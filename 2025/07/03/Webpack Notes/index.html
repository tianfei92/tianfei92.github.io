<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#000" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#000">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"tianfei92.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.23.2","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12},"hljswrap":false,"codeblock":{"theme":{"light":"atom-one-dark","dark":"atom-one-dark"},"prism":{"light":"prism-okaidia","dark":"prism-okaidia"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false,"highlight_theme":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="一、核心概念与基础1.1 Webpack 定位与核心价值1.1.1 模块化打包的本质需求前端开发的核心演变 原始阶段：全局变量污染 &lt;!-- 传统开发方式 --&gt; &lt;script src&#x3D;&quot;jquery.js&quot;&gt;&lt;&#x2F;script&gt; &lt;script src&#x3D;&quot;plugin1.js&quot;&gt;&lt;&#x2F;script&gt; &lt;!-- 可能覆盖全局变量 --&gt; &lt;script sr">
<meta property="og:type" content="article">
<meta property="og:title" content="专题知识学习：Webpack">
<meta property="og:url" content="https://tianfei92.github.io/2025/07/03/Webpack%20Notes/index.html">
<meta property="og:site_name" content="Ariel&#39;s Blog">
<meta property="og:description" content="一、核心概念与基础1.1 Webpack 定位与核心价值1.1.1 模块化打包的本质需求前端开发的核心演变 原始阶段：全局变量污染 &lt;!-- 传统开发方式 --&gt; &lt;script src&#x3D;&quot;jquery.js&quot;&gt;&lt;&#x2F;script&gt; &lt;script src&#x3D;&quot;plugin1.js&quot;&gt;&lt;&#x2F;script&gt; &lt;!-- 可能覆盖全局变量 --&gt; &lt;script sr">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-07-03T01:11:35.000Z">
<meta property="article:modified_time" content="2025-07-11T01:38:59.837Z">
<meta property="article:author" content="Ariel">
<meta property="article:tag" content="Webpack">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://tianfei92.github.io/2025/07/03/Webpack%20Notes/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://tianfei92.github.io/2025/07/03/Webpack%20Notes/","path":"2025/07/03/Webpack Notes/","title":"专题知识学习：Webpack"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>专题知识学习：Webpack | Ariel's Blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.5.0/search.js" integrity="sha256-xFC6PJ82SL9b3WkGjFavNiA9gm5z6UBxWPiu4CYjptg=" crossorigin="anonymous" defer></script>
<script src="/js/third-party/search/local-search.js" defer></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.7.0/mermaid.min.js","integrity":"sha256-4+IKDqhZ/sXjc8Wtl2/MsxI4e0s1KpEVdbEP7V/Lz8U="}}</script>
  <script src="/js/third-party/tags/mermaid.js" defer></script>





  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Ariel's Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">我本地没问题啊</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E4%B8%8E%E5%9F%BA%E7%A1%80"><span class="nav-text">一、核心概念与基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-Webpack-%E5%AE%9A%E4%BD%8D%E4%B8%8E%E6%A0%B8%E5%BF%83%E4%BB%B7%E5%80%BC"><span class="nav-text">1.1 Webpack 定位与核心价值</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-1-%E6%A8%A1%E5%9D%97%E5%8C%96%E6%89%93%E5%8C%85%E7%9A%84%E6%9C%AC%E8%B4%A8%E9%9C%80%E6%B1%82"><span class="nav-text">1.1.1 模块化打包的本质需求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-2-%E4%B8%8ERollup-Vite-Parcel%E7%9A%84%E5%AF%B9%E6%AF%94%EF%BC%88%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF%E5%B7%AE%E5%BC%82%EF%BC%89"><span class="nav-text">1.1.2 与Rollup&#x2F;Vite&#x2F;Parcel的对比（适用场景差异）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E6%A0%B8%E5%BF%83%E9%85%8D%E7%BD%AE%E9%A1%B9%E8%A7%A3%E6%9E%90"><span class="nav-text">1.2 核心配置项解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-entry%EF%BC%9A%E5%A4%9A%E5%85%A5%E5%8F%A3%E3%80%81%E5%8A%A8%E6%80%81%E5%85%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1"><span class="nav-text">1.2.1 entry：多入口、动态入口设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-output%EF%BC%9A%E6%96%87%E4%BB%B6%E5%90%8D%E5%93%88%E5%B8%8C%E3%80%81CDN%E8%B7%AF%E5%BE%84%E3%80%81Library%E5%AF%BC%E5%87%BA"><span class="nav-text">1.2.2 output：文件名哈希、CDN路径、Library导出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-mode%EF%BC%9A%E5%BC%80%E5%8F%91-%E7%94%9F%E4%BA%A7%E6%A8%A1%E5%BC%8F%E5%86%85%E7%BD%AE%E4%BC%98%E5%8C%96"><span class="nav-text">1.2.3 mode：开发&#x2F;生产模式内置优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-4-devtool%EF%BC%9ASource-Map%E5%8E%9F%E7%90%86%E4%B8%8E%E9%80%89%E5%9E%8B"><span class="nav-text">1.2.4 devtool：Source Map原理与选型</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-%E6%A8%A1%E5%9D%97%E5%8C%96%E5%85%BC%E5%AE%B9"><span class="nav-text">1.3 模块化兼容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-1-ES-Module-CommonJS-AMD-%E6%B7%B7%E7%94%A8%E5%A4%84%E7%90%86"><span class="nav-text">1.3.1 ES Module &#x2F; CommonJS &#x2F; AMD 混用处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-2-Tree-Shaking%E6%B7%B1%E5%B1%82%E5%8E%9F%E7%90%86%EF%BC%88sideEffects%E6%A0%87%E5%BF%97%EF%BC%89"><span class="nav-text">1.3.2 Tree Shaking深层原理（sideEffects标志）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E6%A0%B8%E5%BF%83%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B%E4%B8%8E%E6%89%A9%E5%B1%95"><span class="nav-text">二、核心编译流程与扩展</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-Loader%E6%9C%BA%E5%88%B6"><span class="nav-text">2.1 Loader机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1-%E9%93%BE%E5%BC%8F%E8%B0%83%E7%94%A8%E4%B8%8E%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="nav-text">2.1.1 链式调用与执行顺序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2-%E6%89%8B%E5%86%99Loader%EF%BC%88%E4%BB%A3%E7%A0%81%E8%BD%AC%E6%8D%A2-%E5%9B%BD%E9%99%85%E5%8C%96%E5%A4%84%E7%90%86%E6%A1%88%E4%BE%8B%EF%BC%89"><span class="nav-text">2.1.2 手写Loader（代码转换&#x2F;国际化处理案例）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-3-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%EF%BC%9ALoader%E7%BC%93%E5%AD%98%E3%80%81%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%BC%96%E8%AF%91%EF%BC%88thread-loader%EF%BC%89"><span class="nav-text">2.1.3 性能优化：Loader缓存、多进程编译（thread-loader）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Plugin%E7%B3%BB%E7%BB%9F"><span class="nav-text">2.2 Plugin系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-1-Compiler%E4%B8%8ECompilation%E5%AF%B9%E8%B1%A1%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-text">2.2.1 Compiler与Compilation对象生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-2-%E6%89%8B%E5%86%99Plugin%EF%BC%88%E8%B5%84%E6%BA%90%E6%B3%A8%E5%85%A5-%E6%9E%84%E5%BB%BA%E5%88%86%E6%9E%90%E6%A1%88%E4%BE%8B%EF%BC%89"><span class="nav-text">2.2.2 手写Plugin（资源注入&#x2F;构建分析案例）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-3-%E5%B8%B8%E7%94%A8%E6%8F%92%E4%BB%B6%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90%EF%BC%9AHtmlWebpackPlugin-DefinePlugin"><span class="nav-text">2.2.3 常用插件原理剖析：HtmlWebpackPlugin &#x2F; DefinePlugin</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B8%93%E9%A1%B9"><span class="nav-text">三、性能优化专项</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E6%9E%84%E5%BB%BA%E9%80%9F%E5%BA%A6%E4%BC%98%E5%8C%96"><span class="nav-text">3.1 构建速度优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-%E7%BC%93%E5%AD%98%E7%AD%96%E7%95%A5%EF%BC%9Acache-loader-hard-source-webpack-plugin"><span class="nav-text">3.1.1 缓存策略：cache-loader&#x2F;hard-source-webpack-plugin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-%E8%8C%83%E5%9B%B4%E7%BC%A9%E5%B0%8F%EF%BC%9Amodule-noParse-resolve-modules"><span class="nav-text">3.1.2 范围缩小：module.noParse &#x2F; resolve.modules</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-%E5%B9%B6%E8%A1%8C%E5%A4%84%E7%90%86%EF%BC%9Athread-loader-parallel-webpack"><span class="nav-text">3.1.3 并行处理：thread-loader &#x2F; parallel-webpack</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E8%BE%93%E5%87%BA%E5%8C%85%E4%BD%93%E7%A7%AF%E4%BC%98%E5%8C%96"><span class="nav-text">3.2 输出包体积优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-Tree-Shaking%E5%A4%B1%E6%95%88%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90%EF%BC%88%E5%89%AF%E4%BD%9C%E7%94%A8%E5%A4%84%E7%90%86%EF%BC%89"><span class="nav-text">3.2.1 Tree Shaking失效场景分析（副作用处理）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-2-%E4%BB%A3%E7%A0%81%E5%88%86%E5%89%B2%EF%BC%9ASplitChunksPlugin%E9%85%8D%E7%BD%AE%E7%AD%96%E7%95%A5%EF%BC%88chunks-minSize-cacheGroups%EF%BC%89"><span class="nav-text">3.2.2 代码分割：SplitChunksPlugin配置策略（chunks&#x2F;minSize&#x2F;cacheGroups）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-3-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD%EF%BC%9Aimport-%E8%AF%AD%E6%B3%95%E4%B8%8EPrefetch-Preload"><span class="nav-text">3.2.3 动态加载：import()语法与Prefetch&#x2F;Preload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-4-%E8%B5%84%E6%BA%90%E5%8E%8B%E7%BC%A9%EF%BC%9ATerser%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%8E%8B%E7%BC%A9-CSS-cssnano"><span class="nav-text">3.2.4 资源压缩：Terser多进程压缩 &#x2F; CSS cssnano</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7%E4%B8%8E%E5%B7%A5%E7%A8%8B%E5%8C%96"><span class="nav-text">四、高级特性与工程化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-%E7%8E%AF%E5%A2%83%E5%8C%BA%E5%88%86%E4%B8%8E%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE"><span class="nav-text">4.1 环境区分与动态配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-1-%E5%9F%BA%E4%BA%8Ewebpack-merge%E7%9A%84%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-text">4.1.1 基于webpack-merge的多环境配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-2-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5%EF%BC%88dotenv%E4%B8%8EDefinePlugin%E7%BB%93%E5%90%88%EF%BC%89"><span class="nav-text">4.1.2 环境变量注入（dotenv与DefinePlugin结合）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-%E5%BE%AE%E5%89%8D%E7%AB%AF%E9%9B%86%E6%88%90"><span class="nav-text">4.2 微前端集成</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-1-Module-Federation%E5%8E%9F%E7%90%86%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="nav-text">4.2.1 Module Federation原理与配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-2-%E8%B7%A8%E5%BA%94%E7%94%A8%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9D%97%E7%AD%96%E7%95%A5"><span class="nav-text">4.2.2 跨应用共享模块策略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B"><span class="nav-text">4.3 自定义构建流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-1-%E7%BC%96%E5%86%99CLI%E5%B7%A5%E5%85%B7%E9%9B%86%E6%88%90Webpack"><span class="nav-text">4.3.1 编写CLI工具集成Webpack</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-2-%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%E6%B7%B1%E5%BA%A6%E4%BD%BF%E7%94%A8%EF%BC%88afterEmit-done%EF%BC%89"><span class="nav-text">4.3.2 钩子函数深度使用（afterEmit&#x2F;done）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E8%B0%83%E8%AF%95%E4%B8%8E%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-text">五、调试与性能分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#5-1-%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B%E7%9B%91%E6%8E%A7"><span class="nav-text">5.1 构建过程监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-1-speed-measure-webpack-plugin%EF%BC%88%E6%9E%84%E5%BB%BA%E8%80%97%E6%97%B6%E5%88%86%E6%9E%90%EF%BC%89"><span class="nav-text">5.1.1 speed-measure-webpack-plugin（构建耗时分析）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-2-webpack-bundle-analyzer%EF%BC%88%E4%BA%A7%E7%89%A9%E4%BD%93%E7%A7%AF%E5%8F%AF%E8%A7%86%E5%8C%96%EF%BC%89"><span class="nav-text">5.1.2 webpack-bundle-analyzer（产物体积可视化）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-2-DevServer%E6%B7%B1%E5%BA%A6%E9%85%8D%E7%BD%AE"><span class="nav-text">5.2 DevServer深度配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-1-HMR%E5%8E%9F%E7%90%86%E4%B8%8E%E7%83%AD%E6%9B%B4%E6%96%B0%E8%8C%83%E5%9B%B4%E6%8E%A7%E5%88%B6"><span class="nav-text">5.2.1 HMR原理与热更新范围控制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-2-Proxy%E9%85%8D%E7%BD%AE%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%EF%BC%88pathRewrite-context%EF%BC%89"><span class="nav-text">5.2.2 Proxy配置解决跨域（pathRewrite&#x2F;context）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-3-%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%89%A9%E5%B1%95%EF%BC%88before-after%E9%92%A9%E5%AD%90%EF%BC%89"><span class="nav-text">5.2.3 中间件扩展（before&#x2F;after钩子）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E5%8E%9F%E7%90%86%E4%B8%8E%E6%BA%90%E7%A0%81%E5%B1%82"><span class="nav-text">六、原理与源码层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#6-1-Tapable%E4%BA%8B%E4%BB%B6%E6%B5%81%E6%9C%BA%E5%88%B6"><span class="nav-text">6.1 Tapable事件流机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-1-%E5%90%8C%E6%AD%A5-%E5%BC%82%E6%AD%A5%E9%92%A9%E5%AD%90%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="nav-text">6.1.1 同步&#x2F;异步钩子调用流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-2-%E6%8F%92%E4%BB%B6%E6%B3%A8%E5%86%8C%E4%B8%8E%E8%A7%A6%E5%8F%91%E5%8E%9F%E7%90%86"><span class="nav-text">6.1.2 插件注册与触发原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-2-AST%E5%BA%94%E7%94%A8"><span class="nav-text">6.2 AST应用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-1-Loader%E4%B8%AD%E7%9A%84AST%E6%93%8D%E4%BD%9C%EF%BC%88Babel-Parser%E6%A1%88%E4%BE%8B%EF%BC%89"><span class="nav-text">6.2.1 Loader中的AST操作（Babel Parser案例）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-2-%E4%BE%9D%E8%B5%96%E5%9B%BE%EF%BC%88Dependency-Graph%EF%BC%89%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B"><span class="nav-text">6.2.2 依赖图（Dependency Graph）生成过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-3-%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="nav-text">6.3 核心流程源码解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-1-%E7%BC%96%E8%AF%91%E9%98%B6%E6%AE%B5%EF%BC%9AModule-%E2%86%92-Chunk-%E2%86%92-Asset-%E8%BD%AC%E6%8D%A2"><span class="nav-text">6.3.1 编译阶段：Module → Chunk → Asset 转换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-2-%E8%BE%93%E5%87%BA%E9%98%B6%E6%AE%B5%EF%BC%9ATemplate%E6%B8%B2%E6%9F%93%E4%B8%8E%E6%96%87%E4%BB%B6%E7%94%9F%E6%88%90"><span class="nav-text">6.3.2 输出阶段：Template渲染与文件生成</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81%E7%94%9F%E6%80%81%E4%B8%8E%E6%9C%AA%E6%9D%A5%E8%B6%8B%E5%8A%BF"><span class="nav-text">七、生态与未来趋势</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#7-1-Webpack-5-%E6%96%B0%E7%89%B9%E6%80%A7"><span class="nav-text">7.1 Webpack 5 新特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-1-%E6%8C%81%E4%B9%85%E5%8C%96%E7%BC%93%E5%AD%98%EF%BC%88persistentCache%EF%BC%89"><span class="nav-text">7.1.1 持久化缓存（persistentCache）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-2-%E6%A8%A1%E5%9D%97%E8%81%94%E9%82%A6%EF%BC%88Module-Federation%EF%BC%89"><span class="nav-text">7.1.2 模块联邦（Module Federation）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-3-Asset-Modules%E8%B5%84%E6%BA%90%E5%A4%84%E7%90%86"><span class="nav-text">7.1.3 Asset Modules资源处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-2-%E4%B8%8E%E6%96%B0%E5%85%B4%E5%B7%A5%E5%85%B7%E5%8D%8F%E4%BD%9C"><span class="nav-text">7.2 与新兴工具协作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-1-Webpack-Vite-%E6%B7%B7%E5%90%88%E5%BC%80%E5%8F%91%E6%A8%A1%E5%BC%8F"><span class="nav-text">7.2.1 Webpack + Vite 混合开发模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-2-Rust%E5%B7%A5%E5%85%B7%E9%93%BE%E9%9B%86%E6%88%90%EF%BC%88swc-loader%E6%9B%BF%E4%BB%A3Babel%EF%BC%89"><span class="nav-text">7.2.2 Rust工具链集成（swc-loader替代Babel）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E9%9D%A2%E8%AF%95%E4%B8%93%E9%A1%B9%E5%87%86%E5%A4%87%E5%BB%BA%E8%AE%AE"><span class="nav-text">八、面试专项准备建议</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#8-1-%E9%AB%98%E9%A2%91%E8%80%83%E7%82%B9"><span class="nav-text">8.1 高频考点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-1-Tree-Shaking%E6%9D%A1%E4%BB%B6%E4%B8%8E%E5%89%AF%E4%BD%9C%E7%94%A8%E5%A4%84%E7%90%86"><span class="nav-text">8.1.1 Tree Shaking条件与副作用处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-2-SplitChunks%E9%85%8D%E7%BD%AE%E9%A1%B9%E4%BC%98%E5%85%88%E7%BA%A7"><span class="nav-text">8.1.2 SplitChunks配置项优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-3-HMR%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B%EF%BC%88WebSocket-%E2%86%92-HotModuleReplacementPlugin%EF%BC%89"><span class="nav-text">8.1.3 HMR工作流程（WebSocket → HotModuleReplacementPlugin）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-2-%E5%9C%BA%E6%99%AF%E8%AE%BE%E8%AE%A1%E9%A2%98"><span class="nav-text">8.2 场景设计题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-1-%E2%80%9C%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%A7%92%E7%BA%A7%E6%9E%84%E5%BB%BA%E7%9A%84%E5%BE%AE%E5%89%8D%E7%AB%AF%E9%A1%B9%E7%9B%AE%EF%BC%9F%E2%80%9D"><span class="nav-text">8.2.1 “如何实现秒级构建的微前端项目？”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-2-2-%E2%80%9C%E9%A6%96%E5%B1%8F%E5%8A%A0%E8%BD%BD%E6%85%A2%EF%BC%8C%E4%BB%8E%E5%93%AA%E4%BA%9B%E7%BB%B4%E5%BA%A6%E4%BC%98%E5%8C%96%EF%BC%9F%E2%80%9D"><span class="nav-text">8.2.2 “首屏加载慢，从哪些维度优化？”</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-3-%E5%8E%9F%E7%90%86%E6%B7%B1%E6%8C%96"><span class="nav-text">8.3 原理深挖</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-1-%E6%89%8B%E5%86%99%E7%AE%80%E6%98%93Webpack%E6%A0%B8%E5%BF%83%E6%B5%81%E7%A8%8B%EF%BC%88%E8%A7%A3%E6%9E%90%E4%BE%9D%E8%B5%96%E2%86%92%E7%94%9F%E6%88%90Chunk%EF%BC%89"><span class="nav-text">8.3.1 手写简易Webpack核心流程（解析依赖→生成Chunk）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8-3-2-%E5%AF%B9%E6%AF%94Webpack%E4%B8%8EVite%E7%9A%84Bundleless%E8%AE%BE%E8%AE%A1%E5%B7%AE%E5%BC%82"><span class="nav-text">8.3.2 对比Webpack与Vite的Bundleless设计差异</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Ariel"
      src="/uploads/avatar.JPG">
  <p class="site-author-name" itemprop="name">Ariel</p>
  <div class="site-description" itemprop="description">神游在初见的午后</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/tianfei92" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;tianfei92" rel="noopener me" target="_blank">GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:tian.fi@outlook.com" title="E-Mail → mailto:tian.fi@outlook.com" rel="noopener me" target="_blank">E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://juejin.cn/user/3913917124325127" title="Juejin → https:&#x2F;&#x2F;juejin.cn&#x2F;user&#x2F;3913917124325127" rel="noopener me" target="_blank">Juejin</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://tianfei92.github.io/2025/07/03/Webpack%20Notes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.JPG">
      <meta itemprop="name" content="Ariel">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ariel's Blog">
      <meta itemprop="description" content="神游在初见的午后">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="专题知识学习：Webpack | Ariel's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          专题知识学习：Webpack
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2025-07-03 09:11:35" itemprop="dateCreated datePublished" datetime="2025-07-03T09:11:35+08:00">2025-07-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-07-11 09:38:59" itemprop="dateModified" datetime="2025-07-11T09:38:59+08:00">2025-07-11</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Webpack/" itemprop="url" rel="index"><span itemprop="name">Webpack</span></a>
        </span>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>26k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:34</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="一、核心概念与基础"><a href="#一、核心概念与基础" class="headerlink" title="一、核心概念与基础"></a>一、核心概念与基础</h1><h2 id="1-1-Webpack-定位与核心价值"><a href="#1-1-Webpack-定位与核心价值" class="headerlink" title="1.1 Webpack 定位与核心价值"></a>1.1 Webpack 定位与核心价值</h2><h3 id="1-1-1-模块化打包的本质需求"><a href="#1-1-1-模块化打包的本质需求" class="headerlink" title="1.1.1 模块化打包的本质需求"></a>1.1.1 模块化打包的本质需求</h3><p><strong>前端开发的核心演变</strong></p>
<p>原始阶段：全局变量污染</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 传统开发方式 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jquery.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>plugin1.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!-- 可能覆盖全局变量 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>plugin2.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span> <span class="token comment">&lt;!-- 依赖顺序必须正确 --></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>模块化革命：</p>
<ul>
<li>CommonJS（Node.js）：const module &#x3D; require(‘.&#x2F;module’)</li>
<li>ES Modules（现代浏览器）：import module from ‘.&#x2F;module.js’</li>
</ul>
<span id="more"></span>

<p><strong>模块化打包要解决的四大核心问题</strong></p>
<table>
<thead>
<tr>
<th align="left">问题类型</th>
<th align="left">具体表现</th>
<th align="left">解决方案</th>
</tr>
</thead>
<tbody><tr>
<td align="left">依赖管理</td>
<td align="left">脚本加载顺序混乱<br>循环依赖风险</td>
<td align="left">构建依赖关系图(Dependency Graph)</td>
</tr>
<tr>
<td align="left">作用域隔离</td>
<td align="left">全局变量冲突<br>命名污染</td>
<td align="left">模块闭包封装</td>
</tr>
<tr>
<td align="left">资源整合</td>
<td align="left">多文件分散请求<br>资源类型多样</td>
<td align="left">统一打包策略<br>Loader转换机制</td>
</tr>
<tr>
<td align="left">生产优化</td>
<td align="left">未压缩代码<br>未Tree Shaking<br>无缓存优化</td>
<td align="left">压缩&#x2F;混淆<br>Dead Code消除<br>内容哈希</td>
</tr>
</tbody></table>
<p><strong>Webpack的核心解决机制</strong></p>
<p>(1) 依赖图谱构建</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack内部生成的依赖图谱片段</span>
<span class="token punctuation">&#123;</span>
  <span class="token string-property property">'./src/index.js'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./header.js'</span><span class="token punctuation">,</span> <span class="token string">'./sidebar.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function-variable function">code</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> require</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> header <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./header.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> sidebar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./sidebar.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string-property property">'./header.js'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* ... */</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 作用域隔离（模块封装）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 打包后的模块代码</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token comment">// 自执行函数创建闭包</span>
  <span class="token keyword">var</span> __webpack_modules__ <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token string-property property">'./src/math.js'</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a <span class="token operator">+</span> b<span class="token punctuation">,</span>
        <span class="token literal-property property">pi</span><span class="token operator">:</span> <span class="token number">3.14159</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 资源统一处理流程</p>
<pre><code class="mermaid">graph LR
A[ES Modules] --&gt; B[Babel Loader]
B --&gt; C[JavaScript]
D[SCSS] --&gt; E[Sass Loader]
E --&gt; F[CSS]
F --&gt; G[Style Loader]
H[Images] --&gt; I[File Loader]
C --&gt; J[打包输出]
G --&gt; J
I --&gt; J</code></pre>

<p><strong>模块化打包的核心价值</strong></p>
<ul>
<li>开发效率提升<ul>
<li>真正的组件化开发</li>
<li>依赖自动解析</li>
<li>热更新能力</li>
</ul>
</li>
<li>性能优化基础<ul>
<li>Tree Shaking消除无效代码</li>
<li>按需加载（Code Splitting）</li>
<li>长效缓存（Content Hash）</li>
</ul>
</li>
<li>工程化支撑<ul>
<li>统一构建流程</li>
<li>多环境适配</li>
<li>质量保障（Lint&#x2F;Test集成）</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 原始代码</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">used</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/*...*/</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">unused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/*...*/</span> <span class="token punctuation">&#125;</span>

<span class="token comment">// 打包后（未引用的unused被移除）</span>
<span class="token comment">/* harmony export */</span> __webpack_exports__<span class="token punctuation">[</span><span class="token string">"used"</span><span class="token punctuation">]</span> <span class="token operator">=</span> used<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试重点解析</strong></p>
<ul>
<li>为什么现代前端需要打包工具？</li>
<li>Webpack如何解决模块循环依赖问题？</li>
</ul>
<h3 id="1-1-2-与Rollup-Vite-Parcel的对比（适用场景差异）"><a href="#1-1-2-与Rollup-Vite-Parcel的对比（适用场景差异）" class="headerlink" title="1.1.2 与Rollup&#x2F;Vite&#x2F;Parcel的对比（适用场景差异）"></a>1.1.2 与Rollup&#x2F;Vite&#x2F;Parcel的对比（适用场景差异）</h3><p><strong>主流构建工具核心定位对比</strong></p>
<table>
<thead>
<tr>
<th align="left">工具</th>
<th align="left">核心定位</th>
<th align="left">设计哲学</th>
<th align="left">典型用户</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Webpack</td>
<td align="left">全能型模块打包器</td>
<td align="left">“一切皆模块”</td>
<td align="left">复杂SPA应用</td>
</tr>
<tr>
<td align="left">Rollup</td>
<td align="left">ES模块打包器</td>
<td align="left">“输出最简洁的库代码”</td>
<td align="left">库&#x2F;框架开发者</td>
</tr>
<tr>
<td align="left">Vite</td>
<td align="left">下一代前端工具链</td>
<td align="left">“原生ESM + 按需编译”</td>
<td align="left">现代框架项目</td>
</tr>
<tr>
<td align="left">Parcel</td>
<td align="left">零配置打包器</td>
<td align="left">“开箱即用”</td>
<td align="left">快速原型开发</td>
</tr>
</tbody></table>
<p><strong>架构原理差异</strong></p>
<p>(1) webpack</p>
<pre><code class="mermaid">graph LR
A[Entry] --&gt; B[递归构建依赖图]
B --&gt; C[Loader处理资源]
C --&gt; D[Plugin优化]
D --&gt; E[Chunk分割]
E --&gt; F[输出Bundle]</code></pre>

<p>(2) rollup</p>
<pre><code class="mermaid">graph LR
A[ESM入口] --&gt; B[静态分析依赖树]
B --&gt; C[Tree-Shaking]
C --&gt; D[作用域提升]
D --&gt; E[输出扁平化Bundle]</code></pre>

<p>(3) vite</p>
<pre><code class="mermaid">graph LR
A[浏览器请求] --&gt; B&#123;是否为JS&#x2F;CSS?&#125;
B --&gt;|是| C[按需编译]
B --&gt;|否| D[直接返回]
C --&gt; E[ESM方式返回]</code></pre>

<p>(4) parcel</p>
<pre><code class="mermaid">graph LR
A[入口文件] --&gt; B[自动检测依赖]
B --&gt; C[多核并行处理]
C --&gt; D[零配置输出]</code></pre>

<p><strong>适用场景分析</strong></p>
<p>(1) Webpack 首选场景</p>
<ul>
<li>企业级复杂应用（特别是遗留系统）</li>
<li>需要深度定制构建流程</li>
<li>多页面应用（MPA）项目</li>
<li>需要集成大量第三方插件</li>
<li>示例：电商后台管理系统</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 典型特征</span>
- <span class="token number">500</span>+组件
- 需要代码分割
- 需要兼容IE11
- 集成Ant Design等大型UI库<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) Rollup 首选场景</p>
<ul>
<li>开源库&#x2F;框架开发</li>
<li>需要输出多种格式的包（UMD&#x2F;ESM&#x2F;CJS）</li>
<li>追求最小化bundle体积</li>
<li>示例：React组件库</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// rollup.config.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">input</span><span class="token operator">:</span> <span class="token string">'src/index.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span> <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">'dist/library.esm.js'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'es'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token punctuation">&#123;</span> <span class="token literal-property property">file</span><span class="token operator">:</span> <span class="token string">'dist/library.cjs.js'</span><span class="token punctuation">,</span> <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">'cjs'</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">terser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token comment">// 代码压缩</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) Vite 首选场景</p>
<ul>
<li>基于现代框架的新项目（Vue&#x2F;React&#x2F;Svelte）</li>
<li>需要极速开发体验</li>
<li>使用大量ES模块的现代浏览器项目</li>
<li>示例：创新型SaaS平台</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开发体验对比</span>
Webpack启动: <span class="token number">15</span>-25s 
Vite启动: <span class="token operator">&lt;</span>500ms <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>(4) Parcel 首选场景</p>
<ul>
<li>快速原型开发</li>
<li>静态网站生成</li>
<li>不需要复杂配置的小型项目</li>
<li>示例：个人博客网站</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 零配置使用</span>
parcel build index.html 
<span class="token comment"># 自动处理：</span>
<span class="token comment"># - Sass → CSS</span>
<span class="token comment"># - TypeScript → JavaScript</span>
<span class="token comment"># - 图片优化</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试高频问题解析</strong></p>
<p>(1) 为什么Vite开发环境比Webpack快？</p>
<ul>
<li>基于浏览器原生ES模块系统</li>
<li>按需编译（非全量打包）</li>
<li>使用ESBuild预构建（Go语言编写，比JS快10-100倍）</li>
</ul>
<h2 id="1-2-核心配置项解析"><a href="#1-2-核心配置项解析" class="headerlink" title="1.2 核心配置项解析"></a>1.2 核心配置项解析</h2><h3 id="1-2-1-entry：多入口、动态入口设计"><a href="#1-2-1-entry：多入口、动态入口设计" class="headerlink" title="1.2.1 entry：多入口、动态入口设计"></a>1.2.1 <code>entry</code>：多入口、动态入口设计</h3><p><strong>入口(Entry)的核心概念</strong></p>
<p>基本定义：</p>
<ul>
<li>入口起点(entry point)：Webpack构建依赖图的起始模块</li>
<li>单入口基础配置：</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./src/index.js'</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>入口的底层实现:</p>
<pre><code class="mermaid">graph LR
  A[Entry] --&gt; B[创建依赖图]
  B --&gt; C[递归解析依赖]
  C --&gt; D[生成Chunk]</code></pre>

<p><strong>多入口配置实战</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">main</span><span class="token operator">:</span> <span class="token string">'./src/app.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">admin</span><span class="token operator">:</span> <span class="token string">'./src/admin.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">vendor</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'react-dom'</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'[name].bundle.js'</span> <span class="token comment">// 输出 main.bundle.js, admin.bundle.js</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>动态入口高级技巧</strong></p>
<p>(1) 函数式动态入库</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 根据环境变量动态生成入口</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">entry</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> entries <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">main</span><span class="token operator">:</span> <span class="token string">'./src/app.js'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      entries<span class="token punctuation">.</span>debug <span class="token operator">=</span> <span class="token string">'./src/debugPanel.js'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">BUILD_TARGET</span> <span class="token operator">===</span> <span class="token string">'admin'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      entries<span class="token punctuation">.</span>admin <span class="token operator">=</span> <span class="token string">'./src/admin.js'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">return</span> entries<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 文件系统驱动入口</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自动扫描pages目录创建入口</span>
<span class="token keyword">function</span> <span class="token function">generateEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> pagesDir <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src/pages'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>pagesDir<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entries<span class="token punctuation">,</span> page</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    entries<span class="token punctuation">[</span>page<span class="token punctuation">]</span> <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>pagesDir<span class="token punctuation">,</span> page<span class="token punctuation">,</span> <span class="token string">'index.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> entries<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token function">generateEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 远程配置入口（微前端场景）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">entry</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 从配置服务器获取入口配置</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'https://config-server.com/entries'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> remoteConfig <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">main</span><span class="token operator">:</span> <span class="token string">'./src/app.js'</span><span class="token punctuation">,</span>
      <span class="token operator">...</span>remoteConfig<span class="token punctuation">.</span>modules
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能优化策略</strong></p>
<p>(1) 入口依赖优化</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">app</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">import</span><span class="token operator">:</span> <span class="token string">'./src/app.js'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dependOn</span><span class="token operator">:</span> <span class="token string">'shared'</span> <span class="token comment">// 共享依赖</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dashboard</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">import</span><span class="token operator">:</span> <span class="token string">'./src/dashboard.js'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dependOn</span><span class="token operator">:</span> <span class="token string">'shared'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'react-dom'</span><span class="token punctuation">]</span> <span class="token comment">// 公共模块</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 动态入口懒加载</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 运行时动态加载入口（适用于插件系统）</span>
button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackIgnore: false */</span> <span class="token string">'/plugins/'</span> <span class="token operator">+</span> pluginName <span class="token operator">+</span> <span class="token string">'/entry.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> module<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>常见问题与解决方案</strong></p>
<p>(1) 入口文件过大问题</p>
<p>解决方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">main</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">import</span><span class="token operator">:</span> <span class="token string">'./src/app.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'main/[name].js'</span><span class="token punctuation">,</span> <span class="token comment">// 自定义输出路径</span>
    <span class="token literal-property property">dependOn</span><span class="token operator">:</span> <span class="token string">'vendors'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">vendors</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'react'</span><span class="token punctuation">,</span> <span class="token string">'lodash'</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 循环依赖警告</p>
<p>修复方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 重构模块结构或使用动态导入</span>
<span class="token comment">// 错误示例</span>
<span class="token comment">// a.js</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> b <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./b.js'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">a</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// b.js</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> a <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./a.js'</span><span class="token punctuation">;</span> <span class="token comment">// 循环依赖</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">b</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 正确方案</span>
<span class="token comment">// b.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">b</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./a.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> m<span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试重点解析</strong></p>
<p>(1) 多入口应用如何共享代码？</p>
<ul>
<li>使用dependOn显式声明共享模块</li>
<li>配置SplitChunksPlugin自动提取公共代码</li>
</ul>
<p>(2) 动态入口在微前端中的应用？</p>
<ul>
<li>主应用通过动态入口加载子应用</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">mainApp</span><span class="token operator">:</span> <span class="token string">'./main.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">childApp1</span><span class="token operator">:</span> <span class="token string">'https://child-app.com/entry.js'</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>结合Module Federation实现</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 动态配置remotes</span>
<span class="token literal-property property">remotes</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">childApp</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">promise import('child_app/entry.js')</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-2-2-output：文件名哈希、CDN路径、Library导出"><a href="#1-2-2-output：文件名哈希、CDN路径、Library导出" class="headerlink" title="1.2.2 output：文件名哈希、CDN路径、Library导出"></a>1.2.2 <code>output</code>：文件名哈希、CDN路径、Library导出</h3><p><strong>Output 配置核心概念</strong></p>
<p>基本作用与结构：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 输出目录</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'[name].[contenthash].js'</span><span class="token punctuation">,</span>  <span class="token comment">// 文件名模板</span>
    <span class="token literal-property property">publicPath</span><span class="token operator">:</span> <span class="token string">'https://cdn.example.com/'</span><span class="token punctuation">,</span> <span class="token comment">// CDN路径</span>
    <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token string">'MyLibrary'</span><span class="token punctuation">,</span> <span class="token comment">// 库导出名称</span>
    <span class="token literal-property property">libraryTarget</span><span class="token operator">:</span> <span class="token string">'umd'</span> <span class="token comment">// 导出格式</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>文件名哈希策略</strong></p>
<table>
<thead>
<tr>
<th align="left">哈希类型</th>
<th align="left">计算依据</th>
<th align="left">适用场景</th>
<th align="left">示例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">[hash]</td>
<td align="left">整个项目构建</td>
<td align="left">所有输出文件相同哈希</td>
<td align="left">main.3a7f8e9.js</td>
</tr>
<tr>
<td align="left">[chunkhash]</td>
<td align="left">每个入口chunk内容</td>
<td align="left">独立更新的chunk</td>
<td align="left">app.4c2d8b1.js</td>
</tr>
<tr>
<td align="left">[contenthash]</td>
<td align="left">文件实际内容</td>
<td align="left">最佳缓存策略</td>
<td align="left">styles.5e6f7a2.css</td>
</tr>
<tr>
<td align="left">[fullhash]</td>
<td align="left">整个编译过程</td>
<td align="left">Webpack 5+ 替代[hash]</td>
<td align="left">vendor.9b0c3d4.js</td>
</tr>
</tbody></table>
<p>哈希失效问题解决方案</p>
<ul>
<li>问题：模块未变更但哈希变化</li>
<li>原因：Webpack引导代码(manifest)变化</li>
<li>修复：提取runtime到单独文件</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">runtimeChunk</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">name</span><span class="token operator">:</span> <span class="token parameter">entrypoint</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">runtime-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>entrypoint<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>CDN路径配置策略</strong></p>
<p>(1) publicPath 动态配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 根据环境切换路径</span>
<span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">publicPath</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
    <span class="token operator">?</span> <span class="token string">'https://cdn.example.com/assets/'</span>
    <span class="token operator">:</span> <span class="token string">'/'</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 自动检测协议</span>
<span class="token literal-property property">publicPath</span><span class="token operator">:</span> <span class="token string">'//cdn.example.com/assets/'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 微前端场景下的 CDN 配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 主应用配置</span>
<span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">publicPath</span><span class="token operator">:</span> <span class="token string">'https://main-app.com/'</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 子应用配置</span>
<span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">publicPath</span><span class="token operator">:</span> <span class="token string">'https://child-app.com/assets/'</span><span class="token punctuation">,</span>
  <span class="token comment">// Webpack 5 Module Federation</span>
  <span class="token literal-property property">uniqueName</span><span class="token operator">:</span> <span class="token string">'childApp'</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Library 导出配置</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'MyLibrary'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'umd'</span><span class="token punctuation">,</span>
    <span class="token keyword">export</span><span class="token operator">:</span> <span class="token string">'default'</span> <span class="token comment">// 导出默认值</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">globalObject</span><span class="token operator">:</span> <span class="token string">'this'</span> <span class="token comment">// 兼容Node和浏览器</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>导出格式对比：</p>
<table>
<thead>
<tr>
<th align="left">格式类型</th>
<th align="left">使用场景</th>
<th align="left">示例输出</th>
<th align="left">运行环境</th>
</tr>
</thead>
<tbody><tr>
<td align="left">var</td>
<td align="left">全局变量</td>
<td align="left"><code>var MyLib = ...</code></td>
<td align="left">浏览器</td>
</tr>
<tr>
<td align="left">this</td>
<td align="left">当前上下文</td>
<td align="left"><code>this[&quot;MyLib&quot;] = ...</code></td>
<td align="left">浏览器&#x2F;Node</td>
</tr>
<tr>
<td align="left">commonjs</td>
<td align="left">CommonJS环境</td>
<td align="left"><code>exports[&quot;MyLib&quot;] = ...</code></td>
<td align="left">Node</td>
</tr>
<tr>
<td align="left">amd</td>
<td align="left">AMD模块</td>
<td align="left"><code>define(&quot;MyLib&quot;, [], ...)</code></td>
<td align="left">RequireJS</td>
</tr>
<tr>
<td align="left">umd</td>
<td align="left">通用模块定义</td>
<td align="left">兼容AMD&#x2F;CJS&#x2F;全局变量</td>
<td align="left">跨环境</td>
</tr>
<tr>
<td align="left">system</td>
<td align="left">SystemJS模块</td>
<td align="left"><code>System.register(&quot;MyLib&quot;, ...)</code></td>
<td align="left">SystemJS</td>
</tr>
</tbody></table>
<p>多入口库导出示例：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">main</span><span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">utils</span><span class="token operator">:</span> <span class="token string">'./src/utils.js'</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'MyLib'</span><span class="token punctuation">,</span> <span class="token string">'[name]'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// MyLib.main, MyLib.utils</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'umd'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能优化实践</strong></p>
<p>(1) 哈希算法优化（Webpack 5+）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">hashFunction</span><span class="token operator">:</span> <span class="token string">'xxhash64'</span><span class="token punctuation">,</span> <span class="token comment">// 比md4更快</span>
  <span class="token literal-property property">hashDigestLength</span><span class="token operator">:</span> <span class="token number">12</span> <span class="token comment">// 更长的哈希减少碰撞</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) CDN 域名分散</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 使用多个CDN域名加速资源加载</span>
<span class="token keyword">const</span> <span class="token function-variable function">getCDNPath</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> cdns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'https://cdn1.example.com'</span><span class="token punctuation">,</span>
    <span class="token string">'https://cdn2.example.com'</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> cdns<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> cdns<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">publicPath</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span> 
    <span class="token operator">?</span> <span class="token function">getCDNPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token operator">:</span> <span class="token string">'/'</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>常见问题解决方案</strong></p>
<p>(1) 路径错误问题</p>
<ul>
<li>症状：Error: Cannot find module ‘.&#x2F;main.js’</li>
<li>原因：publicPath配置错误</li>
</ul>
<p>(2) 库导出冲突</p>
<ul>
<li>症状：多库共存时全局变量覆盖</li>
<li>解决方案：作用域隔离</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'MyLib'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'var'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">umdNamedDefine</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 添加命名空间</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试重点解析</strong></p>
<p>(1) contenthash&#x2F;chunkhash&#x2F;hash的区别？</p>
<ul>
<li>hash：基于整个compilation生成，所有文件共享</li>
<li>chunkhash：基于入口chunk内容</li>
<li>contenthash：基于文件内容（最佳缓存策略）</li>
<li>使用场景：<ul>
<li>CSS文件应使用[contenthash]</li>
<li>入口JS使用[chunkhash]</li>
<li>避免使用[hash]</li>
</ul>
</li>
</ul>
<p>(2) 如何实现永久缓存？</p>
<ul>
<li>使用[contenthash]作为文件名</li>
<li>提取runtime到单独文件</li>
<li>稳定模块ID（optimization.moduleIds: ‘deterministic’）</li>
<li>避免内联webpack运行时代码</li>
</ul>
<p>(3) UMD库如何兼容不同环境？</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'MyLib'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'umd'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">globalObject</span><span class="token operator">:</span> <span class="token string">'typeof self !== "undefined" ? self : this'</span> <span class="token comment">// 自动检测环境</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-2-3-mode：开发-生产模式内置优化"><a href="#1-2-3-mode：开发-生产模式内置优化" class="headerlink" title="1.2.3 mode：开发&#x2F;生产模式内置优化"></a>1.2.3 <code>mode</code>：开发&#x2F;生产模式内置优化</h3><p><strong>mode 配置的核心作用</strong></p>
<p>模式定义与默认行为：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span> <span class="token comment">// 可选：'development' | 'production' | 'none'</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<table>
<thead>
<tr>
<th align="left">模式</th>
<th align="left">默认行为概览</th>
<th align="left">适用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="left">development</td>
<td align="left">优化开发体验</td>
<td align="left">本地开发</td>
</tr>
<tr>
<td align="left">production</td>
<td align="left">优化输出文件体积和性能</td>
<td align="left">生产部署</td>
</tr>
<tr>
<td align="left">none</td>
<td align="left">不启用任何默认优化</td>
<td align="left">自定义配置</td>
</tr>
</tbody></table>
<p><strong>开发模式(development)深度解析</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// mode: 'development' 等效于以下配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">devtool</span><span class="token operator">:</span> <span class="token string">'eval-cheap-module-source-map'</span><span class="token punctuation">,</span> <span class="token comment">// 源映射(Source Map)</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 禁用压缩/优化</span>
    <span class="token literal-property property">removeAvailableModules</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 保留变量名/注释</span>
    <span class="token literal-property property">removeEmptyChunks</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 保留变量名/注释</span>
    <span class="token literal-property property">splitChunks</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 热模块替换(HMR)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>生产模式(production)深度优化</strong></p>
<p>内置优化清单：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 生产模式等效配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 启用Terser压缩</span>
    <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
    <span class="token literal-property property">splitChunks</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">'all'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 代码分割</span>
    <span class="token literal-property property">concatenateModules</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 模块串联</span>
    <span class="token literal-property property">flagIncludedChunks</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 标记包含的chunks</span>
    <span class="token literal-property property">sideEffects</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 启用Tree Shaking</span>
    <span class="token literal-property property">providedExports</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 分析导出</span>
    <span class="token literal-property property">usedExports</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 标记使用导出</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">performance</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">hints</span><span class="token operator">:</span> <span class="token string">'warning'</span><span class="token punctuation">,</span> <span class="token comment">// 性能提示</span>
    <span class="token literal-property property">maxAssetSize</span><span class="token operator">:</span> <span class="token number">250000</span><span class="token punctuation">,</span> <span class="token comment">// 资源大小阈值</span>
    <span class="token literal-property property">maxEntrypointSize</span><span class="token operator">:</span> <span class="token number">250000</span> <span class="token comment">// 入口大小阈值</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> 
      <span class="token string-property property">'process.env.NODE_ENV'</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token string">'production'</span><span class="token punctuation">)</span> 
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">CssMinimizerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// CSS压缩</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>高级模式配置技巧</strong></p>
<p>(1) 多环境配置管理</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> configs <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">development</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.dev.config'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">production</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.prod.config'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">staging</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.staging.config'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> configs<span class="token punctuation">[</span>env<span class="token punctuation">.</span>mode <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 模式扩展配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 扩展生产模式优化</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 保留原始配置并添加额外优化</span>
    <span class="token operator">...</span>webpack<span class="token punctuation">.</span>optimization<span class="token punctuation">,</span>
    <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">parallel</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token literal-property property">terserOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">drop_console</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 移除console</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试重点解析</strong></p>
<p>(1) mode配置具体做了哪些优化？</p>
<ul>
<li><p>开发模式：</p>
<ul>
<li>启用命名模块ID（非数字ID）</li>
<li>保留变量名和代码格式</li>
<li>启用eval-source-map</li>
<li>添加HMR支持</li>
</ul>
</li>
<li><p>生产模式：</p>
<ul>
<li>启用Terser代码压缩</li>
<li>开启Tree Shaking</li>
<li>启用作用域提升(Scope Hoisting)</li>
<li>设置process.env.NODE_ENV为production</li>
<li>启用性能提示</li>
</ul>
</li>
</ul>
<p>(2) 如何验证Tree Shaking生效？</p>
<p>验证步骤：</p>
<ol>
<li>确保使用生产模式：mode: ‘production’</li>
<li>检查导出的包中是否包含未使用的代码</li>
<li>使用webpack-bundle-analyzer可视化分析</li>
<li>在package.json中添加”sideEffects”: false</li>
</ol>
<p>(3) 为什么生产环境需要不同的Source Map？</p>
<p>安全与性能平衡：</p>
<ul>
<li>hidden-source-map：生成map文件但不关联</li>
<li>nosources-source-map：显示行号但不暴露源码</li>
<li>最佳实践：</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">devtool</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SENTRY_URL</span> 
  <span class="token operator">?</span> <span class="token string">'source-map'</span> <span class="token comment">// 错误监控需要完整sourcemap</span>
  <span class="token operator">:</span> <span class="token string">'hidden-source-map'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="1-2-4-devtool：Source-Map原理与选型"><a href="#1-2-4-devtool：Source-Map原理与选型" class="headerlink" title="1.2.4 devtool：Source Map原理与选型"></a>1.2.4 <code>devtool</code>：Source Map原理与选型</h3><p><strong>Source Map 核心原理</strong></p>
<p>工作原理示意图：</p>
<pre><code class="mermaid">graph LR
A[压缩混淆代码] --&gt; B[错误位置: 第3行第15列]
B --&gt; C[Source Map文件]
C --&gt; D[原始代码位置: 第42行第8列]</code></pre>

<p>Source Map 文件结构：</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>                   <span class="token comment">// Source Map版本</span>
  <span class="token property">"sources"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"app.js"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>           <span class="token comment">// 源文件列表</span>
  <span class="token property">"names"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"add"</span><span class="token punctuation">,</span> <span class="token string">"multiply"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment">// 变量名映射</span>
  <span class="token property">"mappings"</span><span class="token operator">:</span> <span class="token string">"AAAA;ACDE;"</span><span class="token punctuation">,</span>        <span class="token comment">// 位置映射编码</span>
  <span class="token property">"file"</span><span class="token operator">:</span> <span class="token string">"app.min.js"</span><span class="token punctuation">,</span>            <span class="token comment">// 生成的文件名</span>
  <span class="token property">"sourcesContent"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"原始代码"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment">// 原始源代码（可选）</span>
  <span class="token property">"sourceRoot"</span><span class="token operator">:</span> <span class="token string">"/src"</span>             <span class="token comment">// 源文件根路径</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>映射编码解析（VLQ 原理）</strong></p>
<p>(1) VLQ 编码示例</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">原始位置 → 生成位置
第2行第5列 → 第1行第10列

VLQ编码：CAC1F<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) VLQ 解码过程</p>
<table>
<thead>
<tr>
<th align="left">字符</th>
<th align="left">Base64值</th>
<th align="left">二进制</th>
<th align="left">VLQ连续位</th>
<th align="left">实际值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">C</td>
<td align="left">2</td>
<td align="left">000010</td>
<td align="left">0</td>
<td align="left">1</td>
</tr>
<tr>
<td align="left">A</td>
<td align="left">0</td>
<td align="left">000000</td>
<td align="left">1</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">2</td>
<td align="left">000010</td>
<td align="left">0</td>
<td align="left">-1</td>
</tr>
<tr>
<td align="left">1</td>
<td align="left">17</td>
<td align="left">010001</td>
<td align="left">0</td>
<td align="left">8</td>
</tr>
<tr>
<td align="left">F</td>
<td align="left">5</td>
<td align="left">000101</td>
<td align="left">1</td>
<td align="left">5</td>
</tr>
</tbody></table>
<p>结果：行偏移+1，列偏移0 → 行偏移-1，列偏移8 → 列偏移+5</p>
<p><strong>Source Map 类型全解析</strong></p>
<p>(1) 开发环境推荐类型</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">构建速度</th>
<th align="left">重建速度</th>
<th align="left">质量</th>
<th align="left">适用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="left">eval</td>
<td align="left">+++</td>
<td align="left">+++</td>
<td align="left">无</td>
<td align="left">超快速开发</td>
</tr>
<tr>
<td align="left">eval-source-map</td>
<td align="left">+</td>
<td align="left">++</td>
<td align="left">完整</td>
<td align="left">Create React App 默认</td>
</tr>
<tr>
<td align="left">eval-cheap-source-map</td>
<td align="left">++</td>
<td align="left">+++</td>
<td align="left">行级</td>
<td align="left">大型项目开发</td>
</tr>
<tr>
<td align="left">eval-cheap-module-source-map</td>
<td align="left">++</td>
<td align="left">+++</td>
<td align="left">行级</td>
<td align="left">TypeScript项目</td>
</tr>
</tbody></table>
<p>(2) 生产环境推荐类型</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">文件大小</th>
<th align="left">安全性</th>
<th align="left">适用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="left">source-map</td>
<td align="left">大</td>
<td align="left">低</td>
<td align="left">需要完整源码映射</td>
</tr>
<tr>
<td align="left">hidden-source-map</td>
<td align="left">大</td>
<td align="left">高</td>
<td align="left">错误监控系统(Sentry)</td>
</tr>
<tr>
<td align="left">nosources-source-map</td>
<td align="left">中</td>
<td align="left">高</td>
<td align="left">生产环境调试</td>
</tr>
<tr>
<td align="left">cheap-module-source-map</td>
<td align="left">中</td>
<td align="left">中</td>
<td align="left">平衡性能与调试</td>
</tr>
</tbody></table>
<p><strong>常见问题解决方案</strong></p>
<p>(1) Source Map 不生效</p>
<p>诊断步骤：</p>
<ul>
<li>检查浏览器开发者工具设置（需启用Source Map）</li>
<li>验证HTTP响应头是否包含 <code>SourceMap: &lt;url&gt;</code></li>
<li>检查.map文件是否可访问</li>
<li>确认webpack配置未设置 devtool: false</li>
</ul>
<p><strong>面试重点解析</strong></p>
<p>(1) 为什么eval能提升构建速度？</p>
<p>技术原理：</p>
<ul>
<li>使用 eval() 执行代码</li>
<li>映射信息内联在代码中（非独立文件）</li>
<li>浏览器直接解析无需加载额外文件</li>
<li>避免磁盘I&#x2F;O操作</li>
</ul>
<p>(2) 如何选择生产环境的Source Map？</p>
<pre><code class="mermaid">graph LR
  A[需求分析] --&gt; B&#123;需要调试生产环境?&#125;
  B --&gt;|是| C&#123;需要完整源码?&#125;
  C --&gt;|是| D[source-map]
  C --&gt;|否| E[nosources-source-map]
  B --&gt;|否| F&#123;需要错误监控?&#125;
  F --&gt;|是| G[hidden-source-map]
  F --&gt;|否| H[不生成Source Map]</code></pre>

<p>(3) Source Map如何影响性能？</p>
<p>影响维度：</p>
<ul>
<li>构建性能：生成sourcemap增加20%-30%构建时间</li>
<li>文件传输：.map文件增加额外网络请求</li>
<li>浏览器解析：加载sourcemap增加内存占用</li>
<li>安全风险：暴露原始代码结构</li>
</ul>
<h2 id="1-3-模块化兼容"><a href="#1-3-模块化兼容" class="headerlink" title="1.3 模块化兼容"></a>1.3 模块化兼容</h2><h3 id="1-3-1-ES-Module-CommonJS-AMD-混用处理"><a href="#1-3-1-ES-Module-CommonJS-AMD-混用处理" class="headerlink" title="1.3.1 ES Module &#x2F; CommonJS &#x2F; AMD 混用处理"></a>1.3.1 ES Module &#x2F; CommonJS &#x2F; AMD 混用处理</h3><p><strong>模块系统核心差异对比</strong></p>
<table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">ES Module (ESM)</th>
<th align="left">CommonJS (CJS)</th>
<th align="left">AMD</th>
</tr>
</thead>
<tbody><tr>
<td align="left">加载方式</td>
<td align="left">编译时静态分析</td>
<td align="left">运行时动态加载</td>
<td align="left">异步加载</td>
</tr>
<tr>
<td align="left">语法</td>
<td align="left">import&#x2F;export</td>
<td align="left">require&#x2F;module.exports</td>
<td align="left">define&#x2F;require</td>
</tr>
<tr>
<td align="left">适用环境</td>
<td align="left">现代浏览器&#x2F;Node.js v12+</td>
<td align="left">Node.js</td>
<td align="left">浏览器</td>
</tr>
<tr>
<td align="left">模块对象</td>
<td align="left">只读引用</td>
<td align="left">值拷贝</td>
<td align="left">值拷贝</td>
</tr>
<tr>
<td align="left">循环依赖处理</td>
<td align="left">支持（预编译解决）</td>
<td align="left">部分支持（运行时解决）</td>
<td align="left">支持</td>
</tr>
<tr>
<td align="left">Tree Shaking</td>
<td align="left">原生支持</td>
<td align="left">不支持</td>
<td align="left">不支持</td>
</tr>
</tbody></table>
<p><strong>混用场景下的问题与解决方案</strong></p>
<p>(1) 常见混用问题分析</p>
<pre><code class="mermaid">graph TD
  A[模块混用问题] --&gt; B[语法冲突]
  A --&gt; C[作用域污染]
  A --&gt; D[循环依赖风险]
  A --&gt; E[Tree Shaking失效]
  
  B --&gt; B1[ESM的import与CJS的require共存]
  C --&gt; C1[AMD的全局define污染]
  D --&gt; D1[模块间相互引用导致死锁]
  E --&gt; E1[CJS模块无法被Tree Shaking]</code></pre>

<p>(2) Webpack 的模块统一处理</p>
<pre><code class="mermaid">graph LR
  A[ESM] --&gt; D[Webpack模块系统]
  B[CJS] --&gt; D
  C[AMD] --&gt; D
  D --&gt; E[统一模块格式]
  E --&gt; F[输出优化代码]</code></pre>

<p><strong>互操作实践指南</strong></p>
<p>(1) ESM 引用 CJS 模块</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// CJS模块 (math.cjs)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a <span class="token operator">+</span> b<span class="token punctuation">,</span>
  <span class="token constant">PI</span><span class="token operator">:</span> <span class="token number">3.14</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// ESM引用</span>
<span class="token keyword">import</span> math <span class="token keyword">from</span> <span class="token string">'./math.cjs'</span><span class="token punctuation">;</span> <span class="token comment">// 默认导入整个对象</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> add <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./math.cjs'</span><span class="token punctuation">;</span> <span class="token comment">// 命名导入 - 需要特殊处理</span>

<span class="token comment">// 解决方案：CJS模块添加__esModule标记</span>
Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> <span class="token string">'__esModule'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">add</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> a <span class="token operator">+</span> b<span class="token punctuation">,</span>
  <span class="token constant">PI</span><span class="token operator">:</span> <span class="token number">3.14</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) CJS 引用 ESM 模块</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// ESM模块 (utils.mjs)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">log</span> <span class="token operator">=</span> <span class="token parameter">msg</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token string">'1.0'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// CJS引用</span>
<span class="token keyword">const</span> utils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils.mjs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 得到 &#123; default: &#123;...&#125;, log: fn &#125;</span>

<span class="token comment">// 正确使用方式</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> log <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils.mjs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> defaultExport <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils.mjs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) AMD 与 ESM&#x2F;CJS 互操作</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// AMD定义模块</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'require'</span><span class="token punctuation">,</span> <span class="token string">'exports'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  exports<span class="token punctuation">.</span><span class="token function-variable function">sayHello</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 引用ESM模块</span>
    <span class="token keyword">const</span> esModule <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./es-module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    esModule<span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Webpack配置支持AMD</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">libraryTarget</span><span class="token operator">:</span> <span class="token string">'amd'</span> <span class="token comment">// 设置输出格式</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>企业级实践案例</strong></p>
<p>(1) 渐进迁移策略</p>
<pre><code class="mermaid">graph LR
  A[旧AMD系统] --&gt; B[包装为UMD]
  B --&gt; C[新ESM模块]
  C --&gt; D[逐步替换]
  
  subgraph 迁移过程
    B --&gt; E[Webpack配置兼容]
    E --&gt; F[同时支持AMD&#x2F;ESM]
  end</code></pre>

<p>(2) 微前端架构中的应用</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 主应用（ESM）</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'child-app/cjs-module'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  module<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 子应用Webpack配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">library</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'commonjs2'</span> <span class="token comment">// 输出CJS格式</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>常见问题解决方案</strong></p>
<p>(1) __esModule 标记缺失</p>
<p>症状：命名导入CJS模块时报错</p>
<p>解决：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// babel-plugin-transform-esm-to-cjs</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span><span class="token string">'@babel/transform-modules-commonjs'</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">strictMode</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// 自动添加__esModule标记</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) ESM 中动态导入 CJS</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 正确方式</span>
<span class="token keyword">const</span> <span class="token function-variable function">getModule</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> cjsModule <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./legacy.cjs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cjsModule<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 访问默认导出</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>最佳实践总结</strong></p>
<ul>
<li>统一模块规范：<ul>
<li>新项目使用ESM</li>
<li>旧项目逐步迁移</li>
</ul>
</li>
<li>构建配置：</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">mainFields</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'browser'</span><span class="token punctuation">,</span> 
      <span class="token string">'module'</span><span class="token punctuation">,</span> <span class="token comment">// 优先ESM</span>
      <span class="token string">'main'</span>    <span class="token comment">// 其次CJS</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>代码质量：<ul>
<li>使用ESLint规则检测混用问题</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// .eslintrc</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"rules"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"no-restricted-syntax"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"error"</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token property">"selector"</span><span class="token operator">:</span> <span class="token string">"CallExpression[callee.name='require']"</span><span class="token punctuation">,</span>
        <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"请使用import语法"</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="1-3-2-Tree-Shaking深层原理（sideEffects标志）"><a href="#1-3-2-Tree-Shaking深层原理（sideEffects标志）" class="headerlink" title="1.3.2 Tree Shaking深层原理（sideEffects标志）"></a>1.3.2 Tree Shaking深层原理（<code>sideEffects</code>标志）</h3><p><strong>Tree Shaking 的本质与限制</strong></p>
<p>核心原理图解：</p>
<pre><code class="mermaid">graph LR
  A[原始代码] --&gt; B[构建依赖图]
  B --&gt; C[标记使用导出]
  C --&gt; D[删除未使用代码]
  D --&gt; E[优化后代码]</code></pre>

<p>技术前提条件：</p>
<ul>
<li>必须使用 ES Module 语法（import&#x2F;export）</li>
<li>模块依赖关系必须是静态可分析的</li>
<li>编译工具需支持（Webpack&#x2F;Rollup等）</li>
</ul>
<p>CommonJS 的限制：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 无法被Tree Shaking的CommonJS示例</span>
<span class="token keyword">const</span> utils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 动态引入</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> usedFunc <span class="token punctuation">&#125;</span> <span class="token operator">=</span> utils<span class="token punctuation">;</span>       <span class="token comment">// 无法静态分析</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>sideEffects 标志的深层机制</strong></p>
<p>配置方式：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// package.json</span>
<span class="token punctuation">&#123;</span>
  <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"my-package"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"sideEffects"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 整个包无副作用</span>
  <span class="token comment">// 或指定有副作用的文件</span>
  <span class="token string-property property">"sideEffects"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"*.css"</span><span class="token punctuation">,</span>
    <span class="token string">"src/polyfills.js"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>副作用类型分析：</p>
<table>
<thead>
<tr>
<th align="left">副作用类型</th>
<th align="left">示例</th>
<th align="left">处理方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">函数调用副作用</td>
<td align="left"><code>window.APP_CONFIG = &#123;&#125;</code></td>
<td align="left">标记为有副作用</td>
</tr>
<tr>
<td align="left">CSS 导入副作用</td>
<td align="left"><code>import &#39;./styles.css&#39;</code></td>
<td align="left">需显式声明</td>
</tr>
<tr>
<td align="left">Polyfill 副作用</td>
<td align="left"><code>import &#39;core-js/stable&#39;</code></td>
<td align="left">需显式声明</td>
</tr>
<tr>
<td align="left">纯函数</td>
<td align="left"><code>export const add = (a,b) =&gt; a+b</code></td>
<td align="left">安全删除未使用</td>
</tr>
</tbody></table>
<p><strong>Webpack 的 Tree Shaking 处理流程</strong></p>
<p>完整处理流程：</p>
<pre><code class="mermaid">graph TD
  A[收集所有导出] --&gt; B[标记使用导出]
  B --&gt; C&#123;是否有sideEffects标记?&#125;
  C --&gt;|无| D[删除未使用导出]
  C --&gt;|有| E[分析具体副作用]
  E --&gt; F&#123;副作用是否被使用?&#125;
  F --&gt;|是| G[保留整个模块]
  F --&gt;|否| H[删除整个模块]</code></pre>

<p>关键优化阶段：</p>
<ul>
<li>HarmonyExport：识别ESM导出</li>
<li>FlagDependencyUsage：标记依赖</li>
<li>SideEffectsFlag：处理副作用</li>
<li>MangleExports：混淆导出名称</li>
<li>InnerGraph：内部依赖分析（Webpack 5）</li>
</ul>
<p><strong>sideEffects 实战配置指南</strong></p>
<p>(1) 库开发者配置</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// 组件库的package.json</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"sideEffects"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"**/*.css"</span><span class="token punctuation">,</span>
    <span class="token string">"**/*.scss"</span><span class="token punctuation">,</span>
    <span class="token string">"esm/index.js"</span><span class="token punctuation">,</span>    <span class="token comment">// 入口文件可能有副作用</span>
    <span class="token string">"src/setupTests.js"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 应用开发者配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">usedExports</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment">// 启用标记</span>
    <span class="token literal-property property">sideEffects</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment">// 启用副作用分析</span>
    <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token comment">// 启用代码压缩</span>
    <span class="token literal-property property">innerGraph</span><span class="token operator">:</span> <span class="token boolean">true</span>     <span class="token comment">// 启用深度分析（Webpack 5）</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Tree Shaking 失效场景分析</strong></p>
<table>
<thead>
<tr>
<th align="left">失效场景</th>
<th align="left">原因分析</th>
<th align="left">解决方案</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Babel 转译ESM</td>
<td align="left">转为CJS丢失静态特性</td>
<td align="left">保留ESM语法</td>
</tr>
<tr>
<td align="left">动态导入模式</td>
<td align="left">import()非静态分析</td>
<td align="left">重构为静态导入</td>
</tr>
<tr>
<td align="left">副作用模块未声明</td>
<td align="left">CSS文件未声明副作用</td>
<td align="left">正确配置sideEffects</td>
</tr>
<tr>
<td align="left">对象属性访问</td>
<td align="left"><code>obj[dynamicKey]</code></td>
<td align="left">使用纯函数重构</td>
</tr>
<tr>
<td align="left">模块再导出</td>
<td align="left"><code>export * from &#39;./utils&#39;</code></td>
<td align="left">使用命名导出export { func }</td>
</tr>
</tbody></table>
<p>特殊案例：第三方库优化</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 优化lodash导入</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> debounce <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'lodash-es'</span><span class="token punctuation">;</span> <span class="token comment">// 正确</span>
<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>               <span class="token comment">// 错误（整个包被引入）</span>
_<span class="token punctuation">.</span><span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">// Tree Shaking失效</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>高级优化策略</strong></p>
<p>(1) 作用域提升（Scope Hoisting）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 优化前</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">// 优化后</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 减少模块封装代码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 纯注解标记</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/*#__PURE__*/</span> 
<span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token function">createElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 明确标记无副作用</span>

<span class="token comment">// 或使用JSDoc</span>
<span class="token comment">/** @__PURE__ */</span>
<span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试重点解析</strong></p>
<p>(1) 为什么CSS需要特殊处理？</p>
<ol>
<li>CSS导入语法：<code>import &#39;./styles.css&#39;</code></li>
<li>没有显式导出变量</li>
<li>Webpack无法判断是否被使用</li>
<li>需通过<code>sideEffects</code>显式声明：”sideEffects”: [“*.css”]</li>
</ol>
<p>(2) 如何验证Tree Shaking生效？</p>
<p>验证步骤：</p>
<ul>
<li>添加测试导出函数</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// utils.js</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">used</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/*...*/</span> <span class="token punctuation">&#125;</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">unused</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/*...*/</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>只导入使用函数</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> used <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>检查输出bundle：<ul>
<li>搜索 unused 函数是否存在</li>
<li>使用Webpack分析工具验证</li>
</ul>
</li>
</ul>
<p>(3) Webpack 5的Tree Shaking改进？</p>
<p>核心改进：</p>
<ul>
<li>Nested Tree Shaking：嵌套导出分析</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> nested <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">b</span><span class="token operator">:</span> <span class="token number">2</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 仅使用nested.a时删除b属性</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Inner Graph：内部依赖追踪</li>
<li>CommonJS Tree Shaking：基础CJS支持</li>
<li>深度作用域分析：变量级删除</li>
</ul>
<h1 id="二、核心编译流程与扩展"><a href="#二、核心编译流程与扩展" class="headerlink" title="二、核心编译流程与扩展"></a>二、核心编译流程与扩展</h1><h2 id="2-1-Loader机制"><a href="#2-1-Loader机制" class="headerlink" title="2.1 Loader机制"></a>2.1 Loader机制</h2><h3 id="2-1-1-链式调用与执行顺序"><a href="#2-1-1-链式调用与执行顺序" class="headerlink" title="2.1.1 链式调用与执行顺序"></a>2.1.1 链式调用与执行顺序</h3><p><strong>Loader 的本质</strong></p>
<p>Loader本质上是导出为函数的JavaScript模块，webpack内部的loader runner会调用该函数，并将上一个loader的输出结果作为参数传给该函数</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Loader 基本结构</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> map<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 1. 对源代码进行处理</span>
  <span class="token keyword">const</span> transformed <span class="token operator">=</span> <span class="token function">transform</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 2. 返回处理结果（支持多种格式）</span>
  <span class="token keyword">return</span> transformed<span class="token punctuation">;</span> 
  
  <span class="token comment">// 或返回多个值</span>
  <span class="token comment">// this.callback(null, transformed, map, meta);</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>链式调用原理</strong></p>
<p>执行流程示意图：</p>
<pre><code class="mermaid">graph LR
  A[源文件] --&gt; B[Loader1]
  B --&gt; C[Loader2]
  C --&gt; D[Loader3]
  D --&gt; E[处理结果]
  
  subgraph 执行方向
    direction LR
    F[从右到左执行] --&gt; G[从下到上传递]
  end</code></pre>

<p>执行顺序规则：</p>
<table>
<thead>
<tr>
<th align="left">配置位置</th>
<th align="left">执行顺序</th>
<th align="left">示例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">配置数组最后</td>
<td align="left">最先执行</td>
<td align="left">use: [‘style-loader’]</td>
</tr>
<tr>
<td align="left">配置数组中间</td>
<td align="left">中间执行</td>
<td align="left">use: [‘css-loader’]</td>
</tr>
<tr>
<td align="left">配置数组最前</td>
<td align="left">最后执行</td>
<td align="left">use: [‘sass-loader’]</td>
</tr>
</tbody></table>
<p>**完整执行流程分析</p>
<p>(1) 文件处理流程</p>
<pre><code class="mermaid">graph TB
  A[源文件] --&gt; B[Sass-loader]
  B --&gt; |1.编译SCSS| C[CSS-loader]
  C --&gt; |&quot;2.处理@import&#x2F;url&quot;| D[PostCSS-loader]
  D --&gt; |3.自动添加前缀| E[Style-loader]
  E --&gt; |4.注入DOM| F[最终JS输出]</code></pre>

<p>(2) 数据传递机制</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 示例：SCSS文件处理流程</span>
<span class="token comment">// 原始数据流</span>
sass<span class="token operator">-</span><span class="token function">loader</span><span class="token punctuation">(</span>scss<span class="token punctuation">)</span> → css<span class="token operator">-</span><span class="token function">loader</span><span class="token punctuation">(</span>css<span class="token punctuation">)</span> → postcss<span class="token operator">-</span><span class="token function">loader</span><span class="token punctuation">(</span>css<span class="token punctuation">)</span> → style<span class="token operator">-</span><span class="token function">loader</span><span class="token punctuation">(</span>js<span class="token punctuation">)</span>

<span class="token comment">// 各阶段输出：</span>
<span class="token comment">// sass-loader: CSS文本</span>
<span class="token comment">// css-loader: JS模块代码</span>
<span class="token comment">// postcss-loader: 优化后的CSS文本</span>
<span class="token comment">// style-loader: 带DOM操作的JS代码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>控制执行顺序的技巧</strong></p>
<p>(1) 配置优先级</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.scss$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">'style-loader'</span><span class="token punctuation">,</span>  <span class="token comment">// 最后执行（最先放入数组）</span>
        <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
          <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">importLoaders</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 声明前置loader数量</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span> <span class="token comment">// 中间执行</span>
        <span class="token string">'sass-loader'</span>     <span class="token comment">// 最先执行（最后放入数组）</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 使用 enforce 强制排序</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'eslint-loader'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">enforce</span><span class="token operator">:</span> <span class="token string">'pre'</span><span class="token punctuation">,</span> <span class="token comment">// 强制最先执行</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'babel-loader'</span> <span class="token comment">// 默认顺序</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'style-loader'</span><span class="token punctuation">,</span> 
    <span class="token literal-property property">enforce</span><span class="token operator">:</span> <span class="token string">'post'</span> <span class="token comment">// 强制最后执行</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) Loader Pitch</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">//每个 Loader 可定义一个 pitch 方法，Webpack 在真正处理模块内容前会从左向右执行所有 Loader 的 pitch 函数</span>
<span class="token comment">// 当某个 Loader 的 pitch 函数返回非 undefined 值时，会触发熔断效果：</span>
<span class="token comment">// 1.跳过后续所有 Loader 的 pitch 和正常执行</span>
<span class="token comment">// 2.直接返回当前 pitch 的结果作为模块内容</span>
<span class="token comment">// loaderB.js</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token string">'console.log("Skipped by B pitch!");'</span><span class="token punctuation">;</span> <span class="token comment">// 返回字符串</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 执行流程：</span>
<span class="token comment">//   Pitch A → Pitch B (返回结果) → 跳过 Pitch C 和所有 Loader 执行</span>
<span class="token comment">//   ↓</span>
<span class="token comment">//   Webpack 直接将返回的字符串作为模块源码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>特殊场景处理</strong></p>
<p>(1) 前置依赖处理（importLoaders）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// CSS中引用其他资源</span>
<span class="token comment">/* index.css */</span>
@<span class="token keyword">import</span> <span class="token string">'./reset.css'</span><span class="token punctuation">;</span> <span class="token comment">// 需要重新走loader流程</span>

<span class="token comment">// 配置保证@import正确处理</span>
<span class="token punctuation">&#123;</span>
  <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">importLoaders</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token comment">// 指定前置2个loader</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Loader 执行上下文</strong></p>
<p>(1) 关键上下文属性</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 1. 获取配置选项</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 2. 异步回调处理</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 3. 资源路径信息</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 完整文件路径</span>
  
  <span class="token comment">// 4. 添加依赖监视</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>resourcePath <span class="token operator">+</span> <span class="token string">'.map'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 5. 缓存启用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheable<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 异步Loader模式</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 异步Loader示例</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 模拟异步操作</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> source<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">,</span> <span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能优化实践</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 避免不必要的Loader处理</span>
<span class="token punctuation">&#123;</span>
  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
  <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">cacheDirectory</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 启用缓存</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>常见问题解决方案</strong></p>
<p>(1) Loader执行顺序错误</p>
<p>症状：样式未正确应用</p>
<p>解决方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 正确顺序</span>
<span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token comment">// 替代style-loader</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">importLoaders</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">'postcss-loader'</span> <span class="token comment">// 先于css-loader执行</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) Loader未生效</p>
<p>排查步骤：</p>
<ul>
<li>检查Loader是否配置到正确规则</li>
<li>验证文件路径是否匹配test正则</li>
<li>检查Loader是否支持输入格式</li>
<li>在Loader函数中添加日志调试</li>
</ul>
<p><strong>Loader设计原则</strong></p>
<p>(1) 单一职责原则</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 避免</span>
<span class="token keyword">function</span> <span class="token function">allInOneLoader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 处理TypeScript + SCSS + 压缩...</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 推荐</span>
<span class="token comment">// ts-loader → sass-loader → css-loader → minify-loader</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 链式可组合</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 良好设计的Loader输出格式</span>
<span class="token comment">// 文本Loader：输入/输出字符串</span>
<span class="token comment">// JS Loader：输入/输出JS模块</span>
<span class="token comment">// 文件Loader：输入/输出文件路径</span>
<span class="token comment">// 最后一个loader的输出结果应该为String或Buffer类型</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 无状态：不依赖全局状态，所有配置通过options传递</p>
<p>(4) 幂等性：相同输入始终相同输出，避免使用随机值</p>
<p><strong>面试重点解析</strong></p>
<p>(1) Loader为什么从右向左执行？</p>
<p>设计原理：</p>
<ol>
<li>函数组合原理：<code>compose(f, g)(x) = f(g(x))</code></li>
<li>管道模型：输出作为下一个Loader输入</li>
<li>符合直觉顺序：原始文件 → 编译 → 处理 → 输出</li>
</ol>
<p>(2) 如何控制Loader执行顺序？</p>
<p>解决方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 方法1：配置数组顺序</span>
<span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>first<span class="token punctuation">,</span> second<span class="token punctuation">,</span> third<span class="token punctuation">]</span> <span class="token comment">// third → second → first</span>

<span class="token comment">// 方法2：enforce强制排序</span>
<span class="token literal-property property">enforce</span><span class="token operator">:</span> <span class="token string">'pre'</span> <span class="token comment">// 最先执行</span>
<span class="token literal-property property">enforce</span><span class="token operator">:</span> <span class="token string">'post'</span> <span class="token comment">// 最后执行</span>

<span class="token comment">// 方法3：rule顺序（同优先级）</span>
<span class="token comment">// 后定义的rule先执行（从下往上）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) Loader可以异步执行吗？</p>
<p>实现方式：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 方式1：返回Promise</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">resolve</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 方式2：使用this.async()</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">asyncProcess</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-1-2-手写Loader（代码转换-国际化处理案例）"><a href="#2-1-2-手写Loader（代码转换-国际化处理案例）" class="headerlink" title="2.1.2 手写Loader（代码转换&#x2F;国际化处理案例）"></a>2.1.2 手写Loader（代码转换&#x2F;国际化处理案例）</h3><p><strong>Loader 开发基础</strong></p>
<p>Loader 核心结构：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// loader基本模板</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> sourceMap<span class="token punctuation">,</span> meta</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 1. 获取配置选项</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 2. 处理源代码</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">transform</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 3. 返回处理结果</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  
  <span class="token comment">// 或返回多个值</span>
  <span class="token comment">// this.callback(null, result, sourceMap, meta);</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>代码转换案例：HTML 模板处理</strong></p>
<p>(1) 需求场景</p>
<ul>
<li>将 HTML 中的 &lt;%&#x3D; variable %&gt; 替换为 JS 变量</li>
<li>支持条件语句 &lt;% if(cond) { %&gt;</li>
<li>输出可执行 JS 函数</li>
</ul>
<p>(2) 完整实现</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// html-template-loader.js</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> compile <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-template-tag'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 1. 提取模板变量</span>
  <span class="token keyword">const</span> variableRegex <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">&lt;%=\s*([a-zA-Z_$][\w$]*)\s*%></span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> variables <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> match<span class="token punctuation">;</span>
  
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>match <span class="token operator">=</span> variableRegex<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    variables<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token comment">// 2. 生成函数参数</span>
  <span class="token keyword">const</span> params <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>variables<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 3. 编译为模板函数</span>
  <span class="token keyword">const</span> templateCode <span class="token operator">=</span> <span class="token function">compile</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 4. 生成最终函数</span>
  <span class="token keyword">const</span> output <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    export default function render(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>params<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">) &#123;
      return \`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>templateCode<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\`;
    &#125;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> output<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 使用示例</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack配置</span>
<span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.html$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">loader</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'html-template-loader.js'</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>国际化处理案例：i18n 文本替换</strong></p>
<p>(1) 需求场景</p>
<ul>
<li>提取代码中的 __(“key”) 调用</li>
<li>根据语言配置替换为对应文本</li>
<li>支持动态插值 __(“welcome”, { name: user })</li>
</ul>
<p>(2) 完整实现</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// i18n-loader.js</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> transform <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> generate <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> locale <span class="token operator">=</span> options<span class="token punctuation">.</span>locale <span class="token operator">||</span> <span class="token string">'en'</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> messages <span class="token operator">=</span> options<span class="token punctuation">.</span>messages <span class="token operator">||</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 解析AST</span>
  <span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">'module'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'jsx'</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 遍历AST查找__()调用</span>
  <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'__'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> args <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>arguments<span class="token punctuation">;</span>
        
        <span class="token comment">// 验证第一个参数是字符串</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span><span class="token function">isStringLiteral</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> key <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
          
          <span class="token comment">// 获取翻译文本</span>
          <span class="token keyword">const</span> translation <span class="token operator">=</span> messages<span class="token punctuation">[</span>locale<span class="token punctuation">]</span><span class="token operator">?.</span><span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> key<span class="token punctuation">;</span>
          
          <span class="token comment">// 处理插值</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span><span class="token function">isObjectExpression</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">const</span> props <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>properties<span class="token punctuation">;</span>
            <span class="token keyword">let</span> template <span class="token operator">=</span> translation<span class="token punctuation">;</span>
            
            props<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">prop</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
              <span class="token keyword">const</span> varName <span class="token operator">=</span> prop<span class="token punctuation">.</span>key<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
              template <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\&#123;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>varName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\\&#125;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\$&#123;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>varName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&#125;</span><span class="token template-punctuation string">`</span></span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 替换为模板字符串</span>
            path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">templateLiteral</span><span class="token punctuation">(</span>
              <span class="token punctuation">[</span>t<span class="token punctuation">.</span><span class="token function">templateElement</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">raw</span><span class="token operator">:</span> template<span class="token punctuation">,</span> <span class="token literal-property property">cooked</span><span class="token operator">:</span> template <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
              props<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">prop</span> <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">identifier</span><span class="token punctuation">(</span>prop<span class="token punctuation">.</span>key<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 直接替换为文本</span>
            path<span class="token punctuation">.</span><span class="token function">replaceWith</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">stringLiteral</span><span class="token punctuation">(</span>translation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 生成代码</span>
  <span class="token keyword">return</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 配置示例</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.jsx?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">loader</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'i18n-loader.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">locale</span><span class="token operator">:</span> <span class="token string">'zh-CN'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">messages</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token string-property property">'zh-CN'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string-property property">'welcome'</span><span class="token operator">:</span> <span class="token string">'欢迎，&#123;name&#125;！'</span><span class="token punctuation">,</span>
                <span class="token string-property property">'logout'</span><span class="token operator">:</span> <span class="token string">'退出登录'</span>
              <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
              <span class="token literal-property property">en</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
                <span class="token string-property property">'welcome'</span><span class="token operator">:</span> <span class="token string">'Welcome, &#123;name&#125;!'</span><span class="token punctuation">,</span>
                <span class="token string-property property">'logout'</span><span class="token operator">:</span> <span class="token string">'Logout'</span>
              <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Loader 高级功能实现</strong></p>
<p>(1) 缓存与性能优化</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 启用缓存</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cacheable<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cacheable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 添加文件依赖</span>
  <span class="token keyword">const</span> i18nFile <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'locales.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>i18nFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 异步处理</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>i18nFile<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">const</span> messages <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">process</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> messages<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) Source Map 支持</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> sourceMap</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 生成新Source Map</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">transform</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>code<span class="token punctuation">,</span> result<span class="token punctuation">.</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>企业级案例：安全过滤Loader</strong></p>
<p>(1) 需求场景</p>
<ul>
<li>过滤生产环境中的调试代码</li>
<li>移除 console.debug 调用</li>
<li>删除 @test-only 标记的代码块</li>
</ul>
<p>(2) 完整实现</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// secure-loader.js</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> generate <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/generator'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> t <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/types'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 仅在生产环境启用</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> source<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">'module'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'jsx'</span><span class="token punctuation">,</span> <span class="token string">'typescript'</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 移除console.debug</span>
    <span class="token function">CallExpression</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isMemberExpression</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>object<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'console'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          t<span class="token punctuation">.</span><span class="token function">isIdentifier</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>property<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'debug'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        path<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    
    <span class="token comment">// 移除@test-only标记代码块</span>
    <span class="token function">BlockStatement</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> comments <span class="token operator">=</span> path<span class="token punctuation">.</span>node<span class="token punctuation">.</span>innerComments <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>comments<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">c</span> <span class="token operator">=></span> c<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'@test-only'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        path<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    
    <span class="token comment">// 移除debugger语句</span>
    <span class="token function">DebuggerStatement</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      path<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">generate</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">.</span>code<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-1-3-性能优化：Loader缓存、多进程编译（thread-loader）"><a href="#2-1-3-性能优化：Loader缓存、多进程编译（thread-loader）" class="headerlink" title="2.1.3 性能优化：Loader缓存、多进程编译（thread-loader）"></a>2.1.3 性能优化：Loader缓存、多进程编译（<code>thread-loader</code>）</h3><p><strong>Loader 性能瓶颈分析</strong></p>
<p>常见性能问题：</p>
<table>
<thead>
<tr>
<th align="left">问题类型</th>
<th align="left">表现特征</th>
<th align="left">影响程度</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CPU密集型Loader</td>
<td align="left">Babel&#x2F;TypeScript编译慢</td>
<td align="left">高</td>
</tr>
<tr>
<td align="left">IO密集型Loader</td>
<td align="left">文件读取&#x2F;网络请求</td>
<td align="left">中</td>
</tr>
<tr>
<td align="left">重复计算</td>
<td align="left">相同文件反复处理</td>
<td align="left">高</td>
</tr>
<tr>
<td align="left">单线程阻塞</td>
<td align="left">无法利用多核CPU</td>
<td align="left">极高</td>
</tr>
</tbody></table>
<p>性能影响量化：</p>
<pre><code class="mermaid">graph LR
  A[构建时间] --&gt; B[Loader处理]
  B --&gt; C[CPU密集型 60%]
  B --&gt; D[IO操作 30%]
  B --&gt; E[其他 10%]</code></pre>

<p><strong>Loader 缓存优化方案</strong></p>
<p>(1) cache-loader 工作原理</p>
<pre><code class="mermaid">graph TB
  A[源文件] --&gt; B[cache-loader]
  B --&gt; C&#123;缓存是否存在?&#125;
  C --&gt;|是| D[读取缓存结果]
  C --&gt;|否| E[执行后续Loader]
  E --&gt; F[保存结果到缓存]
  F --&gt; G[返回处理结果]</code></pre>

<p>(2) 配置示例</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'cache-loader'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">cacheDirectory</span><span class="token operator">:</span> <span class="token string">'./.cache/loader'</span><span class="token punctuation">,</span> <span class="token comment">// 缓存路径</span>
              <span class="token literal-property property">cacheIdentifier</span><span class="token operator">:</span> <span class="token string">'v1'</span><span class="token punctuation">,</span> <span class="token comment">// 缓存版本标识</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          <span class="token string">'babel-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">'style-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'cache-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'postcss-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 缓存策略对比</p>
<table>
<thead>
<tr>
<th align="left">方案</th>
<th align="left">适用场景</th>
<th align="left">优点</th>
<th align="left">缺点</th>
</tr>
</thead>
<tbody><tr>
<td align="left">cache-loader</td>
<td align="left">通用Loader</td>
<td align="left">配置简单</td>
<td align="left">额外I&#x2F;O开销</td>
</tr>
<tr>
<td align="left">babel-loader缓存</td>
<td align="left">Babel专用</td>
<td align="left">零配置</td>
<td align="left">仅适用Babel</td>
</tr>
<tr>
<td align="left">自定义文件缓存</td>
<td align="left">特殊需求</td>
<td align="left">灵活控制</td>
<td align="left">开发成本高</td>
</tr>
</tbody></table>
<p><strong>多进程编译：thread-loader</strong></p>
<p>架构原理：</p>
<pre><code class="mermaid">graph LR
  A[主进程] --&gt; B[创建Worker池]
  B --&gt; C[Worker 1]
  B --&gt; D[Worker 2]
  B --&gt; E[Worker 3]
  C --&gt; F[处理文件1]
  D --&gt; G[处理文件2]
  E --&gt; H[处理文件3]</code></pre>

<p>完整配置：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// CPU核心数-1</span>
              <span class="token literal-property property">workerParallelJobs</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>
              <span class="token literal-property property">poolTimeout</span><span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>
              <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'js-pool'</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          <span class="token string">'babel-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">'style-loader'</span><span class="token punctuation">,</span>
          <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
              <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'css-pool'</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'postcss-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能优化组合拳：缓存 + 多进程方案</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 最佳实践配置</span>
<span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token string">'cache-loader'</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string">'babel-loader'</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>高级优化策略</strong></p>
<p>(1) Worker 池共享</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// shared-pool.js</span>
<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'thread-loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 预热线程池</span>
threadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token literal-property property">poolTimeout</span><span class="token operator">:</span> <span class="token number">Infinity</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">,</span> <span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">pool</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token number">4</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> pool <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./shared-pool'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">&#123;</span> <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> pool <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          <span class="token string">'babel-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 智能任务分配</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 根据文件大小选择方案</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> fileSize <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">byteLength</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 小文件直接处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fileSize <span class="token operator">&lt;</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// &lt; 10KB</span>
    <span class="token keyword">return</span> <span class="token function">processSmallFile</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token comment">// 大文件使用Worker线程</span>
  <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  workerPool<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> source <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能监控与调优</strong></p>
<p>(1) 构建分析工具</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 1. 安装速度分析插件</span>
<span class="token function">npm</span> <span class="token function">install</span> --save-dev speed-measure-webpack-plugin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 2. 配置使用</span>
<span class="token keyword">const</span> SpeedMeasurePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'speed-measure-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> smp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpeedMeasurePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> smp<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token comment">// webpack配置</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 优化决策树</p>
<pre><code class="mermaid">graph TD
  A[构建速度慢?] --&gt; B&#123;主要瓶颈类型&#125;
  B --&gt; C[CPU密集型] --&gt; D[添加thread-loader]
  B --&gt; E[IO密集型] --&gt; F[添加cache-loader]
  B --&gt; G[重复计算] --&gt; H[启用持久化缓存]
  
  D --&gt; I[Worker数量&#x3D;CPU核心数-1]
  F --&gt; J[缓存目录分离]
  H --&gt; K[Webpack5持久化缓存]</code></pre>

<p><strong>常见问题解决方案</strong></p>
<p>(1) 缓存失效</p>
<p>症状：修改文件后未更新</p>
<p>解决方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// cache-loader配置</span>
<span class="token punctuation">&#123;</span>
  <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'cache-loader'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">cacheIdentifier</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">v2-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// 添加环境变量</span>
    <span class="token literal-property property">cacheDirectory</span><span class="token operator">:</span> <span class="token string">'./.cache/$&#123;projectName&#125;'</span> <span class="token comment">// 项目隔离</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) Worker内存泄漏</p>
<p>诊断：构建后进程未退出</p>
<p>解决：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">poolTimeout</span><span class="token operator">:</span> <span class="token number">2000</span> <span class="token comment">// 超时自动关闭</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-2-Plugin系统"><a href="#2-2-Plugin系统" class="headerlink" title="2.2 Plugin系统"></a>2.2 Plugin系统</h2><p>webpack插件是一个具有 apply 方法的 JavaScript 类。apply 方法会被 webpack compiler 调用，并且在 整个 编译生命周期都可以访问 compiler 对象，插件目的在于解决 loader 无法实现的其他事，包括：打包优化，资源管理，注入环境变量。</p>
<h3 id="2-2-1-Compiler与Compilation对象生命周期"><a href="#2-2-1-Compiler与Compilation对象生命周期" class="headerlink" title="2.2.1 Compiler与Compilation对象生命周期"></a>2.2.1 Compiler与Compilation对象生命周期</h3><p><strong>核心对象关系图谱</strong></p>
<pre><code class="mermaid">graph TD
  A[Compiler] --&gt;|创建| B[Compilation]
  B --&gt;|模块处理| C[Module]
  C --&gt;|依赖解析| D[Dependency]
  B --&gt;|资源生成| E[Chunk]
  E --&gt;|输出| F[Asset]
  
  subgraph 生命周期流程
    G[初始化] --&gt; H[编译]
    H --&gt; I[优化]
    I --&gt; J[输出]
  end</code></pre>

<p><strong>Compiler对象深度解析</strong></p>
<p>Compiler核心职责：</p>
<ul>
<li>Webpack环境的总控制器</li>
<li>维护完整的配置信息</li>
<li>启动和停止构建过程</li>
<li>监听文件系统变化</li>
</ul>
<p>Compiler生命周期钩子：</p>
<table>
<thead>
<tr>
<th align="left">钩子名称</th>
<th align="left">触发时机</th>
<th align="left">类型</th>
<th align="left">典型应用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">initialize</td>
<td align="left">初始化时</td>
<td align="left">sync</td>
<td align="left">插件初始化</td>
</tr>
<tr>
<td align="left">run</td>
<td align="left">开始构建前</td>
<td align="left">async</td>
<td align="left">环境准备</td>
</tr>
<tr>
<td align="left">watchRun</td>
<td align="left">监听模式启动</td>
<td align="left">async</td>
<td align="left">开发服务器</td>
</tr>
<tr>
<td align="left">beforeRun</td>
<td align="left">实际构建前</td>
<td align="left">async</td>
<td align="left">清理操作</td>
</tr>
<tr>
<td align="left">compile</td>
<td align="left">创建Compilation前</td>
<td align="left">sync</td>
<td align="left">修改编译参数</td>
</tr>
<tr>
<td align="left">make</td>
<td align="left">编译阶段开始</td>
<td align="left">parallel</td>
<td align="left">添加entry</td>
</tr>
<tr>
<td align="left">emit</td>
<td align="left">生成资源前</td>
<td align="left">async</td>
<td align="left">修改输出文件</td>
</tr>
<tr>
<td align="left">afterEmit</td>
<td align="left">资源输出后</td>
<td align="left">async</td>
<td align="left">清理临时文件</td>
</tr>
<tr>
<td align="left">done</td>
<td align="left">构建完成</td>
<td align="left">async</td>
<td align="left">输出统计信息</td>
</tr>
<tr>
<td align="left">failed</td>
<td align="left">构建失败</td>
<td align="left">sync</td>
<td align="left">错误处理</td>
</tr>
</tbody></table>
<p><strong>Compilation对象深度解析</strong></p>
<p>Compilation核心职责：</p>
<ul>
<li>单次构建过程的控制器</li>
<li>维护模块依赖图</li>
<li>优化chunks结构</li>
<li>生成最终资源文件</li>
</ul>
<p>Compilation生命周期钩子：</p>
<table>
<thead>
<tr>
<th align="left">钩子名称</th>
<th align="left">触发时机</th>
<th align="left">类型</th>
<th align="left">典型应用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">buildModule</td>
<td align="left">模块构建前</td>
<td align="left">sync</td>
<td align="left">修改模块源码</td>
</tr>
<tr>
<td align="left">succeedModule</td>
<td align="left">模块构建成功</td>
<td align="left">sync</td>
<td align="left">模块分析</td>
</tr>
<tr>
<td align="left">finishModules</td>
<td align="left">所有模块完成</td>
<td align="left">sync</td>
<td align="left">依赖分析</td>
</tr>
<tr>
<td align="left">seal</td>
<td align="left">开始封装chunks</td>
<td align="left">sync</td>
<td align="left">修改chunk分组</td>
</tr>
<tr>
<td align="left">optimizeDependencies</td>
<td align="left">优化依赖</td>
<td align="left">sync</td>
<td align="left">删除未使用模块</td>
</tr>
<tr>
<td align="left">optimize</td>
<td align="left">优化阶段开始</td>
<td align="left">sync</td>
<td align="left">自定义优化</td>
</tr>
<tr>
<td align="left">optimizeModules</td>
<td align="left">优化模块</td>
<td align="left">sync</td>
<td align="left">模块级优化</td>
</tr>
<tr>
<td align="left">optimizeChunks</td>
<td align="left">优化chunks</td>
<td align="left">sync</td>
<td align="left">拆分&#x2F;合并chunk</td>
</tr>
<tr>
<td align="left">optimizeTree</td>
<td align="left">优化依赖树</td>
<td align="left">async</td>
<td align="left">高级优化</td>
</tr>
<tr>
<td align="left">optimizeChunkModules</td>
<td align="left">优化chunk中模块</td>
<td align="left">async</td>
<td align="left">模块级压缩</td>
</tr>
<tr>
<td align="left">optimizeAssets</td>
<td align="left">优化资源</td>
<td align="left">async</td>
<td align="left">资源压缩</td>
</tr>
<tr>
<td align="left">processAssets</td>
<td align="left">处理资源</td>
<td align="left">async</td>
<td align="left">资源修改</td>
</tr>
</tbody></table>
<p><strong>完整生命周期流程图</strong></p>
<pre><code class="mermaid">sequenceDiagram
  participant C as Compiler
  participant Cp as Compilation
  participant M as Module
  participant D as Dependencies

  C-&gt;&gt;C: initialize
  C-&gt;&gt;C: run
  C-&gt;&gt;C: beforeRun
  C-&gt;&gt;C: compile
  C-&gt;&gt;Cp: 创建Compilation
  Cp-&gt;&gt;Cp: addEntry
  Cp-&gt;&gt;M: buildModule
  M-&gt;&gt;D: 解析依赖
  D-&gt;&gt;M: 递归添加新模块
  loop 所有模块
    Cp-&gt;&gt;M: processModule
  end
  Cp-&gt;&gt;Cp: finishModules
  Cp-&gt;&gt;Cp: seal
  Cp-&gt;&gt;Cp: optimizeDependencies
  Cp-&gt;&gt;Cp: createChunks
  Cp-&gt;&gt;Cp: optimizeChunks
  Cp-&gt;&gt;Cp: optimizeAssets
  C-&gt;&gt;C: emit
  C-&gt;&gt;C: afterEmit
  Cp-&gt;&gt;C: 报告统计信息
  C-&gt;&gt;C: done</code></pre>

<p><strong>面试重点解析</strong></p>
<p>Compiler和Compilation的区别？</p>
<ul>
<li>职责范围：<ul>
<li>Compiler：全局控制器，负责整个Webpack环境的生命周期</li>
<li>Compilation：单次构建过程的控制器</li>
</ul>
</li>
<li>生命周期：<ul>
<li>Compiler：从启动到关闭持续存在</li>
<li>Compilation：每次构建时创建，构建结束后销毁</li>
</ul>
</li>
<li>数据存储：<ul>
<li>Compiler：存储全局配置、插件状态</li>
<li>Compilation：存储模块图、chunks、资源</li>
</ul>
</li>
</ul>
<h3 id="2-2-2-手写Plugin（资源注入-构建分析案例）"><a href="#2-2-2-手写Plugin（资源注入-构建分析案例）" class="headerlink" title="2.2.2 手写Plugin（资源注入&#x2F;构建分析案例）"></a>2.2.2 手写Plugin（资源注入&#x2F;构建分析案例）</h3><p><strong>Plugin 核心机制</strong></p>
<p>插件基本结构：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">MyPlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 1. 注册生命周期钩子</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>someHook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'MyPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 2. 处理逻辑</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 3. 异步钩子处理</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'MyPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 4. 操作compilation</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 必须调用</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>资源注入案例：版本信息注入</strong></p>
<p>需求场景：</p>
<ul>
<li>在打包文件中添加构建版本号</li>
<li>自动生成构建时间戳</li>
<li>注入Git提交信息</li>
</ul>
<p>完整实现：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> execSync <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">VersionInfoPlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> options<span class="token punctuation">.</span>filename <span class="token operator">||</span> <span class="token string">'version.json'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token function">getGitInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">branch</span><span class="token operator">:</span> <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git rev-parse --abbrev-ref HEAD'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">commit</span><span class="token operator">:</span> <span class="token function">execSync</span><span class="token punctuation">(</span><span class="token string">'git rev-parse HEAD'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">date</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'Git not available'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'VersionInfoPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> versionInfo <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">buildTime</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">version</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VERSION</span> <span class="token operator">||</span> <span class="token string">'1.0.0'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">env</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">,</span>
        <span class="token literal-property property">git</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getGitInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 将版本信息转为JSON</span>
      <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>versionInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 添加到资源列表</span>
      compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>filename<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token function-variable function">source</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> json<span class="token punctuation">,</span>
        <span class="token function-variable function">size</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> json<span class="token punctuation">.</span>length
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用示例：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> VersionInfoPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./version-info-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">VersionInfoPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'build-info.json'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>构建分析案例：模块依赖报告</strong></p>
<p>需求场景：</p>
<ul>
<li>生成模块依赖关系图</li>
<li>统计模块大小分布</li>
<li>识别大型模块</li>
</ul>
<p>完整实现：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">BundleAnalyzerPlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>filename <span class="token operator">=</span> options<span class="token punctuation">.</span>filename <span class="token operator">||</span> <span class="token string">'module-report.html'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">=</span> options<span class="token punctuation">.</span>threshold <span class="token operator">||</span> <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment">// KB</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'BundleAnalyzerPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> json <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> modules <span class="token operator">=</span> json<span class="token punctuation">.</span>modules<span class="token punctuation">;</span>
      
      <span class="token comment">// 1. 收集模块数据</span>
      <span class="token keyword">const</span> moduleData <span class="token operator">=</span> modules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">id</span><span class="token operator">:</span> module<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> module<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> module<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
        <span class="token literal-property property">chunks</span><span class="token operator">:</span> module<span class="token punctuation">.</span>chunks<span class="token punctuation">,</span>
        <span class="token literal-property property">reasons</span><span class="token operator">:</span> module<span class="token punctuation">.</span>reasons<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=></span> r<span class="token punctuation">.</span>moduleName<span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 2. 生成HTML报告</span>
      <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateReport</span><span class="token punctuation">(</span>moduleData<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 3. 写入输出目录</span>
      <span class="token keyword">const</span> outputPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>
        stats<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span>outputOptions<span class="token punctuation">.</span>path<span class="token punctuation">,</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>filename
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token function">generateReport</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 过滤大型模块</span>
    <span class="token keyword">const</span> largeModules <span class="token operator">=</span> modules<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> m<span class="token punctuation">.</span>size <span class="token operator">></span> <span class="token keyword">this</span><span class="token punctuation">.</span>threshold <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 生成HTML内容</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;!DOCTYPE html>
&lt;html>
&lt;head>
  &lt;title>Bundle Analysis Report&lt;/title>
  &lt;style>
    table &#123; border-collapse: collapse; width: 100%; &#125;
    th, td &#123; border: 1px solid #ddd; padding: 8px; &#125;
    tr:nth-child(even) &#123; background-color: #f2f2f2; &#125;
  &lt;/style>
&lt;/head>
&lt;body>
  &lt;h1>Bundle Analysis Report&lt;/h1>
  
  &lt;h2>Large Modules (></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>threshold<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">KB)&lt;/h2>
  &lt;table>
    &lt;tr>&lt;th>Module&lt;/th>&lt;th>Size (KB)&lt;/th>&lt;th>Dependencies&lt;/th>&lt;/tr>
    </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>largeModules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;tr>
        &lt;td></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>m<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/td>
        &lt;td></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/td>
        &lt;td></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>m<span class="token punctuation">.</span>reasons<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'&lt;br>'</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/td>
      &lt;/tr>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
  &lt;/table>
  
  &lt;h2>All Modules&lt;/h2>
  &lt;table>
    &lt;tr>&lt;th>Module&lt;/th>&lt;th>Size (KB)&lt;/th>&lt;/tr>
    </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>modules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
      &lt;tr>
        &lt;td></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>m<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/td>
        &lt;td></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>size <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&lt;/td>
      &lt;/tr>
    </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">
  &lt;/table>
&lt;/body>
&lt;/html></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>高级插件开发技巧</strong></p>
<p>(1) 多钩子协同工作</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">AdvancedPlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 编译开始前准备数据</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeRun<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'AdvancedPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compiler<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 处理模块</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'AdvancedPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>buildModule<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'AdvancedPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        module<span class="token punctuation">.</span>useCache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 资源输出</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'AdvancedPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span><span class="token string">'cache-info.json'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token function-variable function">source</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span>stats<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">size</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">.</span>stats<span class="token punctuation">)</span><span class="token punctuation">.</span>length
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 跨插件通信</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 插件A：提供数据</span>
<span class="token keyword">class</span> <span class="token class-name">DataProviderPlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>thisCompilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'DataProviderPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      compilation<span class="token punctuation">.</span>dataProvider <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token comment">// 暴露接口</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 插件B：使用数据</span>
<span class="token keyword">class</span> <span class="token class-name">DataConsumerPlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'DataConsumerPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>compilation<span class="token punctuation">.</span>dataProvider<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> data <span class="token operator">=</span> compilation<span class="token punctuation">.</span>dataProvider<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
        <span class="token comment">// 使用数据...</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>插件调试与测试</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> MemoryFS <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'memory-fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">runWebpack</span><span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryFS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> fs<span class="token punctuation">;</span>
    
    compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> stats<span class="token punctuation">,</span> fs <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 测试用例</span>
<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'VersionInfoPlugin generates file'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">VersionInfoPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> fs <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">runWebpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token string">'/dist/version.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'/dist/version.json'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveProperty</span><span class="token punctuation">(</span><span class="token string">'buildTime'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能优化策略</strong></p>
<p>(1) 避免阻塞钩子</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 错误：在同步钩子中执行I/O操作</span>
compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'MyPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'large-data.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 阻塞操作</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 正确：异步处理</span>
compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>beforeRun<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'MyPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compiler<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'large-data.json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 缓存计算结果</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">CachedPlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>thisCompilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'CachedPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token function">heavyCalculation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 只计算一次</span>
      <span class="token punctuation">&#125;</span>
      compilation<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>cache<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>最佳实践指南</strong></p>
<p>(1) 插件设计原则</p>
<table>
<thead>
<tr>
<th align="left">原则</th>
<th align="left">说明</th>
<th align="left">示例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">单一职责</td>
<td align="left">一个插件只做一件事</td>
<td align="left">分离资源注入和构建分析</td>
</tr>
<tr>
<td align="left">配置驱动</td>
<td align="left">通过选项控制行为</td>
<td align="left"><code>new Plugin(&#123; filename: &#39;report.html&#39; &#125;)</code></td>
</tr>
<tr>
<td align="left">错误处理</td>
<td align="left">妥善处理异常</td>
<td align="left">使用compilation.errors收集错误</td>
</tr>
<tr>
<td align="left">文档完善</td>
<td align="left">提供使用说明</td>
<td align="left">包含README和类型定义</td>
</tr>
</tbody></table>
<p>(2) 安全注意事项</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">SafePlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'SafePlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 1. 避免修改原始资源</span>
      <span class="token keyword">const</span> asset <span class="token operator">=</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> newSource <span class="token operator">=</span> <span class="token function">transform</span><span class="token punctuation">(</span>asset<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建副本</span>
      
      <span class="token comment">// 2. 添加新资源</span>
      compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span><span class="token string">'main-safe.js'</span><span class="token punctuation">]</span> <span class="token operator">=</span> newSource<span class="token punctuation">;</span>
      
      <span class="token comment">// 3. 错误处理</span>
      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token function">riskyOperation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        compilation<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试重点解析</strong></p>
<p>(1) Plugin与Loader的区别？</p>
<table>
<thead>
<tr>
<th align="left">维度</th>
<th align="left">Loader</th>
<th align="left">Plugin</th>
</tr>
</thead>
<tbody><tr>
<td align="left">功能范围</td>
<td align="left">模块级别转换</td>
<td align="left">构建流程控制</td>
</tr>
<tr>
<td align="left">运行时机</td>
<td align="left">模块加载时</td>
<td align="left">整个构建生命周期</td>
</tr>
<tr>
<td align="left">使用方式</td>
<td align="left">配置在module.rules</td>
<td align="left">配置在plugins数组</td>
</tr>
<tr>
<td align="left">操作对象</td>
<td align="left">单个文件内容</td>
<td align="left">Compiler&#x2F;Compilation对象</td>
</tr>
<tr>
<td align="left">典型应用</td>
<td align="left">编译JSX、转换SCSS</td>
<td align="left">资源优化、环境注入、报告生成</td>
</tr>
</tbody></table>
<p>(2) 如何实现资源压缩插件？</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">MinifyPlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'MinifyPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>compilation<span class="token punctuation">.</span>assets<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">name</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> source <span class="token operator">=</span> compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">const</span> minified <span class="token operator">=</span> <span class="token function">minify</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 压缩实现</span>
          compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            <span class="token function-variable function">source</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> minified<span class="token punctuation">,</span>
            <span class="token function-variable function">size</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> minified<span class="token punctuation">.</span>length
          <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 如何开发可配置的插件</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">ConfigurablePlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 默认配置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'report.html'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">threshold</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      <span class="token literal-property property">include</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 使用this.options配置</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-2-3-常用插件原理剖析：HtmlWebpackPlugin-DefinePlugin"><a href="#2-2-3-常用插件原理剖析：HtmlWebpackPlugin-DefinePlugin" class="headerlink" title="2.2.3 常用插件原理剖析：HtmlWebpackPlugin &#x2F; DefinePlugin"></a>2.2.3 常用插件原理剖析：<code>HtmlWebpackPlugin</code> &#x2F; <code>DefinePlugin</code></h3><p><strong>HtmlWebpackPlugin 深度解析</strong></p>
<p>核心功能架构：</p>
<pre><code class="mermaid">graph TD
  A[入口配置] --&gt; B[读取模板]
  B --&gt; C[注入资源]
  C --&gt; D[优化HTML]
  D --&gt; E[生成HTML文件]
  
  subgraph 核心处理
    C1[资源注入] --&gt; C2[Chunks映射]
    C3[变量替换] --&gt; C4[模板渲染]
  end</code></pre>

<p>工作原理流程图：</p>
<pre><code class="mermaid">sequenceDiagram
  participant Webpack
  participant HtmlWebpackPlugin
  participant Compiler
  
  Webpack-&gt;&gt;Compiler: 编译开始
  Compiler-&gt;&gt;HtmlWebpackPlugin: 触发compilation事件
  HtmlWebpackPlugin-&gt;&gt;HtmlWebpackPlugin: 初始化模板
  HtmlWebpackPlugin-&gt;&gt;Compiler: 获取资源清单
  HtmlWebpackPlugin-&gt;&gt;HtmlWebpackPlugin: 生成HTML内容
  HtmlWebpackPlugin-&gt;&gt;Compiler: 添加HTML到资源
  Compiler-&gt;&gt;Webpack: 输出HTML文件</code></pre>

<p><strong>HtmlWebpackPlugin 核心机制</strong></p>
<p>(1) 资源注入原理</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 伪代码实现</span>
<span class="token keyword">class</span> <span class="token class-name">HtmlWebpackPlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'HtmlWebpackPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 1. 获取所有资源文件</span>
      <span class="token keyword">const</span> assets <span class="token operator">=</span> compilation<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 2. 生成资源标签</span>
      <span class="token keyword">const</span> scripts <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=></span> a<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;script src="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>a<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">">&lt;/script></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">const</span> styles <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=></span> a<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.css'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=></span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">&lt;link href="</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>a<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">" rel="stylesheet"></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 3. 读取模板</span>
      <span class="token keyword">const</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'template.html'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 4. 替换占位符</span>
      <span class="token keyword">const</span> html <span class="token operator">=</span> template
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'&lt;!-- scripts -->'</span><span class="token punctuation">,</span> scripts<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'&lt;!-- styles -->'</span><span class="token punctuation">,</span> styles<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 5. 添加到资源列表</span>
      compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span><span class="token string">'index.html'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token function-variable function">source</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> html<span class="token punctuation">,</span>
        <span class="token function-variable function">size</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> html<span class="token punctuation">.</span>length
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 多页面配置原理</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 动态生成多页面配置</span>
<span class="token keyword">const</span> pages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">,</span> <span class="token string">'about'</span><span class="token punctuation">,</span> <span class="token string">'contact'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> pages<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">page</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./src/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>page<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>page<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>page<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token comment">// 仅注入当前页面chunk</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>DefinePlugin 深度解析</strong></p>
<p>工作原理示意图：</p>
<pre><code class="mermaid">graph LR
  A[源码] --&gt; B[DefinePlugin处理]
  B --&gt; C&#123;全局常量替换&#125;
  C --&gt; D[开发环境值]
  C --&gt; E[生产环境值]
  D --&gt; F[处理后的代码]
  E --&gt; F</code></pre>

<p>源码替换过程：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 原始代码</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Environment: "</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"API Key: "</span><span class="token punctuation">,</span> <span class="token constant">API_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 经过DefinePlugin处理后</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Environment: "</span><span class="token punctuation">,</span> <span class="token string">"development"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"API Key: "</span><span class="token punctuation">,</span> <span class="token string">"abc123xyz"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>DefinePlugin 核心机制</strong></p>
<p>(1) 实现原理剖析</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">DefinePlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">definitions</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>definitions <span class="token operator">=</span> definitions<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'DefinePlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>normalModuleLoader<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'DefinePlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">loaderContext<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 替换源代码中的标识符</span>
        module<span class="token punctuation">.</span><span class="token function-variable function">source</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> source <span class="token operator">=</span> module<span class="token punctuation">.</span><span class="token function">originalSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token function">replaceIdentifiers</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>definitions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 标识符替换函数</span>
<span class="token keyword">function</span> <span class="token function">replaceIdentifiers</span><span class="token punctuation">(</span><span class="token parameter">source<span class="token punctuation">,</span> definitions</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">let</span> code <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>definitions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">key</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> value <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>definitions<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> regex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RegExp</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\\b</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>key<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">\\b</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    code <span class="token operator">=</span> code<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>regex<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> code<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 安全替换策略</p>
<table>
<thead>
<tr>
<th align="left">替换方式</th>
<th align="left">示例</th>
<th align="left">优点</th>
<th align="left">缺点</th>
</tr>
</thead>
<tbody><tr>
<td align="left">直接文本替换</td>
<td align="left"><code>API_KEY → &quot;abc123&quot;</code></td>
<td align="left">简单高效</td>
<td align="left">可能误替换变量</td>
</tr>
<tr>
<td align="left">作用域感知替换</td>
<td align="left"><code>process.env.NODE_ENV → &quot;production&quot;</code></td>
<td align="left">准确</td>
<td align="left">实现复杂</td>
</tr>
<tr>
<td align="left">AST级替换</td>
<td align="left">解析后替换标识符</td>
<td align="left">最安全</td>
<td align="left">性能开销大</td>
</tr>
</tbody></table>
<p><strong>企业级应用场景</strong></p>
<p>(1) 动态配置HtmlWebpackPlugin</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 根据环境生成不同配置</span>
<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'src/index.ejs'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'index.html'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">minify</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span> <span class="token operator">?</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">collapseWhitespace</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">removeComments</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token literal-property property">meta</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string-property property">'og:image'</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span> 
      <span class="token operator">?</span> <span class="token string">'https://prod.cdn.com/logo.png'</span>
      <span class="token operator">:</span> <span class="token string">'https://dev.cdn.com/logo.png'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 高级DefinePlugin配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token comment">// 安全字符串化</span>
  <span class="token literal-property property">__DEV__</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  
  <span class="token comment">// 计算值</span>
  <span class="token literal-property property">__BUILD_DATE__</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  
  <span class="token comment">// 复杂对象</span>
  <span class="token literal-property property">__APP_CONFIG__</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">apiEndpoint</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">API_URL</span> <span class="token operator">||</span> <span class="token string">'/api'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">enableAnalytics</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>常见问题解决方案</strong></p>
<p>(1) HtmlWebpackPlugin 循环依赖问题</p>
<p>症状：Error: Cyclic dependency</p>
<p>原因：多个HTML模板相互引用</p>
<p>解决方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 配置独立chunks</span>
<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'pageA.html'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'pageA'</span><span class="token punctuation">]</span> <span class="token comment">// 仅包含当前页面chunk</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'pageB.html'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'pageB'</span><span class="token punctuation">]</span> <span class="token comment">// 不包含pageA的chunk</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) DefinePlugin 替换不生效</p>
<p>诊断步骤：</p>
<ul>
<li>检查变量名是否完全匹配</li>
<li>确认是否被其他插件覆盖</li>
<li>验证环境变量是否传递正确</li>
<li>使用<code>console.log(__VARIABLE__)</code>调试</li>
</ul>
<p><strong>面试重点解析</strong></p>
<p>(1) HtmlWebpackPlugin如何实现多页面支持？</p>
<p>实现原理：</p>
<ul>
<li>根据配置创建多个实例</li>
<li>每个实例管理独立入口</li>
<li>通过chunks选项控制资源注入</li>
<li>共享模板引擎但隔离数据</li>
</ul>
<p>(2) DefinePlugin为什么比环境变量更安全？</p>
<p>安全优势：</p>
<ol>
<li>编译时替换：不暴露在运行时环境中</li>
<li>值优化：直接替换为字面量（如true而非字符串”true”）</li>
<li>作用域限定：只替换源代码中精确匹配的标识符</li>
<li>不可变：替换后无法在运行时修改</li>
</ol>
<p>(3) 如何自定义HtmlWebpackPlugin的模板？</p>
<p>实现方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 1. 使用EJS模板引擎</span>
<span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">'src/index.ejs'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">templateParameters</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'自定义标题'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 2. 模板内容示例 --></span>
<span class="token comment">&lt;!-- src/index.ejs --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>&lt;%= htmlWebpackPlugin.options.title %><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
  &lt;%= htmlWebpackPlugin.tags.headTags %>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
  &lt;%= htmlWebpackPlugin.tags.bodyTags %>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="三、性能优化专项"><a href="#三、性能优化专项" class="headerlink" title="三、性能优化专项"></a>三、性能优化专项</h1><h2 id="3-1-构建速度优化"><a href="#3-1-构建速度优化" class="headerlink" title="3.1 构建速度优化"></a>3.1 构建速度优化</h2><h3 id="3-1-1-缓存策略：cache-loader-hard-source-webpack-plugin"><a href="#3-1-1-缓存策略：cache-loader-hard-source-webpack-plugin" class="headerlink" title="3.1.1 缓存策略：cache-loader&#x2F;hard-source-webpack-plugin"></a>3.1.1 缓存策略：<code>cache-loader</code>&#x2F;<code>hard-source-webpack-plugin</code></h3><p><strong>构建缓存核心原理</strong></p>
<p>缓存机制对比：</p>
<pre><code class="mermaid">graph LR
  A[源文件] --&gt; B&#123;缓存是否存在?&#125;
  B --&gt;|是| C[直接使用缓存结果]
  B --&gt;|否| D[执行Loader处理]
  D --&gt; E[保存结果到缓存]
  E --&gt; F[返回处理结果]</code></pre>

<p>缓存层级架构：</p>
<table>
<thead>
<tr>
<th align="left">缓存类型</th>
<th align="left">作用范围</th>
<th align="left">持久性</th>
<th align="left">典型工具</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Loader级缓存</td>
<td align="left">单个Loader处理结果</td>
<td align="left">临时</td>
<td align="left">cache-loader</td>
</tr>
<tr>
<td align="left">模块级缓存</td>
<td align="left">完整模块构建结果</td>
<td align="left">持久</td>
<td align="left">hard-source-webpack-plugin</td>
</tr>
<tr>
<td align="left">系统级缓存</td>
<td align="left">整个构建过程</td>
<td align="left">持久</td>
<td align="left">Webpack 5 内置缓存</td>
</tr>
</tbody></table>
<p><strong>cache-loader 深度解析</strong></p>
<p>工作原理：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 伪代码实现</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> cacheKey <span class="token operator">=</span> <span class="token function">generateCacheKey</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 检查缓存</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回缓存结果</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token comment">// 执行后续Loader</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">runNextLoaders</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 保存缓存</span>
  cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最佳配置实践：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.jsx?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'cache-loader'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">cacheDirectory</span><span class="token operator">:</span> <span class="token string">'./.cache/babel'</span><span class="token punctuation">,</span>
              <span class="token literal-property property">cacheIdentifier</span><span class="token operator">:</span> <span class="token string">'v2'</span> <span class="token comment">// 缓存版本标识</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          <span class="token string">'babel-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.s?css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">'style-loader'</span><span class="token punctuation">,</span>
          <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'cache-loader'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">cacheDirectory</span><span class="token operator">:</span> <span class="token string">'./.cache/css'</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'sass-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>hard-source-webpack-plugin 深度剖析</strong></p>
<p>核心优势：</p>
<table>
<thead>
<tr>
<th align="left">构建次数</th>
<th align="left">性能提升比例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">首次构建</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">二次构建</td>
<td align="left">65</td>
</tr>
<tr>
<td align="left">三次构建</td>
<td align="left">80</td>
</tr>
</tbody></table>
<p>配置示例：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> HardSourceWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'hard-source-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token comment">// 缓存目录</span>
      <span class="token literal-property property">cacheDirectory</span><span class="token operator">:</span> <span class="token string">'./.cache/hard-source/[confighash]'</span><span class="token punctuation">,</span>
      
      <span class="token comment">// 环境变量哈希</span>
      <span class="token literal-property property">environmentHash</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">root</span><span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">directories</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">files</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'package.json'</span><span class="token punctuation">,</span> <span class="token string">'yarn.lock'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      
      <span class="token comment">// 缓存有效期</span>
      <span class="token literal-property property">info</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'none'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">'debug'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      
      <span class="token comment">// 自动清除过期缓存</span>
      <span class="token literal-property property">cachePrune</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">7</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 7天</span>
        <span class="token literal-property property">sizeThreshold</span><span class="token operator">:</span> <span class="token number">100</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token comment">// 100MB</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>缓存策略对比分析</strong></p>
<table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">cache-loader</th>
<th align="left">hard-source-webpack-plugin</th>
<th align="left">Webpack 5 内置缓存</th>
</tr>
</thead>
<tbody><tr>
<td align="left">缓存粒度</td>
<td align="left">单个Loader级别</td>
<td align="left">模块级别</td>
<td align="left">模块级别</td>
</tr>
<tr>
<td align="left">持久性</td>
<td align="left">临时(内存&#x2F;磁盘)</td>
<td align="left">持久(磁盘)</td>
<td align="left">持久(磁盘)</td>
</tr>
<tr>
<td align="left">配置复杂度</td>
<td align="left">低</td>
<td align="left">中</td>
<td align="left">低</td>
</tr>
<tr>
<td align="left">二次构建速度</td>
<td align="left">+30-50%</td>
<td align="left">+60-80%</td>
<td align="left">+80-90%</td>
</tr>
<tr>
<td align="left">内存占用</td>
<td align="left">中</td>
<td align="left">高</td>
<td align="left">低</td>
</tr>
<tr>
<td align="left">支持场景</td>
<td align="left">所有Webpack版本</td>
<td align="left">Webpack 4+</td>
<td align="left">Webpack 5+</td>
</tr>
<tr>
<td align="left">主要优势</td>
<td align="left">精准控制Loader缓存</td>
<td align="left">完整模块缓存</td>
<td align="left">原生集成高效</td>
</tr>
</tbody></table>
<p><strong>Webpack 5 内置缓存</strong></p>
<p>现代化配置：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'filesystem'</span><span class="token punctuation">,</span> <span class="token comment">// 使用文件系统缓存</span>
    <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token string">'v1'</span><span class="token punctuation">,</span>      <span class="token comment">// 缓存版本标识</span>
    <span class="token literal-property property">cacheDirectory</span><span class="token operator">:</span> <span class="token string">'./.cache/webpack5'</span><span class="token punctuation">,</span>
    
    <span class="token comment">// 缓存依赖文件</span>
    <span class="token literal-property property">buildDependencies</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">config</span><span class="token operator">:</span> <span class="token punctuation">[</span>__filename<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 配置文件变更时失效缓存</span>
      <span class="token literal-property property">tsconfig</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./tsconfig.json'</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    
    <span class="token comment">// 缓存策略</span>
    <span class="token literal-property property">managedPaths</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'node_modules'</span><span class="token punctuation">)</span> <span class="token comment">// 只缓存node_modules</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">profile</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 输出缓存使用情况</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>缓存失效策略</strong></p>
<p>(1) 失效场景与解决方案</p>
<table>
<thead>
<tr>
<th align="left">失效场景</th>
<th align="left">检测方法</th>
<th align="left">解决方案</th>
</tr>
</thead>
<tbody><tr>
<td align="left">源代码变更</td>
<td align="left">文件内容哈希</td>
<td align="left">自动处理</td>
</tr>
<tr>
<td align="left">Loader配置变更</td>
<td align="left">配置内容哈希</td>
<td align="left">cacheIdentifier 参数</td>
</tr>
<tr>
<td align="left">依赖包更新</td>
<td align="left">lock文件哈希</td>
<td align="left">包含yarn.lock&#x2F;package-lock.json</td>
</tr>
<tr>
<td align="left">环境变量变更</td>
<td align="left">环境变量哈希</td>
<td align="left">environmentHash 配置</td>
</tr>
<tr>
<td align="left">Webpack升级</td>
<td align="left">版本号检测</td>
<td align="left">自动清除旧缓存</td>
</tr>
</tbody></table>
<p>(2) 手动清除缓存</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 清除所有缓存</span>
<span class="token function">rm</span> <span class="token parameter variable">-rf</span> .cache

<span class="token comment"># Webpack 5 清除缓存</span>
webpack --clear-cache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>常见问题解决方案</strong></p>
<p>(1) 缓存不更新</p>
<p>症状：修改代码后构建结果不变</p>
<p>解决方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// cache-loader 添加版本标识</span>
<span class="token punctuation">&#123;</span>
  <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'cache-loader'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">cacheIdentifier</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">v3-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span> <span class="token comment">// 开发环境使用时间戳</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// Webpack 5 配置</span>
<span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">GIT_COMMIT</span> <span class="token operator">||</span> <span class="token string">'dev'</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 缓存占用过大</p>
<p>优化方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 1. 设置缓存有效期</span>
<span class="token keyword">new</span> <span class="token class-name">HardSourceWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">cachePrune</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">24</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token comment">// 2天</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 2. 排除node_modules</span>
<span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">managedPaths</span><span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-1-2-范围缩小：module-noParse-resolve-modules"><a href="#3-1-2-范围缩小：module-noParse-resolve-modules" class="headerlink" title="3.1.2 范围缩小：module.noParse &#x2F; resolve.modules"></a>3.1.2 范围缩小：<code>module.noParse</code> &#x2F; <code>resolve.modules</code></h3><p><strong>范围缩小核心原理</strong></p>
<p>Webpack 模块解析流程：</p>
<pre><code class="mermaid">graph LR
  A[入口文件] --&gt; B[解析依赖]
  B --&gt; C&#123;是否在 noParse 列表?&#125;
  C --&gt;|是| D[直接包含不解析]
  C --&gt;|否| E[查找模块路径]
  E --&gt; F&#123;是否在 modules 路径?&#125;
  F --&gt;|是| G[直接使用]
  F --&gt;|否| H[继续搜索 node_modules]</code></pre>

<p><strong>module.noParse 深度解析</strong></p>
<p>核心作用与适用场景：</p>
<ul>
<li>作用：跳过指定模块的解析过程</li>
<li>适用场景：<ul>
<li>大型库（如 jQuery、Lodash）</li>
<li>已知无依赖的独立模块</li>
<li>预编译资源（如 .wasm 文件）</li>
<li>性能敏感场景</li>
</ul>
</li>
</ul>
<p>配置方式对比：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">noParse</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// 1. 正则匹配</span>
      <span class="token operator">/</span>jquery<span class="token operator">|</span>lodash<span class="token operator">/</span><span class="token punctuation">,</span>
      
      <span class="token comment">// 2. 函数动态判断</span>
      <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> content<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'This file is already minified'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      
      <span class="token comment">// 3. 精确路径匹配</span>
      path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'vendor/react.production.min.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>resolve.modules 高级配置</strong></p>
<p>路径解析优化策略：</p>
<pre><code class="mermaid">graph TD
  A[模块导入] --&gt; B&#123;是否绝对路径?&#125;
  B --&gt;|是| C[直接使用]
  B --&gt;|否| D&#123;是否相对路径?&#125;
  D --&gt;|是| E[基于当前目录解析]
  D --&gt;|否| F[搜索 resolve.modules]
  F --&gt; G&#123;是否找到?&#125;
  G --&gt;|是| H[使用找到的模块]
  G --&gt;|否| I[搜索 node_modules]</code></pre>

<p>企业级配置方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// 1. 优先项目源目录</span>
      path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      
      <span class="token comment">// 2. 公共组件目录</span>
      path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'shared-components'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      
      <span class="token comment">// 3. 最后 node_modules</span>
      <span class="token string">'node_modules'</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>高级配置技巧</strong></p>
<p>(1) 动态 noParse 函数</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">noParse</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 跳过所有.min.js文件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.min\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 跳过特定目录</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'vendor'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 多环境路径配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> isProduction <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">'src'</span><span class="token punctuation">,</span>
      <span class="token comment">// 生产环境使用优化版库</span>
      isProduction 
        <span class="token operator">?</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist/prod-libs'</span><span class="token punctuation">)</span>
        <span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist/dev-libs'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'node_modules'</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>常见问题解决方案</strong></p>
<p>(1) noParse 导致依赖缺失</p>
<p>症状：Uncaught ReferenceError: require is not defined</p>
<p>解决方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 排除需要解析的模块</span>
<span class="token function-variable function">noParse</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 排除需要依赖的模块</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>content<span class="token punctuation">.</span>resource<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'special-module'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 排除非JS模块</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]vendor[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 路径解析冲突</p>
<p>症状：Module not found: Error: Can’t resolve ‘component’</p>
<p>解决方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 明确路径顺序</span>
    <span class="token string">'src/components'</span><span class="token punctuation">,</span>  <span class="token comment">// 1. 特定组件目录</span>
    <span class="token string">'src'</span><span class="token punctuation">,</span>             <span class="token comment">// 2. 通用源目录</span>
    <span class="token string">'shared'</span><span class="token punctuation">,</span>          <span class="token comment">// 3. 共享目录</span>
    <span class="token string">'node_modules'</span>     <span class="token comment">// 4. 第三方库</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 使用别名精确控制</span>
  <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string-property property">'@components'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src/components'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能优化决策策略</strong></p>
<pre><code class="mermaid">graph TD
  A[构建速度慢?] --&gt; B&#123;瓶颈类型&#125;
  B --&gt; C[模块解析慢] --&gt; D[优化 resolve.modules]
  B --&gt; E[依赖分析慢] --&gt; F[配置 module.noParse]
  
  D --&gt; G[减少搜索路径数量]
  D --&gt; H[设置精确路径顺序]
  F --&gt; I[识别大型独立库]
  F --&gt; J[跳过预编译资源]
  
  G --&gt; K[冷启动加速20-30%]
  H --&gt; L[热更新加速15-25%]
  I --&gt; M[解析时间减少40-60%]
  J --&gt; N[内存占用降低25-35%]</code></pre>

<h3 id="3-1-3-并行处理：thread-loader-parallel-webpack"><a href="#3-1-3-并行处理：thread-loader-parallel-webpack" class="headerlink" title="3.1.3 并行处理：thread-loader &#x2F; parallel-webpack"></a>3.1.3 并行处理：<code>thread-loader</code> &#x2F; <code>parallel-webpack</code></h3><p><strong>并行处理核心原理</strong></p>
<p>CPU多核利用机制：</p>
<pre><code class="mermaid">graph LR
  A[主进程] --&gt; B[任务分配器]
  B --&gt; C[Worker 1]
  B --&gt; D[Worker 2]
  B --&gt; E[Worker 3]
  C --&gt; F[处理任务A]
  D --&gt; G[处理任务B]
  E --&gt; H[处理任务C]
  F --&gt; I[结果合并]
  G --&gt; I
  H --&gt; I</code></pre>

<p><strong>thread-loader 深度解析</strong></p>
<p>工作原理：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 伪代码实现</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 1. 创建Worker线程池</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>workerPool<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workerPool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WorkerPool</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'os'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token comment">// 2. 提交任务到线程池</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workerPool<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">source</span><span class="token operator">:</span> source<span class="token punctuation">,</span>
      <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最佳配置实践：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>                   <span class="token comment">// CPU核心数-1</span>
              <span class="token literal-property property">workerParallelJobs</span><span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span>       <span class="token comment">// 每个Worker并行任务数</span>
              <span class="token literal-property property">poolTimeout</span><span class="token operator">:</span> <span class="token number">2000</span><span class="token punctuation">,</span>            <span class="token comment">// 空闲时自动关闭时间</span>
              <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'js-pool'</span>               <span class="token comment">// 线程池名称</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          <span class="token string">'babel-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">'style-loader'</span><span class="token punctuation">,</span>
          <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
              <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                   <span class="token comment">// CSS处理通常较轻量</span>
              <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'css-pool'</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
          <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'postcss-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>parallel-webpack 高级应用</strong></p>
<p>(1) 多配置并行处理</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建webpack.parallel.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./app.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'app-bundle.js'</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./admin.js'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'admin-bundle.js'</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 运行命令</span>
parallel<span class="token operator">-</span>webpack <span class="token operator">--</span>config<span class="token operator">=</span>webpack<span class="token punctuation">.</span>parallel<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 动态配置生成</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 生成多页面配置</span>
<span class="token keyword">const</span> pages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'home'</span><span class="token punctuation">,</span> <span class="token string">'about'</span><span class="token punctuation">,</span> <span class="token string">'contact'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> pages<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">page</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./src/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>page<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>page<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.bundle.js</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./src/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>page<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.html</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>决策树：选择并行策略</strong></p>
<pre><code class="mermaid">graph TD
  A[需要并行处理?] --&gt; B&#123;项目类型&#125;
  B --&gt; C[单入口SPA] --&gt; D[使用thread-loader]
  B --&gt; E[多入口&#x2F;多页面] --&gt; F[使用parallel-webpack]
  B --&gt; G[微前端架构] --&gt; H[组合使用]
  
  D --&gt; I[CPU密集型Loader]
  F --&gt; J[独立配置构建]
  H --&gt; K[主应用thread-loader + 子应用parallel-webpack]
  
  I --&gt; L[提升50-70%构建速度]
  J --&gt; M[提升60-80%构建速度]
  K --&gt; N[提升70-90%构建速度]</code></pre>

<h2 id="3-2-输出包体积优化"><a href="#3-2-输出包体积优化" class="headerlink" title="3.2 输出包体积优化"></a>3.2 输出包体积优化</h2><h3 id="3-2-1-Tree-Shaking失效场景分析（副作用处理）"><a href="#3-2-1-Tree-Shaking失效场景分析（副作用处理）" class="headerlink" title="3.2.1 Tree Shaking失效场景分析（副作用处理）"></a>3.2.1 Tree Shaking失效场景分析（副作用处理）</h3><p><strong>Tree Shaking 核心原理</strong></p>
<p>工作原理示意图：</p>
<pre><code class="mermaid">graph TD
  A[源代码] --&gt; B[构建依赖图]
  B --&gt; C&#123;标记活动代码&#125;
  C --&gt; D[删除未使用代码]
  D --&gt; E[优化后代码]
  
  subgraph 关键步骤
    C1[ESM静态分析] --&gt; C2[识别导出导入]
    C3[副作用检测] --&gt; C4[安全删除]
  end</code></pre>

<p><strong>Tree Shaking 失效的六大场景</strong></p>
<p>(1) 副作用模块未声明</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 场景：CSS导入无副作用声明</span>
<span class="token keyword">import</span> <span class="token string">'./styles.css'</span><span class="token punctuation">;</span> <span class="token comment">// 无显式导出</span>

<span class="token comment">// 解决方案：package.json</span>
<span class="token punctuation">&#123;</span>
  <span class="token string-property property">"sideEffects"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"*.css"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) CommonJS 模块使用</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 场景：CommonJS无法静态分析</span>
<span class="token keyword">const</span> utils <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./utils'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 动态导入</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> usedFunc <span class="token punctuation">&#125;</span> <span class="token operator">=</span> utils<span class="token punctuation">;</span>

<span class="token comment">// 解决方案：转为ESM</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> usedFunc <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 动态导入模式</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 场景：动态属性访问</span>
<span class="token keyword">import</span> utils <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> funcName <span class="token operator">=</span> <span class="token string">'usedFunc'</span><span class="token punctuation">;</span>
utils<span class="token punctuation">[</span>funcName<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 无法静态分析</span>

<span class="token comment">// 解决方案：直接引用</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> usedFunc <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span>
<span class="token function">usedFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(4) Babel 转换破坏 ESM</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 场景：Babel转换ESM为CommonJS</span>
<span class="token comment">// .babelrc</span>
<span class="token punctuation">&#123;</span>
  <span class="token string-property property">"presets"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"@babel/preset-env"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"modules"</span><span class="token operator">:</span> <span class="token string">"commonjs"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment">// 错误！</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 解决方案：保留ESM</span>
<span class="token punctuation">&#123;</span>
  <span class="token string-property property">"presets"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"@babel/preset-env"</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">"modules"</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment">// 正确</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(5) 模块再导出问题</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 场景：通配符再导出</span>
<span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span> <span class="token comment">// 无法单独Tree Shake</span>

<span class="token comment">// 解决方案：命名导出</span>
<span class="token keyword">export</span> <span class="token punctuation">&#123;</span> utilA<span class="token punctuation">,</span> utilB <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(6) 外部包未优化</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 场景：全量导入lodash</span>
<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span> <span class="token comment">// 整个包被引入</span>
_<span class="token punctuation">.</span><span class="token function">debounce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 解决方案：按需导入</span>
<span class="token keyword">import</span> debounce <span class="token keyword">from</span> <span class="token string">'lodash/debounce'</span><span class="token punctuation">;</span>
<span class="token comment">// 或使用ES版本</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> debounce <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'lodash-es'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>副作用处理深度解析</strong></p>
<p>(1) sideEffects 配置策略</p>
<table>
<thead>
<tr>
<th align="left">配置方式</th>
<th align="left">效果</th>
<th align="left">适用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="left">false</td>
<td align="left">所有文件无副作用</td>
<td align="left">纯工具库</td>
</tr>
<tr>
<td align="left">文件路径数组</td>
<td align="left">标记有副作用的文件</td>
<td align="left">含CSS&#x2F;PNG的组件库</td>
</tr>
<tr>
<td align="left">正则表达式</td>
<td align="left">匹配有副作用的文件</td>
<td align="left">批量标记</td>
</tr>
</tbody></table>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// 典型配置示例</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"my-library"</span><span class="token punctuation">,</span>
  <span class="token property">"sideEffects"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"**/*.css"</span><span class="token punctuation">,</span>
    <span class="token string">"**/*.scss"</span><span class="token punctuation">,</span>
    <span class="token string">"src/polyfill.js"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 函数级副作用标记</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 明确标记无副作用</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">/*#__PURE__*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> version <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">VERSION</span><span class="token punctuation">;</span> <span class="token comment">// 标记为纯</span>

<span class="token comment">// 标记副作用函数</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  window<span class="token punctuation">.</span>appConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 有副作用</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Webpack 优化配置</strong></p>
<p>完整Tree Shaking配置：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">usedExports</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment">// 启用导出标记</span>
    <span class="token literal-property property">sideEffects</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment">// 启用副作用分析</span>
    <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>      <span class="token comment">// 启用代码压缩</span>
    <span class="token literal-property property">concatenateModules</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 作用域提升</span>
    <span class="token literal-property property">innerGraph</span><span class="token operator">:</span> <span class="token boolean">true</span>     <span class="token comment">// 深度依赖分析(Webpack 5)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>决策树：解决Tree Shaking失效</strong></p>
<pre><code class="mermaid">graph TD
  A[Tree Shaking失效] --&gt; B&#123;具体场景&#125;
  B --&gt; C[模块有副作用] --&gt; D[配置sideEffects]
  B --&gt; E[使用CommonJS] --&gt; F[转为ESM]
  B --&gt; G[动态导入] --&gt; H[重构为静态引用]
  B --&gt; I[Babel转换问题] --&gt; J[设置 modules: false]
  B --&gt; K[通配符导出] --&gt; L[使用命名导出]
  B --&gt; M[第三方库问题] --&gt; N[使用ES版本或按需导入]</code></pre>

<h3 id="3-2-2-代码分割：SplitChunksPlugin配置策略（chunks-minSize-cacheGroups）"><a href="#3-2-2-代码分割：SplitChunksPlugin配置策略（chunks-minSize-cacheGroups）" class="headerlink" title="3.2.2 代码分割：SplitChunksPlugin配置策略（chunks&#x2F;minSize&#x2F;cacheGroups）"></a>3.2.2 代码分割：<code>SplitChunksPlugin</code>配置策略（<code>chunks</code>&#x2F;<code>minSize</code>&#x2F;<code>cacheGroups</code>）</h3><p><strong>基础配置项</strong></p>
<table>
<thead>
<tr>
<th align="left">配置项</th>
<th align="left">默认值</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">chunks</td>
<td align="left">‘async’</td>
<td align="left">控制分割范围：async(动态导入) &#x2F; initial(同步导入) &#x2F; all(全部)</td>
</tr>
<tr>
<td align="left">minSize</td>
<td align="left">20000 (20KB)</td>
<td align="left">生成新chunk的最小体积（过小模块不分割）</td>
</tr>
<tr>
<td align="left">minChunks</td>
<td align="left">1</td>
<td align="left">模块被至少多少个chunk引用才分割</td>
</tr>
<tr>
<td align="left">maxAsyncRequests</td>
<td align="left">30</td>
<td align="left">每个异步加载中最大并行请求数</td>
</tr>
<tr>
<td align="left">maxInitialRequests</td>
<td align="left">30</td>
<td align="left">入口点最大并行请求数</td>
</tr>
</tbody></table>
<p><strong>核心配置 cacheGroups（重点！）</strong></p>
<p>定义自定义分割规则组，优先级高于全局配置：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">splitChunks</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 1. 分离第三方库</span>
      <span class="token literal-property property">vendors</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">// 路径匹配</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'vendors'</span><span class="token punctuation">,</span>                  <span class="token comment">// 输出文件名</span>
        <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span>                    <span class="token comment">// 覆盖全局chunks设置</span>
        <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>                     <span class="token comment">// 优先级（数字越大越优先）</span>
        <span class="token literal-property property">reuseExistingChunk</span><span class="token operator">:</span> <span class="token boolean">true</span>          <span class="token comment">// 重用已存在chunk</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token comment">// 2. 分离公共模块（被2个以上chunk引用）</span>
      <span class="token literal-property property">common</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">minChunks</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>                     <span class="token comment">// 最小引用次数</span>
        <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'common'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token literal-property property">minSize</span><span class="token operator">:</span> <span class="token number">0</span>                        <span class="token comment">// 允许小模块（如工具函数）</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置策略实战技巧</strong></p>
<p>(1) chunks 选型策略</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 场景1：SPA应用（推荐）</span>
<span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">'all'</span> <span class="token comment">// 同时优化首屏和异步加载</span>

<span class="token comment">// 场景2：多页应用（MPA）</span>
<span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">'initial'</span> <span class="token comment">// 仅分割入口公共依赖</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 体积阈值调优</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">minSize</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">javascript</span><span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>  <span class="token comment">// JS最小30KB</span>
  <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token number">50000</span>        <span class="token comment">// CSS最小50KB</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
<span class="token literal-property property">maxSize</span><span class="token operator">:</span> <span class="token number">150000</span><span class="token punctuation">,</span>      <span class="token comment">// 尝试拆分大于150KB的包</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) cacheGroups 高级用法</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 分离指定框架（如React）</span>
<span class="token literal-property property">react</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]react|react-dom[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'react-core'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">20</span>  <span class="token comment">// 高于默认vendors</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 按目录结构分组</span>
<span class="token literal-property property">utils</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]src[\\/]utils[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'shared-utils'</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>常见优化场景解决方案</strong></p>
<table>
<thead>
<tr>
<th align="left">问题现象</th>
<th align="left">解决方案</th>
</tr>
</thead>
<tbody><tr>
<td align="left">首屏加载慢</td>
<td align="left">提高 minSize 避免过小包，增大 maxInitialRequests</td>
</tr>
<tr>
<td align="left">公共模块重复打包</td>
<td align="left">设置 minChunks: 2 + cacheGroups.common</td>
</tr>
<tr>
<td align="left">Lodash等工具库未单独拆分</td>
<td align="left">在 cacheGroups 添加专属规则（test: &#x2F;lodash&#x2F;）</td>
</tr>
<tr>
<td align="left">异步加载的组件库体积过大</td>
<td align="left">配置 maxAsyncRequests: 10 限制并发请求数</td>
</tr>
</tbody></table>
<p><strong>配置优先级规则</strong></p>
<p>模块匹配顺序：</p>
<pre><code class="mermaid">graph TB
  A[模块] --&gt; B&#123;是否匹配 cacheGroups 规则?&#125;
  B --&gt;|是| C[按 priority 选择最高优先级组]
  B --&gt;|否| D[应用全局 splitChunks 配置]</code></pre>

<p>冲突处理原则：</p>
<ul>
<li>priority 决定规则优先级</li>
<li>同时匹配多规则时，选择 priority 值更大的组</li>
<li>未匹配任何组时回退到全局配置</li>
</ul>
<p><strong>面试高频问题</strong></p>
<p>(1) 如何避免分割出过多小文件？</p>
<p>合理设置 minSize（推荐30KB+）和 maxAsyncRequests（建议5-10），并启用 reuseExistingChunk</p>
<p>(2) 同步模块(initial)和异步模块(async)分割的区别？</p>
<p>同步分割影响首屏请求数，需配合 maxInitialRequests 控制；异步分割优化动态加载性能</p>
<p>(3) 为什么配置了 minChunks: 2 但公共模块未分离？</p>
<p>排查点：</p>
<ul>
<li>模块体积是否小于 minSize</li>
<li>是否被更高优先级规则匹配</li>
<li>chunks 范围是否包含该模块类型</li>
</ul>
<h3 id="3-2-3-动态加载：import-语法与Prefetch-Preload"><a href="#3-2-3-动态加载：import-语法与Prefetch-Preload" class="headerlink" title="3.2.3 动态加载：import()语法与Prefetch&#x2F;Preload"></a>3.2.3 动态加载：<code>import()</code>语法与Prefetch&#x2F;Preload</h3><p><strong>基础语法与原理</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 1. 基础动态导入</span>
button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./module.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> module<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=></span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'加载失败'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 结合async/await</span>
<span class="token keyword">const</span> <span class="token function-variable function">loadModule</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> export1<span class="token punctuation">,</span> export2 <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'./module.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>编译结果：<br>Webpack 会将动态导入模块拆分为独立 chunk（如 1.bundle.js），并自动注入：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 运行时生成的加载逻辑</span>
__webpack_require__<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token comment">/*! import() */</span> <span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">__webpack_require__</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token operator">...</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>魔法注释（Magic Comments）</strong></p>
<p>通过注释传递配置参数：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span><span class="token punctuation">(</span>
  <span class="token comment">/* webpackChunkName: "chartjs" */</span>
  <span class="token comment">/* webpackPrefetch: true */</span>
  <span class="token comment">/* webpackPreload: true */</span>
  <span class="token comment">/* webpackMode: "lazy-once" */</span>
  <span class="token string">'./chart'</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<table>
<thead>
<tr>
<th align="left">注释指令</th>
<th align="left">作用</th>
<th align="left">适用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="left">webpackChunkName</td>
<td align="left">指定生成chunk的名称（支持占位符[name]）</td>
<td align="left">分组同类模块</td>
</tr>
<tr>
<td align="left">webpackPrefetch</td>
<td align="left">预取：空闲时加载资源（优先级低）</td>
<td align="left">未来可能需要的功能（如下页）</td>
</tr>
<tr>
<td align="left">webpackPreload</td>
<td align="left">预加载：与父模块并行加载（优先级高）</td>
<td align="left">首屏关键异步组件</td>
</tr>
<tr>
<td align="left">webpackMode</td>
<td align="left">加载模式：lazy(默认)&#x2F;eager(不分离chunk)&#x2F;lazy-once(统一chunk)</td>
<td align="left">特殊加载需求</td>
</tr>
</tbody></table>
<p><strong>Prefetch vs Preload 核心差异</strong></p>
<table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">prefetch</th>
<th align="left">preload</th>
</tr>
</thead>
<tbody><tr>
<td align="left">加载时机</td>
<td align="left">浏览器空闲时</td>
<td align="left">立即与父模块并行加载</td>
</tr>
<tr>
<td align="left">优先级</td>
<td align="left">Low</td>
<td align="left">High</td>
</tr>
<tr>
<td align="left">执行顺序</td>
<td align="left">主流程完成后</td>
<td align="left">阻塞父模块渲染</td>
</tr>
<tr>
<td align="left">适用场景</td>
<td align="left">非关键功能（如弹窗&#x2F;下页内容）</td>
<td align="left">关键异步路由&#x2F;首屏必要组件</td>
</tr>
<tr>
<td align="left">HTTP头</td>
<td align="left"><code>&lt;link rel=&quot;prefetch&quot; href=&quot;...&quot;&gt;</code></td>
<td align="left"><code>&lt;link rel=&quot;preload&quot; href=&quot;...&quot;&gt;</code></td>
</tr>
</tbody></table>
<p>错误用法警示：<br>滥用 preload 会导致关键资源被抢占，反而延长首屏时间</p>
<p><strong>工程化最佳实践</strong></p>
<p>(1) 路由级代码分割（React&#x2F;Vue）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// React + React.lazy</span>
<span class="token keyword">const</span> ProductPage <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> 
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackPrefetch: true */</span> <span class="token string">'./ProductPage'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Vue 异步组件</span>
<span class="token keyword">const</span> <span class="token function-variable function">UserProfile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">component</span><span class="token operator">:</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: "profile" */</span> <span class="token string">'./UserProfile.vue'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">delay</span><span class="token operator">:</span> <span class="token number">200</span> <span class="token comment">// 延迟展示loading时间</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 组件库按需加载</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 点击时加载富文本编辑器</span>
editButton<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: "editor" */</span> <span class="token string">'tinymce'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">editor</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    editor<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 预取策略优化</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 页面加载完成后预取下页资源</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'load'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackPrefetch: true */</span> <span class="token string">'./next-page-module.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能优化指标关联</strong></p>
<table>
<thead>
<tr>
<th align="left">优化手段</th>
<th align="left">影响的核心指标</th>
</tr>
</thead>
<tbody><tr>
<td align="left">基础动态导入</td>
<td align="left">减少FCP时间（首次内容绘制）</td>
</tr>
<tr>
<td align="left">Prefetch</td>
<td align="left">提升LCP（最大内容绘制）后的交互体验</td>
</tr>
<tr>
<td align="left">Preload</td>
<td align="left">优化LCP本身（关键内容加载）</td>
</tr>
<tr>
<td align="left">合理拆分chunk</td>
<td align="left">降低TBT（总阻塞时间）</td>
</tr>
</tbody></table>
<p><strong>常见问题解决方案</strong></p>
<p>Q1：动态加载的chunk文件过多导致HTTP&#x2F;2阻塞？</p>
<p>方案：合并小文件 + 域名分片</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 统一命名合并同类模块</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackChunkName: "utils-[request]" */</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./utils/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>file<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>Q2：如何捕获加载失败？</p>
<p>方案：添加错误边界（React） + 重试机制</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// React错误边界</span>
<span class="token keyword">class</span> <span class="token class-name">ErrorBoundary</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">&#123;</span>
  <span class="token function">componentDidCatch</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isChunkLoadError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">retryLoading</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Q3：预取资源过早影响首屏？</p>
<p>方案：动态计算触发时机</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 根据网络速度延迟预取</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>saveData <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">prefetchModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="3-2-4-资源压缩：Terser多进程压缩-CSS-cssnano"><a href="#3-2-4-资源压缩：Terser多进程压缩-CSS-cssnano" class="headerlink" title="3.2.4 资源压缩：Terser多进程压缩 &#x2F; CSS cssnano"></a>3.2.4 资源压缩：Terser多进程压缩 &#x2F; CSS <code>cssnano</code></h3><p><strong>JavaScript压缩：Terser核心机制</strong></p>
<p>Terser（Webpack 5+默认）替代UglifyJS，支持ES6+语法压缩，配置示例：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">parallel</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>         <span class="token comment">// 启用多进程（默认CPU数-1）</span>
      <span class="token literal-property property">extractComments</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 不提取注释到单独文件</span>
      <span class="token literal-property property">terserOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">drop_console</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// 移除console</span>
          <span class="token literal-property property">pure_funcs</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'alert'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 删除指定函数</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">comments</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>       <span class="token comment">// 移除所有注释</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">mangle</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
            <span class="token literal-property property">regex</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^_</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>        <span class="token comment">// 混淆以_开头的私有属性</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关键配置项解析：</p>
<table>
<thead>
<tr>
<th align="left">类别</th>
<th align="left">选项</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">压缩</td>
<td align="left">drop_console<br>dead_code<br>reduce_vars</td>
<td align="left">删除所有console.*调用<br>移除不可达代码（需配合Tree Shaking）<br>变量复用（将重复变量合并）</td>
</tr>
<tr>
<td align="left">混淆</td>
<td align="left">mangle<br>mangle.properties</td>
<td align="left">变量名缩短（默认启用）<br>混淆对象属性名（慎用！可能破坏代码逻辑）</td>
</tr>
<tr>
<td align="left">格式</td>
<td align="left">comments</td>
<td align="left">保留特定注释（如@license）</td>
</tr>
</tbody></table>
<p><strong>CSS压缩：cssnano高级策略</strong></p>
<p>cssnano（通过css-minimizer-webpack-plugin集成）提供智能样式压缩：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> CssMinimizerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'css-minimizer-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">CssMinimizerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">parallel</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// 指定4个进程</span>
        <span class="token literal-property property">minimizerOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
          <span class="token literal-property property">preset</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">'advanced'</span><span class="token punctuation">,</span> <span class="token comment">// 启用高级优化</span>
            <span class="token punctuation">&#123;</span> 
              <span class="token literal-property property">discardComments</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">removeAll</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
              <span class="token literal-property property">normalizeUrl</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">stripWWW</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 保留www域名</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>cssnano优化规则示例：</p>
<table>
<thead>
<tr>
<th align="left">优化类型</th>
<th align="left">原始样式</th>
<th align="left">压缩后</th>
<th align="left">节省字节</th>
</tr>
</thead>
<tbody><tr>
<td align="left">颜色简化</td>
<td align="left">color: #ff0000;</td>
<td align="left">color:red;</td>
<td align="left">6 bytes</td>
</tr>
<tr>
<td align="left">单位简化</td>
<td align="left">padding: 0px 10px;</td>
<td align="left">padding:0 10px;</td>
<td align="left">2 bytes</td>
</tr>
<tr>
<td align="left">合并重复</td>
<td align="left">margin:10px; margin:5px</td>
<td align="left">margin:5px</td>
<td align="left">11 bytes</td>
</tr>
<tr>
<td align="left">删除过时前缀</td>
<td align="left">-webkit-border-radius</td>
<td align="left">border-radius</td>
<td align="left">9 bytes</td>
</tr>
</tbody></table>
<p><strong>压缩陷阱与解决方案</strong></p>
<p>(1) Source Map失效问题</p>
<p>现象：生产环境错误堆栈无法映射源码</p>
<p>解决：配置生成精准Source Map</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Terser配置</span>
<span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">sourceMap</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 必须启用</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// Webpack总配置</span>
<span class="token literal-property property">devtool</span><span class="token operator">:</span> <span class="token string">'hidden-source-map'</span> <span class="token comment">// 生成map文件但不暴露给浏览器</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 混淆导致样式异常</p>
<p>案例：CSS Modules类名被压缩破坏</p>
<p>解决：安全混淆配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">terserOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">mangle</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">reserved</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'_className'</span><span class="token punctuation">]</span> <span class="token comment">// 保留特定属性名</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 压缩引发框架Bug</p>
<p>案例：Vue响应式系统因属性混淆失效</p>
<p>解决：禁用属性混淆</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">mangle</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">properties</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// 关闭属性混淆</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p><strong>企业级优化实践</strong></p>
<p>(1) 差异化压缩策略</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 根据环境动态配置</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">minimizer</span><span class="token operator">:</span> env<span class="token punctuation">.</span>production <span class="token operator">?</span> <span class="token punctuation">[</span>
      <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token comment">/* 生产配置 */</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">CssMinimizerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 定制删除规则（如多语言项目）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 删除特定语言的代码块</span>
<span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">terserOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">global_defs</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 删除__DEV__代码块</span>
        <span class="token literal-property property">__DEV__</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token comment">// 删除中文注释（需配合自定义插件）</span>
        <span class="token literal-property property">__LANG_CN__</span><span class="token operator">:</span> <span class="token boolean">false</span>  
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 压缩率监控（接入CI）</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装体积分析插件</span>
<span class="token function">npm</span> <span class="token function">install</span> --save-dev size-limit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<pre class="line-numbers language-json" data-language="json"><code class="language-json"># package.json
<span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token property">"size"</span><span class="token operator">:</span> <span class="token string">"size-limit"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试要点</strong></p>
<p>Q1：Terser与UglifyJS核心区别</p>
<p>Terser支持ES6+语法、多进程压缩、更精准的Tree Shaking</p>
<p>Q2：如何保留特定注释？</p>
<p>Terser中设置<code>format.comments: /@license/i，cssnano用discardComments: &#123; remove: (comment) =&gt; !comment.includes(&#39;!&#39;) &#125;</code></p>
<p>Q3：压缩导致线上Bug的排查思路</p>
<p>步骤：</p>
<ul>
<li>确认Source Map可还原堆栈</li>
<li>检查混淆配置是否影响框架运行时</li>
<li>通过<code>/*#__PURE__*/</code>标记副作用函数</li>
</ul>
<h1 id="四、高级特性与工程化"><a href="#四、高级特性与工程化" class="headerlink" title="四、高级特性与工程化"></a>四、高级特性与工程化</h1><h2 id="4-1-环境区分与动态配置"><a href="#4-1-环境区分与动态配置" class="headerlink" title="4.1 环境区分与动态配置"></a>4.1 环境区分与动态配置</h2><h3 id="4-1-1-基于webpack-merge的多环境配置"><a href="#4-1-1-基于webpack-merge的多环境配置" class="headerlink" title="4.1.1 基于webpack-merge的多环境配置"></a>4.1.1 基于<code>webpack-merge</code>的多环境配置</h3><p><strong>核心作用</strong></p>
<p>通过分离环境配置实现安全、高效的构建管理，避免生产环境误用开发配置。</p>
<p><strong>基础目录结构</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">config/
├── webpack.common.js    <span class="token comment"># 通用配置（入口/输出/公共规则）</span>
├── webpack.dev.js       <span class="token comment"># 开发配置（devServer/热更新）</span>
└── webpack.prod.js      <span class="token comment"># 生产配置（压缩/代码分割）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>核心合并操作</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.dev.js</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> merge <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> common <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.common.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>common<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">devtool</span><span class="token operator">:</span> <span class="token string">'eval-cheap-module-source-map'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">hot</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">8080</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.prod.js</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> merge <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> common <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.common.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>common<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">devtool</span><span class="token operator">:</span> <span class="token string">'hidden-source-map'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">minimize</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>配置合并规则解析</strong></p>
<table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">智能覆盖</td>
<td align="left">同名属性直接覆盖（如output.path）</td>
</tr>
<tr>
<td align="left">数组合并</td>
<td align="left">对module.rules等数组执行concat操作（非覆盖！）</td>
</tr>
<tr>
<td align="left">对象深度合并</td>
<td align="left">嵌套对象递归合并（如optimization.splitChunks.cacheGroups）</td>
</tr>
<tr>
<td align="left">特殊属性处理</td>
<td align="left">plugins数组通过构造函数名称去重合并</td>
</tr>
</tbody></table>
<blockquote>
<p>避坑提示：若需完全覆盖数组（如plugins），使用 merge.withCustomize 自定义规则</p>
</blockquote>
<p><strong>企业级多环境扩展</strong></p>
<p>(1) 动态环境变量注入</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// package.json</span>
<span class="token string-property property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">"build:prod"</span><span class="token operator">:</span> <span class="token string">"NODE_ENV=production webpack --config config/webpack.prod.js"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"build:stage"</span><span class="token operator">:</span> <span class="token string">"NODE_ENV=staging webpack --config config/webpack.prod.js"</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// webpack.prod.js</span>
<span class="token keyword">const</span> env <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span><span class="token punctuation">;</span> <span class="token comment">// 'production' 或 'staging'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 环境专属插件示例</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 仅生产环境启用Bundle分析</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  prodConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>高阶合并技巧</strong></p>
<p>(1) 条件合并（根据环境变量）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>common<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">USE_MOCK</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">new</span> <span class="token class-name">MockPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 条件添加插件</span>
  <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 自定义合并规则</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> customizeArray <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">customizeArray</span><span class="token operator">:</span> <span class="token function">customizeArray</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token string-property property">'module.rules'</span><span class="token operator">:</span> <span class="token string">'replace'</span> <span class="token comment">// 完全替换rules数组而非合并</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>common<span class="token punctuation">,</span> devConfig<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) TypeScript类型支持</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> Configuration <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'webpack'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">&#123;</span> merge <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'webpack-merge'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> common<span class="token operator">:</span> Configuration <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dev<span class="token operator">:</span> Configuration <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">merge</span><span class="token punctuation">(</span>common<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 自动推导完整类型</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试核心要点</strong></p>
<p>Q：为何不用 Object.assign 合并配置？</p>
<p>Object.assign 仅浅层合并，会破坏嵌套结构（如 module.rules），而 webpack-merge 支持深度递归合并</p>
<p>Q：多环境配置如何防止信息泄露？</p>
<ul>
<li>生产环境禁用 devtool: eval 等不安全Source Map</li>
<li>通过 DefinePlugin 替换API密钥等敏感变量</li>
<li>开发配置绝不包含压缩密钥等生产凭据</li>
</ul>
<p>Q：如何验证配置合并结果？</p>
<p>方案：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">npx webpack <span class="token parameter variable">--config</span> config/webpack.prod.js <span class="token parameter variable">--json</span> <span class="token operator">></span> stats.json<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>分析生成的stats.json文件确认最终配置</p>
<h3 id="4-1-2-环境变量注入（dotenv与DefinePlugin结合）"><a href="#4-1-2-环境变量注入（dotenv与DefinePlugin结合）" class="headerlink" title="4.1.2 环境变量注入（dotenv与DefinePlugin结合）"></a>4.1.2 环境变量注入（<code>dotenv</code>与<code>DefinePlugin</code>结合）</h3><p><strong>基础工作流程</strong></p>
<pre><code class="mermaid">graph LR
  A[.env文件] --&gt; B[dotenv解析] --&gt; C[DefinePlugin转换] --&gt; D[代码中process.env访问]</code></pre>

<p><strong>标准实施步骤</strong></p>
<p>(1) 安装依赖</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> dotenv-webpack --save-dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>(2) 创建环境文件</p>
<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># .env.development</span>
<span class="token key attr-name">API_BASE_URL</span> <span class="token punctuation">=</span> <span class="token value attr-value">https://dev.example.com</span>
<span class="token key attr-name">DEBUG_MODE</span> <span class="token punctuation">=</span> <span class="token value attr-value">true</span>
<span class="token key attr-name">SENTRY_DSN</span> <span class="token punctuation">=</span> <span class="token value attr-value">'' # 开发环境不启用监控</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-ini" data-language="ini"><code class="language-ini"><span class="token comment"># .env.production</span>
<span class="token key attr-name">API_BASE_URL</span> <span class="token punctuation">=</span> <span class="token value attr-value">https://api.example.com</span>
<span class="token key attr-name">DEBUG_MODE</span> <span class="token punctuation">=</span> <span class="token value attr-value">false</span>
<span class="token key attr-name">SENTRY_DSN</span> <span class="token punctuation">=</span> <span class="token value attr-value">'https://key@sentry.io/project' # 生产环境监控</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) Webpack配置集成</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> Dotenv <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv-webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">env</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">Dotenv</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">.env.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>env<span class="token punctuation">.</span>mode<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// 根据mode加载对应文件</span>
      <span class="token literal-property property">systemvars</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>          <span class="token comment">// 兼容系统环境变量</span>
      <span class="token literal-property property">safe</span><span class="token operator">:</span> <span class="token boolean">true</span>                 <span class="token comment">// 如果不存在文件不报错</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token string-property property">'process.env.DEBUG_MODE'</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">DEBUG_MODE</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>安全防护机制</strong></p>
<p>(1) 前端环境变量白名单</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 只允许特定前缀变量注入前端代码</span>
<span class="token keyword">new</span> <span class="token class-name">Dotenv</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">allow</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'API_'</span><span class="token punctuation">,</span> <span class="token string">'PUBLIC_'</span><span class="token punctuation">]</span> <span class="token comment">// 禁止注入DB_PASSWORD等敏感变量</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) .gitignore保护敏感文件</p>
<pre class="line-numbers language-ignore" data-language="ignore"><code class="language-ignore"><span class="token comment"># 禁止提交生产环境文件</span>
<span class="token entry string">.env.production</span>
<span class="token entry string">.env.staging</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>(3) CI&#x2F;CD环境变量托管</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># GitHub Actions示例</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build production
  <span class="token key atrule">run</span><span class="token punctuation">:</span> npm run build
  <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token key atrule">API_BASE_URL</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.PROD_API_URL <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span>
    <span class="token key atrule">SENTRY_DSN</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span><span class="token punctuation">&#123;</span> secrets.SENTRY_DSN <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>框架集成方案</strong></p>
<p>(1) React (create-react-app)</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 直接使用REACT_APP_前缀变量</span>
<span class="token comment">// .env</span>
<span class="token constant">REACT_APP_API_URL</span><span class="token operator">=</span>https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>api<span class="token punctuation">.</span>example<span class="token punctuation">.</span>com

<span class="token comment">// 组件内访问</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">REACT_APP_API_URL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) Vue CLI</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// vue.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">chainWebpack</span><span class="token operator">:</span> <span class="token parameter">config</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    config<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'define'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token parameter">args</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'process.env'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token constant">API_URL</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">API_URL</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> args
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>企业级实践技巧</strong></p>
<p>(1) 类型支持 (TypeScript)</p>
<pre class="line-numbers language-typescript" data-language="typescript"><code class="language-typescript"><span class="token comment">// env.d.ts</span>
<span class="token keyword">declare</span> <span class="token keyword">namespace</span> NodeJS <span class="token punctuation">&#123;</span>
  <span class="token keyword">interface</span> <span class="token class-name">ProcessEnv</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">readonly</span> <span class="token constant">API_BASE_URL</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token keyword">readonly</span> <span class="token constant">DEBUG_MODE</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token string">'true'</span> <span class="token operator">|</span> <span class="token string">'false'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 业务代码</span>
<span class="token keyword">const</span> apiUrl<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">API_BASE_URL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 环境变量校验</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 启动时验证必要变量</span>
<span class="token keyword">const</span> requiredVars <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'API_BASE_URL'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
requiredVars<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">varName</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span>env<span class="token punctuation">[</span>varName<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">缺少环境变量: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>varName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 多环境配置生成</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 根据环境生成不同配置对象</span>
<span class="token keyword">const</span> <span class="token function-variable function">getConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">api</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">baseURL</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">API_BASE_URL</span><span class="token punctuation">,</span>
    <span class="token literal-property property">timeout</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span> <span class="token operator">?</span> <span class="token number">30000</span> <span class="token operator">:</span> <span class="token number">10000</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">sentry</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">dsn</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SENTRY_DSN</span> <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">,</span>
    <span class="token literal-property property">enabled</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试高频问题</strong></p>
<p>Q：前端为什么不能直接使用 process.env？</p>
<p>Node.js 的 process.env 仅在构建阶段可用，DefinePlugin 通过字符串替换将变量硬编码到客户端代码中</p>
<p>Q：如何防止敏感信息泄露？</p>
<p>安全策略：</p>
<ul>
<li>使用 Dotenv 的 allowlist 过滤变量</li>
<li>在 .gitignore 中排除生产环境文件</li>
<li>敏感变量通过 CI&#x2F;CD 管道注入</li>
</ul>
<p>Q：开发环境与生产环境变量冲突怎么办？</p>
<p>解决方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">Dotenv</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">path</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CUSTOM_ENV</span> <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">.env.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">CUSTOM_ENV</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>启动命令：CUSTOM_ENV&#x3D;staging npm run build</p>
<h2 id="4-2-微前端集成"><a href="#4-2-微前端集成" class="headerlink" title="4.2 微前端集成"></a>4.2 微前端集成</h2><h3 id="4-2-1-Module-Federation原理与配置"><a href="#4-2-1-Module-Federation原理与配置" class="headerlink" title="4.2.1 Module Federation原理与配置"></a>4.2.1 Module Federation原理与配置</h3><p>Module Federation（模块联邦）是 Webpack 5 的革命性特性，实现跨应用实时共享模块，彻底改变微前端架构模式。</p>
<p><strong>核心理念</strong></p>
<pre><code class="mermaid">graph LR
  AppA[应用A] -- 运行时加载 --&gt; Shared[共享模块]
  AppB[应用B] -- 直接使用 --&gt; Shared
  Shared[React&#x2F;工具库&#x2F;业务组件] -- 仅加载一次 --&gt; Browser</code></pre>

<p>核心价值：</p>
<ul>
<li>避免重复依赖加载</li>
<li>应用独立开发部署</li>
<li>运行时动态模块共享</li>
</ul>
<p><strong>核心配置项解析</strong></p>
<p>(1) 基础配置结构</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// app1/webpack.config.js</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> ModuleFederationPlugin <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>container<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'app1'</span><span class="token punctuation">,</span>                  <span class="token comment">// 唯一ID（必填）</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'remoteEntry.js'</span><span class="token punctuation">,</span>    <span class="token comment">// 入口文件名</span>
      <span class="token literal-property property">exposes</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                     <span class="token comment">// 暴露给外部的模块</span>
        <span class="token string-property property">'./Button'</span><span class="token operator">:</span> <span class="token string">'./src/Button.jsx'</span><span class="token punctuation">,</span>
        <span class="token string-property property">'./Store'</span><span class="token operator">:</span> <span class="token string">'./src/redux/store.js'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">remotes</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                     <span class="token comment">// 引用远程模块</span>
        <span class="token literal-property property">app2</span><span class="token operator">:</span> <span class="token string">'app2@http://cdn.com/app2/remoteEntry.js'</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>                      <span class="token comment">// 共享依赖</span>
        <span class="token literal-property property">react</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">singleton</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>   <span class="token comment">// 单例模式</span>
        <span class="token string-property property">'react-dom'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">eager</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span>  <span class="token comment">// 立即加载</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 关键配置项说明</p>
<table>
<thead>
<tr>
<th align="left">配置项</th>
<th align="left">类型</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">name</td>
<td align="left">string</td>
<td align="left">应用唯一标识（全局命名空间）</td>
</tr>
<tr>
<td align="left">filename</td>
<td align="left">string</td>
<td align="left">生成的入口文件（默认remoteEntry.js）</td>
</tr>
<tr>
<td align="left">exposes</td>
<td align="left">object</td>
<td align="left">暴露的模块路径（key为公共路径，value为本地路径）</td>
</tr>
<tr>
<td align="left">remotes</td>
<td align="left">object</td>
<td align="left">远程模块映射（key为引用名，value为<code>&lt;name&gt;@&lt;url&gt;</code>格式）</td>
</tr>
<tr>
<td align="left">shared</td>
<td align="left">object&#x2F;array</td>
<td align="left">共享的依赖库（可配置加载策略）</td>
</tr>
</tbody></table>
<p><strong>共享依赖策略</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">react</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">singleton</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// 只加载一个版本（不同版本会警告）</span>
    <span class="token literal-property property">requiredVersion</span><span class="token operator">:</span> <span class="token string">'^17.0.0'</span><span class="token punctuation">,</span>  <span class="token comment">// 指定版本范围</span>
    <span class="token literal-property property">eager</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>       <span class="token comment">// 不立即加载（异步按需）</span>
    <span class="token literal-property property">strictVersion</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 严格版本匹配（不匹配报错）</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">lodash</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">eager</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>        <span class="token comment">// 主应用启动时立即加载</span>
    <span class="token literal-property property">version</span><span class="token operator">:</span> <span class="token string">'4.17.21'</span>  <span class="token comment">// 显式声明版本</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>版本冲突解决方案：</p>
<ul>
<li>使用 singleton: true 强制单例</li>
<li>通过 requiredVersion 约束版本范围</li>
<li>自定义 get 方法实现版本降级</li>
</ul>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">react</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'react'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>动态远程加载</strong></p>
<p>(1) 运行时决定远程地址</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 业务代码中动态加载</span>
<span class="token keyword">const</span> RemoteButton <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> url <span class="token operator">=</span> window<span class="token punctuation">.</span>isAdmin 
    <span class="token operator">?</span> <span class="token string">'http://admin-app/remoteEntry.js'</span>
    <span class="token operator">:</span> <span class="token string">'http://user-app/remoteEntry.js'</span><span class="token punctuation">;</span>
    
  <span class="token keyword">return</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'app2/Button'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">default</span><span class="token operator">:</span> module<span class="token punctuation">.</span>Button
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) Promise-based 远程解析</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token literal-property property">remotes</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">app2</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">promise new Promise(resolve => &#123;
    const urlParams = new URLSearchParams(window.location.search);
    const version = urlParams.get('app2Version') || 'latest';
    resolve(&#123;
      get: () => window.app2[version],
      init: (arg) => window.app2[arg].init(arg)
    &#125;);
  &#125;)</span><span class="token template-punctuation string">`</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>企业级应用场景</strong></p>
<p>(1) 微前端架构</p>
<pre><code class="mermaid">graph TD
  Shell[主应用] --&gt; AppA[产品模块]
  Shell --&gt; AppB[订单模块]
  Shell --&gt; AppC[用户模块]
  shared[共享React&#x2F;状态管理] --&gt; Shell &amp; AppA &amp; AppB &amp; AppC</code></pre>

<p>(2) 跨团队组件共享</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 组件提供方</span>
<span class="token literal-property property">exposes</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">'./DataTable'</span><span class="token operator">:</span> <span class="token string">'./src/components/DataTable.jsx'</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 消费者应用</span>
<span class="token keyword">const</span> DataTable <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'team_ui/DataTable'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 插件化系统</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 动态注册插件</span>
window<span class="token punctuation">.</span><span class="token function-variable function">registerPlugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  __webpack_require__<span class="token punctuation">.</span>m<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 插件使用</span>
<span class="token keyword">const</span> plugin <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'paymentPlugin/PayModule'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能优化策略</strong></p>
<p>(1) 共享依赖预加载</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 主应用HTML中预加载 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.com/shared-react.js<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>(2) 按需加载暴露模块</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 使用import()动态加载</span>
<span class="token keyword">const</span> <span class="token function-variable function">ProductModal</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'productApp/Modal'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>(3) 请求合并（HTTP&#x2F;2）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 配置多个exposes时生成单个入口文件</span>
<span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'remoteEntry.js?exposes=Button,Store'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>常见问题解决方案</strong></p>
<p>Q：如何解决跨域问题？</p>
<p>方案1：开发环境配置 devServer.headers</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">'Access-Control-Allow-Origin'</span><span class="token operator">:</span> <span class="token string">'*'</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>方案2：生产环境配置CDN CORS策略</p>
<p>Q：共享模块版本不兼容？</p>
<p>方案：</p>
<ul>
<li>使用 requiredVersion 约束版本</li>
<li>封装适配层接口</li>
<li>降级到独立加载模式</li>
</ul>
<p>Q：如何调试远程模块？</p>
<p>方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token literal-property property">devtool</span><span class="token operator">:</span> <span class="token string">'source-map'</span><span class="token punctuation">,</span>
<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> 
    <span class="token literal-property property">exposes</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">'react'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">shareScope</span><span class="token operator">:</span> <span class="token string">'debug'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 独立作用域</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="4-2-2-跨应用共享模块策略"><a href="#4-2-2-跨应用共享模块策略" class="headerlink" title="4.2.2 跨应用共享模块策略"></a>4.2.2 跨应用共享模块策略</h3><p><strong>共享模块类型与策略矩阵</strong></p>
<table>
<thead>
<tr>
<th align="left">模块类型</th>
<th align="left">共享策略</th>
<th align="left">风险控制</th>
<th align="left">典型案例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">基础框架</td>
<td align="left">强制单例 + 严格版本</td>
<td align="left">singleton: true + requiredVersion</td>
<td align="left">React&#x2F;Vue 核心库</td>
</tr>
<tr>
<td align="left">UI组件库</td>
<td align="left">按需加载 + 宽松版本</td>
<td align="left">eager: false + 语义化版本</td>
<td align="left">Ant Design &#x2F; Element UI</td>
</tr>
<tr>
<td align="left">状态管理</td>
<td align="left">单例 + 自定义初始化</td>
<td align="left">init 回调统一配置</td>
<td align="left">Redux Store &#x2F; Pinia</td>
</tr>
<tr>
<td align="left">业务工具库</td>
<td align="left">多版本并行 + 隔离</td>
<td align="left">import() 动态加载</td>
<td align="left">支付SDK&#x2F;埋点工具</td>
</tr>
<tr>
<td align="left">配置对象</td>
<td align="left">不共享 + 独立加载</td>
<td align="left">通过API通信获取</td>
<td align="left">权限配置&#x2F;多语言资源</td>
</tr>
</tbody></table>
<p><strong>版本冲突解决方案</strong></p>
<p>(1) 语义化版本控制</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">'react-dom'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">requiredVersion</span><span class="token operator">:</span> <span class="token string">'^18.1.0'</span><span class="token punctuation">,</span> <span class="token comment">// 允许18.x最新版本</span>
    <span class="token literal-property property">strictVersion</span><span class="token operator">:</span> <span class="token boolean">false</span>       <span class="token comment">// 非严格匹配</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 版本降级适配层</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建适配模块</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">compatibleVue2</span><span class="token punctuation">(</span><span class="token parameter">originalVue</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> originalVue<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token comment">/* 兼容逻辑 */</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 消费者应用</span>
<span class="token keyword">const</span> Vue <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'legacyApp/vue'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> CompatibleVue <span class="token operator">=</span> <span class="token function">compatibleVue2</span><span class="token punctuation">(</span>Vue<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 运行时版本检测</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 主应用初始化时</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>sharedReact <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>sharedReact<span class="token punctuation">.</span>version <span class="token operator">!==</span> <span class="token string">'18.2.0'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">showWarning</span><span class="token punctuation">(</span><span class="token string">'React版本不兼容，正在降级...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">loadFallbackReact</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能优化策略</strong></p>
<p>(1) 层级化共享</p>
<p>架构设计：</p>
<pre><code class="mermaid">graph BT
  MainApp[主应用] --&gt;|共享| Core[核心库]
  SubAppA[子应用A] --&gt; Core
  SubAppB[子应用B] --&gt; Core
  SubAppA --&gt;|私有共享| UtilsA[工具库A]
  SubAppB --&gt;|私有共享| UtilsB[工具库B]</code></pre>

<p>(2) 共享模块预加载</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 主应用HTML --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.com/shared-react.js<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>https://cdn.com/antd.js<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Webpack配置</span>
<span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">react</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">eager</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 同步加载</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 按路由动态共享</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 动态加载共享配置</span>
<span class="token keyword">const</span> <span class="token function-variable function">getSharedDeps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>route<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">'admin-libs'</span><span class="token operator">:</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'admin-app/shared-libs'</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 包裹应用渲染</span>
<span class="token operator">&lt;</span>ModuleFederationContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token function">getSharedDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>App <span class="token operator">/</span><span class="token operator">></span>
<span class="token operator">&lt;</span><span class="token operator">/</span>ModuleFederationContext<span class="token punctuation">.</span>Provider<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>安全沙箱策略</strong></p>
<p>(1) CSS隔离方案</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Webpack配置</span>
<span class="token punctuation">&#123;</span>
  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'style-loader'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> 
        <span class="token literal-property property">injectType</span><span class="token operator">:</span> <span class="token string">'shadowDom'</span> <span class="token comment">// 使用Shadow DOM隔离</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string">'css-loader'</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) JS执行沙箱</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建安全执行环境</span>
<span class="token keyword">const</span> <span class="token function-variable function">safeEval</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">code<span class="token punctuation">,</span> sandbox</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>sandbox<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">has</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=></span> key <span class="token operator">===</span> Symbol<span class="token punctuation">.</span>unscopables <span class="token operator">?</span> <span class="token keyword">undefined</span> <span class="token operator">:</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">Function</span><span class="token punctuation">(</span><span class="token string">'sandbox'</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">with(sandbox)&#123;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>code<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">&#125;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 执行远程模块</span>
<span class="token keyword">const</span> remoteModule <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'untrustedApp/module'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">safeEval</span><span class="token punctuation">(</span>remoteModule<span class="token punctuation">.</span>init<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> console<span class="token punctuation">,</span> Date <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) API访问控制</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建安全代理对象</span>
<span class="token keyword">const</span> <span class="token function-variable function">createSafeAPI</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">localStorage</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">getItem</span><span class="token operator">:</span> <span class="token parameter">key</span> <span class="token operator">=></span> key<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'safe_'</span><span class="token punctuation">)</span> <span class="token operator">?</span> localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token function-variable function">setItem</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token comment">/* 过滤写入 */</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注入共享API</span>
<span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">'@safe-api'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">import</span><span class="token operator">:</span> createSafeAPI<span class="token punctuation">,</span>
    <span class="token literal-property property">eager</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>监控与诊断体系</strong></p>
<p>(1) 共享模块健康检查</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 运行时监控</span>
window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'federated-module-error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  sentry<span class="token punctuation">.</span><span class="token function">captureException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">showErrorToast</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">模块加载失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>e<span class="token punctuation">.</span>detail<span class="token punctuation">.</span>moduleName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 性能追踪</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 记录模块加载时间</span>
performance<span class="token punctuation">.</span><span class="token function">mark</span><span class="token punctuation">(</span><span class="token string">'start-load-shared'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'shared-lib'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  performance<span class="token punctuation">.</span><span class="token function">measure</span><span class="token punctuation">(</span><span class="token string">'shared-load'</span><span class="token punctuation">,</span> <span class="token string">'start-load-shared'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">reportPerfData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 依赖关系可视化</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 生成共享图谱</span>
npx module-federation-stats <span class="token parameter variable">--json</span> <span class="token operator">></span> stats.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>面试深度问题</strong></p>
<p>Q：如何实现CSS跨应用隔离？</p>
<ul>
<li>Shadow DOM 原生隔离</li>
<li>CSS Module 命名空间</li>
<li>PostCSS 添加作用域前缀</li>
<li>运行时样式卸载机制</li>
</ul>
<p>Q：共享Redux Store时如何避免污染？</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 创建命名空间Store</span>
<span class="token keyword">const</span> <span class="token function-variable function">createScopedStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">rootStore</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token function-variable function">dispatch</span><span class="token operator">:</span> <span class="token parameter">action</span> <span class="token operator">=></span> rootStore<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token operator">...</span>action<span class="token punctuation">,</span> <span class="token literal-property property">meta</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">scope</span><span class="token operator">:</span> <span class="token string">'app1'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function-variable function">getState</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> rootStore<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>app1
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Q：如何设计灰度发布方案？</p>
<p>架构：</p>
<ul>
<li>通过URL参数控制版本 (?shared_react&#x3D;18.2)</li>
<li>配置中心下发共享策略</li>
<li>动态加载对应版本的 remoteEntry.js</li>
<li>监控错误率自动回滚</li>
</ul>
<h2 id="4-3-自定义构建流程"><a href="#4-3-自定义构建流程" class="headerlink" title="4.3 自定义构建流程"></a>4.3 自定义构建流程</h2><h3 id="4-3-1-编写CLI工具集成Webpack"><a href="#4-3-1-编写CLI工具集成Webpack" class="headerlink" title="4.3.1 编写CLI工具集成Webpack"></a>4.3.1 编写CLI工具集成Webpack</h3><p><strong>CLI 工具核心架构</strong></p>
<pre><code class="mermaid">graph TD
  CLI[命令行工具] --&gt; Parser[参数解析]
  Parser --&gt; Config[动态生成Webpack配置]
  Config --&gt; Executor[执行Webpack构建]
  Executor --&gt; Reporter[构建结果分析]
  Reporter --&gt; Notifier[通知机制]</code></pre>

<p><strong>基础实现步骤</strong></p>
<p>(1) 初始化 CLI 工程</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mkdir</span> my-webpack-cli <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> my-webpack-cli
<span class="token function">npm</span> init <span class="token parameter variable">-y</span>
<span class="token function">npm</span> <span class="token function">install</span> webpack webpack-cli commander chalk ora @types/node <span class="token parameter variable">-D</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>(2) 创建命令入口</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// bin/cli.js</span>
#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> program <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'commander'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> build <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../lib/build'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

program
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'--env &lt;env>'</span><span class="token punctuation">,</span> <span class="token string">'设置构建环境'</span><span class="token punctuation">,</span> <span class="token string">'production'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'--analyze'</span><span class="token punctuation">,</span> <span class="token string">'启用包分析'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token parameter">options</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token function">build</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

program<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 动态生成 Webpack 配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// lib/build.js</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">generateConfig</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> base <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> envConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./webpack.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>options<span class="token punctuation">.</span>env<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> 
    <span class="token operator">...</span>base<span class="token punctuation">,</span> 
    <span class="token operator">...</span>envConfig<span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> options<span class="token punctuation">.</span>analyze 
      <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token operator">...</span>envConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> 
      <span class="token operator">:</span> envConfig<span class="token punctuation">.</span>plugins
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token function">generateConfig</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 执行构建</span>
  compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>核心增强功能实现</strong></p>
<p>(1) 多进程编译加速</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 集成 thread-loader</span>
<span class="token keyword">const</span> threadLoader <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'thread-loader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

threadLoader<span class="token punctuation">.</span><span class="token function">warmup</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token literal-property property">poolTimeout</span><span class="token operator">:</span> <span class="token number">Infinity</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// webpack 配置</span>
<span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span> <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token string">'babel-loader'</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 智能缓存策略</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 根据环境启用缓存</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> cache <span class="token punctuation">&#125;</span> <span class="token operator">=</span> options<span class="token punctuation">.</span>env <span class="token operator">===</span> <span class="token string">'development'</span>
  <span class="token operator">?</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'memory'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span>
  <span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'filesystem'</span><span class="token punctuation">,</span> <span class="token literal-property property">cacheDirectory</span><span class="token operator">:</span> <span class="token string">'.cache'</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token operator">...</span>config<span class="token punctuation">,</span>
  cache
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 构建进度可视化</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 使用 ora + webpack 进度插件</span>
<span class="token keyword">const</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> spinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span><span class="token string">'开始构建...'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ProgressPlugin</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">percentage<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  spinner<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">构建进度 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token punctuation">(</span>percentage <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">%: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>percentage <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> spinner<span class="token punctuation">.</span><span class="token function">succeed</span><span class="token punctuation">(</span><span class="token string">'构建完成'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>企业级功能扩展</strong></p>
<p>(1) 配置文件热更新</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 监听配置变化</span>
<span class="token keyword">const</span> chokidar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chokidar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

chokidar<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">'config/**/*.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'配置更新，自动重启构建...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  compiler<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span><span class="token function">generateConfig</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 多项目配置管理</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 支持项目选择</span>
program
  <span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">'build'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">'--project &lt;name>'</span><span class="token punctuation">,</span> <span class="token string">'指定项目名称'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token parameter">options</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> projectConfig <span class="token operator">=</span> <span class="token function">loadProjectConfig</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>project<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token operator">...</span>options<span class="token punctuation">,</span> <span class="token operator">...</span>projectConfig <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 项目配置文件</span>
<span class="token comment">// projects/dashboard.json</span>
<span class="token punctuation">&#123;</span>
  <span class="token string-property property">"entry"</span><span class="token operator">:</span> <span class="token string">"./src/dashboard.js"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"outputPath"</span><span class="token operator">:</span> <span class="token string">"dist/dashboard"</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 构建结果分析报告</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 生成HTML报告</span>
<span class="token keyword">const</span> ReportGenerator <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-bundle-analyzer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>

compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReportGenerator</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">'report.html'</span><span class="token punctuation">,</span> report<span class="token punctuation">.</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 关键指标提取</span>
  <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> assets<span class="token punctuation">,</span> warnings <span class="token punctuation">&#125;</span> <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mainSize <span class="token operator">=</span> assets<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">a</span> <span class="token operator">=></span> a<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'main.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>size<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">主包体积: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token punctuation">(</span>mainSize <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">KB</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>发布与集成</strong></p>
<p>(1) 全局安装</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// package.json</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"my-webpack-cli"</span><span class="token punctuation">,</span>
  <span class="token property">"bin"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token property">"mwpack"</span><span class="token operator">:</span> <span class="token string">"./bin/cli.js"</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> my-webpack-cli
mwpack build <span class="token parameter variable">--env</span><span class="token operator">=</span>test<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>(2) CI&#x2F;CD 集成</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># .gitlab-ci.yml</span>
<span class="token key atrule">build_prod</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> mwpack build <span class="token punctuation">-</span><span class="token punctuation">-</span>env=production <span class="token punctuation">-</span><span class="token punctuation">-</span>analyze
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> dist/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 插件扩展机制</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 插件系统设计</span>
program<span class="token punctuation">.</span><span class="token function-variable function">plugin</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">hook<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  pluginHooks<span class="token punctuation">[</span>hook<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token punctuation">(</span>pluginHooks<span class="token punctuation">[</span>hook<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fn<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 用户插件</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">cli</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  cli<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'beforeBuild'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'注入自定义规则'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span>module<span class="token punctuation">.</span>rules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试要点总结</strong></p>
<p>Q：为什么需要 CLI 封装 Webpack？</p>
<ul>
<li>解决配置碎片化、统一团队规范、集成高级功能（如安全扫描&#x2F;性能分析）</li>
</ul>
<p>Q：如何实现配置的动态生成？</p>
<p>关键技术：</p>
<ul>
<li>基于环境变量合并配置</li>
<li>函数式配置生成（如 defineConfig）</li>
<li>插件扩展点</li>
</ul>
<p>Q：构建过程卡死如何诊断？</p>
<p>排查方案：</p>
<ul>
<li>添加 –inspect-brk 调试 Webpack</li>
<li>使用 progress-plugin 定位卡住阶段</li>
<li>分析线程锁（特别是多进程场景）</li>
</ul>
<p>Q：如何确保 CLI 的向后兼容？</p>
<p>策略：</p>
<ul>
<li>语义化版本控制</li>
<li>弃用警告系统</li>
<li>迁移指南生成器</li>
</ul>
<h3 id="4-3-2-钩子函数深度使用（afterEmit-done）"><a href="#4-3-2-钩子函数深度使用（afterEmit-done）" class="headerlink" title="4.3.2 钩子函数深度使用（afterEmit&#x2F;done）"></a>4.3.2 钩子函数深度使用（<code>afterEmit</code>&#x2F;<code>done</code>）</h3><p><strong>核心钩子分类与时机</strong></p>
<pre><code class="mermaid">graph LR
  A[初始化] --&gt; B[编译] --&gt; C[封包] --&gt; D[优化] --&gt; E[输出] --&gt; F[结束]
  
  subgraph 关键钩子
    B --&gt; compiler.make(开始编译)
    C --&gt; compilation.processAssets(资源处理)
    E --&gt;|输出后| compiler.afterEmit(资源写入磁盘)
    F --&gt; compiler.done(构建完成)
  end</code></pre>

<p><strong>钩子注册机制详解</strong></p>
<p>(1) 基础注册方式</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 同步钩子</span>
compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterEmit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'MyPlugin'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'资源已写入磁盘'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 异步钩子 (支持Promise)</span>
compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'MyPlugin'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">await</span> <span class="token function">uploadToCDN</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 执行优先级控制</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 通过stage调整执行顺序（数值越小优先级越高）</span>
compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterEmit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
  <span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'PluginA'</span><span class="token punctuation">,</span> <span class="token literal-property property">stage</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">10</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 优先执行</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterEmit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
  <span class="token punctuation">&#123;</span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'PluginB'</span><span class="token punctuation">,</span> <span class="token literal-property property">stage</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 延后执行</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>企业级应用场景</strong></p>
<p>(1) 构建结果分析（afterEmit）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">class</span> <span class="token class-name">BuildAnalyzerPlugin</span> <span class="token punctuation">&#123;</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterEmit<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'BuildAnalyzer'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> assets <span class="token operator">=</span> compilation<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> report <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">buildTime</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> compilation<span class="token punctuation">.</span>startTime<span class="token punctuation">,</span>
        <span class="token literal-property property">totalSize</span><span class="token operator">:</span> assets<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sum<span class="token punctuation">,</span> asset</span><span class="token punctuation">)</span> <span class="token operator">=></span> sum <span class="token operator">+</span> asset<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">largestAsset</span><span class="token operator">:</span> assets<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=></span> b<span class="token punctuation">.</span>size <span class="token operator">-</span> a<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 写入分析报告</span>
      compilation<span class="token punctuation">.</span><span class="token function">emitAsset</span><span class="token punctuation">(</span>
        <span class="token string">'build-report.json'</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">sources<span class="token punctuation">.</span>RawSource</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 资源自动上传（done）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tapPromise</span><span class="token punctuation">(</span><span class="token string">'OSSPlugin'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 构建失败不上传</span>
  
  <span class="token keyword">const</span> files <span class="token operator">=</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token string">'dist/**/*.&#123;js,css,woff2&#125;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> ossClient<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 更新版本清单</span>
  <span class="token keyword">await</span> <span class="token function">updateVersionManifest</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 构建通知集成</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'SlackNotifier'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> message <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">hasErrors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
    <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">❌ 构建失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>stats<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span>errors<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">✅ 构建成功! 耗时: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>stats<span class="token punctuation">.</span>endTime <span class="token operator">-</span> stats<span class="token punctuation">.</span>startTime<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    
  slack<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">text</span><span class="token operator">:</span> message<span class="token punctuation">,</span>
    <span class="token literal-property property">attachments</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'构建报告'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">fields</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'版本哈希'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> stats<span class="token punctuation">.</span>hash
      <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试深度问题</strong></p>
<p>(1) afterEmit 和 done 的本质区别？</p>
<ul>
<li>afterEmit：资源已写入磁盘但构建未结束，可追加新资源</li>
<li>done：所有流程已完成，适合通知&#x2F;清理操作</li>
</ul>
<p>(2) 如何修改已存在的输出文件？</p>
<p>方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>processAssets<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
  <span class="token punctuation">&#123;</span> <span class="token literal-property property">stage</span><span class="token operator">:</span> Compilation<span class="token punctuation">.</span><span class="token constant">PROCESS_ASSETS_STAGE_OPTIMIZE</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">assets</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> source <span class="token operator">=</span> assets<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> newSource <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">console\.log</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    compilation<span class="token punctuation">.</span><span class="token function">updateAsset</span><span class="token punctuation">(</span><span class="token string">'main.js'</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RawSource</span><span class="token punctuation">(</span>newSource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 多插件如何保证执行顺序？</p>
<p>控制策略：</p>
<ul>
<li>使用 stage 参数显式排序</li>
<li>通过 tapAsync + 回调等待前置插件</li>
<li>在插件名添加排序前缀（01_PluginA, 02_PluginB）</li>
</ul>
<h1 id="五、调试与性能分析"><a href="#五、调试与性能分析" class="headerlink" title="五、调试与性能分析"></a>五、调试与性能分析</h1><h2 id="5-1-构建过程监控"><a href="#5-1-构建过程监控" class="headerlink" title="5.1 构建过程监控"></a>5.1 构建过程监控</h2><h3 id="5-1-1-speed-measure-webpack-plugin（构建耗时分析）"><a href="#5-1-1-speed-measure-webpack-plugin（构建耗时分析）" class="headerlink" title="5.1.1 speed-measure-webpack-plugin（构建耗时分析）"></a>5.1.1 <code>speed-measure-webpack-plugin</code>（构建耗时分析）</h3><p><strong>核心价值与工作原理</strong></p>
<pre><code class="mermaid">graph LR
  A[Webpack 编译] --&gt; B[插件注入计时器]
  B --&gt; C[监控Loader&#x2F;Plugin生命周期]
  C --&gt; D[生成阶段耗时报告]
  D --&gt; E[可视化输出瓶颈点]</code></pre>

<p>核心能力：</p>
<ul>
<li>测量 Loader 和 Plugin 精确耗时</li>
<li>显示并行&#x2F;串行任务链关系</li>
<li>输出可交互的终端报告</li>
</ul>
<p><strong>基础配置与输出解析</strong></p>
<p>(1) 安装与集成</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">npm</span> <span class="token function">install</span> speed-measure-webpack-plugin --save-dev<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>(2) 基础配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> SpeedMeasurePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"speed-measure-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> smp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpeedMeasurePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> smp<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token comment">// 原始Webpack配置</span>
  <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 终端报告解读</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"> SMP  ⏱  
General output <span class="token function">time</span> took <span class="token number">15.25</span> secs

 SMP  ⏱  Plugins
HtmlWebpackPlugin took <span class="token number">3.21</span> secs

 SMP  ⏱  Loaders
babel-loader took <span class="token number">8.43</span> secs, <span class="token number">25</span>% of total <span class="token function">time</span>
  modules with no loaders took <span class="token number">1.2</span> secs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>高级配置技巧</strong></p>
<p>(1) 选择性监控</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">SpeedMeasurePlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">disable</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">,</span> <span class="token comment">// 生产环境禁用</span>
  <span class="token literal-property property">outputFormat</span><span class="token operator">:</span> <span class="token string">'human'</span><span class="token punctuation">,</span> <span class="token comment">// 可选：human/json</span>
  <span class="token literal-property property">loaderTopFiles</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// 显示前5个耗时Loader</span>
  <span class="token literal-property property">pluginTopFiles</span><span class="token operator">:</span> <span class="token number">3</span>   <span class="token comment">// 显示前3个耗时Plugin</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 多配置支持</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 合并多个配置的耗时</span>
<span class="token keyword">const</span> config1 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* 配置A */</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> config2 <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* 配置B */</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">[</span>
  smp<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>config1<span class="token punctuation">)</span><span class="token punctuation">,</span>
  smp<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>config2<span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 生成HTML报告</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> <span class="token punctuation">&#123;</span> WebpackStatsWriterPlugin <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"webpack-stats-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">WebpackStatsWriterPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">"build-stats.json"</span> 
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 分析命令
npx smp-analyze build-stats.json <span class="token parameter variable">--output</span> report.html<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p><strong>避坑指南</strong></p>
<p>(1) 插件兼容性问题</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 解决方案：包装特定插件</span>
<span class="token literal-property property">plugins</span><span class="token operator">:</span> smp<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">IncompatiblePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 被smp特殊处理</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 时间测量误差</p>
<ul>
<li>关闭其他CPU密集型应用</li>
<li>多次测量取平均值（建议3次以上）</li>
</ul>
<p>(3) 生产环境使用</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 通过环境变量禁用</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">ANALYZE_BUILD</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  config <span class="token operator">=</span> smp<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-1-2-webpack-bundle-analyzer（产物体积可视化）"><a href="#5-1-2-webpack-bundle-analyzer（产物体积可视化）" class="headerlink" title="5.1.2 webpack-bundle-analyzer（产物体积可视化）"></a>5.1.2 <code>webpack-bundle-analyzer</code>（产物体积可视化）</h3><p><strong>核心功能全景图</strong></p>
<pre><code class="mermaid">graph LR
  A[Webpack Stats] --&gt; B[Analyzer]
  B --&gt; C[交互式树状图]
  B --&gt; D[模块体积排行榜]
  B --&gt; E[重复依赖检测]
  C --&gt; F[优化决策]</code></pre>

<p>核心价值：</p>
<ul>
<li>可视化模块体积占比</li>
<li>识别重复依赖&#x2F;未使用代码</li>
<li>分析按需加载效果</li>
</ul>
<p><strong>进阶配置与解读技巧</strong></p>
<p>(1) 精准配置方案</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-bundle-analyzer'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>BundleAnalyzerPlugin<span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">analyzerMode</span><span class="token operator">:</span> <span class="token string">'server'</span><span class="token punctuation">,</span>     <span class="token comment">// 可选：server/static/json/disabled</span>
      <span class="token literal-property property">analyzerHost</span><span class="token operator">:</span> <span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">analyzerPort</span><span class="token operator">:</span> <span class="token number">8888</span><span class="token punctuation">,</span>         <span class="token comment">// 自定义端口</span>
      <span class="token literal-property property">openAnalyzer</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>        <span class="token comment">// 禁止自动打开浏览器</span>
      <span class="token literal-property property">reportFilename</span><span class="token operator">:</span> <span class="token string">'report.html'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">defaultSizes</span><span class="token operator">:</span> <span class="token string">'parsed'</span><span class="token punctuation">,</span>     <span class="token comment">// 显示解析后体积(gzip前)</span>
      <span class="token literal-property property">statsOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">excludeModules</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules\/core-js</span><span class="token regex-delimiter">/</span></span> <span class="token comment">// 排除特定模块</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">generateStatsFile</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// 生成stats.json</span>
      <span class="token literal-property property">statsFilename</span><span class="token operator">:</span> <span class="token string">'stats.json'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 关键视图解读</p>
<table>
<thead>
<tr>
<th align="left">视图类型</th>
<th align="left">分析重点</th>
<th align="left">优化方向</th>
</tr>
</thead>
<tbody><tr>
<td align="left">树状图(Treemap)</td>
<td align="left">矩形面积&#x3D;模块体积</td>
<td align="left">定位体积异常模块</td>
</tr>
<tr>
<td align="left">网络图(Network)</td>
<td align="left">模块依赖关系</td>
<td align="left">识别重复依赖包</td>
</tr>
<tr>
<td align="left">排行榜(Toplist)</td>
<td align="left">体积TOP10模块</td>
<td align="left">优先优化大头模块</td>
</tr>
<tr>
<td align="left">时间线(Timeline)</td>
<td align="left">模块加入顺序</td>
<td align="left">优化异步加载时机</td>
</tr>
</tbody></table>
<p><strong>高级分析技巧</strong></p>
<p>(1) 源码映射分析</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 关联SourceMap分析源码</span>
<span class="token keyword">const</span> UnusedFilesPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'unused-files-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">UnusedFilesPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    <span class="token literal-property property">patterns</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'src/**/*.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">globOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">ignore</span><span class="token operator">:</span> <span class="token string">'node_modules/**'</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 第三方库占比计算</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 生成node_modules占比报告</span>
<span class="token keyword">const</span> nodeModuleSize <span class="token operator">=</span> stats<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span>chunks<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">sum<span class="token punctuation">,</span> chunk</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> sum <span class="token operator">+</span> chunk<span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> m<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">size<span class="token punctuation">,</span> m</span><span class="token punctuation">)</span> <span class="token operator">=></span> size <span class="token operator">+</span> m<span class="token punctuation">.</span>size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">node_modules占比：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token punctuation">(</span>nodeModuleSize<span class="token operator">/</span>stats<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span>assets<span class="token punctuation">[</span><span class="token string">'main.js'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">%</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) Gzip后体积预估</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">defaultSizes</span><span class="token operator">:</span> <span class="token string">'gzip'</span><span class="token punctuation">,</span> <span class="token comment">// 显示gzip后体积</span>
  <span class="token literal-property property">analyzerStatsOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 自定义压缩配置</span>
    <span class="token literal-property property">gzipLevel</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
    <span class="token literal-property property">brotli</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>避坑指南</strong></p>
<p>(1) 分析结果失真</p>
<ul>
<li>确保使用production模式分析（mode: ‘production’）</li>
<li>禁用devtool或设为hidden-source-map</li>
</ul>
<p>(2) 内存溢出处理</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 增加Node内存限制</span>
<span class="token function">node</span> --max-old-space-size<span class="token operator">=</span><span class="token number">4096</span> node_modules/webpack/bin/webpack.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>(3) 安全风险防范</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 生产环境自动禁用</span>
<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">ANALYZE</span> <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-2-DevServer深度配置"><a href="#5-2-DevServer深度配置" class="headerlink" title="5.2 DevServer深度配置"></a>5.2 DevServer深度配置</h2><h3 id="5-2-1-HMR原理与热更新范围控制"><a href="#5-2-1-HMR原理与热更新范围控制" class="headerlink" title="5.2.1 HMR原理与热更新范围控制"></a>5.2.1 HMR原理与热更新范围控制</h3><p><strong>HMR 核心工作流程</strong></p>
<pre><code class="mermaid">sequenceDiagram
  Browser-&gt;&gt;Webpack DevServer: 1. 建立 WebSocket 连接
  Webpack DevServer-&gt;&gt;Browser: 2. 推送当前编译哈希
  Note left of Webpack DevServer: 文件修改
  Webpack DevServer-&gt;&gt;Compiler: 3. 触发增量编译
  Compiler-&gt;&gt;Webpack DevServer: 4. 发送更新信号(hash-update)
  Webpack DevServer-&gt;&gt;Browser: 5. 通过 WS 发送更新清单
  Browser-&gt;&gt;Webpack Runtime: 6. 发起 JSONP 请求获取更新模块
  Webpack Runtime-&gt;&gt;Browser: 7. 执行模块替换
  Browser-&gt;&gt;HMR API: 8. 触发 module.hot.accept</code></pre>

<p><strong>底层实现原理</strong></p>
<p>(1) 关键模块协作</p>
<table>
<thead>
<tr>
<th align="left">模块</th>
<th align="left">职责</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Webpack DevServer</td>
<td align="left">提供 HTTP 服务 + WebSocket 通信</td>
</tr>
<tr>
<td align="left">HotModuleReplacementPlugin</td>
<td align="left">在输出代码中注入 HMR Runtime 和模块更新逻辑</td>
</tr>
<tr>
<td align="left">HMR Runtime (客户端)</td>
<td align="left">处理更新消息、加载新模块、执行热替换</td>
</tr>
<tr>
<td align="left">webpack&#x2F;hot&#x2F;emitter</td>
<td align="left">服务端事件广播机制</td>
</tr>
</tbody></table>
<p>(2) 更新包结构解析</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 客户端接收的更新包</span>
<span class="token punctuation">&#123;</span>
  <span class="token string-property property">"c"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token comment">// 更新的 chunk ID</span>
    <span class="token string-property property">"main"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 更新的模块数组</span>
      <span class="token punctuation">[</span>moduleId<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* 新模块工厂函数 */</span> <span class="token punctuation">&#125;</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string-property property">"r"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token comment">// 需要重新加载的 chunk</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>热更新范围控制策略</strong></p>
<p>(1) 模块级粒度控制</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 只监控特定模块更新</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 精确监听组件</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token string">'./components/Button.jsx'</span><span class="token punctuation">,</span> <span class="token string">'./utils/api.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 手动更新逻辑</span>
      <span class="token keyword">const</span> NewButton <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./components/Button.jsx'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
      ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>NewButton <span class="token operator">/</span><span class="token operator">></span><span class="token punctuation">,</span> buttonContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 状态保留技术</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// React 组件状态保留</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">'./App.jsx'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取当前组件状态</span>
    <span class="token keyword">const</span> currentState <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 重新渲染</span>
    <span class="token keyword">const</span> NextApp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./App.jsx'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
    ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>Provider store<span class="token operator">=</span><span class="token punctuation">&#123;</span>store<span class="token punctuation">&#125;</span><span class="token operator">></span>
        <span class="token operator">&lt;</span>NextApp <span class="token operator">/</span><span class="token operator">></span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>Provider<span class="token operator">></span><span class="token punctuation">,</span>
      rootEl
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 恢复状态</span>
    store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'HMR_RELOAD'</span><span class="token punctuation">,</span> <span class="token literal-property property">payload</span><span class="token operator">:</span> currentState <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 更新边界控制</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 设置更新边界（CSS模块无需处理）</span>
module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./styles.css'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// CSS 更新自动应用，无需操作</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>性能优化实践</strong></p>
<p>(1) 大型应用更新加速</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 配置 webpack.config.js</span>
<span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">hot</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token literal-property property">devMiddleware</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">writeToDisk</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 禁止写入磁盘</span>
    <span class="token literal-property property">serverSideRender</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 服务端渲染优化</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">client</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">overlay</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 关闭错误遮罩</span>
    <span class="token literal-property property">progress</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token comment">// 关闭进度条</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 更新频率节流</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 自定义中间件</span>
devServer<span class="token punctuation">.</span><span class="token function-variable function">setupMiddlewares</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">middlewares</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> throttle <span class="token operator">=</span> <span class="token function">createThrottle</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1秒节流</span>
  
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token operator">...</span>middlewares<span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'__webpack_hmr'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">throttle</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 选择性 HMR 注入</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 只对开发环境关键模块启用</span>
<span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(jsx|tsx|vue)$</span><span class="token regex-delimiter">/</span></span> <span class="token comment">// 仅 JSX/TSX/Vue 文件启用</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span>

<span class="token comment">// 阻止冒泡更新</span>
module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">decline</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'./config.js'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 此模块变更时强制刷新</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>面试深度问题</strong></p>
<p>(1) HMR 如何保留 React 组件的状态？</p>
<p>通过 react-refresh 的 runtime 注入，在组件更新时：</p>
<ul>
<li>创建代理组件保留状态树</li>
<li>映射新旧组件关系</li>
<li>触发生命周期钩子（如 useEffect 清理）</li>
</ul>
<p>(2) WebSocket 断开后如何恢复 HMR？</p>
<p>方案：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 自动重连机制</span>
<span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>initSocket<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 超时检测</span>
<span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> 
  <span class="token keyword">if</span> <span class="token punctuation">(</span>socket<span class="token punctuation">.</span>readyState <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">initSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 如何实现 Vuex store 的热更新？</p>
<p>代码实现：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">'./store'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> newStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./store'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
    store<span class="token punctuation">.</span><span class="token function">hotUpdate</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">modules</span><span class="token operator">:</span> newStore<span class="token punctuation">.</span>modules
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-2-2-Proxy配置解决跨域（pathRewrite-context）"><a href="#5-2-2-Proxy配置解决跨域（pathRewrite-context）" class="headerlink" title="5.2.2 Proxy配置解决跨域（pathRewrite&#x2F;context）"></a>5.2.2 Proxy配置解决跨域（<code>pathRewrite</code>&#x2F;<code>context</code>）</h3><p><strong>跨域问题本质与解决方案对比</strong></p>
<pre><code class="mermaid">graph LR
  A[浏览器] --&gt;|同源策略| B[API请求被拦截]
  B --&gt; C[解决方案]
  C --&gt; D1[后端CORS]
  C --&gt; D2[JSONP]
  C --&gt; D3[代理转发]
  D3 --&gt; E[Webpack DevServer Proxy]</code></pre>

<p>代理方案优势：</p>
<ul>
<li>前端零改造</li>
<li>支持HTTPS&#x2F;WebSocket</li>
<li>路径重写&#x2F;请求拦截</li>
</ul>
<p><strong>核心配置参数解析</strong></p>
<p>(1) 基础代理设置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string-property property">'/api'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://api.example.com'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">pathRewrite</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">'^/api'</span><span class="token operator">:</span> <span class="token string">''</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 关键参数详解</p>
<table>
<thead>
<tr>
<th align="left">参数</th>
<th align="left">类型</th>
<th align="left">作用</th>
<th align="left">默认值</th>
</tr>
</thead>
<tbody><tr>
<td align="left">target</td>
<td align="left">string</td>
<td align="left">代理目标服务器地址</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">changeOrigin</td>
<td align="left">boolean</td>
<td align="left">修改请求头Host为目标域名</td>
<td align="left">false</td>
</tr>
<tr>
<td align="left">pathRewrite</td>
<td align="left">object</td>
<td align="left">URL路径重写规则</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">context</td>
<td align="left">string[]</td>
<td align="left">匹配多个路径前缀</td>
<td align="left">-</td>
</tr>
<tr>
<td align="left">secure</td>
<td align="left">boolean</td>
<td align="left">是否验证SSL证书</td>
<td align="left">true</td>
</tr>
<tr>
<td align="left">ws</td>
<td align="left">boolean</td>
<td align="left">是否代理WebSocket</td>
<td align="left">true</td>
</tr>
<tr>
<td align="left">headers</td>
<td align="left">object</td>
<td align="left">添加自定义请求头</td>
<td align="left">-</td>
</tr>
</tbody></table>
<p><strong>高级代理策略实战</strong></p>
<p>(1) 多路径上下文代理</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 匹配多个前缀</span>
<span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">context</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/auth'</span><span class="token punctuation">,</span> <span class="token string">'/users'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://user-service.com'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">pathRewrite</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">'^/auth'</span><span class="token operator">:</span> <span class="token string">'/api/v1/auth'</span><span class="token punctuation">,</span> <span class="token string-property property">'^/users'</span><span class="token operator">:</span> <span class="token string">'/api/v1/users'</span> <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 动态目标转发</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 根据请求动态选择目标</span>
<span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">'/services'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token function-variable function">target</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> service <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'x-service-name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>service<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.internal.com</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 请求拦截与修改</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">'/api'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://api.example.com'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">bypass</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> proxyOptions</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 拦截特定请求</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">'/mock/test.json'</span><span class="token punctuation">;</span> <span class="token comment">// 返回本地mock数据</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// 添加认证头</span>
      req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'Authorization'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Bearer token'</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(4) HTTPS证书代理</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">'/secure'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'https://secure-api.com'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">secure</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 禁用证书验证</span>
    <span class="token literal-property property">agent</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">https<span class="token punctuation">.</span>Agent</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">ca</span><span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'internal-ca.pem'</span><span class="token punctuation">)</span> <span class="token comment">// 自签名证书</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>安全防护策略</strong></p>
<p>(1) 请求头过滤</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">'/api'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://api.example.com'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 阻止敏感头转发</span>
      <span class="token string-property property">'Cookie'</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token string-property property">'Authorization'</span><span class="token operator">:</span> <span class="token keyword">null</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onProxyReq</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">proxyReq</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 添加自定义头</span>
      proxyReq<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'X-Proxy-Source'</span><span class="token punctuation">,</span> <span class="token string">'webpack-dev-server'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) IP白名单控制</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">'/admin'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://admin-api.com'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onProxyReq</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">proxyReq<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> clientIP <span class="token operator">=</span> req<span class="token punctuation">.</span>connection<span class="token punctuation">.</span>remoteAddress<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>allowIPs<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>clientIP<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'IP not allowed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 敏感路径拦截</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">bypass</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 禁止访问内部接口</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/internal'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token string">'Access denied'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>高级应用技巧</strong></p>
<p>(1) GraphQL请求代理</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">'/graphql'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://api.example.com/graphql'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">ws</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 支持subscriptions</span>
    <span class="token function-variable function">onProxyReq</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">proxyReq</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 修改GraphQL请求体</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>proxyReq<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>proxyReq<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        body<span class="token punctuation">.</span>variables <span class="token operator">=</span> <span class="token function">sanitizeVariables</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span>variables<span class="token punctuation">)</span><span class="token punctuation">;</span>
        proxyReq<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 文件上传代理</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">proxy</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token string-property property">'/upload'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">target</span><span class="token operator">:</span> <span class="token string">'http://file-service.com'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">changeOrigin</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 解决大文件上传超时</span>
    <span class="token literal-property property">proxyTimeout</span><span class="token operator">:</span> <span class="token number">300000</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onProxyReq</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">proxyReq<span class="token punctuation">,</span> req</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 流式传输避免内存溢出</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        req<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>proxyReq<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) SSR请求直通</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// next.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">async</span> <span class="token function">rewrites</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
      <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token string">'/api/:path*'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">destination</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PROXY_TARGET</span> <span class="token operator">+</span> <span class="token string">'/api/:path*'</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="5-2-3-中间件扩展（before-after钩子）"><a href="#5-2-3-中间件扩展（before-after钩子）" class="headerlink" title="5.2.3 中间件扩展（before&#x2F;after钩子）"></a>5.2.3 中间件扩展（<code>before</code>&#x2F;<code>after</code>钩子）</h3><p>Webpack DevServer 的中间件扩展能力是开发环境定制的核心，通过 before 和 after 钩子实现全链路请求拦截与增强</p>
<p><strong>中间件扩展架构全景</strong></p>
<pre><code class="mermaid">graph LR
  A[客户端请求] --&gt; B[DevServer]
  B --&gt; C[before 中间件]
  C --&gt; D[静态资源处理]
  D --&gt; E[Webpack编译]
  E --&gt; F[after 中间件]
  F --&gt; G[响应客户端]</code></pre>

<p>核心能力：</p>
<ul>
<li>请求拦截与修改</li>
<li>自定义路由处理</li>
<li>Mock数据注入</li>
<li>安全防护增强</li>
</ul>
<p><strong>基础配置与执行顺序</strong></p>
<p>(1) 钩子函数定义</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token function-variable function">before</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> server<span class="token punctuation">,</span> compiler</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 请求到达Webpack前的处理</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token function-variable function">after</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> server<span class="token punctuation">,</span> compiler</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 响应返回前的处理</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 典型执行顺序</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">1. before 中间件
   ├── 自定义中间件A
   ├── 自定义中间件B
2. Webpack内置中间件（静态服务/HMR）
3. after 中间件
   ├── 日志记录
   └── 响应修改<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>before 钩子高级应用</strong></p>
<p>(1) 动态Mock数据</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">before</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 根据参数返回不同数据</span>
    <span class="token keyword">const</span> role <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>role <span class="token operator">||</span> <span class="token string">'user'</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Mock </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>role<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token literal-property property">permissions</span><span class="token operator">:</span> role <span class="token operator">===</span> <span class="token string">'admin'</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">,</span> <span class="token string">'write'</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 请求拦截与重定向</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">before</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 禁止访问敏感路径</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'/internal'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">403</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Access denied'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 重定向旧路径</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'/old-api'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">,</span> <span class="token string">'/new-api'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 接口聚合（BFF层）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">before</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/page-data'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 并行请求多个接口</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>user<span class="token punctuation">,</span> products<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://user-service/user'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://product-service/products'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token keyword">await</span> user<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token literal-property property">products</span><span class="token operator">:</span> <span class="token keyword">await</span> products<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>after 钩子高阶用法</strong></p>
<p>(1) 全局响应包装</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">after</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> originalSend <span class="token operator">=</span> res<span class="token punctuation">.</span>send<span class="token punctuation">;</span>
    
    <span class="token comment">// 拦截所有响应</span>
    res<span class="token punctuation">.</span><span class="token function-variable function">send</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// 统一包装格式</span>
      <span class="token keyword">const</span> wrappedData <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">timestamp</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token function">originalSend</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>wrappedData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 性能监控埋点</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">after</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    res<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'finish'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">const</span> duration <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">;</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>req<span class="token punctuation">.</span>method<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>req<span class="token punctuation">.</span>url<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>duration<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// 上报到监控系统</span>
      perfMonitor<span class="token punctuation">.</span><span class="token function">track</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> req<span class="token punctuation">.</span>path<span class="token punctuation">,</span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> req<span class="token punctuation">.</span>method<span class="token punctuation">,</span>
        duration
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 安全响应头注入</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token function-variable function">after</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 添加安全头</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'X-Content-Type-Options'</span><span class="token punctuation">,</span> <span class="token string">'nosniff'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Security-Policy'</span><span class="token punctuation">,</span> <span class="token string">"default-src 'self'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Strict-Transport-Security'</span><span class="token punctuation">,</span> <span class="token string">'max-age=31536000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h1 id="六、原理与源码层"><a href="#六、原理与源码层" class="headerlink" title="六、原理与源码层"></a>六、原理与源码层</h1><h2 id="6-1-Tapable事件流机制"><a href="#6-1-Tapable事件流机制" class="headerlink" title="6.1 Tapable事件流机制"></a>6.1 Tapable事件流机制</h2><h3 id="6-1-1-同步-异步钩子调用流程"><a href="#6-1-1-同步-异步钩子调用流程" class="headerlink" title="6.1.1 同步&#x2F;异步钩子调用流程"></a>6.1.1 同步&#x2F;异步钩子调用流程</h3><h3 id="6-1-2-插件注册与触发原理"><a href="#6-1-2-插件注册与触发原理" class="headerlink" title="6.1.2 插件注册与触发原理"></a>6.1.2 插件注册与触发原理</h3><h2 id="6-2-AST应用"><a href="#6-2-AST应用" class="headerlink" title="6.2 AST应用"></a>6.2 AST应用</h2><h3 id="6-2-1-Loader中的AST操作（Babel-Parser案例）"><a href="#6-2-1-Loader中的AST操作（Babel-Parser案例）" class="headerlink" title="6.2.1 Loader中的AST操作（Babel Parser案例）"></a>6.2.1 Loader中的AST操作（Babel Parser案例）</h3><h3 id="6-2-2-依赖图（Dependency-Graph）生成过程"><a href="#6-2-2-依赖图（Dependency-Graph）生成过程" class="headerlink" title="6.2.2 依赖图（Dependency Graph）生成过程"></a>6.2.2 依赖图（Dependency Graph）生成过程</h3><h2 id="6-3-核心流程源码解析"><a href="#6-3-核心流程源码解析" class="headerlink" title="6.3 核心流程源码解析"></a>6.3 核心流程源码解析</h2><h3 id="6-3-1-编译阶段：Module-→-Chunk-→-Asset-转换"><a href="#6-3-1-编译阶段：Module-→-Chunk-→-Asset-转换" class="headerlink" title="6.3.1 编译阶段：Module → Chunk → Asset 转换"></a>6.3.1 编译阶段：Module → Chunk → Asset 转换</h3><h3 id="6-3-2-输出阶段：Template渲染与文件生成"><a href="#6-3-2-输出阶段：Template渲染与文件生成" class="headerlink" title="6.3.2 输出阶段：Template渲染与文件生成"></a>6.3.2 输出阶段：Template渲染与文件生成</h3><h1 id="七、生态与未来趋势"><a href="#七、生态与未来趋势" class="headerlink" title="七、生态与未来趋势"></a>七、生态与未来趋势</h1><h2 id="7-1-Webpack-5-新特性"><a href="#7-1-Webpack-5-新特性" class="headerlink" title="7.1 Webpack 5 新特性"></a>7.1 Webpack 5 新特性</h2><h3 id="7-1-1-持久化缓存（persistentCache）"><a href="#7-1-1-持久化缓存（persistentCache）" class="headerlink" title="7.1.1 持久化缓存（persistentCache）"></a>7.1.1 持久化缓存（<code>persistentCache</code>）</h3><h3 id="7-1-2-模块联邦（Module-Federation）"><a href="#7-1-2-模块联邦（Module-Federation）" class="headerlink" title="7.1.2 模块联邦（Module Federation）"></a>7.1.2 模块联邦（Module Federation）</h3><h3 id="7-1-3-Asset-Modules资源处理"><a href="#7-1-3-Asset-Modules资源处理" class="headerlink" title="7.1.3 Asset Modules资源处理"></a>7.1.3 Asset Modules资源处理</h3><h2 id="7-2-与新兴工具协作"><a href="#7-2-与新兴工具协作" class="headerlink" title="7.2 与新兴工具协作"></a>7.2 与新兴工具协作</h2><h3 id="7-2-1-Webpack-Vite-混合开发模式"><a href="#7-2-1-Webpack-Vite-混合开发模式" class="headerlink" title="7.2.1 Webpack + Vite 混合开发模式"></a>7.2.1 Webpack + Vite 混合开发模式</h3><h3 id="7-2-2-Rust工具链集成（swc-loader替代Babel）"><a href="#7-2-2-Rust工具链集成（swc-loader替代Babel）" class="headerlink" title="7.2.2 Rust工具链集成（swc-loader替代Babel）"></a>7.2.2 Rust工具链集成（<code>swc-loader</code>替代Babel）</h3><hr>
<h1 id="八、面试专项准备建议"><a href="#八、面试专项准备建议" class="headerlink" title="八、面试专项准备建议"></a>八、面试专项准备建议</h1><h2 id="8-1-高频考点"><a href="#8-1-高频考点" class="headerlink" title="8.1 高频考点"></a>8.1 高频考点</h2><h3 id="8-1-1-Tree-Shaking条件与副作用处理"><a href="#8-1-1-Tree-Shaking条件与副作用处理" class="headerlink" title="8.1.1 Tree Shaking条件与副作用处理"></a>8.1.1 Tree Shaking条件与副作用处理</h3><p><strong>Tree Shaking 生效的四大核心条件</strong></p>
<table>
<thead>
<tr>
<th align="left">条件</th>
<th align="left">原理说明</th>
<th align="left">验证方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1. ES Module 语法</td>
<td align="left">静态分析依赖关系（import&#x2F;export）</td>
<td align="left">检查是否使用 require</td>
</tr>
<tr>
<td align="left">2. 生产模式（mode: ‘production’）</td>
<td align="left">Webpack 自动启用压缩与无副作用优化</td>
<td align="left">查看 optimization.usedExports</td>
</tr>
<tr>
<td align="left">3. 无副作用标记</td>
<td align="left">通过 package.json 的 sideEffects 声明</td>
<td align="left">分析构建输出未使用导出</td>
</tr>
<tr>
<td align="left">4. 工具链支持</td>
<td align="left">Babel 不转换 ES Module（preset-env 需设 modules: false）</td>
<td align="left">检查编译后代码是否保留 import</td>
</tr>
</tbody></table>
<p><strong>副作用（Side Effects）处理机制</strong></p>
<p>(1) 全局副作用声明</p>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// package.json</span>
<span class="token punctuation">&#123;</span>
  <span class="token property">"sideEffects"</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">// 所有文件均无副作用</span>
  <span class="token property">"sideEffects"</span><span class="token operator">:</span> <span class="token punctuation">[</span>       <span class="token comment">// 指定有副作用的文件</span>
    <span class="token string">"*.css"</span><span class="token punctuation">,</span>
    <span class="token string">"src/polyfill.js"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 模块级标记</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 在模块内标记</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> utils <span class="token operator">=</span> <span class="token comment">/*#__PURE__*/</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span> <span class="token operator">...</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 标记纯函数</span>

<span class="token comment">// 或使用 magic comment</span>
<span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackIgnore: true */</span> <span class="token string">'analytics.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 强制保留</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) Webpack 配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">sideEffects</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 启用全局副作用分析</span>
  <span class="token literal-property property">providedExports</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 导出分析</span>
  <span class="token literal-property property">usedExports</span><span class="token operator">:</span> <span class="token boolean">true</span>   <span class="token comment">// 标记未使用导出</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>Tree Shaking 失效的六大场景与解决方案</strong></p>
<table>
<thead>
<tr>
<th align="left">失效场景</th>
<th align="left">原因分析</th>
<th align="left">解决方案</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1. Babel 转换 ESM</td>
<td align="left"><code>@babel/preset-env</code> 默认转换 ES6 模块为 CommonJS</td>
<td align="left">配置 <code>presets: [[&#39;@babel/preset-env&#39;, &#123; modules: false &#125;]]</code></td>
</tr>
<tr>
<td align="left">2. 第三方库未声明副作用</td>
<td align="left">Lodash 未标记 <code>sideEffects: false</code></td>
<td align="left">手动添加配置：package.json 或使用 lodash-es</td>
</tr>
<tr>
<td align="left">3. CSS 导入被误删</td>
<td align="left"><code>import &#39;./styles.css&#39;</code> 被视为无导出语句</td>
<td align="left">在 sideEffects 添加 [“*.css”]</td>
</tr>
<tr>
<td align="left">4. 动态访问导出属性</td>
<td align="left"><code>obj[dynamicKey]</code> 使工具无法静态分析</td>
<td align="left">改为静态访问：<code>import &#123; named &#125; from &#39;lib&#39;</code></td>
</tr>
<tr>
<td align="left">5. 立即执行函数副作用</td>
<td align="left">IIFE 中包含 DOM 操作等副作用</td>
<td align="left">使用 <code>/*#__PURE__*/</code> 标记或重构为声明式函数</td>
</tr>
<tr>
<td align="left">6. 模块重导出链条断裂</td>
<td align="left">中间模块未正确转发导出</td>
<td align="left">使用统一出口文件：<code>export * from &#39;./module&#39;</code></td>
</tr>
</tbody></table>
<h3 id="8-1-2-SplitChunks配置项优先级"><a href="#8-1-2-SplitChunks配置项优先级" class="headerlink" title="8.1.2 SplitChunks配置项优先级"></a>8.1.2 SplitChunks配置项优先级</h3><p><strong>配置项优先级总览</strong></p>
<pre><code class="mermaid">graph TD
  A[全局splitChunks配置] --&gt; B[cacheGroups默认组]
  A --&gt; C[cacheGroups自定义组]
  C --&gt; D[组内priority属性]
  D --&gt; E[模块匹配test&#x2F;type]
  E --&gt; F[模块体积minSize等]</code></pre>

<p>优先级核心原则：</p>
<ul>
<li>cacheGroups 优先级 &gt; 全局配置</li>
<li>priority 数值越大优先级越高</li>
<li>同一优先级下匹配顺序决定</li>
</ul>
<p><strong>配置继承关系详解</strong></p>
<p>(1) 全局配置 vs 缓存组配置</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 全局配置（低优先级）</span>
<span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">splitChunks</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">chunks</span><span class="token operator">:</span> <span class="token string">'all'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">minSize</span><span class="token operator">:</span> <span class="token number">20000</span><span class="token punctuation">,</span>
    <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">vendors</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">// 高优先级</span>
        <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">10</span>                   <span class="token comment">// 优先级数值</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(2) 参数继承规则</p>
<table>
<thead>
<tr>
<th align="left">配置项</th>
<th align="left">继承逻辑</th>
</tr>
</thead>
<tbody><tr>
<td align="left">chunks</td>
<td align="left">缓存组可覆盖全局设置</td>
</tr>
<tr>
<td align="left">minSize</td>
<td align="left">缓存组未设置时继承全局，设置后覆盖</td>
</tr>
<tr>
<td align="left">maxAsyncRequests</td>
<td align="left">独立生效（不继承），需在每组显式设置</td>
</tr>
<tr>
<td align="left">name</td>
<td align="left">缓存组未设置时使用全局 filename 模板</td>
</tr>
</tbody></table>
<p><strong>缓存组（cacheGroups）竞争机制</strong></p>
<p>(1) 模块匹配流程</p>
<pre><code class="mermaid">graph LR
  模块 --&gt; 匹配组A&#123;test规则&#125; 
  匹配组A -- 是 --&gt; 优先级A[priority:10]
  匹配组A -- 否 --&gt; 匹配组B&#123;test规则&#125;
  匹配组B -- 是 --&gt; 优先级B[priority:20]
  优先级B -- 更高 --&gt; 选定组B
  优先级A -- 更高 --&gt; 选定组A
  匹配组B -- 否 --&gt; 默认组[vendors&#x2F;default]</code></pre>

<p>(2) 同优先级竞争</p>
<p>当两个组 priority 相同且都匹配模块时：</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">reactVendor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/](react|react-dom)[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">20</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">utilsVendor</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/](lodash|moment)[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">20</span> <span class="token comment">// 相同优先级</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>决策逻辑：</p>
<ul>
<li>先检查 reactVendor（配置顺序在前）</li>
<li>若匹配则归入该组，不再检查后续组</li>
</ul>
<h3 id="8-1-3-HMR工作流程（WebSocket-→-HotModuleReplacementPlugin）"><a href="#8-1-3-HMR工作流程（WebSocket-→-HotModuleReplacementPlugin）" class="headerlink" title="8.1.3 HMR工作流程（WebSocket → HotModuleReplacementPlugin）"></a>8.1.3 HMR工作流程（WebSocket → HotModuleReplacementPlugin）</h3><pre><code class="mermaid">sequenceDiagram
  Browser-&gt;&gt;DevServer: 1. 建立 WebSocket 连接
  Note over DevServer: 文件修改
  DevServer-&gt;&gt;Compiler: 2. 触发增量编译
  Compiler-&gt;&gt;DevServer: 3. 生成 Hash 和 Manifest
  DevServer-&gt;&gt;Browser: 4. 推送 hash 消息 (socket.send)
  Browser-&gt;&gt;Runtime: 5. 发起 JSONP 请求更新模块
  Runtime-&gt;&gt;Browser: 6. 执行模块替换 (applyUpdate)
  Browser-&gt;&gt;HMR API: 7. 触发 module.hot.accept 回调</code></pre>

<h2 id="8-2-场景设计题"><a href="#8-2-场景设计题" class="headerlink" title="8.2 场景设计题"></a>8.2 场景设计题</h2><h3 id="8-2-1-“如何实现秒级构建的微前端项目？”"><a href="#8-2-1-“如何实现秒级构建的微前端项目？”" class="headerlink" title="8.2.1 “如何实现秒级构建的微前端项目？”"></a>8.2.1 “如何实现秒级构建的微前端项目？”</h3><p><strong>持久化缓存优化</strong></p>
<p>(1) Webpack 5 文件系统缓存</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// webpack.config.js</span>
<span class="token literal-property property">cache</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'filesystem'</span><span class="token punctuation">,</span> <span class="token comment">// 启用持久化缓存</span>
  <span class="token literal-property property">cacheDirectory</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'.cache/webpack'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token literal-property property">buildDependencies</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">config</span><span class="token operator">:</span> <span class="token punctuation">[</span>__filename<span class="token punctuation">]</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 配置文件变更时自动失效缓存</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>效果：二次构建时间减少70%以上（首屏构建从12s→3s）。</li>
<li>原理：将编译结果（模块AST、依赖图）写入磁盘，跳过重复解析。</li>
</ul>
<p>(2) 内容哈希精准缓存</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'[name].[contenthash:8].js'</span><span class="token punctuation">,</span> <span class="token comment">// 基于内容变化的哈希</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>仅修改的文件触发重新构建，未变更模块直接复用缓存。</li>
</ul>
<p><strong>增量编译与按需加载</strong></p>
<p>(1) 动态入口（Dynamic Entry）</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 根据路由动态生成Entry</span>
<span class="token keyword">const</span> <span class="token function-variable function">dynamicEntries</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> pages <span class="token operator">=</span> <span class="token function">detectUserRoutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 动态扫描路由文件</span>
  <span class="token keyword">return</span> pages<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entries<span class="token punctuation">,</span> page</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    entries<span class="token punctuation">[</span>page<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./src/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>page<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> entries<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">entry</span><span class="token operator">:</span> dynamicEntries <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>优势：仅编译当前开发涉及的路由模块，降低80%编译量。</li>
</ul>
<p>(2) 按需加载子应用</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 主应用动态加载子应用</span>
<span class="token keyword">const</span> <span class="token function-variable function">loadApp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">appName</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">remoteApps/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>appName<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">/remoteEntry.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">remote</span> <span class="token operator">=></span> remote<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>sharedScope<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>模块联邦（Module Federation）深度优化</strong></p>
<p>(1) 共享依赖策略</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 子应用配置</span>
<span class="token keyword">new</span> <span class="token class-name">ModuleFederationPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'productApp'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'remoteEntry.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">exposes</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">'./ProductList'</span><span class="token operator">:</span> <span class="token string">'./src/components/ProductList.jsx'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">shared</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">react</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">singleton</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">eager</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
    <span class="token string-property property">'react-dom'</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">singleton</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>关键参数：</p>
<ul>
<li>singleton: true：强制单例，避免重复加载。</li>
<li>eager: true：主应用启动时预加载，减少运行时延迟。</li>
</ul>
<p>(2) 并行加载远程模块</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 使用Promise.all并行加载</span>
Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'app1/Button'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'app2/Table'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>Button<span class="token punctuation">,</span> Table<span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token function">renderApp</span><span class="token punctuation">(</span>Button<span class="token punctuation">,</span> Table<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>结合HTTP&#x2F;2多路复用，提升模块加载效率。</li>
</ul>
<p><strong>构建流程加速策略</strong></p>
<p>(1) 缩小Loader处理范围</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>
  <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.jsx?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
  <span class="token literal-property property">include</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 限定src目录</span>
  <span class="token literal-property property">exclude</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">// 排除node_modules</span>
  <span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'babel-loader'</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>效果：减少50%文件编译量。</li>
</ul>
<p>(2) 多进程编译</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">use</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token punctuation">&#123;</span> <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span> <span class="token literal-property property">options</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">workers</span><span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// 多进程</span>
  <span class="token string">'babel-loader?cacheDirectory=true'</span> <span class="token comment">// 启用Babel缓存</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>推荐工具：thread-loader + cache-loader。</li>
</ul>
<p>(3) 优化模块搜索路径</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">[</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'node_modules'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 锁定node_modules位置</span>
  <span class="token literal-property property">alias</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token string-property property">'react'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./vendor/react.min.js'</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span> <span class="token comment">// 别名缩短路径</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-2-2-“首屏加载慢，从哪些维度优化？”"><a href="#8-2-2-“首屏加载慢，从哪些维度优化？”" class="headerlink" title="8.2.2 “首屏加载慢，从哪些维度优化？”"></a>8.2.2 “首屏加载慢，从哪些维度优化？”</h3><p><strong>诊断瓶颈点</strong></p>
<table>
<thead>
<tr>
<th align="left">指标</th>
<th align="left">分析工具</th>
<th align="left">优化方向</th>
</tr>
</thead>
<tbody><tr>
<td align="left">FCP (首次内容绘制)</td>
<td align="left">Lighthouse、WebPageTest</td>
<td align="left">资源加载、阻塞渲染</td>
</tr>
<tr>
<td align="left">LCP (最大内容绘制)</td>
<td align="left">Chrome DevTools</td>
<td align="left">图片&#x2F;字体、渲染阻塞</td>
</tr>
<tr>
<td align="left">TTI (可交互时间)</td>
<td align="left">SpeedCurve</td>
<td align="left">JS执行效率、代码分割</td>
</tr>
<tr>
<td align="left">Bundle体积</td>
<td align="left">Webpack Bundle Analyzer</td>
<td align="left">Tree Shaking、代码分割</td>
</tr>
</tbody></table>
<p><strong>资源加载层优化</strong></p>
<p>(1) 代码分割与懒加载</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 路由级分割 (React示例)</span>
<span class="token keyword">const</span> Home <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">lazy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token comment">/* webpackPrefetch: true */</span> <span class="token string">'./Home'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>策略：</p>
<ul>
<li>主包仅保留核心框架（React&#x2F;Vue）</li>
<li>路由组件动态加载 + prefetch</li>
<li>非核心库（如图表库）按需加载</li>
</ul>
<p>(2) 资源预加载优化</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- 关键资源预加载 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>main.css<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>style<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>core.js<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>script<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token comment">&lt;!-- 字体预加载 --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>preload<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>font.woff2<span class="token punctuation">"</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>font<span class="token punctuation">"</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) HTTP&#x2F;2推送 (Server Push)</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># Nginx 配置</span>
<span class="token directive"><span class="token keyword">http2_push</span> /static/core.js</span><span class="token punctuation">;</span> 
<span class="token directive"><span class="token keyword">http2_push</span> /static/main.css</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>适用场景：关键静态资源免握手请求</li>
</ul>
<p><strong>构建输出优化</strong></p>
<p>(1) Tree Shaking深度强化</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// package.json 标记副作用</span>
<span class="token punctuation">&#123;</span>
  <span class="token string-property property">"sideEffects"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"*.css"</span><span class="token punctuation">,</span> <span class="token string">"src/polyfill.js"</span><span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>避坑：</p>
<ul>
<li>Babel需设 modules: false 保留ESM</li>
<li>第三方库替换为ESM版本（如 lodash-es）</li>
</ul>
<p>(2) 代码分割策略</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 精细化SplitChunks配置</span>
<span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">splitChunks</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">cacheGroups</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">core</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> 
        <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/](react|vue)</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> 
        <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">100</span> 
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">commons</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> 
        <span class="token literal-property property">minChunks</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> 
        <span class="token literal-property property">reuseExistingChunk</span><span class="token operator">:</span> <span class="token boolean">true</span> 
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>(3) 资源压缩进阶</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Terser多进程压缩</span>
<span class="token keyword">const</span> TerserPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'terser-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token literal-property property">optimization</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">minimizer</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">parallel</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">terserOptions</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">drop_console</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>运行时性能优化</strong></p>
<p>(1) 预渲染静态内容</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 使用PrerenderSpaPlugin生成静态HTML</span>
<span class="token keyword">const</span> PrerenderSPAPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'prerender-spa-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
  <span class="token keyword">new</span> <span class="token class-name">PrerenderSPAPlugin</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">routes</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token string">'/about'</span><span class="token punctuation">]</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>效果：静态页FCP≤1s</li>
</ul>
<p>(2) 服务端渲染(SSR)关键路径</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// Next.js/Nuxt.js 数据预取</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getServerSideProps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchAPI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span> data <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>优势：首屏直出 + CSR无缝切换</li>
</ul>
<p>(3) 浏览器缓存策略</p>
<pre class="line-numbers language-nginx" data-language="nginx"><code class="language-nginx"><span class="token comment"># 永久缓存静态资源</span>
<span class="token directive"><span class="token keyword">location</span> /static</span> <span class="token punctuation">&#123;</span>
  <span class="token directive"><span class="token keyword">expires</span> <span class="token number">1y</span></span><span class="token punctuation">;</span>
  <span class="token directive"><span class="token keyword">add_header</span> Cache-Control <span class="token string">"public, immutable"</span></span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>渲染层专项优化</strong></p>
<p>(1) CSS关键路径优化</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// 提取关键CSS + 异步加载剩余</span>
<span class="token keyword">const</span> Critters <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'critters-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">Critters</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> <span class="token literal-property property">preload</span><span class="token operator">:</span> <span class="token string">'swap'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>(2) 图片加载策略</p>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th align="left">方案</th>
<th align="left">工具</th>
</tr>
</thead>
<tbody><tr>
<td align="left">首屏图片</td>
<td align="left"><code>&lt;img loading=&quot;eager&quot;&gt;</code></td>
<td align="left">原生LazyLoad</td>
</tr>
<tr>
<td align="left">非首屏图片</td>
<td align="left"><code>&lt;img loading=&quot;lazy&quot;&gt;</code></td>
<td align="left">Lazysizes</td>
</tr>
<tr>
<td align="left">响应式图片</td>
<td align="left"><code>srcset</code> + <code>sizes</code></td>
<td align="left">Sharp图像处理</td>
</tr>
</tbody></table>
<p>(3) 字体加载防阻塞</p>
<pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token comment">/* 异步加载字体 */</span>
<span class="token atrule"><span class="token rule">@font-face</span></span> <span class="token punctuation">&#123;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> <span class="token string">'CustomFont'</span><span class="token punctuation">;</span>
  <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span><span class="token string url">'font.woff2'</span><span class="token punctuation">)</span></span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'woff2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">font-display</span><span class="token punctuation">:</span> swap<span class="token punctuation">;</span> <span class="token comment">/* 文本先用系统字体渲染 */</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>总结应答框架</strong></p>
<p>分层解析：</p>
<ul>
<li>加载层：<ul>
<li>代码分割 + 预加载</li>
<li>HTTP&#x2F;2推送 + 资源预加载</li>
<li>CDN静态资源缓存</li>
</ul>
</li>
<li>构建层：<ul>
<li>Tree Shaking深度配置</li>
<li>SplitChunks精细拆包</li>
<li>持久化缓存 (Webpack 5)</li>
</ul>
</li>
<li>渲染层：<ul>
<li>关键CSS内联</li>
<li>图片懒加载 + 字体异步加载</li>
<li>服务端渲染直出</li>
</ul>
</li>
<li>数据层：<ul>
<li>接口数据裁剪</li>
<li>客户端数据缓存</li>
</ul>
</li>
</ul>
<h2 id="8-3-原理深挖"><a href="#8-3-原理深挖" class="headerlink" title="8.3 原理深挖"></a>8.3 原理深挖</h2><h3 id="8-3-1-手写简易Webpack核心流程（解析依赖→生成Chunk）"><a href="#8-3-1-手写简易Webpack核心流程（解析依赖→生成Chunk）" class="headerlink" title="8.3.1 手写简易Webpack核心流程（解析依赖→生成Chunk）"></a>8.3.1 手写简易Webpack核心流程（解析依赖→生成Chunk）</h3><p>**核心流程架构</p>
<pre><code class="mermaid">graph TD
  A[入口文件] --&gt; B[AST解析依赖]
  B --&gt; C[递归构建依赖图]
  C --&gt; D[生成模块ID]
  D --&gt; E[封装模块闭包]
  E --&gt; F[生成Chunk]
  F --&gt; G[输出Bundle文件]</code></pre>

<p><strong>依赖图构建算法</strong></p>
<pre><code class="mermaid">graph TB
  A[入口文件] --&gt; B[解析直接依赖]
  B --&gt; C[模块入队列]
  C --&gt; D&#123;队列是否为空?&#125;
  D --&gt;|否| E[出队列模块]
  E --&gt; F[解析新依赖]
  F --&gt; G[新模块入队列]
  G --&gt; D
  D --&gt;|是| H[生成依赖图]</code></pre>

<p><strong>核心流程代码实现</strong></p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> traverse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>default<span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">&#123;</span> transformFromAst <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 1. 定义Compiler类 - Webpack的核心编译器</span>
<span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token punctuation">&#123;</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options <span class="token operator">=</span> options<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>modules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储所有模块</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储所有chunk</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>assets <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token comment">// 存储输出资源</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileDependencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储文件依赖</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 2. 运行编译器</span>
  <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 从入口文件开始编译</span>
    <span class="token keyword">const</span> entryModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>entry<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 构建依赖图</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildDependencyGraph</span><span class="token punctuation">(</span>entryModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 生成chunks</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateChunks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 输出文件</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">emitFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'打包完成!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 3. 构建单个模块</span>
  <span class="token function">buildModule</span><span class="token punctuation">(</span><span class="token parameter">filename<span class="token punctuation">,</span> isEntry</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 获取文件绝对路径</span>
    <span class="token keyword">let</span> filePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span> 
      <span class="token operator">?</span> filename 
      <span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 检查文件是否存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">文件不存在: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>filePath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 读取文件内容</span>
    <span class="token keyword">const</span> fileContent <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>fileDependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 使用Babel解析代码为AST</span>
    <span class="token keyword">const</span> ast <span class="token operator">=</span> parser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>fileContent<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">sourceType</span><span class="token operator">:</span> <span class="token string">'module'</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 收集依赖</span>
    <span class="token keyword">const</span> dependencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">traverse</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token function-variable function">ImportDeclaration</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> node <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        dependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>source<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
      <span class="token function-variable function">CallExpression</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">&#123;</span> node <span class="token punctuation">&#125;</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>callee<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'require'</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          dependencies<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 将ES6代码转换为ES5</span>
    <span class="token keyword">const</span> <span class="token punctuation">&#123;</span> code <span class="token punctuation">&#125;</span> <span class="token operator">=</span> <span class="token function">transformFromAst</span><span class="token punctuation">(</span>ast<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">presets</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 创建模块对象</span>
    <span class="token keyword">const</span> module <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">id</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> filePath<span class="token punctuation">,</span>
      dependencies<span class="token punctuation">,</span>
      code<span class="token punctuation">,</span>
      isEntry
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> module<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 4. 构建完整依赖图</span>
  <span class="token function">buildDependencyGraph</span><span class="token punctuation">(</span><span class="token parameter">entryModule</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token punctuation">[</span>entryModule<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> queue<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      module<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">dep</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 转换路径为绝对路径</span>
        <span class="token keyword">const</span> dirname <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> absolutePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>dirname<span class="token punctuation">,</span> dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 检查是否已处理过该模块</span>
        <span class="token keyword">const</span> alreadyProcessed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> m<span class="token punctuation">.</span>filename <span class="token operator">===</span> absolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>alreadyProcessed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> childModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildModule</span><span class="token punctuation">(</span>absolutePath<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          queue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>childModule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 5. 生成Chunks</span>
  <span class="token function">generateChunks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 简单打包策略：所有模块打包到一个chunk中</span>
    <span class="token comment">// 实际Webpack会根据配置分割chunk</span>
    <span class="token keyword">const</span> chunk <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">'main'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> m<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
    <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 6. 生成bundle文件</span>
  <span class="token function">generateBundleCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建模块映射对象</span>
    <span class="token keyword">const</span> modulesMap <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">map<span class="token punctuation">,</span> mod</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
      map<span class="token punctuation">[</span>mod<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
        <span class="token literal-property property">fn</span><span class="token operator">:</span> mod<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
        <span class="token literal-property property">deps</span><span class="token operator">:</span> mod<span class="token punctuation">.</span>dependencies<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">deps<span class="token punctuation">,</span> dep</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">const</span> depModule <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> 
            m<span class="token punctuation">.</span>filename <span class="token operator">===</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>mod<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">,</span> dep<span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>depModule<span class="token punctuation">)</span> deps<span class="token punctuation">[</span>dep<span class="token punctuation">]</span> <span class="token operator">=</span> depModule<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
          <span class="token keyword">return</span> deps<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> map<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 生成bundle代码</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(function(modules) &#123;
      // 缓存已加载的模块
      var installedModules = &#123;&#125;;
      
      // 实现require函数
      function require(moduleId) &#123;
        // 检查是否已缓存
        if (installedModules[moduleId]) &#123;
          return installedModules[moduleId].exports;
        &#125;
        
        // 创建新模块
        var module = installedModules[moduleId] = &#123;
          exports: &#123;&#125;
        &#125;;
        
        // 执行模块函数
        modules[moduleId].fn.call(
          module.exports, 
          module, 
          module.exports, 
          require
        );
        
        // 返回模块导出
        return module.exports;
      &#125;
      
      // 加载入口模块
      require(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">m</span> <span class="token operator">=></span> m<span class="token punctuation">.</span>isEntry<span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">);
    &#125;)(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>modulesMap<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">);</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// 7. 输出文件</span>
  <span class="token function">emitFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> outputPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">,</span> 
      <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 确保输出目录存在</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      fs<span class="token punctuation">.</span><span class="token function">mkdirSync</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>output<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span> <span class="token literal-property property">recursive</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 生成bundle代码</span>
    <span class="token keyword">const</span> bundleCode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">generateBundleCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 写入文件</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>outputPath<span class="token punctuation">,</span> bundleCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">已生成bundle文件: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>outputPath<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 8. 使用示例</span>
<span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'bundle.js'</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 创建Compiler实例并运行</span>
<span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Compiler</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
compiler<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>核心流程详解</strong></p>
<ul>
<li>初始化阶段<ul>
<li>创建Compiler实例，接收配置参数</li>
<li>准备modules、chunks和assets等数据结构</li>
</ul>
</li>
<li>编译阶段<ul>
<li>入口解析：从配置的entry开始解析</li>
<li>模块构建：<ul>
<li>读取文件内容</li>
<li>使用Babel解析为AST</li>
<li>遍历AST收集依赖</li>
<li>使用Babel转换代码</li>
</ul>
</li>
<li>构建依赖图：递归解析所有依赖模块</li>
</ul>
</li>
<li>生成阶段<ul>
<li>生成Chunks：根据入口和依赖关系生成代码块</li>
<li>创建模块映射：为每个模块创建ID和依赖映射</li>
<li>生成运行时代码：实现require函数和模块缓存</li>
</ul>
</li>
<li>输出阶段<ul>
<li>生成bundle代码：将所有模块打包到一个文件中</li>
<li>写入文件系统：输出到配置的output目录</li>
</ul>
</li>
</ul>
<p><strong>使用示例</strong></p>
<p>创建一个简单的项目结构测试我们的Webpack实现：</p>
<p>项目结构：</p>
<pre class="line-numbers language-text" data-language="text"><code class="language-text">my-project/
  ├── src/
  │   ├── index.js
  │   ├── message.js
  │   └── name.js
  ├── dist/
  ├── my-webpack.js (上面的代码)
  └── package.json<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>src&#x2F;index.js:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> message <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./message.js'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>src&#x2F;message.js:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> <span class="token punctuation">&#123;</span> name <span class="token punctuation">&#125;</span> <span class="token keyword">from</span> <span class="token string">'./name.js'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> message <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$&#123;</span>name<span class="token interpolation-punctuation punctuation">&#125;</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>src&#x2F;name.js:</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'Webpack Developer'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>运行我们的Webpack实现：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">node</span> my-webpack.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>输出结果 (dist&#x2F;bundle.js):</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 缓存已加载的模块</span>
  <span class="token keyword">var</span> installedModules <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  
  <span class="token comment">// 实现require函数</span>
  <span class="token keyword">function</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 检查是否已缓存</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">return</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 创建新模块</span>
    <span class="token keyword">var</span> module <span class="token operator">=</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
      <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 执行模块函数</span>
    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
      module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> 
      module<span class="token punctuation">,</span> 
      module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> 
      require
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 返回模块导出</span>
    <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token comment">// 加载入口模块</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
  <span class="token string-property property">"0"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string-property property">"fn"</span><span class="token operator">:</span> <span class="token string">"\"use strict\";\n\nvar _message = require(\"./message.js\");\n\nconsole.log(_message.message);"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"deps"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">"./message.js"</span><span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string-property property">"1"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string-property property">"fn"</span><span class="token operator">:</span> <span class="token string">"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", &#123;\n  value: true\n&#125;);\nexports.message = void 0;\n\nvar _name = require(\"./name.js\");\n\nvar message = \"Hello, \".concat(_name.name, \"!\");\nexports.message = message;"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"deps"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
      <span class="token string-property property">"./name.js"</span><span class="token operator">:</span> <span class="token number">2</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
  <span class="token string-property property">"2"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span>
    <span class="token string-property property">"fn"</span><span class="token operator">:</span> <span class="token string">"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", &#123;\n  value: true\n&#125;);\nexports.name = void 0;\nvar name = 'Webpack Developer';\nexports.name = name;"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"deps"</span><span class="token operator">:</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="8-3-2-对比Webpack与Vite的Bundleless设计差异"><a href="#8-3-2-对比Webpack与Vite的Bundleless设计差异" class="headerlink" title="8.3.2 对比Webpack与Vite的Bundleless设计差异"></a>8.3.2 对比Webpack与Vite的Bundleless设计差异</h3><p><strong>核心架构差异全景</strong></p>
<pre><code class="mermaid">graph LR
  W[Webpack] --&gt;|基于Bundle| A[开发&#x2F;生产统一打包]
  V[Vite] --&gt;|Bundleless| B[开发：ESM按需加载&lt;br&gt;生产：Rollup打包]
  
  subgraph 开发模式
    A --&gt; C[启动时全量打包]
    B --&gt; D[启动时无打包]
  end
  
  subgraph 生产模式
    A --&gt; E[Webpack打包]
    B --&gt; F[Rollup打包]
  end</code></pre>

<p><strong>五大核心维度对比</strong></p>
<table>
<thead>
<tr>
<th align="left">维度</th>
<th align="left">Webpack</th>
<th align="left">Vite</th>
<th align="left">本质差异</th>
</tr>
</thead>
<tbody><tr>
<td align="left">开发启动</td>
<td align="left">全量打包后启动（O(n)）</td>
<td align="left">仅启动Server（O(1)）</td>
<td align="left">项目越大差异越显著</td>
</tr>
<tr>
<td align="left">HMR更新</td>
<td align="left">重新构建受影响Chunk</td>
<td align="left">边界模块按需更新（毫秒级）</td>
<td align="left">依赖图遍历 vs ESM动态加载</td>
</tr>
<tr>
<td align="left">生态兼容</td>
<td align="left">⭐⭐⭐⭐⭐ 支持所有Loader&#x2F;Plugin</td>
<td align="left">⭐⭐⭐ 依赖Rollup插件体系</td>
<td align="left">历史包袱 vs 轻量设计</td>
</tr>
<tr>
<td align="left">构建输出</td>
<td align="left">自定义Chunk分割</td>
<td align="left">原生ESM输出 + 异步Chunk</td>
<td align="left">人工优化 vs 原生并行加载</td>
</tr>
<tr>
<td align="left">调试支持</td>
<td align="left">SourceMap映射打包后代码</td>
<td align="left">直接映射源码（未编译状态）</td>
<td align="left">转换后调试 vs 源码级调试</td>
</tr>
</tbody></table>
<p><strong>开发模式原理剖析</strong></p>
<p>(1) Webpack 传统打包流程</p>
<pre><code class="mermaid">sequenceDiagram
  浏览器-&gt;&gt;DevServer: 请求入口HTML
  DevServer-&gt;&gt;Webpack: 触发全量打包
  Webpack-&gt;&gt;浏览器: 返回bundle.js(包含所有模块)
  浏览器-&gt;&gt;DevServer: HMR更新请求
  Webpack-&gt;&gt;Webpack: 重新构建受影响Chunk
  Webpack-&gt;&gt;浏览器: 发送更新补丁</code></pre>

<p>(2) Vite Bundleless 流程</p>
<pre><code class="mermaid">sequenceDiagram
  浏览器-&gt;&gt;ViteServer: 请求入口HTML
  ViteServer-&gt;&gt;浏览器: 返回基础HTML
  浏览器-&gt;&gt;ViteServer: 请求main.js(ESM)
  ViteServer-&gt;&gt;浏览器: 返回原生ESM模块
  浏览器-&gt;&gt;ViteServer: 按需请求依赖模块
  浏览器-&gt;&gt;ViteServer: HMR边界模块更新
  ViteServer-&gt;&gt;浏览器: 仅更新单个模块</code></pre>

<p>关键创新：</p>
<ul>
<li>利用浏览器原生 ESM 能力</li>
<li>依赖预构建（esbuild 转换 CJS 模块）</li>
<li>基于路由的代码分割（自然代码分割）</li>
</ul>
<hr>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="reward-container">
  <div>请我一杯咖啡吧！</div>
  <button>
    赞赏
  </button>
  <div class="post-reward">

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/Webpack/" rel="tag"><i class="fa fa-tag"></i> Webpack</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/06/29/Performance%20Optimization/" rel="prev" title="专题知识学习：前端性能优化">
                  <i class="fa fa-angle-left"></i> 专题知识学习：前端性能优化
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/07/05/NodeJS%20Study%20Notes/" rel="next" title="专题知识学习：Node.js">
                  专题知识学习：Node.js <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Ariel</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">210k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">12:45</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/tianfei92" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
